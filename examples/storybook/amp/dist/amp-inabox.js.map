{
  "version": 3,
  "sources": ["../src/polyfills/abort-controller.js", "../src/polyfills/array-includes.js", "../src/core/data-structures/promise.js", "../src/core/types/object/index.js", "../src/core/error/index.js", "../src/polyfills/custom-elements.js", "../src/polyfills/domtokenlist.js", "../src/polyfills/document-contains.js", "../src/core/types/array.js", "../src/core/types/enum.js", "../src/core/types/string/index.js", "../src/core/types/index.js", "../src/core/error/message-helpers.js", "../src/core/assert/base.js", "../src/internal-version.js", "../src/core/types/string/url.js", "../src/mode.js", "../src/core/types/function/index.js", "../src/config.js", "../src/log.js", "../src/core/minified-mode.js", "../src/core/assert/dev.js", "../src/core/assert/user.js", "../src/core/types/object/json.js", "../src/core/types/string/bytes.js", "../src/polyfills/fetch.js", "../src/core/math/layout-rect.js", "../third_party/css-escape/css-escape.js", "../src/core/dom/css-selectors.js", "../src/core/dom/query.js", "../src/core/window/index.js", "../src/dom.js", "../src/polyfills/get-bounding-client-rect.js", "../src/polyfills/stubs/intersection-observer-stub.js", "../src/polyfills/intersection-observer.js", "../src/polyfills/map-set.js", "../src/polyfills/math-sign.js", "../src/polyfills/object-assign.js", "../src/polyfills/object-values.js", "../node_modules/promise-pjs/promise.mjs", "../src/polyfills/promise.js", "../src/polyfills/stubs/resize-observer-stub.js", "../src/polyfills/resize-observer.js", "../src/polyfills/set-add.js", "../src/polyfills/string-starts-with.js", "../src/polyfills/weakmap-set.js", "../src/polyfills/index.js", "../src/service.js", "../src/service/extension-script.js", "../src/element-service.js", "../src/services.js", "../src/core/window/interface.js", "../src/core/data-structures/lru-cache.js", "../src/url.js", "../src/experiments/index.js", "../src/impression.js", "../src/core/data-structures/priority-queue.js", "../src/service/navigation.js", "../src/core/constants/enums.js", "../src/core/constants/action-constants.js", "../src/static-template.js", "../src/style.js", "../src/core/dom/img.js", "../src/layout.js", "../src/core/dom/event-helper-listen.js", "../src/event-helper.js", "../src/base-element.js", "../src/core/constants/common-signals.js", "../src/core/constants/visibility-state.js", "../third_party/webcomponentsjs/ShadowCSS.js", "../src/core/dom/web-components.js", "../src/render-delaying-services.js", "../src/style-installer.js", "../src/shadow-embed.js", "../build/ampshared.css.js", "../src/core/constants/key-codes.js", "../src/format.js", "../src/core/constants/amp-events.js", "../src/core/types/function/exponential-backoff.js", "../src/analytics.js", "../src/error-reporting.js", "../src/service/action-impl.js", "../src/form-data-wrapper.js", "../src/utils/xhr-utils.js", "../src/service/xhr-impl.js", "../src/service/batched-xhr-impl.js", "../src/service/cid-api.js", "../src/core/types/string/base64.js", "../src/service/cid-impl.js", "../src/service/crypto-impl.js", "../src/service/document-info-impl.js", "../src/document-submit.js", "../src/core/data-structures/observable.js", "../src/service/hidden-observer-impl.js", "../src/core/window/history.js", "../src/service/history-impl.js", "../src/core/constants/ready-state.js", "../src/element-stub.js", "../src/core/dom/media-query-props.js", "../src/service/resource.js", "../src/core/data-structures/signals.js", "../src/3p-frame-messaging.js", "../src/iframe-helper.js", "../src/utils/intersection-observer-3p-host.js", "../src/service/resources-interface.js", "../src/service/scheduler.js", "../src/consent.js", "../src/chunk.js", "../src/custom-element.js", "../src/service/custom-element-registry.js", "../builtins/amp-img/amp-img.js", "../src/pass.js", "../src/inabox/inabox-resources.js", "../src/input.js", "../builtins/amp-layout/amp-layout.js", "../src/viewport-observer.js", "../src/service/mutator-impl.js", "../src/service/owners-impl.js", "../src/pixel.js", "../builtins/amp-pixel/amp-pixel.js", "../src/service/platform-impl.js", "../src/core/document-ready.js", "../src/preconnect.js", "../src/service/resources-impl.js", "../src/service/standard-actions-impl.js", "../src/service/template-impl.js", "../src/service/timer-impl.js", "../src/service/url-impl.js", "../src/service/variable-source.js", "../src/service/url-expander/expander.js", "../src/service/url-replacements-impl.js", "../src/core/data-structures/curve.js", "../src/utils/document-visibility.js", "../src/service/vsync-impl.js", "../src/service/core-services.js", "../src/service/extensions-impl.js", "../src/runtime.js", "../src/font-stylesheet-timeout.js", "../src/ini-load.js", "../src/inabox/utils.js", "../3p/iframe-messaging-client.js", "../src/inabox/inabox-iframe-messaging-client.js", "../src/inabox/inabox-cid.js", "../src/inabox/inabox-mutator.js", "../src/inabox/inabox-viewer.js", "../src/full-overlay-frame-helper.js", "../ads/inabox/util.js", "../ads/inabox/frame-overlay-helper.js", "../ads/inabox/frame-overlay-manager.js", "../ads/inabox/position-observer.js", "../src/inabox/inabox-viewport.js", "../src/inabox/inabox-services.js", "../src/service/ampdoc-impl.js", "../src/utils/story.js", "../src/service/performance-impl.js", "../extensions/amp-story-auto-ads/0.1/story-ad-button-text-fitter.js", "../build/amp-story-auto-ads-attribution-0.1.css.js", "../extensions/amp-story/1.0/utils.js", "../build/amp-story-auto-ads-cta-button-0.1.css.js", "../extensions/amp-story-auto-ads/0.1/story-ad-ui.js", "../build/amp-story-auto-ads-inabox-0.1.css.js", "../build/amp-story-auto-ads-shared-0.1.css.js", "../src/inabox/inabox-story-ad.js", "../src/validator-integration.js", "../src/inabox/amp-inabox.js"],
  "sourcesContent": ["/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** Polyfill for the public AbortController. */\nclass AbortController {\n  /** Constructor. */\n  constructor() {\n    /** @const {!AbortSignal} */\n    this.signal_ = new AbortSignal();\n  }\n\n  /** Triggers an abort signal. */\n  abort() {\n    if (this.signal_.isAborted_) {\n      // Already aborted.\n      return;\n    }\n    this.signal_.isAborted_ = true;\n    if (this.signal_.onabort_) {\n      const event = /** @type {!Event} */ ({\n        'type': 'abort',\n        'bubbles': false,\n        'cancelable': false,\n        'target': this.signal_,\n        'currentTarget': this.signal_,\n      });\n      this.signal_.onabort_(event);\n    }\n  }\n\n  /** @return {!AbortSignal} */\n  get signal() {\n    return this.signal_;\n  }\n}\n\n/** Polyfill for the public AbortSignal. */\nclass AbortSignal {\n  /** */\n  constructor() {\n    /** @private {boolean} */\n    this.isAborted_ = false;\n    /** @private {?function(!Event)} */\n    this.onabort_ = null;\n  }\n\n  /** @return {boolean} */\n  get aborted() {\n    return this.isAborted_;\n  }\n\n  /** @return {?function(!Event)} */\n  get onabort() {\n    return this.onabort_;\n  }\n\n  /** @param {?function(!Event)} value */\n  set onabort(value) {\n    this.onabort_ = value;\n  }\n}\n\n/**\n * Sets the AbortController and AbortSignal polyfills if not defined.\n * @param {!Window} win\n */\nexport function install(win) {\n  if (win.AbortController) {\n    return;\n  }\n  Object.defineProperty(win, 'AbortController', {\n    configurable: true,\n    enumerable: false,\n    writable: true,\n    value: AbortController,\n  });\n  Object.defineProperty(win, 'AbortSignal', {\n    configurable: true,\n    enumerable: false,\n    writable: true,\n    value: AbortSignal,\n  });\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns true if the element is in the array and false otherwise.\n *\n * @param {*} value\n * @param {number=} opt_fromIndex\n * @return {boolean}\n * @this {Array}\n */\nfunction includes(value, opt_fromIndex) {\n  const fromIndex = opt_fromIndex || 0;\n  // eslint-disable-next-line local/no-invalid-this\n  const len = this.length;\n  let i = fromIndex >= 0 ? fromIndex : Math.max(len + fromIndex, 0);\n  for (; i < len; i++) {\n    // eslint-disable-next-line local/no-invalid-this\n    const other = this[i];\n    // If value has been found OR (value is NaN AND other is NaN)\n    /*eslint \"no-self-compare\": 0*/\n    if (other === value || (value !== value && other !== other)) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Sets the Array.contains polyfill if it does not exist.\n * @param {!Window} win\n */\nexport function install(win) {\n  if (!win.Array.prototype.includes) {\n    win.Object.defineProperty(win.Array.prototype, 'includes', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: includes,\n    });\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nlet resolved;\n\n/**\n * Returns a cached resolved promise.\n * Babel converts direct calls to Promise.resolve() (with no arguments) into\n * calls to this.\n *\n * @return {!Promise<undefined>}\n */\nexport function resolvedPromise() {\n  if (resolved) {\n    return resolved;\n  }\n\n  // It's important that we call with `undefined` here, to prevent a transform\n  // recursion. If we didn't pass an arg, then the transformer would replace\n  // this callsite with a call to `resolvedPromise()`.\n  resolved = Promise.resolve(undefined);\n  return resolved;\n}\n\n/**\n * Returns a Deferred struct, which holds a pending promise and its associated\n * resolve and reject functions.\n *\n * This is preferred instead of creating a Promise instance to extract the\n * resolve/reject functions yourself:\n *\n * ```\n * // Avoid doing\n * let resolve;\n * const promise = new Promise(res => {\n *   resolve = res;\n * });\n *\n * // Good\n * const deferred = new Deferred();\n * const { promise, resolve } = deferred;\n * ```\n *\n * @template T\n */\nexport class Deferred {\n  /** Constructor. */\n  constructor() {\n    /** @const {!Promise<T>} */\n    this.promise = new /*OK*/ Promise((res, rej) => {\n      /** @const {function(T=)} */\n      this.resolve = res;\n      /** @const {function(*=)} */\n      this.reject = rej;\n    });\n  }\n}\n\n/**\n * Creates a promise resolved to the return value of fn.\n * If fn sync throws, it will cause the promise to reject.\n *\n * @param {function():T} fn\n * @return {!Promise<T>}\n * @template T\n */\nexport function tryResolve(fn) {\n  return new Promise((resolve) => {\n    resolve(fn());\n  });\n}\n\n/**\n * Resolves with the result of the last promise added.\n * @implements {IThenable}\n */\nexport class LastAddedResolver {\n  /**\n   * @param {!Array<!IThenable>=} opt_promises\n   */\n  constructor(opt_promises) {\n    /** @private @const {!Deferred} */\n    this.deferred_ = new Deferred();\n\n    /** @private */\n    this.count_ = 0;\n\n    if (opt_promises) {\n      for (const promise of opt_promises) {\n        this.add(promise);\n      }\n    }\n  }\n\n  /**\n   * Add a promise to possibly be resolved.\n   * @param {!IThenable} promise\n   * @return {!Promise}\n   */\n  add(promise) {\n    const countAtAdd = ++this.count_;\n    promise.then(\n      (result) => {\n        if (this.count_ === countAtAdd) {\n          this.deferred_.resolve(result);\n        }\n      },\n      (error) => {\n        // Don't follow behavior of Promise.all and Promise.race error so that\n        // this will only reject when most recently added promise fails.\n        if (this.count_ === countAtAdd) {\n          this.deferred_.reject(error);\n        }\n      }\n    );\n    return this.deferred_.promise;\n  }\n\n  /** @override */\n  then(opt_resolve, opt_reject) {\n    return this.deferred_.promise.then(opt_resolve, opt_reject);\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* @const */\nconst {hasOwnProperty: hasOwn_, toString: toString_} = Object.prototype;\n\n/**\n * Determines if value is actually an Object.\n * @param {*} value\n * @return {boolean}\n */\nexport function isObject(value) {\n  return toString_.call(value) === '[object Object]';\n}\n\n/**\n * Returns a map-like object.\n * If opt_initial is provided, copies its own properties into the\n * newly created object.\n * @param {T=} opt_initial This should typically be an object literal.\n * @return {T}\n * @template T\n */\nexport function map(opt_initial) {\n  const obj = Object.create(null);\n  if (opt_initial) {\n    Object.assign(obj, opt_initial);\n  }\n  return obj;\n}\n\n/**\n * Return an empty JsonObject or makes the passed in object literal\n * an JsonObject.\n * The JsonObject type is just a simple object that is at-dict.\n * See\n * https://github.com/google/closure-compiler/wiki/@struct-and-@dict-Annotations\n * for what a dict is type-wise.\n * The linter enforces that the argument is, in fact, at-dict like.\n * @param {!Object=} opt_initial\n * @return {!JsonObject}\n */\nexport function dict(opt_initial) {\n  // We do not copy. The linter enforces that the passed in object is a literal\n  // and thus the caller cannot have a reference to it.\n  return /** @type {!JsonObject} */ (opt_initial || {});\n}\n\n/**\n * Checks if the given key is a property in the map.\n *\n * @param {T}  obj a map like property.\n * @param {string}  key\n * @return {boolean}\n * @template T\n */\nexport function hasOwn(obj, key) {\n  return hasOwn_.call(obj, key);\n}\n\n/**\n * Returns obj[key] iff key is obj's own property (is not inherited).\n * Otherwise, returns undefined.\n *\n * @param {Object} obj\n * @param {string} key\n * @return {*}\n */\nexport function ownProperty(obj, key) {\n  if (hasOwn(obj, key)) {\n    return obj[key];\n  } else {\n    return undefined;\n  }\n}\n\n/**\n * Deep merges source into target.\n *\n * @param {!Object} target\n * @param {!Object} source\n * @param {number} depth The maximum merge depth. If exceeded, Object.assign\n *                       will be used instead.\n * @return {!Object}\n * @throws {Error} If source contains a circular reference.\n * Note: Only nested objects are deep-merged, primitives and arrays are not.\n */\nexport function deepMerge(target, source, depth = 10) {\n  // Keep track of seen objects to detect recursive references.\n  const seen = [];\n\n  /** @type {!Array<{t: !Object, s: !Object, d: number}>} */\n  const queue = [];\n  queue.push({t: target, s: source, d: 0});\n\n  // BFS to ensure objects don't have recursive references at shallower depths.\n  while (queue.length > 0) {\n    const {d, s, t} = queue.shift();\n    if (seen.includes(s)) {\n      throw new Error('Source object has a circular reference.');\n    }\n    seen.push(s);\n    if (t === s) {\n      continue;\n    }\n    if (d > depth) {\n      Object.assign(t, s);\n      continue;\n    }\n    for (const key of Object.keys(s)) {\n      const newValue = s[key];\n      // Perform a deep merge IFF both target and source have the same key\n      // whose corresponding values are objects.\n      if (hasOwn(t, key)) {\n        const oldValue = t[key];\n        if (isObject(newValue) && isObject(oldValue)) {\n          queue.push({t: oldValue, s: newValue, d: d + 1});\n          continue;\n        }\n      }\n      t[key] = newValue;\n    }\n  }\n  return target;\n}\n\n/**\n * @param {!Object} o An object to remove properties from\n * @param {!Array<string>} props A list of properties to remove from the Object\n * @return {!Object} An object with the given properties removed\n */\nexport function omit(o, props) {\n  return Object.keys(o).reduce((acc, key) => {\n    if (!props.includes(key)) {\n      acc[key] = o[key];\n    }\n    return acc;\n  }, {});\n}\n\n/**\n * @param {!Object|null|undefined} o1\n * @param {!Object|null|undefined} o2\n * @return {boolean}\n */\nexport function objectsEqualShallow(o1, o2) {\n  if (o1 == null || o2 == null) {\n    // Null is only equal to null, and undefined to undefined.\n    return o1 === o2;\n  }\n\n  for (const k in o1) {\n    if (o1[k] !== o2[k]) {\n      return false;\n    }\n  }\n  for (const k in o2) {\n    if (o2[k] !== o1[k]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\n/**\n * @param {T} obj\n * @param {string} prop\n * @param {function(T, string):R} factory\n * @return {R}\n * @template T,R\n */\nexport function memo(obj, prop, factory) {\n  let result = /** @type {?R} */ (obj[prop]);\n  if (result === undefined) {\n    result = factory(obj, prop);\n    obj[prop] = result;\n  }\n  return result;\n}\n\n/**\n * Recreates objects with prototype-less copies.\n * @param {!JsonObject} obj\n * @return {!JsonObject}\n */\nexport function recreateNonProtoObject(obj) {\n  const copy = map();\n  for (const k in obj) {\n    if (!hasOwn(obj, k)) {\n      continue;\n    }\n    const v = obj[k];\n    copy[k] = isObject(v) ? recreateNonProtoObject(v) : v;\n  }\n  return /** @type {!JsonObject} */ (copy);\n}\n\n/**\n * Returns a value from an object for a field-based expression. The expression\n * is a simple nested dot-notation of fields, such as `field1.field2`. If any\n * field in a chain does not exist or is not an object or array, the returned\n * value will be `undefined`.\n *\n * @param {!JsonObject} obj\n * @param {string} expr\n * @return {*}\n */\nexport function getValueForExpr(obj, expr) {\n  // The `.` indicates \"the object itself\".\n  if (expr == '.') {\n    return obj;\n  }\n  // Otherwise, navigate via properties.\n  const parts = expr.split('.');\n  let value = obj;\n  for (const part of parts) {\n    if (\n      part &&\n      value &&\n      value[part] !== undefined &&\n      typeof value == 'object' &&\n      hasOwn(value, part)\n    ) {\n      value = value[part];\n      continue;\n    }\n    value = undefined;\n    break;\n  }\n  return value;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Some exceptions (DOMException, namely) have read-only message.\n * @param {!Error} error\n * @return {!Error};\n */\nexport function duplicateErrorIfNecessary(error) {\n  const messageProperty = Object.getOwnPropertyDescriptor(error, 'message');\n  if (messageProperty?.writable) {\n    return error;\n  }\n\n  const {message, stack} = error;\n  const e = new Error(message);\n  // Copy all the extraneous things we attach.\n  for (const prop in error) {\n    e[prop] = error[prop];\n  }\n  // Ensure these are copied.\n  e.stack = stack;\n  return e;\n}\n\n/**\n * @param {...*} var_args\n * @return {!Error}\n * @visibleForTesting\n */\nexport function createErrorVargs(var_args) {\n  let error = null;\n  let message = '';\n  for (const arg of arguments) {\n    if (arg instanceof Error && !error) {\n      error = duplicateErrorIfNecessary(arg);\n    } else {\n      if (message) {\n        message += ' ';\n      }\n      message += arg;\n    }\n  }\n\n  if (!error) {\n    error = new Error(message);\n  } else if (message) {\n    error.message = message + ': ' + error.message;\n  }\n  return error;\n}\n\n/**\n * Rethrows the error without terminating the current context. This preserves\n * whether the original error designation is a user error or a dev error.\n * @param {...*} var_args\n */\nexport function rethrowAsync(var_args) {\n  const error = createErrorVargs.apply(null, arguments);\n  setTimeout(() => {\n    // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n    // It may not exist for Bento components without the runtime.\n    self.__AMP_REPORT_ERROR?.(error);\n    throw error;\n  });\n}\n\n/**\n * Executes the provided callback in a try/catch and rethrows any errors\n * asynchronously.\n *\n * @param {function(...*):T} callback\n * @param {...*} args\n * @return {T}\n * @template T\n */\nexport function tryCallback(callback, ...args) {\n  try {\n    return callback.apply(null, args);\n  } catch (e) {\n    rethrowAsync(e);\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../core/data-structures/promise';\nimport {map} from '../core/types/object';\nimport {rethrowAsync} from '../core/error';\n\n/**\n * For type anotations where Element is a local variable.\n * @typedef {!Element}\n */\nlet ElementOrigDef;\n\n/** @typedef {!typeof HTMLElement} */\nlet CustomElementConstructorDef;\n\n/**\n * @typedef {{\n *  name: string,\n *  ctor: !CustomElementConstructorDef,\n * }}\n */\nlet CustomElementDef;\n\n/**\n * Validates the custom element's name.\n * This intentionally ignores \"valid\" higher Unicode Code Points.\n * https://html.spec.whatwg.org/multipage/custom-elements.html#valid-custom-element-name\n */\nconst VALID_NAME = /^[a-z][a-z0-9._]*-[a-z0-9._-]*$/;\nconst INVALID_NAMES = [\n  'annotation-xml',\n  'color-profile',\n  'font-face',\n  'font-face-src',\n  'font-face-uri',\n  'font-face-format',\n  'font-face-name',\n  'missing-glyph',\n];\n\n/**\n * A MutationObserverInit dictionary to track subtree modifications.\n */\nconst TRACK_SUBTREE = {\n  'childList': true,\n  'subtree': true,\n};\n\n/**\n * Asserts that the custom element name conforms to the spec.\n *\n * @param {!typeof SyntaxError} SyntaxError\n * @param {string} name\n */\nfunction assertValidName(SyntaxError, name) {\n  if (!VALID_NAME.test(name) || INVALID_NAMES.includes(name)) {\n    throw new SyntaxError(`invalid custom element name \"${name}\"`);\n  }\n}\n\n/**\n * Does win have a full Custom Elements registry?\n *\n * @param {!Window} win\n * @return {boolean}\n */\nfunction hasCustomElements(win) {\n  const {customElements} = win;\n\n  return !!(\n    customElements &&\n    customElements.define &&\n    customElements.get &&\n    customElements.whenDefined\n  );\n}\n\n/**\n * Was HTMLElement already patched for this window?\n *\n * @param {!Window} win\n * @return {boolean}\n */\nfunction isPatched(win) {\n  const tag = win.HTMLElement.toString();\n  return tag.indexOf('[native code]') === -1;\n}\n\n/**\n * The public Custom Elements API.\n */\nclass CustomElementRegistry {\n  /**\n   * @param {!Window} win\n   * @param {!Registry} registry\n   */\n  constructor(win, registry) {\n    /** @const @private */\n    this.win_ = win;\n\n    /** @const @private */\n    this.registry_ = registry;\n\n    /** @private @const @type {!Object<string, !Deferred>} */\n    this.pendingDefines_ = map();\n  }\n\n  /**\n   * Register the custom element.\n   *\n   * @param {string} name\n   * @param {!CustomElementConstructorDef} ctor\n   * @param {!Object=} options\n   */\n  define(name, ctor, options) {\n    this.registry_.define(name, ctor, options);\n\n    // If anyone is waiting for this custom element to be defined, resolve\n    // their promise.\n    const pending = this.pendingDefines_;\n    const deferred = pending[name];\n    if (deferred) {\n      deferred.resolve();\n      delete pending[name];\n    }\n  }\n\n  /**\n   * Get the constructor of the (already defined) custom element.\n   *\n   * @param {string} name\n   * @return {!CustomElementConstructorDef|undefined}\n   */\n  get(name) {\n    const def = this.registry_.getByName(name);\n    if (def) {\n      return def.ctor;\n    }\n  }\n\n  /**\n   * Returns a promise that waits until the custom element is defined.\n   * If the custom element is already defined, returns a resolved promise.\n   *\n   * @param {string} name\n   * @return {!Promise<undefined>}\n   */\n  whenDefined(name) {\n    const {Promise, SyntaxError} = this.win_;\n    assertValidName(SyntaxError, name);\n\n    if (this.registry_.getByName(name)) {\n      return Promise.resolve();\n    }\n\n    const pending = this.pendingDefines_;\n    let deferred = pending[name];\n    if (!deferred) {\n      deferred = new Deferred();\n      pending[name] = deferred;\n    }\n\n    return deferred.promise;\n  }\n\n  /**\n   * Upgrade all custom elements inside root.\n   *\n   * @param {!Node} root\n   */\n  upgrade(root) {\n    this.registry_.upgrade(root);\n  }\n}\n\n/**\n * This internal APIs necessary to run the CustomElementRegistry.\n * Since Registry is never exposed externally, all methods are actually\n * available on the instance.\n */\nclass Registry {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const */\n    this.win_ = win;\n\n    /** @private @const @type {!Object<string, !CustomElementDef>} */\n    this.definitions_ = map();\n\n    /**\n     * A up-to-date DOM selector for all custom elements.\n     * @type {string}\n     */\n    this.query_ = '';\n\n    /**\n     * The currently upgrading element.\n     * @private {?Element}\n     */\n    this.current_ = null;\n\n    /**\n     * Once started (after the first Custom Element definition), this tracks\n     * DOM append and removals.\n     *\n     * @private {?MutationObserver}\n     */\n    this.mutationObserver_ = null;\n\n    /**\n     * All the observed DOM trees, including shadow trees.\n     *\n     * @private @const {!Array<!Node>}\n     */\n    this.roots_ = [win.document];\n  }\n\n  /**\n   * The currently-being-upgraded custom element.\n   *\n   * When an already created (through the DOM parsing APIs, or innerHTML)\n   * custom element node is being upgraded, we can't just create a new node\n   * (it's illegal in the spec). But we still need to run the custom element's\n   * constructor code on the node. We avoid this conundrum by running the\n   * constructor while returning this current node in the HTMLElement\n   * class constructor (the base class of all custom elements).\n   *\n   * @return {?Element}\n   */\n  current() {\n    const current = this.current_;\n    this.current_ = null;\n    return current;\n  }\n\n  /**\n   * Finds the custom element definition by name.\n   *\n   * @param {string} name\n   * @return {!CustomElementDef|undefined}\n   */\n  getByName(name) {\n    const definition = this.definitions_[name];\n    if (definition) {\n      return definition;\n    }\n  }\n\n  /**\n   * Finds the custom element definition by constructor instance.\n   *\n   * @param {!CustomElementConstructorDef} ctor\n   * @return {!CustomElementDef|undefined}\n   */\n  getByConstructor(ctor) {\n    const definitions = this.definitions_;\n\n    for (const name in definitions) {\n      const def = definitions[name];\n      if (def.ctor === ctor) {\n        return def;\n      }\n    }\n  }\n\n  /**\n   * Registers the custom element definition, and upgrades all elements by that\n   * name in the root document.\n   *\n   * @param {string} name\n   * @param {!CustomElementConstructorDef} ctor\n   * @param {!Object|undefined} options\n   */\n  define(name, ctor, options) {\n    const {Error, SyntaxError} = this.win_;\n\n    if (options) {\n      throw new Error('Extending native custom elements is not supported');\n    }\n\n    assertValidName(SyntaxError, name);\n\n    if (this.getByName(name) || this.getByConstructor(ctor)) {\n      throw new Error(`duplicate definition \"${name}\"`);\n    }\n\n    // TODO(jridgewell): Record connectedCallback, disconnectedCallback,\n    // adoptedCallback, attributeChangedCallback, and observedAttributes.\n    // TODO(jridgewell): If attributeChangedCallback, gather observedAttributes\n    this.definitions_[name] = {\n      name,\n      ctor,\n    };\n\n    this.observe_(name);\n    for (const tree of this.roots_) {\n      this.upgrade(tree, name);\n    }\n  }\n\n  /**\n   * Upgrades custom elements descendants of root (but not including root).\n   *\n   * When called with an opt_query, it both upgrades and connects the custom\n   * elements (this is used during the custom element define algorithm).\n   *\n   * @param {!Node} root\n   * @param {string=} opt_query\n   */\n  upgrade(root, opt_query) {\n    // Only CustomElementRegistry.p.define provides a query (the newly defined\n    // custom element). In this case, we are both upgrading _and_ connecting\n    // the custom elements.\n    const newlyDefined = !!opt_query;\n    const query = opt_query || this.query_;\n    const upgradeCandidates = this.queryAll_(root, query);\n\n    for (const candidate of upgradeCandidates) {\n      if (newlyDefined) {\n        this.connectedCallback_(candidate);\n      } else {\n        this.upgradeSelf(candidate);\n      }\n    }\n  }\n\n  /**\n   * Upgrades the custom element node, if a custom element has been registered\n   * by this name.\n   *\n   * @param {!Node} node\n   */\n  upgradeSelf(node) {\n    const def = this.getByName(node.localName);\n    if (!def) {\n      return;\n    }\n\n    this.upgradeSelf_(/** @type {!Element} */ (node), def);\n  }\n\n  /**\n   * @param {!Node} root\n   * @param {string} query\n   * @return {!Array|!NodeList}\n   */\n  queryAll_(root, query) {\n    if (!query || !root.querySelectorAll) {\n      // Nothing to do...\n      return [];\n    }\n\n    return root.querySelectorAll(query);\n  }\n\n  /**\n   * Upgrades the (already created via DOM parsing) custom element.\n   *\n   * @param {!Element} node\n   * @param {!CustomElementDef} def\n   */\n  upgradeSelf_(node, def) {\n    const {ctor} = def;\n    if (node instanceof ctor) {\n      return;\n    }\n\n    // Despite how it looks, this is not a useless construction.\n    // HTMLElementPolyfill (the base class of all custom elements) will return\n    // the current node, allowing the custom element's subclass constructor to\n    // run on the node. The node itself is already constructed, so the return\n    // value is just the node.\n    this.current_ = node;\n    try {\n      const el = new ctor();\n\n      if (el !== node) {\n        throw new this.win_.Error(\n          'Constructor illegally returned a different instance.'\n        );\n      }\n    } catch (e) {\n      rethrowAsync(e);\n    }\n  }\n\n  /**\n   * Fires connectedCallback on the custom element, if it has one.\n   * This also upgrades the custom element, since it may not have been\n   * accessible via the root document before (a detached DOM tree).\n   *\n   * @param {!Node} node\n   */\n  connectedCallback_(node) {\n    const def = this.getByName(node.localName);\n    if (!def) {\n      return;\n    }\n    node = /** @type {!HTMLElement} */ (node);\n    this.upgradeSelf_(node, def);\n    // TODO(jridgewell): It may be appropriate to adoptCallback, if the node\n    // used to be in another doc.\n    // TODO(jridgewell): I should be calling the definitions connectedCallback\n    // with node as the context.\n    if (node.connectedCallback) {\n      try {\n        node.connectedCallback();\n      } catch (e) {\n        rethrowAsync(e);\n      }\n    }\n  }\n\n  /**\n   * Fires disconnectedCallback on the custom element, if it has one.\n   *\n   * @param {!Node} node\n   */\n  disconnectedCallback_(node) {\n    // TODO(jridgewell): I should be calling the definitions connectedCallback\n    // with node as the context.\n    node = /** @type {!HTMLElement} */ (node);\n    if (node.disconnectedCallback) {\n      try {\n        node.disconnectedCallback();\n      } catch (e) {\n        rethrowAsync(e);\n      }\n    }\n  }\n\n  /**\n   * Records name as a registered custom element to observe.\n   *\n   * Starts the Mutation Observer if this is the first registered custom\n   * element. This is deferred until the first custom element is defined to\n   * speed up initial rendering of the page.\n   *\n   * Mutation Observers are conveniently available in every browser we care\n   * about. When a node is connected to the root document, all custom\n   * elements (including that node iteself) will be upgraded and call\n   * connectedCallback. When a node is disconnectedCallback from the root\n   * document, all custom elements will call disconnectedCallback.\n   *\n   * @param {string} name\n   */\n  observe_(name) {\n    if (this.query_) {\n      this.query_ += `,${name}`;\n      return;\n    }\n\n    this.query_ = name;\n\n    // The first registered name starts the mutation observer.\n    const mo = new this.win_.MutationObserver((records) => {\n      if (records) {\n        this.handleRecords_(records);\n      }\n    });\n    this.mutationObserver_ = mo;\n\n    // I would love to not have to hold onto all of the roots, since it's a\n    // memory leak. Unfortunately, there's no way to iterate a list and hold\n    // onto its contents weakly.\n    for (const tree of this.roots_) {\n      mo.observe(tree, TRACK_SUBTREE);\n    }\n\n    installPatches(this.win_, this);\n  }\n\n  /**\n   * Adds the shadow tree to be observed by the polyfill.\n   *\n   * @param {!Node} tree\n   */\n  observe(tree) {\n    this.roots_.push(tree);\n    if (this.mutationObserver_) {\n      this.mutationObserver_.observe(tree, TRACK_SUBTREE);\n    }\n  }\n\n  /**\n   * This causes a synchronous handling of all the Mutation Observer's tracked\n   * mutations. This does nothing until the mutation observer is actually\n   * registered on the first Custom Element definition.\n   */\n  sync() {\n    if (this.mutationObserver_) {\n      this.handleRecords_(this.mutationObserver_.takeRecords());\n    }\n  }\n\n  /**\n   * Handle all the Mutation Observer's Mutation Records.\n   * All added custom elements will be upgraded (if not already) and call\n   * connectedCallback. All removed custom elements will call\n   * disconnectedCallback.\n   *\n   * @param {!Array<!MutationRecord>} records\n   */\n  handleRecords_(records) {\n    for (const record of records) {\n      if (!record) {\n        continue;\n      }\n\n      const {addedNodes, removedNodes} = record;\n      for (const node of addedNodes) {\n        const connectedCandidates = this.queryAll_(node, this.query_);\n        this.connectedCallback_(node);\n        for (const candidate of connectedCandidates) {\n          this.connectedCallback_(candidate);\n        }\n      }\n\n      for (const node of removedNodes) {\n        const disconnectedCandidates = this.queryAll_(node, this.query_);\n        this.disconnectedCallback_(node);\n        for (const candidate of disconnectedCandidates) {\n          this.disconnectedCallback_(candidate);\n        }\n      }\n    }\n  }\n}\n\n/**\n * Patches the DOM APIs to support synchronous Custom Elements.\n * @param {!Window} win\n * @param {!Registry} registry\n */\nfunction installPatches(win, registry) {\n  const {Document, Element, Node, document} = win;\n  const docProto = Document.prototype;\n  const elProto = Element.prototype;\n  const nodeProto = Node.prototype;\n  const {createElement, importNode} = docProto;\n  const {appendChild, cloneNode, insertBefore, removeChild, replaceChild} =\n    nodeProto;\n\n  // Patch createElement to immediately upgrade the custom element.\n  // This has the added benefit that it avoids the \"already created but needs\n  // constructor code run\" chicken-and-egg problem.\n  docProto.createElement = function (name) {\n    const def = registry.getByName(name);\n    if (def) {\n      return new def.ctor();\n    }\n    return createElement.apply(this, arguments);\n  };\n\n  // Patch importNode to immediately upgrade custom elements.\n  // TODO(jridgewell): Can fire adoptedCallback for cross doc imports.\n  docProto.importNode = function () {\n    const imported = importNode.apply(this, arguments);\n\n    // Only upgrade elements if the document that the nodes were imported into\n    // is _this_ document. If it's another document, then that document's\n    // element registry must do the upgrade.\n    // Eg, when importing from a <template>, the cloned document fragment\n    // should be upgraded. But importing from document into the <template>\n    // should not.\n    if (imported && this === document) {\n      registry.upgradeSelf(imported);\n      registry.upgrade(imported);\n    }\n    return imported;\n  };\n\n  // Patch appendChild to upgrade custom elements before returning.\n  nodeProto.appendChild = function () {\n    const appended = appendChild.apply(this, arguments);\n    registry.sync();\n    return appended;\n  };\n\n  // Patch insertBefore to upgrade custom elements before returning.\n  nodeProto.insertBefore = function () {\n    const inserted = insertBefore.apply(this, arguments);\n    registry.sync();\n    return inserted;\n  };\n\n  // Patch removeChild to upgrade custom elements before returning.\n  nodeProto.removeChild = function () {\n    const removed = removeChild.apply(this, arguments);\n    registry.sync();\n    return removed;\n  };\n\n  // Patch replaceChild to upgrade and detach custom elements before returning.\n  nodeProto.replaceChild = function () {\n    const replaced = replaceChild.apply(this, arguments);\n    registry.sync();\n    return replaced;\n  };\n\n  // Patch cloneNode to immediately upgrade custom elements.\n  nodeProto.cloneNode = function () {\n    const cloned = cloneNode.apply(this, arguments);\n\n    // Only upgrade elements if the cloned node belonged to _this_ document.\n    // Eg, when cloning a <template>'s content, the cloned document fragment\n    // does not belong to this document.\n    if (cloned.ownerDocument === document) {\n      registry.upgradeSelf(cloned);\n      registry.upgrade(cloned);\n    }\n    return cloned;\n  };\n\n  // Patch the innerHTML setter to immediately upgrade custom elements.\n  // Note, this could technically fire connectedCallbacks if this node was\n  // connected, but we leave that to the Mutation Observer.\n  let innerHTMLProto = elProto;\n  let innerHTMLDesc = Object.getOwnPropertyDescriptor(\n    innerHTMLProto,\n    'innerHTML'\n  );\n  if (!innerHTMLDesc) {\n    // Sigh... IE11 puts innerHTML desciptor on HTMLElement. But, we've\n    // replaced HTMLElement with a polyfill wrapper, so have to get its proto.\n    innerHTMLProto = Object.getPrototypeOf(win.HTMLElement.prototype);\n    innerHTMLDesc = Object.getOwnPropertyDescriptor(\n      innerHTMLProto,\n      'innerHTML'\n    );\n  }\n  if (innerHTMLDesc?.configurable) {\n    const innerHTMLSetter = innerHTMLDesc.set;\n    innerHTMLDesc.set = function (html) {\n      innerHTMLSetter.call(this, html);\n      registry.upgrade(this);\n    };\n    Object.defineProperty(\n      /** @type {!Object} */ (innerHTMLProto),\n      'innerHTML',\n      innerHTMLDesc\n    );\n  }\n}\n\n/**\n * Does the polyfilling.\n * @param {!Window} win\n */\nfunction polyfill(win) {\n  const {Element, HTMLElement, document} = win;\n  const {createElement} = document;\n\n  const registry = new Registry(win);\n  const customElements = new CustomElementRegistry(win, registry);\n\n  // Expose the custom element registry.\n  // Object.getOwnPropertyDescriptor(window, 'customElements')\n  // {get: \u0192, set: undefined, enumerable: true, configurable: true}\n  Object.defineProperty(win, 'customElements', {\n    enumerable: true,\n    configurable: true,\n    // writable: false,\n    value: customElements,\n  });\n\n  // Have to patch shadow methods now, since there's no way to find shadow trees\n  // later.\n  const elProto = Element.prototype;\n  const {attachShadow, createShadowRoot} = elProto;\n  if (attachShadow) {\n    /**\n     * @param {{mode: string}} unused\n     * @return {!ShadowRoot}\n     */\n    elProto.attachShadow = function (unused) {\n      const shadow = attachShadow.apply(this, arguments);\n      registry.observe(shadow);\n      return shadow;\n    };\n    // Necessary for Shadow AMP\n    elProto.attachShadow.toString = function () {\n      return attachShadow.toString();\n    };\n  }\n  if (createShadowRoot) {\n    /** @return {!ShadowRoot} */\n    elProto.createShadowRoot = function () {\n      const shadow = createShadowRoot.apply(this, arguments);\n      registry.observe(shadow);\n      return shadow;\n    };\n    // Necessary for Shadow AMP\n    elProto.createShadowRoot.toString = function () {\n      return createShadowRoot.toString();\n    };\n  }\n\n  /**\n   * You can't use the real HTMLElement constructor, because you can't subclass\n   * it without using native classes. So, mock its approximation using\n   * createElement.\n   * @return {!ElementOrigDef}\n   */\n  function HTMLElementPolyfill() {\n    const {constructor} = this;\n\n    // If we're upgrading an already created custom element, we can't create\n    // another new node (by the spec, it must be the same node).\n    let el = registry.current();\n\n    // If there's not a already created custom element, we're being invoked via\n    // `new`ing the constructor.\n    //\n    // Technically, we could get here via createElement, but we patched that.\n    // If it the custom element was registered, the patch turned it into a\n    // `new` call.\n    // If it was not registered, the native createElement is used. And if\n    // native createElement is being used and we got to this code, we're really\n    // in an infinite loop (a native createElement call just below) so we've\n    // got bigger problems.\n    //\n    // So just take my word we got here via `new`.\n    if (!el) {\n      // The custom element definition is an invariant. If the custom element\n      // is registered, everything works. If it's not, it throws in the member\n      // property access (only defined custom elements can be directly\n      // constructed via `new`).\n      const def = registry.getByConstructor(constructor);\n      el = createElement.call(document, def.name);\n    }\n\n    // Finally, if the node was already constructed, we need to reset its\n    // prototype to the custom element prototype. And if it wasn't already\n    // constructed, we created a new node via native createElement, and we need\n    // to reset its prototype. Basically always reset the prototype.\n    setPrototypeOf(el, constructor.prototype);\n    return el;\n  }\n  subClass(HTMLElement, HTMLElementPolyfill);\n\n  // Expose the polyfilled HTMLElement constructor for everyone to extend from.\n  win.HTMLElementOrig = win.HTMLElement;\n  win.HTMLElement = HTMLElementPolyfill;\n\n  // When we transpile `super` in Custom Element subclasses, we change it to\n  // `superClass.call(this)` (where `superClass` is `HTMLElementPolyfill`).\n  // That `.call` value is inherited from `Function.prototype`.\n  // But, IE11's native HTMLElement hierarchy doesn't extend from Function!\n  // And because `HTMLElementPolyfill` extends from `HTMLElement`, it doesn't\n  // have a `.call`! So we need to manually install it.\n  if (!HTMLElementPolyfill.call) {\n    HTMLElementPolyfill.apply = win.Function.apply;\n    HTMLElementPolyfill.bind = win.Function.bind;\n    HTMLElementPolyfill.call = win.Function.call;\n  }\n}\n\n/**\n * Wraps HTMLElement in a Reflect.construct constructor, so that transpiled\n * classes can `_this = superClass.call(this)` during their construction.\n *\n * This is only used when Custom Elements v1 is already available _and_ we're\n * using transpiled classes (which use ES5 construction idioms).\n *\n * @param {!Window} win\n * @suppress {globalThis}\n */\nfunction wrapHTMLElement(win) {\n  const {HTMLElement, Reflect} = win;\n  /** @return {!Element} */\n  function HTMLElementWrapper() {\n    const ctor = /** @type {function(...?):?|undefined} */ (this.constructor);\n\n    // Reflect.construct allows us to construct a new HTMLElement without using\n    // `new` (which will always fail because native HTMLElement is a restricted\n    // constructor).\n    return Reflect.construct(HTMLElement, [], ctor);\n  }\n  subClass(HTMLElement, HTMLElementWrapper);\n\n  // Expose the wrapped HTMLElement constructor for everyone to extend from.\n  win.HTMLElementOrig = win.HTMLElement;\n  win.HTMLElement = HTMLElementWrapper;\n}\n\n/**\n * Setups up prototype inheritance\n *\n * @param {!SUPER} superClass\n * @param {!SUB} subClass\n * @template SUPER\n * @template SUB\n */\nfunction subClass(superClass, subClass) {\n  // Object.getOwnPropertyDescriptor(superClass.prototype, 'constructor')\n  // {value: \u0192, writable: true, enumerable: false, configurable: true}\n  subClass.prototype = Object.create(superClass.prototype, {\n    constructor: {\n      // enumerable: false,\n      configurable: true,\n      writable: true,\n      value: subClass,\n    },\n  });\n  setPrototypeOf(subClass, superClass);\n}\n\n/**\n * Tests whether setting '__proto__' will change the prototype chain of an\n * object. Only needed for old IE.\n * @return {boolean}\n */\nfunction supportsUnderProto() {\n  const proto = {'test': true};\n  const obj = {};\n  obj.__proto__ = proto;\n  return !!obj['test'];\n}\n\n/**\n * Sets the prototype chain of an object, with various fallbacks to support\n * old IE.\n * @param {!Object} obj\n * @param {!Object} prototype\n * @suppress {suspiciousCode} due to IS_ESM inlining\n */\nfunction setPrototypeOf(obj, prototype) {\n  if (IS_ESM || Object.setPrototypeOf) {\n    // Every decent browser.\n    Object.setPrototypeOf(obj, prototype);\n  } else if (supportsUnderProto()) {\n    // IE11\n    obj.__proto__ = prototype;\n  } else {\n    // IE10 man. :sigh:\n    copyProperties(obj, prototype);\n  }\n}\n\n/**\n * Copies the property descriptors from prototype to obj. This is only\n * necessary for old IE, which can't properly set the prototype of an already\n * created object.\n * @param {!Object} obj\n * @param {!Object} prototype\n * @visibleForTesting\n */\nexport function copyProperties(obj, prototype) {\n  let current = prototype;\n  while (current !== null) {\n    if (Object.isPrototypeOf.call(current, obj)) {\n      break;\n    }\n\n    for (const prop of Object.getOwnPropertyNames(current)) {\n      if (Object.hasOwnProperty.call(obj, prop)) {\n        continue;\n      }\n\n      const desc = /** @type {!ObjectPropertyDescriptor<Object>} */ (\n        Object.getOwnPropertyDescriptor(current, prop)\n      );\n      Object.defineProperty(obj, prop, desc);\n    }\n\n    current = Object.getPrototypeOf(current);\n  }\n}\n\n/**\n * Polyfills Custom Elements v1 API. This has 5 modes:\n *\n * 1. Custom elements v1 already supported, using native classes\n * 2. Custom elements v1 already supported, using transpiled classes\n * 3. Custom elements v1 not supported, using native classes\n * 4. Custom elements v1 not supported, using transpiled classes\n * 5. No sample class constructor provided\n *\n * In mode 1, nothing is done. In mode 2, a minimal polyfill is used to support\n * extending the HTMLElement base class. In mode 3, 4, and 5 a full polyfill is\n * done.\n *\n * @param {!Window} win\n * @param {!Function} ctor\n */\nexport function install(win, ctor) {\n  // Don't install in no-DOM environments e.g. worker.\n  const shouldInstall = win.document;\n  const hasCE = hasCustomElements(win);\n  if (!shouldInstall || (hasCE && isPatched(win))) {\n    return;\n  }\n\n  let install = true;\n  let installWrapper = false;\n\n  if (ctor && hasCE) {\n    // If ctor is constructable without new, it's a function. That means it was\n    // compiled down, and we need to do the minimal polyfill because all you\n    // cannot extend HTMLElement without native classes.\n    try {\n      const {Reflect} = win;\n\n      // \"Construct\" ctor using ES5 idioms\n      // I'm not sure why, but Closure will complain at the\n      // `Function.call.call()` below unless we cast to a Function instance\n      // here.\n      const instance = /** @type {!Function} */ (Object.create(ctor.prototype));\n\n      // This will throw an error unless we're in a transpiled environemnt.\n      // Native classes must be called as `new Ctor`, not `Ctor.call(instance)`.\n      // We use `Function.call.call` because Closure is too smart for regular\n      // `Ctor.call`.\n      Function.call.call(ctor, instance);\n\n      // If that didn't throw, we're transpiled.\n      // Let's find out if we can wrap HTMLElement and avoid a full patch.\n      installWrapper = !!Reflect?.construct;\n    } catch (e) {\n      // The ctor threw when we constructed it via ES5, so it's a real class.\n      // We're ok to not install the polyfill.\n      install = false;\n    }\n  }\n\n  if (installWrapper) {\n    wrapHTMLElement(win);\n  } else if (install) {\n    polyfill(win);\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Polyfill for `DOMTokenList.prototype.toggle(token, opt_force)` method. This\n * is specially important because IE does not support `opt_force` attribute. See\n * https://goo.gl/hgKNYY for details.\n * @param {string} token\n * @param {boolean=} opt_force\n * @this {DOMTokenList}\n * @return {boolean}\n */\nfunction domTokenListTogglePolyfill(token, opt_force) {\n  // eslint-disable-next-line local/no-invalid-this\n  const remove = opt_force === undefined ? this.contains(token) : !opt_force;\n  if (remove) {\n    // eslint-disable-next-line local/no-invalid-this\n    this.remove(token);\n    return false;\n  } else {\n    // eslint-disable-next-line local/no-invalid-this\n    this.add(token);\n    return true;\n  }\n}\n\n/**\n * Polyfills `DOMTokenList.prototype.toggle` API and makes `.add` accepts N\n * classes in IE.\n * @param {!Window} win\n */\nexport function install(win) {\n  if (isIe(win) && win.DOMTokenList) {\n    win.Object.defineProperty(win.DOMTokenList.prototype, 'toggle', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: domTokenListTogglePolyfill,\n    });\n\n    const {add} = win.DOMTokenList.prototype;\n    win.DOMTokenList.prototype.add = function () {\n      for (let i = 0; i < arguments.length; i++) {\n        add.call(this, arguments[i]);\n      }\n    };\n  }\n}\n\n/**\n * Whether the current browser is a IE browser.\n * @param {!Window} win\n * @return {boolean}\n */\nfunction isIe(win) {\n  return /Trident|MSIE|IEMobile/i.test(win.navigator.userAgent);\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Polyfill for `document.contains()` method. Notice that according to spec\n * `document.contains` is inclusionary.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/contains\n * @param {?Node} node\n * @return {boolean}\n * @this {Document}\n */\nfunction documentContainsPolyfill(node) {\n  // Per spec, \"contains\" method is inclusionary\n  // i.e. `node.contains(node) == true`. However, we still need to test\n  // equality to the document itself.\n  // eslint-disable-next-line local/no-invalid-this\n  return node == this || this.documentElement.contains(node);\n}\n\n/**\n * Polyfills `HTMLDocument.contains` API.\n * @param {!Window} win\n */\nexport function install(win) {\n  // HTMLDocument is undefined in Internet Explorer 10, but it has Document,\n  // so we use that as a fallback.\n  const documentClass = win.HTMLDocument || win.Document;\n  if (documentClass && !documentClass.prototype.contains) {\n    win.Object.defineProperty(documentClass.prototype, 'contains', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: documentContainsPolyfill,\n    });\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Converts an array-like object to an array.\n * @param {?IArrayLike<T>|string} arrayLike\n * @return {!Array<T>}\n * @template T\n */\nexport function toArray(arrayLike) {\n  return arrayLike ? Array.prototype.slice.call(arrayLike) : [];\n}\n\n/**\n * Determines if value is actually an Array.\n * @param {*} value\n * @return {boolean}\n */\nexport const {isArray} = Array;\n\n/**\n * If the specified argument is an array, it's returned as is. If it's a\n * single item, the array containing this item is created and returned.\n *\n * The double-template pattern here solves a bug where CC can be passed a value\n * with declared type {string|!Array<string>} and return a value with a type of\n * {!Array<string|Array<string>>}.\n *\n * @param {!Array<T>|S} arrayOrSingleItem\n * @return {!Array<T>|!Array<S>}\n * @template S\n * @template T\n */\nexport function arrayOrSingleItemToArray(arrayOrSingleItem) {\n  return isArray(arrayOrSingleItem)\n    ? /** @type {!Array<T>} */ (arrayOrSingleItem)\n    : [/** @type {!S} */ (arrayOrSingleItem)];\n}\n\n/**\n * Compares if two arrays contains exactly same elements of same number\n * of same order. Note that it does NOT handle NaN case as expected.\n *\n * @param {!Array<T>} arr1\n * @param {!Array<T>} arr2\n * @return {boolean}\n * @template T\n */\nexport function areEqualOrdered(arr1, arr2) {\n  if (arr1.length !== arr2.length) {\n    return false;\n  }\n  for (let i = 0; i < arr1.length; i++) {\n    if (arr1[i] !== arr2[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Removes elements that shouldRemove returns true for from the array.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} shouldRemove\n * @return {!Array<T>}\n * @template T\n */\nexport function remove(array, shouldRemove) {\n  const removed = [];\n  let index = 0;\n  for (let i = 0; i < array.length; i++) {\n    const item = array[i];\n    if (shouldRemove(item, i, array)) {\n      removed.push(item);\n    } else {\n      if (index < i) {\n        array[index] = item;\n      }\n      index++;\n    }\n  }\n  if (index < array.length) {\n    array.length = index;\n  }\n  return removed;\n}\n\n/**\n * Returns the index of the first element matching the predicate.\n * Like Array#findIndex.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} predicate\n * @return {number}\n * @template T\n */\nexport function findIndex(array, predicate) {\n  for (let i = 0; i < array.length; i++) {\n    if (predicate(array[i], i, array)) {\n      return i;\n    }\n  }\n  return -1;\n}\n\n/**\n * Converts the given iterator to an array.\n *\n * @param {!Iterator<T>} iterator\n * @return {Array<T>}\n * @template T\n */\nexport function fromIterator(iterator) {\n  const array = [];\n  for (let e = iterator.next(); !e.done; e = iterator.next()) {\n    array.push(e.value);\n  }\n  return array;\n}\n\n/**\n * Adds item to array if it is not already present.\n *\n * @param {Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function pushIfNotExist(array, item) {\n  if (array.indexOf(item) < 0) {\n    array.push(item);\n    return true;\n  }\n  return false;\n}\n\n/**\n * Removes the first matching item in the array. Returns `true` if the array\n * has changed.\n *\n * @param {!Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function removeItem(array, item) {\n  const index = array.indexOf(item);\n  if (index == -1) {\n    return false;\n  }\n  array.splice(index, 1);\n  return true;\n}\n\n/**\n * Returns the last item in an array.\n *\n * @param {Array<T>} array\n * @template T\n * @return {?T}\n */\nexport function lastItem(array) {\n  return array[array.length - 1];\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Checks whether `val` is a valid value of `enumObj`.\n *\n * @param {!Object<T>} enumObj\n * @param {T} val\n * @return {boolean}\n * @template T\n */\nexport function isEnumValue(enumObj, val) {\n  for (const k in enumObj) {\n    if (enumObj[k] === val) {\n      return true;\n    }\n  }\n  return false;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {string} _match\n * @param {string} character\n * @return {string}\n */\nfunction toUpperCase(_match, character) {\n  return character.toUpperCase();\n}\n\n/**\n * @param {string} match\n * @return {string}\n */\nfunction prependDashAndToLowerCase(match) {\n  return '-' + match.toLowerCase();\n}\n\n/**\n * @param {string} name Attribute name containing dashes.\n * @return {string} Dashes removed and successive character sent to upper case.\n * visibleForTesting\n */\nexport function dashToCamelCase(name) {\n  return name.replace(/-([a-z])/g, toUpperCase);\n}\n\n/**\n * Converts a string that is in camelCase to one that is in dash-case.\n *\n * @param {string} string The string to convert.\n * @return {string} The string in dash-case.\n */\nexport function camelCaseToDash(string) {\n  return string.replace(/(?!^)[A-Z]/g, prependDashAndToLowerCase);\n}\n\n/**\n * @param {string} name Attribute name with dashes\n * @return {string} Dashes replaced by underlines.\n */\nexport function dashToUnderline(name) {\n  return name.replace('-', '_');\n}\n\n/**\n * Polyfill for String.prototype.endsWith.\n * @param {string} string\n * @param {string} suffix\n * @return {boolean}\n */\nexport function endsWith(string, suffix) {\n  const index = string.length - suffix.length;\n  return index >= 0 && string.indexOf(suffix, index) == index;\n}\n\n/**\n * Polyfill for String.prototype.includes.\n * @param {string} string\n * @param {string} substring\n * @param {number=} start\n * @return {boolean}\n */\nexport function includes(string, substring, start) {\n  if (typeof start !== 'number') {\n    start = 0;\n  }\n  if (start + substring.length > string.length) {\n    return false;\n  }\n  return string.indexOf(substring, start) !== -1;\n}\n\n/**\n * Expands placeholders in a given template string with values.\n *\n * Placeholders use ${key-name} syntax and are replaced with the value\n * returned from the given getter function.\n *\n * @param {string} template The template string to expand.\n * @param {function(string):*} getter Function used to retrieve a value for a\n *   placeholder. Returns values will be coerced into strings.\n * @param {number=} opt_maxIterations Number of times to expand the template.\n *   Defaults to 1, but should be set to a larger value your placeholder tokens\n *   can be expanded to other placeholder tokens. Take caution with large values\n *   as recursively expanding a string can be exponentially expensive.\n * @return {string}\n */\nexport function expandTemplate(template, getter, opt_maxIterations) {\n  const maxIterations = opt_maxIterations || 1;\n  for (let i = 0; i < maxIterations; i++) {\n    let matches = 0;\n    template = template.replace(/\\${([^}]*)}/g, (_a, b) => {\n      matches++;\n      return getter(b);\n    });\n    if (!matches) {\n      break;\n    }\n  }\n  return template;\n}\n\n/**\n * Hash function djb2a\n * This is intended to be a simple, fast hashing function using minimal code.\n * It does *not* have good cryptographic properties.\n * @param {string} str\n * @return {string} 32-bit unsigned hash of the string\n */\nexport function stringHash32(str) {\n  const {length} = str;\n  let hash = 5381;\n  for (let i = 0; i < length; i++) {\n    hash = (hash * 33) ^ str.charCodeAt(i);\n  }\n  // Convert from 32-bit signed to unsigned.\n  return String(hash >>> 0);\n}\n\n/**\n * Trims a string on the end, removing whitespace characters.\n * @param {string} str  A string to trim.\n * @return {string} The string, with trailing whitespace removed.\n */\nexport function trimEnd(str) {\n  // TODO(sparhami) Does this get inlined for an ES2019 build?\n  if (str.trimEnd) {\n    return str.trimEnd();\n  }\n\n  return ('_' + str).trim().slice(1);\n}\n\n/**\n * Trims any leading whitespace from a string.\n * @param {string} str  A string to trim.\n * @return {string} The string, with leading whitespace removed.\n */\nexport function trimStart(str) {\n  if (str.trimStart) {\n    return str.trimStart();\n  }\n\n  return (str + '_').trim().slice(0, -1);\n}\n\n/**\n * Wrapper around String.replace that handles asynchronous resolution.\n * @param {string} str\n * @param {RegExp} regex\n * @param {Function|string} replacer\n * @return {!Promise<string>}\n */\nexport function asyncStringReplace(str, regex, replacer) {\n  if (isString(replacer)) {\n    return Promise.resolve(str.replace(regex, replacer));\n  }\n  const stringBuilder = [];\n  let lastIndex = 0;\n\n  str.replace(regex, function (match) {\n    // String.prototype.replace will pass 3 to n number of arguments to the\n    // callback function based on how many capture groups the regex may or may\n    // not contain. We know that the match will always be first, and the\n    // index will always be second to last.\n    const matchIndex = arguments[arguments.length - 2];\n    stringBuilder.push(str.slice(lastIndex, matchIndex));\n    lastIndex = matchIndex + match.length;\n\n    // Store the promise in it's eventual string position.\n    const replacementPromise = replacer.apply(null, arguments);\n    stringBuilder.push(replacementPromise);\n  });\n  stringBuilder.push(str.slice(lastIndex));\n\n  return Promise.all(stringBuilder).then((resolved) => resolved.join(''));\n}\n\n/**\n * Pads the beginning of a string with a substring to a target length.\n * @param {string} s\n * @param {number} targetLength\n * @param {string} padString\n * @return {string}\n */\nexport function padStart(s, targetLength, padString) {\n  if (s.length >= targetLength) {\n    return s;\n  }\n  targetLength = targetLength - s.length;\n  let padding = padString;\n  while (targetLength > padding.length) {\n    padding += padString;\n  }\n  return padding.slice(0, targetLength) + s;\n}\n\n/**\n * Tests if a value is a string.\n * @param {?} s\n * @return {boolean}\n */\nexport function isString(s) {\n  return typeof s == 'string';\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Export all type-checking helpers for convenience\nexport {isArray} from './array';\nexport {isEnumValue} from './enum';\nexport {isString} from './string';\nexport {isObject} from './object';\n\n/**\n * Determines if value is an ELement\n * @param {*} value\n * @return {boolean}\n */\nexport function isElement(value) {\n  return value?.nodeType == /* Node.ELEMENT_NODE */ 1;\n}\n\n/**\n * Determines if value is of number type and finite.\n * NaN and Infinity are not considered a finite number.\n * String numbers are not considered numbers.\n * @param {*} value\n * @return {boolean}\n */\nexport function isFiniteNumber(value) {\n  return typeof value === 'number' && isFinite(value);\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isElement} from '../types';\n\n/**\n * Triple zero width space.\n *\n * This is added to user error messages, so that we can later identify\n * them, when the only thing that we have is the message. This is the\n * case in many browsers when the global exception handler is invoked.\n *\n * @const {string}\n */\nexport const USER_ERROR_SENTINEL = '\\u200B\\u200B\\u200B';\n\n/**\n * Converts an element to a readable string; all other types are unchanged.\n * TODO(rcebulko): Unify with log.js\n * @param {*} val\n * @return {*}\n */\nexport function elementStringOrPassThru(val) {\n  // Do check equivalent to `val instanceof Element` without cross-window bug\n  if (isElement(val)) {\n    val = /** @type {Element} */ (val);\n    return val.tagName.toLowerCase() + (val.id ? `#${val.id}` : '');\n  }\n  return val;\n}\n\n/**\n * Tests if an error message contains the user sentinel.\n * @param {string} message\n * @return {boolean} Whether this message was a user error.\n */\nexport function isUserErrorMessage(message) {\n  return message.indexOf(USER_ERROR_SENTINEL) >= 0;\n}\n\n/**\n * Strips the user error sentinel from an error message.\n * @param {string} message\n * @return {string} The new message without USER_ERROR_SENTINEL\n */\nexport function stripUserError(message) {\n  return message.replace(USER_ERROR_SENTINEL, '');\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {elementStringOrPassThru} from '../error/message-helpers';\nimport {includes} from '../types/string';\nimport {isArray, isElement, isString} from '../types';\nimport {remove} from '../types/array';\n\n/**\n * @fileoverview This file provides the base implementation for assertion\n * functions. Most files should never import from this; instead, import from\n * `dev` or `user`. It is also used by the Log class for its assertions.\n */\n\n/**\n * A base assertion function, provided to various assertion helpers.\n * @typedef {function(?, string=, ...*):?|function(?, !Array<*>)}\n */\nexport let AssertionFunctionDef;\n\n/**\n * Throws an error if the second argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n * @param {?string} sentinel\n * @param {T} shouldBeTruthy\n * @param {string} opt_message\n * @param {...*} var_args Arguments substituted into %s in the message\n * @return {T}\n * @template T\n * @throws {Error} when shouldBeTruthy is not truthy.\n */\nexport function assert(\n  sentinel,\n  shouldBeTruthy,\n  opt_message = 'Assertion failed',\n  var_args\n) {\n  if (shouldBeTruthy) {\n    return shouldBeTruthy;\n  }\n\n  // Include the sentinel string if provided and not already present\n  if (sentinel && !includes(opt_message, sentinel)) {\n    opt_message += sentinel;\n  }\n\n  // Skip the first 3 arguments to isolate format params\n  // const messageArgs = Array.prototype.slice.call(arguments, 3);\n  // Index at which message args start\n  let i = 3;\n\n  // Substitute provided values into format string in message\n  const splitMessage = opt_message.split('%s');\n  let message = splitMessage.shift();\n  const messageArray = [message];\n\n  while (splitMessage.length) {\n    const subValue = arguments[i++];\n    const nextConstant = splitMessage.shift();\n\n    message += elementStringOrPassThru(subValue) + nextConstant;\n    messageArray.push(subValue, nextConstant.trim());\n  }\n\n  const error = new Error(message);\n  error.messageArray = remove(messageArray, (x) => x !== '');\n  // __AMP_REPORT_ERROR is installed globally per window in the entry point in\n  // AMP documents. It may not be present for Bento/Preact elements on non-AMP\n  // pages.\n  self.__AMP_REPORT_ERROR?.(error);\n  throw error;\n}\n\n/**\n * Asserts types, backbone of `assertNumber`, `assertString`, etc.\n *\n * It understands array-based \"id\"-contracted messages.\n *\n * Otherwise creates a sprintf syntax string containing the optional message or the\n * default. The `subject` of the assertion is added at the end.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {T} subject\n * @param {*} shouldBeTruthy\n * @param {string} defaultMessage\n * @param {!Array<*>|string=} opt_message\n * @return {T}\n * @template T\n * @private\n */\nfunction assertType_(\n  assertFn,\n  subject,\n  shouldBeTruthy,\n  defaultMessage,\n  opt_message\n) {\n  if (isArray(opt_message)) {\n    assertFn(\n      shouldBeTruthy,\n      /** @type {!Array} */ (opt_message).concat([subject])\n    );\n  } else {\n    assertFn(shouldBeTruthy, `${opt_message || defaultMessage}: %s`, subject);\n  }\n\n  return subject;\n}\n\n/**\n * Throws an error if the first argument isn't an Element.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeElement\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Element} The value of shouldBeTrueish.\n * @throws {Error} when shouldBeElement is not an Element\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertElement(assertFn, shouldBeElement, opt_message) {\n  return /** @type {!Element} */ (\n    assertType_(\n      assertFn,\n      shouldBeElement,\n      isElement(shouldBeElement),\n      'Element expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a string. The string can\n * be empty.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeString\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {string} The string value. Can be an empty string.\n * @throws {Error} when shouldBeString is not an String\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertString(assertFn, shouldBeString, opt_message) {\n  return /** @type {string} */ (\n    assertType_(\n      assertFn,\n      shouldBeString,\n      isString(shouldBeString),\n      'String expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a number. The allowed values\n * include `0` and `NaN`.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeNumber\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {number} The number value. The allowed values include `0`\n *   and `NaN`.\n * @throws {Error} when shouldBeNumber is not an Number\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertNumber(assertFn, shouldBeNumber, opt_message) {\n  return /** @type {number} */ (\n    assertType_(\n      assertFn,\n      shouldBeNumber,\n      typeof shouldBeNumber == 'number',\n      'Number expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument is not an array.\n * The array can be empty.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeArray\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Array} The array value\n * @throws {Error} when shouldBeArray is not an Array\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertArray(assertFn, shouldBeArray, opt_message) {\n  return /** @type {!Array} */ (\n    assertType_(\n      assertFn,\n      shouldBeArray,\n      isArray(shouldBeArray),\n      'Array expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a boolean.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeBoolean\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {boolean} The boolean value.\n * @throws {Error} when shouldBeBoolean is not an Boolean\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertBoolean(assertFn, shouldBeBoolean, opt_message) {\n  return /** @type {boolean} */ (\n    assertType_(\n      assertFn,\n      shouldBeBoolean,\n      !!shouldBeBoolean === shouldBeBoolean,\n      'Boolean expected',\n      opt_message\n    )\n  );\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns the internal AMP runtime version. Note that this is not the RTV,\n * which is a prefix and the runtime version.\n *\n * The call sites for this function are replaced with a compile time constant\n * string.\n *\n * @return {string}\n */\nexport function internalRuntimeVersion() {\n  return '$internalRuntimeVersion$';\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {map} from '../object';\n\nconst QUERY_STRING_REGEX = /(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;\n\n/**\n * Tries to decode a URI component, falling back to opt_fallback (or an empty\n * string)\n *\n * @param {string} component\n * @param {string=} fallback\n * @return {string}\n */\nexport function tryDecodeUriComponent(component, fallback = '') {\n  try {\n    return decodeURIComponent(component);\n  } catch (e) {\n    return fallback;\n  }\n}\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\nexport function parseQueryString(queryString) {\n  const params = map();\n  if (!queryString) {\n    return params;\n  }\n\n  let match;\n  while ((match = QUERY_STRING_REGEX.exec(queryString))) {\n    const name = tryDecodeUriComponent(match[1], match[1]);\n    const value = match[2]\n      ? tryDecodeUriComponent(match[2].replace(/\\+/g, ' '), match[2])\n      : '';\n    params[name] = value;\n  }\n  return params;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalRuntimeVersion} from './internal-version';\nimport {parseQueryString} from './core/types/string/url';\n\n/**\n * @typedef {{\n *   localDev: boolean,\n *   development: boolean,\n *   minified: boolean,\n *   test: boolean,\n *   examiner: boolean,\n *   log: (string|undefined),\n *   version: string,\n *   rtvVersion: string,\n *   runtime: (null|string|undefined),\n *   a4aId: (null|string|undefined),\n *   esm: (boolean|undefined),\n * }}\n */\nexport let ModeDef;\n\n/**\n * `rtvVersion` is the prefixed version we serve off of the cdn.\n * The prefix denotes canary(00) or prod(01) or an experiment version ( > 01).\n * @type {string}\n */\nlet rtvVersion = '';\n\n/**\n * Provides info about the current app.\n * @param {?Window=} opt_win\n * @return {!ModeDef}\n */\nexport function getMode(opt_win) {\n  const win = opt_win || self;\n  if (win.__AMP_MODE) {\n    return win.__AMP_MODE;\n  }\n  return (win.__AMP_MODE = getMode_(win));\n}\n\n/**\n * Provides info about the current app.\n * @param {!Window} win\n * @return {!ModeDef}\n */\nfunction getMode_(win) {\n  // TODO(erwinmombay): simplify the logic here\n  const AMP_CONFIG = self.AMP_CONFIG || {};\n\n  // Magic constants that are replaced by closure compiler.\n  // IS_MINIFIED is always replaced with true when closure compiler is used\n  // while IS_FORTESTING is only replaced when `amp dist` is called without the\n  // --fortesting flag.\n  const IS_FORTESTING = true;\n  const IS_MINIFIED = false;\n\n  const runningTests =\n    IS_FORTESTING && !!(AMP_CONFIG.test || win.__AMP_TEST || win['__karma__']);\n  const isLocalDev = IS_FORTESTING && (!!AMP_CONFIG.localDev || runningTests);\n  const hashQuery = parseQueryString(\n    // location.originalHash is set by the viewer when it removes the fragment\n    // from the URL.\n    win.location['originalHash'] || win.location.hash\n  );\n\n  if (!rtvVersion) {\n    rtvVersion = getRtvVersion(win);\n  }\n\n  // The `minified`, `test` and `localDev` properties are replaced\n  // as boolean literals when we run `amp dist` without the `--fortesting`\n  // flags. This improved DCE on the production file we deploy as the code\n  // paths for localhost/testing/development are eliminated.\n  return {\n    localDev: isLocalDev,\n    development: isModeDevelopment(win),\n    examiner: hashQuery['development'] == '2',\n    esm: IS_ESM,\n    // amp-geo override\n    geoOverride: hashQuery['amp-geo'],\n    minified: IS_MINIFIED,\n    test: runningTests,\n    log: hashQuery['log'],\n    version: internalRuntimeVersion(),\n    rtvVersion,\n  };\n}\n\n/**\n * Retrieve the `rtvVersion` which will have a numeric prefix\n * denoting canary/prod/experiment (unless `isLocalDev` is true).\n *\n * @param {!Window} win\n * @return {string}\n */\nfunction getRtvVersion(win) {\n  if (win.AMP_CONFIG && win.AMP_CONFIG.v) {\n    return win.AMP_CONFIG.v;\n  }\n\n  // Currently `internalRuntimeVersion` and thus `mode.version` contain only\n  // major version. The full version however must also carry the minor version.\n  // We will default to production default `01` minor version for now.\n  // TODO(erwinmombay): decide whether internalRuntimeVersion should contain\n  // minor version.\n  return `01${internalRuntimeVersion()}`;\n}\n\n/**\n * Triggers validation or enable pub level logging. Validation can be\n * bypassed via #validate=0.\n * Note that AMP_DEV_MODE flag is used for testing purposes.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isModeDevelopment(win) {\n  const hashQuery = parseQueryString(\n    win.location['originalHash'] || win.location.hash\n  );\n  return !!(\n    ['1', 'actions', 'amp', 'amp4ads', 'amp4email'].includes(\n      hashQuery['development']\n    ) || win.AMP_DEV_MODE\n  );\n}\n\n/**\n * @param {!Window} win\n * @return {string}\n * @visibleForTesting\n */\nexport function getRtvVersionForTesting(win) {\n  return getRtvVersion(win);\n}\n\n/** @visibleForTesting */\nexport function resetRtvVersionForTesting() {\n  rtvVersion = '';\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @fileoverview Helpers to wrap functions. */\n\n/**\n * Creates a function that is evaluated only once and returns the cached result\n * subsequently.\n *\n * Please note that `once` only takes the function definition into account,\n * so it will return the same cached value even when the arguments are\n * different.\n *\n * @param {function(...):T} fn\n * @return {function(...):T}\n * @template T\n */\nexport function once(fn) {\n  let evaluated = false;\n  let retValue = null;\n  let callback = fn;\n  return (...args) => {\n    if (!evaluated) {\n      retValue = callback.apply(self, args);\n      evaluated = true;\n      callback = null; // GC\n    }\n    return retValue;\n  };\n}\n\n/**\n * Wraps a given callback and applies a rate limit.\n * It throttles the calls so that no consequent calls have time interval\n * smaller than the given minimal interval.\n *\n * @param {!Window} win\n * @param {function(...T):R} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...T)}\n * @template T\n * @template R\n */\nexport function throttle(win, callback, minInterval) {\n  let locker = 0;\n  let nextCallArgs = null;\n\n  /**\n   * @param {!Object} args\n   */\n  function fire(args) {\n    nextCallArgs = null;\n    // Lock the fire for minInterval milliseconds\n    locker = win.setTimeout(waiter, minInterval);\n\n    callback.apply(null, args);\n  }\n\n  /**\n   * Waiter function\n   */\n  function waiter() {\n    locker = 0;\n    // If during the period there're invocations queued up, fire once.\n    if (nextCallArgs) {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function (...args) {\n    if (locker) {\n      nextCallArgs = args;\n    } else {\n      fire(args);\n    }\n  };\n}\n\n/**\n * Wraps a given callback and applies a wait timer, so that minInterval\n * milliseconds must pass since the last call before the callback is actually\n * invoked.\n *\n * @param {!Window} win\n * @param {function(...T):R} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...T)}\n * @template T\n * @template R\n */\nexport function debounce(win, callback, minInterval) {\n  let locker = 0;\n  let timestamp = 0;\n  let nextCallArgs = null;\n\n  /**\n   * @param {?Array} args\n   */\n  function fire(args) {\n    nextCallArgs = null;\n    callback.apply(null, args);\n  }\n\n  /**\n   * Wait function for debounce\n   */\n  function waiter() {\n    locker = 0;\n    const remaining = minInterval - (win.Date.now() - timestamp);\n    if (remaining > 0) {\n      locker = win.setTimeout(waiter, remaining);\n    } else {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function (...args) {\n    timestamp = win.Date.now();\n    nextCallArgs = args;\n    if (!locker) {\n      locker = win.setTimeout(waiter, minInterval);\n    }\n  };\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Allows for runtime configuration. Internally, the runtime should\n * use the src/config.js module for various constants. We can use the\n * AMP_CONFIG global to translate user-defined configurations to this\n * module.\n * @type {!Object<string, string>}\n */\nconst env = self.AMP_CONFIG || {};\n\nconst thirdPartyFrameRegex =\n  (typeof env['thirdPartyFrameRegex'] == 'string'\n    ? new RegExp(env['thirdPartyFrameRegex'])\n    : env['thirdPartyFrameRegex']) || /^d-\\d+\\.ampproject\\.net$/;\n\nconst cdnProxyRegex =\n  (typeof env['cdnProxyRegex'] == 'string'\n    ? new RegExp(env['cdnProxyRegex'])\n    : env['cdnProxyRegex']) ||\n  /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org$/;\n\n/**\n * Check for a custom URL definition in special <meta> tags. Note that this does\n * not allow for distinct custom URLs in AmpDocShadow instances. The shell is\n * allowed to define one set of custom URLs via AMP_CONFIG (recommended) or by\n * including <meta> tags in the shell <head>. Those custom URLs then apply to\n * all AMP documents loaded in the shell.\n * @param {string} name\n * @return {?string}\n * @private\n */\nfunction getMetaUrl(name) {\n  // Avoid exceptions in unit tests\n  if (!self.document || !self.document.head) {\n    return null;\n  }\n\n  // Disallow on proxy origins\n  if (self.location && cdnProxyRegex.test(self.location.origin)) {\n    return null;\n  }\n\n  const metaEl = self.document.head./*OK*/ querySelector(\n    `meta[name=\"${name}\"]`\n  );\n  return (metaEl && metaEl.getAttribute('content')) || null;\n}\n\n/**\n * @typedef {{\n *   thirdParty: string,\n *   thirdPartyFrameHost: string,\n *   thirdPartyFrameRegex: !RegExp,\n *   cdn: string,\n *   cdnProxyRegex: !RegExp,\n *   localhostRegex: !RegExp,\n *   errorReporting: string,\n *   betaErrorReporting: string,\n *   localDev: boolean,\n *   trustedViewerHosts: !Array<!RegExp>,\n *   geoApi: ?string,\n * }}\n */\nexport const urls = {\n  thirdParty: env['thirdPartyUrl'] || 'https://3p.ampproject.net',\n  thirdPartyFrameHost: env['thirdPartyFrameHost'] || 'ampproject.net',\n  thirdPartyFrameRegex,\n  cdn:\n    env['cdnUrl'] || getMetaUrl('runtime-host') || 'https://cdn.ampproject.org',\n  /* Note that cdnProxyRegex is only ever checked against origins\n   * (proto://host[:port]) so does not need to consider path\n   */\n  cdnProxyRegex,\n  localhostRegex: /^https?:\\/\\/localhost(:\\d+)?$/,\n  errorReporting:\n    env['errorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r',\n  betaErrorReporting:\n    env['betaErrorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r-beta',\n  localDev: env['localDev'] || false,\n  /**\n   * These domains are trusted with more sensitive viewer operations such as\n   * propagating the referrer. If you believe your domain should be here,\n   * file the issue on GitHub to discuss. The process will be similar\n   * (but somewhat more stringent) to the one described in the [3p/README.md](\n   * https://github.com/ampproject/amphtml/blob/main/3p/README.md)\n   *\n   * {!Array<!RegExp>}\n   */\n  trustedViewerHosts: [\n    /(^|\\.)google\\.(com?|[a-z]{2}|com?\\.[a-z]{2}|cat)$/,\n    /(^|\\.)gmail\\.(com|dev)$/,\n  ],\n  // Optional fallback API if amp-geo is left unpatched\n  geoApi: env['geoApiUrl'] || getMetaUrl('amp-geo-api'),\n};\n\nexport const config = {\n  urls,\n};\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assertions from './core/assert/base';\nimport {\n  USER_ERROR_SENTINEL,\n  elementStringOrPassThru,\n  isUserErrorMessage,\n  stripUserError,\n} from './core/error/message-helpers';\nimport {createErrorVargs, duplicateErrorIfNecessary} from './core/error';\nimport {getMode} from './mode';\nimport {internalRuntimeVersion} from './internal-version';\nimport {isArray} from './core/types';\nimport {once} from './core/types/function';\nimport {urls} from './config';\n\nconst noop = () => {};\n\n// These are exported here despite being defined in core to avoid updating\n// imports for now.\nexport {USER_ERROR_SENTINEL, isUserErrorMessage, stripUserError};\n\n/**\n * Four zero width space.\n *\n * @const {string}\n */\nexport const USER_ERROR_EMBED_SENTINEL = '\\u200B\\u200B\\u200B\\u200B';\n\n/**\n * @param {string} message\n * @return {boolean} Whether this message was a a user error from an iframe embed.\n */\nexport function isUserErrorEmbed(message) {\n  return message.indexOf(USER_ERROR_EMBED_SENTINEL) >= 0;\n}\n\n/**\n * @enum {number}\n */\nexport const LogLevel = {\n  OFF: 0,\n  ERROR: 1,\n  WARN: 2,\n  INFO: 3,\n  FINE: 4,\n};\n\n/**\n * Sets reportError function. Called from error-reporting.js to break cyclic\n * dependency.\n * @param {function(this:Window, Error, (?Element)=): ?|undefined} fn\n */\nexport function setReportError(fn) {\n  self.__AMP_REPORT_ERROR = fn;\n}\n\n/**\n * @type {!LogLevel|undefined}\n * @private\n */\nlet levelOverride_ = undefined;\n\n/**\n * @param {!LogLevel} level\n */\nexport function overrideLogLevel(level) {\n  levelOverride_ = level;\n}\n\n/**\n * Prefixes `internalRuntimeVersion` with the `01` channel signifier (for prod.) for\n * extracted message URLs.\n * (Specific channel is irrelevant: message tables are invariant on internal version.)\n * @return {string}\n */\nconst messageUrlRtv = () => `01${internalRuntimeVersion()}`;\n\n/**\n * Gets a URL to display a message on amp.dev.\n * @param {string} id\n * @param {!Array} interpolatedParts\n * @return {string}\n */\nconst externalMessageUrl = (id, interpolatedParts) =>\n  interpolatedParts.reduce(\n    (prefix, arg) => `${prefix}&s[]=${messageArgToEncodedComponent(arg)}`,\n    `https://log.amp.dev/?v=${messageUrlRtv()}&id=${encodeURIComponent(id)}`\n  );\n\n/**\n * URL to simple log messages table JSON file, which contains an Object<string, string>\n * which maps message id to full message template.\n * @return {string}\n */\nconst externalMessagesSimpleTableUrl = () =>\n  `${urls.cdn}/rtv/${messageUrlRtv()}/log-messages.simple.json`;\n\n/**\n * @param {*} arg\n * @return {string}\n */\nconst messageArgToEncodedComponent = (arg) =>\n  encodeURIComponent(String(elementStringOrPassThru(arg)));\n\n/**\n * Logging class. Use of sentinel string instead of a boolean to check user/dev\n * errors because errors could be rethrown by some native code as a new error,\n * and only a message would survive. Also, some browser don\u2019t support a 5th\n * error object argument in window.onerror. List of supporting browser can be\n * found here:\n * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n * @final\n * @private Visible for testing only.\n */\nexport class Log {\n  /**\n   * opt_suffix will be appended to error message to identify the type of the\n   * error message. We can't rely on the error object to pass along the type\n   * because some browsers do not have this param in its window.onerror API.\n   * See:\n   * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n   *\n   * @param {!Window} win\n   * @param {function(number, boolean):!LogLevel} levelFunc\n   * @param {string=} opt_suffix\n   */\n  constructor(win, levelFunc, opt_suffix = '') {\n    /**\n     * In tests we use the main test window instead of the iframe where\n     * the tests runs because only the former is relayed to the console.\n     * @const {!Window}\n     */\n    this.win = getMode().test && win.__AMP_TEST_IFRAME ? win.parent : win;\n\n    /** @private @const {function(number, boolean):!LogLevel} */\n    this.levelFunc_ = levelFunc;\n\n    /** @private @const {!LogLevel} */\n    this.level_ = this.defaultLevel_();\n\n    /** @private @const {string} */\n    this.suffix_ = opt_suffix;\n\n    /** @private {?JsonObject} */\n    this.messages_ = null;\n\n    this.fetchExternalMessagesOnce_ = once(() => {\n      win\n        .fetch(externalMessagesSimpleTableUrl())\n        .then((response) => response.json(), noop)\n        .then((opt_messages) => {\n          if (opt_messages) {\n            this.messages_ = /** @type {!JsonObject} */ (opt_messages);\n          }\n        });\n    });\n\n    // This bound assertion function is capable of handling the format used when\n    // error/assertion messages are extracted. This logic hasn't yet been\n    // migrated to an AMP-independent form for use in core. This binding allows\n    // Log assertion helpers to maintain message-extraction capabilities until\n    // that logic can be moved to core.\n    this.boundAssertFn_ = /** @type {!assertions.AssertionFunctionDef} */ (\n      this.assert.bind(this)\n    );\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  getLevel_() {\n    return levelOverride_ !== undefined ? levelOverride_ : this.level_;\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevel_() {\n    // No console - can't enable logging.\n    if (!this.win.console || !this.win.console.log) {\n      return LogLevel.OFF;\n    }\n\n    // Logging has been explicitly disabled.\n    if (getMode().log == '0') {\n      return LogLevel.OFF;\n    }\n\n    // Logging is enabled for tests directly.\n    if (getMode().test && this.win.ENABLE_LOG) {\n      return LogLevel.FINE;\n    }\n\n    // LocalDev by default allows INFO level, unless overriden by `#log`.\n    if (getMode().localDev && !getMode().log) {\n      return LogLevel.INFO;\n    }\n\n    return this.defaultLevelWithFunc_();\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevelWithFunc_() {\n    // Delegate to the specific resolver.\n    return this.levelFunc_(parseInt(getMode().log, 10), getMode().development);\n  }\n\n  /**\n   * @param {string} tag\n   * @param {!LogLevel} level\n   * @param {!Array} messages\n   * @return {boolean} true if a message was logged\n   */\n  msg_(tag, level, messages) {\n    if (this.getLevel_() < level) {\n      return false;\n    }\n    let fn = this.win.console.log;\n    if (level == LogLevel.ERROR) {\n      fn = this.win.console.error || fn;\n    } else if (level == LogLevel.INFO) {\n      fn = this.win.console.info || fn;\n    } else if (level == LogLevel.WARN) {\n      fn = this.win.console.warn || fn;\n    }\n    const args = this.maybeExpandMessageArgs_(messages);\n    // Prefix console message with \"[tag]\".\n    const prefix = `[${tag}]`;\n    if (typeof args[0] === 'string') {\n      // Prepend string to avoid breaking string substitutions e.g. %s.\n      args[0] = prefix + ' ' + args[0];\n    } else {\n      args.unshift(prefix);\n    }\n    fn.apply(this.win.console, args);\n    return true;\n  }\n\n  /**\n   * Whether the logging is enabled.\n   * @return {boolean}\n   */\n  isEnabled() {\n    return this.getLevel_() != LogLevel.OFF;\n  }\n\n  /**\n   * Reports a fine-grained message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  fine(tag, ...args) {\n    this.msg_(tag, LogLevel.FINE, args);\n  }\n\n  /**\n   * Reports a informational message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  info(tag, ...args) {\n    this.msg_(tag, LogLevel.INFO, args);\n  }\n\n  /**\n   * Reports a warning message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  warn(tag, ...args) {\n    this.msg_(tag, LogLevel.WARN, args);\n  }\n\n  /**\n   * Reports an error message. If the logging is disabled, the error is rethrown\n   * asynchronously.\n   * @param {string} tag\n   * @param {...*} args\n   * @return {!Error|undefined}\n   * @private\n   */\n  error_(tag, ...args) {\n    if (!this.msg_(tag, LogLevel.ERROR, args)) {\n      return this.createError.apply(this, args);\n    }\n  }\n\n  /**\n   * Reports an error message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  error(tag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      // TODO(rcebulko): Determine if/how this Error#name property is used.\n      error.name = tag || error.name;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Reports an error message and marks with an expected property. If the\n   * logging is disabled, the error is rethrown asynchronously.\n   * @param {string} unusedTag\n   * @param {...*} var_args\n   */\n  expectedError(unusedTag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      error.expected = true;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Creates an error object.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    return error;\n  }\n\n  /**\n   * Creates an error object with its expected property set to true.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createExpectedError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    error.expected = true;\n    return error;\n  }\n\n  /**\n   * Throws an error if the first argument isn't trueish.\n   *\n   * Supports argument substitution into the message via %s placeholders.\n   *\n   * Throws an error object that has two extra properties:\n   * - associatedElement: This is the first element provided in the var args.\n   *   It can be used for improved display of error messages.\n   * - messageArray: The elements of the substituted message as non-stringified\n   *   elements in an array. When e.g. passed to console.error this yields\n   *   native displays of things like HTML elements.\n   *\n   * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n   *     not evaluate to true.\n   * @param {!Array|string=} opt_message The assertion message\n   * @param {...*} var_args Arguments substituted into %s in the message.\n   * @return {T} The value of shouldBeTrueish.\n   * @throws {!Error} When `value` is falsey.\n   * @template T\n   * @closurePrimitive {asserts.truthy}\n   */\n  assert(shouldBeTrueish, opt_message, var_args) {\n    if (isArray(opt_message)) {\n      return this.assert.apply(\n        this,\n        [shouldBeTrueish].concat(\n          this.expandMessageArgs_(/** @type {!Array} */ (opt_message))\n        )\n      );\n    }\n\n    return assertions.assert.apply(\n      null,\n      [this.suffix_].concat(Array.prototype.slice.call(arguments))\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't an Element\n   *\n   * Otherwise see `assert` for usage\n   *\n   * @param {*} shouldBeElement\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Element} The value of shouldBeTrueish.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertElement(shouldBeElement, opt_message) {\n    return assertions.assertElement(\n      this.boundAssertFn_,\n      shouldBeElement,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a string. The string can\n   * be empty.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeString\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {string} The string value. Can be an empty string.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertString(shouldBeString, opt_message) {\n    return assertions.assertString(\n      this.boundAssertFn_,\n      shouldBeString,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a number. The allowed values\n   * include `0` and `NaN`.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeNumber\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {number} The number value. The allowed values include `0`\n   *   and `NaN`.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertNumber(shouldBeNumber, opt_message) {\n    return assertions.assertNumber(\n      this.boundAssertFn_,\n      shouldBeNumber,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument is not an array.\n   * The array can be empty.\n   *\n   * @param {*} shouldBeArray\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Array} The array value\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertArray(shouldBeArray, opt_message) {\n    return assertions.assertArray(\n      this.boundAssertFn_,\n      shouldBeArray,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a boolean.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeBoolean\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {boolean} The boolean value.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertBoolean(shouldBeBoolean, opt_message) {\n    return assertions.assertBoolean(\n      this.boundAssertFn_,\n      shouldBeBoolean,\n      opt_message\n    );\n  }\n\n  /**\n   * @param {!Error} error\n   * @private\n   */\n  prepareError_(error) {\n    error = duplicateErrorIfNecessary(error);\n\n    if (this.suffix_) {\n      if (!error.message) {\n        error.message = this.suffix_;\n      } else if (error.message.indexOf(this.suffix_) == -1) {\n        error.message += this.suffix_;\n      }\n    } else if (isUserErrorMessage(error.message)) {\n      error.message = error.message.replace(USER_ERROR_SENTINEL, '');\n    }\n  }\n\n  /**\n   * @param {!Array} args\n   * @return {!Array}\n   * @private\n   */\n  maybeExpandMessageArgs_(args) {\n    if (isArray(args[0])) {\n      return this.expandMessageArgs_(/** @type {!Array} */ (args[0]));\n    }\n    return args;\n  }\n\n  /**\n   * Either redirects a pair of (errorId, ...args) to a URL where the full\n   * message is displayed, or displays it from a fetched table.\n   *\n   * This method is used by the output of the `transform-log-methods` babel\n   * plugin. It should not be used directly. Use the (*error|assert*|info|warn)\n   * methods instead.\n   *\n   * @param {!Array} parts\n   * @return {!Array}\n   * @private\n   */\n  expandMessageArgs_(parts) {\n    // First value should exist.\n    const id = parts.shift();\n    // Best effort fetch of message template table.\n    // Since this is async, the first few logs might be indirected to a URL even\n    // if in development mode. Message table is ~small so this should be a short\n    // gap.\n    if (getMode(this.win).development) {\n      this.fetchExternalMessagesOnce_();\n    }\n    if (this.messages_ && id in this.messages_) {\n      return [this.messages_[id]].concat(parts);\n    }\n    return [`More info at ${externalMessageUrl(id, parts)}`];\n  }\n}\n\n/**\n * Cache for logs. We do not use a Service since the service module depends\n * on Log and closure literally can't even.\n * @type {{user: ?Log, dev: ?Log, userForEmbed: ?Log}}\n */\nself.__AMP_LOG = self.__AMP_LOG || {\n  user: null,\n  dev: null,\n  userForEmbed: null,\n};\n\nconst logs = self.__AMP_LOG;\n\n/**\n * Eventually holds a constructor for Log objects. Lazily initialized, so we\n * can avoid ever referencing the real constructor except in JS binaries\n * that actually want to include the implementation.\n * @type {?typeof Log}\n */\nlet logConstructor = null;\n\n/**\n * Initializes log constructor.\n */\nexport function initLogConstructor() {\n  logConstructor = Log;\n  // Initialize instances for use. If a binary (an extension for example) that\n  // does not call `initLogConstructor` invokes `dev()` or `user()` earlier than\n  // the binary that does call `initLogConstructor` (amp.js), the extension will\n  // throw an error as that extension will never be able to initialize the log\n  // instances and we also don't want it to call `initLogConstructor` either\n  // (since that will cause the Log implementation to be bundled into that\n  // binary). So we must initialize the instances eagerly so that they are ready\n  // for use (stored globally) after the main binary calls `initLogConstructor`.\n  dev();\n  user();\n}\n\n/**\n * Resets log constructor for testing.\n */\nexport function resetLogConstructorForTesting() {\n  logConstructor = null;\n}\n\n/**\n * Publisher level log.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Development mode is enabled via `#development=1` or logging is explicitly\n *     enabled via `#log=D` where D >= 1.\n *  3. AMP.setLogLevel(D) is called, where D >= 1.\n *\n * @param {!Element=} opt_element\n * @return {!Log}\n */\nexport function user(opt_element) {\n  if (!logs.user) {\n    logs.user = getUserLogger(USER_ERROR_SENTINEL);\n  }\n  if (!isFromEmbed(logs.user.win, opt_element)) {\n    return logs.user;\n  } else {\n    if (logs.userForEmbed) {\n      return logs.userForEmbed;\n    }\n    return (logs.userForEmbed = getUserLogger(USER_ERROR_EMBED_SENTINEL));\n  }\n}\n\n/**\n * Getter for user logger\n * @param {string=} suffix\n * @return {!Log}\n */\nfunction getUserLogger(suffix) {\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return new logConstructor(\n    self,\n    (logNum, development) => {\n      if (development || logNum >= 1) {\n        return LogLevel.FINE;\n      }\n      return LogLevel.WARN;\n    },\n    suffix\n  );\n}\n\n/**\n * AMP development log. Calls to `devLog().assert` and `dev.fine` are stripped\n * in the PROD binary. However, `devLog().assert` result is preserved in either\n * case.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Logging is explicitly enabled via `#log=D`, where D >= 2.\n *  3. AMP.setLogLevel(D) is called, where D >= 2.\n *\n * @return {!Log}\n */\nexport function dev() {\n  if (logs.dev) {\n    return logs.dev;\n  }\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return (logs.dev = new logConstructor(self, (logNum) => {\n    if (logNum >= 3) {\n      return LogLevel.FINE;\n    }\n    if (logNum >= 2) {\n      return LogLevel.INFO;\n    }\n    return LogLevel.OFF;\n  }));\n}\n\n/**\n * @param {!Window} win\n * @param {!Element=} opt_element\n * @return {boolean} isEmbed\n */\nexport function isFromEmbed(win, opt_element) {\n  if (!opt_element) {\n    return false;\n  }\n  return opt_element.ownerDocument.defaultView != win;\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function devAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (getMode().minified) {\n    return shouldBeTrueish;\n  }\n  if (self.__AMP_ASSERTION_CHECK) {\n    // This will never execute regardless, but will be included on unminified\n    // builds. It will be DCE'd away from minified builds, and so can be used to\n    // validate that Babel is properly removing dev assertions in minified\n    // builds.\n    console /*OK*/\n      .log('__devAssert_sentinel__');\n  }\n\n  return dev()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function userAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  return user()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Magic constant that is replaced by babel.\n// IS_MINIFIED is always replaced with true when closure compiler is used\nconst IS_MINIFIED = false;\n\n/**\n * Returns true whenever closure compiler is used.\n * @return {boolean}\n */\nexport function isMinifiedMode() {\n  return IS_MINIFIED;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assertions from './base';\nimport {isMinifiedMode} from '../minified-mode';\n\n/**\n * @fileoverview This file provides the entrypoint for dev assertions. It's\n * designed so all functions are pure function calls to improve inlining. All\n * functions in this file get DCE'd away during compilation.\n */\n\n/**\n * This will never execute regardless, but will be included on unminified builds\n * builds. It will be DCE'd away from minified builds, and so can be used to\n * validate that Babel is properly removing dev assertions in minified builds.\n */\nfunction devAssertDceCheck() {\n  if (self.__AMP_ASSERTION_CHECK) {\n    console /*OK*/\n      .log('__devAssert_sentinel__');\n  }\n}\n\n/**\n * Throws an error if the first argument isn't trueish. Mirrors devAssert in\n * src/log.js.\n * @param {T} shouldBeTruthy\n * @param {string=} opt_message\n * @param {*=} opt_1 Optional argument (var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T}\n * @template T\n * @throws {Error} when shouldBeTruthy is not truthy.\n * @closurePrimitive {asserts.truthy}\n */\nexport function devAssert(\n  shouldBeTruthy,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (isMinifiedMode()) {\n    return shouldBeTruthy;\n  }\n  devAssertDceCheck();\n\n  return assertions.assert(\n    '',\n    shouldBeTruthy,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't an Element.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeElement\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Element} The value of shouldBeTrueish.\n * @throws {Error} when shouldBeElement is not an Element\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertElement(shouldBeElement, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {!Element} */ (shouldBeElement);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertElement(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeElement,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a string. The string can\n * be empty.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeString\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {string} The string value. Can be an empty string.\n * @throws {Error} when shouldBeString is not an String\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertString(shouldBeString, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {string} */ (shouldBeString);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertString(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeString,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a number. The allowed values\n * include `0` and `NaN`.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeNumber\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {number} The number value. The allowed values include `0`\n *   and `NaN`.\n * @throws {Error} when shouldBeNumber is not an Number\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertNumber(shouldBeNumber, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {number} */ (shouldBeNumber);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertNumber(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeNumber,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument is not an array.\n * The array can be empty.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeArray\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Array} The array value\n * @throws {Error} when shouldBeArray is not an Array\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertArray(shouldBeArray, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {!Array} */ (shouldBeArray);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertArray(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeArray,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a boolean.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeBoolean\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {boolean} The boolean value.\n * @throws {Error} when shouldBeBoolean is not an Boolean\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertBoolean(shouldBeBoolean, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {boolean} */ (shouldBeBoolean);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertBoolean(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeBoolean,\n    opt_message\n  );\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assertions from './base';\nimport {USER_ERROR_SENTINEL} from '../error/message-helpers';\n\n/**\n * @fileoverview This file provides the entrypoint for user assertions. It's\n * designed so all functions are pure function calls to improve inlining.\n */\n\n/**\n * Throws a user error if the first argument isn't trueish. Mirrors userAssert\n * in src/log.js.\n * @param {T} shouldBeTruthy\n * @param {string} opt_message\n * @param {*=} opt_1 Optional argument (var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T}\n * @template T\n * @throws {UserError} when shouldBeTruthy is not truthy.\n * @closurePrimitive {asserts.truthy}\n */\nexport function userAssert(\n  shouldBeTruthy,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  return assertions.assert(\n    USER_ERROR_SENTINEL,\n    shouldBeTruthy,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't an Element.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeElement\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Element} The value of shouldBeTrueish.\n * @throws {Error} when shouldBeElement is not an Element\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function userAssertElement(shouldBeElement, opt_message) {\n  return assertions.assertElement(\n    /** @type {!assertions.AssertionFunctionDef} */ (userAssert),\n    shouldBeElement,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a string. The string can\n * be empty.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeString\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {string} The string value. Can be an empty string.\n * @throws {Error} when shouldBeString is not an String\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function userAssertString(shouldBeString, opt_message) {\n  return assertions.assertString(\n    /** @type {!assertions.AssertionFunctionDef} */ (userAssert),\n    shouldBeString,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a number. The allowed values\n * include `0` and `NaN`.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeNumber\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {number} The number value. The allowed values include `0`\n *   and `NaN`.\n * @throws {Error} when shouldBeNumber is not an Number\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function userAssertNumber(shouldBeNumber, opt_message) {\n  return assertions.assertNumber(\n    /** @type {!assertions.AssertionFunctionDef} */ (userAssert),\n    shouldBeNumber,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument is not an array.\n * The array can be empty.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeArray\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Array} The array value\n * @throws {Error} when shouldBeArray is not an Array\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function userAssertArray(shouldBeArray, opt_message) {\n  return assertions.assertArray(\n    /** @type {!assertions.AssertionFunctionDef} */ (userAssert),\n    shouldBeArray,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a boolean.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeBoolean\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {boolean} The boolean value.\n * @throws {Error} when shouldBeBoolean is not an Boolean\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function userAssertBoolean(shouldBeBoolean, opt_message) {\n  return assertions.assertBoolean(\n    /** @type {!assertions.AssertionFunctionDef} */ (userAssert),\n    shouldBeBoolean,\n    opt_message\n  );\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isArray} from '../array';\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n\n// NOTE Type are changed to {*} because of\n// https://github.com/google/closure-compiler/issues/1999\n\n/**\n * JSON scalar. It's either string, number or boolean.\n * @typedef {string|number|boolean|null}\n */\nlet JSONScalarDef;\n\n/**\n * JSON object. It's a map with string keys and JSON values.\n * @typedef {!Object<string, ?*>} (* should be JSONValueDef)\n */\nlet JSONObjectDef;\n\n/**\n * JSON array. It's an array with JSON values.\n * @typedef {!Array<?*>} (* should be JSONValueDef)\n */\nlet JSONArrayDef;\n\n/**\n * JSON value. It's either a scalar, an object or an array.\n * @typedef {!JSONScalarDef|!JSONObjectDef|!JSONArrayDef}\n */\nlet JSONValueDef;\n\n/**\n * @typedef {{\n *   YOU_MUST_USE: string,\n *   jsonLiteral: function(),\n *   TO_MAKE_THIS_TYPE: string,\n * }}\n */\nlet InternalJsonLiteralTypeDef;\n\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {string} json JSON string to parse\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function parseJson(json) {\n  return /** @type {?JsonObject} */ (JSON.parse(json));\n}\n\n/**\n * Parses the given `json` string without throwing an exception if not valid.\n * Returns `undefined` if parsing fails.\n * Returns the `Object` corresponding to the JSON string when parsing succeeds.\n * @param {string} json JSON string to parse\n * @param {function(!Error)=} opt_onFailed Optional function that will be called\n *     with the error if parsing fails.\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function tryParseJson(json, opt_onFailed) {\n  try {\n    return parseJson(json);\n  } catch (e) {\n    opt_onFailed?.(e);\n    return null;\n  }\n}\n\n/**\n * Deeply checks strict equality of items in nested arrays and objects.\n *\n * @param {JSONValueDef} a\n * @param {JSONValueDef} b\n * @param {number} depth The maximum depth. Must be finite.\n * @return {boolean}\n * @throws {Error} If depth argument is not finite.\n */\nexport function deepEquals(a, b, depth = 5) {\n  if (!isFinite(depth) || depth < 0) {\n    throw new Error('Invalid depth: ' + depth);\n  }\n  if (a === b) {\n    return true;\n  }\n  /** @type {!Array<{a: JSONValueDef, b: JSONValueDef, depth: number}>} */\n  const queue = [{a, b, depth}];\n  while (queue.length > 0) {\n    const {a, b, depth} = queue.shift();\n    // Only check deep equality if depth > 0.\n    if (depth > 0) {\n      if (typeof a !== typeof b) {\n        return false;\n      } else if (isArray(a) && isArray(b)) {\n        if (a.length !== b.length) {\n          return false;\n        }\n        for (let i = 0; i < a.length; i++) {\n          queue.push({a: a[i], b: b[i], depth: depth - 1});\n        }\n        continue;\n      } else if (a && b && typeof a === 'object' && typeof b === 'object') {\n        const keysA = Object.keys(a);\n        const keysB = Object.keys(b);\n        if (keysA.length !== keysB.length) {\n          return false;\n        }\n        for (const k of keysA) {\n          queue.push({a: a[k], b: b[k], depth: depth - 1});\n        }\n        continue;\n      }\n    }\n    // If we get here, then depth == 0 or (a, b) are primitives.\n    if (a !== b) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * This helper function handles configurations specified in a JSON format.\n *\n * It allows the configuration is to be written in plain JS (which has better\n * dev ergonomics like comments and trailing commas), and allows the\n * configuration to be transformed into an efficient JSON-parsed representation\n * in the dist build. See https://v8.dev/blog/cost-of-javascript-2019#json\n *\n * @param {!Object} obj\n * @return {!JsonObject}\n */\nexport function jsonConfiguration(obj) {\n  return /** @type {!JsonObject} */ (obj);\n}\n\n/**\n * This converts an Object into a suitable type to be used in `includeJsonLiteral`.\n * This doesn't actually do any conversion, it only changes the closure type.\n *\n * @param {?JSONValueDef} value\n * @return {!InternalJsonLiteralTypeDef}\n */\nexport function jsonLiteral(value) {\n  return /** @type {!InternalJsonLiteralTypeDef} */ (value);\n}\n\n/**\n * Allows inclusion of a variable (that's wrapped in a jsonLiteral\n * call) to be included inside a jsonConfiguration.\n *\n * @param {!InternalJsonLiteralTypeDef} value\n * @return {*}\n */\nexport function includeJsonLiteral(value) {\n  return value;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../../assert';\n\n/**\n * Interpret a byte array as a UTF-8 string.\n * @param {!BufferSource} bytes\n * @return {string}\n */\nexport function utf8Decode(bytes) {\n  if (typeof TextDecoder !== 'undefined') {\n    return new TextDecoder('utf-8').decode(bytes);\n  }\n  const asciiString = bytesToString(new Uint8Array(bytes.buffer || bytes));\n  return decodeURIComponent(escape(asciiString));\n}\n\n/**\n * Turn a string into UTF-8 bytes.\n * @param {string} string\n * @return {!Uint8Array}\n */\nexport function utf8Encode(string) {\n  if (typeof TextEncoder !== 'undefined') {\n    return new TextEncoder('utf-8').encode(string);\n  }\n  return stringToBytes(unescape(encodeURIComponent(string)));\n}\n\n/**\n * Converts a string which holds 8-bit code points, such as the result of atob,\n * into a Uint8Array with the corresponding bytes.\n * If you have a string of characters, you probably want to be using utf8Encode.\n * @param {string} str\n * @return {!Uint8Array}\n */\nexport function stringToBytes(str) {\n  const bytes = new Uint8Array(str.length);\n  for (let i = 0; i < str.length; i++) {\n    const charCode = str.charCodeAt(i);\n    devAssert(charCode <= 255, 'Characters must be in range [0,255]');\n    bytes[i] = charCode;\n  }\n  return bytes;\n}\n\n/**\n * Converts a 8-bit bytes array into a string\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nexport function bytesToString(bytes) {\n  // Intentionally avoids String.fromCharCode.apply so we don't suffer a\n  // stack overflow. #10495, https://jsperf.com/bytesToString-2\n  const array = new Array(bytes.length);\n  for (let i = 0; i < bytes.length; i++) {\n    array[i] = String.fromCharCode(bytes[i]);\n  }\n  return array.join('');\n}\n\n/**\n * Converts a 4-item byte array to an unsigned integer.\n * Assumes bytes are big endian.\n * @param {!Uint8Array} bytes\n * @return {number}\n */\nexport function bytesToUInt32(bytes) {\n  if (bytes.length != 4) {\n    throw new Error('Received byte array with length != 4');\n  }\n  const val =\n    ((bytes[0] & 0xff) << 24) |\n    ((bytes[1] & 0xff) << 16) |\n    ((bytes[2] & 0xff) << 8) |\n    (bytes[3] & 0xff);\n  // Convert to unsigned.\n  return val >>> 0;\n}\n\n/**\n * Generate a random bytes array with specific length using\n * win.crypto.getRandomValues. Return null if it is not available.\n * @param {!Window} win\n * @param {number} length\n * @return {?Uint8Array}\n */\nexport function getCryptoRandomBytesArray(win, length) {\n  let {crypto} = win;\n\n  // Support IE 11\n  if (!IS_ESM) {\n    crypto = /** @type {!webCrypto.Crypto|undefined} */ (\n      crypto || win.msCrypto\n    );\n    if (!crypto || !crypto.getRandomValues) {\n      return null;\n    }\n  }\n\n  // Widely available in browsers we support:\n  // http://caniuse.com/#search=getRandomValues\n  const uint8array = new Uint8Array(length);\n  crypto.getRandomValues(uint8array);\n  return uint8array;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {dev, user} from '../log';\nimport {devAssert} from '../core/assert';\nimport {hasOwn, map} from '../core/types/object';\nimport {isArray, isObject} from '../core/types';\nimport {parseJson} from '../core/types/object/json';\nimport {utf8Encode} from '../core/types/string/bytes';\n\n/** @enum {number} Allowed fetch responses. */\nconst allowedFetchTypes = {\n  document: 1,\n  text: 2,\n};\n\n/** @const {!Array<string>} */\nconst allowedMethods = ['GET', 'POST'];\n\n/**\n * A record version of `XMLHttpRequest` that has all the necessary properties\n * and methods of `XMLHttpRequest` to construct a `FetchResponse` from a\n * serialized response returned by the viewer.\n * @typedef {{\n *   status: number,\n *   statusText: string,\n *   responseText: string,\n *   getResponseHeader: function(this:XMLHttpRequestDef, string): string,\n * }}\n */\nlet XMLHttpRequestDef;\n\n/**\n * A minimal polyfill of Fetch API. It only polyfills what we currently use.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n *\n * Notice that the \"fetch\" method itself is not exported as that would require\n * us to immediately support a much wide API.\n *\n * @param {string} input\n * @param {!Object|RequestInit=} init\n * @return {!Promise<!FetchResponse>}\n */\nexport function fetchPolyfill(input, init = {}) {\n  return new Promise(function (resolve, reject) {\n    const requestMethod = normalizeMethod(init.method || 'GET');\n    const xhr = createXhrRequest(requestMethod, input);\n\n    if (init.credentials == 'include') {\n      xhr.withCredentials = true;\n    }\n\n    if (init.responseType in allowedFetchTypes) {\n      xhr.responseType = init.responseType;\n    }\n\n    if (init.headers) {\n      Object.keys(init.headers).forEach(function (header) {\n        xhr.setRequestHeader(header, init.headers[header]);\n      });\n    }\n\n    xhr.onreadystatechange = () => {\n      if (xhr.readyState < /* STATUS_RECEIVED */ 2) {\n        return;\n      }\n      if (xhr.status < 100 || xhr.status > 599) {\n        xhr.onreadystatechange = null;\n        reject(user().createExpectedError(`Unknown HTTP status ${xhr.status}`));\n        return;\n      }\n\n      // TODO(dvoytenko): This is currently simplified: we will wait for the\n      // whole document loading to complete. This is fine for the use cases\n      // we have now, but may need to be reimplemented later.\n      if (xhr.readyState == /* COMPLETE */ 4) {\n        resolve(new FetchResponse(xhr));\n      }\n    };\n    xhr.onerror = () => {\n      reject(user().createExpectedError('Network failure'));\n    };\n    xhr.onabort = () => {\n      reject(user().createExpectedError('Request aborted'));\n    };\n\n    if (requestMethod == 'POST') {\n      xhr.send(init.body);\n    } else {\n      xhr.send();\n    }\n  });\n}\n\n/**\n * @param {string} method\n * @param {string} url\n * @return {!XMLHttpRequest}\n */\nfunction createXhrRequest(method, url) {\n  const xhr = new XMLHttpRequest();\n  if ('withCredentials' in xhr) {\n    xhr.open(method, url, true);\n  } else {\n    throw dev().createExpectedError('CORS is not supported');\n  }\n  return xhr;\n}\n\n/**\n * Response object in the Fetch API.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n */\nclass FetchResponse {\n  /**\n   * @param {!XMLHttpRequest|!XMLHttpRequestDef} xhr\n   */\n  constructor(xhr) {\n    /** @private @const {!XMLHttpRequest|!XMLHttpRequestDef} */\n    this.xhr_ = xhr;\n\n    /** @const {number} */\n    this.status = this.xhr_.status;\n\n    /** @const {string} */\n    this.statusText = this.xhr_.statusText;\n\n    /** @const {boolean} */\n    this.ok = this.status >= 200 && this.status < 300;\n\n    /** @const {!FetchResponseHeaders} */\n    this.headers = new FetchResponseHeaders(xhr);\n\n    /** @type {boolean} */\n    this.bodyUsed = false;\n\n    /** @type {?ReadableStream} */\n    this.body = null;\n\n    /** @type {?string} */\n    this.url = xhr.responseURL;\n  }\n\n  /**\n   * Create a copy of the response and return it.\n   * @return {!FetchResponse}\n   */\n  clone() {\n    devAssert(!this.bodyUsed, 'Body already used');\n    return new FetchResponse(this.xhr_);\n  }\n\n  /**\n   * Drains the response and returns the text.\n   * @return {!Promise<string>}\n   * @private\n   */\n  drainText_() {\n    devAssert(!this.bodyUsed, 'Body already used');\n    this.bodyUsed = true;\n    return Promise.resolve(this.xhr_.responseText);\n  }\n\n  /**\n   * Drains the response and returns a promise that resolves with the response\n   * text.\n   * @return {!Promise<string>}\n   */\n  text() {\n    return this.drainText_();\n  }\n\n  /**\n   * Drains the response and returns the JSON object.\n   * @return {!Promise<!JsonObject>}\n   */\n  json() {\n    return /** @type {!Promise<!JsonObject>} */ (\n      this.drainText_().then(parseJson)\n    );\n  }\n\n  /**\n   * Drains the response and returns a promise that resolves with the response\n   * ArrayBuffer.\n   * @return {!Promise<!ArrayBuffer>}\n   */\n  arrayBuffer() {\n    return /** @type {!Promise<!ArrayBuffer>} */ (\n      this.drainText_().then(utf8Encode)\n    );\n  }\n}\n\n/**\n * Normalized method name by uppercasing.\n * @param {string|undefined} method\n * @return {string}\n * @private\n */\nfunction normalizeMethod(method) {\n  if (method === undefined) {\n    return 'GET';\n  }\n  method = method.toUpperCase();\n  devAssert(\n    allowedMethods.includes(method),\n    'Only one of %s is currently allowed. Got %s',\n    allowedMethods.join(', '),\n    method\n  );\n  return method;\n}\n\n/**\n * Provides access to the response headers as defined in the Fetch API.\n * @private Visible for testing.\n */\nclass FetchResponseHeaders {\n  /**\n   * @param {!XMLHttpRequest|!XMLHttpRequestDef} xhr\n   */\n  constructor(xhr) {\n    /** @private @const {!XMLHttpRequest|!XMLHttpRequestDef} */\n    this.xhr_ = xhr;\n  }\n\n  /**\n   * @param {string} name\n   * @return {string}\n   */\n  get(name) {\n    return this.xhr_.getResponseHeader(name);\n  }\n\n  /**\n   * @param {string} name\n   * @return {boolean}\n   */\n  has(name) {\n    return this.xhr_.getResponseHeader(name) != null;\n  }\n}\n\nexport class Response extends FetchResponse {\n  /**\n   * Returns instance of Response.\n   * @param {?ResponseBodyInit=} body\n   * @param {!ResponseInit=} init\n   */\n  constructor(body, init = {}) {\n    const lowercasedHeaders = map();\n    const data = {\n      status: 200,\n      statusText: 'OK',\n      responseText: body ? String(body) : '',\n      getResponseHeader(name) {\n        const headerName = String(name).toLowerCase();\n        return hasOwn(lowercasedHeaders, headerName)\n          ? lowercasedHeaders[headerName]\n          : null;\n      },\n      ...init,\n    };\n\n    data.status = init.status === undefined ? 200 : parseInt(init.status, 10);\n\n    if (isArray(init.headers)) {\n      /** @type {!Array} */ (init.headers).forEach((entry) => {\n        const headerName = entry[0];\n        const headerValue = entry[1];\n        lowercasedHeaders[String(headerName).toLowerCase()] =\n          String(headerValue);\n      });\n    } else if (isObject(init.headers)) {\n      for (const key in init.headers) {\n        lowercasedHeaders[String(key).toLowerCase()] = String(\n          init.headers[key]\n        );\n      }\n    }\n\n    if (init.statusText) {\n      data.statusText = String(init.statusText);\n    }\n\n    super(/** @type {XMLHttpRequestDef} */ (data));\n  }\n}\n\n/**\n * Installs fetch and Response polyfill\n * @param {Window} win\n */\nexport function install(win) {\n  if (!win.fetch) {\n    Object.defineProperty(win, 'fetch', {\n      value: fetchPolyfill,\n      writable: true,\n      enumerable: true,\n      configurable: true,\n    });\n    Object.defineProperty(win, 'Response', {\n      value: Response,\n      writable: true,\n      enumerable: false,\n      configurable: true,\n    });\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * TODO(rcebulko): Migrate the actual ViewportInterface into core or an extern.\n * @typedef {{\n *   getHeight: function(this:ViewportInterfaceDef):number,\n *   getWidth: function(this:ViewportInterfaceDef):number,\n * }}\n */\nlet ViewportInterfaceDef;\n\n/**\n * The structure that combines position and size for an element. The exact\n * interpretation of position and size depends on the use case.\n *\n * @typedef {{\n *   top: number,\n *   bottom: number,\n *   left: number,\n *   right: number,\n *   width: number,\n *   height: number,\n *   x: number,\n *   y: number\n * }}\n */\nexport let LayoutRectDef;\n\n/**\n * The structure that contains the size for an element. The exact\n * interpretation of the size depends on the use case.\n *\n * @typedef {{\n *   width: number,\n *   height: number,\n * }}\n */\nexport let LayoutSizeDef;\n\n/**\n * The structure that represents the margins of an Element.\n *\n * @typedef {{\n *   top: number,\n *   right: number,\n *   bottom: number,\n *   left: number\n * }}\n */\nexport let LayoutMarginsDef;\n\n/**\n * The structure that represents a requested change to the margins of an\n * Element. Any new values specified will replace existing ones (rather than\n * being additive).\n *\n * @typedef {{\n *   top: (number|undefined),\n *   right: (number|undefined),\n *   bottom: (number|undefined),\n *   left: (number|undefined)\n * }}\n */\nexport let LayoutMarginsChangeDef;\n\n/**\n * RelativePositions\n *\n * Describes the relative position of an element to another (whether the\n * first is inside the second, on top of the second or on the bottom\n * @enum {string}\n */\nexport const RelativePositions = {\n  INSIDE: 'inside',\n  TOP: 'top',\n  BOTTOM: 'bottom',\n};\n\n/**\n * Creates a layout rect based on the left, top, width and height parameters\n * in that order.\n * @param {number} left\n * @param {number} top\n * @param {number} width\n * @param {number} height\n * @return {!LayoutRectDef}\n */\nexport function layoutRectLtwh(left, top, width, height) {\n  return {\n    left,\n    top,\n    width,\n    height,\n    bottom: top + height,\n    right: left + width,\n    x: left,\n    y: top,\n  };\n}\n\n/**\n * Creates a layout rect based on the DOMRect, e.g. obtained from calling\n * getBoundingClientRect.\n * @param {!ClientRect} rect\n * @return {!LayoutRectDef}\n */\nexport function layoutRectFromDomRect(rect) {\n  return layoutRectLtwh(\n    Number(rect.left),\n    Number(rect.top),\n    Number(rect.width),\n    Number(rect.height)\n  );\n}\n\n/**\n * Returns true if the specified two rects overlap by a single pixel.\n * @param {!LayoutRectDef|!ClientRect} r1\n * @param {!LayoutRectDef|!ClientRect} r2\n * @return {boolean}\n */\nexport function rectsOverlap(r1, r2) {\n  return (\n    r1.top <= r2.bottom &&\n    r2.top <= r1.bottom &&\n    r1.left <= r2.right &&\n    r2.left <= r1.right\n  );\n}\n\n/**\n * Returns the intersection between a, b or null if there is none.\n * @param {...?LayoutRectDef|undefined} var_args\n * @return {?LayoutRectDef}\n */\nexport function rectIntersection(var_args) {\n  let x0 = -Infinity;\n  let x1 = Infinity;\n  let y0 = -Infinity;\n  let y1 = Infinity;\n  for (let i = 0; i < arguments.length; i++) {\n    const current = arguments[i];\n    if (!current) {\n      continue;\n    }\n    x0 = Math.max(x0, current.left);\n    x1 = Math.min(x1, current.left + current.width);\n    y0 = Math.max(y0, current.top);\n    y1 = Math.min(y1, current.top + current.height);\n    if (x1 < x0 || y1 < y0) {\n      return null;\n    }\n  }\n  if (x1 == Infinity) {\n    return null;\n  }\n  return layoutRectLtwh(x0, y0, x1 - x0, y1 - y0);\n}\n\n/**\n * Returns the position of r2 relative to r1\n * @param {!LayoutRectDef} r1\n * @param {!LayoutRectDef} r2\n * @return {!RelativePositions}\n */\nexport function layoutRectsRelativePos(r1, r2) {\n  if (r1.top < r2.top) {\n    return RelativePositions.TOP;\n  } else if (r1.bottom > r2.bottom) {\n    return RelativePositions.BOTTOM;\n  } else {\n    return RelativePositions.INSIDE;\n  }\n}\n\n/**\n * Determines if any portion of a layoutBox would be onscreen in the given\n * viewport, when scrolled to the specified position.\n * @param {!LayoutRectDef} layoutBox\n * @param {!ViewportInterfaceDef} viewport\n * @param {number} scrollPos\n * @return {!RelativePositions}\n */\nexport function layoutPositionRelativeToScrolledViewport(\n  layoutBox,\n  viewport,\n  scrollPos\n) {\n  const scrollLayoutBox = layoutRectFromDomRect(\n    /** @type {!ClientRect} */ ({\n      top: scrollPos,\n      bottom: scrollPos + viewport.getHeight(),\n      left: 0,\n      right: viewport.getWidth(),\n    })\n  );\n  if (rectsOverlap(layoutBox, scrollLayoutBox)) {\n    return RelativePositions.INSIDE;\n  } else {\n    return layoutRectsRelativePos(layoutBox, scrollLayoutBox);\n  }\n}\n\n/**\n * Expand the layout rect using multiples of width and height.\n * @param {!LayoutRectDef} rect Original rect.\n * @param {number} dw Expansion in width, specified as a multiple of width.\n * @param {number} dh Expansion in height, specified as a multiple of height.\n * @return {!LayoutRectDef}\n */\nexport function expandLayoutRect(rect, dw, dh) {\n  return layoutRectLtwh(\n    rect.left - rect.width * dw,\n    rect.top - rect.height * dh,\n    rect.width * (1 + dw * 2),\n    rect.height * (1 + dh * 2)\n  );\n}\n\n/**\n * Moves the layout rect using dx and dy.\n * @param {!LayoutRectDef} rect Original rect.\n * @param {number} dx Move horizontally with this value.\n * @param {number} dy Move vertically with this value.\n * @return {!LayoutRectDef}\n */\nexport function moveLayoutRect(rect, dx, dy) {\n  if ((dx == 0 && dy == 0) || (rect.width == 0 && rect.height == 0)) {\n    return rect;\n  }\n  return layoutRectLtwh(rect.left + dx, rect.top + dy, rect.width, rect.height);\n}\n\n/**\n * @param {!LayoutMarginsDef} margins\n * @param {!LayoutMarginsChangeDef} change\n * @return {boolean}\n */\nexport function areMarginsChanged(margins, change) {\n  return (\n    (change.top !== undefined && change.top != margins.top) ||\n    (change.right !== undefined && change.right != margins.right) ||\n    (change.bottom !== undefined && change.bottom != margins.bottom) ||\n    (change.left !== undefined && change.left != margins.left)\n  );\n}\n\n/**\n * @param {!LayoutRectDef} from\n * @param {!LayoutRectDef} to\n * @return {boolean}\n */\nexport function layoutRectSizeEquals(from, to) {\n  return from.width == to.width && from.height === to.height;\n}\n\n/**\n * @param {?LayoutRectDef} r1\n * @param {?LayoutRectDef} r2\n * @return {boolean}\n */\nexport function layoutRectEquals(r1, r2) {\n  if (!r1 || !r2) {\n    return false;\n  }\n  return (\n    r1.left == r2.left &&\n    r1.top == r2.top &&\n    r1.width == r2.width &&\n    r1.height == r2.height\n  );\n}\n\n/**\n * @param {LayoutMarginsChangeDef|undefined} marginsChange\n * @return {LayoutMarginsChangeDef|undefined}\n */\nexport function cloneLayoutMarginsChangeDef(marginsChange) {\n  if (!marginsChange) {\n    return marginsChange;\n  }\n  return {\n    top: marginsChange.top,\n    bottom: marginsChange.bottom,\n    left: marginsChange.left,\n    right: marginsChange.right,\n  };\n}\n\n/**\n * @param {!LayoutRectDef|!ClientRect|!DOMRect} rect\n * @return {!LayoutSizeDef}\n */\nexport function layoutSizeFromRect(rect) {\n  const {height, width} = rect;\n  return {width, height};\n}\n", "/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */\n\n\n/**\n * This regex consists of 4 matching capture groups and one (non-matching) fallback:\n *\n * - (\\0), catch the null terminator character so it may be replaced by UTF\n *   Replacement Char\n * - ^(-)$, catch a solitary dash char, so that it may be backslash escaped.\n *   This is a separate capture group so that the legal-chars (group 4) doesn't\n *   capture it first, since that group doesn't need to escape its dash.\n * - ([\\x01-\\x1f\\x7f]|^-?[0-9]), catch a UTF control char, or any leading\n *   number (with an optional leading dash). The control or the number (but not\n *   the leading dash) must be hex-escaped,.\n * - ([\\x80-\\uffff0-9a-zA-Z_-]+), catch legal-chars, with the exception of a\n *   solitary dash, which will already have matched in group 1.\n * - [^], finally, a catch-all that allows us to backslash escape the char.\n *\n * Together, this matches everything necessary for CSS.escape.\n */\nvar regex = /(\\0)|^(-)$|([\\x01-\\x1f\\x7f]|^-?[0-9])|([\\x80-\\uffff0-9a-zA-Z_-]+)|[^]/g;\n\nfunction escaper(match, nil, dash, hexEscape, chars) {\n  // Chars is the legal-chars (group 4) capture\n  if (chars) {\n    return chars;\n  }\n  // Nil is the null terminator (group 1) capture\n  if (nil) {\n    return '\\uFFFD';\n  }\n  // Both UTF control chars, and leading numbers (with optional leading dash)\n  // (group 3) must be backslash escaped with a trailing space.  Funnily, the\n  // leading dash must not be escaped, but the number. :shrug:\n  if (hexEscape) {\n    return match.slice(0, -1) + '\\\\' + match.slice(-1).charCodeAt(0).toString(16) + ' '\n  }\n  // Finally, the solitary dash and the catch-all chars require backslash\n  // escaping.\n  return '\\\\' + match;\n}\n\n/**\n * https://drafts.csswg.org/cssom/#serialize-an-identifier\n * @param {string} value\n * @return {string}\n */\nexport function cssEscape(value) {\n  return String(value).replace(regex, escaper);\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {cssEscape} from '../../../third_party/css-escape/css-escape';\nimport {devAssert} from '../assert';\n\n/**\n * @type {boolean|undefined}\n */\nlet scopeSelectorSupported;\n\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\nexport function setScopeSelectorSupportedForTesting(val) {\n  scopeSelectorSupported = val;\n}\n\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element|!ShadowRoot} el\n * @return {boolean}\n */\nexport function isScopeSelectorSupported(el) {\n  if (scopeSelectorSupported !== undefined) {\n    return scopeSelectorSupported;\n  }\n\n  return (scopeSelectorSupported = testScopeSelector(el));\n}\n\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element|!ShadowRoot} el\n * @return {boolean}\n */\nfunction testScopeSelector(el) {\n  try {\n    const doc = el.ownerDocument;\n    const testElement = doc.createElement('div');\n    const testChild = doc.createElement('div');\n    testElement.appendChild(testChild);\n    // NOTE(cvializ, #12383): Firefox's implementation is incomplete,\n    // therefore we test actual functionality of`:scope` as well.\n    return testElement./*OK*/ querySelector(':scope div') === testChild;\n  } catch (e) {\n    return false;\n  }\n}\n\n/**\n * Prefixes a selector for ancestor selection. Splits in subselectors and\n * applies prefix to each.\n *\n * e.g.\n * ```\n *   prependSelectorsWith('div', '.i-amphtml-scoped');\n *   // => '.i-amphtml-scoped div'\n *   prependSelectorsWith('div, ul', ':scope');\n *   // => ':scope div, :scope ul'\n *   prependSelectorsWith('div, ul', 'article >');\n *   // => 'article > div, article > ul'\n * ```\n *\n * @param {string} selector\n * @param {string} distribute\n * @return {string}\n */\nexport function prependSelectorsWith(selector, distribute) {\n  return selector.replace(/^|,/g, `$&${distribute} `);\n}\n\n/**\n * Escapes an ident (ID or a class name) to be used as a CSS selector.\n *\n * See https://drafts.csswg.org/cssom/#serialize-an-identifier.\n *\n * @param {string} ident\n * @return {string}\n * @suppress {uselessCode}\n */\nexport function escapeCssSelectorIdent(ident) {\n  // This gets rewritten to true/false during compilation. It will trigger an\n  // JSC_UNREACHABLE_CODE warning, but that's intentional for DCE.\n  if (IS_ESM) {\n    return CSS.escape(ident);\n  }\n  return cssEscape(ident);\n}\n\n/**\n * Escapes an ident in a way that can be used by :nth-child() psuedo-class.\n *\n * See https://github.com/w3c/csswg-drafts/issues/2306.\n *\n * @param {string|number} ident\n * @return {string}\n */\nexport function escapeCssSelectorNth(ident) {\n  const escaped = String(ident);\n  // Ensure it doesn't close the nth-child psuedo class.\n  devAssert(escaped.indexOf(')') === -1);\n  return escaped;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../assert';\nimport {isScopeSelectorSupported, prependSelectorsWith} from './css-selectors';\n\n/** @fileoverview Helper functions for DOM queries. */\n\n/**\n * Asserts that name is just an alphanumeric word, and does not contain\n * advanced CSS selector features like attributes, psuedo-classes, class names,\n * nor ids.\n * @param {string} name\n */\nfunction assertIsName(name) {\n  devAssert(\n    /^[\\w-]+$/.test(name),\n    `Expected \"${name}\" to be a CSS name composed of alphanumerics and hyphens.`\n  );\n}\n\n/**\n * Finds all elements that matche `selector`, scoped inside `root`\n * for user-agents that do not support native scoping.\n *\n * This method isn't required for modern builds, can be removed.\n *\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n */\nfunction scopedQuerySelectionFallback(root, selector) {\n  const unique = 'i-amphtml-scoped';\n  root.classList.add(unique);\n  const scopedSelector = prependSelectorsWith(selector, `.${unique}`);\n  const elements = root./*OK*/ querySelectorAll(scopedSelector);\n  root.classList.remove(unique);\n  return elements;\n}\n\n/**\n * Finds the first element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {?Element}\n *\n * @suppress {suspiciousCode}\n */\nexport function scopedQuerySelector(root, selector) {\n  if (IS_ESM || isScopeSelectorSupported(root)) {\n    return root./*OK*/ querySelector(prependSelectorsWith(selector, ':scope'));\n  }\n\n  // Only IE.\n  const fallbackResult = scopedQuerySelectionFallback(root, selector);\n  return fallbackResult[0] === undefined ? null : fallbackResult[0];\n}\n\n/**\n * Finds every element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n *\n * @suppress {suspiciousCode}\n */\nexport function scopedQuerySelectorAll(root, selector) {\n  if (IS_ESM || isScopeSelectorSupported(root)) {\n    return root./*OK*/ querySelectorAll(\n      prependSelectorsWith(selector, ':scope')\n    );\n  }\n\n  // Only IE.\n  return scopedQuerySelectionFallback(root, selector);\n}\n\n/**\n * Checks if the given element matches the selector\n * @param  {!Element} el The element to verify\n * @param  {string} selector The selector to check against\n * @return {boolean} True if the element matched the selector. False otherwise.\n */\nexport function matches(el, selector) {\n  const matcher =\n    el.matches ||\n    el.webkitMatchesSelector ||\n    el.mozMatchesSelector ||\n    el.msMatchesSelector ||\n    el.oMatchesSelector;\n  if (matcher) {\n    return matcher.call(el, selector);\n  }\n  return false; // IE8 always returns false.\n}\n\n/**\n * Finds the closest element that satisfies the callback from this element\n * up the DOM subtree.\n * @param {!Element} element\n * @param {function(!Element):boolean} callback\n * @param {Element=} opt_stopAt optional elemnt to stop the search at.\n * @return {?Element}\n */\nexport function closest(element, callback, opt_stopAt) {\n  for (let el = element; el && el !== opt_stopAt; el = el.parentElement) {\n    if (callback(el)) {\n      return el;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the closest node that satisfies the callback from this node\n * up the DOM subtree.\n * @param {!Node} node\n * @param {function(!Node):boolean} callback\n * @return {?Node}\n */\nexport function closestNode(node, callback) {\n  for (let n = node; n; n = n.parentNode) {\n    if (callback(n)) {\n      return n;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the closest ancestor element with the specified selector from this\n * element.\n * @param {!Element} element\n * @param {string} selector\n * @return {?Element} closest ancestor if found.\n */\nexport function closestAncestorElementBySelector(element, selector) {\n  return element.closest\n    ? element.closest(selector)\n    : closest(element, (el) => matches(el, selector));\n}\n\n/**\n * Finds all ancestor elements that satisfy predicate.\n * @param {!Element} child\n * @param {function(!Element):boolean} predicate\n * @return {!Array<!Element>}\n */\nexport function ancestorElements(child, predicate) {\n  const ancestors = [];\n  for (\n    let ancestor = child.parentElement;\n    ancestor;\n    ancestor = ancestor.parentElement\n  ) {\n    if (predicate(ancestor)) {\n      ancestors.push(ancestor);\n    }\n  }\n  return ancestors;\n}\n\n/**\n * Finds all ancestor elements that has the specified tag name.\n * @param {!Element} child\n * @param {string} tagName\n * @return {!Array<!Element>}\n */\nexport function ancestorElementsByTag(child, tagName) {\n  assertIsName(tagName);\n  tagName = tagName.toUpperCase();\n  return ancestorElements(child, (el) => el.tagName == tagName);\n}\n\n/**\n * Finds the first child element that satisfies the callback.\n * TODO(rcebulko): Can we start using generators in childElements and defer to\n * that here?\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function childElement(parent, callback) {\n  for (\n    let child = parent.firstElementChild;\n    child;\n    child = child.nextElementSibling\n  ) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the last child element that satisfies the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function lastChildElement(parent, callback) {\n  for (\n    let child = parent.lastElementChild;\n    child;\n    child = child.previousElementSibling\n  ) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds all child elements that satisfy the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {!Array<!Element>}\n */\nexport function childElements(parent, callback) {\n  const children = [];\n  for (\n    let child = parent.firstElementChild;\n    child;\n    child = child.nextElementSibling\n  ) {\n    if (callback(child)) {\n      children.push(child);\n    }\n  }\n  return children;\n}\n\n/**\n * Finds all child nodes that satisfy the callback.\n * These nodes can include Text, Comment and other child nodes.\n * @param {!Node} parent\n * @param {function(!Node):boolean} callback\n * @return {!Array<!Node>}\n */\nexport function childNodes(parent, callback) {\n  const nodes = [];\n  for (let child = parent.firstChild; child; child = child.nextSibling) {\n    if (callback(child)) {\n      nodes.push(child);\n    }\n  }\n  return nodes;\n}\n\n/**\n * Finds the first child element that has the specified attribute.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} attr\n * @return {?Element}\n */\nexport function childElementByAttr(parent, attr) {\n  assertIsName(attr);\n  return /*OK*/ scopedQuerySelector(parent, `> [${attr}]`);\n}\n\n/**\n * Finds the last child element that has the specified attribute.\n * @param {!Element} parent\n * @param {string} attr\n * @return {?Element}\n */\nexport function lastChildElementByAttr(parent, attr) {\n  assertIsName(attr);\n  return lastChildElement(parent, (el) => {\n    return el.hasAttribute(attr);\n  });\n}\n\n/**\n * Finds all child elements that has the specified attribute.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} attr\n * @return {!NodeList<!Element>}\n */\nexport function childElementsByAttr(parent, attr) {\n  assertIsName(attr);\n  return /*OK*/ scopedQuerySelectorAll(parent, `> [${attr}]`);\n}\n\n/**\n * Finds the first child element that has the specified tag name.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} tagName\n * @return {?Element}\n */\nexport function childElementByTag(parent, tagName) {\n  assertIsName(tagName);\n  return /*OK*/ scopedQuerySelector(parent, `> ${tagName}`);\n}\n\n/**\n * Finds all child elements with the specified tag name.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} tagName\n * @return {!NodeList<!Element>}\n */\nexport function childElementsByTag(parent, tagName) {\n  assertIsName(tagName);\n  return /*OK*/ scopedQuerySelectorAll(parent, `> ${tagName}`);\n}\n\n/**\n * Finds the first descendant element with the specified name.\n * @param {!Element|!Document|!ShadowRoot} element\n * @param {string} tagName\n * @return {?Element}\n */\nexport function elementByTag(element, tagName) {\n  assertIsName(tagName);\n  return element./*OK*/ querySelector(tagName);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Externs declare that access `defaultView` from `document` or\n * `ownerDocument` is of type `(Window|null)` but most of our parameter types\n * assume that it is never null. This is OK in practice as we ever only get\n * null on disconnected documents or old IE.\n * This helper function casts it into just a simple Window return type.\n *\n * @param {?Window} winOrNull\n * @return {!Window}\n */\nexport function toWin(winOrNull) {\n  return /** @type {!Window} */ (winOrNull);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {dev, devAssert} from './log';\nimport {dict} from './core/types/object';\nimport {includes} from './core/types/string';\nimport {matches} from './core/dom/query';\nimport {toWin} from './core/window';\n\nconst HTML_ESCAPE_CHARS = {\n  '&': '&amp;',\n  '<': '&lt;',\n  '>': '&gt;',\n  '\"': '&quot;',\n  \"'\": '&#x27;',\n  '`': '&#x60;',\n};\nconst HTML_ESCAPE_REGEX = /(&|<|>|\"|'|`)/g;\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_PROMISE = '__AMP_UPG_PRM';\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_RESOLVER = '__AMP_UPG_RES';\n\n/**\n * @typedef {{\n *   bubbles: (boolean|undefined),\n *   cancelable: (boolean|undefined),\n * }}\n */\nexport let CustomEventOptionsDef;\n\n/** @const {!CustomEventOptionsDef} */\nconst DEFAULT_CUSTOM_EVENT_OPTIONS = {bubbles: true, cancelable: true};\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * callback is executed.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @param {function()} callback\n * @suppress {suspiciousCode}\n */\nexport function waitForChild(parent, checkFunc, callback) {\n  if (checkFunc(parent)) {\n    callback();\n    return;\n  }\n  /** @const {!Window} */\n  const win = toWin(parent.ownerDocument.defaultView);\n  if (IS_ESM || win.MutationObserver) {\n    /** @const {MutationObserver} */\n    const observer = new win.MutationObserver(() => {\n      if (checkFunc(parent)) {\n        observer.disconnect();\n        callback();\n      }\n    });\n    observer.observe(parent, {childList: true});\n  } else {\n    /** @const {number} */\n    const interval = win.setInterval(() => {\n      if (checkFunc(parent)) {\n        win.clearInterval(interval);\n        callback();\n      }\n    }, /* milliseconds */ 5);\n  }\n}\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * promise is resolved.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @return {!Promise}\n */\nexport function waitForChildPromise(parent, checkFunc) {\n  return new Promise((resolve) => {\n    waitForChild(parent, checkFunc, resolve);\n  });\n}\n\n/**\n * Waits for document's body to be available and ready.\n * @param {!Document} doc\n * @param {function()} callback\n */\nexport function waitForBodyOpen(doc, callback) {\n  waitForChild(doc.documentElement, () => !!doc.body, callback);\n}\n\n/**\n * Waits for document's body to be available.\n * @param {!Document} doc\n * @return {!Promise}\n */\nexport function waitForBodyOpenPromise(doc) {\n  return new Promise((resolve) => waitForBodyOpen(doc, resolve));\n}\n\n/**\n * Removes the element.\n * @param {!Element} element\n */\nexport function removeElement(element) {\n  if (element.parentElement) {\n    element.parentElement.removeChild(element);\n  }\n}\n\n/**\n * Removes all child nodes of the specified element.\n * @param {!Element|!DocumentFragment} parent\n */\nexport function removeChildren(parent) {\n  while (parent.firstChild) {\n    parent.removeChild(parent.firstChild);\n  }\n}\n\n/**\n * Copies all children nodes of element \"from\" to element \"to\". Child nodes\n * are deeply cloned. Notice, that this method should be used with care and\n * preferably on smaller subtrees.\n * @param {!Element} from\n * @param {!Element|!DocumentFragment} to\n */\nexport function copyChildren(from, to) {\n  const frag = to.ownerDocument.createDocumentFragment();\n  for (let n = from.firstChild; n; n = n.nextSibling) {\n    frag.appendChild(n.cloneNode(true));\n  }\n  to.appendChild(frag);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n * @param {?Node=} after\n */\nexport function insertAfterOrAtStart(root, element, after = null) {\n  if (!after) {\n    insertAtStart(root, element);\n    return;\n  }\n  const before = after.nextSibling;\n  root.insertBefore(element, before);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n */\nexport function insertAtStart(root, element) {\n  root.insertBefore(element, root.firstChild);\n}\n\n/**\n * Add attributes to an element.\n * @param {!Element} element\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function addAttributesToElement(element, attributes) {\n  for (const attr in attributes) {\n    element.setAttribute(attr, attributes[attr]);\n  }\n  return element;\n}\n\n/**\n * Create a new element on document with specified tagName and attributes.\n * @param {!Document} doc\n * @param {string} tagName\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function createElementWithAttributes(doc, tagName, attributes) {\n  const element = doc.createElement(tagName);\n  return addAttributesToElement(element, attributes);\n}\n\n/**\n * Returns true if node is connected (attached).\n * @param {!Node} node\n * @return {boolean}\n * @see https://dom.spec.whatwg.org/#connected\n */\nexport function isConnectedNode(node) {\n  const connected = node.isConnected;\n  if (connected !== undefined) {\n    return connected;\n  }\n\n  // \"An element is connected if its shadow-including root is a document.\"\n  let n = node;\n  do {\n    n = rootNodeFor(n);\n    if (n.host) {\n      n = n.host;\n    } else {\n      break;\n    }\n  } while (true);\n  return n.nodeType === Node.DOCUMENT_NODE;\n}\n\n/**\n * Returns the root for a given node. Does not cross shadow DOM boundary.\n * @param {!Node} node\n * @return {!Node}\n */\nexport function rootNodeFor(node) {\n  if (Node.prototype.getRootNode) {\n    // Type checker says `getRootNode` may return null.\n    return node.getRootNode() || node;\n  }\n  let n;\n  // Check isShadowRoot() is only needed for the polyfill case.\n  for (\n    n = node;\n    !!n.parentNode && !isShadowRoot(/** @type {HTMLElement} */ (n));\n    n = n.parentNode\n  ) {}\n  return n;\n}\n\n/**\n * Determines if value is actually a `ShadowRoot` node.\n * @param {HTMLElement} value\n * @return {boolean}\n */\nexport function isShadowRoot(value) {\n  if (!value) {\n    return false;\n  }\n  // Node.nodeType == DOCUMENT_FRAGMENT to speed up the tests. Unfortunately,\n  // nodeType of DOCUMENT_FRAGMENT is used currently for ShadowRoot nodes.\n  if (value.tagName == 'I-AMPHTML-SHADOW-ROOT') {\n    return true;\n  }\n  return (\n    value.nodeType == /* DOCUMENT_FRAGMENT */ 11 &&\n    Object.prototype.toString.call(value) === '[object ShadowRoot]'\n  );\n}\n\n/**\n * Returns element data-param- attributes as url parameters key-value pairs.\n * e.g. data-param-some-attr=value -> {someAttr: value}.\n * @param {!HTMLElement} element\n * @param {function(string):string=} opt_computeParamNameFunc to compute the\n *    parameter name, get passed the camel-case parameter name.\n * @param {!RegExp=} opt_paramPattern Regex pattern to match data attributes.\n * @return {!JsonObject}\n */\nexport function getDataParamsFromAttributes(\n  element,\n  opt_computeParamNameFunc,\n  opt_paramPattern\n) {\n  const computeParamNameFunc = opt_computeParamNameFunc || ((key) => key);\n  const {dataset} = element;\n  const params = dict();\n  const paramPattern = opt_paramPattern ? opt_paramPattern : /^param(.+)/;\n  for (const key in dataset) {\n    const matches = key.match(paramPattern);\n    if (matches) {\n      const param = matches[1][0].toLowerCase() + matches[1].substr(1);\n      params[computeParamNameFunc(param)] = dataset[key];\n    }\n  }\n  return params;\n}\n\n/**\n * Whether the element have a next node in the document order.\n * This means either:\n *  a. The element itself has a nextSibling.\n *  b. Any of the element ancestors has a nextSibling.\n * @param {!Element} element\n * @param {?Node} opt_stopNode\n * @return {boolean}\n */\nexport function hasNextNodeInDocumentOrder(element, opt_stopNode) {\n  let currentElement = element;\n  do {\n    if (currentElement.nextSibling) {\n      return true;\n    }\n  } while (\n    (currentElement = currentElement.parentNode) &&\n    currentElement != opt_stopNode\n  );\n  return false;\n}\n\n/**\n * Returns a clone of the content of a template element.\n *\n * Polyfill to replace .content access for browsers that do not support\n * HTMLTemplateElements natively.\n *\n * @param {!HTMLTemplateElement|!Element} template\n * @return {!DocumentFragment}\n */\nexport function templateContentClone(template) {\n  if ('content' in template) {\n    return template.content.cloneNode(true);\n  } else {\n    const content = template.ownerDocument.createDocumentFragment();\n    copyChildren(template, content);\n    return content;\n  }\n}\n\n/**\n * Iterate over an array-like.\n * Test cases: https://jsbench.github.io/#f638cacc866a1b2d6e517e6cfa900d6b\n * @param {!IArrayLike<T>} iterable\n * @param {function(T, number)} cb\n * @template T\n */\nexport function iterateCursor(iterable, cb) {\n  const {length} = iterable;\n  for (let i = 0; i < length; i++) {\n    cb(iterable[i], i);\n  }\n}\n\n/**\n * This method wraps around window's open method. It first tries to execute\n * `open` call with the provided target and if it fails, it retries the call\n * with the `_top` target. This is necessary given that in some embedding\n * scenarios, such as iOS' WKWebView, navigation to `_blank` and other targets\n * is blocked by default.\n *\n * @param {!Window} win\n * @param {string} url\n * @param {string} target\n * @param {string=} opt_features\n * @return {?Window}\n */\nexport function openWindowDialog(win, url, target, opt_features) {\n  // Try first with the specified target. If we're inside the WKWebView or\n  // a similar environments, this method is expected to fail by default for\n  // all targets except `_top`.\n  let res;\n  try {\n    res = win.open(url, target, opt_features);\n  } catch (e) {\n    dev().error('DOM', 'Failed to open url on target: ', target, e);\n  }\n\n  // Then try with `_top` target.\n  if (!res && target != '_top' && !includes(opt_features || '', 'noopener')) {\n    res = win.open(url, '_top');\n  }\n  return res;\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.hasAttribute('type') &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/JSON'\n  );\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonLdScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/LD+JSON'\n  );\n}\n\n/**\n * Whether the page's direction is right to left or not.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isRTL(doc) {\n  const dir =\n    doc.body.getAttribute('dir') ||\n    doc.documentElement.getAttribute('dir') ||\n    'ltr';\n  return dir == 'rtl';\n}\n\n/**\n * Escapes `<`, `>` and other HTML charcaters with their escaped forms.\n * @param {string} text\n * @return {string}\n */\nexport function escapeHtml(text) {\n  if (!text) {\n    return text;\n  }\n  return text.replace(HTML_ESCAPE_REGEX, escapeHtmlChar);\n}\n\n/**\n * @param {string} c\n * @return {string}\n */\nfunction escapeHtmlChar(c) {\n  return HTML_ESCAPE_CHARS[c];\n}\n\n/**\n * Tries to focus on the given element; fails silently if browser throws an\n * exception.\n * @param {!Element} element\n */\nexport function tryFocus(element) {\n  try {\n    element./*OK*/ focus();\n  } catch (e) {\n    // IE <= 7 may throw exceptions when focusing on hidden items.\n  }\n}\n\n/**\n * Whether the given window is in an iframe or not.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isIframed(win) {\n  return win.parent && win.parent != win;\n}\n\n/**\n * Determines if this element is an AMP element\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isAmpElement(element) {\n  const tag = element.tagName;\n  // Use prefix to recognize AMP element. This is necessary because stub\n  // may not be attached yet.\n  return (\n    tag.startsWith('AMP-') &&\n    // Some \"amp-*\" elements are not really AMP elements. :smh:\n    !(tag == 'AMP-STICKY-AD-TOP-PADDING' || tag == 'AMP-BODY')\n  );\n}\n\n/**\n * Return a promise that resolve when an AMP element upgrade from HTMLElement\n * to CustomElement\n * @param {!HTMLElement} element\n * @return {!Promise<!AmpElement>}\n */\nexport function whenUpgradedToCustomElement(element) {\n  devAssert(isAmpElement(element), 'element is not AmpElement');\n  if (element.createdCallback) {\n    // Element already is CustomElement;\n    return Promise.resolve(/**@type {!AmpElement} */ (element));\n  }\n  // If Element is still HTMLElement, wait for it to upgrade to customElement\n  // Note: use pure string to avoid obfuscation between versions.\n  if (!element[UPGRADE_TO_CUSTOMELEMENT_PROMISE]) {\n    const deferred = new Deferred();\n    element[UPGRADE_TO_CUSTOMELEMENT_PROMISE] = deferred.promise;\n    element[UPGRADE_TO_CUSTOMELEMENT_RESOLVER] = deferred.resolve;\n  }\n\n  return element[UPGRADE_TO_CUSTOMELEMENT_PROMISE];\n}\n\n/**\n * Returns true if node is not disabled.\n *\n * IE8 can return false positives, see {@link matches}.\n * @param {!HTMLInputElement} element\n * @return {boolean}\n * @see https://www.w3.org/TR/html5/forms.html#concept-fe-disabled\n */\nexport function isEnabled(element) {\n  return !(element.disabled || matches(element, ':disabled'));\n}\n\n/**\n * A sorting comparator that sorts elements in DOM tree order.\n * A first sibling is sorted to be before its nextSibling.\n * A parent node is sorted to be before a child.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/compareDocumentPosition\n *\n * @param {!Element} element1\n * @param {!Element} element2\n * @return {number}\n */\nexport function domOrderComparator(element1, element2) {\n  if (element1 === element2) {\n    return 0;\n  }\n\n  const pos = element1.compareDocumentPosition(element2);\n  const precedingOrContains =\n    Node.DOCUMENT_POSITION_PRECEDING | Node.DOCUMENT_POSITION_CONTAINS;\n\n  // if fe2 is preceding or contains fe1 then, fe1 is after fe2\n  if (pos & precedingOrContains) {\n    return 1;\n  }\n\n  // if fe2 is following or contained by fe1, then fe1 is before fe2\n  return -1;\n}\n\n/**\n * Like `Element.prototype.toggleAttribute`. This either toggles an attribute\n * on by adding an attribute with an empty value, or toggles it off by removing\n * the attribute. This does not mutate the element if the new state matches\n * the existing state.\n * @param {!Element} element An element to toggle the attribute for.\n * @param {string} name The name of the attribute.\n * @param {boolean=} forced Whether the attribute should be forced on/off. If\n *    not specified, it will be toggled from the current state.\n * @return {boolean} Whether or not the element now has the attribute.\n */\nexport function toggleAttribute(element, name, forced) {\n  const hasAttribute = element.hasAttribute(name);\n  const enabled = forced !== undefined ? forced : !hasAttribute;\n\n  if (enabled !== hasAttribute) {\n    if (enabled) {\n      element.setAttribute(name, '');\n    } else {\n      element.removeAttribute(name);\n    }\n  }\n\n  return enabled;\n}\n\n/**\n * Parses a string as a boolean value using the expanded rules for DOM boolean\n * attributes:\n * - a `null` or `undefined` returns `null`;\n * - an empty string returns `true`;\n * - a \"false\" string returns `false`;\n * - otherwise, `true` is returned.\n *\n * @param {?string|undefined} s\n * @return {boolean|undefined}\n */\nexport function parseBooleanAttribute(s) {\n  return s == null ? undefined : s !== 'false';\n}\n\n/**\n * @param {!Window} win\n * @return {number} The width of the vertical scrollbar, in pixels.\n */\nexport function getVerticalScrollbarWidth(win) {\n  const {documentElement} = win.document;\n  const windowWidth = win./*OK*/ innerWidth;\n  const documentWidth = documentElement./*OK*/ clientWidth;\n  return windowWidth - documentWidth;\n}\n\n/**\n * Dispatches a custom event.\n *\n * @param {!Node} node\n * @param {string} name\n * @param {!Object=} opt_data Event data.\n * @param {!CustomEventOptionsDef=} opt_options\n */\nexport function dispatchCustomEvent(node, name, opt_data, opt_options) {\n  const data = opt_data || {};\n  // Constructors of events need to come from the correct window. Sigh.\n  const event = node.ownerDocument.createEvent('Event');\n\n  // Technically .data is not a property of Event.\n  /**@type {?}*/ (event).data = data;\n\n  const {bubbles, cancelable} = opt_options || DEFAULT_CUSTOM_EVENT_OPTIONS;\n  event.initEvent(name, bubbles, cancelable);\n  node.dispatchEvent(event);\n}\n\n/**\n * Ensures the child is contained by the parent, but not the parent itself.\n *\n * @param {!Node} parent\n * @param {!Node} child\n * @return {boolean}\n */\nexport function containsNotSelf(parent, child) {\n  return child !== parent && parent.contains(child);\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview\n * IE 10 throws \"Unspecified error\" when calling getBoundingClientRect() on a\n * disconnected node.\n * @see https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/106812/\n */\n\nimport {LayoutRectDef, layoutRectLtwh} from '../core/math/layout-rect';\nimport {isConnectedNode} from '../dom';\n\n/**\n * Stores the native getBoundingClientRect before we patch it, so that the\n * patch may call the native implementation.\n */\nlet nativeClientRect;\n\n/**\n * Polyfill for Node.getBoundingClientRect API.\n * @this {!Element}\n * @return {!ClientRect|!LayoutRectDef}\n * @suppress {suspiciousCode} due to IS_ESM inlining\n */\nfunction getBoundingClientRect() {\n  // eslint-disable-next-line local/no-invalid-this\n  if (IS_ESM || isConnectedNode(this)) {\n    return nativeClientRect.call(this);\n  }\n\n  return layoutRectLtwh(0, 0, 0, 0);\n}\n\n/**\n * Determines if this polyfill should be installed.\n * @param {!Window} win\n * @return {boolean}\n * @suppress {uselessCode} due to IS_ESM inlining\n */\nfunction shouldInstall(win) {\n  if (IS_ESM) {\n    return false;\n  }\n\n  // Don't install in no-DOM environments e.g. worker.\n  if (!win.document) {\n    return false;\n  }\n\n  try {\n    const div = win.document.createElement('div');\n    const rect = div./*OK*/ getBoundingClientRect();\n    return rect.top !== 0;\n  } catch (e) {\n    // IE 10 or less\n    return true;\n  }\n}\n\n/**\n * Sets the getBoundingClientRect polyfill if using IE 10 or an\n * earlier version.\n * @param {!Window} win\n */\nexport function install(win) {\n  if (shouldInstall(win)) {\n    nativeClientRect = Element.prototype.getBoundingClientRect;\n    win.Object.defineProperty(win.Element.prototype, 'getBoundingClientRect', {\n      value: getBoundingClientRect,\n    });\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview\n * See https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver.\n *\n * This is the stub to support IntersectionObserver. It's installed from\n * polyfills/intersection-observer.js and upgraded from the\n * amp-intersection-observer-polyfill extension.\n */\n\n/** @typedef {function(!typeof IntersectionObserver)} */\nlet InObUpgraderDef;\n\nconst UPGRADERS = '_upgraders';\nconst NATIVE = '_native';\nconst STUB = '_stub';\n\n/**\n * @param {!Window} win\n * @return {boolean}\n * @visibleForTesting\n */\nexport function shouldLoadPolyfill(win) {\n  return (\n    !win.IntersectionObserver ||\n    !win.IntersectionObserverEntry ||\n    !!win.IntersectionObserver[STUB] ||\n    !supportsDocumentRoot(win) ||\n    isWebkit(win)\n  );\n}\n\n/**\n * All current WebKit (as of Safari 14.x) {root:document} IntersectionObservers\n * will report incorrect rootBounds, intersectionRect, and intersectionRatios\n * and therefore we force the polyfill in this case.\n * See: https://bugs.webkit.org/show_bug.cgi?id=219495.\n *\n * @param {!Window} win\n * @return {boolean}\n */\nfunction isWebkit(win) {\n  // navigator.vendor is always \"Apple Computer, Inc.\" for all iOS browsers and\n  // Mac OS Safari.\n  return /apple/i.test(win.navigator.vendor);\n}\n\n/**\n * @param {!typeof IntersectionObserver} Native\n * @param {!typeof IntersectionObserver} Polyfill\n * @return {!typeof IntersectionObserver}\n */\nfunction getIntersectionObserverDispatcher(Native, Polyfill) {\n  /**\n   * @param {!IntersectionObserverCallback} ioCallback\n   * @param {IntersectionObserverInit=} opts\n   * @return {!IntersectionObserver}\n   */\n  function Ctor(ioCallback, opts) {\n    if (opts?.root?.nodeType === /* Node.DOCUMENT_NODE */ 9) {\n      return new Polyfill(ioCallback, opts);\n    } else {\n      return new Native(ioCallback, opts);\n    }\n  }\n  return Ctor;\n}\n\n/**\n * Installs the InOb stubs. This should only be called in two cases:\n * 1. No native InOb exists.\n * 2. Native InOb is present, but lacks document root support.\n *\n * @param {!Window} win\n */\nexport function installStub(win) {\n  if (!win.IntersectionObserver) {\n    win.IntersectionObserver = IntersectionObserverStub;\n    win.IntersectionObserver[STUB] = IntersectionObserverStub;\n    return;\n  }\n\n  const Native = win.IntersectionObserver;\n  win.IntersectionObserver = getIntersectionObserverDispatcher(\n    win.IntersectionObserver,\n    IntersectionObserverStub\n  );\n  win.IntersectionObserver[STUB] = IntersectionObserverStub;\n  win.IntersectionObserver[NATIVE] = Native;\n}\n\n/**\n * Returns true if IntersectionObserver supports a document root.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function supportsDocumentRoot(win) {\n  try {\n    new win.IntersectionObserver(() => {}, {\n      // TODO(rcebulko): Update when CC updates their externs\n      // See https://github.com/google/closure-compiler/pull/3804\n      root: /** @type {?} */ (win.document),\n    });\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * @param {!Window} win\n * @param {function()} installer\n */\nexport function upgradePolyfill(win, installer) {\n  // Can't use the IntersectionObserverStub here directly since it's a separate\n  // instance deployed in v0.js vs the polyfill extension.\n  const Stub = win.IntersectionObserver[STUB];\n  if (Stub) {\n    const Native = win.IntersectionObserver[NATIVE];\n    delete win.IntersectionObserver;\n    delete win.IntersectionObserverEntry;\n    installer();\n    const Polyfill = win.IntersectionObserver;\n    if (Native) {\n      win.IntersectionObserver = getIntersectionObserverDispatcher(\n        Native,\n        Polyfill\n      );\n    }\n\n    /** @type {!Array<!InObUpgraderDef>} */\n    const upgraders = Stub[UPGRADERS].slice(0);\n    const microtask = Promise.resolve();\n    const upgrade = (upgrader) => {\n      microtask.then(() => upgrader(Polyfill));\n    };\n    upgraders.forEach(upgrade);\n    Stub[UPGRADERS] = {'push': upgrade};\n  } else {\n    // Even if this is not the stub, we still may need to polyfill\n    // `isIntersecting`. See `shouldLoadPolyfill` for more info.\n    installer();\n  }\n}\n\n/**\n * The stub for `IntersectionObserver`. Implements the same interface, but\n * keeps the tracked elements in memory until the actual polyfill arives.\n * This stub is necessary because the polyfill itself is significantly bigger.\n *\n * It doesn't technically extend IntersectionObserver, but this allows the stub\n * to be seen as equivalent when typechecking calls expecting an\n * IntersectionObserver.\n * @extends IntersectionObserver\n */\nexport class IntersectionObserverStub {\n  /**\n   * @param {!IntersectionObserverCallback} callback\n   * @param {!IntersectionObserverInit=} options\n   */\n  constructor(callback, options) {\n    /** @private @const */\n    this.callback_ = callback;\n\n    /** @private @const {!IntersectionObserverInit} */\n    this.options_ = {\n      root: null,\n      rootMargin: '0px 0px 0px 0px',\n      ...options,\n    };\n\n    /** @private {!Array<!Element>} */\n    this.elements_ = [];\n\n    /** @private {?IntersectionObserver} */\n    this.inst_ = null;\n\n    // Wait for the upgrade.\n    IntersectionObserverStub[UPGRADERS].push(this.upgrade_.bind(this));\n  }\n\n  /** @return {?Element} */\n  get root() {\n    if (this.inst_) {\n      return this.inst_.root;\n    }\n    return this.options_.root || null;\n  }\n\n  /** @return {string} */\n  get rootMargin() {\n    if (this.inst_) {\n      return this.inst_.rootMargin;\n    }\n    // The CC-provided IntersectionObserverInit type allows for rootMargin to be\n    // undefined, but we provide a default, so it's guaranteed to be a string\n    // here.\n    return /** @type {string} */ (this.options_.rootMargin);\n  }\n\n  /** @return {!Array<number>} */\n  get thresholds() {\n    if (this.inst_) {\n      return this.inst_.thresholds;\n    }\n    return [].concat(this.options_.threshold || 0);\n  }\n\n  /** @return {undefined} */\n  disconnect() {\n    if (this.inst_) {\n      this.inst_.disconnect();\n    } else {\n      this.elements_.length = 0;\n    }\n  }\n\n  /** @return {!Array<!IntersectionObserverEntry>} */\n  takeRecords() {\n    if (this.inst_) {\n      return this.inst_.takeRecords();\n    }\n    return [];\n  }\n\n  /** @param {!Element} target */\n  observe(target) {\n    if (this.inst_) {\n      this.inst_.observe(target);\n    } else {\n      if (this.elements_.indexOf(target) == -1) {\n        this.elements_.push(target);\n      }\n    }\n  }\n\n  /** @param {!Element} target */\n  unobserve(target) {\n    if (this.inst_) {\n      this.inst_.unobserve(target);\n    } else {\n      const index = this.elements_.indexOf(target);\n      if (index != -1) {\n        this.elements_.splice(index, 1);\n      }\n    }\n  }\n\n  /**\n   * @param {!typeof IntersectionObserver} Ctor\n   * @private\n   */\n  upgrade_(Ctor) {\n    const inst = new Ctor(this.callback_, this.options_);\n    this.inst_ = inst;\n    for (const e of this.elements_) {\n      inst.observe(e);\n    }\n    this.elements_.length = 0;\n  }\n}\n\n/** @type {!Array<!InObUpgraderDef>} */\nIntersectionObserverStub[UPGRADERS] = [];\n\n/** @visibleForTesting */\nexport function resetStubsForTesting() {\n  IntersectionObserverStub[UPGRADERS] = [];\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview\n * See https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver.\n */\n\nimport {\n  installStub,\n  shouldLoadPolyfill,\n} from './stubs/intersection-observer-stub';\n\n/**\n * Installs the IntersectionObserver polyfill. There are a few different modes of operation.\n * - No native support: immediately register a Stub and upgrade lazily once the full polyfill loads.\n * - Partial InOb support: choose between the lazily upgrading Stub and the native InOb on a per-instance basis.\n * - Full InOb support: Don't install anything.\n *\n * @param {!Window} win\n */\nexport function install(win) {\n  if (shouldLoadPolyfill(win)) {\n    installStub(win);\n  }\n  fixEntry(win);\n}\n\n/**\n * @param {!Window} parentWin\n * @param {!Window} childWin\n */\nexport function installForChildWin(parentWin, childWin) {\n  if (shouldLoadPolyfill(childWin)) {\n    Object.defineProperties(childWin, {\n      IntersectionObserver: {get: () => parentWin.IntersectionObserver},\n      IntersectionObserverEntry: {\n        get: () => parentWin.IntersectionObserverEntry,\n      },\n    });\n  } else {\n    fixEntry(childWin);\n  }\n}\n\n/** @param {!Window} win */\nfunction fixEntry(win) {\n  // Minimal polyfill for Edge 15's lack of `isIntersecting`\n  // See: https://github.com/w3c/IntersectionObserver/issues/211\n  if (\n    win.IntersectionObserverEntry &&\n    !('isIntersecting' in win.IntersectionObserverEntry.prototype)\n  ) {\n    Object.defineProperty(\n      win.IntersectionObserverEntry.prototype,\n      'isIntersecting',\n      {\n        enumerable: true,\n        configurable: true,\n        get() {\n          return this.intersectionRatio > 0;\n        },\n      }\n    );\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Forces the return value from Map.prototype.set to always be the map\n * instance. IE11 returns undefined.\n *\n * @param {!Window} win\n */\nexport function install(win) {\n  const {Map} = win;\n  const m = new Map();\n  if (m.set(0, 0) !== m) {\n    const {set} = m;\n\n    win.Object.defineProperty(Map.prototype, 'set', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: function () {\n        set.apply(this, arguments);\n        return this;\n      },\n    });\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Parses the number x and returns its sign. For positive x returns 1, for\n * negative, -1. For 0 and -0, returns 0 and -0 respectively. For any number\n * that parses to NaN, returns NaN.\n *\n * @param {number} x\n * @return {number}\n */\nexport function sign(x) {\n  x = Number(x);\n\n  // If x is 0, -0, or NaN, return it.\n  if (!x) {\n    return x;\n  }\n\n  return x > 0 ? 1 : -1;\n}\n\n/**\n * Sets the Math.sign polyfill if it does not exist.\n * @param {!Window} win\n */\nexport function install(win) {\n  if (!win.Math.sign) {\n    win.Object.defineProperty(win.Math, 'sign', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: sign,\n    });\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst {hasOwnProperty} = Object.prototype;\n\n/**\n * Copies values of all enumerable own properties from one or more source\n * objects (provided as extended arguments to the function) to a target object.\n *\n * @param {!Object} target\n * @param {...Object} var_args\n * @return {!Object}\n */\nexport function assign(target, var_args) {\n  if (target == null) {\n    throw new TypeError('Cannot convert undefined or null to object');\n  }\n\n  const output = Object(target);\n  for (let i = 1; i < arguments.length; i++) {\n    const source = arguments[i];\n    if (source != null) {\n      for (const key in source) {\n        if (hasOwnProperty.call(source, key)) {\n          output[key] = source[key];\n        }\n      }\n    }\n  }\n  return output;\n}\n\n/**\n * Sets the Object.assign polyfill if it does not exist.\n * @param {!Window} win\n */\nexport function install(win) {\n  if (!win.Object.assign) {\n    win.Object.defineProperty(win.Object, 'assign', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: assign,\n    });\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Implements `Object.values` API.\n * See https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Object/values.\n *\n * @param {!Object} target\n * @return {!Array<*>}\n */\nexport function values(target) {\n  return Object.keys(target).map((k) => target[k]);\n}\n\n/**\n * Sets the Object.values polyfill if it does not exist.\n * @param {!Window} win\n */\nexport function install(win) {\n  if (!win.Object.values) {\n    win.Object.defineProperty(win.Object, 'values', {\n      configurable: true,\n      writable: true,\n      value: values,\n    });\n  }\n}\n", "'use strict';\n\n/**\n * Constructs a ES6/Promises A+ Promise instance.\n *\n * @constructor\n * @param {function(function(*=), function (*=))} resolver\n */\nfunction Promise(resolver) {\n  if (!(this instanceof Promise)) {\n    throw new TypeError('Constructor Promise requires `new`');\n  }\n  if (!isFunction(resolver)) {\n    throw new TypeError('Must pass resolver function');\n  }\n\n  /**\n   * @type {function(this:Promise,*=,function(*=),function(*=),Deferred):!Promise}\n   * @private\n   */\n  this._state = PendingPromise;\n\n  /**\n   * @type {*}\n   * @private\n   */\n  this._value = [];\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this._isChainEnd = true;\n\n  doResolve(\n    this,\n    adopter(this, FulfilledPromise),\n    adopter(this, RejectedPromise),\n    { then: resolver }\n  );\n}\n\n/****************************\n  Public Instance Methods\n ****************************/\n\n/**\n * Creates a new promise instance that will receive the result of this promise\n * as inputs to the onFulfilled or onRejected callbacks.\n *\n * @param {function(*)} onFulfilled\n * @param {function(*)} onRejected\n */\nPromise.prototype.then = function(onFulfilled, onRejected) {\n  onFulfilled = isFunction(onFulfilled) ? onFulfilled : void 0;\n  onRejected = isFunction(onRejected) ? onRejected : void 0;\n\n  if (onFulfilled || onRejected) {\n    this._isChainEnd = false;\n  }\n\n  return this._state(\n    this._value,\n    onFulfilled,\n    onRejected\n  );\n};\n\n/**\n * Creates a new promise that will handle the rejected state of this promise.\n *\n * @param {function(*)} onRejected\n * @returns {!Promise}\n */\nPromise.prototype.catch = function(onRejected) {\n  return this.then(void 0, onRejected);\n};\n\n/****************************\n  Public Static Methods\n ****************************/\n\n/**\n * Creates a fulfilled Promise of value. If value is itself a then-able,\n * resolves with the then-able's value.\n *\n * @this {!Promise}\n * @param {*=} value\n * @returns {!Promise}\n */\nPromise.resolve = function(value) {\n  var Constructor = this;\n  var promise;\n\n  if (isObject(value) && value instanceof this) {\n    promise = value;\n  } else {\n    promise = new Constructor(function(resolve) {\n      resolve(value);\n    });\n  }\n\n  return /** @type {!Promise} */(promise);\n};\n\n/**\n * Creates a rejected Promise of reason.\n *\n * @this {!Promise}\n * @param {*=} reason\n * @returns {!Promise}\n */\nPromise.reject = function(reason) {\n  var Constructor = this;\n  var promise = new Constructor(function(_, reject) {\n    reject(reason);\n  });\n\n  return /** @type {!Promise} */(promise);\n};\n\n/**\n * Creates a Promise that will resolve with an array of the values of the\n * passed in promises. If any promise rejects, the returned promise will\n * reject.\n *\n * @this {!Promise}\n * @param {!Array<Promise|*>} promises\n * @returns {!Promise}\n */\nPromise.all = function(promises) {\n  var Constructor = this;\n  var promise = new Constructor(function(resolve, reject) {\n    var length = promises.length;\n    var values = new Array(length);\n\n    if (length === 0) {\n      return resolve(values);\n    }\n\n    each(promises, function(promise, index) {\n      Constructor.resolve(promise).then(function(value) {\n        values[index] = value;\n        if (--length === 0) {\n          resolve(values);\n        }\n      }, reject);\n    });\n  });\n\n  return /** @type {!Promise} */(promise);\n};\n\n/**\n * Creates a Promise that will resolve or reject based on the first\n * resolved or rejected promise.\n *\n * @this {!Promise}\n * @param {!Array<Promise|*>} promises\n * @returns {!Promise}\n */\nPromise.race = function(promises) {\n  var Constructor = this;\n  var promise = new Constructor(function(resolve, reject) {\n    for (var i = 0; i < promises.length; i++) {\n      Constructor.resolve(promises[i]).then(resolve, reject);\n    }\n  });\n\n  return /** @type {!Promise} */(promise);\n};\n\nvar onPossiblyUnhandledRejection = function(reason, promise) {\n  throw reason;\n};\n\n/**\n * An internal use static function.\n */\nPromise._overrideUnhandledExceptionHandler = function(handler) {\n  onPossiblyUnhandledRejection = handler;\n};\n\n/****************************\n  Private functions\n ****************************/\n\n/**\n * The Fulfilled Promise state. Calls onFulfilled with the resolved value of\n * this promise, creating a new promise.\n *\n * If there is no onFulfilled, returns the current promise to avoid a promise\n * instance.\n *\n * @this {!Promise} The current promise\n * @param {*=} value The current promise's resolved value.\n * @param {function(*=)=} onFulfilled\n * @param {function(*=)=} unused\n * @param {Deferred} deferred A deferred object that holds a promise and its\n *     resolve and reject functions. It IS NOT passed when called from\n *     Promise#then to save an object instance (since we may return the current\n *     promise). It IS passed in when adopting the Fulfilled state from the\n *     Pending state.\n * @returns {!Promise}\n */\nfunction FulfilledPromise(value, onFulfilled, unused, deferred) {\n  if (!onFulfilled) {\n    deferredAdopt(deferred, FulfilledPromise, value);\n    return this;\n  }\n  if (!deferred) {\n    deferred = new Deferred(this.constructor);\n  }\n  defer(tryCatchDeferred(deferred, onFulfilled, value));\n  return deferred.promise;\n}\n\n/**\n * The Rejected Promise state. Calls onRejected with the resolved value of\n * this promise, creating a new promise.\n *\n * If there is no onRejected, returns the current promise to avoid a promise\n * instance.\n *\n * @this {!Promise} The current promise\n * @param {*=} reason The current promise's rejection reason.\n * @param {function(*=)=} unused\n * @param {function(*=)=} onRejected\n * @param {Deferred} deferred A deferred object that holds a promise and its\n *     resolve and reject functions. It IS NOT passed when called from\n *     Promise#then to save an object instance (since we may return the current\n *     promise). It IS passed in when adopting the Rejected state from the\n *     Pending state.\n * @returns {!Promise}\n */\nfunction RejectedPromise(reason, unused, onRejected, deferred) {\n  if (!onRejected) {\n    deferredAdopt(deferred, RejectedPromise, reason);\n    return this;\n  }\n  if (!deferred) {\n    deferred = new Deferred(this.constructor);\n  }\n  defer(tryCatchDeferred(deferred, onRejected, reason));\n  return deferred.promise;\n}\n\n/**\n * The Pending Promise state. Eventually calls onFulfilled once the promise has\n * resolved, or onRejected once the promise rejects.\n *\n * If there is no onFulfilled and no onRejected, returns the current promise to\n * avoid a promise instance.\n *\n * @this {!Promise} The current promise\n * @param {*=} queue The current promise's pending promises queue.\n * @param {function(*=)=} onFulfilled\n * @param {function(*=)=} onRejected\n * @param {Deferred} deferred A deferred object that holds a promise and its\n *     resolve and reject functions. It IS NOT passed when called from\n *     Promise#then to save an object instance (since we may return the current\n *     promise). It IS passed in when adopting the Pending state from the\n *     Pending state of another promise.\n * @returns {!Promise}\n */\nfunction PendingPromise(queue, onFulfilled, onRejected, deferred) {\n  if (!deferred) {\n    if (!onFulfilled && !onRejected) { return this; }\n    deferred = new Deferred(this.constructor);\n  }\n  queue.push({\n    deferred: deferred,\n    onFulfilled: onFulfilled || deferred.resolve,\n    onRejected: onRejected || deferred.reject\n  });\n  return deferred.promise;\n}\n\n/**\n * Constructs a deferred instance that holds a promise and its resolve and\n * reject functions.\n *\n * @constructor\n */\nfunction Deferred(Promise) {\n  var deferred = this;\n  /** @type {!Promise} */\n  this.promise = new Promise(function(resolve, reject) {\n    /** @type {function(*=)} */\n    deferred.resolve = resolve;\n\n    /** @type {function(*=)} */\n    deferred.reject = reject;\n  });\n  return deferred;\n}\n\n/**\n * Transitions the state of promise to another state. This is only ever called\n * on with a promise that is currently in the Pending state.\n *\n * @param {!Promise} promise\n * @param {function(this:Promise,*=,function(*=),function(*=),Deferred):!Promise} state\n * @param {*=} value\n */\nfunction adopt(promise, state, value, adoptee) {\n  var queue = promise._value;\n  promise._state = state;\n  promise._value = value;\n\n  if (adoptee && state === PendingPromise) {\n    adoptee._state(value, void 0, void 0, {\n      promise: promise,\n      resolve: void 0,\n      reject: void 0\n    });\n  }\n\n  for (var i = 0; i < queue.length; i++) {\n    var next = queue[i];\n    promise._state(\n      value,\n      next.onFulfilled,\n      next.onRejected,\n      next.deferred\n    );\n  }\n  queue.length = 0;\n\n  // If we're adopting another promise, it's not the end of the promise chain,\n  // the new promise is.\n  if (adoptee) {\n    adoptee._isChainEnd = false;\n  }\n\n  // Determine if this rejected promise will be \"handled\".\n  if (state === RejectedPromise && promise._isChainEnd) {\n    setTimeout(function() {\n      if (promise._isChainEnd) {\n        onPossiblyUnhandledRejection(value, promise);\n      }\n    }, 0);\n  }\n}\n\n/**\n * A partial application of adopt.\n *\n * @param {!Promise} promise\n * @param {function(this:Promise,*=,function(*=),function(*=),Deferred):!Promise} state\n * @returns {function(*=)}\n */\nfunction adopter(promise, state) {\n  return function(value) {\n    adopt(promise, state, value);\n  };\n}\n\n/**\n * Updates a deferred promises state. Necessary for updating an adopting\n * promise's state when the adoptee resolves.\n *\n * @param {?Deferred} deferred\n * @param {function(this:Promise,*=,function(*=),function(*=),Deferred):!Promise} state\n * @param {*=} value\n */\nfunction deferredAdopt(deferred, state, value) {\n  if (deferred) {\n    var promise = deferred.promise;\n    promise._state = state;\n    promise._value = value;\n  }\n}\n\n/**\n * A no-op function to prevent double resolving.\n */\nfunction noop() {}\n\n/**\n * Tests if fn is a Function\n *\n * @param {*} fn\n * @returns {boolean}\n */\nfunction isFunction(fn) {\n  return typeof fn === 'function';\n}\n\n/**\n * Tests if fn is an Object\n *\n * @param {*} obj\n * @returns {boolean}\n */\nfunction isObject(obj) {\n  return obj === Object(obj);\n}\n\n/**\n * Iterates over each element of an array, calling the iterator with the\n * element and its index.\n *\n * @param {!Array} collection\n * @param {function(*=,number)} iterator\n */\nfunction each(collection, iterator) {\n  for (var i = 0; i < collection.length; i++) {\n    iterator(collection[i], i);\n  }\n}\n\n/**\n * Creates a function that will attempt to resolve the deferred with the return\n * of fn. If any error is raised, rejects instead.\n *\n * @param {!Deferred} deferred\n * @param {function(*=)} fn\n * @param {*} arg\n * @returns {function()}\n */\nfunction tryCatchDeferred(deferred, fn, arg) {\n  var promise = deferred.promise;\n  var resolve = deferred.resolve;\n  var reject = deferred.reject;\n  return function() {\n    try {\n      var result = fn(arg);\n      doResolve(promise, resolve, reject, result, result);\n    } catch (e) {\n      reject(e);\n    }\n  };\n}\n\n/**\n * Queues and executes multiple deferred functions on another run loop.\n */\nvar defer = (function() {\n  /**\n   * Defers fn to another run loop.\n   */\n  var scheduleFlush;\n  if (typeof window !== 'undefined' && window.postMessage) {\n    window.addEventListener('message', flush);\n    scheduleFlush = function() {\n      window.postMessage('macro-task', '*');\n    };\n  } else {\n    scheduleFlush = function() {\n      setTimeout(flush, 0);\n    };\n  }\n\n  var queue = new Array(16);\n  var length = 0;\n\n  function flush() {\n    for (var i = 0; i < length; i++) {\n      var fn = queue[i];\n      queue[i] = null;\n      fn();\n    }\n    length = 0;\n  }\n\n  /**\n   * @param {function()} fn\n   */\n  function defer(fn) {\n    if (length === 0) { scheduleFlush(); }\n    queue[length++] = fn;\n  }\n\n  return defer;\n})();\n\n/**\n * The Promise resolution procedure.\n * https://github.com/promises-aplus/promises-spec#the-promise-resolution-procedure\n *\n * @param {!Promise} promise\n * @param {function(*=)} resolve\n * @param {function(*=)} reject\n * @param {*} value\n * @param {*=} context\n */\nfunction doResolve(promise, resolve, reject, value, context) {\n  var _reject = reject;\n  var then;\n  var _resolve;\n  try {\n    if (value === promise) {\n      throw new TypeError('Cannot fulfill promise with itself');\n    }\n    var isObj = isObject(value);\n    if (isObj && value instanceof promise.constructor) {\n      adopt(promise, value._state, value._value, value);\n    } else if (isObj && (then = value.then) && isFunction(then)) {\n      _resolve = function(value) {\n        _resolve = _reject = noop;\n        doResolve(promise, resolve, reject, value, value);\n      };\n      _reject = function(reason) {\n        _resolve = _reject = noop;\n        reject(reason);\n      };\n      then.call(\n        context,\n        function(value) { _resolve(value); },\n        function(reason) { _reject(reason); }\n      );\n    } else {\n      resolve(value);\n    }\n  } catch (e) {\n    _reject(e);\n  }\n}\n\nexport default Promise;\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport Promise from 'promise-pjs';\n\n/**\n * Sets the Promise polyfill if it does not exist.\n * @param {!Window} win\n */\nexport function install(win) {\n  if (!win.Promise) {\n    win.Promise = Promise;\n    // In babel the * export is an Object with a default property.\n    // In closure compiler it is the Promise function itself.\n    if (Promise.default) {\n      win.Promise = Promise.default;\n    }\n    // We copy the individual static methods, because closure\n    // compiler flattens the polyfill namespace.\n    win.Promise.resolve = Promise.resolve;\n    win.Promise.reject = Promise.reject;\n    win.Promise.all = Promise.all;\n    win.Promise.race = Promise.race;\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview\n * See https://developer.mozilla.org/en-US/docs/Web/API/ResizeObserver\n *\n * This is the stub to support ResizeObserver. It's installed from\n * polyfills/resize-observer.js and upgraded from the\n * amp-resize-observer-polyfill extension.\n */\n\n/** @typedef {function(!typeof ResizeObserver)} */\nlet ResObsUpgraderDef;\n\nconst UPGRADERS = '_upgraders';\nconst STUB = '_stub';\n\n/**\n * @param {!Window} win\n * @return {boolean}\n * @visibleForTesting\n */\nexport function shouldLoadPolyfill(win) {\n  return !win.ResizeObserver || !!win.ResizeObserver[STUB];\n}\n\n/**\n * Installs the ResOb stubs.\n *\n * @param {!Window} win\n */\nexport function installStub(win) {\n  if (win.ResizeObserver) {\n    return;\n  }\n\n  win.ResizeObserver = ResizeObserverStub;\n  win.ResizeObserver[STUB] = ResizeObserverStub;\n}\n\n/**\n * @param {!Window} win\n * @param {function()} installer\n */\nexport function upgradePolyfill(win, installer) {\n  // Can't use the ResizeObserverStub here directly since it's a separate\n  // instance deployed in v0.js vs the polyfill extension.\n  const Stub = win.ResizeObserver[STUB];\n  if (Stub) {\n    delete win.ResizeObserver;\n    delete win.ResizeObserverEntry;\n    installer();\n\n    const Polyfill = win.ResizeObserver;\n    /** @type {!Array<ResObsUpgraderDef>} */\n    const upgraders = Stub[UPGRADERS].slice(0);\n    const microtask = Promise.resolve();\n    const upgrade = (upgrader) => {\n      microtask.then(() => upgrader(Polyfill));\n    };\n    for (const upgrader of upgraders) {\n      upgrade(upgrader);\n    }\n    Stub[UPGRADERS] = {'push': upgrade};\n  } else {\n    // Even if this is not the stub, we still may need to install the polyfill.\n    // See `shouldLoadPolyfill` for more info.\n    installer();\n  }\n}\n\n/**\n * The stub for `ResizeObserver`. Implements the same interface, but\n * keeps the tracked elements in memory until the actual polyfill arives.\n * This stub is necessary because the polyfill itself is significantly bigger.\n * It doesn't technically extend ResizeObserver, but this allows the stub\n * to be seen as equivalent when typechecking calls expecting a ResizeObserver.\n * @extends ResizeObserver\n */\nexport class ResizeObserverStub {\n  /** @param {!ResizeObserverCallback} callback */\n  constructor(callback) {\n    /** @private @const {!ResizeObserverCallback} */\n    this.callback_ = callback;\n\n    /** @private {!Array<!Element>} */\n    this.elements_ = [];\n\n    /** @private {?ResizeObserver} */\n    this.inst_ = null;\n\n    // Wait for the upgrade.\n    ResizeObserverStub[UPGRADERS].push(this.upgrade_.bind(this));\n  }\n\n  /** @return {undefined} */\n  disconnect() {\n    if (this.inst_) {\n      this.inst_.disconnect();\n    } else {\n      this.elements_.length = 0;\n    }\n  }\n\n  /** @param {!Element} target */\n  observe(target) {\n    if (this.inst_) {\n      this.inst_.observe(target);\n    } else {\n      if (this.elements_.indexOf(target) == -1) {\n        this.elements_.push(target);\n      }\n    }\n  }\n\n  /** @param {!Element} target */\n  unobserve(target) {\n    if (this.inst_) {\n      this.inst_.unobserve(target);\n    } else {\n      const index = this.elements_.indexOf(target);\n      if (index != -1) {\n        this.elements_.splice(index, 1);\n      }\n    }\n  }\n\n  /**\n   * @param {!typeof ResizeObserver} Ctor\n   * @private\n   */\n  upgrade_(Ctor) {\n    const inst = new Ctor(this.callback_);\n    this.inst_ = inst;\n    for (const e of this.elements_) {\n      inst.observe(e);\n    }\n    this.elements_.length = 0;\n  }\n}\n\n/** @type {!Array<!ResObsUpgraderDef>} */\nResizeObserverStub[UPGRADERS] = [];\n\n/** @visibleForTesting */\nexport function resetStubsForTesting() {\n  ResizeObserverStub[UPGRADERS] = [];\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview\n * See https://developer.mozilla.org/en-US/docs/Web/API/ResizeObserver\n */\n\nimport {installStub, shouldLoadPolyfill} from './stubs/resize-observer-stub';\n\n/**\n * Installs the ResizeObserver polyfill. There are a few different modes of\n * operation.\n *\n * @param {!Window} win\n */\nexport function install(win) {\n  if (shouldLoadPolyfill(win)) {\n    installStub(win);\n  }\n}\n\n/**\n * @param {!Window} parentWin\n * @param {!Window} childWin\n */\nexport function installForChildWin(parentWin, childWin) {\n  if (!childWin.ResizeObserver && parentWin.ResizeObserver) {\n    Object.defineProperties(childWin, {\n      ResizeObserver: {get: () => parentWin.ResizeObserver},\n      ResizeObserverEntry: {get: () => parentWin.ResizeObserverEntry},\n    });\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Forces the return value from Set.prototype.add to always be the set\n * instance. IE11 returns undefined.\n *\n * @param {!Window} win\n */\nexport function install(win) {\n  const {Set} = win;\n  const s = new Set();\n  if (s.add(0) !== s) {\n    const {add} = s;\n\n    win.Object.defineProperty(Set.prototype, 'add', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: function () {\n        add.apply(this, arguments);\n        return this;\n      },\n    });\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Return true if string begins with the characters of the specified string.\n * Polyfill copied from MDN: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string/startsWith\n *\n * @param {string} search\n * @param {number=} rawPos\n * @return {boolean}\n * @this {string}\n */\nfunction startsWith(search, rawPos) {\n  const pos = rawPos > 0 ? rawPos | 0 : 0;\n  // eslint-disable-next-line local/no-invalid-this\n  return this.substr(pos, search.length) === search;\n}\n\n/**\n * Sets the String.startsWith polyfill if it does not exist.\n * @param {!Window} win\n */\nexport function install(win) {\n  if (!win.String.prototype.startsWith) {\n    win.Object.defineProperty(win.String.prototype, 'startsWith', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: startsWith,\n    });\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Forces the return value from WeakMap.prototype.set to always be the map\n * instance. IE11 returns undefined.\n *\n * @param {!Window} win\n */\nexport function install(win) {\n  const {WeakMap} = win;\n  const m = new WeakMap();\n  if (m.set({}, 0) !== m) {\n    const {set} = m;\n\n    win.Object.defineProperty(WeakMap.prototype, 'set', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: function () {\n        set.apply(this, arguments);\n        return this;\n      },\n    });\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @fileoverview Installs polyfills depending on build environment. */\n\nimport {install as installAbortController} from './abort-controller';\nimport {install as installArrayIncludes} from './array-includes';\nimport {install as installCustomElements} from './custom-elements';\nimport {install as installDOMTokenList} from './domtokenlist';\nimport {install as installDocContains} from './document-contains';\nimport {install as installFetch} from './fetch';\nimport {install as installGetBoundingClientRect} from './get-bounding-client-rect';\nimport {install as installIntersectionObserver} from './intersection-observer';\nimport {install as installMapSet} from './map-set';\nimport {install as installMathSign} from './math-sign';\nimport {install as installObjectAssign} from './object-assign';\nimport {install as installObjectValues} from './object-values';\nimport {install as installPromise} from './promise';\nimport {install as installResizeObserver} from './resize-observer';\nimport {install as installSetAdd} from './set-add';\nimport {install as installStringStartsWith} from './string-starts-with';\nimport {install as installWeakMapSet} from './weakmap-set';\n\nif (!IS_ESM) {\n  installFetch(self);\n  installMathSign(self);\n  installObjectAssign(self);\n  installObjectValues(self);\n  installPromise(self);\n  installArrayIncludes(self);\n  installMapSet(self);\n  installWeakMapSet(self);\n  installSetAdd(self);\n  installStringStartsWith(self);\n}\n\n// Polyfills that depend on DOM availability\nif (self.document) {\n  if (!IS_ESM) {\n    installDOMTokenList(self);\n    installDocContains(self);\n    installGetBoundingClientRect(self);\n  }\n  // The anonymous class parameter allows us to detect native classes vs\n  // transpiled classes.\n  if (!IS_SXG) {\n    installCustomElements(self, class {});\n    installIntersectionObserver(self);\n    installResizeObserver(self);\n    installAbortController(self);\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Registration and getter functions for AMP services.\n *\n * Invariant: Service getters never return null for registered services.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {dev, devAssert} from './log';\nimport {toWin} from './core/window';\n\n/**\n * Holds info about a service.\n * - obj: Actual service implementation when available.\n * - promise: Promise for the obj.\n * - resolve: Function to resolve the promise with the object.\n * - context: Argument for ctor, either a window or an ampdoc.\n * - ctor: Function that constructs and returns the service.\n * @typedef {{\n *   obj: (?Object),\n *   promise: (?Promise),\n *   resolve: (?function(!Object)),\n *   reject: (?function((*))),\n *   context: (?Window|?./service/ampdoc-impl.AmpDoc),\n *   ctor: (function(new:Object, !Window)|\n *          function(new:Object, !./service/ampdoc-impl.AmpDoc)),\n * }}\n */\nlet ServiceHolderDef;\n\n/**\n * This interface provides a `dispose` method that will be called by\n * runtime when a service needs to be disposed of.\n * @interface\n */\nexport class Disposable {\n  /**\n   * Instructs the service to release any resources it might be holding. Can\n   * be called only once in the lifecycle of a service.\n   */\n  dispose() {}\n}\n\n/**\n * Installs a service override on amp-doc level.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n * @param {!Object} service The service.\n */\nexport function installServiceInEmbedDoc(ampdoc, id, service) {\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    function () {\n      return service;\n    },\n    /* override */ true\n  );\n}\n\n/**\n * Installs a service override in the scope of an embedded window.\n * @param {!Window} embedWin\n * @param {string} id\n * @param {function(new:Object, !Window)} constructor\n */\nexport function registerServiceBuilderInEmbedWin(embedWin, id, constructor) {\n  registerServiceInternal(\n    embedWin,\n    embedWin,\n    id,\n    constructor,\n    /* override */ true\n  );\n}\n\n/**\n * Registers a service given a class to be used as implementation.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {function(new:Object, !Window)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilder(win, id, constructor, opt_instantiate) {\n  win = getTopWindow(win);\n  registerServiceInternal(win, win, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(win, id);\n  }\n}\n\n/**\n * Returns a service and registers it given a class to be used as\n * implementation.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id of the service.\n * @param {function(new:Object, !./service/ampdoc-impl.AmpDoc)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilderForDoc(\n  nodeOrDoc,\n  id,\n  constructor,\n  opt_instantiate\n) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  registerServiceInternal(holder, ampdoc, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * Reject a service promise.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id\n * @param {*} error\n */\nexport function rejectServicePromiseForDoc(nodeOrDoc, id, error) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  rejectServicePromiseInternal(holder, id, error);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). Users\n * should typically wrap this as a special purpose function (e.g.\n * `Services.vsyncFor(win)`) for type safety and because the factory should not\n * be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getService(win, id) {\n  win = getTopWindow(win);\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). But\n * it looks in the immediate window scope, not the top-level window.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getServiceInEmbedWin(win, id) {\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. `Services.vsyncFor(win)`) for type safety and because the\n * factory should not be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nexport function getServicePromise(win, id) {\n  return getServicePromiseInternal(win, id);\n}\n\n/**\n * Returns a service or null with the given id.\n * @param {!Window} win\n * @param {string} id\n * @return {?Object} The service.\n */\nexport function getExistingServiceOrNull(win, id) {\n  win = getTopWindow(win);\n  if (isServiceRegistered(win, id)) {\n    return getServiceInternal(win, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Like getServicePromise but returns null if the service was never registered.\n * @param {!Window} win\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNull(win, id) {\n  return getServicePromiseOrNullInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * Expects service `id` to be registered.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {T}\n * @template T\n */\nexport function getServiceForDoc(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  return getServiceInternal(holder, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * If service `id` is not registered, returns null.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Object}\n */\nexport function getServiceForDocOrNull(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  if (isServiceRegistered(holder, id)) {\n    return getServiceInternal(holder, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Returns a promise for a service for the given id and ampdoc. Also expects\n * a service that has the actual implementation. The promise resolves when\n * the implementation loaded.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {!Promise<!Object>}\n */\nexport function getServicePromiseForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseInternal(getAmpdocServiceHolder(elementOrAmpDoc), id);\n}\n\n/**\n * Like getServicePromiseForDoc but returns null if the service was never\n * registered for this ampdoc.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNullForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseOrNullInternal(\n    getAmpdocServiceHolder(elementOrAmpDoc),\n    id\n  );\n}\n\n/**\n * Set the parent and top windows on a child window (friendly iframe).\n * @param {!Window} win\n * @param {!Window} parentWin\n */\nexport function setParentWindow(win, parentWin) {\n  win.__AMP_PARENT = parentWin;\n  win.__AMP_TOP = getTopWindow(parentWin);\n}\n\n/**\n * Returns the parent window for a child window (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getParentWindow(win) {\n  return win.__AMP_PARENT || win;\n}\n\n/**\n * Returns the top window where AMP Runtime is installed for a child window\n * (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getTopWindow(win) {\n  return win.__AMP_TOP || (win.__AMP_TOP = win);\n}\n\n/**\n * Returns the parent \"friendly\" iframe if the node belongs to a child window.\n * @param {!Node} node\n * @param {!Window=} opt_topWin\n * @return {?HTMLIFrameElement}\n */\nexport function getParentWindowFrameElement(node, opt_topWin) {\n  const childWin = (node.ownerDocument || node).defaultView;\n  const topWin = opt_topWin || getTopWindow(childWin);\n  if (childWin && childWin != topWin && getTopWindow(childWin) == topWin) {\n    try {\n      return /** @type {?HTMLIFrameElement} */ (childWin.frameElement);\n    } catch (e) {\n      // Ignore the error.\n    }\n  }\n  return null;\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc}\n */\nexport function getAmpdoc(nodeOrDoc) {\n  if (nodeOrDoc.nodeType) {\n    const win = toWin(\n      /** @type {!Document} */ (nodeOrDoc.ownerDocument || nodeOrDoc)\n        .defaultView\n    );\n    return getAmpdocService(win).getAmpDoc(/** @type {!Node} */ (nodeOrDoc));\n  }\n  return /** @type {!./service/ampdoc-impl.AmpDoc} */ (nodeOrDoc);\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc|!Window}\n */\nfunction getAmpdocServiceHolder(nodeOrDoc) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  return ampdoc.isSingleDoc() ? ampdoc.win : ampdoc;\n}\n\n/**\n * This is essentially a duplicate of `ampdoc.js`, but necessary to avoid\n * circular dependencies.\n * @param {!Window} win\n * @return {!./service/ampdoc-impl.AmpDocService}\n */\nfunction getAmpdocService(win) {\n  return /** @type {!./service/ampdoc-impl.AmpDocService} */ (\n    getService(win, 'ampdoc')\n  );\n}\n\n/**\n * Get service `id` from `holder`. Assumes the service\n * has already been registered.\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {Object}\n */\nfunction getServiceInternal(holder, id) {\n  devAssert(\n    isServiceRegistered(holder, id),\n    `Expected service ${id} to be registered`\n  );\n  const services = getServices(holder);\n  const s = services[id];\n  if (!s.obj) {\n    devAssert(s.ctor, `Service ${id} registered without ctor nor impl.`);\n    devAssert(s.context, `Service ${id} registered without context.`);\n    s.obj = new s.ctor(s.context);\n    devAssert(s.obj, `Service ${id} constructed to null.`);\n    s.context = null;\n    // The service may have been requested already, in which case we have a\n    // pending promise we need to fulfill.\n    if (s.resolve) {\n      s.resolve(s.obj);\n    }\n  }\n  return s.obj;\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {!Window|!./service/ampdoc-impl.AmpDoc} context Win or AmpDoc.\n * @param {string} id of the service.\n * @param {?function(new:Object, !Window)|?function(new:Object, !./service/ampdoc-impl.AmpDoc)} ctor Constructor function to new the service. Called with context.\n * @param {boolean=} opt_override\n * @param {boolean=} opt_sharedInstance\n */\nfunction registerServiceInternal(\n  holder,\n  context,\n  id,\n  ctor,\n  opt_override,\n  opt_sharedInstance\n) {\n  const services = getServices(holder);\n  let s = services[id];\n\n  if (!s) {\n    s = services[id] = {\n      obj: null,\n      promise: null,\n      resolve: null,\n      reject: null,\n      context: null,\n      ctor: null,\n      sharedInstance: opt_sharedInstance || false,\n    };\n  }\n\n  if (!opt_override && s.ctor) {\n    // Service already registered.\n    return;\n  }\n\n  s.ctor = ctor;\n  s.context = context;\n  s.sharedInstance = opt_sharedInstance || false;\n\n  // The service may have been requested already, in which case there is a\n  // pending promise that needs to fulfilled.\n  if (s.resolve) {\n    // getServiceInternal will resolve the promise.\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nfunction getServicePromiseInternal(holder, id) {\n  const cached = getServicePromiseOrNullInternal(holder, id);\n  if (cached) {\n    return cached;\n  }\n  // Service is not registered.\n\n  // TODO(@cramforce): Add a check that if the element is eventually registered\n  // that the service is actually provided and this promise resolves.\n  const services = getServices(holder);\n  services[id] = emptyServiceHolderWithPromise();\n  return /** @type {!Promise<!Object>} */ (services[id].promise);\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @param {*} error\n */\nfunction rejectServicePromiseInternal(holder, id, error) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.reject) {\n      s.reject(error);\n    }\n    return;\n  }\n\n  services[id] = emptyServiceHolderWithPromise();\n  services[id].reject(error);\n}\n\n/**\n * Returns a promise for service `id` if the service has been registered\n * on `holder`.\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {?Promise<!Object>}\n */\nfunction getServicePromiseOrNullInternal(holder, id) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.promise) {\n      return s.promise;\n    } else {\n      // Instantiate service if not already instantiated.\n      getServiceInternal(holder, id);\n      return (s.promise = Promise.resolve(/** @type {!Object} */ (s.obj)));\n    }\n  }\n  return null;\n}\n\n/**\n * Returns the object that holds the services registered in a holder.\n * @param {!Object} holder\n * @return {!Object<string,!ServiceHolderDef>}\n */\nfunction getServices(holder) {\n  let services = holder.__AMP_SERVICES;\n  if (!services) {\n    services = holder.__AMP_SERVICES = {};\n  }\n  return services;\n}\n\n/**\n * Whether the specified service implements `Disposable` interface.\n * @param {!Object} service\n * @return {boolean}\n */\nexport function isDisposable(service) {\n  return typeof service.dispose == 'function';\n}\n\n/**\n * Asserts that the specified service implements `Disposable` interface and\n * typecasts the instance to `Disposable`.\n * @param {!Object} service\n * @return {!Disposable}\n */\nexport function assertDisposable(service) {\n  devAssert(isDisposable(service), 'required to implement Disposable');\n  return /** @type {!Disposable} */ (service);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * ampdoc scope.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function disposeServicesForDoc(ampdoc) {\n  disposeServicesInternal(ampdoc);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * embed scope.\n * @param {!Window} embedWin\n */\nexport function disposeServicesForEmbed(embedWin) {\n  disposeServicesInternal(embedWin);\n}\n\n/**\n * @param {!Object} holder Object holding the service instances.\n */\nfunction disposeServicesInternal(holder) {\n  const services = getServices(holder);\n  for (const id in services) {\n    if (!Object.prototype.hasOwnProperty.call(services, id)) {\n      continue;\n    }\n    const serviceHolder = services[id];\n    if (serviceHolder.sharedInstance) {\n      continue;\n    }\n    if (serviceHolder.obj) {\n      disposeServiceInternal(id, serviceHolder.obj);\n    } else if (serviceHolder.promise) {\n      serviceHolder.promise.then((instance) =>\n        disposeServiceInternal(id, instance)\n      );\n    }\n  }\n}\n\n/**\n * @param {string} id\n * @param {!Object} service\n */\nfunction disposeServiceInternal(id, service) {\n  if (!isDisposable(service)) {\n    return;\n  }\n  try {\n    assertDisposable(service).dispose();\n  } catch (e) {\n    // Ensure that a failure to dispose a service does not disrupt other\n    // services.\n    dev().error('SERVICE', 'failed to dispose service', id, e);\n  }\n}\n\n/**\n * This adopts the service **instance** from the parent.\n *\n * This function is dangerous! Sharing an instance means data can leak to and\n * from a child ampdoc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceForEmbedDoc(ampdoc, id) {\n  const service = getServiceInternal(\n    getAmpdocServiceHolder(devAssert(ampdoc.getParent())),\n    id\n  );\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    function () {\n      return service;\n    },\n    /* override */ false,\n    /* sharedInstance */ true\n  );\n}\n\n/**\n * This adopts the service **factory** from the parent.\n *\n * This function is safer than sharing the service instance, since each ampdoc\n * will create its own instance of the factory (and each instance will have its\n * own instance data). Note that static data is still shared, so it's not 100%\n * foolproof.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceFactoryForEmbedDoc(ampdoc, id) {\n  const parentHolder = getAmpdocServiceHolder(devAssert(ampdoc.getParent()));\n  devAssert(\n    isServiceRegistered(parentHolder, id),\n    `Expected service ${id} to be registered`\n  );\n  const service = getServices(parentHolder)[id];\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    devAssert(service.ctor)\n  );\n}\n\n/**\n * Resets a single service, so it gets recreated on next getService invocation.\n * @param {!Object} holder\n * @param {string} id of the service.\n */\nexport function resetServiceForTesting(holder, id) {\n  if (holder.__AMP_SERVICES) {\n    holder.__AMP_SERVICES[id] = null;\n  }\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {boolean}\n */\nfunction isServiceRegistered(holder, id) {\n  const service = holder.__AMP_SERVICES && holder.__AMP_SERVICES[id];\n  // All registered services must have a constructor.\n  return !!(service && service.ctor);\n}\n\n/** @return {!ServiceHolderDef} */\nfunction emptyServiceHolderWithPromise() {\n  const deferred = new Deferred();\n  const {promise, reject, resolve} = deferred;\n  promise.catch(() => {}); // avoid uncaught exception when service gets rejected\n  return {\n    obj: null,\n    promise,\n    resolve,\n    reject,\n    context: null,\n    ctor: null,\n  };\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from '../mode';\nimport {urls} from '../config';\n\nconst CUSTOM_TEMPLATES = ['amp-mustache'];\nconst LATEST_VERSION = 'latest';\n\n/**\n * Calculate the base url for any scripts.\n * @param {!Location} location The window's location\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateScriptBaseUrl(location, opt_isLocalDev) {\n  if (opt_isLocalDev) {\n    let prefix = `${location.protocol}//${location.host}`;\n    if (\n      location.protocol == 'about:' ||\n      location.protocol == 'blob:' ||\n      location.protocol == 'data:'\n    ) {\n      prefix = '';\n    }\n    return `${prefix}/dist`;\n  }\n  return urls.cdn;\n}\n\n/**\n * Calculate script url for an extension.\n * @param {!Location} location The window's location\n * @param {string} extensionId\n * @param {string} version\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateExtensionScriptUrl(\n  location,\n  extensionId,\n  version,\n  opt_isLocalDev\n) {\n  const fileExtension = getMode().esm ? '.mjs' : '.js';\n  const base = calculateScriptBaseUrl(location, opt_isLocalDev);\n  const rtv = getMode().rtvVersion;\n  const extensionVersion = version ? '-' + version : '';\n  return `${base}/rtv/${rtv}/v0/${extensionId}${extensionVersion}${fileExtension}`;\n}\n\n/**\n * Calculate script url for an entry point.\n * If `opt_rtv` is true, returns the URL matching the current RTV.\n * @param {!Location} location The window's location\n * @param {string} entryPoint\n * @param {boolean=} isLocalDev\n * @param {boolean=} opt_rtv\n * @return {string}\n */\nexport function calculateEntryPointScriptUrl(\n  location,\n  entryPoint,\n  isLocalDev,\n  opt_rtv\n) {\n  const fileExtension = getMode().esm ? '.mjs' : '.js';\n  const base = calculateScriptBaseUrl(location, isLocalDev);\n  if (isLocalDev) {\n    return `${base}/${entryPoint}${fileExtension}`;\n  }\n  if (opt_rtv) {\n    return `${base}/rtv/${getMode().rtvVersion}/${entryPoint}${fileExtension}`;\n  }\n  return `${base}/${entryPoint}${fileExtension}`;\n}\n\n/**\n * Parse the extension version from a given script URL.\n * @param {string} scriptUrl\n * @return {?{extensionId: string, extensionVersion: string}}\n */\nexport function parseExtensionUrl(scriptUrl) {\n  if (!scriptUrl) {\n    return null;\n  }\n  // Note that the \"(\\.max)?\" group only applies to local dev.\n  const matches = scriptUrl.match(\n    /^(.*)\\/(.*)-([0-9.]+|latest)(\\.max)?\\.(?:js|mjs)$/i\n  );\n  const extensionId = matches ? matches[2] : undefined;\n  const extensionVersion = matches ? matches[3] : undefined;\n  if (!extensionId || !extensionVersion) {\n    return null;\n  }\n  return {extensionId, extensionVersion};\n}\n\n/**\n * Create the missing amp extension HTML script element.\n * @param {!Window} win\n * @param {string} extensionId\n * @param {string} version\n * @return {!Element} Script object\n */\nexport function createExtensionScript(win, extensionId, version) {\n  const scriptElement = win.document.createElement('script');\n  scriptElement.async = true;\n  if (isIntermediateExtension(extensionId)) {\n    version = '';\n  } else {\n    scriptElement.setAttribute(\n      CUSTOM_TEMPLATES.indexOf(extensionId) >= 0\n        ? 'custom-template'\n        : 'custom-element',\n      extensionId\n    );\n  }\n  scriptElement.setAttribute('data-script', extensionId);\n  scriptElement.setAttribute('i-amphtml-inserted', '');\n  if (getMode().esm) {\n    scriptElement.setAttribute('type', 'module');\n  }\n\n  // Propagate nonce to all generated script tags.\n  const currentScript = win.document.head.querySelector('script[nonce]');\n  if (currentScript) {\n    scriptElement.setAttribute('nonce', currentScript.getAttribute('nonce'));\n  }\n\n  // Allow error information to be collected\n  // https://github.com/ampproject/amphtml/issues/7353\n  scriptElement.setAttribute('crossorigin', 'anonymous');\n  let loc = win.location;\n  if (getMode(win).test && win.testLocation) {\n    loc = win.testLocation;\n  }\n  const scriptSrc = calculateExtensionScriptUrl(\n    loc,\n    extensionId,\n    version,\n    getMode(win).localDev\n  );\n  scriptElement.src = scriptSrc;\n  return scriptElement;\n}\n\n/**\n * Returns the extension <script> element and attribute for the given\n * extension ID, if it exists. Otherwise, returns null.\n * @param {!Window} win\n * @param {string} extensionId\n * @param {string} version\n * @param {boolean} latest\n * @param {boolean=} includeInserted If true, includes script elements that\n *   are inserted by the runtime dynamically. Default is true.\n * @return {!Array<!Element>}\n */\nexport function getExtensionScripts(\n  win,\n  extensionId,\n  version,\n  latest,\n  includeInserted = true\n) {\n  // Always ignore <script> elements that have a mismatched RTV.\n  const modifier =\n    ':not([i-amphtml-loaded-new-version])' +\n    (includeInserted ? '' : ':not([i-amphtml-inserted])');\n  // We have to match against \"src\" because a few extensions, such as\n  // \"amp-viewer-integration\", do not have \"custom-element\" attribute.\n  const matches = win.document.head./*OK*/ querySelectorAll(\n    `script[src*=\"/${extensionId}-\"]${modifier}`\n  );\n  const filtered = [];\n  for (let i = 0; i < matches.length; i++) {\n    const match = matches[i];\n    const urlParts = parseExtensionUrl(match.src);\n    if (!urlParts) {\n      continue;\n    }\n    const {\n      extensionId: scriptExtensionId,\n      extensionVersion: scriptExtensionVersion,\n    } = urlParts;\n    if (\n      scriptExtensionId == extensionId &&\n      (isIntermediateExtension(extensionId) ||\n        scriptExtensionVersion == version ||\n        (scriptExtensionVersion == LATEST_VERSION && latest))\n    ) {\n      filtered.push(match);\n    }\n  }\n  return filtered;\n}\n\n/**\n * Get list of all the extension JS files.\n * @param {HTMLHeadElement|Element|ShadowRoot|Document} head\n * @return {!Array<{extensionId: string, extensionVersion: string}>}\n */\nexport function extensionScriptsInNode(head) {\n  // ampdoc.getHeadNode() can return null.\n  if (!head) {\n    return [];\n  }\n  // Note: Some extensions don't have [custom-element] or [custom-template]\n  // e.g. amp-viewer-integration.\n  const list = head.querySelectorAll(\n    'script[custom-element],script[custom-template]'\n  );\n  const scripts = [];\n  for (let i = 0; i < list.length; i++) {\n    const script = list[i];\n    const extensionId =\n      script.getAttribute('custom-element') ||\n      script.getAttribute('custom-template');\n    const urlParts = parseExtensionUrl(script.src);\n    if (extensionId && urlParts) {\n      scripts.push({extensionId, extensionVersion: urlParts.extensionVersion});\n    }\n  }\n  return scripts;\n}\n\n/**\n * Verifies that an extension script is present in head for\n * installation.\n * @param {!Window} win\n * @param {string} id\n * @param {string} version\n * @return {boolean}\n */\nexport function extensionScriptInNode(win, id, version) {\n  return extensionScriptsInNode(win.document.head).some(\n    ({extensionId, extensionVersion}) =>\n      id == extensionId && version == extensionVersion\n  );\n}\n\n/**\n * @param {string} extensionId\n * @return {boolean}\n */\nfunction isIntermediateExtension(extensionId) {\n  return extensionId.startsWith('_');\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dom from './dom';\nimport {extensionScriptInNode} from './service/extension-script';\nimport {\n  getAmpdoc,\n  getService,\n  getServiceForDocOrNull,\n  getServicePromise,\n  getServicePromiseForDoc,\n  getServicePromiseOrNull,\n  getServicePromiseOrNullForDoc,\n} from './service';\nimport {userAssert} from './log';\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {string} version The extension version.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailable(\n  win,\n  id,\n  extension,\n  version,\n  opt_element\n) {\n  const s = getServicePromiseOrNull(win, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  return getElementServicePromiseOrNull(\n    win,\n    id,\n    extension,\n    version,\n    opt_element\n  );\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. Services.viewportForDoc(...)) for type safety and because the\n * factory should not be passed around.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an element,\n *     not the extension.\n * @return {!Promise<*>}\n */\nexport function getElementServiceForDoc(element, id, extension, opt_element) {\n  return getElementServiceIfAvailableForDoc(\n    element,\n    id,\n    extension,\n    opt_element\n  ).then((service) => assertService(service, id, extension));\n}\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDoc(\n  element,\n  id,\n  extension,\n  opt_element\n) {\n  const s = getServicePromiseOrNullForDoc(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  const ampdoc = getAmpdoc(element);\n  return ampdoc\n    .whenExtensionsKnown()\n    .then(() => {\n      const version = ampdoc.getExtensionVersion(extension);\n      if (!version) {\n        return null;\n      }\n      const extensions = getService(ampdoc.win, 'extensions');\n      return extensions.waitForExtension(extension, version);\n    })\n    .then((ext) => {\n      if (!ext) {\n        return null;\n      }\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNullForDoc(element, id);\n      }\n      return getServicePromiseForDoc(element, id);\n    });\n}\n\n/**\n * Returns a promise for service for the given id in the embed scope of\n * a given element, if it exists. Falls back to ampdoc scope if the element\n * is not embedded.\n *\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDocInEmbedScope(\n  element,\n  id,\n  extension\n) {\n  const s = getServiceForDocOrNull(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (Promise.resolve(s));\n  }\n  return getElementServiceIfAvailableForDoc(element, id, extension);\n}\n\n/**\n * Throws user error if `service` is null.\n * @param {Object} service\n * @param {string} id\n * @param {string} extension\n * @return {!Object}\n * @private\n * @closurePrimitive {asserts.matchesReturn}\n */\nfunction assertService(service, id, extension) {\n  return /** @type {!Object} */ (\n    userAssert(\n      service,\n      'Service %s was requested to be provided through %s, ' +\n        'but %s is not loaded in the current page. To fix this ' +\n        'problem load the JavaScript file for %s in this page.',\n      id,\n      extension,\n      extension,\n      extension\n    )\n  );\n}\n\n/**\n * Returns the promise for service with `id` on the given window if available.\n * Otherwise, resolves with null (service was not registered).\n * @param {!Window} win\n * @param {string} id\n * @param {string} extension\n * @param {string} version\n * @param {boolean=} opt_element\n * @return {!Promise<Object>}\n * @private\n */\nfunction getElementServicePromiseOrNull(\n  win,\n  id,\n  extension,\n  version,\n  opt_element\n) {\n  return dom\n    .waitForBodyOpenPromise(win.document)\n    .then(() => {\n      // If there is an extension script wait for it to load before trying\n      // to get the service. Prevents a race condition when everything but\n      // the extensions is in cache. If there is no script then it's either\n      // not present, or the service was defined by a test. In those cases\n      // we don't wait around for an extension that does not exist.\n      const extensions = getService(win, 'extensions');\n\n      // TODO(jpettitt) investigate registerExtension to short circuit\n      // the dom call in extensionScriptsInNode()\n      if (!extensionScriptInNode(extensions.win, extension, version)) {\n        return null;\n      }\n      return extensions.waitForExtension(extension, version);\n    })\n    .then((ext) => {\n      if (!ext) {\n        return null;\n      }\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNull(win, id);\n      }\n      return getServicePromise(win, id);\n    });\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  getAmpdoc,\n  getExistingServiceOrNull,\n  getService,\n  getServiceForDoc,\n  getServiceForDocOrNull,\n  getServiceInEmbedWin,\n  getServicePromiseForDoc,\n} from './service';\nimport {\n  getElementServiceForDoc,\n  getElementServiceIfAvailable,\n  getElementServiceIfAvailableForDoc,\n  getElementServiceIfAvailableForDocInEmbedScope,\n} from './element-service';\n\n/** @typedef {!../extensions/amp-subscriptions/0.1/amp-subscriptions.SubscriptionService} */\nexport let SubscriptionService;\n\nexport class Services {\n  /**\n   * Hint: Add extensions folder path to compile.js with\n   * warnings cannot find modules.\n   */\n\n  /**\n   * Returns a promise for the Access service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>} */ (\n      getElementServiceForDoc(element, 'access', 'amp-access')\n    );\n  }\n\n  /**\n   * Returns a promise for the Access service or a promise for null if the\n   * service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>} */ (\n      getElementServiceIfAvailableForDoc(element, 'access', 'amp-access')\n    );\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!SubscriptionService>}\n   */\n  static subscriptionsServiceForDoc(element) {\n    return /** @type {!Promise<!SubscriptionService>} */ (\n      getElementServiceForDoc(element, 'subscriptions', 'amp-subscriptions')\n    );\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?SubscriptionService>}\n   */\n  static subscriptionsServiceForDocOrNull(element) {\n    return /** @type {!Promise<?SubscriptionService>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'subscriptions',\n        'amp-subscriptions'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/action-impl.ActionService}\n   */\n  static actionServiceForDoc(element) {\n    return /** @type {!./service/action-impl.ActionService} */ (\n      getServiceForDocOrNull(element, 'action')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/standard-actions-impl.StandardActions}\n   */\n  static standardActionsForDoc(element) {\n    return /** @type {!./service/standard-actions-impl.StandardActions} */ (\n      getServiceForDocOrNull(element, 'standard-actions')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>}\n   */\n  static activityForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>} */ (\n      getElementServiceForDoc(element, 'activity', 'amp-analytics')\n    );\n  }\n\n  /**\n   * Returns the global instance of the `AmpDocService` service that can be\n   * used to resolve an ampdoc for any node: either in the single-doc or\n   * shadow-doc environment.\n   * @param {!Window} window\n   * @return {!./service/ampdoc-impl.AmpDocService}\n   */\n  static ampdocServiceFor(window) {\n    return /** @type {!./service/ampdoc-impl.AmpDocService} */ (\n      getService(window, 'ampdoc')\n    );\n  }\n\n  /**\n   * Returns the AmpDoc for the specified context node.\n   * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrAmpDoc\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   */\n  static ampdoc(nodeOrAmpDoc) {\n    return getAmpdoc(nodeOrAmpDoc);\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @param {boolean=} loadAnalytics\n   * @return {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDoc(element, loadAnalytics = false) {\n    if (loadAnalytics) {\n      // Get Extensions service and force load analytics extension.\n      const ampdoc = getAmpdoc(element);\n      Services.extensionsFor(ampdoc.win)./*OK*/ installExtensionForDoc(\n        ampdoc,\n        'amp-analytics'\n      );\n    }\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (\n      getElementServiceForDoc(\n        element,\n        'amp-analytics-instrumentation',\n        'amp-analytics'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'amp-analytics-instrumentation',\n        'amp-analytics'\n      )\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/batched-xhr-impl.BatchedXhr}\n   */\n  static batchedXhrFor(window) {\n    return /** @type {!./service/batched-xhr-impl.BatchedXhr} */ (\n      getService(window, 'batched-xhr')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>}\n   */\n  static bindForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>} */ (\n      getElementServiceIfAvailableForDocInEmbedScope(\n        element,\n        'bind',\n        'amp-bind'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-script/0.1/amp-script.AmpScriptService>}\n   */\n  static scriptForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-script/0.1/amp-script.AmpScriptService>} */ (\n      getElementServiceIfAvailableForDocInEmbedScope(\n        element,\n        'amp-script',\n        'amp-script'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/cid-impl.CidDef>}\n   */\n  static cidForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/cid-impl.CidDef>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'cid')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/navigation.Navigation}\n   */\n  static navigationForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/navigation.Navigation} */ (\n      getServiceForDoc(elementOrAmpDoc, 'navigation')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>}\n   */\n  static loaderServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>} */ (\n      getElementServiceForDoc(element, 'loader', 'amp-loader')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>}\n   */\n  static standaloneServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>} */ (\n      getElementServiceForDoc(element, 'standalone', 'amp-standalone')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/crypto-impl.Crypto}\n   */\n  static cryptoFor(window) {\n    return /** @type {!./service/crypto-impl.Crypto} */ (\n      getService(window, 'crypto')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/document-info-impl.DocumentInfoDef} Info about the doc\n   */\n  static documentInfoForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/document-info-impl.DocInfo} */ (\n      getServiceForDoc(elementOrAmpDoc, 'documentInfo')\n    ).get();\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/extensions-impl.Extensions}\n   */\n  static extensionsFor(window) {\n    return /** @type {!./service/extensions-impl.Extensions} */ (\n      getService(window, 'extensions')\n    );\n  }\n\n  /**\n   * Returns a service to register callbacks we wish to execute when an\n   * amp-form is submitted.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>}\n   */\n  static formSubmitForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'form-submit-service')\n    );\n  }\n\n  /**\n   * Returns service to listen for `hidden` attribute mutations.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/hidden-observer-impl.HiddenObserver}\n   */\n  static hiddenObserverForDoc(element) {\n    return /** @type {!./service/hidden-observer-impl.HiddenObserver} */ (\n      getServiceForDocOrNull(element, 'hidden-observer')\n    );\n  }\n\n  /**\n   * Returns service implemented in service/history-impl.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/history-impl.History}\n   */\n  static historyForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/history-impl.History} */ (\n      getServiceForDoc(elementOrAmpDoc, 'history')\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {!./input.Input}\n   */\n  static inputFor(win) {\n    return getService(win, 'input');\n  }\n\n  /**s\n   * Returns a promise for the Inputmask service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>}\n   */\n  static inputmaskServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>} */ (\n      getElementServiceIfAvailableForDoc(element, 'inputmask', 'amp-inputmask')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {?./service/loading-indicator.LoadingIndicatorImpl}\n   */\n  static loadingIndicatorOrNull(elementOrAmpDoc) {\n    return /** @type {?./service/loading-indicator.LoadingIndicatorImpl} */ (\n      getServiceForDocOrNull(elementOrAmpDoc, 'loadingIndicator')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-next-page/1.0/service.NextPageService}\n   */\n  static nextPageServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-next-page/1.0/service.NextPageService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'next-page')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/mutator-interface.MutatorInterface}\n   */\n  static mutatorForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/mutator-interface.MutatorInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'mutator')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/owners-interface.OwnersInterface}\n   */\n  static ownersForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/owners-interface.OwnersInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'owners')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceFor(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (\n      getService(window, 'performance')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceForOrNull(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (\n      getExistingServiceOrNull(window, 'performance')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/platform-impl.Platform}\n   */\n  static platformFor(window) {\n    return /** @type {!./service/platform-impl.Platform} */ (\n      getService(window, 'platform')\n    );\n  }\n\n  /**\n   * Not installed by default; must be installed in extension code before use.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/position-observer/position-observer-impl.PositionObserver}\n   * @throws If the service is not installed.\n   */\n  static positionObserverForDoc(element) {\n    return /** @type {!./service/position-observer/position-observer-impl.PositionObserver} */ (\n      getServiceForDoc(element, 'position-observer')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./preconnect.PreconnectService}\n   */\n  static preconnectFor(window) {\n    return getService(window, 'preconnect');\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/resources-interface.ResourcesInterface}\n   */\n  static resourcesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/resources-interface.ResourcesInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'resources')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/resources-interface.ResourcesInterface>}\n   */\n  static resourcesPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/resources-interface.ResourcesInterface>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'resources')\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService>}\n   */\n  static storyVariableServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService>} */\n      (getElementServiceIfAvailable(win, 'story-variable', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService}\n   */\n  static storyVariableService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService} */\n      (getExistingServiceOrNull(win, 'story-variable'))\n    );\n  }\n\n  /**\n   * Version of the story store service depends on which version of amp-story\n   * the publisher is loading. They all have the same implementation.\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService>}\n   */\n  static storyStoreServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService>} */\n      (getElementServiceIfAvailable(win, 'story-store', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService}\n   */\n  static storyStoreService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService} */\n      (getExistingServiceOrNull(win, 'story-store'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService}\n   */\n  static storyMediaQueryService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService} */\n      (getExistingServiceOrNull(win, 'story-media-query'))\n    );\n  }\n\n  /**\n   * Get promise with story request service\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService>}\n   */\n  static storyRequestServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService>} */\n      (getElementServiceIfAvailable(win, 'story-request', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService}\n   */\n  static storyRequestService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService} */\n      (getExistingServiceOrNull(win, 'story-request'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService}\n   */\n  static mediaPerformanceMetricsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService} */\n      (getExistingServiceOrNull(win, 'media-performance-metrics'))\n    );\n  }\n\n  /**\n   * @param {!Element} el\n   * @return {!Promise<./service/localization.LocalizationService>}\n   */\n  static localizationServiceForOrNull(el) {\n    return /** @type {!Promise<?./service/localization.LocalizationService>} */ (\n      getServicePromiseForDoc(el, 'localization')\n    );\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {?./service/localization.LocalizationService}\n   */\n  static localizationForDoc(element) {\n    return /** @type {?./service/localization.LocalizationService} */ (\n      getServiceForDocOrNull(element, 'localization')\n    );\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>}\n   */\n  static storyAnalyticsServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>} */\n      (\n        getElementServiceIfAvailable(\n          win,\n          'story-analytics',\n          'amp-story',\n          '1.0',\n          true\n        )\n      )\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService}\n   */\n  static storyAnalyticsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService} */\n      (getExistingServiceOrNull(win, 'story-analytics'))\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>}\n   */\n  static webAnimationServiceFor(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>} */\n      (getElementServiceForDoc(element, 'web-animation', 'amp-animation'))\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/real-time-config/real-time-config-impl.RealTimeConfigManager>}\n   */\n  static realTimeConfigForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/real-time-config/real-time-config-impl.RealTimeConfigManager>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'real-time-config')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   */\n  static storageForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'storage')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   * TODO(dmanek): Add tests for this method.\n   */\n  static storageForTopLevelDoc(elementOrAmpDoc) {\n    const thisAmpdoc = Services.ampdoc(elementOrAmpDoc);\n    const ampdocService = Services.ampdocServiceFor(thisAmpdoc.win);\n    const topAmpdoc = ampdocService.isSingleDoc()\n      ? ampdocService.getSingleDoc()\n      : null;\n    // We need to verify that ampdocs are on the same origin, therefore\n    // we compare the windows of both.\n    const ampdoc =\n      topAmpdoc && topAmpdoc.win == thisAmpdoc.win ? topAmpdoc : thisAmpdoc;\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (\n      getServicePromiseForDoc(ampdoc, 'storage')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/template-impl.Templates}\n   */\n  static templatesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/template-impl.Templates} */ (\n      getServiceForDoc(elementOrAmpDoc, 'templates')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/timer-impl.Timer}\n   */\n  static timerFor(window) {\n    // TODO(alabiaga): This will always return the top window's Timer service.\n    return /** @type {!./service/timer-impl.Timer} */ (\n      getServiceInEmbedWin(window, 'timer')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-replacements-impl.UrlReplacements}\n   */\n  static urlReplacementsForDoc(element) {\n    return /** @type {!./service/url-replacements-impl.UrlReplacements} */ (\n      getServiceForDocOrNull(element, 'url-replace')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>}\n   */\n  static userNotificationManagerForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>} */\n      (\n        getElementServiceForDoc(\n          element,\n          'userNotificationManager',\n          'amp-user-notification'\n        )\n      )\n    );\n  }\n\n  /**\n   * Returns a promise for the consentPolicy Service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>}\n   */\n  static consentPolicyServiceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>} */\n      (\n        getElementServiceIfAvailableForDoc(\n          element,\n          'consentPolicyManager',\n          'amp-consent'\n        )\n      )\n    );\n  }\n\n  /**\n   * Returns a promise for the geo service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>}\n   */\n  static geoForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>} */ (\n      getElementServiceIfAvailableForDoc(element, 'geo', 'amp-geo', true)\n    );\n  }\n\n  /**\n   * Unlike most service getters, passing `Node` is necessary for some FIE-scope\n   * services since sometimes we only have the FIE Document for context.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-impl.Url}\n   */\n  static urlForDoc(element) {\n    return /** @type {!./service/url-impl.Url} */ (\n      getServiceForDocOrNull(element, 'url')\n    );\n  }\n\n  /**\n   * Returns a promise for the experiment variants or a promise for null if it\n   * is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>}\n   */\n  static variantsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'variant',\n        'amp-experiment',\n        true\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/video-manager-impl.VideoManager}\n   */\n  static videoManagerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/video-manager-impl.VideoManager} */ (\n      getServiceForDoc(elementOrAmpDoc, 'video-manager')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewer-interface.ViewerInterface}\n   */\n  static viewerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewer-interface.ViewerInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'viewer')\n    );\n  }\n\n  /**\n   * Returns promise for the viewer. This is an unusual case and necessary only\n   * for services that need reference to the viewer before it has been\n   * initialized. Most of the code, however, just should use `viewerForDoc`.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/viewer-interface.ViewerInterface>}\n   */\n  static viewerPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/viewer-interface.ViewerInterface>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'viewer')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/vsync-impl.Vsync}\n   */\n  static vsyncFor(window) {\n    return /** @type {!./service/vsync-impl.Vsync} */ (\n      getService(window, 'vsync')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewport/viewport-interface.ViewportInterface}\n   */\n  static viewportForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewport/viewport-interface.ViewportInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'viewport')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/xhr-impl.Xhr}\n   */\n  static xhrFor(window) {\n    return /** @type {!./service/xhr-impl.Xhr} */ (getService(window, 'xhr'));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-frame-service.AssistjsFrameService}\n   */\n  static assistjsFrameServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-frame-service.AssistjsFrameService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'assistjs-frame-service')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-config-service.AssistjsConfigService}\n   */\n  static assistjsConfigServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-config-service.AssistjsConfigService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'assistjs-config-service')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../amp-cache-url/amp-cache-url.AmpCacheUrlService>}\n   */\n  static cacheUrlServicePromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<?../amp-cache-url/amp-cache-url.AmpCacheUrlService>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'cache-url')\n    );\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * An interface to interact with browser window object.\n * Mainly used to mock out read only APIs in test.\n * See test-helper.js#mockWindowInterface\n */\nexport class WindowInterface {\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {!Window}\n   */\n  static getTop(win) {\n    return win.top;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {!Location}\n   */\n  static getLocation(win) {\n    return win.location;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getDocumentReferrer(win) {\n    return win.document.referrer;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getHostname(win) {\n    return win.location.hostname;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getUserAgent(win) {\n    return win.navigator.userAgent;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getUserLanguage(win) {\n    // The `navigator.userLanguage` is only supported by IE. The standard is\n    // the `navigator.language`.\n    return win.navigator['userLanguage'] || win.navigator.language;\n  }\n\n  /**\n   * @static\n   * @return {number}\n   */\n  static getDevicePixelRatio() {\n    // No matter the window, the device-pixel-ratio is always one.\n    return self.devicePixelRatio || 1;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {function(string,(ArrayBufferView|Blob|FormData|null|string)=):boolean|undefined}\n   */\n  static getSendBeacon(win) {\n    if (!win.navigator.sendBeacon) {\n      return undefined;\n    }\n    return win.navigator.sendBeacon.bind(win.navigator);\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {typeof XMLHttpRequest}\n   */\n  static getXMLHttpRequest(win) {\n    return win.XMLHttpRequest;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {typeof Image}\n   */\n  static getImage(win) {\n    return win.Image;\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {map} from '../types/object';\n\n/**\n * @template T\n */\nexport class LruCache {\n  /**\n   * @param {number} capacity\n   */\n  constructor(capacity) {\n    /** @private @const {number} */\n    this.capacity_ = capacity;\n\n    /** @private {number} */\n    this.size_ = 0;\n\n    /**\n     * An incrementing counter to define the last access.\n     * @private {number}\n     */\n    this.access_ = 0;\n\n    /** @private {!Object<(number|string), {payload: T, access: number}>} */\n    this.cache_ = map();\n  }\n\n  /**\n   * Returns whether key is cached.\n   *\n   * @param {number|string} key\n   * @return {boolean}\n   */\n  has(key) {\n    return !!this.cache_[key];\n  }\n\n  /**\n   * @param {number|string} key\n   * @return {T} The cached payload.\n   */\n  get(key) {\n    const cacheable = this.cache_[key];\n    if (cacheable) {\n      cacheable.access = ++this.access_;\n      return cacheable.payload;\n    }\n    return undefined;\n  }\n\n  /**\n   * @param {number|string} key\n   * @param {T} payload The payload to cache.\n   */\n  put(key, payload) {\n    if (!this.has(key)) {\n      this.size_++;\n    }\n    this.cache_[key] = {payload, access: this.access_};\n    this.evict_();\n  }\n\n  /**\n   * Evicts the oldest cache entry, if we've exceeded capacity.\n   */\n  evict_() {\n    if (this.size_ <= this.capacity_) {\n      return;\n    }\n\n    const cache = this.cache_;\n    let oldest = this.access_ + 1;\n    let oldestKey;\n    for (const key in cache) {\n      const {access} = cache[key];\n      if (access < oldest) {\n        oldest = access;\n        oldestKey = key;\n      }\n    }\n\n    if (oldestKey !== undefined) {\n      delete cache[oldestKey];\n      this.size_--;\n    }\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {LruCache} from './core/data-structures/lru-cache';\nimport {dict, hasOwn} from './core/types/object';\nimport {endsWith} from './core/types/string';\nimport {getMode} from './mode';\nimport {isArray} from './core/types';\nimport {parseQueryString} from './core/types/string/url';\nimport {urls} from './config';\nimport {userAssert} from './log';\n\n/**\n * @type {!JsonObject}\n */\nconst SERVING_TYPE_PREFIX = dict({\n  // No viewer\n  'c': true,\n  // In viewer\n  'v': true,\n  // Ad landing page\n  'a': true,\n  // Ad\n  'ad': true,\n});\n\n/**\n * Cached a-tag to avoid memory allocation during URL parsing.\n * @type {HTMLAnchorElement}\n */\nlet a;\n\n/**\n * We cached all parsed URLs. As of now there are no use cases\n * of AMP docs that would ever parse an actual large number of URLs,\n * but we often parse the same one over and over again.\n * @type {LruCache}\n */\nlet cache;\n\n/** @private @const Matches amp_js_* parameters in query string. */\nconst AMP_JS_PARAMS_REGEX = /[?&]amp_js[^&]*/;\n\n/** @private @const Matches amp_gsa parameters in query string. */\nconst AMP_GSA_PARAMS_REGEX = /[?&]amp_gsa[^&]*/;\n\n/** @private @const Matches amp_r parameters in query string. */\nconst AMP_R_PARAMS_REGEX = /[?&]amp_r[^&]*/;\n\n/** @private @const Matches amp_kit parameters in query string. */\nconst AMP_KIT_PARAMS_REGEX = /[?&]amp_kit[^&]*/;\n\n/** @private @const Matches usqp parameters from goog experiment in query string. */\nconst GOOGLE_EXPERIMENT_PARAMS_REGEX = /[?&]usqp[^&]*/;\n\nconst INVALID_PROTOCOLS = [\n  /*eslint no-script-url: 0*/ 'javascript:',\n  /*eslint no-script-url: 0*/ 'data:',\n  /*eslint no-script-url: 0*/ 'vbscript:',\n];\n\n/** @const {string} */\nexport const SOURCE_ORIGIN_PARAM = '__amp_source_origin';\n\n/**\n * Returns the correct origin for a given window.\n * @param {!Window} win\n * @return {string} origin\n */\nexport function getWinOrigin(win) {\n  return win.origin || parseUrlDeprecated(win.location.href).origin;\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {string} url\n * @param {boolean=} opt_nocache\n *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n * @return {!Location}\n */\nexport function parseUrlDeprecated(url, opt_nocache) {\n  if (!a) {\n    a = /** @type {!HTMLAnchorElement} */ (self.document.createElement('a'));\n    cache = IS_ESM\n      ? null\n      : self.__AMP_URL_CACHE || (self.__AMP_URL_CACHE = new LruCache(100));\n  }\n\n  return parseUrlWithA(a, url, IS_ESM || opt_nocache ? null : cache);\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {!HTMLAnchorElement} a\n * @param {string} url\n * @param {LruCache=} opt_cache\n *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n * @return {!Location}\n * @restricted\n */\nexport function parseUrlWithA(a, url, opt_cache) {\n  if (IS_ESM) {\n    a.href = '';\n    return /** @type {?} */ (new URL(url, a.href));\n  }\n\n  if (opt_cache && opt_cache.has(url)) {\n    return opt_cache.get(url);\n  }\n\n  a.href = url;\n\n  // IE11 doesn't provide full URL components when parsing relative URLs.\n  // Assigning to itself again does the trick #3449.\n  if (!a.protocol) {\n    a.href = a.href;\n  }\n\n  const info = /** @type {!Location} */ ({\n    href: a.href,\n    protocol: a.protocol,\n    host: a.host,\n    hostname: a.hostname,\n    port: a.port == '0' ? '' : a.port,\n    pathname: a.pathname,\n    search: a.search,\n    hash: a.hash,\n    origin: null, // Set below.\n  });\n\n  // Some IE11 specific polyfills.\n  // 1) IE11 strips out the leading '/' in the pathname.\n  if (info.pathname[0] !== '/') {\n    info.pathname = '/' + info.pathname;\n  }\n\n  // 2) For URLs with implicit ports, IE11 parses to default ports while\n  // other browsers leave the port field empty.\n  if (\n    (info.protocol == 'http:' && info.port == 80) ||\n    (info.protocol == 'https:' && info.port == 443)\n  ) {\n    info.port = '';\n    info.host = info.hostname;\n  }\n\n  // For data URI a.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n  let origin;\n  if (a.origin && a.origin != 'null') {\n    origin = a.origin;\n  } else if (info.protocol == 'data:' || !info.host) {\n    origin = info.href;\n  } else {\n    origin = info.protocol + '//' + info.host;\n  }\n  info.origin = origin;\n\n  // Freeze during testing to avoid accidental mutation.\n  const frozen = getMode().test && Object.freeze ? Object.freeze(info) : info;\n\n  if (opt_cache) {\n    opt_cache.put(url, frozen);\n  }\n\n  return frozen;\n}\n\n/**\n * Appends the string just before the fragment part (or optionally\n * to the front of the query string) of the URL.\n * @param {string} url\n * @param {string} paramString\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function appendEncodedParamStringToUrl(\n  url,\n  paramString,\n  opt_addToFront\n) {\n  if (!paramString) {\n    return url;\n  }\n  const mainAndFragment = url.split('#', 2);\n  const mainAndQuery = mainAndFragment[0].split('?', 2);\n\n  let newUrl =\n    mainAndQuery[0] +\n    (mainAndQuery[1]\n      ? opt_addToFront\n        ? `?${paramString}&${mainAndQuery[1]}`\n        : `?${mainAndQuery[1]}&${paramString}`\n      : `?${paramString}`);\n  newUrl += mainAndFragment[1] ? `#${mainAndFragment[1]}` : '';\n  return newUrl;\n}\n/**\n * Appends a query string field and value to a url. `key` and `value`\n * will be ran through `encodeURIComponent` before appending.\n * @param {string} url\n * @param {string} key\n * @param {string} value\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function addParamToUrl(url, key, value, opt_addToFront) {\n  const field = `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;\n  return appendEncodedParamStringToUrl(url, field, opt_addToFront);\n}\n\n/**\n * Appends query string fields and values to a url. The `params` objects'\n * `key`s and `value`s will be transformed into query string keys/values.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addParamsToUrl(url, params) {\n  return appendEncodedParamStringToUrl(url, serializeQueryString(params));\n}\n\n/**\n * Append query string fields and values to a url, only if the key does not\n * exist in current query string.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addMissingParamsToUrl(url, params) {\n  const location = parseUrlDeprecated(url);\n  const existingParams = parseQueryString(location.search);\n  const paramsToAdd = dict({});\n  const keys = Object.keys(params);\n  for (let i = 0; i < keys.length; i++) {\n    if (!hasOwn(existingParams, keys[i])) {\n      paramsToAdd[keys[i]] = params[keys[i]];\n    }\n  }\n  return addParamsToUrl(url, paramsToAdd);\n}\n\n/**\n * Serializes the passed parameter map into a query string with both keys\n * and values encoded.\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function serializeQueryString(params) {\n  const s = [];\n  for (const k in params) {\n    const v = params[k];\n    if (v == null) {\n      continue;\n    } else if (isArray(v)) {\n      for (let i = 0; i < v.length; i++) {\n        const sv = /** @type {string} */ (v[i]);\n        s.push(`${encodeURIComponent(k)}=${encodeURIComponent(sv)}`);\n      }\n    } else {\n      const sv = /** @type {string} */ (v);\n      s.push(`${encodeURIComponent(k)}=${encodeURIComponent(sv)}`);\n    }\n  }\n  return s.join('&');\n}\n\n/**\n * Returns `true` if the URL is secure: either HTTPS or localhost (for testing).\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isSecureUrlDeprecated(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return (\n    url.protocol == 'https:' ||\n    url.hostname == 'localhost' ||\n    url.hostname == '127.0.0.1' ||\n    endsWith(url.hostname, '.localhost')\n  );\n}\n\n/**\n * Asserts that a given url is HTTPS or protocol relative. It's a user-level\n * assert.\n *\n * Provides an exception for localhost.\n *\n * @param {?string|undefined} urlString\n * @param {!Element|string} elementContext Element where the url was found.\n * @param {string=} sourceName Used for error messages.\n * @return {string}\n */\nexport function assertHttpsUrl(\n  urlString,\n  elementContext,\n  sourceName = 'source'\n) {\n  userAssert(\n    urlString != null,\n    '%s %s must be available',\n    elementContext,\n    sourceName\n  );\n  // (erwinm, #4560): type cast necessary until #4560 is fixed.\n  const theUrlString = /** @type {string} */ (urlString);\n  userAssert(\n    isSecureUrlDeprecated(theUrlString) || /^(\\/\\/)/.test(theUrlString),\n    '%s %s must start with ' +\n      '\"https://\" or \"//\" or be relative and served from ' +\n      'either https or from localhost. Invalid value: %s',\n    elementContext,\n    sourceName,\n    theUrlString\n  );\n  return theUrlString;\n}\n\n/**\n * Asserts that a given url is an absolute HTTP or HTTPS URL.\n * @param {string} urlString\n * @return {string}\n */\nexport function assertAbsoluteHttpOrHttpsUrl(urlString) {\n  userAssert(\n    /^https?\\:/i.test(urlString),\n    'URL must start with \"http://\" or \"https://\". Invalid value: %s',\n    urlString\n  );\n  return parseUrlDeprecated(urlString).href;\n}\n\n/**\n * Returns the URL without fragment. If URL doesn't contain fragment, the same\n * string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function removeFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return url;\n  }\n  return url.substring(0, index);\n}\n\n/**\n * Returns the fragment from the URL. If the URL doesn't contain fragment,\n * the empty string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function getFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return '';\n  }\n  return url.substring(index);\n}\n\n/**\n * Returns whether the URL has the origin of a proxy.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isProxyOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return urls.cdnProxyRegex.test(url.origin);\n}\n\n/**\n * @param {string} uri\n * @return {boolean}\n */\nexport function isAmpScriptUri(uri) {\n  return uri.startsWith('amp-script:');\n}\n\n/**\n * For proxy-origin URLs, returns the serving type. Otherwise, returns null.\n * E.g., 'https://amp-com.cdn.ampproject.org/a/s/amp.com/amp_document.html'\n * returns 'a'.\n * @param {string|!Location} url URL of an AMP document.\n * @return {?string}\n */\nexport function getProxyServingType(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  if (!isProxyOrigin(url)) {\n    return null;\n  }\n  const path = url.pathname.split('/', 2);\n  return path[1];\n}\n\n/**\n * Returns whether the URL origin is localhost.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isLocalhostOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return urls.localhostRegex.test(url.origin);\n}\n\n/**\n * Returns whether the URL has valid protocol.\n * Deep link protocol is valid, but not javascript etc.\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isProtocolValid(url) {\n  if (!url) {\n    return true;\n  }\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return !INVALID_PROTOCOLS.includes(url.protocol);\n}\n\n/**\n * Returns a URL without AMP JS parameters.\n * @param {string} url\n * @return {string}\n */\nexport function removeAmpJsParamsFromUrl(url) {\n  const parsed = parseUrlDeprecated(url);\n  const search = removeAmpJsParamsFromSearch(parsed.search);\n  return parsed.origin + parsed.pathname + search + parsed.hash;\n}\n\n/**\n * Returns a URL without a query string.\n * @param {string} url\n * @return {string}\n */\nexport function removeSearch(url) {\n  const index = url.indexOf('?');\n  if (index == -1) {\n    return url;\n  }\n  const fragment = getFragment(url);\n  return url.substring(0, index) + fragment;\n}\n\n/**\n * Removes parameters that start with amp js parameter pattern and returns the\n * new search string.\n * @param {string} urlSearch\n * @return {string}\n */\nfunction removeAmpJsParamsFromSearch(urlSearch) {\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const search = urlSearch\n    .replace(AMP_JS_PARAMS_REGEX, '')\n    .replace(AMP_GSA_PARAMS_REGEX, '')\n    .replace(AMP_R_PARAMS_REGEX, '')\n    .replace(AMP_KIT_PARAMS_REGEX, '')\n    .replace(GOOGLE_EXPERIMENT_PARAMS_REGEX, '')\n    .replace(/^[?&]/, ''); // Removes first ? or &.\n  return search ? '?' + search : '';\n}\n\n/**\n * Removes parameters with param name and returns the new search string.\n * @param {string} urlSearch\n * @param {string} paramName\n * @return {string}\n */\nexport function removeParamsFromSearch(urlSearch, paramName) {\n  // TODO: reuse the function in removeAmpJsParamsFromSearch. Accept paramNames\n  // as an array.\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const paramRegex = new RegExp(`[?&]${paramName}=[^&]*`, 'g');\n  const search = urlSearch.replace(paramRegex, '').replace(/^[?&]/, '');\n  return search ? '?' + search : '';\n}\n\n/**\n * Returns the source URL of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string}\n */\nexport function getSourceUrl(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n\n  // Not a proxy URL - return the URL itself.\n  if (!isProxyOrigin(url)) {\n    return url.href;\n  }\n\n  // A proxy URL.\n  // Example path that is being matched here.\n  // https://cdn.ampproject.org/c/s/www.origin.com/foo/\n  // The /s/ is optional and signals a secure origin.\n  const path = url.pathname.split('/');\n  const prefix = path[1];\n  userAssert(\n    SERVING_TYPE_PREFIX[prefix],\n    'Unknown path prefix in url %s',\n    url.href\n  );\n  const domainOrHttpsSignal = path[2];\n  const origin =\n    domainOrHttpsSignal == 's'\n      ? 'https://' + decodeURIComponent(path[3])\n      : 'http://' + decodeURIComponent(domainOrHttpsSignal);\n  // Sanity test that what we found looks like a domain.\n  userAssert(origin.indexOf('.') > 0, 'Expected a . in origin %s', origin);\n  path.splice(1, domainOrHttpsSignal == 's' ? 3 : 2);\n  return (\n    origin +\n    path.join('/') +\n    removeAmpJsParamsFromSearch(url.search) +\n    (url.hash || '')\n  );\n}\n\n/**\n * Returns the source origin of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string} The source origin of the URL.\n */\nexport function getSourceOrigin(url) {\n  return parseUrlDeprecated(getSourceUrl(url)).origin;\n}\n\n/**\n * Returns absolute URL resolved based on the relative URL and the base.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n */\nexport function resolveRelativeUrl(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n  if (IS_ESM || typeof URL == 'function') {\n    return new URL(relativeUrlString, baseUrl.href).toString();\n  }\n  return resolveRelativeUrlFallback_(relativeUrlString, baseUrl);\n}\n\n/**\n * Fallback for URL resolver when URL class is not available.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n * @private @visibleForTesting\n */\nexport function resolveRelativeUrlFallback_(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n  relativeUrlString = relativeUrlString.replace(/\\\\/g, '/');\n  const relativeUrl = parseUrlDeprecated(relativeUrlString);\n\n  // Absolute URL.\n  if (relativeUrlString.toLowerCase().startsWith(relativeUrl.protocol)) {\n    return relativeUrl.href;\n  }\n\n  // Protocol-relative URL.\n  if (relativeUrlString.startsWith('//')) {\n    return baseUrl.protocol + relativeUrlString;\n  }\n\n  // Absolute path.\n  if (relativeUrlString.startsWith('/')) {\n    return baseUrl.origin + relativeUrlString;\n  }\n\n  // Relative path.\n  return (\n    baseUrl.origin +\n    baseUrl.pathname.replace(/\\/[^/]*$/, '/') +\n    relativeUrlString\n  );\n}\n\n/**\n * Add \"__amp_source_origin\" query parameter to the URL.\n * @param {!Window} win\n * @param {string} url\n * @return {string}\n */\nexport function getCorsUrl(win, url) {\n  checkCorsUrl(url);\n  const sourceOrigin = getSourceOrigin(win.location.href);\n  return addParamToUrl(url, SOURCE_ORIGIN_PARAM, sourceOrigin);\n}\n\n/**\n * Checks if the url has __amp_source_origin and throws if it does.\n * @param {string} url\n */\nexport function checkCorsUrl(url) {\n  const parsedUrl = parseUrlDeprecated(url);\n  const query = parseQueryString(parsedUrl.search);\n  userAssert(\n    !(SOURCE_ORIGIN_PARAM in query),\n    'Source origin is not allowed in %s',\n    url\n  );\n}\n\n/**\n * Adds the path to the given url.\n *\n * @param {!Location} url\n * @param {string} path\n * @return {string}\n */\nexport function appendPathToUrl(url, path) {\n  const pathname = url.pathname.replace(/\\/?$/, '/') + path.replace(/^\\//, '');\n  return url.origin + pathname + url.search + url.hash;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Experiments system allows a developer to opt-in to test\n * features that are not yet fully tested.\n *\n * Experiments page: https://cdn.ampproject.org/experiments.html *\n */\n\nimport {dev, user} from '../log';\nimport {getMode} from '../mode';\nimport {getTopWindow} from '../service';\nimport {hasOwn, map} from '../core/types/object';\nimport {isArray} from '../core/types';\nimport {parseQueryString} from '../core/types/string/url';\n\n// typedef imports\nimport {ExperimentInfoDef} from './experiments.type';\n\n/** @const {string} */\nconst TAG = 'EXPERIMENTS';\n\n/** @const {string} */\nconst LOCAL_STORAGE_KEY = 'amp-experiment-toggles';\n\n/** @const {string} */\nconst TOGGLES_WINDOW_PROPERTY = '__AMP__EXPERIMENT_TOGGLES';\n\n/**\n * Whether we are in canary.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isCanary(win) {\n  return !!win.AMP_CONFIG?.canary;\n}\n\n/**\n * Returns binary type, e.g., canary, production, control, or rc.\n * @param {!Window} win\n * @return {string}\n */\nexport function getBinaryType(win) {\n  return win.AMP_CONFIG?.type || 'unknown';\n}\n\n/**\n * Whether the specified experiment is on or off.\n * @param {!Window} win\n * @param {string} experimentId\n * @return {boolean}\n */\nexport function isExperimentOn(win, experimentId) {\n  const toggles = experimentToggles(win);\n  return !!toggles[experimentId];\n}\n\n/**\n * Toggles the experiment on or off. Returns the actual value of the experiment\n * after toggling is done.\n * @param {!Window} win\n * @param {string} experimentId\n * @param {boolean=} opt_on\n * @param {boolean=} opt_transientExperiment  Whether to toggle the\n *     experiment state \"transiently\" (i.e., for this page load only) or\n *     durably (by saving the experiment IDs after toggling).\n *     Default: false (save durably).\n * @return {boolean} New state for experimentId.\n */\nexport function toggleExperiment(\n  win,\n  experimentId,\n  opt_on,\n  opt_transientExperiment\n) {\n  const currentlyOn = isExperimentOn(win, /*OK*/ experimentId);\n  const on = opt_on ?? !currentlyOn;\n  if (on != currentlyOn) {\n    const toggles = experimentToggles(win);\n    toggles[experimentId] = on;\n\n    if (!opt_transientExperiment) {\n      const storedToggles = getExperimentToggles(win);\n      storedToggles[experimentId] = on;\n      saveExperimentToggles(win, storedToggles);\n      // Avoid affecting tests that spy/stub warn().\n      if (!getMode().test) {\n        user().warn(\n          TAG,\n          '\"%s\" experiment %s for the domain \"%s\". See: https://amp.dev/documentation/guides-and-tutorials/learn/experimental',\n          experimentId,\n          on ? 'enabled' : 'disabled',\n          win.location.hostname\n        );\n      }\n    }\n  }\n  return on;\n}\n\n/**\n * Calculate whether the experiment is on or off based off of its default value,\n * stored overriden value, or the global config frequency given.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\nexport function experimentToggles(win) {\n  if (win[TOGGLES_WINDOW_PROPERTY]) {\n    return win[TOGGLES_WINDOW_PROPERTY];\n  }\n  win[TOGGLES_WINDOW_PROPERTY] = map();\n  const toggles = win[TOGGLES_WINDOW_PROPERTY];\n\n  // Read the default config of this build.\n  if (win.AMP_CONFIG) {\n    for (const experimentId in win.AMP_CONFIG) {\n      const frequency = win.AMP_CONFIG[experimentId];\n      if (typeof frequency === 'number' && frequency >= 0 && frequency <= 1) {\n        toggles[experimentId] = Math.random() < frequency;\n      }\n    }\n  }\n  // Read document level override from meta tag.\n  const allowedDocOptIn = win.AMP_CONFIG?.['allow-doc-opt-in'];\n  if (isArray(allowedDocOptIn) && allowedDocOptIn.length) {\n    const meta = win.document.head.querySelector(\n      'meta[name=\"amp-experiments-opt-in\"]'\n    );\n    if (meta) {\n      const optedInExperiments = meta.getAttribute('content').split(',');\n      for (const experiment of optedInExperiments) {\n        if (dev().assertArray(allowedDocOptIn).includes(experiment)) {\n          toggles[experiment] = true;\n        }\n      }\n    }\n  }\n\n  Object.assign(toggles, getExperimentToggles(win));\n\n  const allowedUrlOptIn = win.AMP_CONFIG?.['allow-url-opt-in'];\n  if (isArray(allowedUrlOptIn) && allowedUrlOptIn.length) {\n    const hash = win.location['originalHash'] || win.location.hash;\n    const params = parseQueryString(hash);\n    for (const experiment of allowedUrlOptIn) {\n      const param = params[`e-${experiment}`];\n      if (param == '1') {\n        toggles[experiment] = true;\n      }\n      if (param == '0') {\n        toggles[experiment] = false;\n      }\n    }\n  }\n  return toggles;\n}\n\n/**\n * Returns the cached experiments toggles, or null if they have not been\n * computed yet.\n * @param {!Window} win\n * @return {?Object<string, boolean>}\n */\nexport function experimentTogglesOrNull(win) {\n  return win[TOGGLES_WINDOW_PROPERTY] || null;\n}\n\n/**\n * Returns a set of experiment IDs currently on.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\nfunction getExperimentToggles(win) {\n  let experimentsString = '';\n  try {\n    if ('localStorage' in win) {\n      experimentsString = win.localStorage.getItem(LOCAL_STORAGE_KEY);\n    }\n  } catch {\n    dev().warn(TAG, 'Failed to retrieve experiments from localStorage.');\n  }\n  const tokens = experimentsString?.split(/\\s*,\\s*/g) || [];\n\n  const toggles = map();\n  for (const token of tokens) {\n    if (!token) {\n      continue;\n    }\n    if (token[0] == '-') {\n      toggles[token.substr(1)] = false;\n    } else {\n      toggles[token] = true;\n    }\n  }\n  return toggles;\n}\n\n/**\n * Saves a set of experiment IDs currently on.\n * @param {!Window} win\n * @param {!Object<string, boolean>} toggles\n */\nfunction saveExperimentToggles(win, toggles) {\n  const experimentIds = [];\n  for (const experiment in toggles) {\n    experimentIds.push((toggles[experiment] === false ? '-' : '') + experiment);\n  }\n  try {\n    win.localStorage?.setItem(LOCAL_STORAGE_KEY, experimentIds.join(','));\n  } catch (e) {\n    user().error(TAG, 'Failed to save experiments to localStorage.');\n  }\n}\n\n/**\n * See getExperimentToggles().\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n * @visibleForTesting\n */\nexport function getExperimentTogglesForTesting(win) {\n  return getExperimentToggles(win);\n}\n\n/**\n * Resets the experimentsToggle cache for testing purposes.\n * @param {!Window} win\n * @visibleForTesting\n */\nexport function resetExperimentTogglesForTesting(win) {\n  saveExperimentToggles(win, {});\n  win[TOGGLES_WINDOW_PROPERTY] = null;\n}\n\n/**\n * In some browser implementations of Math.random(), sequential calls of\n * Math.random() are correlated and can cause a bias.  In particular,\n * if the previous random() call was < 0.001 (as it will be if we select\n * into an experiment), the next value could be less than 0.5 more than\n * 50.7% of the time.  This provides an implementation that roots down into\n * the crypto API, when available, to produce less biased samples.\n *\n * @return {number} Pseudo-random floating-point value on the range [0, 1).\n */\nfunction slowButAccuratePrng() {\n  // TODO(tdrl): Implement.\n  return Math.random();\n}\n\n/**\n * Container for alternate random number generator implementations.  This\n * allows us to set an \"accurate\" PRNG for branch selection, but to mock it\n * out easily in tests.\n *\n * @visibleForTesting\n * @const {!{accuratePrng: function():number}}\n */\nexport const RANDOM_NUMBER_GENERATORS = {\n  accuratePrng: slowButAccuratePrng,\n};\n\n/**\n * Selects, uniformly at random, a single item from the array.\n * @param {!Array<string>} arr Object to select from.\n * @return {?string} Single item from arr or null if arr was empty.\n */\nfunction selectRandomItem(arr) {\n  const rn = RANDOM_NUMBER_GENERATORS.accuratePrng();\n  return dev().assertString(arr[Math.floor(rn * arr.length)]) || null;\n}\n\n/**\n * Selects which page-level experiment branches are enabled. If a given\n * experiment name is already set (including to the null / no branches selected\n * state), this won't alter its state.\n *\n * Check whether a given experiment is set using isExperimentOn(win,\n * experimentName) and, if it is on, look for which branch is selected in\n * win.__AMP_EXPERIMENT_BRANCHES[experimentName].\n *\n * @param {!Window} win Window context on which to save experiment\n *     selection state.\n * @param {!Array<!ExperimentInfoDef>} experiments  Set of experiments to\n *     configure for this page load.\n * @return {!Object<string, string>} Map of experiment names to selected\n *     branches.\n */\nexport function randomlySelectUnsetExperiments(win, experiments) {\n  win.__AMP_EXPERIMENT_BRANCHES = win.__AMP_EXPERIMENT_BRANCHES || {};\n  const selectedExperiments = {};\n  for (const experiment of experiments) {\n    const experimentName = experiment.experimentId;\n    if (hasOwn(win.__AMP_EXPERIMENT_BRANCHES, experimentName)) {\n      selectedExperiments[experimentName] =\n        win.__AMP_EXPERIMENT_BRANCHES[experimentName];\n      continue;\n    }\n\n    if (!experiment.isTrafficEligible?.(win)) {\n      win.__AMP_EXPERIMENT_BRANCHES[experimentName] = null;\n      continue;\n    }\n\n    // If we're in the experiment, but we haven't already forced a specific\n    // experiment branch (e.g., via a test setup), then randomize the branch\n    // choice.\n    if (\n      !win.__AMP_EXPERIMENT_BRANCHES[experimentName] &&\n      isExperimentOn(win, /*OK*/ experimentName)\n    ) {\n      win.__AMP_EXPERIMENT_BRANCHES[experimentName] = selectRandomItem(\n        experiment.branches\n      );\n      selectedExperiments[experimentName] =\n        win.__AMP_EXPERIMENT_BRANCHES[experimentName];\n    }\n  }\n  return selectedExperiments;\n}\n\n/**\n * Returns the experiment branch enabled for the given experiment ID.\n * For example, 'control' or 'experiment'.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @param {string} experimentName Name of the experiment to check.\n * @return {?string} Active experiment branch ID for experimentName (possibly\n *     null if experimentName has been tested but no branch was enabled).\n */\nexport function getExperimentBranch(win, experimentName) {\n  return win.__AMP_EXPERIMENT_BRANCHES\n    ? win.__AMP_EXPERIMENT_BRANCHES[experimentName]\n    : null;\n}\n\n/**\n * Returns an object containing all active experiment branches on the\n * top Window.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @return {!Object} contains all experiment branches and their ids.\n */\nexport function getActiveExperimentBranches(win) {\n  const topWin = getTopWindow(win);\n  if (!topWin.__AMP_EXPERIMENT_BRANCHES) {\n    topWin.__AMP_EXPERIMENT_BRANCHES = {};\n  }\n  return {...topWin.__AMP_EXPERIMENT_BRANCHES};\n}\n\n/**\n * Force enable (or disable) a specific branch of a given experiment name.\n * Disables the experiment name altogether if branchId is falseish.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @param {string} experimentName Name of the experiment to check.\n * @param {?string} branchId ID of branch to force or null to disable\n *     altogether.\n * @visibleForTesting\n */\nexport function forceExperimentBranch(win, experimentName, branchId) {\n  win.__AMP_EXPERIMENT_BRANCHES = win.__AMP_EXPERIMENT_BRANCHES || {};\n  toggleExperiment(win, experimentName, !!branchId, true);\n  win.__AMP_EXPERIMENT_BRANCHES[experimentName] = branchId;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {Services} from './services';\nimport {WindowInterface} from './core/window/interface';\nimport {addParamsToUrl, isProxyOrigin, parseUrlDeprecated} from './url';\nimport {dev, user, userAssert} from './log';\nimport {getMode} from './mode';\nimport {isExperimentOn} from './experiments';\nimport {parseQueryString} from './core/types/string/url';\n\nconst TIMEOUT_VALUE = 8000;\n\nlet trackImpressionPromise = null;\n\nconst DEFAULT_APPEND_URL_PARAM = ['gclid', 'gclsrc'];\n\n/**\n * These domains are trusted with more sensitive viewer operations such as\n * sending impression requests. If you believe your domain should be here,\n * file the issue on GitHub to discuss. The process will be similar\n * (but somewhat more stringent) to the one described in the [3p/README.md](\n * https://github.com/ampproject/amphtml/blob/main/3p/README.md)\n *\n * @type {!Array<!RegExp>}\n */\nconst TRUSTED_REFERRER_HOSTS = [\n  /**\n   * Twitter's link wrapper domains:\n   * - t.co\n   */\n  /^t.co$/,\n];\n\n/**\n * A function to get the trackImpressionPromise;\n * @return {!Promise}\n */\nexport function getTrackImpressionPromise() {\n  return userAssert(trackImpressionPromise, 'E#19457 trackImpressionPromise');\n}\n\n/**\n * Function that reset the trackImpressionPromise only for testing\n * @visibleForTesting\n */\nexport function resetTrackImpressionPromiseForTesting() {\n  trackImpressionPromise = null;\n}\n\n/**\n * Emit a HTTP request to a destination defined on the incoming URL.\n * Launched for trusted viewer. Otherwise guarded by experiment.\n * @param {!Window} win\n */\nexport function maybeTrackImpression(win) {\n  const deferred = new Deferred();\n  const {promise, resolve: resolveImpression} = deferred;\n\n  trackImpressionPromise = Services.timerFor(win)\n    .timeoutPromise(TIMEOUT_VALUE, promise, 'TrackImpressionPromise timeout')\n    .catch((error) => {\n      dev().warn('IMPRESSION', error);\n    });\n\n  const viewer = Services.viewerForDoc(win.document.documentElement);\n  const isTrustedViewerPromise = viewer.isTrustedViewer();\n  const isTrustedReferrerPromise = viewer\n    .getReferrerUrl()\n    .then((referrer) => isTrustedReferrer(referrer));\n  Promise.all([isTrustedViewerPromise, isTrustedReferrerPromise]).then(\n    (results) => {\n      const isTrustedViewer = results[0];\n      const isTrustedReferrer = results[1];\n      // Enable the feature in the case of trusted viewer,\n      // or trusted referrer\n      // or with experiment turned on\n      if (\n        !isTrustedViewer &&\n        !isTrustedReferrer &&\n        !isExperimentOn(win, 'alp')\n      ) {\n        resolveImpression();\n        return;\n      }\n\n      const replaceUrlPromise = handleReplaceUrl(win);\n      const clickUrlPromise = handleClickUrl(win);\n\n      Promise.all([replaceUrlPromise, clickUrlPromise]).then(\n        () => {\n          resolveImpression();\n        },\n        () => {}\n      );\n    }\n  );\n}\n\n/**\n * Signal that impression tracking is not relevant in this environment.\n */\nexport function doNotTrackImpression() {\n  trackImpressionPromise = Promise.resolve();\n}\n\n/**\n * Handle the getReplaceUrl and return a promise when url is replaced Only\n * handles replaceUrl when viewer indicates AMP to do so. Viewer should indicate\n * by setting the legacy replaceUrl init param and add `replaceUrl` to its\n * capability param. Future plan is to change the type of legacy init replaceUrl\n * param from url string to boolean value. Please NOTE replaceUrl and adLocation\n * will never arrive at same time, so there is no race condition on the order of\n * handling url replacement.\n * @param {!Window} win\n * @return {!Promise}\n */\nfunction handleReplaceUrl(win) {\n  const viewer = Services.viewerForDoc(win.document.documentElement);\n\n  // ReplaceUrl substitution doesn't have to wait until the document is visible\n  if (!viewer.getParam('replaceUrl')) {\n    // The init replaceUrl param serve as a signal on whether replaceUrl is\n    // required for this doc.\n    return Promise.resolve();\n  }\n\n  if (!viewer.hasCapability('replaceUrl')) {\n    // If Viewer is not capability of providing async replaceUrl, use the legacy\n    // init replaceUrl param.\n    viewer.replaceUrl(viewer.getParam('replaceUrl') || null);\n    return Promise.resolve();\n  }\n\n  // request async replaceUrl is viewer support getReplaceUrl.\n  return viewer\n    .sendMessageAwaitResponse('getReplaceUrl', /* data */ undefined)\n    .then(\n      (response) => {\n        if (!response || typeof response != 'object') {\n          dev().warn('IMPRESSION', 'get invalid replaceUrl response');\n          return;\n        }\n        viewer.replaceUrl(response['replaceUrl'] || null);\n      },\n      (err) => {\n        dev().warn('IMPRESSION', 'Error request replaceUrl from viewer', err);\n      }\n    );\n}\n\n/**\n * @param {string} referrer\n * @return {boolean}\n * @visibleForTesting\n */\nexport function isTrustedReferrer(referrer) {\n  const url = parseUrlDeprecated(referrer);\n  if (url.protocol != 'https:') {\n    return false;\n  }\n  return TRUSTED_REFERRER_HOSTS.some((th) => th.test(url.hostname));\n}\n\n/**\n * Perform the impression request if it has been provided via\n * the click param in the viewer arguments. Returns a promise.\n * @param {!Window} win\n * @return {!Promise}\n */\nfunction handleClickUrl(win) {\n  const ampdoc = Services.ampdoc(win.document.documentElement);\n  const viewer = Services.viewerForDoc(ampdoc);\n\n  /** @const {?string} */\n  const clickUrl = viewer.getParam('click');\n  if (!clickUrl) {\n    return Promise.resolve();\n  }\n\n  if (clickUrl.indexOf('https://') != 0) {\n    user().warn(\n      'IMPRESSION',\n      'click fragment param should start with https://. Found ',\n      clickUrl\n    );\n    return Promise.resolve();\n  }\n\n  if (WindowInterface.getLocation(win).hash) {\n    // This is typically done using replaceState inside the viewer.\n    // If for some reason it failed, get rid of the fragment here to\n    // avoid duplicate tracking.\n    WindowInterface.getLocation(win).hash = '';\n  }\n\n  // TODO(@zhouyx) need test with a real response.\n  return ampdoc\n    .whenFirstVisible()\n    .then(() => {\n      return invoke(win, dev().assertString(clickUrl));\n    })\n    .then((response) => {\n      applyResponse(win, response);\n    })\n    .catch((err) => {\n      user().warn('IMPRESSION', 'Error on request clickUrl: ', err);\n    });\n}\n\n/**\n * Send the url to ad server and wait for its response\n * @param {!Window} win\n * @param {string} clickUrl\n * @return {!Promise<?JsonObject>}\n */\nfunction invoke(win, clickUrl) {\n  if (getMode().localDev && !getMode().test) {\n    clickUrl = 'http://localhost:8000/impression-proxy?url=' + clickUrl;\n  }\n  return Services.xhrFor(win)\n    .fetchJson(clickUrl, {\n      credentials: 'include',\n    })\n    .then((res) => {\n      // Treat 204 no content response specially\n      if (res.status == 204) {\n        return null;\n      }\n      return res.json();\n    });\n}\n\n/**\n * parse the response back from ad server\n * Set for analytics purposes\n * @param {!Window} win\n * @param {?JsonObject} response\n */\nfunction applyResponse(win, response) {\n  if (!response) {\n    return;\n  }\n\n  const adLocation = response['location'];\n  const adTracking = response['tracking_url'];\n\n  // If there is a tracking_url, need to track it\n  // Otherwise track the location\n  const trackUrl = adTracking || adLocation;\n\n  if (trackUrl && !isProxyOrigin(trackUrl)) {\n    // To request the provided trackUrl for tracking purposes.\n    new Image().src = trackUrl;\n  }\n\n  // Replace the location href params with new location params we get (if any).\n  if (adLocation) {\n    if (!win.history.replaceState) {\n      return;\n    }\n\n    const viewer = Services.viewerForDoc(win.document.documentElement);\n    const currentHref = WindowInterface.getLocation(win).href;\n    const url = parseUrlDeprecated(adLocation);\n    const params = parseQueryString(url.search);\n    const newHref = addParamsToUrl(currentHref, params);\n    // TODO: Avoid overwriting the fragment parameter.\n    win.history.replaceState(null, '', newHref);\n    viewer.maybeUpdateFragmentForCct();\n  }\n}\n\n/**\n * Return a promise that whether appending extra url params to outgoing link is\n * required.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<boolean>}\n */\nexport function shouldAppendExtraParams(ampdoc) {\n  return ampdoc.whenReady().then(() => {\n    return !!ampdoc\n      .getBody()\n      .querySelector('amp-analytics[type=googleanalytics]');\n  });\n}\n\n/**\n * Return the extra url params string that should be appended to outgoing link\n * @param {!Window} win\n * @param {!Element} target\n * @return {string}\n */\nexport function getExtraParamsUrl(win, target) {\n  // Get an array with extra params that needs to append.\n  const url = parseUrlDeprecated(WindowInterface.getLocation(win).href);\n  const params = parseQueryString(url.search);\n  const appendParams = [];\n  for (let i = 0; i < DEFAULT_APPEND_URL_PARAM.length; i++) {\n    const param = DEFAULT_APPEND_URL_PARAM[i];\n    if (typeof params[param] !== 'undefined') {\n      appendParams.push(param);\n    }\n  }\n\n  // Check if the param already exists\n  const additionalUrlParams = target.getAttribute('data-amp-addparams');\n  let {href} = target;\n  if (additionalUrlParams) {\n    href = addParamsToUrl(href, parseQueryString(additionalUrlParams));\n  }\n  const loc = parseUrlDeprecated(href);\n  const existParams = parseQueryString(loc.search);\n  for (let i = appendParams.length - 1; i >= 0; i--) {\n    const param = appendParams[i];\n    if (typeof existParams[param] !== 'undefined') {\n      appendParams.splice(i, 1);\n    }\n  }\n  return getQueryParamUrl(appendParams);\n}\n\n/**\n * Helper method to convert an query param array to string\n * @param {!Array<string>} params\n * @return {string}\n */\nfunction getQueryParamUrl(params) {\n  let url = '';\n  for (let i = 0; i < params.length; i++) {\n    const param = params[i];\n    url +=\n      i == 0\n        ? `${param}=QUERY_PARAM(${param})`\n        : `&${param}=QUERY_PARAM(${param})`;\n  }\n  return url;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * A priority queue backed with sorted array.\n * @template T\n */\nexport default class PriorityQueue {\n  /**\n   * Creates an instance of PriorityQueue.\n   */\n  constructor() {\n    /** @private @const {Array<{item: T, priority: number}>} */\n    this.queue_ = [];\n  }\n\n  /**\n   * Returns the max priority item without dequeueing it.\n   * @return {T}\n   */\n  peek() {\n    const l = this.length;\n    if (!l) {\n      return null;\n    }\n    return this.queue_[l - 1].item;\n  }\n\n  /**\n   * Enqueues an item with the given priority.\n   * @param {T} item\n   * @param {number} priority\n   */\n  enqueue(item, priority) {\n    if (isNaN(priority)) {\n      throw new Error('Priority must not be NaN.');\n    }\n    const i = this.binarySearch_(priority);\n    this.queue_.splice(i, 0, {item, priority});\n  }\n\n  /**\n   * Returns index at which item with `target` priority should be inserted.\n   * @param {number} target\n   * @return {number}\n   * @private\n   */\n  binarySearch_(target) {\n    let i = -1;\n    let lo = 0;\n    let hi = this.length;\n    while (lo <= hi) {\n      i = Math.floor((lo + hi) / 2);\n      // This means `target` is the new max priority in the queue.\n      if (i === this.length) {\n        break;\n      }\n      // Stop searching once p[i] >= target AND p[i-1] < target.\n      // This way, we'll return the index of the first occurence of `target`\n      // priority (if any), which preserves FIFO order of same-priority items.\n      if (this.queue_[i].priority < target) {\n        lo = i + 1;\n      } else if (i > 0 && this.queue_[i - 1].priority >= target) {\n        hi = i - 1;\n      } else {\n        break;\n      }\n    }\n    return i;\n  }\n\n  /**\n   * @param {function(T)} callback\n   */\n  forEach(callback) {\n    let index = this.length;\n    while (index--) {\n      callback(this.queue_[index].item);\n    }\n  }\n\n  /**\n   * Dequeues the max priority item.\n   * Items with the same priority are dequeued in FIFO order.\n   * @return {T}\n   */\n  dequeue() {\n    if (!this.length) {\n      return null;\n    }\n    return this.queue_.pop().item;\n  }\n\n  /**\n   * The number of items in the queue.\n   * @return {number}\n   */\n  get length() {\n    return this.queue_.length;\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {closestAncestorElementBySelector} from '../core/dom/query';\nimport {dev, user, userAssert} from '../log';\nimport {dict} from '../core/types/object';\nimport {escapeCssSelectorIdent} from '../core/dom/css-selectors';\nimport {getExtraParamsUrl, shouldAppendExtraParams} from '../impression';\nimport {getMode} from '../mode';\nimport {isIframed, openWindowDialog, tryFocus} from '../dom';\nimport {isLocalhostOrigin} from '../url';\nimport {registerServiceBuilderForDoc} from '../service';\nimport {toWin} from '../core/window';\nimport PriorityQueue from '../core/data-structures/priority-queue';\n\nconst TAG = 'navigation';\n\n/** @private @const {string} */\nconst EVENT_TYPE_CLICK = 'click';\n\n/** @private @const {string} */\nconst EVENT_TYPE_CONTEXT_MENU = 'contextmenu';\n\nconst VALID_TARGETS = ['_top', '_blank'];\n\n/** @private @const {string} */\nconst ORIG_HREF_ATTRIBUTE = 'data-a4a-orig-href';\n\n/**\n * Key used for retargeting event target originating from shadow DOM.\n * @const {string}\n */\nconst AMP_CUSTOM_LINKER_TARGET = '__AMP_CUSTOM_LINKER_TARGET__';\n\n/**\n * @enum {number} Priority reserved for extensions in anchor mutations.\n * The higher the priority, the sooner it's invoked.\n */\nexport const Priority = {\n  LINK_REWRITER_MANAGER: 0,\n  ANALYTICS_LINKER: 2,\n};\n\n/**\n * Install navigation service for ampdoc, which handles navigations from anchor\n * tag clicks and other runtime features like AMP.navigateTo().\n *\n * Immediately instantiates the service.\n *\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installGlobalNavigationHandlerForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    TAG,\n    Navigation,\n    /* opt_instantiate */ true\n  );\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Event} e\n * @visibleForTesting\n */\nexport function maybeExpandUrlParamsForTesting(ampdoc, e) {\n  maybeExpandUrlParams(ampdoc, e);\n}\n\n/**\n * Intercept any click on the current document and prevent any\n * linking to an identifier from pushing into the history stack.\n * @visibleForTesting\n */\nexport class Navigation {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @private @const {!Document|!ShadowRoot} */\n    this.rootNode_ = ampdoc.getRootNode();\n\n    /** @private @const {!./viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(this.ampdoc);\n\n    /** @private @const {!./viewer-interface.ViewerInterface} */\n    this.viewer_ = Services.viewerForDoc(this.ampdoc);\n\n    /** @private @const {!./history-impl.History} */\n    this.history_ = Services.historyForDoc(this.ampdoc);\n\n    /** @private @const {!./platform-impl.Platform} */\n    this.platform_ = Services.platformFor(this.ampdoc.win);\n\n    /** @private @const {boolean} */\n    this.isIosSafari_ = this.platform_.isIos() && this.platform_.isSafari();\n\n    /** @private @const {boolean} */\n    this.isIframed_ =\n      isIframed(this.ampdoc.win) && this.viewer_.isOvertakeHistory();\n\n    /** @private @const {boolean} */\n    this.isEmbed_ =\n      this.rootNode_ != this.ampdoc.getRootNode() || !!this.ampdoc.getParent();\n\n    /** @private @const {boolean} */\n    this.isInABox_ = getMode(this.ampdoc.win).runtime == 'inabox';\n\n    /**\n     * Must use URL parsing scoped to `rootNode_` for correct FIE behavior.\n     * @private @const {!Element|!ShadowRoot}\n     */\n    this.serviceContext_ = /** @type {!Element|!ShadowRoot} */ (\n      this.rootNode_.nodeType == Node.DOCUMENT_NODE\n        ? this.rootNode_.documentElement\n        : this.rootNode_\n    );\n\n    /** @private @const {!function(!Event)|undefined} */\n    this.boundHandle_ = this.handle_.bind(this);\n    this.rootNode_.addEventListener(EVENT_TYPE_CLICK, this.boundHandle_);\n    this.rootNode_.addEventListener(EVENT_TYPE_CONTEXT_MENU, this.boundHandle_);\n    /** @private {boolean} */\n    this.appendExtraParams_ = false;\n    shouldAppendExtraParams(this.ampdoc).then((res) => {\n      this.appendExtraParams_ = res;\n    });\n\n    /** @private {boolean} */\n    this.isTrustedViewer_ = false;\n    /** @private {boolean} */\n    this.isLocalViewer_ = false;\n    Promise.all([\n      this.viewer_.isTrustedViewer(),\n      this.viewer_.getViewerOrigin(),\n    ]).then((values) => {\n      this.isTrustedViewer_ = values[0];\n      this.isLocalViewer_ = isLocalhostOrigin(values[1]);\n    });\n\n    /**\n     * Lazy-generated list of A2A-enabled navigation features.\n     * @private {?Array<string>}\n     */\n    this.a2aFeatures_ = null;\n\n    /**\n     * @type {!PriorityQueue<function(!Element, !Event)>}\n     * @private\n     * @const\n     */\n    this.anchorMutators_ = new PriorityQueue();\n\n    /**\n     * @type {!PriorityQueue<function(string)>}\n     * @private\n     * @const\n     */\n    this.navigateToMutators_ = new PriorityQueue();\n  }\n\n  /**\n   * Registers a handler that performs URL replacement on the href\n   * of an ad click.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Window} win\n   */\n  static installAnchorClickInterceptor(ampdoc, win) {\n    win.document.documentElement.addEventListener(\n      'click',\n      maybeExpandUrlParams.bind(null, ampdoc),\n      /* capture */ true\n    );\n  }\n\n  /**\n   * Removes all event listeners.\n   */\n  cleanup() {\n    if (this.boundHandle_) {\n      this.rootNode_.removeEventListener(EVENT_TYPE_CLICK, this.boundHandle_);\n      this.rootNode_.removeEventListener(\n        EVENT_TYPE_CONTEXT_MENU,\n        this.boundHandle_\n      );\n    }\n  }\n\n  /**\n   * Opens a new window with the specified target.\n   *\n   * @param {!Window} win A window to use to open a new window.\n   * @param {string} url THe URL to open.\n   * @param {string} target The target for the newly opened window.\n   * @param {boolean} opener Whether or not the new window should have acccess\n   *   to the opener (win).\n   */\n  openWindow(win, url, target, opener) {\n    let options = '';\n    // We don't pass noopener for Chrome since it opens a new window without\n    // tabs. Instead, we remove the opener property from the newly opened\n    // window.\n    // Note: for Safari, we need to use noopener instead of clearing the opener\n    // property.\n    if ((this.platform_.isIos() || !this.platform_.isChrome()) && !opener) {\n      options += 'noopener';\n    }\n\n    const newWin = openWindowDialog(win, url, target, options);\n    // For Chrome, since we cannot use noopener.\n    if (newWin && !opener) {\n      newWin.opener = null;\n    }\n  }\n\n  /**\n   * Navigates a window to a URL.\n   *\n   * If opt_requestedBy matches a feature name in a <meta> tag with attribute\n   * name=\"amp-to-amp-navigation\", then treats the URL as an AMP URL (A2A).\n   *\n   * @param {!Window} win\n   * @param {string} url\n   * @param {string=} opt_requestedBy\n   * @param {!{\n   *   target: (string|undefined),\n   *   opener: (boolean|undefined),\n   * }=} options\n   */\n  navigateTo(win, url, opt_requestedBy, options = {}) {\n    const {opener = false, target = '_top'} = options;\n    url = this.applyNavigateToMutators_(url);\n    const urlService = Services.urlForDoc(this.serviceContext_);\n    if (!urlService.isProtocolValid(url)) {\n      user().error(TAG, 'Cannot navigate to invalid protocol: ' + url);\n      return;\n    }\n\n    userAssert(\n      VALID_TARGETS.includes(target),\n      `Target '${target}' not supported.`\n    );\n\n    // If we're on cache, resolve relative URLs to the publisher (non-cache) origin.\n    const sourceUrl = urlService.getSourceUrl(win.location);\n    url = urlService.resolveRelativeUrl(url, sourceUrl);\n\n    // If we have a target of \"_blank\", we will want to open a new window. A\n    // target of \"_top\" should behave like it would on an anchor tag and\n    // update the URL.\n    if (target == '_blank') {\n      this.openWindow(win, url, target, opener);\n      return;\n    }\n\n    // If this redirect was requested by a feature that opted into A2A,\n    // try to ask the viewer to navigate this AMP URL.\n    if (opt_requestedBy) {\n      if (!this.a2aFeatures_) {\n        this.a2aFeatures_ = this.queryA2AFeatures_();\n      }\n      if (this.a2aFeatures_.includes(opt_requestedBy)) {\n        if (this.navigateToAmpUrl(url, opt_requestedBy)) {\n          return;\n        }\n      }\n    }\n\n    // Otherwise, perform normal behavior of navigating the top frame.\n    win.top.location.href = url;\n  }\n\n  /**\n   * Requests A2A navigation to the given destination. If the viewer does\n   * not support this operation, does nothing.\n   * The URL is assumed to be in AMP Cache format already.\n   * @param {string} url An AMP article URL.\n   * @param {string} requestedBy Informational string about the entity that\n   *     requested the navigation.\n   * @return {boolean} Returns true if navigation message was sent to viewer.\n   *     Otherwise, returns false.\n   */\n  navigateToAmpUrl(url, requestedBy) {\n    if (this.viewer_.hasCapability('a2a')) {\n      this.viewer_.sendMessage(\n        'a2aNavigate',\n        dict({\n          'url': url,\n          'requestedBy': requestedBy,\n        })\n      );\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * @return {!Array<string>}\n   * @private\n   */\n  queryA2AFeatures_() {\n    const meta = this.rootNode_.querySelector(\n      'meta[name=\"amp-to-amp-navigation\"]'\n    );\n    if (meta && meta.hasAttribute('content')) {\n      return meta\n        .getAttribute('content')\n        .split(',')\n        .map((s) => s.trim());\n    }\n    return [];\n  }\n\n  /**\n   * Intercept any click on the current document and prevent any\n   * linking to an identifier from pushing into the history stack.\n   *\n   * This also handles custom protocols (e.g. whatsapp://) when iframed\n   * on iOS Safari.\n   *\n   * @param {!Event} e\n   * @private\n   */\n  handle_(e) {\n    if (e.defaultPrevented) {\n      return;\n    }\n    const element = dev().assertElement(\n      e[AMP_CUSTOM_LINKER_TARGET] || e.target\n    );\n    const target = closestAncestorElementBySelector(element, 'A');\n    if (!target || !target.href) {\n      return;\n    }\n    if (e.type == EVENT_TYPE_CLICK) {\n      this.handleClick_(target, e);\n    } else if (e.type == EVENT_TYPE_CONTEXT_MENU) {\n      this.handleContextMenuClick_(target, e);\n    }\n  }\n\n  /**\n   * @param {!Element} element\n   * @param {!Event} e\n   * @private\n   */\n  handleClick_(element, e) {\n    this.expandVarsForAnchor_(element);\n\n    let toLocation = this.parseUrl_(element.href);\n\n    // Handle AMP-to-AMP navigation and early-outs, if rel=amphtml.\n    if (this.handleA2AClick_(e, element, toLocation)) {\n      return;\n    }\n\n    // Handle navigating to custom protocol and early-outs, if applicable.\n    if (this.handleCustomProtocolClick_(e, element, toLocation)) {\n      return;\n    }\n\n    const fromLocation = this.getLocation_();\n    // Only apply anchor mutator if this is an external navigation.\n    // Note that anchor mutators may theoretically change the navigation\n    // from external to internal, so we re-parse the new targetLocation\n    // in handleNavigation_().\n    if (getHrefMinusHash(toLocation) != getHrefMinusHash(fromLocation)) {\n      this.applyAnchorMutators_(element, e);\n      toLocation = this.parseUrl_(element.href);\n    }\n\n    // Finally, handle normal click-navigation behavior.\n    this.handleNavigation_(e, element, toLocation, fromLocation);\n  }\n\n  /**\n   * Handles \"contextmenu\" event e.g. right mouse button click.\n   * @param {!Element} element\n   * @param {!Event} e\n   * @private\n   */\n  handleContextMenuClick_(element, e) {\n    // TODO(wg-performance): Handle A2A, custom link protocols, and ITP 2.3 mitigation.\n    this.expandVarsForAnchor_(element);\n    this.applyAnchorMutators_(element, e);\n  }\n\n  /**\n   * Apply anchor transformations.\n   * @param {!Element} element\n   * @param {!Event} e\n   */\n  applyAnchorMutators_(element, e) {\n    this.anchorMutators_.forEach((anchorMutator) => {\n      anchorMutator(element, e);\n    });\n  }\n\n  /**\n   * Apply URL transformations for AMP.navigateTo.\n   * @param {string} url\n   * @return {string}\n   */\n  applyNavigateToMutators_(url) {\n    this.navigateToMutators_.forEach((mutator) => {\n      url = mutator(url);\n    });\n    return url;\n  }\n\n  /**\n   * @param {!Element} el\n   * @private\n   */\n  expandVarsForAnchor_(el) {\n    // First check if need to handle external link decoration.\n    let defaultExpandParamsUrl = null;\n    if (this.appendExtraParams_ && !this.isEmbed_) {\n      // Only decorate outgoing link when needed to and is not in FIE.\n      defaultExpandParamsUrl = getExtraParamsUrl(this.ampdoc.win, el);\n    }\n\n    const urlReplacements = Services.urlReplacementsForDoc(el);\n    urlReplacements.maybeExpandLink(el, defaultExpandParamsUrl);\n  }\n\n  /**\n   * Handles clicking on a custom protocol link.\n   * Returns true if the navigation was handled. Otherwise, returns false.\n   * @param {!Event} e\n   * @param {!Element} element\n   * @param {!Location} location\n   * @return {boolean}\n   * @private\n   */\n  handleCustomProtocolClick_(e, element, location) {\n    // Handle custom protocols only if the document is iframed.\n    if (!this.isIframed_) {\n      return false;\n    }\n\n    /** @const {!Window} */\n    const win = toWin(element.ownerDocument.defaultView);\n    const url = element.href;\n    const {protocol} = location;\n\n    // On Safari iOS, custom protocol links will fail to open apps when the\n    // document is iframed - in order to go around this, we set the top.location\n    // to the custom protocol href.\n    const isFTP = protocol == 'ftp:';\n\n    // In case of FTP Links in embedded documents always open then in _blank.\n    if (isFTP) {\n      openWindowDialog(win, url, '_blank');\n      e.preventDefault();\n      return true;\n    }\n\n    const isNormalProtocol = /^(https?|mailto):$/.test(protocol);\n    if (this.isIosSafari_ && !isNormalProtocol) {\n      openWindowDialog(win, url, '_top');\n      // Without preventing default the page would should an alert error twice\n      // in the case where there's no app to handle the custom protocol.\n      e.preventDefault();\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Handles clicking on an AMP link.\n   * Returns true if the navigation was handled. Otherwise, returns false.\n   * @param {!Event} e\n   * @param {!Element} element\n   * @param {!Location} location\n   * @return {boolean}\n   * @private\n   */\n  handleA2AClick_(e, element, location) {\n    if (!element.hasAttribute('rel')) {\n      return false;\n    }\n    const relations = element\n      .getAttribute('rel')\n      .split(' ')\n      .map((s) => s.trim());\n    if (!relations.includes('amphtml')) {\n      return false;\n    }\n    // The viewer may not support the capability for navigating AMP links.\n    if (this.navigateToAmpUrl(location.href, '<a rel=amphtml>')) {\n      e.preventDefault();\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Handles click-navigation on a non-A2A, standard-protocol link.\n   * @param {!Event} e\n   * @param {!Element} element\n   * @param {!Location} toLocation\n   * @param {!Location} fromLocation\n   * @private\n   */\n  handleNavigation_(e, element, toLocation, fromLocation) {\n    const to = getHrefMinusHash(toLocation);\n    const from = getHrefMinusHash(fromLocation);\n\n    // Handle same-page (hash) navigation separately.\n    if (toLocation.hash && to == from) {\n      this.handleHashNavigation_(e, toLocation, fromLocation);\n    } else {\n      // Otherwise, this is an other-page (external) navigation.\n      let target = (element.getAttribute('target') || '').toLowerCase();\n\n      if (this.isEmbed_ || this.isInABox_) {\n        // Target in the embed must be either _top or _blank (default).\n        if (target != '_top' && target != '_blank') {\n          target = '_blank';\n          element.setAttribute('target', target);\n        }\n      }\n\n      // ITP 2.3 mitigation. See https://github.com/ampproject/amphtml/issues/25179.\n      const {win} = this.ampdoc;\n      const platform = Services.platformFor(win);\n      const viewer = Services.viewerForDoc(element);\n      if (\n        fromLocation.search &&\n        platform.isSafari() &&\n        platform.getMajorVersion() >= 13 &&\n        viewer.isProxyOrigin() &&\n        viewer.isEmbedded()\n      ) {\n        this.removeViewerQueryBeforeNavigation_(win, fromLocation, target);\n      }\n\n      if (this.viewerInterceptsNavigation(to, 'intercept_click')) {\n        e.preventDefault();\n      }\n    }\n  }\n\n  /**\n   * Temporarily remove viewer query params from iframe (e.g. amp_js_v, usqp)\n   * to prevent document.referrer from being reduced to eTLD+1 (e.g. ampproject.org).\n   * @param {!Window} win\n   * @param {!Location} fromLocation\n   * @param {string} target\n   * @private\n   */\n  removeViewerQueryBeforeNavigation_(win, fromLocation, target) {\n    dev().info(\n      TAG,\n      'Removing iframe query string before navigation:',\n      fromLocation.search\n    );\n    const original = fromLocation.href;\n    const noQuery = `${fromLocation.origin}${fromLocation.pathname}${fromLocation.hash}`;\n    win.history.replaceState(null, '', noQuery);\n\n    const restoreQuery = () => {\n      const currentHref = win.location.href;\n      if (currentHref == noQuery) {\n        dev().info(TAG, 'Restored iframe URL with query string:', original);\n        win.history.replaceState(null, '', original);\n      } else {\n        dev().error(TAG, 'Unexpected iframe URL change:', currentHref, noQuery);\n      }\n    };\n\n    // For blank_, restore query params after the new page opens.\n    if (target === '_blank') {\n      win.setTimeout(restoreQuery, 0);\n    } else {\n      // For _top etc., wait until page is restored from page cache (bfcache).\n      // https://webkit.org/blog/516/webkit-page-cache-ii-the-unload-event/\n      win.addEventListener('pageshow', function onPageShow(e) {\n        if (e.persisted) {\n          restoreQuery();\n          win.removeEventListener('pageshow', onPageShow);\n        }\n      });\n    }\n  }\n\n  /**\n   * Handles clicking on an internal link\n   * @param {!Event} e\n   * @param {!Location} toLocation\n   * @param {!Location} fromLocation\n   * @private\n   */\n  handleHashNavigation_(e, toLocation, fromLocation) {\n    // Anchor navigation in IE doesn't change input focus, which can result in\n    // confusing behavior e.g. when pressing \"tab\" button.\n    // @see https://humanwhocodes.com/blog/2013/01/15/fixing-skip-to-content-links/\n    // @see https://github.com/ampproject/amphtml/issues/18671\n    if (!IS_ESM && Services.platformFor(this.ampdoc.win).isIe()) {\n      const id = toLocation.hash.substring(1);\n      const elementWithId = this.ampdoc.getElementById(id);\n      if (elementWithId) {\n        if (\n          !/^(?:a|select|input|button|textarea)$/i.test(elementWithId.tagName)\n        ) {\n          elementWithId.tabIndex = -1;\n        }\n        tryFocus(elementWithId);\n      }\n    }\n\n    // We prevent default so that the current click does not push\n    // into the history stack as this messes up the external documents\n    // history which contains the amp document.\n    e.preventDefault();\n\n    // For an embed, do not perform scrolling or global history push - both have\n    // significant UX and browser problems.\n    if (this.isEmbed_) {\n      return;\n    }\n\n    // Look for the referenced element.\n    const hash = toLocation.hash.slice(1);\n    let el = null;\n    if (hash) {\n      const escapedHash = escapeCssSelectorIdent(hash);\n      el =\n        this.rootNode_.getElementById(hash) ||\n        // Fallback to anchor[name] if element with id is not found.\n        // Linking to an anchor element with name is obsolete in html5.\n        this.rootNode_./*OK*/ querySelector(`a[name=\"${escapedHash}\"]`);\n    }\n\n    // If possible do update the URL with the hash. As explained above\n    // we do `replace` to avoid messing with the container's history.\n    if (toLocation.hash != fromLocation.hash) {\n      this.history_.replaceStateForTarget(toLocation.hash).then(() => {\n        this.scrollToElement_(el, hash);\n      });\n    } else {\n      // If the hash did not update just scroll to the element.\n      this.scrollToElement_(el, hash);\n    }\n  }\n\n  /**\n   * @param {function(!Element, !Event)} callback\n   * @param {number} priority\n   */\n  registerAnchorMutator(callback, priority) {\n    this.anchorMutators_.enqueue(callback, priority);\n  }\n\n  /**\n   * @param {function(string)} callback\n   * @param {number} priority\n   */\n  registerNavigateToMutator(callback, priority) {\n    this.navigateToMutators_.enqueue(callback, priority);\n  }\n\n  /**\n   * Scrolls the page to the given element.\n   * @param {?Element} elem\n   * @param {string} hash\n   * @private\n   */\n  scrollToElement_(elem, hash) {\n    // Scroll to the element if found.\n    if (elem) {\n      // The first call to scrollIntoView overrides browsers' default scrolling\n      // behavior. The second call insides setTimeout allows us to scroll to\n      // that element properly. Without doing this, the viewport will not catch\n      // the updated scroll position on iOS Safari and hence calculate the wrong\n      // scrollTop for the scrollbar jumping the user back to the top for\n      // failing to calculate the new jumped offset. Without the first call\n      // there will be a visual jump due to browser scroll. See\n      // https://github.com/ampproject/amphtml/issues/5334 for more details.\n      this.viewport_./*OK*/ scrollIntoView(elem);\n      Services.timerFor(this.ampdoc.win).delay(\n        () => this.viewport_./*OK*/ scrollIntoView(dev().assertElement(elem)),\n        1\n      );\n    } else {\n      dev().warn(\n        TAG,\n        `failed to find element with id=${hash} or a[name=${hash}]`\n      );\n    }\n  }\n\n  /**\n   * @param {string} url\n   * @return {!Location}\n   * @private\n   */\n  parseUrl_(url) {\n    return Services.urlForDoc(this.serviceContext_).parse(url);\n  }\n\n  /**\n   * @return {!Location}\n   * @private\n   */\n  getLocation_() {\n    // In test mode, we're not able to properly fix the anchor tag's base URL.\n    // So, we have to use the (mocked) window's location instead.\n    const baseHref =\n      getMode().test && !this.isEmbed_ ? this.ampdoc.win.location.href : '';\n    return this.parseUrl_(baseHref);\n  }\n\n  /**\n   * Requests navigation through a Viewer to the given destination.\n   *\n   * This function only proceeds if:\n   * 1. The viewer supports the 'interceptNavigation' capability.\n   * 2. The contained AMP doc has 'opted in' via including the 'allow-navigation-interception'\n   * attribute on the <html> tag.\n   * 3. The viewer is trusted or from localhost.\n   *\n   * @param {string} url A URL.\n   * @param {string} requestedBy Informational string about the entity that\n   *     requested the navigation.\n   * @return {boolean} Returns true if navigation message was sent to viewer.\n   *     Otherwise, returns false.\n   */\n  viewerInterceptsNavigation(url, requestedBy) {\n    const viewerHasCapability = this.viewer_.hasCapability(\n      'interceptNavigation'\n    );\n    const docOptedIn =\n      this.ampdoc.isSingleDoc() &&\n      this.ampdoc\n        .getRootNode()\n        .documentElement.hasAttribute('allow-navigation-interception');\n\n    if (\n      !viewerHasCapability ||\n      !docOptedIn ||\n      !(this.isTrustedViewer_ || this.isLocalViewer_)\n    ) {\n      return false;\n    }\n\n    this.viewer_.sendMessage(\n      'navigateTo',\n      dict({\n        'url': url,\n        'requestedBy': requestedBy,\n      })\n    );\n    return true;\n  }\n}\n\n/**\n * Handle click on links and replace variables in the click URL.\n * The function changes the actual href value and stores the\n * template in the ORIGINAL_HREF_ATTRIBUTE attribute\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Event} e\n */\nfunction maybeExpandUrlParams(ampdoc, e) {\n  const target = closestAncestorElementBySelector(\n    dev().assertElement(e.target),\n    'A'\n  );\n  if (!target || !target.href) {\n    // Not a click on a link.\n    return;\n  }\n  const hrefToExpand =\n    target.getAttribute(ORIG_HREF_ATTRIBUTE) || target.getAttribute('href');\n  if (!hrefToExpand) {\n    return;\n  }\n  const vars = {\n    'CLICK_X': () => {\n      return e.pageX;\n    },\n    'CLICK_Y': () => {\n      return e.pageY;\n    },\n  };\n  const newHref = Services.urlReplacementsForDoc(target).expandUrlSync(\n    hrefToExpand,\n    vars,\n    /* opt_allowlist */ {\n      // For now we only allow to replace the click location vars\n      // and nothing else.\n      // NOTE: Addition to this allowlist requires additional review.\n      'CLICK_X': true,\n      'CLICK_Y': true,\n    }\n  );\n  if (newHref != hrefToExpand) {\n    // Store original value so that later clicks can be processed with\n    // freshest values.\n    if (!target.getAttribute(ORIG_HREF_ATTRIBUTE)) {\n      target.setAttribute(ORIG_HREF_ATTRIBUTE, hrefToExpand);\n    }\n    target.setAttribute('href', newHref);\n  }\n}\n\n/**\n * Returns href without hash.\n * @param {!Location} location\n * @return {string}\n */\nfunction getHrefMinusHash(location) {\n  return `${location.origin}${location.pathname}${location.search}`;\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Registred singleton on AMP doc.\n * @enum {number}\n */\nexport const AMPDOC_SINGLETON_NAME = {\n  TRACKING_IFRAME: 1,\n  LINKER: 2,\n};\n\n/**\n * Enum for tick labels (used by Performance service)\n * @enum {string}\n */\nexport const TickLabel = {\n  ACCESS_AUTHORIZATION: 'aaa',\n  ACCESS_AUTHORIZATION_VISIBLE: 'aaav',\n  ADS_LAYOUT_DELAY: 'adld',\n  BAD_FRAMES: 'bf',\n  BATTERY_DROP: 'bd',\n  CONTENT_LAYOUT_DELAY: 'cld',\n  CUMULATIVE_LAYOUT_SHIFT: 'cls',\n  CUMULATIVE_LAYOUT_SHIFT_2: 'cls-2',\n  // TODO(#33207): Remove after data collection\n  CUMULATIVE_LAYOUT_SHIFT_BEFORE_FCP: 'cls-fcp',\n  CUMULATIVE_LAYOUT_SHIFT_BEFORE_VISIBLE: 'cls-ofv',\n  DOCUMENT_READY: 'dr',\n  END_INSTALL_STYLES: 'e_is',\n  FIRST_CONTENTFUL_PAINT: 'fcp',\n  FIRST_CONTENTFUL_PAINT_VISIBLE: 'fcpv',\n  FIRST_PAINT: 'fp',\n  FIRST_INPUT_DELAY: 'fid',\n  FIRST_INPUT_DELAY_POLYFILL: 'fid-polyfill',\n  FIRST_VIEWPORT_READY: 'pc',\n  GOOD_FRAME_PROBABILITY: 'gfp',\n  INSTALL_STYLES: 'is',\n  LARGEST_CONTENTFUL_PAINT_VISIBLE: 'lcpv',\n  LARGEST_CONTENTFUL_PAINT_LOAD: 'lcpl',\n  LARGEST_CONTENTFUL_PAINT_RENDER: 'lcpr',\n  LONG_TASKS_CHILD: 'ltc',\n  LONG_TASKS_SELF: 'lts',\n  MAKE_BODY_VISIBLE: 'mbv',\n  MESSAGING_READY: 'msr',\n  ON_FIRST_VISIBLE: 'ofv',\n  ON_LOAD: 'ol',\n  TIME_ORIGIN: 'timeOrigin',\n  VIDEO_CACHE_STATE: 'vcs',\n  VIDEO_ERROR: 'verr',\n  VIDEO_ON_FIRST_PAGE: 'vofp',\n  VIDEO_JOINT_LATENCY: 'vjl',\n  VIDEO_MEAN_TIME_BETWEEN_REBUFFER: 'vmtbrb',\n  VIDEO_REBUFFERS: 'vrb',\n  VIDEO_REBUFFER_RATE: 'vrbr',\n  VIDEO_WATCH_TIME: 'vwt',\n};\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../assert';\n\n/**\n * Key string in an action arguments map for an unparsed object literal string.\n *\n * E.g. for the action in <p on=\"tap:AMP.setState({foo: 'bar'})\",\n * then `args[RAW_OBJECT_ARGS_KEY]` is the string \"{foo: 'bar'}\".\n *\n * The action service delegates parsing of object literals to the corresponding\n * extension (in the example above, amp-bind).\n *\n * @see ./service/action-impl.ActionInfoDef\n * @const {string}\n */\nexport const RAW_OBJECT_ARGS_KEY = '__AMP_OBJECT_STRING__';\n\n/**\n * Identifier for an element's default action.\n *\n * @const {string}\n */\nexport const DEFAULT_ACTION = 'activate';\n\n/**\n * Corresponds to degree of user intent, i.e. events triggered with strong\n * user intent have high trust.\n *\n * @enum {number}\n */\nexport const ActionTrust = {\n  /**\n   * Events that are triggered without a user gesture, or triggered by a user\n   * gesture with weak intent (e.g. scroll) are \"low trust\".\n   *\n   * Actions that have low impact on the page's visual state should require\n   * \"low trust\" (e.g. pausing a video).\n   */\n  LOW: 1,\n  /**\n   * Events that are triggered nearly immediately (up to a few seconds) after\n   * a user gesture with strong intent (e.g. tap or swipe) are \"default trust\".\n   *\n   * Actions that can modify the page's visual state (e.g. content jumping)\n   * should require \"default trust\". This is the default required trust level\n   * for actions.\n   */\n  DEFAULT: 2,\n  /**\n   * Events that are triggered immediately after a user gesture with\n   * strong intent (e.g. tap or swipe) are \"high trust\".\n   *\n   * There are no actions yet that require high trust.\n   */\n  HIGH: 3,\n};\n\n/**\n * @param {!ActionTrust} actionTrust\n * @return {string}\n */\nexport function actionTrustToString(actionTrust) {\n  switch (actionTrust) {\n    case ActionTrust.LOW:\n      return 'low';\n    case ActionTrust.HIGH:\n      return 'high';\n    default:\n      devAssert(actionTrust === ActionTrust.DEFAULT);\n      return 'default';\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from './log';\nimport {map} from './core/types/object';\n\nlet htmlContainer;\nlet svgContainer;\n\n/**\n * Creates the html helper for the doc.\n *\n * @param {!Element|!Document} nodeOrDoc\n * @return {function(!Array<string>):!Element}\n */\nexport function htmlFor(nodeOrDoc) {\n  const doc = nodeOrDoc.ownerDocument || nodeOrDoc;\n  if (!htmlContainer || htmlContainer.ownerDocument !== doc) {\n    htmlContainer = doc.createElement('div');\n  }\n\n  return html;\n}\n\n/**\n * Creates the svg helper for the doc.\n *\n * @param {!Element|!Document} nodeOrDoc\n * @return {function(!Array<string>):!Element}\n */\nexport function svgFor(nodeOrDoc) {\n  const doc = nodeOrDoc.ownerDocument || nodeOrDoc;\n  if (!svgContainer || svgContainer.ownerDocument !== svgContainer) {\n    svgContainer = doc.createElementNS('http://www.w3.org/2000/svg', 'svg');\n  }\n\n  return svg;\n}\n\n/**\n * A tagged template literal helper to generate static SVG trees.\n * This must be used as a tagged template, ie\n *\n * ```\n * const circle = svg`<circle cx=\"60\" cy=\"60\" r=\"22\"></circle>`;\n * ```\n *\n * Only the root element and its subtree will be returned. DO NOT use this to\n * render subtree's with dynamic content, it WILL result in an error!\n *\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction svg(strings) {\n  return createNode(svgContainer, strings);\n}\n\n/**\n * A tagged template literal helper to generate static DOM trees.\n * This must be used as a tagged template, ie\n *\n * ```\n * const div = html`<div><span></span></div>`;\n * ```\n *\n * Only the root element and its subtree will be returned. DO NOT use this to\n * render subtree's with dynamic content, it WILL result in an error!\n *\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction html(strings) {\n  return createNode(htmlContainer, strings);\n}\n\n/**\n * Helper used by html and svg string literal functions.\n * @param {!Element} container\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction createNode(container, strings) {\n  devAssert(strings.length === 1, 'Improper html template tag usage.');\n  container./*OK*/ innerHTML = strings[0];\n\n  const el = container.firstElementChild;\n  devAssert(el, 'No elements in template');\n  devAssert(!el.nextElementSibling, 'Too many root elements in template');\n\n  // Clear to free memory.\n  container.removeChild(el);\n\n  return el;\n}\n\n/**\n * Queries an element for all elements with a \"ref\" attribute, removing\n * the attribute afterwards.\n * Returns a named map of all ref elements.\n *\n * @param {!Element} root\n * @return {!Object<string, !Element>}\n */\nexport function htmlRefs(root) {\n  const elements = root.querySelectorAll('[ref]');\n  const refs = map();\n\n  for (let i = 0; i < elements.length; i++) {\n    const element = elements[i];\n    const ref = devAssert(element.getAttribute('ref'), 'Empty ref attr');\n    element.removeAttribute('ref');\n    devAssert(refs[ref] === undefined, 'Duplicate ref');\n    refs[ref] = element;\n  }\n\n  return refs;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Note: loaded by 3p system. Cannot rely on babel polyfills.\nimport {dev, devAssert} from './log';\nimport {map} from './core/types/object';\n\n/** @type {Object<string, string>} */\nlet propertyNameCache;\n\n/** @const {!Array<string>} */\nconst vendorPrefixes = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n\nconst EMPTY_CSS_DECLARATION = /** @type {!CSSStyleDeclaration} */ ({\n  'getPropertyPriority': () => '',\n  'getPropertyValue': () => '',\n});\n\n/**\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\nexport function camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n\n/**\n  Checks the style if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} style\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\nfunction getVendorJsPropertyName_(style, titleCase) {\n  for (let i = 0; i < vendorPrefixes.length; i++) {\n    const propertyName = vendorPrefixes[i] + titleCase;\n    if (style[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n  return '';\n}\n\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @param {!Object} style\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} opt_bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\nexport function getVendorJsPropertyName(style, camelCase, opt_bypassCache) {\n  if (isVar(camelCase)) {\n    // CSS vars are returned as is.\n    return camelCase;\n  }\n  if (!propertyNameCache) {\n    propertyNameCache = map();\n  }\n  let propertyName = propertyNameCache[camelCase];\n  if (!propertyName || opt_bypassCache) {\n    propertyName = camelCase;\n    if (style[camelCase] === undefined) {\n      const titleCase = camelCaseToTitleCase(camelCase);\n      const prefixedPropertyName = getVendorJsPropertyName_(style, titleCase);\n\n      if (style[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n    if (!opt_bypassCache) {\n      propertyNameCache[camelCase] = propertyName;\n    }\n  }\n  return propertyName;\n}\n\n/**\n * Sets the CSS styles of the specified element with !important. The styles\n * are specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setImportantStyles(element, styles) {\n  const {style} = element;\n  for (const k in styles) {\n    style.setProperty(\n      getVendorJsPropertyName(style, k),\n      String(styles[k]),\n      'important'\n    );\n  }\n}\n\n/**\n * Sets the CSS style of the specified element with optional units, e.g. \"px\".\n * @param {?Element} element\n * @param {string} property\n * @param {*} value\n * @param {string=} opt_units\n * @param {boolean=} opt_bypassCache\n */\nexport function setStyle(element, property, value, opt_units, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return;\n  }\n  const styleValue = /** @type {string} */ (\n    opt_units ? value + opt_units : value\n  );\n  if (isVar(propertyName)) {\n    element.style.setProperty(propertyName, styleValue);\n  } else {\n    element.style[propertyName] = styleValue;\n  }\n}\n\n/**\n * Returns the value of the CSS style of the specified element.\n * @param {!Element} element\n * @param {string} property\n * @param {boolean=} opt_bypassCache\n * @return {*}\n */\nexport function getStyle(element, property, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return undefined;\n  }\n  if (isVar(propertyName)) {\n    return element.style.getPropertyValue(propertyName);\n  }\n  return element.style[propertyName];\n}\n\n/**\n * Sets the CSS styles of the specified element. The styles\n * a specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setStyles(element, styles) {\n  for (const k in styles) {\n    setStyle(element, k, styles[k]);\n  }\n}\n\n/**\n * Asserts that the style is not the `display` style.\n * This is the only possible way to pass a dynamic style to setStyle.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {string} style\n * @return {string}\n */\nexport function assertNotDisplay(style) {\n  if (style === 'display') {\n    dev().error(\n      'STYLE',\n      '`display` style detected. You must use toggle instead.'\n    );\n  }\n  return style;\n}\n\n/**\n * Asserts that the styles does not contain the `display` style.\n * This is the only possible way to pass a dynamic styles object to setStyles\n * and setImportantStyles.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {!Object<string, *>} styles\n * @return {!Object<string, *>}\n */\nexport function assertDoesNotContainDisplay(styles) {\n  if ('display' in styles) {\n    dev().error(\n      'STYLE',\n      '`display` style detected in styles. You must use toggle instead.'\n    );\n  }\n  return styles;\n}\n\n/**\n * Sets the initial display style of an element. This is a last resort. If you\n * can set the initial display using CSS, YOU MUST.\n * DO NOT USE THIS TO ARBITRARILY SET THE DISPLAY STYLE AFTER INITIAL SETUP.\n *\n * @param {!Element} el\n * @param {string} value\n */\nexport function setInitialDisplay(el, value) {\n  const {style} = el;\n  devAssert(\n    value !== '' && value !== 'none',\n    'Initial display value must not be \"none\". Use toggle instead.'\n  );\n  devAssert(\n    !style['display'],\n    'setInitialDisplay MUST NOT be used for ' +\n      'resetting the display style. If you are looking for display:none ' +\n      'toggling, use toggle instead.'\n  );\n  style['display'] = value;\n}\n\n/**\n * Shows or hides the specified element.\n * @param {!Element} element\n * @param {boolean=} opt_display\n */\nexport function toggle(element, opt_display) {\n  if (opt_display === undefined) {\n    opt_display = element.hasAttribute('hidden');\n  }\n  if (opt_display) {\n    element.removeAttribute('hidden');\n  } else {\n    element.setAttribute('hidden', '');\n  }\n}\n\n/**\n * Returns a pixel value.\n * @param {number} value\n * @return {string}\n */\nexport function px(value) {\n  return `${value}px`;\n}\n\n/**\n * Returns a degree value.\n * @param {number} value\n * @return {string}\n */\nexport function deg(value) {\n  return `${value}deg`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function translateX(value) {\n  if (typeof value == 'string') {\n    return `translateX(${value})`;\n  }\n  return `translateX(${px(value)})`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} x\n * @param {(number|string)=} opt_y\n * @return {string}\n */\nexport function translate(x, opt_y) {\n  if (typeof x == 'number') {\n    x = px(x);\n  }\n  if (opt_y === undefined) {\n    return `translate(${x})`;\n  }\n  if (typeof opt_y == 'number') {\n    opt_y = px(opt_y);\n  }\n  return `translate(${x}, ${opt_y})`;\n}\n\n/**\n * Returns a \"scale\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function scale(value) {\n  return `scale(${value})`;\n}\n\n/**\n * Returns a \"rotate\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function rotate(value) {\n  if (typeof value == 'number') {\n    value = deg(value);\n  }\n  return `rotate(${value})`;\n}\n\n/**\n * Remove alpha value from a rgba color value.\n * Return the new color property with alpha equals if has the alpha value.\n * Caller needs to make sure the input color value is a valid rgba/rgb value\n * @param {string} rgbaColor\n * @return {string}\n */\nexport function removeAlphaFromColor(rgbaColor) {\n  return rgbaColor.replace(\n    /\\(([^,]+),([^,]+),([^,)]+),[^)]+\\)/g,\n    '($1,$2,$3, 1)'\n  );\n}\n\n/**\n * Gets the computed style of the element. The helper is necessary to enforce\n * the possible `null` value returned by a buggy Firefox.\n *\n * @param {!Window} win\n * @param {!Element} el\n * @return {!CSSStyleDeclaration}\n */\nexport function computedStyle(win, el) {\n  const style = /** @type {?CSSStyleDeclaration} */ (win.getComputedStyle(el));\n  return style || EMPTY_CSS_DECLARATION;\n}\n\n/**\n * Resets styles that were set dynamically (i.e. inline)\n * @param {!Element} element\n * @param {!Array<string>} properties\n */\nexport function resetStyles(element, properties) {\n  for (let i = 0; i < properties.length; i++) {\n    setStyle(element, properties[i], null);\n  }\n}\n\n/**\n * Propagates the object-fit/position element attributes as styles.\n * @param {!Element} fromEl ie: amp-img\n * @param {!Element} toEl ie: the img within amp-img\n */\nexport function propagateObjectFitStyles(fromEl, toEl) {\n  if (fromEl.hasAttribute('object-fit')) {\n    setStyle(toEl, 'object-fit', fromEl.getAttribute('object-fit'));\n  }\n\n  if (fromEl.hasAttribute('object-position')) {\n    setStyle(toEl, 'object-position', fromEl.getAttribute('object-position'));\n  }\n}\n\n/**\n * @param {string} property\n * @return {boolean}\n */\nfunction isVar(property) {\n  return property.startsWith('--');\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Sets the img src to the first url in the srcset if srcset is defined but\n * src is not for browsers that do not support srcset.\n * @param {!Element} img\n */\nexport function guaranteeSrcForSrcsetUnsupportedBrowsers(img) {\n  // The <img> tag does not have a src and does not support srcset\n  if (!img.hasAttribute('src') && 'srcset' in img == false) {\n    const srcset = img.getAttribute('srcset');\n    const matches = /\\S+/.exec(srcset);\n    if (matches == null) {\n      return;\n    }\n    const srcseturl = matches[0];\n    img.setAttribute('src', srcseturl);\n  }\n}\n\n/**\n * Generates a transparent PNG of a given width/height.\n *\n * @param {!Document} doc\n * @param {number} width\n * @param {number} height\n * @return {string}\n */\nexport function transparentPng(doc, width, height) {\n  const canvas = /** @type {!HTMLCanvasElement} */ (\n    doc.createElement('canvas')\n  );\n  canvas.width = width;\n  canvas.height = height;\n\n  // Canvases are fully transparent by default, so we don't actually need to\n  // draw anything.\n\n  return canvas.toDataURL();\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Implements element layout. See https://goo.gl/9avXuT for\n * details.\n */\n\nimport {dev, devAssert, userAssert} from './log';\nimport {htmlFor} from './static-template';\nimport {isExperimentOn} from './experiments';\nimport {isFiniteNumber} from './core/types';\nimport {setStyle, setStyles, toggle} from './style';\nimport {toWin} from './core/window';\nimport {transparentPng} from './core/dom/img';\n\n/**\n * @enum {string}\n */\nexport const Layout = {\n  NODISPLAY: 'nodisplay',\n  FIXED: 'fixed',\n  FIXED_HEIGHT: 'fixed-height',\n  RESPONSIVE: 'responsive',\n  CONTAINER: 'container',\n  FILL: 'fill',\n  FLEX_ITEM: 'flex-item',\n  FLUID: 'fluid',\n  INTRINSIC: 'intrinsic',\n};\n\n/**\n * Layout priorities to use with BaseElement#getLayoutPriority() and\n * BaseElement#updateLayoutPriority().\n * @enum {number}\n */\nexport const LayoutPriority = {\n  CONTENT: 0,\n  METADATA: 1,\n  ADS: 2,\n  BACKGROUND: 3,\n};\n\n/**\n * CSS Length type. E.g. \"1px\" or \"20vh\".\n * @typedef {string}\n */\nexport let LengthDef;\n\n/**\n * @typedef {{\n *   width: string,\n *   height: string\n * }}\n */\nlet DimensionsDef;\n\n/**\n * The set of elements with natural dimensions, that is, elements\n * which have a known dimension either based on their value specified here,\n * or, if the value is null, a dimension specific to the browser.\n * `hasNaturalDimensions` checks for membership in this set.\n * `getNaturalDimensions` determines the dimensions for an element in the\n *    set and caches it.\n * @type {!Object<string, ?DimensionsDef>}\n * @private  Visible for testing only!\n */\nexport const naturalDimensions_ = {\n  'AMP-PIXEL': {width: '0px', height: '0px'},\n  'AMP-ANALYTICS': {width: '1px', height: '1px'},\n  // TODO(dvoytenko): audio should have width:auto.\n  'AMP-AUDIO': null,\n  'AMP-SOCIAL-SHARE': {width: '60px', height: '44px'},\n};\n\n/**\n * Elements that the progress can be shown for. This set has to be externalized\n * since the element's implementation may not be downloaded yet.\n * This list does not include video players which are found via regex later.\n * @enum {boolean}\n * @private  Visible for testing only!\n */\nexport const LOADING_ELEMENTS_ = {\n  'AMP-AD': true,\n  'AMP-ANIM': true,\n  'AMP-EMBED': true,\n  'AMP-FACEBOOK': true,\n  'AMP-FACEBOOK-COMMENTS': true,\n  'AMP-FACEBOOK-PAGE': true,\n  'AMP-GOOGLE-DOCUMENT-EMBED': true,\n  'AMP-IFRAME': true,\n  'AMP-IMG': true,\n  'AMP-INSTAGRAM': true,\n  'AMP-LIST': true,\n  'AMP-PINTEREST': true,\n  'AMP-PLAYBUZZ': true,\n  'AMP-RENDER': true,\n  'AMP-TWITTER': true,\n};\n/**\n * All video player components must either have a) \"video\" or b) \"player\" in\n * their name. A few components don't follow this convention for historical\n * reasons, so they are listed individually.\n * @private @const {!RegExp}\n */\nconst videoPlayerTagNameRe =\n  /^amp\\-(video|.+player)|AMP-BRIGHTCOVE|AMP-DAILYMOTION|AMP-YOUTUBE|AMP-VIMEO|AMP-IMA-VIDEO/i;\n\n/**\n * Whether aspect-ratio CSS can be used to implement responsive layouts.\n * @type {?boolean}\n */\nlet aspectRatioCssCache = null;\n\n/**\n * @param {string} s\n * @return {Layout|undefined} Returns undefined in case of failure to parse\n *   the layout string.\n */\nexport function parseLayout(s) {\n  for (const k in Layout) {\n    if (Layout[k] == s) {\n      return Layout[k];\n    }\n  }\n  return undefined;\n}\n\n/**\n * @param {!Layout} layout\n * @return {string}\n */\nexport function getLayoutClass(layout) {\n  return 'i-amphtml-layout-' + layout;\n}\n\n/**\n * Whether an element with this layout inherently defines the size.\n * @param {!Layout} layout\n * @return {boolean}\n */\nexport function isLayoutSizeDefined(layout) {\n  return (\n    layout == Layout.FIXED ||\n    layout == Layout.FIXED_HEIGHT ||\n    layout == Layout.RESPONSIVE ||\n    layout == Layout.FILL ||\n    layout == Layout.FLEX_ITEM ||\n    layout == Layout.FLUID ||\n    layout == Layout.INTRINSIC\n  );\n}\n\n/**\n * Whether an element with this layout has a fixed dimension.\n * @param {!Layout} layout\n * @return {boolean}\n */\nexport function isLayoutSizeFixed(layout) {\n  return layout == Layout.FIXED || layout == Layout.FIXED_HEIGHT;\n}\n\n/**\n * Whether the tag is an internal (service) AMP tag.\n * @param {!Node|string} tag\n * @return {boolean}\n */\nexport function isInternalElement(tag) {\n  const tagName = typeof tag == 'string' ? tag : tag.tagName;\n  return tagName && tagName.toLowerCase().startsWith('i-');\n}\n\n/**\n * Parses the CSS length value. If no units specified, the assumed value is\n * \"px\". Returns undefined in case of parsing error.\n * @param {string|undefined|null} s\n * @return {!LengthDef|undefined}\n */\nexport function parseLength(s) {\n  if (typeof s == 'number') {\n    return s + 'px';\n  }\n  if (!s) {\n    return undefined;\n  }\n  if (!/^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|cm|mm|q|in|pc|pt)?$/.test(s)) {\n    return undefined;\n  }\n  if (/^\\d+(\\.\\d+)?$/.test(s)) {\n    return s + 'px';\n  }\n  return s;\n}\n\n/**\n * Asserts that the supplied value is a non-percent CSS Length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {!LengthDef}\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertLength(length) {\n  userAssert(\n    /^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|cm|mm|q|in|pc|pt)$/.test(length),\n    'Invalid length value: %s',\n    length\n  );\n  return /** @type {!LengthDef} */ (length);\n}\n\n/**\n * Asserts that the supplied value is a CSS Length value\n * (including percent unit).\n * @param {!LengthDef|string} length\n * @return {!LengthDef}\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertLengthOrPercent(length) {\n  userAssert(\n    /^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|%)$/.test(length),\n    'Invalid length or percent value: %s',\n    length\n  );\n  return length;\n}\n\n/**\n * Returns units from the CSS length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {string}\n */\nexport function getLengthUnits(length) {\n  assertLength(length);\n  const m = userAssert(\n    /[a-z]+/i.exec(length),\n    'Failed to read units from %s',\n    length\n  );\n  return m[0];\n}\n\n/**\n * Returns the numeric value of a CSS length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {number|undefined}\n */\nexport function getLengthNumeral(length) {\n  const res = parseFloat(length);\n  return isFiniteNumber(res) ? res : undefined;\n}\n\n/**\n * Determines whether the tagName is a known element that has natural dimensions\n * in our runtime or the browser.\n * @param {string} tagName The element tag name.\n * @return {boolean}\n */\nexport function hasNaturalDimensions(tagName) {\n  tagName = tagName.toUpperCase();\n  return naturalDimensions_[tagName] !== undefined;\n}\n\n/**\n * Determines the default dimensions for an element which could vary across\n * different browser implementations, like <audio> for instance.\n * This operation can only be completed for an element allowlisted by\n * `hasNaturalDimensions`.\n * @param {!Element} element\n * @return {DimensionsDef}\n */\nexport function getNaturalDimensions(element) {\n  const tagName = element.tagName.toUpperCase();\n  devAssert(naturalDimensions_[tagName] !== undefined);\n  if (!naturalDimensions_[tagName]) {\n    const doc = element.ownerDocument;\n    const naturalTagName = tagName.replace(/^AMP\\-/, '');\n    const temp = doc.createElement(naturalTagName);\n    // For audio, should no-op elsewhere.\n    temp.controls = true;\n    setStyles(temp, {\n      position: 'absolute',\n      visibility: 'hidden',\n    });\n    doc.body.appendChild(temp);\n    naturalDimensions_[tagName] = {\n      width: (temp./*OK*/ offsetWidth || 1) + 'px',\n      height: (temp./*OK*/ offsetHeight || 1) + 'px',\n    };\n    doc.body.removeChild(temp);\n  }\n  return /** @type {DimensionsDef} */ (naturalDimensions_[tagName]);\n}\n\n/**\n * Whether the loading can be shown for the specified element. This set has\n * to be externalized since the element's implementation may not be\n * downloaded yet.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isLoadingAllowed(element) {\n  const tagName = element.tagName.toUpperCase();\n  return LOADING_ELEMENTS_[tagName] || isIframeVideoPlayerComponent(tagName);\n}\n\n/**\n * All video player components must either have a) \"video\" or b) \"player\" in\n * their name. A few components don't follow this convention for historical\n * reasons, so they're present in the LOADING_ELEMENTS_ allowlist.\n * @param {string} tagName\n * @return {boolean}\n */\nexport function isIframeVideoPlayerComponent(tagName) {\n  if (tagName == 'AMP-VIDEO') {\n    return false;\n  }\n  return videoPlayerTagNameRe.test(tagName);\n}\n\n/**\n * Applies layout to the element. Visible for testing only.\n *\n * \\   \\  /  \\  /   / /   \\     |   _  \\     |  \\ |  | |  | |  \\ |  |  / _____|\n *  \\   \\/    \\/   / /  ^  \\    |  |_)  |    |   \\|  | |  | |   \\|  | |  |  __\n *   \\            / /  /_\\  \\   |      /     |  . `  | |  | |  . `  | |  | |_ |\n *    \\    /\\    / /  _____  \\  |  |\\  \\----.|  |\\   | |  | |  |\\   | |  |__| |\n *     \\__/  \\__/ /__/     \\__\\ | _| `._____||__| \\__| |__| |__| \\__|  \\______|\n *\n * The equivalent of this method is used for server-side rendering (SSR) and\n * any changes made to it must be made in coordination with caches that\n * implement SSR. For more information on SSR see bit.ly/amp-ssr.\n *\n * @param {!Element} element\n * @param {boolean} fixIeIntrinsic\n * @return {!Layout}\n */\nexport function applyStaticLayout(element, fixIeIntrinsic = false) {\n  // Check if the layout has already been done by server-side rendering or\n  // client-side rendering and the element was cloned. The document may be\n  // visible to the user if the boilerplate was removed so please take care in\n  // making changes here.\n  const completedLayoutAttr = element.getAttribute('i-amphtml-layout');\n  if (completedLayoutAttr) {\n    const layout = /** @type {!Layout} */ (\n      devAssert(parseLayout(completedLayoutAttr))\n    );\n    if (\n      (layout == Layout.RESPONSIVE || layout == Layout.INTRINSIC) &&\n      element.firstElementChild\n    ) {\n      // Find sizer, but assume that it might not have been parsed yet.\n      element.sizerElement =\n        element.querySelector('i-amphtml-sizer') || undefined;\n      if (element.sizerElement) {\n        element.sizerElement.setAttribute('slot', 'i-amphtml-svc');\n      }\n    } else if (layout == Layout.NODISPLAY) {\n      toggle(element, false);\n      // TODO(jridgewell): Temporary hack while SSR still adds an inline\n      // `display: none`\n      element['style']['display'] = '';\n    }\n    return layout;\n  }\n\n  // If the layout was already done by server-side rendering (SSR), then the\n  // code below will not run. Any changes below will necessitate a change to SSR\n  // and must be coordinated with caches that implement SSR. See bit.ly/amp-ssr.\n\n  // Parse layout from the element.\n  const layoutAttr = element.getAttribute('layout');\n  const widthAttr = element.getAttribute('width');\n  const heightAttr = element.getAttribute('height');\n  const sizesAttr = element.getAttribute('sizes');\n  const heightsAttr = element.getAttribute('heights');\n\n  // Input layout attributes.\n  const inputLayout = layoutAttr ? parseLayout(layoutAttr) : null;\n  userAssert(\n    inputLayout !== undefined,\n    'Invalid \"layout\" value: %s, %s',\n    layoutAttr,\n    element\n  );\n  /** @const {string|null|undefined} */\n  const inputWidth =\n    widthAttr && widthAttr != 'auto' ? parseLength(widthAttr) : widthAttr;\n  userAssert(\n    inputWidth !== undefined,\n    'Invalid \"width\" value: %s, %s',\n    widthAttr,\n    element\n  );\n  /** @const {string|null|undefined} */\n  const inputHeight =\n    heightAttr && heightAttr != 'fluid' ? parseLength(heightAttr) : heightAttr;\n  userAssert(\n    inputHeight !== undefined,\n    'Invalid \"height\" value: %s, %s',\n    heightAttr,\n    element\n  );\n\n  // Effective layout attributes. These are effectively constants.\n  let width;\n  let height;\n  let layout;\n\n  // Calculate effective width and height.\n  if (\n    (!inputLayout ||\n      inputLayout == Layout.FIXED ||\n      inputLayout == Layout.FIXED_HEIGHT) &&\n    (!inputWidth || !inputHeight) &&\n    hasNaturalDimensions(element.tagName)\n  ) {\n    // Default width and height: handle elements that do not specify a\n    // width/height and are defined to have natural browser dimensions.\n    const dimensions = getNaturalDimensions(element);\n    width =\n      inputWidth || inputLayout == Layout.FIXED_HEIGHT\n        ? inputWidth\n        : dimensions.width;\n    height = inputHeight || dimensions.height;\n  } else {\n    width = inputWidth;\n    height = inputHeight;\n  }\n\n  // Calculate effective layout.\n  if (inputLayout) {\n    layout = inputLayout;\n  } else if (!width && !height) {\n    layout = Layout.CONTAINER;\n  } else if (height == 'fluid') {\n    layout = Layout.FLUID;\n  } else if (height && (!width || width == 'auto')) {\n    layout = Layout.FIXED_HEIGHT;\n  } else if (height && width && (sizesAttr || heightsAttr)) {\n    layout = Layout.RESPONSIVE;\n  } else {\n    layout = Layout.FIXED;\n  }\n\n  // Verify layout attributes.\n  if (\n    layout == Layout.FIXED ||\n    layout == Layout.FIXED_HEIGHT ||\n    layout == Layout.RESPONSIVE ||\n    layout == Layout.INTRINSIC\n  ) {\n    userAssert(height, 'The \"height\" attribute is missing: %s', element);\n  }\n  if (layout == Layout.FIXED_HEIGHT) {\n    userAssert(\n      !width || width == 'auto',\n      'The \"width\" attribute must be missing or \"auto\": %s',\n      element\n    );\n  }\n  if (\n    layout == Layout.FIXED ||\n    layout == Layout.RESPONSIVE ||\n    layout == Layout.INTRINSIC\n  ) {\n    userAssert(\n      width && width != 'auto',\n      'The \"width\" attribute must be present and not \"auto\": %s',\n      element\n    );\n  }\n\n  if (layout == Layout.RESPONSIVE || layout == Layout.INTRINSIC) {\n    userAssert(\n      getLengthUnits(width) == getLengthUnits(height),\n      'Length units should be the same for \"width\" and \"height\": %s, %s, %s',\n      widthAttr,\n      heightAttr,\n      element\n    );\n  } else {\n    userAssert(\n      heightsAttr === null,\n      '\"heights\" attribute must be missing: %s',\n      element\n    );\n  }\n\n  // Apply UI.\n  element.classList.add(getLayoutClass(layout));\n  if (isLayoutSizeDefined(layout)) {\n    element.classList.add('i-amphtml-layout-size-defined');\n  }\n  if (layout == Layout.NODISPLAY) {\n    // CSS defines layout=nodisplay automatically with `display:none`. Thus\n    // no additional styling is needed.\n    toggle(element, false);\n    // TODO(jridgewell): Temporary hack while SSR still adds an inline\n    // `display: none`\n    element['style']['display'] = '';\n  } else if (layout == Layout.FIXED) {\n    setStyles(element, {\n      width: dev().assertString(width),\n      height: dev().assertString(height),\n    });\n  } else if (layout == Layout.FIXED_HEIGHT) {\n    setStyle(element, 'height', dev().assertString(height));\n  } else if (layout == Layout.RESPONSIVE) {\n    if (shouldUseAspectRatioCss(toWin(element.ownerDocument.defaultView))) {\n      setStyle(\n        element,\n        'aspect-ratio',\n        `${getLengthNumeral(width)}/${getLengthNumeral(height)}`\n      );\n    } else {\n      const sizer = element.ownerDocument.createElement('i-amphtml-sizer');\n      sizer.setAttribute('slot', 'i-amphtml-svc');\n      setStyles(sizer, {\n        paddingTop:\n          (getLengthNumeral(height) / getLengthNumeral(width)) * 100 + '%',\n      });\n      element.insertBefore(sizer, element.firstChild);\n      element.sizerElement = sizer;\n    }\n  } else if (layout == Layout.INTRINSIC) {\n    // Intrinsic uses an svg inside the sizer element rather than the padding\n    // trick Note a naked svg won't work becasue other thing expect the\n    // i-amphtml-sizer element\n    const sizer = htmlFor(element)`\n      <i-amphtml-sizer class=\"i-amphtml-sizer\" slot=\"i-amphtml-svc\">\n        <img alt=\"\" role=\"presentation\" aria-hidden=\"true\"\n             class=\"i-amphtml-intrinsic-sizer\" />\n      </i-amphtml-sizer>`;\n    const intrinsicSizer = sizer.firstElementChild;\n    intrinsicSizer.setAttribute(\n      'src',\n      !IS_ESM && fixIeIntrinsic && element.ownerDocument\n        ? transparentPng(\n            element.ownerDocument,\n            dev().assertNumber(getLengthNumeral(width)),\n            dev().assertNumber(getLengthNumeral(height))\n          )\n        : `data:image/svg+xml;charset=utf-8,<svg height=\"${height}\" width=\"${width}\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\"/>`\n    );\n    element.insertBefore(sizer, element.firstChild);\n    element.sizerElement = sizer;\n  } else if (layout == Layout.FILL) {\n    // Do nothing.\n  } else if (layout == Layout.CONTAINER) {\n    // Do nothing. Elements themselves will check whether the supplied\n    // layout value is acceptable. In particular container is only OK\n    // sometimes.\n  } else if (layout == Layout.FLEX_ITEM) {\n    // Set height and width to a flex item if they exist.\n    // The size set to a flex item could be overridden by `display: flex` later.\n    if (width) {\n      setStyle(element, 'width', width);\n    }\n    if (height) {\n      setStyle(element, 'height', height);\n    }\n  } else if (layout == Layout.FLUID) {\n    element.classList.add('i-amphtml-layout-awaiting-size');\n    if (width) {\n      setStyle(element, 'width', width);\n    }\n    setStyle(element, 'height', 0);\n  }\n  // Mark the element as having completed static layout, in case it is cloned\n  // in the future.\n  element.setAttribute('i-amphtml-layout', layout);\n  return layout;\n}\n\n/**\n * Whether aspect-ratio CSS can be used to implement responsive layouts.\n *\n * @param {!Window} win\n * @return {boolean}\n */\nfunction shouldUseAspectRatioCss(win) {\n  if (aspectRatioCssCache == null) {\n    aspectRatioCssCache =\n      (isExperimentOn(win, 'layout-aspect-ratio-css') &&\n        win.CSS &&\n        win.CSS.supports &&\n        win.CSS.supports('aspect-ratio: 1/1')) ||\n      false;\n  }\n  return aspectRatioCssCache;\n}\n\n/** @visibleForTesting */\nexport function resetShouldUseAspectRatioCssForTesting() {\n  aspectRatioCssCache = null;\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether addEventListener supports options or only takes capture as a boolean\n * @type {boolean|undefined}\n * @visibleForTesting\n */\nlet optsSupported;\n\n/**\n * Whether addEventListener supports options or only takes passive as a boolean\n * @type {boolean|undefined}\n */\nlet passiveSupported;\n\n/**\n * Options supported by addEventListener\n * @typedef AddEventListenerOptsDef\n * @property {undefined|boolean} [capture]\n * @property {undefined|boolean} [once]\n * @property {undefined|boolean} [passive]\n * @property {undefined|!AbortSignal} [signal]\n * }}\n */\nlet AddEventListenerOptsDef;\n\n/**\n * Listens for the specified event on the element.\n *\n * Do not use this directly. This method is implemented as a shared\n * dependency. Use `listen()` in either `event-helper` or `3p-frame-messaging`,\n * depending on your use case.\n *\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {!AddEventListenerOptsDef=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function internalListenImplementation(\n  element,\n  eventType,\n  listener,\n  opt_evtListenerOpts\n) {\n  let localElement = element;\n  let localListener = listener;\n  /** @type {?function(!Event)} */\n  let wrapped = (event) => {\n    try {\n      return localListener(event);\n    } catch (e) {\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR?.(e);\n      throw e;\n    }\n  };\n  const optsSupported = detectEvtListenerOptsSupport();\n  const capture = !!opt_evtListenerOpts?.capture;\n\n  localElement.addEventListener(\n    eventType,\n    wrapped,\n    optsSupported ? opt_evtListenerOpts : capture\n  );\n  return () => {\n    localElement?.removeEventListener(\n      eventType,\n      wrapped,\n      optsSupported ? opt_evtListenerOpts : capture\n    );\n    // Ensure these are GC'd\n    localListener = null;\n    localElement = null;\n    wrapped = null;\n  };\n}\n\n/**\n * Tests whether the browser supports options as an argument of addEventListener\n * or not.\n *\n * @return {boolean}\n */\nexport function detectEvtListenerOptsSupport() {\n  // Only run the test once\n  if (optsSupported !== undefined) {\n    return optsSupported;\n  }\n\n  optsSupported = false;\n  try {\n    // Test whether browser supports EventListenerOptions or not\n    const options = {\n      get capture() {\n        optsSupported = true;\n      },\n    };\n    self.addEventListener('test-options', null, options);\n    self.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return optsSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports options or not.\n */\nexport function resetEvtListenerOptsSupportForTesting() {\n  optsSupported = undefined;\n}\n\n/**\n * Return boolean. if listener option is supported, return `true`.\n * if not supported, return `false`\n * @param {!Window} win\n * @return {boolean}\n */\nexport function supportsPassiveEventListener(win) {\n  if (passiveSupported !== undefined) {\n    return passiveSupported;\n  }\n\n  passiveSupported = false;\n  try {\n    const options = {\n      get passive() {\n        // This function will be called when the browser\n        // attempts to access the passive property.\n        passiveSupported = true;\n        return false;\n      },\n    };\n\n    win.addEventListener('test-options', null, options);\n    win.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return passiveSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports passive options or not.\n */\nexport function resetPassiveSupportedForTesting() {\n  passiveSupported = undefined;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalListenImplementation} from './core/dom/event-helper-listen';\nimport {lastChildElement} from './core/dom/query';\nimport {user} from './log';\n\n/** @const {string}  */\nconst LOAD_FAILURE_PREFIX = 'Failed to load:';\n\n/** @const {string} */\nexport const MEDIA_LOAD_FAILURE_SRC_PROPERTY = '__AMP_MEDIA_LOAD_FAILURE_SRC';\n\n/**\n * Returns a CustomEvent with a given type and detail; supports fallback for IE.\n * @param {!Window} win\n * @param {string} type\n * @param {!JsonObject|string|undefined|null} detail\n * @param {EventInit=} opt_eventInit\n * @return {!Event}\n */\nexport function createCustomEvent(win, type, detail, opt_eventInit) {\n  const eventInit = /** @type {!CustomEventInit} */ ({detail});\n  Object.assign(eventInit, opt_eventInit);\n  // win.CustomEvent is a function on Edge, Chrome, FF, Safari but\n  // is an object on IE 11.\n  if (IS_ESM || typeof win.CustomEvent == 'function') {\n    return new win.CustomEvent(type, eventInit);\n  } else {\n    // Deprecated fallback for IE.\n    const e = win.document.createEvent('CustomEvent');\n    e.initCustomEvent(\n      type,\n      !!eventInit.bubbles,\n      !!eventInit.cancelable,\n      detail\n    );\n    return e;\n  }\n}\n\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listen(element, eventType, listener, opt_evtListenerOpts) {\n  return internalListenImplementation(\n    element,\n    eventType,\n    listener,\n    opt_evtListenerOpts\n  );\n}\n\n/**\n * Returns the data property of an event with the correct type.\n * @param {!Event|{data: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getData(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.data);\n}\n\n/**\n * Returns the detail property of an event with the correct type.\n * @param {!Event|{detail: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getDetail(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.detail);\n}\n\n/**\n * Listens for the specified event on the element and removes the listener\n * as soon as event has been received.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listenOnce(element, eventType, listener, opt_evtListenerOpts) {\n  let localListener = listener;\n  const unlisten = internalListenImplementation(\n    element,\n    eventType,\n    (event) => {\n      try {\n        localListener(event);\n      } finally {\n        // Ensure listener is GC'd\n        localListener = null;\n        unlisten();\n      }\n    },\n    opt_evtListenerOpts\n  );\n  return unlisten;\n}\n\n/**\n * Returns  a promise that will resolve as soon as the specified event has\n * fired on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {Object=} opt_evtListenerOpts\n * @param {function(!UnlistenDef)=} opt_cancel An optional function that, when\n *     provided, will be called with the unlistener. This gives the caller\n *     access to the unlistener, so it may be called manually when necessary.\n * @return {!Promise<!Event>}\n */\nexport function listenOncePromise(\n  element,\n  eventType,\n  opt_evtListenerOpts,\n  opt_cancel\n) {\n  let unlisten;\n  const eventPromise = new Promise((resolve) => {\n    unlisten = listenOnce(element, eventType, resolve, opt_evtListenerOpts);\n  });\n  eventPromise.then(unlisten, unlisten);\n  if (opt_cancel) {\n    opt_cancel(unlisten);\n  }\n  return eventPromise;\n}\n\n/**\n * Whether the specified element/window has been loaded already.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nexport function isLoaded(eleOrWindow) {\n  return !!(\n    eleOrWindow.complete ||\n    eleOrWindow.readyState == 'complete' ||\n    (isHTMLMediaElement(eleOrWindow) && eleOrWindow.readyState > 0) ||\n    // If the passed in thing is a Window, infer loaded state from\n    //\n    (eleOrWindow.document && eleOrWindow.document.readyState == 'complete')\n  );\n}\n\n/**\n * Returns a promise that will resolve or fail based on the eleOrWindow's 'load'\n * and 'error' events. Optionally this method takes a timeout, which will reject\n * the promise if the resource has not loaded by then.\n * @param {T} eleOrWindow Supports both Elements and as a special case Windows.\n * @return {!Promise<T>}\n * @template T\n */\nexport function loadPromise(eleOrWindow) {\n  let unlistenLoad;\n  let unlistenError;\n  if (isLoaded(eleOrWindow)) {\n    return Promise.resolve(eleOrWindow);\n  }\n  const isMediaElement = isHTMLMediaElement(eleOrWindow);\n  if (\n    isMediaElement &&\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] === eleOrWindow.currentSrc\n  ) {\n    return Promise.reject(eleOrWindow);\n  }\n  const loadingPromise = new Promise((resolve, reject) => {\n    // Listen once since IE 5/6/7 fire the onload event continuously for\n    // animated GIFs.\n    if (isMediaElement) {\n      // The following event can be triggered by the media or one of its\n      // sources. Using capture is required as the media events do not bubble.\n      unlistenLoad = listenOnce(eleOrWindow, 'loadedmetadata', resolve, {\n        capture: true,\n      });\n    } else {\n      unlistenLoad = listenOnce(eleOrWindow, 'load', resolve);\n    }\n    // Don't unlisten on error for Windows.\n    if (!eleOrWindow.tagName) {\n      return;\n    }\n    let errorTarget = eleOrWindow;\n    // If the media element has no `src`, it will try to load the sources in\n    // document order. If the last source errors, then the media element\n    // loading errored.\n    if (isMediaElement && !eleOrWindow.hasAttribute('src')) {\n      errorTarget = lastChildElement(\n        eleOrWindow,\n        (child) => child.tagName === 'SOURCE'\n      );\n      if (!errorTarget) {\n        return reject(new Error('Media has no source.'));\n      }\n    }\n    unlistenError = listenOnce(errorTarget, 'error', reject);\n  });\n\n  return loadingPromise.then(\n    () => {\n      if (unlistenError) {\n        unlistenError();\n      }\n      return eleOrWindow;\n    },\n    () => {\n      if (unlistenLoad) {\n        unlistenLoad();\n      }\n      failedToLoad(eleOrWindow);\n    }\n  );\n}\n\n/**\n * Emit error on load failure.\n * @param {!Element|!Window} eleOrWindow Supports both Elements and as a special\n *     case Windows.\n */\nfunction failedToLoad(eleOrWindow) {\n  // Mark the element as errored since some elements - like HTMLMediaElement\n  // using HTMLSourceElement - do not provide any synchronous way to verify if\n  // they already errored, even though the error event was already dispatched.\n  if (isHTMLMediaElement(eleOrWindow)) {\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] =\n      eleOrWindow.currentSrc || true;\n  }\n\n  // Report failed loads as user errors so that they automatically go\n  // into the \"document error\" bucket.\n  let target = eleOrWindow;\n  if (target && target.src) {\n    target = target.src;\n  }\n  throw user().createError(LOAD_FAILURE_PREFIX, target);\n}\n\n/**\n * Returns true if the parameter is a HTMLMediaElement.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nfunction isHTMLMediaElement(eleOrWindow) {\n  return eleOrWindow.tagName === 'AUDIO' || eleOrWindow.tagName === 'VIDEO';\n}\n\n/**\n * Returns true if this error message is was created for a load error.\n * @param {string} message An error message\n * @return {boolean}\n */\nexport function isLoadErrorMessage(message) {\n  return message.indexOf(LOAD_FAILURE_PREFIX) != -1;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ActionTrust, DEFAULT_ACTION} from './core/constants/action-constants';\nimport {Layout, LayoutPriority} from './layout';\nimport {Services} from './services';\nimport {devAssert, user, userAssert} from './log';\nimport {dispatchCustomEvent} from './dom';\nimport {getData, listen, loadPromise} from './event-helper';\nimport {getMode} from './mode';\nimport {isArray} from './core/types';\nimport {toWin} from './core/window';\n\n/**\n * Base class for all custom element implementations. Instead of inheriting\n * from Element this class has an Element. Among other things this allows\n * switching the element implementation when going from a stub to the full\n * implementation.\n *\n * The base class implements a set of lifecycle methods that are called by\n * the runtime as appropriate. These are mostly based on the custom element\n * lifecycle (See\n * https://developers.google.com/web/fundamentals/getting-started/primers/customelements)\n * and adding AMP style late loading to the mix.\n *\n * The complete lifecycle of a custom DOM element is:\n *\n *    State: <NOT BUILT> <NOT UPGRADED>\n *           ||\n *           || upgrade\n *           ||\n *           \\/\n *    State: <NOT BUILT>\n *           ||\n *           || buildCallback\n *           || !getPlaceholder() => createPlaceholderCallback\n *           || preconnectCallback may be called N times after this, but only\n *           || after the doc becomes visible.\n *           || pauseCallback may be called N times after this.\n *           || resumeCallback may be called N times after this.\n *           ||\n *           \\/\n *    State: <BUILT>\n *           ||\n *           || layoutCallback        <==\n *           || (firstLayoutCompleted)  ||\n *           ||                         ||\n *           \\/                         || isRelayoutNeeded?\n *    State: <LAID OUT>                 ||\n *           ||                         ||\n *           ||                 =========\n *           ||\n *           || unlayoutCallback may be called N times after this.\n *           ||\n *           \\/\n *    State: <IN VIEWPORT>\n *\n * The preconnectCallback is called when the systems thinks it is good\n * to preconnect to hosts needed by an element. It will never be called\n * before buildCallback and it might be called multiple times including\n * after layoutCallback.\n *\n * The pauseCallback is called when when the document becomes inactive, e.g.\n * when the user swipes away from the document, or when the element is no\n * longer being displayed, e.g. when the carousel slide slides out of view.\n * In these situations, any actively playing media should pause.\n *\n * The resumeCallback is called when when the document becomes active again\n * after becoming inactive, e.g. when the user swipes away from the document\n * and swipes back. In these situations, any paused media may begin playing\n * again, if user interaction is not required.\n * TODO(jridgewell) slide slides into view\n *\n * The createPlaceholderCallback is called if AMP didn't detect a provided\n * placeholder for the element, subclasses can override this to build and\n * return a dynamically created placeholder that AMP would append to the\n * element.\n *\n * The unlayoutCallback is called when the document becomes inactive, e.g.\n * when the user swipes away from the document, or another tab is focused.\n * In these situations, expensive memory and CPU resources should be freed.\n *\n * Additionally whenever the dimensions of an element might have changed\n * AMP remeasures its dimensions and calls `onLayoutMeasure` on the\n * element instance. This can be used to do additional style calculations\n * without triggering style recalculations.\n *\n * For more details, see {@link custom-element.js}.\n *\n * Each method is called exactly once and overriding them in subclasses\n * is optional.\n * @implements {BaseElementInterface}\n */\nexport class BaseElement {\n  /**\n   * Whether this element supports R1 protocol, which includes:\n   * 1. Layout/unlayout are not managed by the runtime, but instead are\n   *    implemented by the element as needed.\n   * 2. The element can defer its build until later. See `deferredMount`.\n   * 3. The construction of the element is delayed until mount.\n   *\n   * Notice, in this mode `layoutCallback`, `pauseCallback`, `onLayoutMeasure`,\n   * `getLayoutSize`, and other methods are deprecated. The element must\n   * independently handle each of these states internally.\n   *\n   * @return {boolean}\n   * @nocollapse\n   */\n  static R1() {\n    return false;\n  }\n\n  /**\n   * Whether this element supports deferred-build mode. In this mode, the\n   * element's build will be deferred roughly based on the\n   * `content-visibility: auto` rules.\n   *\n   * Only used for R1 elements.\n   *\n   * @param {!AmpElement} unusedElement\n   * @return {boolean}\n   * @nocollapse\n   */\n  static deferredMount(unusedElement) {\n    return true;\n  }\n\n  /**\n   * Subclasses can override this method to opt-in into being called to\n   * prerender when document itself is not yet visible (pre-render mode).\n   *\n   * The return value of this function is used to determine whether or not the\n   * element will be built _and_ laid out during prerender mode. Therefore, any\n   * changes to the return value _after_ buildCallback() will have no affect.\n   *\n   * @param {!AmpElement} unusedElement\n   * @return {boolean}\n   * @nocollapse\n   */\n  static prerenderAllowed(unusedElement) {\n    return false;\n  }\n\n  /**\n   * Subclasses can override this method to indicate that an element can load\n   * network resources.\n   *\n   * Such elements can have their `ensureLoaded` method called.\n   *\n   * @param {!AmpElement} unusedElement\n   * @return {boolean}\n   * @nocollapse\n   */\n  static usesLoading(unusedElement) {\n    return false;\n  }\n\n  /**\n   * Subclasses can override this method to provide a svg logo that will be\n   * displayed as the loader.\n   *\n   * @param {!AmpElement} unusedElement\n   * @return {{\n   *  content: (!Element|undefined),\n   *  color: (string|undefined),\n   * }}\n   * @nocollapse\n   */\n  static createLoaderLogoCallback(unusedElement) {\n    return {};\n  }\n\n  /**\n   * This is the element's build priority.\n   *\n   * The lower the number, the higher the priority.\n   *\n   * The default priority for base elements is LayoutPriority.CONTENT.\n   *\n   * @param {!AmpElement} unusedElement\n   * @return {number}\n   * @nocollapse\n   */\n  static getBuildPriority(unusedElement) {\n    return LayoutPriority.CONTENT;\n  }\n\n  /**\n   * Called by the framework to give the element a chance to preconnect to\n   * hosts and prefetch resources it is likely to need. May be called\n   * multiple times because connections can time out.\n   *\n   * Returns an array of URLs to be preconnected.\n   *\n   * @param {!AmpElement} unusedElement\n   * @return {?Array<string>}\n   * @nocollapse\n   */\n  static getPreconnects(unusedElement) {\n    return null;\n  }\n\n  /**\n   * Subclasses can override this method to indicate that instances need to\n   * use Shadow DOM. The Runtime will ensure that the Shadow DOM polyfill is\n   * installed before upgrading and building this class.\n   *\n   * @return {boolean}\n   * @nocollapse\n   */\n  static requiresShadowDom() {\n    return false;\n  }\n\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    /** @public @const {!Element} */\n    this.element = element;\n\n    /** @public @const {!Window} */\n    this.win = toWin(element.ownerDocument.defaultView);\n\n    /*\n    \\   \\  /  \\  /   / /   \\     |   _  \\     |  \\ |  | |  | |  \\ |  |  /  ____|\n     \\   \\/    \\/   / /  ^  \\    |  |_)  |    |   \\|  | |  | |   \\|  | |  |  __\n      \\            / /  /_\\  \\   |      /     |  . `  | |  | |  . `  | |  | |_ |\n       \\    /\\    / /  _____  \\  |  |\\  \\----.|  |\\   | |  | |  |\\   | |  |__| |\n        \\__/  \\__/ /__/     \\__\\ | _| `._____||__| \\__| |__| |__| \\__|  \\______|\n\n    Any private property for BaseElement MUST be wrapped with quotes. We cannot\n    allow Closure Compiler to mangle privates in this class, because it can\n    reuse the same mangled name for a different property in, i.e., amp-youtube's\n    BaseElement subclass (which lives in a different binary).\n    */\n\n    /**\n     * Maps action name to struct containing the action handler and minimum\n     * trust required to invoke the handler.\n     * @private {?Object<string, {\n     *   handler: function(!./service/action-impl.ActionInvocation),\n     *   minTrust: ActionTrust,\n     * }>} */\n    this['actionMap_'] = null;\n\n    /** @private {?string} */\n    this['defaultActionAlias_'] = null;\n  }\n\n  /**\n   * The element's signal tracker.\n   * @return {!./utils/signals.Signals}\n   */\n  signals() {\n    return this.element.signals();\n  }\n\n  /**\n   * The element's default action alias.\n   * @return {?string}\n   */\n  getDefaultActionAlias() {\n    return this['defaultActionAlias_'];\n  }\n\n  /**\n   * This is the priority of loading elements (layoutCallback). Used only to\n   * determine layout timing and preloading priority. Does not affect build time,\n   * etc.\n   *\n   * The lower the number, the higher the priority.\n   *\n   * The default priority for base elements is LayoutPriority.CONTENT.\n   * @return {number}\n   * TODO(#31915): remove once R1 migration is complete.\n   */\n  getLayoutPriority() {\n    return LayoutPriority.CONTENT;\n  }\n\n  /**\n   * Updates the priority of the resource. If there are tasks currently\n   * scheduled, their priority is updated as well.\n   *\n   * This method can be called any time when the new priority value is\n   * available. It's a restricted API and special review is required to\n   * allow individual extensions to request priority upgrade.\n   *\n   * @param {number} newLayoutPriority\n   * @restricted\n   */\n  updateLayoutPriority(newLayoutPriority) {\n    this.element\n      .getResources()\n      .updateLayoutPriority(this.element, newLayoutPriority);\n  }\n\n  /** @return {!Layout} */\n  getLayout() {\n    return this.element.getLayout();\n  }\n\n  /**\n   * Returns a previously measured layout box adjusted to the viewport. This\n   * mainly affects fixed-position elements that are adjusted to be always\n   * relative to the document position in the viewport.\n   * @return {!./layout-rect.LayoutRectDef}\n   * TODO(#31915): remove once R1 migration is complete.\n   */\n  getLayoutBox() {\n    return this.element.getLayoutBox();\n  }\n\n  /**\n   * Returns a previously measured layout size.\n   * @return {!./layout-rect.LayoutSizeDef}\n   * TODO(#31915): remove once R1 migration is complete.\n   */\n  getLayoutSize() {\n    return this.element.getLayoutSize();\n  }\n\n  /**\n   * DO NOT CALL. Retained for backward compat during rollout.\n   * @public\n   * @return {!Window}\n   */\n  getWin() {\n    return this.win;\n  }\n\n  /**\n   * Returns the associated ampdoc. Only available when `buildCallback` and\n   * going forward. It throws an exception before `buildCallback`.\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   */\n  getAmpDoc() {\n    return this.element.getAmpDoc();\n  }\n\n  /**\n   * @public\n   * @return {!./service/vsync-impl.Vsync}\n   */\n  getVsync() {\n    return Services.vsyncFor(this.win);\n  }\n\n  /**\n   * Returns the consent policy id that this element should wait for before\n   * buildCallback.\n   * A `null` value indicates to not be blocked by consent.\n   * Subclasses may override.\n   * @return {?string}\n   */\n  getConsentPolicy() {\n    let policyId = null;\n    if (this.element.hasAttribute('data-block-on-consent')) {\n      policyId =\n        this.element.getAttribute('data-block-on-consent') || 'default';\n    }\n    return policyId;\n  }\n\n  /**\n   * Intended to be implemented by subclasses. Tests whether the element\n   * supports the specified layout. By default only Layout.NODISPLAY is\n   * supported.\n   * @param {!Layout} layout\n   * @return {boolean}\n   * @public\n   */\n  isLayoutSupported(layout) {\n    return layout == Layout.NODISPLAY;\n  }\n\n  /**\n   * Intended to be implemented by subclasses. Tests whether the element\n   * requires fixed positioning.\n   * @return {boolean}\n   * @public\n   */\n  isAlwaysFixed() {\n    return false;\n  }\n\n  /**\n   * This method is called when the element is added to DOM for the first time\n   * and before `buildCallback` to give the element a chance to redirect its\n   * implementation to another `BaseElement` implementation. The returned\n   * value can be either `null` or `undefined` to indicate that no redirection\n   * will take place; `BaseElement` instance to upgrade immediately; or a\n   * promise to upgrade with the resolved `BaseElement` instance.\n   *\n   * Notice that calls to `upgradeCallback` are not recursive. I.e. this\n   * callback will not be called on the returned instance again.\n   *\n   * @return {!BaseElement|!Promise<!BaseElement>|null}\n   */\n  upgradeCallback() {\n    // Subclasses may override.\n    return null;\n  }\n\n  /**\n   * Override in subclass if the element needs to rebuilt its DOM content.\n   * Until the element has been rebuilt its content are not shown with an only\n   * exception of [placeholder] elements. From the moment the element is created\n   * and until the building phase is complete it will have \"amp-notbuilt\" CSS\n   * class set on it.\n   *\n   * This callback is executed early after the element has been attached to DOM.\n   *\n   * This callback can either immediately return or return a promise if the\n   * build steps are asynchronous.\n   *\n   * @return {!Promise|undefined}\n   */\n  buildCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Called by the framework to give the element a chance to preconnect to\n   * hosts and prefetch resources it is likely to need. May be called\n   * multiple times because connections can time out.\n   * @param {boolean=} opt_onLayout\n   * TODO(#31915): remove once R1 migration is complete.\n   */\n  preconnectCallback(opt_onLayout) {\n    // Subclasses may override.\n  }\n\n  /**\n   * Override in subclass to adjust the element when it is being added to\n   * the DOM. Could e.g. be used to add a listener. Notice, that this\n   * callback is called immediately after `buildCallback()` if the element\n   * is attached to the DOM.\n   */\n  attachedCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Override in subclass to adjust the element when it is being removed from\n   * the DOM. Could e.g. be used to remove a listener.\n   */\n  detachedCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Set itself as a container element that can be monitored by the scheduler\n   * for auto-mounting. Scheduler is used for R1 elements. A container is\n   * usually a top-level scrollable overlay such as a lightbox or a sidebar.\n   * The main scheduler (`IntersectionObserver`) cannot properly handle elements\n   * inside a non-document scroller and this method instructs the scheduler\n   * to also use the `IntersectionObserver` corresponding to the container.\n   *\n   * @param {!Element=} opt_scroller A child of the container that should be\n   * monitored. Typically a scrollable element.\n   */\n  setAsContainer(opt_scroller) {\n    this.element.setAsContainerInternal(opt_scroller);\n  }\n\n  /**\n   * Removes itself as a container. See `setAsContainer`.\n   */\n  removeAsContainer() {\n    this.element.removeAsContainerInternal();\n  }\n\n  /**\n   * Subclasses can override this method to indicate that it is has\n   * render-blocking service.\n   *\n   * The return value of this function is used to determine if the element\n   * built _and_ laid out will be prioritized.\n   * @return {boolean}\n   */\n  isBuildRenderBlocking() {\n    return false;\n  }\n\n  /**\n   * Subclasses can override this method to create a dynamic placeholder\n   * element and return it to be appended to the element. This will only\n   * be called if the element doesn't already have a placeholder.\n   * @return {?Element}\n   */\n  createPlaceholderCallback() {\n    return null;\n  }\n\n  /**\n   * Subclasses can override this method to opt-out of rendering the element\n   * when it is not currently visible.\n   * Returning a boolean allows or prevents rendering outside the viewport at\n   * any distance, while returning a positive number allows rendering only when\n   * the element is within X viewports of the current viewport. Returning a\n   * zero causes the element to only render inside the viewport.\n   * @return {boolean|number}\n   */\n  renderOutsideViewport() {\n    // Inabox allow layout independent of viewport location.\n    return getMode(this.win).runtime == 'inabox' || 3;\n  }\n\n  /**\n   * Allows for rendering outside of the constraint set by renderOutsideViewport\n   * so long task scheduler is idle.  Integer values less than those returned\n   * by renderOutsideViewport have no effect.  Subclasses can override (default\n   * is disabled).\n   * @return {boolean|number}\n   */\n  idleRenderOutsideViewport() {\n    return false;\n  }\n\n  /**\n   * Ensure that the element is being eagerly loaded.\n   *\n   * Only used for R1 elements.\n   */\n  ensureLoaded() {}\n\n  /**\n   * Update the current `readyState`.\n   *\n   * Only used for R1 elements.\n   *\n   * @param {!./ready-state.ReadyState} state\n   * @param {*=} opt_failure\n   * @final\n   */\n  setReadyState(state, opt_failure) {\n    this.element.setReadyStateInternal(state, opt_failure);\n  }\n\n  /**\n   * Load heavy elements, perform expensive operations, add global\n   * listeners/observers, etc. The mount and unmount can be called multiple\n   * times for resource management. The unmount should reverse the changes\n   * made by the mount. See `unmountCallback` for more info.\n   *\n   * If this callback returns a promise, the `readyState` becomes \"complete\"\n   * after the promise is resolved.\n   *\n   * @param {!AbortSignal=} opt_abortSignal\n   * @return {?Promise|undefined}\n   */\n  mountCallback(opt_abortSignal) {}\n\n  /**\n   * Unload heavy elements, remove global listeners, etc.\n   */\n  unmountCallback() {}\n\n  /**\n   * Subclasses can override this method to opt-in into receiving additional\n   * {@link layoutCallback} calls. Note that this method is not consulted for\n   * the first layout given that each element must be laid out at least once.\n   * @return {boolean}\n   */\n  isRelayoutNeeded() {\n    return false;\n  }\n\n  /**\n   * Called when the element should perform layout. At this point the element\n   * should load/reload resources associated with it. This method is called\n   * by the runtime and cannot be called manually. Returns promise that will\n   * complete when loading is considered to be complete.\n   *\n   * The first layout call is always called. If the subclass is interested in\n   * receiving additional callbacks, it has to opt in to do so using\n   * {@link isRelayoutNeeded} method.\n   *\n   * @return {!Promise}\n   * TODO(#31915): remove once R1 migration is complete.\n   */\n  layoutCallback() {\n    return Promise.resolve();\n  }\n\n  /**\n   * Called to notify the element that the first layout has been successfully\n   * completed.\n   *\n   * The default behavior of this method is to hide the placeholder. However,\n   * a subclass may choose to hide placeholder earlier or not hide it at all.\n   *\n   * @public\n   */\n  firstLayoutCompleted() {\n    this.togglePlaceholder(false);\n  }\n\n  /**\n   * Requests the element to stop its activity when the document goes into\n   * inactive state. The scope is up to the actual component. Among other\n   * things the active playback of video or audio content must be stopped.\n   * TODO(#31915): remove once R1 migration is complete.\n   */\n  pauseCallback() {}\n\n  /**\n   * Requests the element to resume its activity when the document returns from\n   * an inactive state. The scope is up to the actual component. Among other\n   * things the active playback of video or audio content may be resumed.\n   * TODO(#31915): remove once R1 migration is complete.\n   */\n  resumeCallback() {}\n\n  /**\n   * Requests the element to unload any expensive resources when the element\n   * goes into non-visible state. The scope is up to the actual component.\n   * The component must return `true` if it'd like to later receive\n   * {@link layoutCallback} in case document becomes active again.\n   *\n   * @return {boolean}\n   * TODO(#31915): remove once R1 migration is complete.\n   */\n  unlayoutCallback() {\n    return false;\n  }\n\n  /**\n   * Subclasses can override this method to opt-in into calling\n   * {@link unlayoutCallback} when paused.\n   * @return {boolean}\n   * TODO(#31915): remove once R1 migration is complete.\n   */\n  unlayoutOnPause() {\n    return false;\n  }\n\n  /**\n   * Whether the element needs to be reconstructed after it has been\n   * re-parented. Many elements cannot survive fully the reparenting and\n   * are better to be reconstructed from scratch.\n   *\n   * An example of an element that should be reconstructed in a iframe-based\n   * element. Reparenting such an element will cause the iframe to reload and\n   * will lost the previously established connection. It's safer to reconstruct\n   * such an element. An image or the other hand does not need to be\n   * reconstructed since image itself is not reloaded by the browser and thus\n   * there's no need to use additional resources for reconstruction.\n   *\n   * @return {boolean}\n   */\n  reconstructWhenReparented() {\n    return true;\n  }\n\n  /**\n   * Returns a promise that will resolve or fail based on the element's 'load'\n   * and 'error' events.\n   * @param {T} element\n   * @return {!Promise<T>}\n   * @template T\n   * @final\n   */\n  loadPromise(element) {\n    return loadPromise(element);\n  }\n\n  /**\n   * Registers the action handler for the method with the specified name.\n   *\n   * The handler is only invoked by events with trust equal to or greater than\n   * `minTrust`. Otherwise, a user error is logged.\n   *\n   * @param {string} alias\n   * @param {function(!./service/action-impl.ActionInvocation)} handler\n   * @param {ActionTrust} minTrust\n   * @public\n   */\n  registerAction(alias, handler, minTrust = ActionTrust.DEFAULT) {\n    initActionMap(this);\n    this['actionMap_'][alias] = {handler, minTrust};\n  }\n\n  /**\n   * Registers the default action for this component.\n   * @param {function(!./service/action-impl.ActionInvocation)} handler\n   * @param {string=} alias\n   * @param {ActionTrust=} minTrust\n   * @public\n   */\n  registerDefaultAction(\n    handler,\n    alias = DEFAULT_ACTION,\n    minTrust = ActionTrust.DEFAULT\n  ) {\n    devAssert(\n      !this['defaultActionAlias_'],\n      'Default action \"%s\" already registered.',\n      this['defaultActionAlias_']\n    );\n    this.registerAction(alias, handler, minTrust);\n    this['defaultActionAlias_'] = alias;\n  }\n\n  /**\n   * Requests the element to execute the specified method. If method must have\n   * been previously registered using {@link registerAction}, otherwise an\n   * error is thrown.\n   * @param {!./service/action-impl.ActionInvocation} invocation The invocation data.\n   * @param {boolean=} unusedDeferred Whether the invocation has had to wait any time\n   *   for the element to be resolved, upgraded and built.\n   * @final\n   * @package\n   * @return {*} TODO(#23582): Specify return type\n   */\n  executeAction(invocation, unusedDeferred) {\n    let {method} = invocation;\n    // If the default action has an alias, the handler will be stored under it.\n    if (method === DEFAULT_ACTION) {\n      method = this['defaultActionAlias_'] || method;\n    }\n    initActionMap(this);\n    const holder = this['actionMap_'][method];\n    const {tagName} = this.element;\n    userAssert(holder, `Method not found: ${method} in ${tagName}`);\n    const {handler, minTrust} = holder;\n    if (invocation.satisfiesTrust(minTrust)) {\n      return handler(invocation);\n    }\n  }\n\n  /**\n   * Utility method that propagates attributes from this element\n   * to the given element.\n   * If `opt_removeMissingAttrs` is true, then also removes any specified\n   * attributes that are missing on this element from the target element.\n   * @param {string|!Array<string>} attributes\n   * @param {!Element} element\n   * @param {boolean=} opt_removeMissingAttrs\n   * @public @final\n   */\n  propagateAttributes(attributes, element, opt_removeMissingAttrs) {\n    attributes = isArray(attributes) ? attributes : [attributes];\n    for (let i = 0; i < attributes.length; i++) {\n      const attr = attributes[i];\n      const val = this.element.getAttribute(attr);\n      if (null !== val) {\n        element.setAttribute(attr, val);\n      } else if (opt_removeMissingAttrs) {\n        element.removeAttribute(attr);\n      }\n    }\n  }\n\n  /**\n   * Utility method that forwards the given list of non-bubbling events\n   * from the given element to this element as custom events with the same name.\n   * @param  {string|!Array<string>} events\n   * @param  {!Element} element\n   * @public @final\n   * @return {!UnlistenDef}\n   */\n  forwardEvents(events, element) {\n    const unlisteners = (isArray(events) ? events : [events]).map((eventType) =>\n      listen(element, eventType, (event) => {\n        dispatchCustomEvent(this.element, eventType, getData(event) || {});\n      })\n    );\n\n    return () => unlisteners.forEach((unlisten) => unlisten());\n  }\n\n  /**\n   * Returns an optional placeholder element for this custom element.\n   * @return {?Element}\n   * @public @final\n   */\n  getPlaceholder() {\n    return this.element.getPlaceholder();\n  }\n\n  /**\n   * Hides or shows the placeholder, if available.\n   * @param {boolean} state\n   * @public @final\n   */\n  togglePlaceholder(state) {\n    this.element.togglePlaceholder(state);\n  }\n\n  /**\n   * Returns an optional fallback element for this custom element.\n   * @return {?Element}\n   * @public @final\n   */\n  getFallback() {\n    return this.element.getFallback();\n  }\n\n  /**\n   * Hides or shows the fallback, if available. This function must only\n   * be called inside a mutate context.\n   * @param {boolean} state\n   * @public @final\n   */\n  toggleFallback(state) {\n    this.element.toggleFallback(state);\n  }\n\n  /**\n   * Hides or shows the loading indicator.\n   * @param {boolean} state\n   * @param {boolean=} force\n   * @public @final\n   */\n  toggleLoading(state, force = false) {\n    this.element.toggleLoading(state, force);\n  }\n\n  /**\n   * Returns an optional overflow element for this custom element.\n   * @return {?Element}\n   * @public @final\n   */\n  getOverflowElement() {\n    return this.element.getOverflowElement();\n  }\n\n  /**\n   * An implementation can call this method to signal to the element that\n   * it has started rendering.\n   */\n  renderStarted() {\n    this.element.renderStarted();\n  }\n\n  /**\n   * Returns the original nodes of the custom element without any service nodes\n   * that could have been added for markup. These nodes can include Text,\n   * Comment and other child nodes.\n   * @return {!Array<!Node>}\n   * @public @final\n   */\n  getRealChildNodes() {\n    return this.element.getRealChildNodes();\n  }\n\n  /**\n   * Returns the original children of the custom element without any service\n   * nodes that could have been added for markup.\n   * @return {!Array<!Element>}\n   * @public @final\n   */\n  getRealChildren() {\n    return this.element.getRealChildren();\n  }\n\n  /**\n   * Configures the supplied element to have a \"fill content\" layout. The\n   * exact interpretation of \"fill content\" depends on the element's layout.\n   *\n   * If `opt_replacedContent` is specified, it indicates whether the \"replaced\n   * content\" styling should be applied. Replaced content is not allowed to\n   * have its own paddings or border.\n   *\n   * @param {!Element} element\n   * @param {boolean=} opt_replacedContent\n   * @public @final\n   */\n  applyFillContent(element, opt_replacedContent) {\n    element.classList.add('i-amphtml-fill-content');\n    if (opt_replacedContent) {\n      element.classList.add('i-amphtml-replaced-content');\n    }\n  }\n\n  /**\n   * Returns the viewport within which the element operates.\n   * @return {!./service/viewport/viewport-interface.ViewportInterface}\n   */\n  getViewport() {\n    return Services.viewportForDoc(this.getAmpDoc());\n  }\n\n  /**\n   * Returns the layout rectangle used for when calculating this element's\n   * intersection with the viewport.\n   * @return {!./layout-rect.LayoutRectDef}\n   */\n  getIntersectionElementLayoutBox() {\n    return this.getLayoutBox();\n  }\n\n  /**\n   * Collapses the element, setting it to `display: none`, and notifies its\n   * owner (if there is one) through {@link collapsedCallback} that the element\n   * is no longer visible.\n   */\n  collapse() {\n    Services.mutatorForDoc(this.getAmpDoc()).collapseElement(this.element);\n  }\n\n  /**\n   * Return a promise that request the runtime to collapse one element\n   * @return {!Promise}\n   */\n  attemptCollapse() {\n    return Services.mutatorForDoc(this.getAmpDoc()).attemptCollapse(\n      this.element\n    );\n  }\n\n  /**\n   * Requests the runtime to update the height of this element to the specified\n   * value. The runtime will schedule this request and attempt to process it\n   * as soon as possible.\n   * @param {number} newHeight\n   * @public\n   */\n  forceChangeHeight(newHeight) {\n    Services.mutatorForDoc(this.getAmpDoc()).forceChangeSize(\n      this.element,\n      newHeight,\n      /* newWidth */ undefined\n    );\n  }\n\n  /**\n   * Return a promise that requests the runtime to update\n   * the height of this element to the specified value.\n   * The runtime will schedule this request and attempt to process it\n   * as soon as possible. However, unlike in {@link forceChangeHeight}, the runtime\n   * may refuse to make a change in which case it will show the element's\n   * overflow element if provided, which is supposed to provide the reader with\n   * the necessary user action. (The overflow element is shown only if the\n   * requested height is greater than 0.)\n   * The promise is resolved if the height is successfully updated.\n   * @param {number} newHeight\n   * @return {!Promise}\n   * @public\n   */\n  attemptChangeHeight(newHeight) {\n    return Services.mutatorForDoc(this.getAmpDoc()).requestChangeSize(\n      this.element,\n      newHeight,\n      /* newWidth */ undefined\n    );\n  }\n\n  /**\n   * Return a promise that requests the runtime to update\n   * the size of this element to the specified value.\n   * The runtime will schedule this request and attempt to process it\n   * as soon as possible. However, unlike in {@link changeSize}, the runtime\n   * may refuse to make a change in which case it will show the element's\n   * overflow element if provided, which is supposed to provide the reader with\n   * the necessary user action. (The overflow element is shown only if the\n   * requested height is greater than 0.)\n   * The promise is resolved if the height is successfully updated.\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {?Event=} opt_event\n   * @return {!Promise}\n   * @public\n   */\n  attemptChangeSize(newHeight, newWidth, opt_event) {\n    return Services.mutatorForDoc(this.getAmpDoc()).requestChangeSize(\n      this.element,\n      newHeight,\n      newWidth,\n      /* newMargin */ undefined,\n      opt_event\n    );\n  }\n\n  /**\n   * Runs the specified measure, which is called in the \"measure\" vsync phase.\n   * This is simply a proxy to the privileged vsync service.\n   *\n   * @param {function()} measurer\n   * @return {!Promise}\n   */\n  measureElement(measurer) {\n    return Services.mutatorForDoc(this.getAmpDoc()).measureElement(measurer);\n  }\n\n  /**\n   * Runs the specified mutation on the element and ensures that remeasures and\n   * layouts are performed for the affected elements.\n   *\n   * This method should be called whenever a significant mutations are done\n   * on the DOM that could affect layout of elements inside this subtree or\n   * its siblings. The top-most affected element should be specified as the\n   * first argument to this method and all the mutation work should be done\n   * in the mutator callback which is called in the \"mutation\" vsync phase.\n   *\n   * @param {function()} mutator\n   * @param {Element=} opt_element\n   * @return {!Promise}\n   */\n  mutateElement(mutator, opt_element) {\n    return this.measureMutateElement(null, mutator, opt_element);\n  }\n\n  /**\n   * Runs the specified measure, then runs the mutation on the element and\n   * ensures that remeasures and layouts are performed for the affected\n   * elements.\n   *\n   * This method should be called whenever a measure and significant mutations\n   * are done on the DOM that could affect layout of elements inside this\n   * subtree or its siblings. The top-most affected element should be specified\n   * as the first argument to this method and all the mutation work should be\n   * done in the mutator callback which is called in the \"mutation\" vsync phase.\n   *\n   * @param {?function()} measurer\n   * @param {function()} mutator\n   * @param {Element=} opt_element\n   * @return {!Promise}\n   */\n  measureMutateElement(measurer, mutator, opt_element) {\n    return Services.mutatorForDoc(this.getAmpDoc()).measureMutateElement(\n      opt_element || this.element,\n      measurer,\n      mutator\n    );\n  }\n\n  /**\n   * Runs the specified mutation on the element. Will not cause remeasurements.\n   * Only use this function when the mutations will not affect any resource sizes.\n   *\n   * @param {function()} mutator\n   * @return {!Promise}\n   */\n  mutateElementSkipRemeasure(mutator) {\n    return Services.mutatorForDoc(this.getAmpDoc()).mutateElement(\n      this.element,\n      mutator,\n      /* skipRemeasure */ true\n    );\n  }\n\n  /**\n   * Called every time an owned AmpElement collapses itself.\n   * See {@link collapse}.\n   * @param {!AmpElement} unusedElement Child element that was collapsed.\n   */\n  collapsedCallback(unusedElement) {\n    // Subclasses may override.\n  }\n\n  /**\n   * Expands the element, resetting its default display value, and notifies its\n   * owner (if there is one) through {@link expandedCallback} that the element\n   * is no longer visible.\n   */\n  expand() {\n    Services.mutatorForDoc(this.getAmpDoc()).expandElement(this.element);\n  }\n\n  /**\n   * Called when one or more attributes are mutated.\n   * Note:\n   * - Must be called inside a mutate context.\n   * - Boolean attributes have a value of `true` and `false` when\n   *       present and missing, respectively.\n   * @param {\n   *   !JsonObject<string, (null|boolean|string|number|Array|Object)>\n   * } unusedMutations\n   */\n  mutatedAttributesCallback(unusedMutations) {\n    // Subclasses may override.\n  }\n\n  /**\n   * Called when we just measured the layout rect of this element. Doing\n   * more expensive style reads should now be cheap.\n   * This may currently not work with extended elements. Please file\n   * an issue if that is required.\n   * @public\n   * TODO(#31915): remove once R1 migration is complete.\n   */\n  onLayoutMeasure() {}\n\n  /**\n   * @return {./log.Log}\n   */\n  user() {\n    return user(this.element);\n  }\n\n  /**\n   * Returns this BaseElement instance. This is equivalent to Bento's\n   * imperative API object, since this is where we define the element's custom\n   * APIs.\n   *\n   * @return {!Promise<!Object>}\n   */\n  getApi() {\n    return this;\n  }\n}\n\n/**\n * This would usually be a private method on BaseElement class, but we cannot\n * use privates here. So, it's manually devirtualized into a regular function.\n *\n * @param {typeof BaseElement} baseElement\n */\nfunction initActionMap(baseElement) {\n  if (!baseElement['actionMap_']) {\n    baseElement['actionMap_'] = baseElement.win.Object.create(null);\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Commonly used signals across different elements and documents.\n * @enum {string}\n */\nexport const CommonSignals = {\n  /**\n   * The element's implementation has been registered and ready for upgrade.\n   */\n  READY_TO_UPGRADE: 'ready-upgrade',\n\n  /**\n   * The element has been upgraded from ElementStub to its real implementation.\n   */\n  UPGRADED: 'upgraded',\n\n  /**\n   * The element has been built.\n   */\n  BUILT: 'built',\n\n  /**\n   * The element has been mounted.\n   */\n  MOUNTED: 'mounted',\n\n  /**\n   * The element has started loading.\n   * LOAD_START triggers at the start of the layoutCallback.\n   */\n  LOAD_START: 'load-start',\n\n  /**\n   * Rendering has been confirmed to have been started.\n   * It is a signal to indicate meaningful display (e.g. text could be displayed\n   * CSS is correctly installed/applied).\n   *\n   * Elements can optionally implement RENDER_START signal. (e.g. ad, shadowdoc)\n   * if it want to define its own meaningful display time and toggle visibility.\n   *\n   * Simpler elements's RENDER_START can be equal to the start of the\n   * buildCallback\n   */\n  RENDER_START: 'render-start',\n\n  /**\n   * The element has been loaded.\n   * LOAD_END triggers at the end of the layoutCallback.\n   *\n   */\n  LOAD_END: 'load-end',\n\n  /**\n   * The initial contents of an element/document/embed have been loaded.\n   * INI_LOAD is an optional signal, implemented by ads, story, and elements\n   * that consist of other resources.\n   * It instructs that all critical resources has been loaded, and can be used\n   * for more accurate visibility measurement.\n   * When an element doesn't consist multiple child resources, LOAD_END signal\n   * can be used to indicate resource load completion.\n   * Note: Based on the implementation, INI_LOAD can trigger before or after\n   * LOAD_END.\n   */\n  INI_LOAD: 'ini-load',\n\n  /**\n   * The element has been unlaid out.\n   */\n  UNLOAD: 'unload',\n};\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Visibility state of the AMP document.\n * @enum {string}\n */\nexport const VisibilityState = {\n  /**\n   * The AMP document is being pre-rendered before being shown.\n   */\n  PRERENDER: 'prerender',\n\n  /**\n   * The AMP document is currently active and visible.\n   */\n  VISIBLE: 'visible',\n\n  /**\n   * The AMP document is active but the browser tab or AMP app is not.\n   */\n  HIDDEN: 'hidden',\n\n  /**\n   * The AMP document is visible, but the user has started swiping away from\n   * it. The runtime may stop active playback.\n   */\n  PAUSED: 'paused',\n\n  /**\n   * The AMP document is no longer active because the user swiped away or\n   * closed the viewer. The document may become visible again later.\n   */\n  INACTIVE: 'inactive',\n};\n", "/**\n* @license\n* Copyright (c) 2014 The Polymer Project Authors. All rights reserved.\n* Use of this source code is governed by a BSD-style\n* license that can be found in the LICENSE file or at\n* https://developers.google.com/open-source/licenses/bsd\n*/\n\n/*\n  This is a limited shim for ShadowDOM css styling.\n  https://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html#styles\n\n  The intention here is to support only the styling features which can be\n  relatively simply implemented. The goal is to allow users to avoid the\n  most obvious pitfalls and do so without compromising performance significantly.\n  For ShadowDOM styling that's not covered here, a set of best practices\n  can be provided that should allow users to accomplish more complex styling.\n\n  The following is a list of specific ShadowDOM styling features and a brief\n  discussion of the approach used to shim.\n\n  Shimmed features:\n\n  * :host, :host-context: ShadowDOM allows styling of the shadowRoot's host\n  element using the :host rule. To shim this feature, the :host styles are\n  reformatted and prefixed with a given scope name and promoted to a\n  document level stylesheet.\n  For example, given a scope name of .foo, a rule like this:\n\n    :host {\n        background: red;\n      }\n    }\n\n  becomes:\n\n    .foo {\n      background: red;\n    }\n\n  * encapsultion: Styles defined within ShadowDOM, apply only to\n  dom inside the ShadowDOM. Polymer uses one of two techniques to imlement\n  this feature.\n\n  By default, rules are prefixed with the host element tag name\n  as a descendant selector. This ensures styling does not leak out of the 'top'\n  of the element's ShadowDOM. For example,\n\n  div {\n      font-weight: bold;\n    }\n\n  becomes:\n\n  x-foo div {\n      font-weight: bold;\n    }\n\n  becomes:\n\n\n  Alternatively, if WebComponents.ShadowCSS.strictStyling is set to true then\n  selectors are scoped by adding an attribute selector suffix to each\n  simple selector that contains the host element tag name. Each element\n  in the element's ShadowDOM template is also given the scope attribute.\n  Thus, these rules match only elements that have the scope attribute.\n  For example, given a scope name of x-foo, a rule like this:\n\n    div {\n      font-weight: bold;\n    }\n\n  becomes:\n\n    div[x-foo] {\n      font-weight: bold;\n    }\n\n  Note that elements that are dynamically added to a scope must have the scope\n  selector added to them manually.\n\n  * upper/lower bound encapsulation: Styles which are defined outside a\n  shadowRoot should not cross the ShadowDOM boundary and should not apply\n  inside a shadowRoot.\n\n  This styling behavior is not emulated. Some possible ways to do this that\n  were rejected due to complexity and/or performance concerns include: (1) reset\n  every possible property for every possible selector for a given scope name;\n  (2) re-implement css in javascript.\n\n  As an alternative, users should make sure to use selectors\n  specific to the scope in which they are working.\n\n  * ::distributed: This behavior is not emulated. It's often not necessary\n  to style the contents of a specific insertion point and instead, descendants\n  of the host element can be styled selectively. Users can also create an\n  extra node around an insertion point and style that node's contents\n  via descendent selectors. For example, with a shadowRoot like this:\n\n    <style>\n      ::content(div) {\n        background: red;\n      }\n    </style>\n    <content></content>\n\n  could become:\n\n    <style>\n      / *@polyfill .content-container div * /\n      ::content(div) {\n        background: red;\n      }\n    </style>\n    <div class=\"content-container\">\n      <content></content>\n    </div>\n\n  Note the use of @polyfill in the comment above a ShadowDOM specific style\n  declaration. This is a directive to the styling shim to use the selector\n  in comments in lieu of the next selector when running under polyfill.\n*/\n\nexport const ShadowCSS = {\n  strictStyling: false,\n  // change a selector like 'div' to 'name div'\n  /** @this {ShadowCSS} */\n  scopeRules: function(cssRules, scopeSelector, opt_transformer) {\n    var cssText = '';\n    if (cssRules) {\n      Array.prototype.forEach.call(cssRules, function(rule) {\n        if (rule.selectorText && (rule.style && rule.style.cssText !== undefined)) {\n          cssText += this.scopeSelector(rule.selectorText, scopeSelector,\n            this.strictStyling, opt_transformer) + ' {\\n\\t';\n          cssText += this.propertiesFromRule(rule) + '\\n}\\n\\n';\n        } else if (rule.type === CSSRule.MEDIA_RULE) {\n          cssText += '@media ' + rule.media.mediaText + ' {\\n';\n          cssText += this.scopeRules(rule.cssRules, scopeSelector);\n          cssText += '\\n}\\n\\n';\n        } else {\n          // KEYFRAMES_RULE in IE throws when we query cssText\n          // when it contains a -webkit- property.\n          // if this happens, we fallback to constructing the rule\n          // from the CSSRuleSet\n          // https://connect.microsoft.com/IE/feedbackdetail/view/955703/accessing-csstext-of-a-keyframe-rule-that-contains-a-webkit-property-via-cssom-generates-exception\n          try {\n            if (rule.cssText) {\n              cssText += rule.cssText + '\\n\\n';\n            }\n          } catch(x) {\n            if (rule.type === CSSRule.KEYFRAMES_RULE && rule.cssRules) {\n              cssText += this.ieSafeCssTextFromKeyFrameRule(rule);\n            }\n          }\n        }\n      }, this);\n    }\n    return cssText;\n  },\n  /** @this {ShadowCSS} */\n  ieSafeCssTextFromKeyFrameRule: function(rule) {\n    var cssText = '@keyframes ' + rule.name + ' {';\n    Array.prototype.forEach.call(rule.cssRules, function(rule) {\n      cssText += ' ' + rule.keyText + ' {' + rule.style.cssText + '}';\n    });\n    cssText += ' }';\n    return cssText;\n  },\n  /** @this {ShadowCSS} */\n  scopeSelector: function(selector, scopeSelector, strict, opt_transformer) {\n    var r = [], parts = selector.split(',');\n    parts.forEach(function(p) {\n      p = p.trim();\n      if (opt_transformer) {\n        p = opt_transformer(p);\n      }\n      if (this.selectorNeedsScoping(p, scopeSelector)) {\n        p = (strict && !p.match(polyfillHostNoCombinator)) ?\n            this.applyStrictSelectorScope(p, scopeSelector) :\n            this.applySelectorScope(p, scopeSelector);\n      }\n      r.push(p);\n    }, this);\n    return r.join(', ');\n  },\n  /** @this {ShadowCSS} */\n  selectorNeedsScoping: function(selector, scopeSelector) {\n    if (Array.isArray(scopeSelector)) {\n      return true;\n    }\n    var re = this.makeScopeMatcher(scopeSelector);\n    return !selector.match(re);\n  },\n  /** @this {ShadowCSS} */\n  makeScopeMatcher: function(scopeSelector) {\n    scopeSelector = scopeSelector.replace(/\\[/g, '\\\\[').replace(/\\]/g, '\\\\]');\n    return new RegExp('^(' + scopeSelector + ')' + selectorReSuffix, 'm');\n  },\n  /** @this {ShadowCSS} */\n  applySelectorScope: function(selector, selectorScope) {\n    return Array.isArray(selectorScope) ?\n        this.applySelectorScopeList(selector, selectorScope) :\n        this.applySimpleSelectorScope(selector, selectorScope);\n  },\n  // apply an array of selectors\n  /** @this {ShadowCSS} */\n  applySelectorScopeList: function(selector, scopeSelectorList) {\n    var r = [];\n    for (var i=0, s; (s=scopeSelectorList[i]); i++) {\n      r.push(this.applySimpleSelectorScope(selector, s));\n    }\n    return r.join(', ');\n  },\n  // scope via name and [is=name]\n  /** @this {ShadowCSS} */\n  applySimpleSelectorScope: function(selector, scopeSelector) {\n    if (selector.match(polyfillHostRe)) {\n      selector = selector.replace(polyfillHostNoCombinator, scopeSelector);\n      return selector.replace(polyfillHostRe, scopeSelector + ' ');\n    } else {\n      return scopeSelector + ' ' + selector;\n    }\n  },\n  // return a selector with [name] suffix on each simple selector\n  // e.g. .foo.bar > .zot becomes .foo[name].bar[name] > .zot[name]\n  /** @this {ShadowCSS} */\n  applyStrictSelectorScope: function(selector, scopeSelector) {\n    scopeSelector = scopeSelector.replace(/\\[is=([^\\]]*)\\]/g, '$1');\n    var splits = [' ', '>', '+', '~'],\n      scoped = selector,\n      attrName = '[' + scopeSelector + ']';\n    splits.forEach(function(sep) {\n      var parts = scoped.split(sep);\n      scoped = parts.map(function(p) {\n        // remove :host since it should be unnecessary\n        var t = p.trim().replace(polyfillHostRe, '');\n        if (t && (splits.indexOf(t) < 0) && (t.indexOf(attrName) < 0)) {\n          p = t.replace(/([^:]*)(:*)(.*)/, '$1' + attrName + '$2$3');\n        }\n        return p;\n      }).join(sep);\n    });\n    return scoped;\n  },\n  /** @this {ShadowCSS} */\n  propertiesFromRule: function(rule) {\n    var cssText = rule.style.cssText;\n    // TODO(sorvell): Safari cssom incorrectly removes quotes from the content\n    // property. (https://bugs.webkit.org/show_bug.cgi?id=118045)\n    // don't replace attr rules\n    if (rule.style.content && !rule.style.content.match(/['\"]+|attr/)) {\n      cssText = cssText.replace(/content:[^;]*;/g, 'content: \\'' +\n          rule.style.content + '\\';');\n    }\n    // TODO(sorvell): we can workaround this issue here, but we need a list\n    // of troublesome properties to fix https://github.com/Polymer/platform/issues/53\n    //\n    // inherit rules can be omitted from cssText\n    // TODO(sorvell): remove when Blink bug is fixed:\n    // https://code.google.com/p/chromium/issues/detail?id=358273\n    var style = rule.style;\n    for (var i in style) {\n      if (style[i] === 'initial') {\n        cssText += i + ': initial; ';\n      }\n    }\n    return cssText;\n  }\n};\n\nvar selectorRe = /([^{]*)({[\\s\\S]*?})/gim,\n    cssCommentRe = /\\/\\*[^*]*\\*+([^/*][^*]*\\*+)*\\//gim,\n    // TODO(sorvell): remove either content or comment\n    cssCommentNextSelectorRe = /\\/\\*\\s*@polyfill ([^*]*\\*+([^/*][^*]*\\*+)*\\/)([^{]*?){/gim,\n    cssContentNextSelectorRe = /polyfill-next-selector[^}]*content\\:[\\s]*?['\"](.*?)['\"][;\\s]*}([^{]*?){/gim,\n    // TODO(sorvell): remove either content or comment\n    cssCommentRuleRe = /\\/\\*\\s@polyfill-rule([^*]*\\*+([^/*][^*]*\\*+)*)\\//gim,\n    cssContentRuleRe = /(polyfill-rule)[^}]*(content\\:[\\s]*['\"](.*?)['\"])[;\\s]*[^}]*}/gim,\n    // TODO(sorvell): remove either content or comment\n    cssCommentUnscopedRuleRe = /\\/\\*\\s@polyfill-unscoped-rule([^*]*\\*+([^/*][^*]*\\*+)*)\\//gim,\n    cssContentUnscopedRuleRe = /(polyfill-unscoped-rule)[^}]*(content\\:[\\s]*['\"](.*?)['\"])[;\\s]*[^}]*}/gim,\n    cssPseudoRe = /::(x-[^\\s{,(]*)/gim,\n    cssPartRe = /::part\\(([^)]*)\\)/gim,\n    // note: :host pre-processed to -shadowcsshost.\n    polyfillHost = '-shadowcsshost',\n    // note: :host-context pre-processed to -shadowcsshostcontext.\n    polyfillHostContext = '-shadowcsscontext',\n    parenSuffix = ')(?:\\\\((' +\n        '(?:\\\\([^)(]*\\\\)|[^)(]*)+?' +\n        ')\\\\))?([^,{]*)';\n    var cssColonHostRe = new RegExp('(' + polyfillHost + parenSuffix, 'gim'),\n    cssColonHostContextRe = new RegExp('(' + polyfillHostContext + parenSuffix, 'gim'),\n    selectorReSuffix = '([>\\\\s~+\\[.,{:][\\\\s\\\\S]*)?$',\n    colonHostRe = /\\:host/gim,\n    colonHostContextRe = /\\:host-context/gim,\n    /* host name without combinator */\n    polyfillHostNoCombinator = polyfillHost + '-no-combinator',\n    polyfillHostRe = new RegExp(polyfillHost, 'gim'),\n    polyfillHostContextRe = new RegExp(polyfillHostContext, 'gim'),\n    shadowDOMSelectorsRe = [\n      />>>/g,\n      /::shadow/g,\n      /::content/g,\n      // Deprecated selectors\n      /\\/deep\\//g, // former >>>\n      /\\/shadow\\//g, // former ::shadow\n      /\\/shadow-deep\\//g, // former /deep/\n      /\\^\\^/g,     // former /shadow/\n      /\\^(?!=)/g   // former /shadow-deep/\n    ];\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Possible versions of Shadow DOM spec\n * @enum {string}\n */\nexport const ShadowDomVersion = {\n  NONE: 'none',\n  V0: 'v0',\n  V1: 'v1',\n};\n\n/**\n * @type {!ShadowDomVersion|undefined}\n * @visibleForTesting\n */\nlet shadowDomSupportedVersion;\n\n/**\n * @type {boolean|undefined}\n * @visibleForTesting\n */\nlet shadowCssSupported;\n\n/**\n * @param {!ShadowDomVersion|undefined} val\n * @visibleForTesting\n */\nexport function setShadowDomSupportedVersionForTesting(val) {\n  shadowDomSupportedVersion = val;\n}\n\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\nexport function setShadowCssSupportedForTesting(val) {\n  shadowCssSupported = val;\n}\n\n/**\n * Returns `true` if the Shadow DOM is supported.\n * @return {boolean}\n */\nexport function isShadowDomSupported() {\n  return getShadowDomSupportedVersion() != ShadowDomVersion.NONE;\n}\n\n/**\n * Returns `true` if Shadow CSS encapsulation is supported.\n * @return {boolean}\n */\nexport function isShadowCssSupported() {\n  if (shadowCssSupported === undefined) {\n    shadowCssSupported =\n      isShadowDomSupported() &&\n      (isNative(Element.prototype.attachShadow) ||\n        isNative(Element.prototype.createShadowRoot));\n  }\n  return shadowCssSupported;\n}\n\n/**\n * Returns `true` if the passed function is native to the browser, and is not\n * polyfilled\n * @param {Function|undefined} func A function that is attatched to a JS\n * object.\n * @return {boolean}\n */\nfunction isNative(func) {\n  return !!func && func.toString().indexOf('[native code]') != -1;\n}\n\n/**\n * Returns the supported version of Shadow DOM spec.\n * @param {typeof Element=} opt_elementClass optional for testing\n * @return {!ShadowDomVersion}\n */\nexport function getShadowDomSupportedVersion(opt_elementClass) {\n  if (shadowDomSupportedVersion === undefined) {\n    shadowDomSupportedVersion = getShadowDomVersion(\n      opt_elementClass || Element\n    );\n  }\n  return shadowDomSupportedVersion;\n}\n\n/**\n * Returns shadow dom version.\n *\n * @param {!typeof Element} element\n * @return {!ShadowDomVersion}\n */\nfunction getShadowDomVersion(element) {\n  if (!!element.prototype.attachShadow) {\n    return ShadowDomVersion.V1;\n  } else if (!!element.prototype.createShadowRoot) {\n    return ShadowDomVersion.V0;\n  }\n  return ShadowDomVersion.NONE;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {devAssert} from './log';\nimport {getServicePromise} from './service';\n\n/**\n * A map of services that delay rendering. The key is the name of the service\n * and the value is a DOM query which is used to check if the service is needed\n * in the current document.\n * Do not add a service unless absolutely necessary.\n *\n * \\   \\  /  \\  /   / /   \\     |   _  \\     |  \\ |  | |  | |  \\ |  |  / _____|\n *  \\   \\/    \\/   / /  ^  \\    |  |_)  |    |   \\|  | |  | |   \\|  | |  |  __\n *   \\            / /  /_\\  \\   |      /     |  . `  | |  | |  . `  | |  | |_ |\n *    \\    /\\    / /  _____  \\  |  |\\  \\----.|  |\\   | |  | |  |\\   | |  |__| |\n *     \\__/  \\__/ /__/     \\__\\ | _| `._____||__| \\__| |__| |__| \\__|  \\______|\n *\n * The equivalent of this list is used for server-side rendering (SSR) and any\n * changes made to it must be made in coordination with caches that implement\n * SSR. For more information on SSR see bit.ly/amp-ssr.\n *\n * @const {!Object<string, string>}\n */\nconst SERVICES = {\n  'amp-dynamic-css-classes': '[custom-element=amp-dynamic-css-classes]',\n  'variant': 'amp-experiment',\n  'amp-story-render': 'amp-story[standalone]',\n};\n\n/**\n * Base class for render delaying services.\n * This should be extended to ensure the service\n * is properly handled\n *\n * @interface\n */\nexport class RenderDelayingService {\n  /**\n   * Function to return a promise for when\n   * it is finished delaying render, and is ready.\n   * NOTE: This should simply return Promise.resolve,\n   * if your service does not need to perform any logic\n   * after being registered.\n   * @return {!Promise}\n   */\n  whenReady() {}\n}\n\n/**\n * Maximum milliseconds to wait for all extensions to load before erroring.\n * @const\n */\nconst LOAD_TIMEOUT = 3000;\n\n/**\n * Detects any render delaying services that are required on the page, and\n * returns a promise with a timeout.\n * @param {!Window} win\n * @return {!Promise<!Array<*>>} resolves to an Array that has the same length\n *     as the detected render delaying services\n */\nexport function waitForServices(win) {\n  const promises = includedServices(win).map((serviceId) => {\n    const serviceReadyPromise = getServicePromise(win, serviceId).then(\n      (service) => {\n        if (service && isRenderDelayingService(service)) {\n          return service.whenReady().then(() => {\n            return service;\n          });\n        }\n        return service;\n      }\n    );\n\n    return Services.timerFor(win).timeoutPromise(\n      LOAD_TIMEOUT,\n      serviceReadyPromise,\n      `Render timeout waiting for service ${serviceId} to be ready.`\n    );\n  });\n  return Promise.all(promises);\n}\n\n/**\n * Returns true if the page has a render delaying service.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function hasRenderDelayingServices(win) {\n  return includedServices(win).length > 0;\n}\n\n/**\n * Function to determine if the passed\n * Object is a Render Delaying Service\n * @param {!Object} service\n * @return {boolean}\n */\nexport function isRenderDelayingService(service) {\n  const maybeRenderDelayingService = /** @type {!RenderDelayingService}*/ (\n    service\n  );\n  return typeof maybeRenderDelayingService.whenReady == 'function';\n}\n\n/**\n * Detects which, if any, render-delaying extensions are included on the page.\n * @param {!Window} win\n * @return {!Array<string>}\n */\nexport function includedServices(win) {\n  /** @const {!Document} */\n  const doc = win.document;\n  devAssert(doc.body);\n\n  return Object.keys(SERVICES).filter((service) => {\n    return doc.querySelector(SERVICES[service]);\n  });\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CommonSignals} from './core/constants/common-signals';\nimport {Services} from './services';\nimport {TickLabel} from './core/constants/enums';\nimport {dev, devAssert} from './log';\nimport {getAmpdoc} from './service';\nimport {insertAfterOrAtStart, waitForBodyOpenPromise} from './dom';\nimport {map} from './core/types/object';\nimport {rethrowAsync} from './core/error';\nimport {setStyles} from './style';\nimport {waitForServices} from './render-delaying-services';\n\nconst TRANSFORMER_PROP = '__AMP_CSS_TR';\nconst STYLE_MAP_PROP = '__AMP_CSS_SM';\n\n/**\n * Adds the given css text to the given ampdoc.\n *\n * The style tags will be at the beginning of the head before all author\n * styles. One element can be the main runtime CSS. This is guaranteed\n * to always be the first stylesheet in the doc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc The ampdoc that should get the new styles.\n * @param {string} cssText\n * @param {?function(!Element)|undefined} cb Called when the new styles are available.\n *     Not using a promise, because this is synchronous when possible.\n *     for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n * @param {string=} opt_ext\n * @return {!Element}\n */\nexport function installStylesForDoc(\n  ampdoc,\n  cssText,\n  cb,\n  opt_isRuntimeCss,\n  opt_ext\n) {\n  const cssRoot = ampdoc.getHeadNode();\n  const style = insertStyleElement(\n    cssRoot,\n    maybeTransform(cssRoot, cssText),\n    opt_isRuntimeCss || false,\n    opt_ext || null\n  );\n\n  if (cb) {\n    const rootNode = ampdoc.getRootNode();\n    // Styles aren't always available synchronously. E.g. if there is a\n    // pending style download, it will have to finish before the new\n    // style is visible.\n    // For this reason we poll until the style becomes available.\n    // Sync case.\n    if (styleLoaded(rootNode, style)) {\n      cb(style);\n      return style;\n    }\n    // Poll until styles are available.\n    const interval = setInterval(() => {\n      if (styleLoaded(rootNode, style)) {\n        clearInterval(interval);\n        cb(style);\n      }\n    }, 4);\n  }\n  return style;\n}\n\n/**\n * Creates the properly configured style element.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @param {boolean} isRuntimeCss\n * @param {?string} ext\n * @return {!Element}\n */\nfunction insertStyleElement(cssRoot, cssText, isRuntimeCss, ext) {\n  let styleMap = cssRoot[STYLE_MAP_PROP];\n  if (!styleMap) {\n    styleMap = cssRoot[STYLE_MAP_PROP] = map();\n  }\n\n  const isExtCss =\n    !isRuntimeCss && ext && ext != 'amp-custom' && ext != 'amp-keyframes';\n  const key = isRuntimeCss\n    ? 'amp-runtime'\n    : isExtCss\n    ? `amp-extension=${ext}`\n    : null;\n\n  // Check if it has already been created or discovered.\n  if (key) {\n    const existing = getExistingStyleElement(cssRoot, styleMap, key);\n    if (existing) {\n      if (existing.textContent !== cssText) {\n        existing.textContent = cssText;\n      }\n      return existing;\n    }\n  }\n\n  // Create the new style element and append to cssRoot.\n  const doc = cssRoot.ownerDocument || cssRoot;\n  const style = doc.createElement('style');\n  style./*OK*/ textContent = cssText;\n  let afterElement = null;\n  // Make sure that we place style tags after the main runtime CSS. Otherwise\n  // the order is random.\n  if (isRuntimeCss) {\n    style.setAttribute('amp-runtime', '');\n  } else if (isExtCss) {\n    style.setAttribute('amp-extension', ext || '');\n    afterElement = dev().assertElement(\n      getExistingStyleElement(cssRoot, styleMap, 'amp-runtime')\n    );\n  } else {\n    if (ext) {\n      style.setAttribute(ext, '');\n    }\n    afterElement = cssRoot.lastChild;\n  }\n  insertAfterOrAtStart(cssRoot, style, afterElement);\n  if (key) {\n    styleMap[key] = style;\n  }\n  return style;\n}\n\n/**\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {!Object<string, !Element>} styleMap\n * @param {string} key\n * @return {?Element}\n */\nfunction getExistingStyleElement(cssRoot, styleMap, key) {\n  // Already cached.\n  if (styleMap[key]) {\n    return styleMap[key];\n  }\n  // Check if the style has already been added by the server layout.\n  const existing = cssRoot./*OK*/ querySelector(`style[${key}]`);\n  if (existing) {\n    styleMap[key] = existing;\n    return existing;\n  }\n  // Nothing found.\n  return null;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {function(string):string} transformer\n */\nexport function installCssTransformer(cssRoot, transformer) {\n  cssRoot[TRANSFORMER_PROP] = transformer;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @return {string}\n */\nfunction maybeTransform(cssRoot, cssText) {\n  const transformer = cssRoot[TRANSFORMER_PROP];\n  return transformer ? transformer(cssText) : cssText;\n}\n\n/** @private {boolean} */\nlet bodyMadeVisible = false;\n\n/**\n * @param {boolean} value\n * @visibleForTesting\n */\nexport function setBodyMadeVisibleForTesting(value) {\n  bodyMadeVisible = value;\n}\n\n/**\n * Sets the document's body opacity to 1.\n * If the body is not yet available (because our script was loaded\n * synchronously), polls until it is.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisible(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  const win = /** @type {!Window} */ (doc.defaultView);\n  waitForBodyOpenPromise(doc)\n    .then(() => {\n      return waitForServices(win);\n    })\n    .catch((reason) => {\n      rethrowAsync(reason);\n      return [];\n    })\n    .then((services) => {\n      bodyMadeVisible = true;\n      if (INI_LOAD_INOB) {\n        // Force sync measurement to ensure that style recalc is complete\n        // before showing body, which would trigger FCP. This should reduce\n        // make it less likely that a CLS would be triggered after FCP.\n        doc.body./*OK*/ getBoundingClientRect();\n      }\n      setBodyVisibleStyles(doc);\n      const ampdoc = getAmpdoc(doc);\n      ampdoc.signals().signal(CommonSignals.RENDER_START);\n      if (services.length > 0) {\n        const resources = Services.resourcesForDoc(doc.documentElement);\n        resources./*OK*/ schedulePass(1, /* relayoutAll */ true);\n      }\n      try {\n        const perf = Services.performanceFor(win);\n        perf.tick(TickLabel.MAKE_BODY_VISIBLE);\n        perf.flush();\n      } catch (e) {}\n    });\n}\n\n/**\n * Set the document's body opacity to 1. Called in error cases.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisibleRecovery(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  if (bodyMadeVisible) {\n    return;\n  }\n  bodyMadeVisible = true;\n  setBodyVisibleStyles(doc);\n}\n\n/**\n * Make sure that body exists, and make it visible.\n * @param {!Document} doc\n */\nfunction setBodyVisibleStyles(doc) {\n  setStyles(dev().assertElement(doc.body), {\n    opacity: 1,\n    visibility: 'visible',\n    'animation': 'none',\n  });\n}\n\n/**\n * Indicates that the body is always visible. For instance, in case of PWA.\n * This check is on a module level variable, and could be problematic if you are\n * relying on this function across different binaries.\n * @param {!Window} unusedWin\n */\nexport function bodyAlwaysVisible(unusedWin) {\n  bodyMadeVisible = true;\n}\n\n/**\n * Checks whether a style element was registered in the DOM.\n * @param {!Document|!ShadowRoot} doc\n * @param {!Element} style\n * @return {boolean}\n */\nfunction styleLoaded(doc, style) {\n  const sheets = doc.styleSheets;\n  for (let i = 0; i < sheets.length; i++) {\n    const sheet = sheets[i];\n    if (sheet.ownerNode == style) {\n      return true;\n    }\n  }\n  return false;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {DomWriterBulk, DomWriterStreamer} from './utils/dom-writer';\nimport {Services} from './services';\nimport {ShadowCSS} from '../third_party/webcomponentsjs/ShadowCSS';\nimport {\n  ShadowDomVersion,\n  getShadowDomSupportedVersion,\n  isShadowCssSupported,\n} from './core/dom/web-components';\nimport {dev, devAssert} from './log';\nimport {escapeCssSelectorIdent} from './core/dom/css-selectors';\nimport {installCssTransformer} from './style-installer';\nimport {iterateCursor} from './dom';\nimport {setInitialDisplay, setStyle} from './style';\nimport {toArray} from './core/types/array';\nimport {toWin} from './core/window';\n\n/** @const {!RegExp} */\nconst CSS_SELECTOR_BEG_REGEX = /[^\\.\\-\\_0-9a-zA-Z]/;\n\n/** @const {!RegExp} */\nconst CSS_SELECTOR_END_REGEX = /[^\\-\\_0-9a-zA-Z]/;\n\nconst SHADOW_CSS_CACHE = '__AMP_SHADOW_CSS';\n\n/**\n * @type {boolean|undefined}\n */\nlet shadowDomStreamingSupported;\n\n/**\n * Creates a shadow root for the specified host and returns it. Polyfills\n * shadow root creation if necessary.\n * @param {!Element} hostElement\n * @return {!ShadowRoot}\n */\nexport function createShadowRoot(hostElement) {\n  const win = toWin(hostElement.ownerDocument.defaultView);\n\n  const existingRoot = hostElement.shadowRoot || hostElement.__AMP_SHADOW_ROOT;\n  if (existingRoot) {\n    existingRoot./*OK*/ innerHTML = '';\n    return existingRoot;\n  }\n\n  let shadowRoot;\n  const shadowDomSupported = getShadowDomSupportedVersion();\n  if (shadowDomSupported == ShadowDomVersion.V1) {\n    shadowRoot = hostElement.attachShadow({mode: 'open'});\n    if (!shadowRoot.styleSheets) {\n      Object.defineProperty(shadowRoot, 'styleSheets', {\n        get: function () {\n          const items = [];\n          iterateCursor(shadowRoot.childNodes, (child) => {\n            if (child.tagName === 'STYLE') {\n              items.push(child.sheet);\n            }\n          });\n          return items;\n        },\n      });\n    }\n  } else if (shadowDomSupported == ShadowDomVersion.V0) {\n    shadowRoot = hostElement.createShadowRoot();\n  } else {\n    shadowRoot = createShadowRootPolyfill(hostElement);\n  }\n\n  if (!isShadowCssSupported()) {\n    const rootId = `i-amphtml-sd-${win.Math.floor(win.Math.random() * 10000)}`;\n    shadowRoot['id'] = rootId;\n    shadowRoot.host.classList.add(rootId);\n\n    // CSS isolation.\n    installCssTransformer(shadowRoot, (css) => {\n      return transformShadowCss(shadowRoot, css);\n    });\n  }\n\n  return shadowRoot;\n}\n\n/**\n * Shadow root polyfill.\n * @param {!Element} hostElement\n * @return {!ShadowRoot}\n */\nfunction createShadowRootPolyfill(hostElement) {\n  const doc = hostElement.ownerDocument;\n\n  // Host CSS polyfill.\n  hostElement.classList.add('i-amphtml-shadow-host-polyfill');\n  const hostStyle = doc.createElement('style');\n  hostStyle.textContent =\n    '.i-amphtml-shadow-host-polyfill>:not(i-amphtml-shadow-root)' +\n    '{display:none!important}';\n  hostElement.appendChild(hostStyle);\n\n  // Shadow root.\n  const shadowRoot /** @type {!ShadowRoot} */ =\n    // Cast to ShadowRoot even though it is an Element\n    // TODO(@dvoytenko) Consider to switch to a type union instead.\n    /** @type {?}  */ (doc.createElement('i-amphtml-shadow-root'));\n  hostElement.appendChild(shadowRoot);\n  hostElement.__AMP_SHADOW_ROOT = shadowRoot;\n  Object.defineProperty(hostElement, 'shadowRoot', {\n    enumerable: true,\n    configurable: true,\n    value: shadowRoot,\n  });\n\n  // API: https://www.w3.org/TR/shadow-dom/#the-shadowroot-interface\n\n  shadowRoot.host = hostElement;\n\n  // `getElementById` is resolved via `querySelector('#id')`.\n  shadowRoot.getElementById = function (id) {\n    const escapedId = escapeCssSelectorIdent(id);\n    return /** @type {?HTMLElement} */ (\n      shadowRoot./*OK*/ querySelector(`#${escapedId}`)\n    );\n  };\n\n  // The styleSheets property should have a list of local styles.\n  Object.defineProperty(shadowRoot, 'styleSheets', {\n    get: () => {\n      if (!doc.styleSheets) {\n        return [];\n      }\n      return toArray(doc.styleSheets).filter((styleSheet) =>\n        shadowRoot.contains(styleSheet.ownerNode)\n      );\n    },\n  });\n\n  return shadowRoot;\n}\n\n/**\n * Imports a body into a shadow root with the workaround for a polyfill case.\n * @param {!ShadowRoot} shadowRoot\n * @param {!Element} body\n * @param {boolean} deep\n * @return {!Element}\n */\nexport function importShadowBody(shadowRoot, body, deep) {\n  const doc = shadowRoot.ownerDocument;\n  let resultBody;\n  if (isShadowCssSupported()) {\n    resultBody = dev().assertElement(doc.importNode(body, deep));\n  } else {\n    resultBody = doc.createElement('amp-body');\n    setInitialDisplay(resultBody, 'block');\n    for (let i = 0; i < body.attributes.length; i++) {\n      resultBody.setAttribute(\n        body.attributes[0].name,\n        body.attributes[0].value\n      );\n    }\n    if (deep) {\n      for (let n = body.firstChild; !!n; n = n.nextSibling) {\n        resultBody.appendChild(doc.importNode(n, true));\n      }\n    }\n  }\n  setStyle(resultBody, 'position', 'relative');\n  const oldBody = shadowRoot['body'];\n  if (oldBody) {\n    shadowRoot.removeChild(oldBody);\n  }\n  shadowRoot.appendChild(resultBody);\n  Object.defineProperty(shadowRoot, 'body', {\n    configurable: true,\n    value: resultBody,\n  });\n  return resultBody;\n}\n\n/**\n * If necessary, transforms CSS to isolate AMP CSS within the shaodw root and\n * reduce the possibility of high-level conflicts.\n * @param {!ShadowRoot} shadowRoot\n * @param {string} css\n * @return {string}\n */\nexport function transformShadowCss(shadowRoot, css) {\n  return scopeShadowCss(shadowRoot, css);\n}\n\n/**\n * Transforms CSS to isolate AMP CSS within the shadow root and reduce the\n * possibility of high-level conflicts. There are two types of transformations:\n * 1. Root transformation: `body` -> `amp-body`, etc.\n * 2. Scoping: `a {}` -> `.i-amphtml-sd-123 a {}`.\n *\n * @param {!ShadowRoot} shadowRoot\n * @param {string} css\n * @return {string}\n * @visibleForTesting\n */\nexport function scopeShadowCss(shadowRoot, css) {\n  const id = devAssert(shadowRoot['id']);\n  const doc = shadowRoot.ownerDocument;\n  let rules = null;\n  // Try to use a separate document.\n  try {\n    rules = getStylesheetRules(doc.implementation.createHTMLDocument(''), css);\n  } catch (e) {\n    // Ignore.\n  }\n  // Try to use the current document.\n  if (!rules) {\n    try {\n      rules = getStylesheetRules(doc, css);\n    } catch (e) {\n      // Ignore.\n    }\n  }\n\n  // No rules could be parsed - return css as is.\n  if (!rules) {\n    return css;\n  }\n\n  // Patch selectors.\n  // Invoke `ShadowCSS.scopeRules` via `call` because the way it uses `this`\n  // internally conflicts with Closure compiler's advanced optimizations.\n  const {scopeRules} = ShadowCSS;\n  return scopeRules.call(ShadowCSS, rules, `.${id}`, transformRootSelectors);\n}\n\n/**\n * Replaces top-level selectors such as `html` and `body` with their polyfill\n * counterparts: `amp-html` and `amp-body`.\n * @param {string} selector\n * @return {string}\n */\nfunction transformRootSelectors(selector) {\n  return selector.replace(/(html|body)/g, rootSelectorPrefixer);\n}\n\n/**\n * See `transformRootSelectors`.\n * @param {string} match\n * @param {string} name\n * @param {number} pos\n * @param {string} selector\n * @return {string}\n * @private\n */\nfunction rootSelectorPrefixer(match, name, pos, selector) {\n  const prev = selector.charAt(pos - 1);\n  const next = selector.charAt(pos + match.length);\n  if (\n    (!prev || CSS_SELECTOR_BEG_REGEX.test(prev)) &&\n    (!next || CSS_SELECTOR_END_REGEX.test(next))\n  ) {\n    return 'amp-' + match;\n  }\n  return match;\n}\n\n/**\n * @param {!Document} doc\n * @param {string} css\n * @return {?CSSRuleList}\n */\nfunction getStylesheetRules(doc, css) {\n  const style = /** @type {!HTMLStyleElement} */ (doc.createElement('style'));\n  style./*OK*/ textContent = css;\n  try {\n    (doc.head || doc.documentElement).appendChild(style);\n    if (style.sheet) {\n      return /** @type {!CSSStyleSheet} */ (style.sheet).cssRules;\n    }\n    return null;\n  } finally {\n    if (style.parentNode) {\n      style.parentNode.removeChild(style);\n    }\n  }\n}\n\n/**\n * @param {!ShadowRoot} shadowRoot\n * @param {string} name\n * @param {string} cssText\n */\nexport function installShadowStyle(shadowRoot, name, cssText) {\n  const doc = shadowRoot.ownerDocument;\n  const win = toWin(doc.defaultView);\n  if (\n    shadowRoot.adoptedStyleSheets !== undefined &&\n    win.CSSStyleSheet.prototype.replaceSync !== undefined\n  ) {\n    const cache = win[SHADOW_CSS_CACHE] || (win[SHADOW_CSS_CACHE] = {});\n    let styleSheet = cache[name];\n    if (!styleSheet) {\n      styleSheet = new win.CSSStyleSheet();\n      styleSheet.replaceSync(cssText);\n      cache[name] = styleSheet;\n    }\n    shadowRoot.adoptedStyleSheets =\n      shadowRoot.adoptedStyleSheets.concat(styleSheet);\n  } else {\n    const styleEl = doc.createElement('style');\n    styleEl.setAttribute('data-name', name);\n    styleEl.textContent = cssText;\n    shadowRoot.appendChild(styleEl);\n  }\n}\n\n/**\n * @param {!Window} win\n * @visibleForTesting\n */\nexport function resetShadowStyleCacheForTesting(win) {\n  win[SHADOW_CSS_CACHE] = null;\n}\n\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\nexport function setShadowDomStreamingSupportedForTesting(val) {\n  shadowDomStreamingSupported = val;\n}\n\n/**\n * Returns `true` if the Shadow DOM streaming is supported.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isShadowDomStreamingSupported(win) {\n  if (shadowDomStreamingSupported === undefined) {\n    shadowDomStreamingSupported = calcShadowDomStreamingSupported(win);\n  }\n  return shadowDomStreamingSupported;\n}\n\n/**\n * @param {!Window} win\n * @return {boolean}\n */\nfunction calcShadowDomStreamingSupported(win) {\n  // API must be supported.\n  if (\n    !win.document.implementation ||\n    typeof win.document.implementation.createHTMLDocument != 'function'\n  ) {\n    return false;\n  }\n  // Firefox does not support DOM streaming.\n  // See: https://bugzilla.mozilla.org/show_bug.cgi?id=867102\n  if (Services.platformFor(win).isFirefox()) {\n    return false;\n  }\n  // Assume full streaming support.\n  return true;\n}\n\n/**\n * Creates the Shadow DOM writer available on this platform.\n * @param {!Window} win\n * @return {!./utils/dom-writer.DomWriter}\n */\nexport function createShadowDomWriter(win) {\n  if (isShadowDomStreamingSupported(win)) {\n    return new DomWriterStreamer(win);\n  }\n  return new DomWriterBulk(win);\n}\n", "export const cssText = \"[hidden]{display:none!important}.i-amphtml-element{display:inline-block}.i-amphtml-blurry-placeholder{transition:opacity 0.3s cubic-bezier(0.0,0.0,0.2,1)!important;pointer-events:none}[layout=nodisplay]:not(.i-amphtml-element){display:none!important}.i-amphtml-layout-fixed,[layout=fixed][width][height]:not(.i-amphtml-layout-fixed){display:inline-block;position:relative}.i-amphtml-layout-responsive,[layout=responsive][width][height]:not(.i-amphtml-layout-responsive),[width][height][heights]:not([layout]):not(.i-amphtml-layout-responsive),[width][height][sizes]:not(img):not([layout]):not(.i-amphtml-layout-responsive){display:block;position:relative}.i-amphtml-layout-intrinsic,[layout=intrinsic][width][height]:not(.i-amphtml-layout-intrinsic){display:inline-block;position:relative;max-width:100%}.i-amphtml-layout-intrinsic .i-amphtml-sizer{max-width:100%}.i-amphtml-intrinsic-sizer{max-width:100%;display:block!important}.i-amphtml-layout-container,.i-amphtml-layout-fixed-height,[layout=container],[layout=fixed-height][height]:not(.i-amphtml-layout-fixed-height){display:block;position:relative}.i-amphtml-layout-fill,.i-amphtml-layout-fill.i-amphtml-notbuilt,[layout=fill]:not(.i-amphtml-layout-fill),body noscript>*{display:block;overflow:hidden!important;position:absolute;top:0;left:0;bottom:0;right:0}body noscript>*{position:absolute!important;width:100%;height:100%;z-index:2}body noscript{display:inline!important}.i-amphtml-layout-flex-item,[layout=flex-item]:not(.i-amphtml-layout-flex-item){display:block;position:relative;-ms-flex:1 1 auto;flex:1 1 auto}.i-amphtml-layout-fluid{position:relative}.i-amphtml-layout-size-defined{overflow:hidden!important}.i-amphtml-layout-awaiting-size{position:absolute!important;top:auto!important;bottom:auto!important}i-amphtml-sizer{display:block!important}@supports (aspect-ratio:1/1){i-amphtml-sizer.i-amphtml-disable-ar{display:none!important}}.i-amphtml-blurry-placeholder,.i-amphtml-fill-content{display:block;height:0;max-height:100%;max-width:100%;min-height:100%;min-width:100%;width:0;margin:auto}.i-amphtml-layout-size-defined .i-amphtml-fill-content{position:absolute;top:0;left:0;bottom:0;right:0}.i-amphtml-replaced-content,.i-amphtml-screen-reader{padding:0!important;border:none!important}.i-amphtml-screen-reader{position:fixed!important;top:0px!important;left:0px!important;width:4px!important;height:4px!important;opacity:0!important;overflow:hidden!important;margin:0!important;display:block!important;visibility:visible!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:8px!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:12px!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:16px!important}.i-amphtml-unresolved{position:relative;overflow:hidden!important}.i-amphtml-select-disabled{-webkit-user-select:none!important;-ms-user-select:none!important;user-select:none!important}.i-amphtml-notbuilt,[layout]:not(.i-amphtml-element),[width][height][heights]:not([layout]):not(.i-amphtml-element),[width][height][sizes]:not(img):not([layout]):not(.i-amphtml-element){position:relative;overflow:hidden!important;color:transparent!important}.i-amphtml-notbuilt:not(.i-amphtml-layout-container)>*,[layout]:not([layout=container]):not(.i-amphtml-element)>*,[width][height][heights]:not([layout]):not(.i-amphtml-element)>*,[width][height][sizes]:not([layout]):not(.i-amphtml-element)>*{display:none}amp-img:not(.i-amphtml-element)[i-amphtml-ssr]>img.i-amphtml-fill-content{display:block}.i-amphtml-notbuilt:not(.i-amphtml-layout-container),[layout]:not([layout=container]):not(.i-amphtml-element),[width][height][heights]:not([layout]):not(.i-amphtml-element),[width][height][sizes]:not(img):not([layout]):not(.i-amphtml-element){color:transparent!important;line-height:0!important}.i-amphtml-ghost{visibility:hidden!important}.i-amphtml-element>[placeholder],[layout]:not(.i-amphtml-element)>[placeholder],[width][height][heights]:not([layout]):not(.i-amphtml-element)>[placeholder],[width][height][sizes]:not([layout]):not(.i-amphtml-element)>[placeholder]{display:block;line-height:normal}.i-amphtml-element>[placeholder].amp-hidden,.i-amphtml-element>[placeholder].hidden{visibility:hidden}.i-amphtml-element:not(.amp-notsupported)>[fallback],.i-amphtml-layout-container>[placeholder].amp-hidden,.i-amphtml-layout-container>[placeholder].hidden{display:none}.i-amphtml-layout-size-defined>[fallback],.i-amphtml-layout-size-defined>[placeholder]{position:absolute!important;top:0!important;left:0!important;right:0!important;bottom:0!important;z-index:1}amp-img.i-amphtml-ssr:not(.i-amphtml-element)>[placeholder]{z-index:auto}.i-amphtml-notbuilt>[placeholder]{display:block!important}.i-amphtml-hidden-by-media-query{display:none!important}.i-amphtml-element-error{background:red!important;color:#fff!important;position:relative!important}.i-amphtml-element-error:before{content:attr(error-message)}i-amp-scroll-container,i-amphtml-scroll-container{position:absolute;top:0;left:0;right:0;bottom:0;display:block}i-amp-scroll-container.amp-active,i-amphtml-scroll-container.amp-active{overflow:auto;-webkit-overflow-scrolling:touch}.i-amphtml-loading-container{display:block!important;pointer-events:none;z-index:1}.i-amphtml-notbuilt>.i-amphtml-loading-container{display:block!important}.i-amphtml-loading-container.amp-hidden{visibility:hidden}.i-amphtml-element>[overflow]{cursor:pointer;position:relative;z-index:2;visibility:hidden;display:initial;line-height:normal}.i-amphtml-layout-size-defined>[overflow]{position:absolute}.i-amphtml-element>[overflow].amp-visible{visibility:visible}template{display:none!important}.amp-border-box,.amp-border-box *,.amp-border-box :after,.amp-border-box :before{box-sizing:border-box}amp-pixel{display:none!important}amp-analytics,amp-auto-ads,amp-story-auto-ads{position:fixed!important;top:0!important;width:1px!important;height:1px!important;overflow:hidden!important;visibility:hidden}html.i-amphtml-fie>amp-analytics{position:initial!important}[visible-when-invalid]:not(.visible),form [submit-error],form [submit-success],form [submitting]{display:none}amp-accordion{display:block!important}@media (min-width:1px){:where(amp-accordion>section)>:first-child{margin:0;background-color:#efefef;padding-right:20px;border:1px solid #dfdfdf}:where(amp-accordion>section)>:last-child{margin:0}}amp-accordion>section{float:none!important}amp-accordion>section>*{float:none!important;display:block!important;overflow:hidden!important;position:relative!important}amp-accordion,amp-accordion>section{margin:0}amp-accordion:not(.i-amphtml-built)>section>:last-child{display:none!important}amp-accordion:not(.i-amphtml-built)>section[expanded]>:last-child{display:block!important}\\n/*# sourceURL=/css/ampshared.css*/\"", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @enum {number}\n */\nexport const KeyCodes = {\n  ENTER: 13,\n  ESCAPE: 27,\n  SPACE: 32,\n  LEFT_ARROW: 37,\n  UP_ARROW: 38,\n  RIGHT_ARROW: 39,\n  DOWN_ARROW: 40,\n};\n\n/**\n * @enum {string}\n */\nexport const Keys = {\n  ENTER: 'Enter',\n  ESCAPE: 'Escape',\n  SPACE: ' ',\n  LEFT_ARROW: 'ArrowLeft',\n  UP_ARROW: 'ArrowUp',\n  RIGHT_ARROW: 'ArrowRight',\n  DOWN_ARROW: 'ArrowDown',\n  TAB: 'Tab',\n  BACKSPACE: 'Backspace',\n  HOME: 'Home',\n  END: 'End',\n};\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Checks that the document is of an AMP format type.\n * @param {!Array<string>} formats\n * @param {!Document} doc\n * @return {boolean}\n */\nfunction isAmpFormatType(formats, doc) {\n  const html = doc.documentElement;\n  const isFormatType = formats.some((format) => html.hasAttribute(format));\n  return isFormatType;\n}\n\n/**\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isAmp4Email(doc) {\n  return isAmpFormatType(['\u26A14email', 'amp4email'], doc);\n}\n\n/**\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isAmphtml(doc) {\n  return isAmpFormatType(['\u26A1', 'amp'], doc);\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Common AMP events.\n * @enum {string}\n */\nexport const AmpEvents = {\n  DOM_UPDATE: 'amp:dom-update',\n  FORM_DIRTINESS_CHANGE: 'amp:form-dirtiness-change',\n  FORM_VALUE_CHANGE: 'amp:form-value-change',\n  VISIBILITY_CHANGE: 'amp:visibilitychange', // https://github.com/ampproject/amphtml/blob/main/ads/README.md#page-visibility\n  // The following codes are only used for testing.\n  // TODO(choumx): Move these to a separate enum so they can be DCE'd.\n  ATTACHED: 'amp:attached',\n  STUBBED: 'amp:stubbed',\n  LOAD_START: 'amp:load-start',\n  LOAD_END: 'amp:load-end',\n  ERROR: 'amp:error',\n  SIZE_CHANGED: 'amp:size-changed',\n  UNLOAD: 'amp:unload',\n};\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {number=} opt_base Exponential base. Defaults to 2.\n * @return {function(function()): number} Function that when invoked will\n *     call the passed in function. On every invocation the next\n *     invocation of the passed in function will be exponentially\n *     later. Returned function returns timeout id.\n */\nexport function exponentialBackoff(opt_base) {\n  const getTimeout = exponentialBackoffClock(opt_base);\n  return (work) => {\n    return setTimeout(work, getTimeout());\n  };\n}\n\n/**\n * @param {number=} opt_base Exponential base. Defaults to 2.\n * @return {function(): number} Function that when invoked will return\n *    a number that exponentially grows per invocation.\n */\nexport function exponentialBackoffClock(opt_base) {\n  const base = opt_base || 2;\n  let count = 0;\n  return () => {\n    let wait = Math.pow(base, count++);\n    wait += getJitter(wait);\n    return wait * 1000;\n  };\n}\n\n/**\n * Add jitter to avoid the thundering herd. This can e.g. happen when\n * we poll a backend and it fails for everyone at the same time.\n * We add up to 30% (default) longer or shorter than the given time.\n *\n * @param {number} wait the amount if base milliseconds\n * @param {number=} opt_perc the min/max percentage to add or sutract\n * @return {number}\n */\nexport function getJitter(wait, opt_perc) {\n  opt_perc = opt_perc || 0.3;\n  let jitter = wait * opt_perc * Math.random();\n  if (Math.random() > 0.5) {\n    jitter *= -1;\n  }\n  return jitter;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {dict} from './core/types/object';\n\n/**\n * Helper method to trigger analytics event if amp-analytics is available.\n * TODO: Do not expose this function\n * @param {!Element} target\n * @param {string} eventType\n * @param {!JsonObject} vars A map of vars and their values.\n * @param {boolean} enableDataVars A boolean to indicate if data-vars-*\n * attribute value from target element should be included.\n */\nexport function triggerAnalyticsEvent(\n  target,\n  eventType,\n  vars = dict(),\n  enableDataVars = true\n) {\n  Services.analyticsForDocOrNull(target).then((analytics) => {\n    if (!analytics) {\n      return;\n    }\n    analytics.triggerEventForTarget(target, eventType, vars, enableDataVars);\n  });\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {AmpEvents} from './core/constants/amp-events';\nimport {Services} from './services';\nimport {\n  USER_ERROR_SENTINEL,\n  dev,\n  isUserErrorEmbed,\n  isUserErrorMessage,\n} from './log';\nimport {dict} from './core/types/object';\nimport {duplicateErrorIfNecessary} from './core/error';\nimport {experimentTogglesOrNull, getBinaryType, isCanary} from './experiments';\nimport {exponentialBackoff} from './core/types/function/exponential-backoff';\nimport {findIndex} from './core/types/array';\nimport {getMode} from './mode';\nimport {isLoadErrorMessage} from './event-helper';\nimport {isProxyOrigin} from './url';\nimport {makeBodyVisibleRecovery} from './style-installer';\nimport {triggerAnalyticsEvent} from './analytics';\nimport {urls} from './config';\n\n/**\n * @const {string}\n */\nconst CANCELLED = 'CANCELLED';\n\n/**\n * @const {string}\n */\nconst BLOCK_BY_CONSENT = 'BLOCK_BY_CONSENT';\n\n/**\n * @const {string}\n */\nconst ABORTED = 'AbortError';\n\n/**\n * The threshold for errors throttled because nothing can be done about\n * them, but we'd still like to report the rough number.\n * @const {number}\n */\nconst NON_ACTIONABLE_ERROR_THROTTLE_THRESHOLD = 0.001;\n\n/**\n * The threshold for errors throttled because nothing can be done about\n * them, but we'd still like to report the rough number.\n * @const {number}\n */\nconst USER_ERROR_THROTTLE_THRESHOLD = 0.1;\n\n/**\n * Chance to post to the new error reporting endpoint.\n * @const {number}\n */\nconst BETA_ERROR_REPORT_URL_FREQ = 0.1;\n\n/**\n * Collects error messages, so they can be included in subsequent reports.\n * That allows identifying errors that might be caused by previous errors.\n */\nlet accumulatedErrorMessages = self.__AMP_ERRORS || [];\n// Use a true global, to avoid multi-module inclusion issues.\nself.__AMP_ERRORS = accumulatedErrorMessages;\n\n/**\n * Pushes element into array, keeping at most the most recent limit elements\n *\n * @param {!Array<T>} array\n * @param {T} element\n * @param {number} limit\n * @template T\n */\nfunction pushLimit(array, element, limit) {\n  if (array.length >= limit) {\n    array.splice(0, array.length - limit + 1);\n  }\n  array.push(element);\n}\n\n/**\n * A wrapper around our exponentialBackoff, to lazy initialize it to avoid an\n * un-DCE'able side-effect.\n * @param {function()} work the function to execute after backoff\n * @return {number} the setTimeout id\n */\nlet reportingBackoff = function (work) {\n  // Set reportingBackoff as the lazy-created function. JS Vooodoooo.\n  reportingBackoff = exponentialBackoff(1.5);\n  return reportingBackoff(work);\n};\n\n/**\n * Attempts to stringify a value, falling back to String.\n * @param {*} value\n * @return {string}\n */\nfunction tryJsonStringify(value) {\n  try {\n    // Cast is fine, because we really don't care here. Just trying.\n    return JSON.stringify(/** @type {!JsonObject} */ (value));\n  } catch (e) {\n    return String(value);\n  }\n}\n\n/**\n * @param {!Window} win\n * @param {*} error\n * @param {!Element=} opt_associatedElement\n */\nexport function reportErrorForWin(win, error, opt_associatedElement) {\n  reportError(error, opt_associatedElement);\n  if (\n    error &&\n    !!win &&\n    isUserErrorMessage(error.message) &&\n    !isUserErrorEmbed(error.message)\n  ) {\n    reportErrorToAnalytics(/** @type {!Error} */ (error), win);\n  }\n}\n\n/**\n * Reports an error. If the error has an \"associatedElement\" property\n * the element is marked with the `i-amphtml-element-error` and displays\n * the message itself. The message is always send to the console.\n * If the error has a \"messageArray\" property, that array is logged.\n * This way one gets the native fidelity of the console for things like\n * elements instead of stringification.\n * @param {*} error\n * @param {!Element=} opt_associatedElement\n * @return {!Error}\n */\nexport function reportError(error, opt_associatedElement) {\n  try {\n    // Convert error to the expected type.\n    let isValidError;\n    if (error) {\n      if (error.message !== undefined) {\n        error = duplicateErrorIfNecessary(/** @type {!Error} */ (error));\n        isValidError = true;\n      } else {\n        const origError = error;\n        error = new Error(tryJsonStringify(origError));\n        error.origError = origError;\n      }\n    } else {\n      error = new Error('Unknown error');\n    }\n    // Report if error is not an expected type.\n    if (!isValidError && getMode().localDev && !getMode().test) {\n      setTimeout(function () {\n        const rethrow = new Error(\n          '_reported_ Error reported incorrectly: ' + error\n        );\n        throw rethrow;\n      });\n    }\n\n    if (error.reported) {\n      return /** @type {!Error} */ (error);\n    }\n    error.reported = true;\n\n    // `associatedElement` is used to add the i-amphtml-error class; in\n    // `#development=1` mode, it also adds `i-amphtml-element-error` to the\n    // element and sets the `error-message` attribute.\n    if (error.messageArray) {\n      const elIndex = findIndex(error.messageArray, (item) => item?.tagName);\n      if (elIndex > -1) {\n        error.associatedElement = error.messageArray[elIndex];\n      }\n    }\n    // Update element.\n    const element = opt_associatedElement || error.associatedElement;\n    if (element && element.classList) {\n      element.classList.add('i-amphtml-error');\n      if (getMode().development) {\n        element.classList.add('i-amphtml-element-error');\n        element.setAttribute('error-message', error.message);\n      }\n    }\n\n    // Report to console.\n    if (\n      self.console &&\n      (isUserErrorMessage(error.message) ||\n        !error.expected ||\n        getMode().localDev)\n    ) {\n      const output = console.error || console.log;\n      if (error.messageArray) {\n        output.apply(console, error.messageArray);\n      } else {\n        if (element) {\n          output.call(console, error.message, element);\n        } else if (!getMode().minified) {\n          output.call(console, error.stack);\n        } else {\n          output.call(console, error.message);\n        }\n      }\n    }\n    if (element && element.dispatchCustomEventForTesting) {\n      element.dispatchCustomEventForTesting(AmpEvents.ERROR, error.message);\n    }\n\n    // 'call' to make linter happy. And .call to make compiler happy\n    // that expects some @this.\n    onError['call'](self, undefined, undefined, undefined, undefined, error);\n  } catch (errorReportingError) {\n    setTimeout(function () {\n      throw errorReportingError;\n    });\n  }\n  return /** @type {!Error} */ (error);\n}\n\n/**\n * Returns an error for a cancellation of a promise.\n * @return {!Error}\n */\nexport function cancellation() {\n  return new Error(CANCELLED);\n}\n\n/**\n * @param {*} errorOrMessage\n * @return {boolean}\n */\nexport function isCancellation(errorOrMessage) {\n  if (!errorOrMessage) {\n    return false;\n  }\n  if (typeof errorOrMessage == 'string') {\n    return errorOrMessage.startsWith(CANCELLED);\n  }\n  if (typeof errorOrMessage.message == 'string') {\n    return errorOrMessage.message.startsWith(CANCELLED);\n  }\n  return false;\n}\n\n/**\n * Returns an error for component blocked by consent\n * @return {!Error}\n */\nexport function blockedByConsentError() {\n  return new Error(BLOCK_BY_CONSENT);\n}\n\n/**\n * @param {*} errorOrMessage\n * @return {boolean}\n */\nexport function isBlockedByConsent(errorOrMessage) {\n  if (!errorOrMessage) {\n    return false;\n  }\n  if (typeof errorOrMessage == 'string') {\n    return errorOrMessage.startsWith(BLOCK_BY_CONSENT);\n  }\n  if (typeof errorOrMessage.message == 'string') {\n    return errorOrMessage.message.startsWith(BLOCK_BY_CONSENT);\n  }\n  return false;\n}\n\n/**\n * Install handling of global unhandled exceptions.\n * @param {!Window} win\n */\nexport function installErrorReporting(win) {\n  win.onerror = /** @type {!Function} */ (onError);\n  win.addEventListener('unhandledrejection', (event) => {\n    if (\n      event.reason &&\n      (event.reason.message === CANCELLED ||\n        event.reason.message === BLOCK_BY_CONSENT ||\n        event.reason.message === ABORTED)\n    ) {\n      event.preventDefault();\n      return;\n    }\n    reportError(event.reason || new Error('rejected promise ' + event));\n  });\n}\n\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {*|undefined} error\n * @this {!Window|undefined}\n */\nfunction onError(message, filename, line, col, error) {\n  // Make an attempt to unhide the body but don't if the error is actually expected.\n  // eslint-disable-next-line local/no-invalid-this\n  if (this && this.document && (!error || !error.expected)) {\n    // eslint-disable-next-line local/no-invalid-this\n    makeBodyVisibleRecovery(this.document);\n  }\n  if (getMode().localDev || getMode().development || getMode().test) {\n    return;\n  }\n  let hasNonAmpJs = false;\n  try {\n    hasNonAmpJs = detectNonAmpJs(self);\n  } catch (ignore) {\n    // Ignore errors during error report generation.\n  }\n  if (hasNonAmpJs && Math.random() > 0.01) {\n    // Only report 1% of errors on pages with non-AMP JS.\n    // These errors can almost never be acted upon, but spikes such as\n    // due to buggy browser extensions may be helpful to notify authors.\n    return;\n  }\n  const data = getErrorReportData(\n    message,\n    filename,\n    line,\n    col,\n    error,\n    hasNonAmpJs\n  );\n  if (data) {\n    reportingBackoff(() => {\n      try {\n        return reportErrorToServerOrViewer(\n          // eslint-disable-next-line local/no-invalid-this\n          this,\n          /** @type {!JsonObject} */\n          (data)\n        ).catch(() => {\n          // catch async errors to avoid recursive errors.\n        });\n      } catch (e) {\n        // catch async errors to avoid recursive errors.\n      }\n    });\n  }\n}\n\n/**\n * Determines the error reporting endpoint which should be used.\n * If changing this URL, keep `docs/spec/amp-errors.md` in sync.\n * @return {string} error reporting endpoint URL.\n */\nfunction chooseReportingUrl_() {\n  return Math.random() < BETA_ERROR_REPORT_URL_FREQ\n    ? urls.betaErrorReporting\n    : urls.errorReporting;\n}\n\n/**\n * Passes the given error data to either server or viewer.\n * @param {!Window} win\n * @param {!JsonObject} data Data from `getErrorReportData`.\n * @return {Promise<undefined>}\n */\nexport function reportErrorToServerOrViewer(win, data) {\n  // Report the error to viewer if it has the capability. The data passed\n  // to the viewer is exactly the same as the data passed to the server\n  // below.\n\n  // Throttle reports from Stable by 90%.\n  if (data['pt'] && Math.random() < 0.9) {\n    return Promise.resolve();\n  }\n\n  return maybeReportErrorToViewer(win, data).then((reportedErrorToViewer) => {\n    if (!reportedErrorToViewer) {\n      const xhr = new XMLHttpRequest();\n      xhr.open('POST', chooseReportingUrl_(), true);\n      xhr.send(JSON.stringify(data));\n    }\n  });\n}\n\n/**\n * Passes the given error data to the viewer if the following criteria is met:\n * - The viewer is a trusted viewer\n * - The viewer has the `errorReporter` capability\n * - The AMP doc is in single doc mode\n * - The AMP doc is opted-in for error interception (`<html>` tag has the\n *   `report-errors-to-viewer` attribute)\n *\n * @param {!Window} win\n * @param {!JsonObject} data Data from `getErrorReportData`.\n * @return {!Promise<boolean>} `Promise<True>` if the error was sent to the\n *     viewer, `Promise<False>` otherwise.\n * @visibleForTesting\n */\nexport function maybeReportErrorToViewer(win, data) {\n  const ampdocService = Services.ampdocServiceFor(win);\n  if (!ampdocService.isSingleDoc()) {\n    return Promise.resolve(false);\n  }\n  const ampdocSingle = ampdocService.getSingleDoc();\n  const htmlElement = ampdocSingle.getRootNode().documentElement;\n  const docOptedIn = htmlElement.hasAttribute('report-errors-to-viewer');\n  if (!docOptedIn) {\n    return Promise.resolve(false);\n  }\n  const viewer = Services.viewerForDoc(ampdocSingle);\n  if (!viewer.hasCapability('errorReporter')) {\n    return Promise.resolve(false);\n  }\n  return viewer.isTrustedViewer().then((viewerTrusted) => {\n    if (!viewerTrusted) {\n      return false;\n    }\n    viewer.sendMessage('error', errorReportingDataForViewer(data));\n    return true;\n  });\n}\n\n/**\n * Strips down the error reporting data to a minimal set\n * to be sent to the viewer.\n * @param {!JsonObject} errorReportData\n * @return {!JsonObject}\n * @visibleForTesting\n */\nexport function errorReportingDataForViewer(errorReportData) {\n  return dict({\n    'm': errorReportData['m'], // message\n    'a': errorReportData['a'], // isUserError\n    's': errorReportData['s'], // error stack\n    'el': errorReportData['el'], // tagName\n    'ex': errorReportData['ex'], // expected error?\n    'v': errorReportData['v'], // runtime\n    'pt': errorReportData['pt'], // is pre-throttled\n  });\n}\n\n/**\n * @param {string|undefined}  message\n * @param {*|undefined} error\n * @return {string}\n */\nfunction buildErrorMessage_(message, error) {\n  if (error) {\n    if (error.message) {\n      message = error.message;\n    } else {\n      // This should never be a string, but sometimes it is.\n      message = String(error);\n    }\n  }\n  if (!message) {\n    message = 'Unknown error';\n  }\n\n  return message;\n}\n\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {*|undefined} error\n * @param {boolean} hasNonAmpJs\n * @return {!JsonObject|undefined} The data to post\n * visibleForTesting\n */\nexport function getErrorReportData(\n  message,\n  filename,\n  line,\n  col,\n  error,\n  hasNonAmpJs\n) {\n  message = buildErrorMessage_(message, error);\n  // An \"expected\" error is still an error, i.e. some features are disabled\n  // or not functioning fully because of it. However, it's an expected\n  // error. E.g. as is the case with some browser API missing (storage).\n  // Thus, the error can be classified differently by log aggregators.\n  // The main goal is to monitor that an \"expected\" error doesn't deteriorate\n  // over time. It's impossible to completely eliminate it.\n  let expected = !!(error && error.expected);\n  if (/_reported_/.test(message)) {\n    return;\n  }\n  if (message == CANCELLED) {\n    return;\n  }\n\n  const detachedWindow = !(self && self.window);\n  const throttleBase = Math.random();\n\n  // We throttle load errors and generic \"Script error.\" errors\n  // that have no information and thus cannot be acted upon.\n  if (\n    isLoadErrorMessage(message) ||\n    // See https://github.com/ampproject/amphtml/issues/7353\n    // for context.\n    message == 'Script error.' ||\n    // Window has become detached, really anything can happen\n    // at this point.\n    detachedWindow\n  ) {\n    expected = true;\n\n    if (throttleBase > NON_ACTIONABLE_ERROR_THROTTLE_THRESHOLD) {\n      return;\n    }\n  }\n\n  const isUserError = isUserErrorMessage(message);\n\n  // Only report a subset of user errors.\n  if (isUserError && throttleBase > USER_ERROR_THROTTLE_THRESHOLD) {\n    return;\n  }\n\n  // This is the App Engine app in\n  // https://github.com/ampproject/error-tracker\n  // It stores error reports via https://cloud.google.com/error-reporting/\n  // for analyzing production issues.\n  const data = /** @type {!JsonObject} */ (Object.create(null));\n  data['v'] = getMode().rtvVersion;\n  data['noAmp'] = hasNonAmpJs ? '1' : '0';\n  data['m'] = message.replace(USER_ERROR_SENTINEL, '');\n  data['a'] = isUserError ? '1' : '0';\n\n  // Errors are tagged with \"ex\" (\"expected\") label to allow loggers to\n  // classify these errors as benchmarks and not exceptions.\n  data['ex'] = expected ? '1' : '0';\n  data['dw'] = detachedWindow ? '1' : '0';\n\n  let runtime = '1p';\n  if (IS_SXG) {\n    runtime = 'sxg';\n    data['sxg'] = '1';\n  } else if (IS_ESM) {\n    runtime = 'esm';\n    data['esm'] = '1';\n  } else if (self.context && self.context.location) {\n    data['3p'] = '1';\n    runtime = '3p';\n  } else if (getMode().runtime) {\n    runtime = getMode().runtime;\n  }\n\n  data['rt'] = runtime;\n\n  // Add our a4a id if we are inabox\n  if (runtime === 'inabox') {\n    data['adid'] = getMode().a4aId;\n  }\n\n  // TODO(erwinm): Remove ca when all systems read `bt` instead of `ca` to\n  // identify js binary type.\n  data['ca'] = isCanary(self) ? '1' : '0';\n\n  // Pass binary type.\n  data['bt'] = getBinaryType(self);\n\n  if (self.location.ancestorOrigins && self.location.ancestorOrigins[0]) {\n    data['or'] = self.location.ancestorOrigins[0];\n  }\n  if (self.viewerState) {\n    data['vs'] = self.viewerState;\n  }\n  // Is embedded?\n  if (self.parent && self.parent != self) {\n    data['iem'] = '1';\n  }\n\n  if (self.AMP && self.AMP.viewer) {\n    const resolvedViewerUrl = self.AMP.viewer.getResolvedViewerUrl();\n    const messagingOrigin = self.AMP.viewer.maybeGetMessagingOrigin();\n    if (resolvedViewerUrl) {\n      data['rvu'] = resolvedViewerUrl;\n    }\n    if (messagingOrigin) {\n      data['mso'] = messagingOrigin;\n    }\n  }\n\n  const exps = [];\n  const experiments = experimentTogglesOrNull(self);\n  for (const exp in experiments) {\n    const on = experiments[exp];\n    exps.push(`${exp}=${on ? '1' : '0'}`);\n  }\n  data['exps'] = exps.join(',');\n\n  if (error) {\n    data['el'] = error.associatedElement?.tagName || 'u'; // Unknown\n\n    if (error.args) {\n      data['args'] = JSON.stringify(error.args);\n    }\n\n    if (!isUserError && !error.ignoreStack && error.stack) {\n      data['s'] = error.stack;\n    }\n\n    // TODO(jridgewell, #18574); Make sure error is always an object.\n    if (error.message) {\n      error.message += ' _reported_';\n    }\n  } else {\n    data['f'] = filename || '';\n    data['l'] = line || '';\n    data['c'] = col || '';\n  }\n  data['r'] = self.document ? self.document.referrer : '';\n  data['ae'] = accumulatedErrorMessages.join(',');\n  data['fr'] = self.location['originalHash'] || self.location.hash;\n\n  // TODO(https://github.com/ampproject/error-tracker/issues/129): Remove once\n  // all clients are serving a version with pre-throttling.\n  if (data['bt'] === 'production') {\n    // Setting this field allows the error reporting service to know that this\n    // error has already been pre-throttled for Stable, so it doesn't need to\n    // throttle again.\n    data['pt'] = '1';\n  }\n\n  pushLimit(accumulatedErrorMessages, message, 25);\n\n  return data;\n}\n\n/**\n * Returns true if it appears like there is non-AMP JS on the\n * current page.\n * @param {!Window} win\n * @return {boolean}\n * @visibleForTesting\n */\nexport function detectNonAmpJs(win) {\n  if (!win.document) {\n    return false;\n  }\n  const scripts = win.document.querySelectorAll('script[src]');\n  for (let i = 0; i < scripts.length; i++) {\n    if (!isProxyOrigin(scripts[i].src.toLowerCase())) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Resets accumulated error messages for testing\n */\nexport function resetAccumulatedErrorMessagesForTesting() {\n  accumulatedErrorMessages = [];\n}\n\n/**\n * @param {!Error} error\n * @param {!Window} win\n */\nexport function reportErrorToAnalytics(error, win) {\n  // Currently this can only be executed in a single-doc mode. Otherwise,\n  // it's not clear which ampdoc the event would belong too.\n  if (Services.ampdocServiceFor(win).isSingleDoc()) {\n    const vars = dict({\n      'errorName': error.name,\n      'errorMessage': error.message,\n    });\n    triggerAnalyticsEvent(\n      getRootElement_(win),\n      'user-error',\n      vars,\n      /** enableDataVars */ false\n    );\n  }\n}\n\n/**\n * @param {!Window} win\n * @return {!Element}\n * @private\n */\nfunction getRootElement_(win) {\n  const root = Services.ampdocServiceFor(win).getSingleDoc().getRootNode();\n  return dev().assertElement(root.documentElement || root.body || root);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ActionTrust,\n  DEFAULT_ACTION,\n  RAW_OBJECT_ARGS_KEY,\n  actionTrustToString,\n} from '../core/constants/action-constants';\nimport {Keys} from '../core/constants/key-codes';\nimport {Services} from '../services';\nimport {debounce, throttle} from '../core/types/function';\nimport {dev, devAssert, user, userAssert} from '../log';\nimport {dict, getValueForExpr, hasOwn, map} from '../core/types/object';\nimport {getDetail} from '../event-helper';\nimport {getMode} from '../mode';\nimport {isAmp4Email} from '../format';\nimport {isArray, toArray} from '../core/types/array';\nimport {isEnabled} from '../dom';\nimport {isFiniteNumber} from '../core/types';\nimport {registerServiceBuilderForDoc} from '../service';\nimport {reportError} from '../error-reporting';\nimport {toWin} from '../core/window';\n\n/** @const {string} */\nconst TAG_ = 'Action';\n\n/** @const {string} */\nconst ACTION_MAP_ = '__AMP_ACTION_MAP__' + Math.random();\n\n/** @const {string} */\nconst ACTION_QUEUE_ = '__AMP_ACTION_QUEUE__';\n\n/** @const {string} */\nconst ACTION_HANDLER_ = '__AMP_ACTION_HANDLER__';\n\n/** @const {number} */\nconst DEFAULT_DEBOUNCE_WAIT = 300; // ms\n\n/** @const {number} */\nconst DEFAULT_THROTTLE_INTERVAL = 100; // ms\n\n/** @const {!Object<string,!Array<string>>} */\nconst NON_AMP_ELEMENTS_ACTIONS_ = {\n  'form': ['submit', 'clear'],\n};\n\nconst DEFAULT_EMAIL_ALLOWLIST = [\n  {tagOrTarget: 'AMP', method: 'setState'},\n  {tagOrTarget: '*', method: 'focus'},\n  {tagOrTarget: '*', method: 'hide'},\n  {tagOrTarget: '*', method: 'show'},\n  {tagOrTarget: '*', method: 'toggleClass'},\n  {tagOrTarget: '*', method: 'toggleVisibility'},\n];\n\n/**\n * Interactable widgets which should trigger tap events when the user clicks\n * or activates via the keyboard. Not all are here, e.g. progressbar, tabpanel,\n * since they are text inputs, readonly, or composite widgets that shouldn't\n * need to trigger tap events from spacebar or enter on their own.\n * See https://www.w3.org/TR/wai-aria-1.1/#widget_roles\n * @const {!Object<boolean>}\n */\nexport const TAPPABLE_ARIA_ROLES = {\n  'button': true,\n  'checkbox': true,\n  'link': true,\n  'listbox': true,\n  'menuitem': true,\n  'menuitemcheckbox': true,\n  'menuitemradio': true,\n  'option': true,\n  'radio': true,\n  'scrollbar': true,\n  'slider': true,\n  'spinbutton': true,\n  'switch': true,\n  'tab': true,\n  'treeitem': true,\n};\n\n/**\n * An expression arg value, e.g. `foo.bar` in `e:t.m(arg=foo.bar)`.\n * @typedef {{expression: string}}\n */\nlet ActionInfoArgExpressionDef;\n\n/**\n * An arg value.\n * @typedef {(boolean|number|string|ActionInfoArgExpressionDef)}\n */\nlet ActionInfoArgValueDef;\n\n/**\n * Map of arg names to their values, e.g. {arg: 123} in `e:t.m(arg=123)`.\n * @typedef {Object<string, ActionInfoArgValueDef>}\n */\nlet ActionInfoArgsDef;\n\n/**\n * @typedef {{\n *   event: string,\n *   target: string,\n *   method: string,\n *   args: ?ActionInfoArgsDef,\n *   str: string\n * }}\n */\nexport let ActionInfoDef;\n\n/**\n * Function called when an action is invoked.\n *\n * Optionally, takes this action's position within all actions triggered by\n * the same event, as well as said action array, as params.\n *\n * If the action is chainable, returns a Promise which resolves when the\n * action is complete. Otherwise, returns null.\n *\n * @typedef {function(!ActionInvocation, number=, !Array<!ActionInfoDef>=):?Promise}\n */\nlet ActionHandlerDef;\n\n/**\n * @typedef {Event|DeferredEvent}\n */\nexport let ActionEventDef;\n\n/**\n * The structure that contains all details of the action method invocation.\n * @struct @const @package For type.\n */\nexport class ActionInvocation {\n  /**\n   * For example:\n   *\n   *   <div id=\"div\" on=\"tap:myForm.submit(foo=bar)\">\n   *     <button id=\"btn\">Submit</button>\n   *   </div>\n   *\n   * `node` is #myForm.\n   * `method` is \"submit\".\n   * `args` is {'foo': 'bar'}.\n   * `source` is #btn.\n   * `caller` is #div.\n   * `event` is a \"click\" Event object.\n   * `actionEventType` is \"tap\".\n   * `trust` depends on whether this action was a result of a user gesture.\n   * `tagOrTarget` is \"amp-form\".\n   * `sequenceId` is a pseudo-UUID.\n   *\n   * @param {!Node} node Element whose action is being invoked.\n   * @param {string} method Name of the action being invoked.\n   * @param {?JsonObject} args Named action arguments.\n   * @param {?Element} source Element that generated the `event`.\n   * @param {?Element} caller Element containing the on=\"...\" action handler.\n   * @param {?ActionEventDef} event The event object that triggered this action.\n   * @param {!ActionTrust} trust The trust level of this invocation's trigger.\n   * @param {?string} actionEventType The AMP event name that triggered this.\n   * @param {?string} tagOrTarget The global target name or the element tagName.\n   * @param {number} sequenceId An identifier for this action's sequence (all\n   *   actions triggered by one event e.g. \"tap:form1.submit, form2.submit\").\n   */\n  constructor(\n    node,\n    method,\n    args,\n    source,\n    caller,\n    event,\n    trust,\n    actionEventType = '?',\n    tagOrTarget = null,\n    sequenceId = Math.random()\n  ) {\n    /** @type {!Node} */\n    this.node = node;\n    /** @const {string} */\n    this.method = method;\n    /** @const {?JsonObject} */\n    this.args = args;\n    /** @const {?Element} */\n    this.source = source;\n    /** @const {?Element} */\n    this.caller = caller;\n    /** @const {?ActionEventDef} */\n    this.event = event;\n    /** @const {!ActionTrust} */\n    this.trust = trust;\n    /** @const {?string} */\n    this.actionEventType = actionEventType;\n    /** @const {string} */\n    this.tagOrTarget = tagOrTarget || node.tagName;\n    /** @const {number} */\n    this.sequenceId = sequenceId;\n  }\n\n  /**\n   * Returns true if the trigger event has a trust equal to or greater than\n   * `minimumTrust`. Otherwise, logs a user error and returns false.\n   * @param {ActionTrust} minimumTrust\n   * @return {boolean}\n   */\n  satisfiesTrust(minimumTrust) {\n    // Sanity check.\n    if (!isFiniteNumber(this.trust)) {\n      dev().error(TAG_, `Invalid trust for '${this.method}': ${this.trust}`);\n      return false;\n    }\n    if (this.trust < minimumTrust) {\n      const t = actionTrustToString(this.trust);\n      user().error(\n        TAG_,\n        `\"${this.actionEventType}\" event with \"${t}\" trust is not allowed to ` +\n          `invoke \"${this.tagOrTarget.toLowerCase()}.${this.method}\".`\n      );\n      return false;\n    }\n    return true;\n  }\n}\n\n/**\n * TODO(dvoytenko): consider splitting this class into two:\n * 1. A class that has a method \"trigger(element, eventType, data)\" and\n *    simply can search target in DOM and trigger methods on it.\n * 2. A class that configures event recognizers and rules and then\n *    simply calls action.trigger.\n */\nexport class ActionService {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {(!Document|!ShadowRoot)=} opt_root\n   */\n  constructor(ampdoc, opt_root) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @const {!Document|!ShadowRoot} */\n    this.root_ = opt_root || ampdoc.getRootNode();\n\n    /** @const {boolean} */\n    this.isEmail_ =\n      this.ampdoc.isSingleDoc() &&\n      isAmp4Email(/** @type {!Document} */ (this.root_));\n\n    /**\n     * Optional allowlist of actions, e.g.:\n     *\n     *     [{tagOrTarget: 'AMP', method: 'navigateTo'},\n     *      {tagOrTarget: 'AMP-FORM', method: 'submit'},\n     *      {tagOrTarget: '*', method: 'show'}]\n     *\n     * If not null, any actions that are not in the allowlist will be ignored\n     * and throw a user error at invocation time. Note that `tagOrTarget` is\n     * always the canonical uppercased form (same as\n     * `Element.prototype.tagName`). If `tagOrTarget` is the wildcard '*', then\n     * the allowlisted method is allowed on any tag or target.\n     *\n     * For AMP4Email format documents, allowed actions are autogenerated.\n     * @private {?Array<{tagOrTarget: string, method: string}>}\n     */\n    this.allowlist_ = this.isEmail_ ? DEFAULT_EMAIL_ALLOWLIST : null;\n\n    /** @const @private {!Object<string, ActionHandlerDef>} */\n    this.globalTargets_ = map();\n\n    /**\n     * @const @private {!Object<string, {handler: ActionHandlerDef, minTrust: ActionTrust}>}\n     */\n    this.globalMethodHandlers_ = map();\n\n    // Add core events.\n    this.addEvent('tap');\n    this.addEvent('submit');\n    this.addEvent('change');\n    this.addEvent('input-debounced');\n    this.addEvent('input-throttled');\n    this.addEvent('valid');\n    this.addEvent('invalid');\n  }\n\n  /**\n   * @param {string} name\n   * TODO(dvoytenko): switch to a system where the event recognizers are\n   * registered with Action instead, e.g. \"doubletap\", \"tap to zoom\".\n   */\n  addEvent(name) {\n    if (name == 'tap') {\n      // TODO(dvoytenko): if needed, also configure touch-based tap, e.g. for\n      // fast-click.\n      this.root_.addEventListener('click', (event) => {\n        if (!event.defaultPrevented) {\n          const element = dev().assertElement(event.target);\n          this.trigger(element, name, event, ActionTrust.HIGH);\n        }\n      });\n      this.root_.addEventListener('keydown', (event) => {\n        const {key, target} = event;\n        const element = dev().assertElement(target);\n        if (key == Keys.ENTER || key == Keys.SPACE) {\n          const role = element.getAttribute('role');\n          const isTapEventRole =\n            role && hasOwn(TAPPABLE_ARIA_ROLES, role.toLowerCase());\n          if (!event.defaultPrevented && isTapEventRole) {\n            const hasAction = this.trigger(\n              element,\n              name,\n              event,\n              ActionTrust.HIGH\n            );\n            // Only if the element has an action do we prevent the default.\n            // In the absence of an action, e.g. on=\"[event].method\", we do not\n            // want to stop default behavior.\n            if (hasAction) {\n              event.preventDefault();\n            }\n          }\n        }\n      });\n    } else if (name == 'submit') {\n      this.root_.addEventListener(name, (event) => {\n        const element = dev().assertElement(event.target);\n        // For get requests, the delegating to the viewer needs to happen\n        // before this.\n        this.trigger(element, name, event, ActionTrust.HIGH);\n      });\n    } else if (name == 'change') {\n      this.root_.addEventListener(name, (event) => {\n        const element = dev().assertElement(event.target);\n        this.addTargetPropertiesAsDetail_(event);\n        this.trigger(element, name, event, ActionTrust.HIGH);\n      });\n    } else if (name == 'input-debounced') {\n      const debouncedInput = debounce(\n        this.ampdoc.win,\n        (event) => {\n          const target = dev().assertElement(event.target);\n          this.trigger(\n            target,\n            name,\n            /** @type {!ActionEventDef} */ (event),\n            ActionTrust.HIGH\n          );\n        },\n        DEFAULT_DEBOUNCE_WAIT\n      );\n\n      this.root_.addEventListener('input', (event) => {\n        // Create a DeferredEvent to avoid races where the browser cleans up\n        // the event object before the async debounced function is called.\n        const deferredEvent = new DeferredEvent(event);\n        this.addTargetPropertiesAsDetail_(deferredEvent);\n        debouncedInput(deferredEvent);\n      });\n    } else if (name == 'input-throttled') {\n      const throttledInput = throttle(\n        this.ampdoc.win,\n        (event) => {\n          const target = dev().assertElement(event.target);\n          this.trigger(\n            target,\n            name,\n            /** @type {!ActionEventDef} */ (event),\n            ActionTrust.HIGH\n          );\n        },\n        DEFAULT_THROTTLE_INTERVAL\n      );\n\n      this.root_.addEventListener('input', (event) => {\n        const deferredEvent = new DeferredEvent(event);\n        this.addTargetPropertiesAsDetail_(deferredEvent);\n        throttledInput(deferredEvent);\n      });\n    } else if (name == 'valid' || name == 'invalid') {\n      this.root_.addEventListener(name, (event) => {\n        const element = dev().assertElement(event.target);\n        this.trigger(element, name, event, ActionTrust.HIGH);\n      });\n    }\n  }\n\n  /**\n   * Registers the action target that will receive all designated actions.\n   * @param {string} name\n   * @param {ActionHandlerDef} handler\n   */\n  addGlobalTarget(name, handler) {\n    this.globalTargets_[name] = handler;\n  }\n\n  /**\n   * Registers the action handler for a common method.\n   * @param {string} name\n   * @param {ActionHandlerDef} handler\n   * @param {ActionTrust} minTrust\n   */\n  addGlobalMethodHandler(name, handler, minTrust = ActionTrust.DEFAULT) {\n    this.globalMethodHandlers_[name] = {handler, minTrust};\n  }\n\n  /**\n   * Triggers the specified event on the target element.\n   * @param {!Element} target\n   * @param {string} eventType\n   * @param {?ActionEventDef} event\n   * @param {!ActionTrust} trust\n   * @param {?JsonObject=} opt_args\n   * @return {boolean} true if the target has an action.\n   */\n  trigger(target, eventType, event, trust, opt_args) {\n    return this.action_(target, eventType, event, trust, opt_args);\n  }\n\n  /**\n   * Triggers execution of the method on a target/method.\n   * @param {!Element} target\n   * @param {string} method\n   * @param {?JsonObject} args\n   * @param {?Element} source\n   * @param {?Element} caller\n   * @param {?ActionEventDef} event\n   * @param {ActionTrust} trust\n   */\n  execute(target, method, args, source, caller, event, trust) {\n    const invocation = new ActionInvocation(\n      target,\n      method,\n      args,\n      source,\n      caller,\n      event,\n      trust\n    );\n    this.invoke_(invocation);\n  }\n\n  /**\n   * Installs action handler for the specified element. The action handler is\n   * responsible for checking invocation trust.\n   *\n   * For AMP elements, use base-element.registerAction() instead.\n   *\n   * @param {!Element} target\n   * @param {ActionHandlerDef} handler\n   */\n  installActionHandler(target, handler) {\n    // TODO(dvoytenko, #7063): switch back to `target.id` with form proxy.\n    const targetId = target.getAttribute('id') || '';\n\n    devAssert(\n      isAmpTagName(targetId) ||\n        target.tagName.toLowerCase() in NON_AMP_ELEMENTS_ACTIONS_,\n      'AMP or special element expected: %s',\n      target.tagName + '#' + targetId\n    );\n\n    if (target[ACTION_HANDLER_]) {\n      dev().error(TAG_, `Action handler already installed for ${target}`);\n      return;\n    }\n    target[ACTION_HANDLER_] = handler;\n\n    /** @const {Array<!ActionInvocation>} */\n    const queuedInvocations = target[ACTION_QUEUE_];\n    if (isArray(queuedInvocations)) {\n      // Invoke and clear all queued invocations now handler is installed.\n      Services.timerFor(toWin(target.ownerDocument.defaultView)).delay(() => {\n        // TODO(dvoytenko, #1260): dedupe actions.\n        queuedInvocations.forEach((invocation) => {\n          try {\n            handler(invocation);\n          } catch (e) {\n            dev().error(TAG_, 'Action execution failed:', invocation, e);\n          }\n        });\n        target[ACTION_QUEUE_].length = 0;\n      }, 1);\n    }\n  }\n\n  /**\n   * Checks if the given element has registered a particular action type.\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  hasAction(element, actionEventType, opt_stopAt) {\n    return !!this.findAction_(element, actionEventType, opt_stopAt);\n  }\n\n  /**\n   * Checks if the given element's registered action resolves to at least one\n   * existing element by id or a global target (e.g. \"AMP\").\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  hasResolvableAction(element, actionEventType, opt_stopAt) {\n    const action = this.findAction_(element, actionEventType, opt_stopAt);\n    if (!action) {\n      return false;\n    }\n    return action.actionInfos.some((action) => {\n      const {target} = action;\n      return !!this.getActionNode_(target);\n    });\n  }\n\n  /**\n   * Checks if the given element's registered action resolves to at least one\n   * existing element by id or a global target (e.g. \"AMP\").\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element} targetElement\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  hasResolvableActionForTarget(\n    element,\n    actionEventType,\n    targetElement,\n    opt_stopAt\n  ) {\n    const action = this.findAction_(element, actionEventType, opt_stopAt);\n    if (!action) {\n      return false;\n    }\n    return action.actionInfos.some((actionInfo) => {\n      const {target} = actionInfo;\n      return this.getActionNode_(target) == targetElement;\n    });\n  }\n\n  /**\n   * For global targets e.g. \"AMP\", returns the document root. Otherwise,\n   * `target` is an element id and the corresponding element is returned.\n   * @param {string} target\n   * @return {?Document|?Element|?ShadowRoot}\n   * @private\n   */\n  getActionNode_(target) {\n    return this.globalTargets_[target]\n      ? this.root_\n      : this.root_.getElementById(target);\n  }\n\n  /**\n   * Sets the action allowlist. Can be used to clear it.\n   * @param {!Array<{tagOrTarget: string, method: string}>} allowlist\n   */\n  setAllowlist(allowlist) {\n    devAssert(\n      allowlist.every((v) => v.tagOrTarget && v.method),\n      'Action allowlist entries should be of shape { tagOrTarget: string, method: string }'\n    );\n    this.allowlist_ = allowlist;\n  }\n\n  /**\n   * Adds an action to the allowlist.\n   * @param {string} tagOrTarget The tag or target to allowlist, e.g.\n   *     'AMP-LIST', '*'.\n   * @param {string|Array<string>} methods The method(s) to allowlist, e.g. 'show', 'hide'.\n   * @param {Array<string>=} opt_forFormat\n   */\n  addToAllowlist(tagOrTarget, methods, opt_forFormat) {\n    // TODO(wg-performance): When it becomes possible to getFormat(),\n    // we can store `format_` instead of `isEmail_` and check\n    // (opt_forFormat && !opt_forFormat.includes(this.format_))\n    if (opt_forFormat && opt_forFormat.includes('email') !== this.isEmail_) {\n      return;\n    }\n    if (!this.allowlist_) {\n      this.allowlist_ = [];\n    }\n    if (!isArray(methods)) {\n      methods = [methods];\n    }\n    methods.forEach((method) => {\n      if (\n        this.allowlist_.some(\n          (v) => v.tagOrTarget == tagOrTarget && v.method == method\n        )\n      ) {\n        return;\n      }\n      this.allowlist_.push({tagOrTarget, method});\n    });\n  }\n\n  /**\n   * @param {!Element} source\n   * @param {string} actionEventType\n   * @param {?ActionEventDef} event\n   * @param {!ActionTrust} trust\n   * @param {?JsonObject=} opt_args\n   * @return {boolean} True if the element has an action.\n   * @private\n   */\n  action_(source, actionEventType, event, trust, opt_args) {\n    const action = this.findAction_(source, actionEventType);\n    if (!action) {\n      return false;\n    }\n    // Use a pseudo-UUID to uniquely identify this sequence of actions.\n    // A sequence is all actions triggered by a single event.\n    const sequenceId = Math.random();\n    // Invoke actions serially, where each action waits for its predecessor\n    // to complete. `currentPromise` is the i'th promise in the chain.\n    /** @type {?Promise} */\n    let currentPromise = null;\n    action.actionInfos.forEach((actionInfo) => {\n      const {args, method, str, target} = actionInfo;\n      const dereferencedArgs = dereferenceArgsVariables(args, event, opt_args);\n      const invokeAction = () => {\n        const node = this.getActionNode_(target);\n        if (!node) {\n          this.error_(`Target \"${target}\" not found for action [${str}].`);\n          return;\n        }\n        const invocation = new ActionInvocation(\n          node,\n          method,\n          dereferencedArgs,\n          source,\n          action.node,\n          event,\n          trust,\n          actionEventType,\n          node.tagName || target,\n          sequenceId\n        );\n        return this.invoke_(invocation);\n      };\n      // Wait for the previous action, if any.\n      currentPromise = currentPromise\n        ? currentPromise.then(invokeAction)\n        : invokeAction();\n    });\n\n    return action.actionInfos.length >= 1;\n  }\n\n  /**\n   * @param {string} message\n   * @param {?Element=} opt_element\n   * @private\n   */\n  error_(message, opt_element) {\n    if (opt_element) {\n      // reportError() supports displaying the element in dev console.\n      const e = user().createError(`[${TAG_}] ${message}`);\n      reportError(e, opt_element);\n      throw e;\n    } else {\n      user().error(TAG_, message);\n    }\n  }\n\n  /**\n   * @param {!ActionInvocation} invocation\n   * @return {?Promise}\n   * @private\n   */\n  invoke_(invocation) {\n    const {method, tagOrTarget} = invocation;\n\n    // Check that this action is allowlisted (if a allowlist is set).\n    if (this.allowlist_) {\n      if (!isActionAllowlisted(invocation, this.allowlist_)) {\n        this.error_(\n          `\"${tagOrTarget}.${method}\" is not allowlisted ${JSON.stringify(\n            this.allowlist_\n          )}.`\n        );\n        return null;\n      }\n    }\n\n    // Handle global targets e.g. \"AMP\".\n    const globalTarget = this.globalTargets_[tagOrTarget];\n    if (globalTarget) {\n      return globalTarget(invocation);\n    }\n\n    // Subsequent handlers assume that invocation target is an Element.\n    const node = dev().assertElement(invocation.node);\n\n    // Handle global actions e.g. \"<any-element-id>.toggle\".\n    const globalMethod = this.globalMethodHandlers_[method];\n    if (globalMethod && invocation.satisfiesTrust(globalMethod.minTrust)) {\n      return globalMethod.handler(invocation);\n    }\n\n    // Handle element-specific actions.\n    const lowerTagName = node.tagName.toLowerCase();\n    if (isAmpTagName(lowerTagName)) {\n      if (node.enqueAction) {\n        node.enqueAction(invocation);\n      } else {\n        this.error_(`Unrecognized AMP element \"${lowerTagName}\".`, node);\n      }\n      return null;\n    }\n\n    // Special non-AMP elements with AMP ID or known supported actions.\n    const nonAmpActions = NON_AMP_ELEMENTS_ACTIONS_[lowerTagName];\n    // TODO(dvoytenko, #7063): switch back to `target.id` with form proxy.\n    const targetId = node.getAttribute('id') || '';\n    if (\n      isAmpTagName(targetId) ||\n      (nonAmpActions && nonAmpActions.indexOf(method) > -1)\n    ) {\n      const handler = node[ACTION_HANDLER_];\n      if (handler) {\n        handler(invocation);\n      } else {\n        node[ACTION_QUEUE_] = node[ACTION_QUEUE_] || [];\n        node[ACTION_QUEUE_].push(invocation);\n      }\n      return null;\n    }\n\n    // Unsupported method.\n    this.error_(\n      `Target (${tagOrTarget}) doesn't support \"${method}\" action.`,\n      invocation.caller\n    );\n\n    return null;\n  }\n\n  /**\n   * @param {!Element} target\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {?{node: !Element, actionInfos: !Array<!ActionInfoDef>}}\n   */\n  findAction_(target, actionEventType, opt_stopAt) {\n    // Go from target up the DOM tree and find the applicable action.\n    let n = target;\n    while (n) {\n      if (opt_stopAt && n == opt_stopAt) {\n        return null;\n      }\n      const actionInfos = this.matchActionInfos_(n, actionEventType);\n      if (actionInfos && isEnabled(n)) {\n        return {node: n, actionInfos: devAssert(actionInfos)};\n      }\n      n = n.parentElement;\n    }\n    return null;\n  }\n\n  /**\n   * @param {!Element} node\n   * @param {string} actionEventType\n   * @return {?Array<!ActionInfoDef>}\n   */\n  matchActionInfos_(node, actionEventType) {\n    const actionMap = this.getActionMap_(node, actionEventType);\n    if (!actionMap) {\n      return null;\n    }\n    return actionMap[actionEventType] || null;\n  }\n\n  /**\n   * @param {!Element} node\n   * @param {string} actionEventType\n   * @return {?Object<string, !Array<!ActionInfoDef>>}\n   */\n  getActionMap_(node, actionEventType) {\n    let actionMap = node[ACTION_MAP_];\n    if (actionMap === undefined) {\n      actionMap = null;\n      if (node.hasAttribute('on')) {\n        const action = node.getAttribute('on');\n        actionMap = parseActionMap(action, node);\n        node[ACTION_MAP_] = actionMap;\n      } else if (node.hasAttribute('execute')) {\n        const action = node.getAttribute('execute');\n        actionMap = parseActionMap(`${actionEventType}:${action}`, node);\n        node[ACTION_MAP_] = actionMap;\n      }\n    }\n    return actionMap;\n  }\n\n  /**\n   * Resets a node's actions with those defined in the given actions string.\n   * @param {!Element} node\n   * @param {string} actionsStr\n   */\n  setActions(node, actionsStr) {\n    node.setAttribute('on', actionsStr);\n\n    // Clear cache.\n    delete node[ACTION_MAP_];\n  }\n\n  /**\n   * Given a browser 'change' or 'input' event, add `detail` property to it\n   * containing allowlisted properties of the target element. Noop if `detail`\n   * is readonly.\n   * @param {!ActionEventDef} event\n   * @private\n   */\n  addTargetPropertiesAsDetail_(event) {\n    const detail = /** @type {!JsonObject} */ (map());\n    const {target} = event;\n\n    if (target.value !== undefined) {\n      detail['value'] = target.value;\n    }\n\n    // Check tagName instead since `valueAsNumber` isn't supported on IE.\n    if (target.tagName == 'INPUT') {\n      // Probably supported natively but convert anyways for consistency.\n      detail['valueAsNumber'] = Number(target.value);\n    }\n\n    if (target.checked !== undefined) {\n      detail['checked'] = target.checked;\n    }\n\n    if (target.min !== undefined || target.max !== undefined) {\n      detail['min'] = target.min;\n      detail['max'] = target.max;\n    }\n\n    if (target.files) {\n      detail['files'] = toArray(target.files).map((file) => ({\n        'name': file.name,\n        'size': file.size,\n        'type': file.type,\n      }));\n    }\n\n    if (Object.keys(detail).length > 0) {\n      try {\n        event.detail = detail;\n      } catch {} // event.detail is readonly\n    }\n  }\n}\n\n/**\n * @param {string} lowercaseTagName\n * @return {boolean}\n * @private\n */\nfunction isAmpTagName(lowercaseTagName) {\n  return lowercaseTagName.substring(0, 4) === 'amp-';\n}\n\n/**\n * Returns `true` if the given action invocation is allowlisted in the given\n * allowlist. Default actions' alias, 'activate', are automatically\n * allowlisted if their corresponding registered alias is allowlisted.\n * @param {!ActionInvocation} invocation\n * @param {!Array<{tagOrTarget: string, method: string}>} allowlist\n * @return {boolean}\n * @private\n */\nfunction isActionAllowlisted(invocation, allowlist) {\n  let {method} = invocation;\n  const {node, tagOrTarget} = invocation;\n  // Use alias if default action is invoked.\n  if (\n    method === DEFAULT_ACTION &&\n    typeof node.getDefaultActionAlias == 'function'\n  ) {\n    method = node.getDefaultActionAlias();\n  }\n  const lcMethod = method.toLowerCase();\n  const lcTagOrTarget = tagOrTarget.toLowerCase();\n  return allowlist.some((w) => {\n    if (\n      w.tagOrTarget.toLowerCase() === lcTagOrTarget ||\n      w.tagOrTarget === '*'\n    ) {\n      if (w.method.toLowerCase() === lcMethod) {\n        return true;\n      }\n    }\n    return false;\n  });\n}\n\n/**\n * A clone of an event object with its function properties replaced.\n * This is useful e.g. for event objects that need to be passed to an async\n * context, but the browser might have cleaned up the original event object.\n * This clone replaces functions with error throws since they won't behave\n * normally after the original object has been destroyed.\n * @private visible for testing\n */\nexport class DeferredEvent {\n  /**\n   * @param {!Event} event\n   */\n  constructor(event) {\n    /** @type {?Object} */\n    this.detail = null;\n\n    cloneWithoutFunctions(event, this);\n  }\n}\n\n/**\n * Clones an object and replaces its function properties with throws.\n * @param {!T} original\n * @param {!T=} opt_dest\n * @return {!T}\n * @template T\n * @private\n */\nfunction cloneWithoutFunctions(original, opt_dest) {\n  const clone = opt_dest || map();\n  for (const prop in original) {\n    const value = original[prop];\n    if (typeof value === 'function') {\n      clone[prop] = notImplemented;\n    } else {\n      clone[prop] = original[prop];\n    }\n  }\n  return clone;\n}\n\n/** @private */\nfunction notImplemented() {\n  devAssert(null, 'Deferred events cannot access native event functions.');\n}\n\n/**\n * @param {string} action\n * @param {!Element} context\n * @return {?Object<string, !Array<!ActionInfoDef>>}\n * @private Visible for testing only.\n */\nexport function parseActionMap(action, context) {\n  const assertAction = assertActionForParser.bind(null, action, context);\n  const assertToken = assertTokenForParser.bind(null, action, context);\n\n  let actionMap = null;\n\n  const toks = new ParserTokenizer(action);\n  let tok;\n  let peek;\n  do {\n    tok = toks.next();\n    if (\n      tok.type == TokenType.EOF ||\n      (tok.type == TokenType.SEPARATOR && tok.value == ';')\n    ) {\n      // Expected, ignore.\n    } else if (tok.type == TokenType.LITERAL || tok.type == TokenType.ID) {\n      // Format: event:target.method\n\n      // Event: \"event:\"\n      const event = tok.value;\n\n      // Target: \":target.\" separator\n      assertToken(toks.next(), [TokenType.SEPARATOR], ':');\n\n      const actions = [];\n\n      // Handlers for event.\n      do {\n        const target = assertToken(toks.next(), [\n          TokenType.LITERAL,\n          TokenType.ID,\n        ]).value;\n\n        // Method: \".method\". Method is optional.\n        let method = DEFAULT_ACTION;\n        let args = null;\n\n        peek = toks.peek();\n        if (peek.type == TokenType.SEPARATOR && peek.value == '.') {\n          toks.next(); // Skip '.'\n          method =\n            assertToken(toks.next(), [TokenType.LITERAL, TokenType.ID]).value ||\n            method;\n\n          // Optionally, there may be arguments: \"(key = value, key = value)\".\n          peek = toks.peek();\n          if (peek.type == TokenType.SEPARATOR && peek.value == '(') {\n            toks.next(); // Skip '('\n            args = tokenizeMethodArguments(toks, assertToken, assertAction);\n          }\n        }\n\n        actions.push({\n          event,\n          target,\n          method,\n          args:\n            args && getMode().test && Object.freeze\n              ? Object.freeze(args)\n              : args,\n          str: action,\n        });\n\n        peek = toks.peek();\n      } while (\n        peek.type == TokenType.SEPARATOR &&\n        peek.value == ',' &&\n        toks.next()\n      ); // skip \",\" when found\n\n      if (!actionMap) {\n        actionMap = map();\n      }\n\n      actionMap[event] = actions;\n    } else {\n      // Unexpected token.\n      assertAction(false, `; unexpected token [${tok.value || ''}]`);\n    }\n  } while (tok.type != TokenType.EOF);\n\n  return actionMap;\n}\n\n/**\n * Tokenizes and returns method arguments, e.g. target.method(arguments).\n * @param {!ParserTokenizer} toks\n * @param {!Function} assertToken\n * @param {!Function} assertAction\n * @return {?ActionInfoArgsDef}\n * @private\n */\nfunction tokenizeMethodArguments(toks, assertToken, assertAction) {\n  let peek = toks.peek();\n  let tok;\n  let args = null;\n  // Object literal. Format: {...}\n  if (peek.type == TokenType.OBJECT) {\n    // Don't parse object literals. Tokenize as a single expression\n    // fragment and delegate to specific action handler.\n    args = map();\n    const {value} = toks.next();\n    args[RAW_OBJECT_ARGS_KEY] = value;\n    assertToken(toks.next(), [TokenType.SEPARATOR], ')');\n  } else {\n    // Key-value pairs. Format: key = value, ....\n    do {\n      tok = toks.next();\n      const {type, value} = tok;\n      if (type == TokenType.SEPARATOR && (value == ',' || value == ')')) {\n        // Expected: ignore.\n      } else if (type == TokenType.LITERAL || type == TokenType.ID) {\n        // Key: \"key = \"\n        assertToken(toks.next(), [TokenType.SEPARATOR], '=');\n        // Value is either a literal or an expression: \"foo.bar.baz\"\n        tok = assertToken(toks.next(/* convertValue */ true), [\n          TokenType.LITERAL,\n          TokenType.ID,\n        ]);\n        const argValueTokens = [tok];\n        // Expressions have one or more dereferences: \".identifier\"\n        if (tok.type == TokenType.ID) {\n          for (\n            peek = toks.peek();\n            peek.type == TokenType.SEPARATOR && peek.value == '.';\n            peek = toks.peek()\n          ) {\n            toks.next(); // Skip '.'.\n            tok = assertToken(toks.next(false), [TokenType.ID]);\n            argValueTokens.push(tok);\n          }\n        }\n        const argValue = argValueForTokens(argValueTokens);\n        if (!args) {\n          args = map();\n        }\n        args[value] = argValue;\n        peek = toks.peek();\n        assertAction(\n          peek.type == TokenType.SEPARATOR &&\n            (peek.value == ',' || peek.value == ')'),\n          'Expected either [,] or [)]'\n        );\n      } else {\n        // Unexpected token.\n        assertAction(false, `; unexpected token [${tok.value || ''}]`);\n      }\n    } while (!(tok.type == TokenType.SEPARATOR && tok.value == ')'));\n  }\n  return args;\n}\n\n/**\n * @param {Array<!TokenDef>} tokens\n * @return {?ActionInfoArgValueDef}\n * @private\n */\nfunction argValueForTokens(tokens) {\n  if (tokens.length == 0) {\n    return null;\n  } else if (tokens.length == 1) {\n    return /** @type {(boolean|number|string)} */ (tokens[0].value);\n  } else {\n    const values = tokens.map((token) => token.value);\n    const expression = values.join('.');\n    return /** @type {ActionInfoArgExpressionDef} */ ({expression});\n  }\n}\n\n/**\n * Dereferences expression args in `args` using values in data.\n * @param {?ActionInfoArgsDef} args\n * @param {?ActionEventDef} event\n * @param {?JsonObject=} opt_args\n * @return {?JsonObject}\n * @private\n */\nexport function dereferenceArgsVariables(args, event, opt_args) {\n  if (!args) {\n    return args;\n  }\n  const data = opt_args || dict({});\n  if (event) {\n    const detail = getDetail(/** @type {!Event} */ (event));\n    if (detail) {\n      data['event'] = detail;\n    }\n  }\n  const applied = map();\n  Object.keys(args).forEach((key) => {\n    let value = args[key];\n    // Only JSON expression strings that contain dereferences (e.g. `foo.bar`)\n    // are processed as ActionInfoArgExpressionDef. We also support\n    // dereferencing strings like `foo` iff there is a corresponding key in\n    // `data`. Otherwise, `foo` is treated as a string \"foo\".\n    if (typeof value == 'object' && value.expression) {\n      const expr = /** @type {ActionInfoArgExpressionDef} */ (value).expression;\n      const exprValue = getValueForExpr(data, expr);\n      // If expr can't be found in data, use null instead of undefined.\n      value = exprValue === undefined ? null : exprValue;\n    }\n    if (data[value]) {\n      applied[key] = data[value];\n    } else {\n      applied[key] = value;\n    }\n  });\n  return applied;\n}\n\n/**\n * @param {string} s\n * @param {!Element} context\n * @param {?T} condition\n * @param {string=} opt_message\n * @return {T}\n * @template T\n * @private\n */\nfunction assertActionForParser(s, context, condition, opt_message) {\n  return userAssert(\n    condition,\n    'Invalid action definition in %s: [%s] %s',\n    context,\n    s,\n    opt_message || ''\n  );\n}\n\n/**\n * @param {string} s\n * @param {!Element} context\n * @param {!TokenDef} tok\n * @param {Array<TokenType>} types\n * @param {*=} opt_value\n * @return {!TokenDef}\n * @private\n */\nfunction assertTokenForParser(s, context, tok, types, opt_value) {\n  if (opt_value !== undefined) {\n    assertActionForParser(\n      s,\n      context,\n      types.includes(tok.type) && tok.value == opt_value,\n      `; expected [${opt_value}]`\n    );\n  } else {\n    assertActionForParser(s, context, types.includes(tok.type));\n  }\n  return tok;\n}\n\n/**\n * @enum {number}\n */\nconst TokenType = {\n  INVALID: 0,\n  EOF: 1,\n  SEPARATOR: 2,\n  LITERAL: 3,\n  ID: 4,\n  OBJECT: 5,\n};\n\n/**\n * @typedef {{type: TokenType, value: *}}\n */\nlet TokenDef;\n\n/** @private @const {string} */\nconst WHITESPACE_SET = ' \\t\\n\\r\\f\\v\\u00A0\\u2028\\u2029';\n\n/** @private @const {string} */\nconst SEPARATOR_SET = ';:.()=,|!';\n\n/** @private @const {string} */\nconst STRING_SET = '\"\\'';\n\n/** @private @const {string} */\nconst OBJECT_SET = '{}';\n\n/** @private @const {string} */\nconst SPECIAL_SET = WHITESPACE_SET + SEPARATOR_SET + STRING_SET + OBJECT_SET;\n\n/** @private */\nclass ParserTokenizer {\n  /**\n   * @param {string} str\n   */\n  constructor(str) {\n    /** @private @const {string} */\n    this.str_ = str;\n\n    /** @private {number} */\n    this.index_ = -1;\n  }\n\n  /**\n   * Returns the next token and advances the position.\n   * @param {boolean=} opt_convertValues\n   * @return {!TokenDef}\n   */\n  next(opt_convertValues) {\n    const tok = this.next_(opt_convertValues || false);\n    this.index_ = tok.index;\n    return tok;\n  }\n\n  /**\n   * Returns the next token but keeps the current position.\n   * @param {boolean=} opt_convertValues\n   * @return {!TokenDef}\n   */\n  peek(opt_convertValues) {\n    return this.next_(opt_convertValues || false);\n  }\n\n  /**\n   * @param {boolean} convertValues\n   * @return {!{type: TokenType, value: *, index: number}}\n   */\n  next_(convertValues) {\n    let newIndex = this.index_ + 1;\n    if (newIndex >= this.str_.length) {\n      return {type: TokenType.EOF, index: this.index_};\n    }\n\n    let c = this.str_.charAt(newIndex);\n\n    // Whitespace: standard set.\n    if (WHITESPACE_SET.indexOf(c) != -1) {\n      newIndex++;\n      for (; newIndex < this.str_.length; newIndex++) {\n        if (WHITESPACE_SET.indexOf(this.str_.charAt(newIndex)) == -1) {\n          break;\n        }\n      }\n      if (newIndex >= this.str_.length) {\n        return {type: TokenType.EOF, index: newIndex};\n      }\n      c = this.str_.charAt(newIndex);\n    }\n\n    // A numeric. Notice that it steals the `.` from separators.\n    if (\n      convertValues &&\n      (isNum(c) ||\n        (c == '.' &&\n          newIndex + 1 < this.str_.length &&\n          isNum(this.str_[newIndex + 1])))\n    ) {\n      let hasFraction = c == '.';\n      let end = newIndex + 1;\n      for (; end < this.str_.length; end++) {\n        const c2 = this.str_.charAt(end);\n        if (c2 == '.') {\n          hasFraction = true;\n          continue;\n        }\n        if (!isNum(c2)) {\n          break;\n        }\n      }\n      const s = this.str_.substring(newIndex, end);\n      const value = hasFraction ? parseFloat(s) : parseInt(s, 10);\n      newIndex = end - 1;\n      return {type: TokenType.LITERAL, value, index: newIndex};\n    }\n\n    // Different separators.\n    if (SEPARATOR_SET.indexOf(c) != -1) {\n      return {type: TokenType.SEPARATOR, value: c, index: newIndex};\n    }\n\n    // String literal.\n    if (STRING_SET.indexOf(c) != -1) {\n      let end = -1;\n      for (let i = newIndex + 1; i < this.str_.length; i++) {\n        if (this.str_.charAt(i) == c) {\n          end = i;\n          break;\n        }\n      }\n      if (end == -1) {\n        return {type: TokenType.INVALID, index: newIndex};\n      }\n      const value = this.str_.substring(newIndex + 1, end);\n      newIndex = end;\n      return {type: TokenType.LITERAL, value, index: newIndex};\n    }\n\n    // Object literal.\n    if (c == '{') {\n      let numberOfBraces = 1;\n      let end = -1;\n      for (let i = newIndex + 1; i < this.str_.length; i++) {\n        const char = this.str_[i];\n        if (char == '{') {\n          numberOfBraces++;\n        } else if (char == '}') {\n          numberOfBraces--;\n        }\n        if (numberOfBraces <= 0) {\n          end = i;\n          break;\n        }\n      }\n      if (end == -1) {\n        return {type: TokenType.INVALID, index: newIndex};\n      }\n      const value = this.str_.substring(newIndex, end + 1);\n      newIndex = end;\n      return {type: TokenType.OBJECT, value, index: newIndex};\n    }\n\n    // Advance until next special character.\n    let end = newIndex + 1;\n    for (; end < this.str_.length; end++) {\n      if (SPECIAL_SET.indexOf(this.str_.charAt(end)) != -1) {\n        break;\n      }\n    }\n    const s = this.str_.substring(newIndex, end);\n    newIndex = end - 1;\n\n    // Boolean literal.\n    if (convertValues && (s == 'true' || s == 'false')) {\n      const value = s == 'true';\n      return {type: TokenType.LITERAL, value, index: newIndex};\n    }\n\n    // Identifier.\n    if (!isNum(s.charAt(0))) {\n      return {type: TokenType.ID, value: s, index: newIndex};\n    }\n\n    // Key.\n    return {type: TokenType.LITERAL, value: s, index: newIndex};\n  }\n}\n\n/**\n * Tests whether a chacter is a number.\n * @param {string} c\n * @return {boolean}\n */\nfunction isNum(c) {\n  return c >= '0' && c <= '9';\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installActionServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    'action',\n    ActionService,\n    /* opt_instantiate */ true\n  );\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {getFormAsObject, getSubmitButtonUsed} from './form';\nimport {iterateCursor} from './dom';\nimport {map} from './core/types/object';\n\n/**\n * Create a form data wrapper. The wrapper is necessary to provide a common\n * API for FormData objects on all browsers. For example, not all browsers\n * support the FormData#entries or FormData#delete functions.\n *\n * @param {!Window} win\n * @param {!HTMLFormElement=} opt_form\n * @return {!FormDataWrapperInterface}\n */\nexport function createFormDataWrapper(win, opt_form) {\n  const platform = Services.platformFor(win);\n\n  if (platform.isIos() && platform.getMajorVersion() == 11) {\n    return new Ios11NativeFormDataWrapper(opt_form);\n  } else if (FormData.prototype.entries && FormData.prototype.delete) {\n    return new NativeFormDataWrapper(opt_form);\n  } else {\n    return new PolyfillFormDataWrapper(opt_form);\n  }\n}\n\n/**\n * Check if the given object is a FormDataWrapper instance\n * @param {*} o\n * @return {boolean} True if the object is a FormDataWrapper instance.\n */\nexport function isFormDataWrapper(o) {\n  // instanceof doesn't work as expected, so we detect with duck-typing.\n  return !!o && typeof o.getFormData == 'function';\n}\n\n/**\n * A polyfill wrapper for a `FormData` object.\n *\n * If there's no native `FormData#entries`, chances are there are no native\n * methods to read the content of the `FormData` after construction, so the\n * only way to implement `entries` in this class is to capture the fields in\n * the form passed to the constructor (and the arguments passed to the\n * `append` method).\n *\n * For more details on this, see http://mdn.io/FormData.\n *\n * @implements {FormDataWrapperInterface}\n * @visibleForTesting\n */\nexport class PolyfillFormDataWrapper {\n  /** @override */\n  constructor(opt_form = undefined) {\n    /** @private @const {!Object<string, !Array<string>>} */\n    this.fieldValues_ = opt_form ? getFormAsObject(opt_form) : map();\n  }\n\n  /**\n   * @param {string} name\n   * @param {string|!File} value\n   * @param {string=} opt_filename\n   * @override\n   */\n  append(name, value, opt_filename) {\n    // Coercion to string is required to match\n    // the native FormData.append behavior\n    const nameString = String(name);\n    this.fieldValues_[nameString] = this.fieldValues_[nameString] || [];\n    this.fieldValues_[nameString].push(String(value));\n  }\n\n  /** @override */\n  delete(name) {\n    delete this.fieldValues_[name];\n  }\n\n  /** @override */\n  entries() {\n    const fieldEntries = [];\n    Object.keys(this.fieldValues_).forEach((name) => {\n      const values = this.fieldValues_[name];\n      values.forEach((value) => fieldEntries.push([name, value]));\n    });\n\n    // Generator functions are not supported by the current Babel configuration,\n    // so we must manually implement the iterator interface.\n    let nextIndex = 0;\n    return /** @type {!Iterator<!Array<string>>} */ ({\n      next() {\n        return nextIndex < fieldEntries.length\n          ? {value: fieldEntries[nextIndex++], done: false}\n          : {value: undefined, done: true};\n      },\n    });\n  }\n\n  /** @override */\n  getFormData() {\n    const formData = new FormData();\n\n    Object.keys(this.fieldValues_).forEach((name) => {\n      const values = this.fieldValues_[name];\n      values.forEach((value) => formData.append(name, value));\n    });\n\n    return formData;\n  }\n}\n\n/**\n * Wrap the native `FormData` implementation.\n *\n * NOTE: This differs from the standard `FormData` constructor. This constructor\n * includes a submit button if it was used to submit the `opt_form`, where\n * the native `FormData` constructor does not include the submit button used to\n * submit the form.\n * {@link https://xhr.spec.whatwg.org/#dom-formdata}\n * @implements {FormDataWrapperInterface}\n */\nclass NativeFormDataWrapper {\n  /** @override */\n  constructor(opt_form) {\n    /** @private @const {!FormData} */\n    this.formData_ = new FormData(opt_form);\n\n    this.maybeIncludeSubmitButton_(opt_form);\n  }\n\n  /**\n   * If a submit button is focused (because it was used to submit the form),\n   * or was the first submit button present, add its name and value to the\n   * `FormData`, since publishers expect the submit button to be present.\n   * @param {!HTMLFormElement=} opt_form\n   * @private\n   */\n  maybeIncludeSubmitButton_(opt_form) {\n    // If a form is not passed to the constructor,\n    // we are not in a submitting code path.\n    if (!opt_form) {\n      return;\n    }\n\n    const button = getSubmitButtonUsed(opt_form);\n    if (button && button.name) {\n      this.append(button.name, button.value);\n    }\n  }\n\n  /**\n   * @param {string} name\n   * @param {string|!File} value\n   * @param {string=} opt_filename\n   * @override\n   */\n  append(name, value, opt_filename) {\n    this.formData_.append(name, value);\n  }\n\n  /** @override */\n  delete(name) {\n    this.formData_.delete(name);\n  }\n\n  /** @override */\n  entries() {\n    return this.formData_.entries();\n  }\n\n  /** @override */\n  getFormData() {\n    return this.formData_;\n  }\n}\n\n/**\n * iOS 11 has a bug when submitting empty file inputs.\n * This works around the bug by replacing the empty files with Blob objects.\n */\nclass Ios11NativeFormDataWrapper extends NativeFormDataWrapper {\n  /** @override */\n  constructor(opt_form) {\n    super(opt_form);\n\n    if (opt_form) {\n      iterateCursor(opt_form.elements, (input) => {\n        if (input.type == 'file' && input.files.length == 0) {\n          this.formData_.delete(input.name);\n          this.formData_.append(input.name, new Blob([]), '');\n        }\n      });\n    }\n  }\n\n  /**\n   * @param {string} name\n   * @param {string|!File} value\n   * @param {string=} opt_filename\n   * @override\n   */\n  append(name, value, opt_filename) {\n    // Safari 11 breaks on submitting empty File values.\n    if (value && typeof value == 'object' && isEmptyFile(value)) {\n      this.formData_.append(name, new Blob([]), opt_filename || '');\n    } else {\n      this.formData_.append(name, value);\n    }\n  }\n}\n\n/**\n * A wrapper for a native `FormData` object that allows the retrieval of entries\n * in the form data after construction even on browsers that don't natively\n * support `FormData.prototype.entries`.\n *\n * @interface\n * Subclassing `FormData` doesn't work in this case as the transpiler\n *     generates code that calls the super constructor directly using\n *     `Function.prototype.call`. WebKit (Safari) doesn't allow this and\n *     enforces that constructors be called with the `new` operator.\n */\nclass FormDataWrapperInterface {\n  /**\n   * Creates a new wrapper for a `FormData` object.\n   *\n   * If there's no native `FormData#entries`, chances are there are no native\n   * methods to read the content of the `FormData` after construction, so the\n   * only way to implement `entries` in this class is to capture the fields in\n   * the form passed to the constructor (and the arguments passed to the\n   * `append` method).\n   *\n   * This constructor should also add the submitter element as defined in the\n   * HTML spec for Form Submission Algorithm, but is not defined by the standard\n   * when using the `FormData` constructor directly.\n   *\n   * For more details on this, see http://mdn.io/FormData.\n   *\n   * @param {!HTMLFormElement=} opt_form An HTML `<form>` element \u2014 when\n   *     specified, the `FormData` object will be populated with the form's\n   *     current keys/values using the name property of each element for the\n   *     keys and their submitted value for the values. It will also encode file\n   *     input content.\n   */\n  constructor(opt_form) {}\n\n  /**\n   * Appends a new value onto an existing key inside a `FormData` object, or\n   * adds the key if it does not already exist.\n   *\n   * Appending a `File` object is not yet supported and the `filename`\n   * parameter is ignored for this wrapper.\n   *\n   * For more details on this, see http://mdn.io/FormData/append.\n   *\n   * TODO(cvializ): Update file support\n   *\n   * @param {string} unusedName The name of the field whose data is contained in\n   *     `value`.\n   * @param {string|!File} unusedValue The field's value.\n   * @param {string=} opt_filename The filename to use if the value is a file.\n   */\n  append(unusedName, unusedValue, opt_filename) {}\n\n  /**\n   * Remove the given value from the FormData.\n   *\n   * For more details on this, see http://mdn.io/FormData/delete.\n   *\n   * @param {string} unusedName The name of the field to remove from the FormData.\n   */\n  delete(unusedName) {}\n\n  /**\n   * Returns an iterator of all key/value pairs contained in this object.\n   *\n   * For more details on this, see http://mdn.io/FormData/entries.\n   *\n   * @return {!Iterator<!Array<string|!File>>}\n   */\n  entries() {}\n\n  /**\n   * Returns the wrapped native `FormData` object.\n   *\n   * @return {!FormData}\n   */\n  getFormData() {}\n}\n\n/**\n * Check if the given file is an empty file, which is the result of submitting\n * an empty `<input type=\"file\">`. These cause errors when submitting forms\n * in Safari 11.\n *\n * @param {!File} file\n * @return {boolean}\n */\nfunction isEmptyFile(file) {\n  return file.name == '' && file.size == 0;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {devAssert, userAssert} from '../core/assert';\nimport {dict, isObject, map} from '../core/types/object';\nimport {fromIterator, isArray} from '../core/types/array';\nimport {\n  getCorsUrl,\n  getWinOrigin,\n  isProxyOrigin,\n  parseUrlDeprecated,\n  serializeQueryString,\n} from '../url';\nimport {getMode} from '../mode';\nimport {user} from '../log';\n\nimport {isExperimentOn} from '../experiments';\nimport {isFormDataWrapper} from '../form-data-wrapper';\n\n/** @private @const {!Array<string>} */\nconst allowedMethods_ = ['GET', 'POST'];\n\n/** @private @const {!Array<function(*):boolean>} */\nconst allowedJsonBodyTypes_ = [isArray, isObject];\n\n/**\n * Serializes a fetch request so that it can be passed to `postMessage()`,\n * i.e., can be cloned using the\n * [structured clone algorithm](http://mdn.io/Structured_clone_algorithm).\n *\n * The request is serialized in the following way:\n *\n * 1. If the `init.body` is a `FormData`, set content-type header to\n * `multipart/form-data` and transform `init.body` into an\n * `!Array<!Array<string>>` holding the list of form entries, where each\n * element in the array is a form entry (key-value pair) represented as a\n * 2-element array.\n *\n * 2. Return a new object having properties `input` and the transformed\n * `init`.\n *\n * The serialized request is assumed to be de-serialized in the following way:\n *\n * 1.If content-type header starts with `multipart/form-data`\n * (case-insensitive), transform the entry array in `init.body` into a\n * `FormData` object.\n *\n * 2. Pass `input` and transformed `init` to `fetch` (or the constructor of\n * `Request`).\n *\n * Currently only `FormData` used in `init.body` is handled as it's the only\n * type being used in AMP runtime that needs serialization. The `Headers` type\n * also needs serialization, but callers should not be passing `Headers`\n * object in `init`, as that fails `fetchPolyfill` on browsers that don't\n * support fetch. Some serialization-needing types for `init.body` such as\n * `ArrayBuffer` and `Blob` are already supported by the structured clone\n * algorithm. Other serialization-needing types such as `URLSearchParams`\n * (which is not supported in IE and Safari) and `FederatedCredentials` are\n * not used in AMP runtime.\n *\n * @param {string} input The URL of the XHR to convert to structured\n *     cloneable.\n * @param {!FetchInitDef} init The options of the XHR to convert to structured\n *     cloneable.\n * @return {{input: string, init: !FetchInitDef}} The serialized structurally-\n *     cloneable request.\n */\nexport function toStructuredCloneable(input, init) {\n  const newInit = /** @type {!FetchInitDef} */ ({...init});\n  if (isFormDataWrapper(init.body)) {\n    const wrapper = /** @type {!FormDataWrapperInterface} */ (init.body);\n    newInit.headers['Content-Type'] = 'multipart/form-data;charset=utf-8';\n    newInit.body = fromIterator(wrapper.entries());\n  }\n  return {input, init: newInit};\n}\n\n/**\n * De-serializes a fetch response that was made possible to be passed to\n * `postMessage()`, i.e., can be cloned using the\n * [structured clone algorithm](http://mdn.io/Structured_clone_algorithm).\n *\n * The response is assumed to be serialized in the following way:\n *\n * 1. Transform the entries in the headers of the response into an\n * `!Array<!Array<string>>` holding the list of header entries, where each\n * element in the array is a header entry (key-value pair) represented as a\n * 2-element array. The header key is case-insensitive.\n *\n * 2. Include the header entry list and `status` and `statusText` properties\n * of the response in as `headers`, `status` and `statusText` properties of\n * `init`.\n *\n * 3. Include the body of the response serialized as string in `body`.\n *\n * 4. Return a new object having properties `body` and `init`.\n *\n * The response is de-serialized in the following way:\n *\n * 1. If the `Response` type is supported and `responseType` is not\n * document, pass `body` and `init` directly to the constructor of `Response`.\n *\n * 2. Otherwise, populate a fake XHR object to pass to `FetchResponse` as if\n * the response is returned by the fetch polyfill.\n *\n * 3. If `responseType` is `document`, also parse the body and populate\n * `responseXML` as a `Document` type.\n *\n * @param {JsonObject|string|undefined} response The structurally-cloneable\n *     response to convert back to a regular Response.\n * @param {string|undefined} responseType The original response type used to\n *     initiate the XHR.\n * @return {!Response} The deserialized regular response.\n * @private\n */\nexport function fromStructuredCloneable(response, responseType) {\n  userAssert(isObject(response), 'Object expected: %s', response);\n\n  const isDocumentType = responseType == 'document';\n  if (!isDocumentType) {\n    // Use native `Response` type if available for performance. If response\n    // type is `document`, we must fall back to `FetchResponse` polyfill\n    // because callers would then rely on the `responseXML` property being\n    // present, which is not supported by the Response type.\n    return new Response(response['body'], response['init']);\n  }\n\n  const lowercasedHeaders = map();\n  const data = {\n    status: 200,\n    statusText: 'OK',\n    /**\n     * @param {string} name\n     * @return {string}\n     */\n    getResponseHeader(name) {\n      return lowercasedHeaders[String(name).toLowerCase()] || null;\n    },\n  };\n\n  if (response['init']) {\n    const init = response['init'];\n    if (isArray(init.headers)) {\n      /** @type {!Array} */ (init.headers).forEach((entry) => {\n        const headerName = entry[0];\n        const headerValue = entry[1];\n        lowercasedHeaders[String(headerName).toLowerCase()] =\n          String(headerValue);\n      });\n    }\n    if (init.status) {\n      data.status = parseInt(init.status, 10);\n    }\n    if (init.statusText) {\n      data.statusText = String(init.statusText);\n    }\n  }\n\n  return new Response(response['body'] ? String(response['body']) : '', data);\n}\n\n/**\n * Intercepts the XHR and proxies it through the viewer if necessary.\n *\n * XHRs are intercepted if all of the following are true:\n * - The AMP doc is in single doc mode\n * - The requested resource is not a 1p request.\n * - The viewer has the `xhrInterceptor` capability\n * - The Viewer is a trusted viewer or AMP is currently in developement mode\n * - The AMP doc is opted-in for XHR interception (`<html>` tag has\n *   `allow-xhr-interception` attribute)\n *\n * @param {!Window} win\n * @param {?../service/ampdoc-impl.AmpDoc} ampdocSingle\n * @param {string} input The URL of the XHR which may get intercepted.\n * @param {!FetchInitDef} init The options of the XHR which may get\n *     intercepted.\n * @return {!Promise<!Response|undefined>}\n *     A response returned by the interceptor if XHR is intercepted or\n *     `Promise<undefined>` otherwise.\n */\nexport function getViewerInterceptResponse(win, ampdocSingle, input, init) {\n  if (!ampdocSingle) {\n    return Promise.resolve();\n  }\n\n  const whenUnblocked = init.prerenderSafe\n    ? Promise.resolve()\n    : ampdocSingle.whenFirstVisible();\n  const viewer = Services.viewerForDoc(ampdocSingle);\n  const urlIsProxy = isProxyOrigin(input);\n  const viewerCanIntercept = viewer.hasCapability('xhrInterceptor');\n  const interceptorDisabledForLocalDev =\n    init.bypassInterceptorForDev && getMode(win).localDev;\n  if (urlIsProxy || !viewerCanIntercept || interceptorDisabledForLocalDev) {\n    return whenUnblocked;\n  }\n\n  const htmlElement = ampdocSingle.getRootNode().documentElement;\n  const docOptedIn = htmlElement.hasAttribute('allow-xhr-interception');\n  if (!docOptedIn) {\n    return whenUnblocked;\n  }\n\n  return whenUnblocked\n    .then(() => viewer.isTrustedViewer())\n    .then((viewerTrusted) => {\n      if (\n        !(\n          viewerTrusted ||\n          getMode(win).localDev ||\n          isExperimentOn(win, 'untrusted-xhr-interception')\n        )\n      ) {\n        return;\n      }\n      const messagePayload = dict({\n        'originalRequest': toStructuredCloneable(input, init),\n      });\n      return viewer\n        .sendMessageAwaitResponse('xhr', messagePayload)\n        .then((response) =>\n          fromStructuredCloneable(response, init.responseType)\n        );\n    });\n}\n\n/**\n * Sets up URL based on ampCors\n * @param {!Window} win\n * @param {string} input\n * @param {!FetchInitDef} init The options of the XHR which may get\n * intercepted.\n * @return {string}\n */\nexport function setupInput(win, input, init) {\n  devAssert(typeof input == 'string', 'Only URL supported: %s', input);\n  if (init.ampCors !== false) {\n    input = getCorsUrl(win, input);\n  }\n  return input;\n}\n\n/**\n * Sets up and normalizes the FetchInitDef\n *\n * @param {?FetchInitDef=} opt_init Fetch options object.\n * @param {string=} opt_accept The HTTP Accept header value.\n * @return {!FetchInitDef}\n */\nexport function setupInit(opt_init, opt_accept) {\n  const init = opt_init || {};\n\n  // In particular, Firefox does not tolerate `null` values for\n  // `credentials`.\n  const creds = init.credentials;\n  devAssert(\n    creds === undefined || creds == 'include' || creds == 'omit',\n    'Only credentials=include|omit support: %s',\n    creds\n  );\n\n  init.method = normalizeMethod_(init.method);\n  init.headers = init.headers || dict({});\n  if (opt_accept) {\n    init.headers['Accept'] = opt_accept;\n  }\n\n  // In edge a `TypeMismatchError` is thrown when body is set to null.\n  devAssert(init.body !== null, 'fetch `body` can not be `null`');\n\n  return init;\n}\n\n/**\n *\n * Sets up AMPSpecific CORS headers.\n * @param {!Window} win\n * @param {string} input\n * @param {?FetchInitDef=} init\n * @return {!FetchInitDef}\n */\nexport function setupAMPCors(win, input, init) {\n  init = init || {};\n  // For some same origin requests, add AMP-Same-Origin: true header to allow\n  // publishers to validate that this request came from their own origin.\n  const currentOrigin = getWinOrigin(win);\n  const targetOrigin = parseUrlDeprecated(input).origin;\n  if (currentOrigin == targetOrigin) {\n    init['headers'] = init['headers'] || {};\n    init['headers']['AMP-Same-Origin'] = 'true';\n  }\n  return init;\n}\n\n/**\n * @param {?FetchInitDef=} init\n * @return {!FetchInitDef}\n */\nexport function setupJsonFetchInit(init) {\n  const fetchInit = setupInit(init, 'application/json');\n  if (fetchInit.method == 'POST' && !isFormDataWrapper(fetchInit.body)) {\n    // Assume JSON strict mode where only objects or arrays are allowed\n    // as body.\n    devAssert(\n      allowedJsonBodyTypes_.some((test) => test(fetchInit.body)),\n      'body must be of type object or array. %s',\n      fetchInit.body\n    );\n\n    // Content should be 'text/plain' to avoid CORS preflight.\n    fetchInit.headers['Content-Type'] =\n      fetchInit.headers['Content-Type'] || 'text/plain;charset=utf-8';\n    const headerContentType = fetchInit.headers['Content-Type'];\n    // Cast is valid, because we checked that it is not form data above.\n    if (headerContentType === 'application/x-www-form-urlencoded') {\n      fetchInit.body = serializeQueryString(\n        /** @type {!JsonObject} */ (fetchInit.body)\n      );\n    } else {\n      fetchInit.body = JSON.stringify(\n        /** @type {!JsonObject} */ (fetchInit.body)\n      );\n    }\n  }\n  return fetchInit;\n}\n\n/**\n * Normalized method name by uppercasing.\n * @param {string|undefined} method\n * @return {string}\n * @private\n */\nfunction normalizeMethod_(method) {\n  if (method === undefined) {\n    return 'GET';\n  }\n  method = method.toUpperCase();\n  devAssert(\n    allowedMethods_.includes(method),\n    'Only one of %s is currently allowed. Got %s',\n    allowedMethods_.join(', '),\n    method\n  );\n  return method;\n}\n\n/**\n * If 415 or in the 5xx range.\n * @param {number} status\n * @return {boolean}\n */\nfunction isRetriable(status) {\n  return status == 415 || (status >= 500 && status < 600);\n}\n\n/**\n * Returns the response if successful or otherwise throws an error.\n * @param {!Response} response\n * @return {!Promise<!Response>}\n */\nexport function assertSuccess(response) {\n  return new Promise((resolve) => {\n    if (response.ok) {\n      return resolve(response);\n    }\n\n    const {status} = response;\n    const err = user().createError(`HTTP error ${status}`);\n    err['retriable'] = isRetriable(status);\n    // TODO(@jridgewell, #9448): Callers who need the response should\n    // skip processing.\n    err['response'] = response;\n    throw err;\n  });\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {\n  assertSuccess,\n  getViewerInterceptResponse,\n  setupAMPCors,\n  setupInit,\n  setupInput,\n  setupJsonFetchInit,\n} from '../utils/xhr-utils';\nimport {dev, user} from '../log';\nimport {getCorsUrl, parseUrlDeprecated} from '../url';\nimport {getService, registerServiceBuilder} from '../service';\nimport {isFormDataWrapper} from '../form-data-wrapper';\nimport {parseJson} from '../core/types/object/json';\n\n/**\n * A service that polyfills Fetch API for use within AMP.\n *\n * @package Visible for type.\n * @visibleForTesting\n */\nexport class Xhr {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    const ampdocService = Services.ampdocServiceFor(win);\n\n    // The isSingleDoc check is required because if in shadow mode, this will\n    // throw a console error because the shellShadowDoc_ is not set when\n    // fetching the amp doc. So either the test-bind-impl or test pre setup in\n    // shadow mode tests needs to be fixed or there is a bug in ampdoc impl\n    // getAmpDoc.\n    // TODO(alabiaga): This should be investigated and fixed\n    /** @private {?./ampdoc-impl.AmpDoc} */\n    this.ampdocSingle_ = ampdocService.isSingleDoc()\n      ? ampdocService.getSingleDoc()\n      : null;\n  }\n\n  /**\n   * We want to call `fetch_` unbound from any context since it could\n   * be either the native fetch or our polyfill.\n   *\n   * @param {string} input\n   * @param {!FetchInitDef} init\n   * @return {!Promise<!Response>}\n   * @private\n   */\n  fetch_(input, init) {\n    return getViewerInterceptResponse(\n      this.win,\n      this.ampdocSingle_,\n      input,\n      init\n    ).then((interceptorResponse) => {\n      if (interceptorResponse) {\n        return interceptorResponse;\n      }\n      // After this point, both the native `fetch` and the `fetch` polyfill\n      // will expect a native `FormData` object in the `body` property, so\n      // the native `FormData` object needs to be unwrapped.\n      if (isFormDataWrapper(init.body)) {\n        const formDataWrapper = /** @type {!FormDataWrapperInterface} */ (\n          init.body\n        );\n        init.body = formDataWrapper.getFormData();\n      }\n      return this.win.fetch.apply(null, arguments);\n    });\n  }\n\n  /**\n   * Performs the final initialization and requests the fetch. It does two\n   * main things:\n   * - It adds \"__amp_source_origin\" URL parameter with source origin\n   * USE WITH CAUTION: setting ampCors to false disables AMP source origin check\n   * but allows for caching resources cross pages.\n   *\n   * @param {string} input\n   * @param {!FetchInitDef=} init\n   * @return {!Promise<!Response>}\n   * @private\n   */\n  fetchAmpCors_(input, init = {}) {\n    input = setupInput(this.win, input, init);\n    init = setupAMPCors(this.win, input, init);\n    return this.fetch_(input, init).then(\n      (response) => response,\n      (reason) => {\n        const targetOrigin = parseUrlDeprecated(input).origin;\n        throw user().createExpectedError(\n          'XHR',\n          `Failed fetching (${targetOrigin}/...):`,\n          reason && /** @type {!Error} */ (reason).message\n        );\n      }\n    );\n  }\n\n  /**\n   * Fetches a JSON response. Note this returns the response object, not the\n   * response's JSON. #fetchJson merely sets up the request to accept JSON.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * See `fetchAmpCors_` for more detail.\n   *\n   * @param {string} input\n   * @param {?FetchInitDef=} opt_init\n   * @return {!Promise<!Response>}\n   */\n  fetchJson(input, opt_init) {\n    return this.fetch(input, setupJsonFetchInit(opt_init));\n  }\n\n  /**\n   * Fetches a text response. Note this returns the response object, not the\n   * response's text. #fetchText merely sets up the request to accept text.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * See `fetchAmpCors_` for more detail.\n   *\n   * @param {string} input\n   * @param {?FetchInitDef=} opt_init\n   * @return {!Promise<!Response>}\n   */\n  fetchText(input, opt_init) {\n    return this.fetch(input, setupInit(opt_init, 'text/plain'));\n  }\n\n  /**\n   * A subsitute for the standard response.json(), which may optionally strip a prefix before calling JSON.parse().\n   *\n   * @param {!Response} res fetch response to convert to json.\n   * @param {string|undefined} prefix to strip away.\n   * @return {Promise<*>}\n   */\n  xssiJson(res, prefix) {\n    if (!prefix) {\n      return res.json();\n    }\n\n    return res.text().then((txt) => {\n      if (!txt.startsWith(dev().assertString(prefix))) {\n        user().warn(\n          'XHR',\n          `Failed to strip missing prefix \"${prefix}\" in fetch response.`\n        );\n        return parseJson(txt);\n      }\n      return parseJson(txt.slice(prefix.length));\n    });\n  }\n\n  /**\n   * @param {string} input URL\n   * @param {?FetchInitDef=} opt_init Fetch options object.\n   * @return {!Promise<!Response>}\n   */\n  fetch(input, opt_init) {\n    const init = setupInit(opt_init);\n    return this.fetchAmpCors_(input, init).then((response) =>\n      assertSuccess(response)\n    );\n  }\n\n  /**\n   * Sends the request, awaits result and confirms that it was successful.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * See `fetchAmpCors_` for more detail.\n   *\n   * @param {string} input\n   * @param {!FetchInitDef=} opt_init\n   * @return {!Promise}\n   */\n  sendSignal(input, opt_init) {\n    return this.fetchAmpCors_(input, opt_init).then((response) =>\n      assertSuccess(response)\n    );\n  }\n\n  /**\n   * Add \"__amp_source_origin\" query parameter to the URL. Ideally, we'd be\n   * able to set a header (e.g. AMP-Source-Origin), but this will force\n   * preflight request on all CORS request.\n   * @param {!Window} win\n   * @param {string} url\n   * @return {string}\n   */\n  getCorsUrl(win, url) {\n    return getCorsUrl(win, url);\n  }\n}\n\n/**\n * @param {!Window} window\n * @return {!Xhr}\n */\nexport function xhrServiceForTesting(window) {\n  installXhrService(window);\n  return getService(window, 'xhr');\n}\n\n/**\n * @param {!Window} window\n */\nexport function installXhrService(window) {\n  registerServiceBuilder(window, 'xhr', Xhr);\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Xhr} from './xhr-impl';\nimport {getService, registerServiceBuilder} from '../service';\nimport {getSourceOrigin, removeFragment, resolveRelativeUrl} from '../url';\nimport {map} from '../core/types/object';\n\n/**\n * A wrapper around the Xhr service which batches the result of GET requests\n *\n * @package Visible for type.\n * @visibleForTesting\n */\nexport class BatchedXhr extends Xhr {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    super(win);\n\n    /** @const {!Object<!Promise<!Response>>} */\n    this.fetchPromises_ = map();\n  }\n\n  /**\n   * Fetch and batch the requests if possible.\n   *\n   * @param {string} input URL\n   * @param {?FetchInitDef=} opt_init Fetch options object.\n   * @return {!Promise<!Response>}\n   * @override\n   */\n  fetch(input, opt_init) {\n    const accept =\n      (opt_init && opt_init.headers && opt_init.headers['Accept']) || '';\n    const isBatchable =\n      !opt_init || !opt_init.method || opt_init.method === 'GET';\n    const key = this.getMapKey_(input, accept);\n    const isBatched = !!this.fetchPromises_[key];\n\n    if (isBatchable && isBatched) {\n      return this.fetchPromises_[key].then((response) => response.clone());\n    }\n\n    const fetchPromise = super.fetch(input, opt_init);\n\n    if (isBatchable) {\n      this.fetchPromises_[key] = fetchPromise.then(\n        (response) => {\n          delete this.fetchPromises_[key];\n          return response.clone();\n        },\n        (err) => {\n          delete this.fetchPromises_[key];\n          throw err;\n        }\n      );\n    }\n\n    return fetchPromise;\n  }\n\n  /**\n   * Creates a map key for a fetch.\n   *\n   * @param {string} input URL\n   * @param {string} responseType\n   * @return {string}\n   * @private\n   */\n  getMapKey_(input, responseType) {\n    const absoluteUrl = resolveRelativeUrl(\n      input,\n      getSourceOrigin(this.win.location)\n    );\n    return removeFragment(absoluteUrl) + responseType;\n  }\n}\n\n/**\n * @param {!Window} window\n * @return {!BatchedXhr}\n */\nexport function batchedXhrServiceForTesting(window) {\n  installBatchedXhrService(window);\n  return getService(window, 'batched-xhr');\n}\n\n/**\n * @param {!Window} window\n */\nexport function installBatchedXhrService(window) {\n  registerServiceBuilder(window, 'batched-xhr', BatchedXhr);\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {WindowInterface} from '../core/window/interface';\nimport {dev} from '../log';\nimport {dict} from '../core/types/object';\nimport {getCookie, setCookie} from '../cookies';\nimport {isProxyOrigin, parseUrlDeprecated} from '../url';\n\nconst GOOGLE_API_URL =\n  'https://ampcid.google.com/v1/publisher:getClientId?key=';\n\nconst TAG = 'GoogleCidApi';\nconst AMP_TOKEN = 'AMP_TOKEN';\n\n/** @enum {string} */\nexport const TokenStatus = {\n  RETRIEVING: '$RETRIEVING',\n  OPT_OUT: '$OPT_OUT',\n  NOT_FOUND: '$NOT_FOUND',\n  ERROR: '$ERROR',\n};\n\nconst TIMEOUT = 30000;\nconst HOUR = 60 * 60 * 1000;\nconst DAY = 24 * HOUR;\nconst YEAR = 365 * DAY;\n\n/**\n * Client impl for Google CID API\n */\nexport class GoogleCidApi {\n  /** @param {!./ampdoc-impl.AmpDoc} ampdoc */\n  constructor(ampdoc) {\n    /**\n     * @private {!Window}\n     */\n    this.win_ = ampdoc.win;\n    /**\n     * @private {!./timer-impl.Timer}\n     */\n    this.timer_ = Services.timerFor(this.win_);\n\n    /**\n     * @private {!Object<string, !Promise<?string>>}\n     */\n    this.cidPromise_ = {};\n\n    const {canonicalUrl} = Services.documentInfoForDoc(ampdoc);\n\n    /** @private {?string} */\n    this.canonicalOrigin_ = canonicalUrl\n      ? parseUrlDeprecated(canonicalUrl).origin\n      : null;\n  }\n\n  /**\n   * @param {string} apiKey\n   * @param {string} scope\n   * @return {!Promise<?string>}\n   */\n  getScopedCid(apiKey, scope) {\n    if (this.cidPromise_[scope]) {\n      return this.cidPromise_[scope];\n    }\n    let token;\n    // Block the request if a previous request is on flight\n    // Poll every 200ms. Longer interval means longer latency for the 2nd CID.\n    return (this.cidPromise_[scope] = this.timer_\n      .poll(200, () => {\n        token = getCookie(this.win_, AMP_TOKEN);\n        return token !== TokenStatus.RETRIEVING;\n      })\n      .then(() => {\n        if (token === TokenStatus.OPT_OUT) {\n          return TokenStatus.OPT_OUT;\n        }\n        // If the page referrer is proxy origin, we force to use API even the\n        // token indicates a previous fetch returned nothing\n        const forceFetch =\n          token === TokenStatus.NOT_FOUND && this.isReferrerProxyOrigin_();\n\n        // Token is in a special state, fallback to existing cookie\n        if (!forceFetch && this.isStatusToken_(token)) {\n          return null;\n        }\n\n        if (!token || this.isStatusToken_(token)) {\n          this.persistToken_(TokenStatus.RETRIEVING, TIMEOUT);\n        }\n\n        const url = GOOGLE_API_URL + apiKey;\n        return this.fetchCid_(dev().assertString(url), scope, token)\n          .then((response) => {\n            const cid = this.handleResponse_(response);\n            if (!cid && response['alternateUrl']) {\n              // If an alternate url is provided, try again with the alternate\n              // url The client is still responsible for appending API keys to\n              // the URL.\n              const altUrl = `${response['alternateUrl']}?key=${apiKey}`;\n              return this.fetchCid_(\n                dev().assertString(altUrl),\n                scope,\n                token\n              ).then(this.handleResponse_.bind(this));\n            }\n            return cid;\n          })\n          .catch((e) => {\n            this.persistToken_(TokenStatus.ERROR, TIMEOUT);\n            if (e && e.response) {\n              e.response.json().then((res) => {\n                dev().error(TAG, JSON.stringify(res));\n              });\n            } else {\n              dev().error(TAG, e);\n            }\n            return null;\n          });\n      }));\n  }\n\n  /**\n   * @param {string} url\n   * @param {string} scope\n   * @param {?string} token\n   * @return {!Promise<!JsonObject>}\n   */\n  fetchCid_(url, scope, token) {\n    const payload = dict({\n      'originScope': scope,\n      'canonicalOrigin': this.canonicalOrigin_,\n    });\n    if (token) {\n      payload['securityToken'] = token;\n    }\n    return this.timer_.timeoutPromise(\n      TIMEOUT,\n      Services.xhrFor(this.win_)\n        .fetchJson(url, {\n          method: 'POST',\n          ampCors: false,\n          credentials: 'include',\n          mode: 'cors',\n          body: payload,\n        })\n        .then((res) => res.json())\n    );\n  }\n\n  /**\n   * @param {!JsonObject} res\n   * @return {?string}\n   */\n  handleResponse_(res) {\n    if (res['optOut']) {\n      this.persistToken_(TokenStatus.OPT_OUT, YEAR);\n      return TokenStatus.OPT_OUT;\n    }\n    if (res['clientId']) {\n      this.persistToken_(res['securityToken'], YEAR);\n      return res['clientId'];\n    }\n    if (res['alternateUrl']) {\n      return null;\n    }\n    this.persistToken_(TokenStatus.NOT_FOUND, HOUR);\n    return null;\n  }\n\n  /**\n   * @param {string|undefined} tokenValue\n   * @param {number} expires\n   */\n  persistToken_(tokenValue, expires) {\n    if (tokenValue) {\n      setCookie(this.win_, AMP_TOKEN, tokenValue, this.expiresIn_(expires), {\n        highestAvailableDomain: true,\n      });\n    }\n  }\n\n  /**\n   * @param {number} time\n   * @return {number}\n   */\n  expiresIn_(time) {\n    return this.win_.Date.now() + time;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isReferrerProxyOrigin_() {\n    return isProxyOrigin(WindowInterface.getDocumentReferrer(this.win_));\n  }\n\n  /**\n   * @param {?string} token\n   * @return {boolean}\n   */\n  isStatusToken_(token) {\n    return /** @type {boolean} */ (token && token[0] === '$');\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {bytesToString, stringToBytes, utf8Decode, utf8Encode} from './bytes';\n\n/**\n * Character mapping from base64url to base64.\n * @const {!Object<string, string>}\n */\nconst base64UrlDecodeSubs = {'-': '+', '_': '/', '.': '='};\n\n/**\n * Character mapping from base64 to base64url.\n * @const {!Object<string, string>}\n */\nconst base64UrlEncodeSubs = {'+': '-', '/': '_', '=': '.'};\n\n/**\n * Converts a string which is in base64url encoding into a Uint8Array\n * containing the decoded value.\n * @param {string} str\n * @return {!Uint8Array}\n */\nexport function base64UrlDecodeToBytes(str) {\n  const encoded = atob(str.replace(/[-_.]/g, (ch) => base64UrlDecodeSubs[ch]));\n  return stringToBytes(encoded);\n}\n\n/**\n * Converts a string which is in base64 encoding into a Uint8Array\n * containing the decoded value.\n * @param {string} str\n * @return {!Uint8Array}\n */\nexport function base64DecodeToBytes(str) {\n  return stringToBytes(atob(str));\n}\n\n/**\n * Converts a bytes array into base64url encoded string.\n * base64url is defined in RFC 4648. It is sometimes referred to as \"web safe\".\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nexport function base64UrlEncodeFromBytes(bytes) {\n  const str = bytesToString(bytes);\n  return btoa(str).replace(/[+/=]/g, (ch) => base64UrlEncodeSubs[ch]);\n}\n\n/**\n * Converts a string into base64url encoded string.\n * base64url is defined in RFC 4648. It is sometimes referred to as \"web safe\".\n * @param {string} str\n * @return {string}\n */\nexport function base64UrlEncodeFromString(str) {\n  const bytes = utf8Encode(str);\n  return base64UrlEncodeFromBytes(bytes);\n}\n\n/**\n * Decode a base64url encoded string by `base64UrlEncodeFromString`\n * @param {string} str\n * @return {string}\n */\nexport function base64UrlDecodeFromString(str) {\n  const bytes = base64UrlDecodeToBytes(str);\n  return utf8Decode(bytes);\n}\n\n/**\n * Converts a bytes array into base64 encoded string.\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nexport function base64EncodeFromBytes(bytes) {\n  return btoa(bytesToString(bytes));\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Provides per AMP document source origin and use case\n * persistent client identifiers for use in analytics and similar use\n * cases.\n *\n * For details, see https://goo.gl/Mwaacs\n */\n\nimport {CacheCidApi} from './cache-cid-api';\nimport {GoogleCidApi, TokenStatus} from './cid-api';\nimport {Services} from '../services';\nimport {ViewerCidApi} from './viewer-cid-api';\nimport {base64UrlEncodeFromBytes} from '../core/types/string/base64';\nimport {dev, user, userAssert} from '../log';\nimport {dict} from '../core/types/object';\nimport {getCookie, setCookie} from '../cookies';\nimport {getCryptoRandomBytesArray} from '../core/types/string/bytes';\nimport {getServiceForDoc, registerServiceBuilderForDoc} from '../service';\nimport {getSourceOrigin, isProxyOrigin, parseUrlDeprecated} from '../url';\nimport {isExperimentOn} from '../../src/experiments';\nimport {isIframed} from '../dom';\nimport {parseJson, tryParseJson} from '../core/types/object/json';\nimport {rethrowAsync} from '../core/error';\nimport {tryResolve} from '../core/data-structures/promise';\n\nconst ONE_DAY_MILLIS = 24 * 3600 * 1000;\n\n/**\n * We ignore base cids that are older than (roughly) one year.\n */\nexport const BASE_CID_MAX_AGE_MILLIS = 365 * ONE_DAY_MILLIS;\n\nconst SCOPE_NAME_VALIDATOR = /^[a-zA-Z0-9-_.]+$/;\n\nconst CID_OPTOUT_STORAGE_KEY = 'amp-cid-optout';\n\nconst CID_OPTOUT_VIEWER_MESSAGE = 'cidOptOut';\n\nconst CID_BACKUP_STORAGE_KEY = 'amp-cid:';\n\n/**\n * Tag for debug logging.\n * @const @private {string}\n */\nconst TAG_ = 'CID';\n\n/**\n * The name of the Google CID API as it appears in the meta tag to opt-in.\n * @const @private {string}\n */\nconst GOOGLE_CID_API_META_NAME = 'amp-google-client-id-api';\n\n/**\n * The mapping from analytics providers to CID scopes.\n * @const @private {Object<string, string>}\n */\nconst CID_API_SCOPE_ALLOWLIST = {\n  'googleanalytics': 'AMP_ECID_GOOGLE',\n};\n\n/**\n * The mapping from analytics providers to their CID API service keys.\n * @const @private {Object<string, string>}\n */\nconst API_KEYS = {\n  'googleanalytics': 'AIzaSyA65lEHUEizIsNtlbNo-l2K18dT680nsaM',\n};\n\n/**\n * A base cid string value and the time it was last read / stored.\n * @typedef {{time: time, cid: string}}\n */\nlet BaseCidInfoDef;\n\n/**\n * The \"get CID\" parameters.\n * - createCookieIfNotPresent: Whether CID is allowed to create a cookie when.\n *   Default value is `false`.\n * - cookieName: Name of the cookie to be used if defined for non-proxy case.\n * - disableBackup: Whether CID should not be backed up in Storage.\n *   Default value is `false`.\n * @typedef {{\n *   scope: string,\n *   createCookieIfNotPresent: (boolean|undefined),\n *   cookieName: (string|undefined),\n *   disableBackup: (boolean|undefined),\n * }}\n */\nlet GetCidDef;\n\n/**\n * @interface\n */\nexport class CidDef {\n  /**\n   * @param {!GetCidDef} unusedGetCidStruct an object provides CID scope name for\n   *     proxy case and cookie name for non-proxy case.\n   * @param {!Promise} unusedConsent Promise for when the user has given consent\n   *     (if deemed necessary by the publisher) for use of the client\n   *     identifier.\n   * @param {!Promise=} opt_persistenceConsent Dedicated promise for when\n   *     it is OK to persist a new tracking identifier. This could be\n   *     supplied ONLY by the code that supplies the actual consent\n   *     cookie.\n   *     If this is given, the consent param should be a resolved promise\n   *     because this call should be only made in order to get consent.\n   *     The consent promise passed to other calls should then itself\n   *     depend on the opt_persistenceConsent promise (and the actual\n   *     consent, of course).\n   * @return {!Promise<?string>} A client identifier that should be used\n   *      within the current source origin and externalCidScope. Might be\n   *      null if user has opted out of cid or no identifier was found\n   *      or it could be made.\n   *      This promise may take a long time to resolve if consent isn't\n   *      given.\n   */\n  get(unusedGetCidStruct, unusedConsent, opt_persistenceConsent) {}\n\n  /**\n   * User will be opted out of Cid issuance for all scopes.\n   * When opted-out Cid service will reject all `get` requests.\n   *\n   * @return {!Promise}\n   */\n  optOut() {}\n}\n\n/**\n * @implements {CidDef}\n */\nclass Cid {\n  /** @param {!./ampdoc-impl.AmpDoc} ampdoc */\n  constructor(ampdoc) {\n    /** @const */\n    this.ampdoc = ampdoc;\n\n    /**\n     * Cached base cid once read from storage to avoid repeated\n     * reads.\n     * @private {?Promise<string>}\n     * @restricted\n     */\n    this.baseCid_ = null;\n\n    /**\n     * Cache to store external cids. Scope is used as the key and cookie value\n     * is the value.\n     * @private {!Object<string, !Promise<string>>}\n     * @restricted\n     */\n    this.externalCidCache_ = Object.create(null);\n\n    /**\n     * @private @const {!CacheCidApi}\n     */\n    this.cacheCidApi_ = new CacheCidApi(ampdoc);\n\n    /**\n     * @private {!ViewerCidApi}\n     */\n    this.viewerCidApi_ = new ViewerCidApi(ampdoc);\n\n    this.cidApi_ = new GoogleCidApi(ampdoc);\n\n    /** @private {?Object<string, string>} */\n    this.apiKeyMap_ = null;\n\n    /** @const {boolean} */\n    this.isBackupCidExpOn = isExperimentOn(this.ampdoc.win, 'amp-cid-backup');\n  }\n\n  /** @override */\n  get(getCidStruct, consent, opt_persistenceConsent) {\n    userAssert(\n      SCOPE_NAME_VALIDATOR.test(getCidStruct.scope) &&\n        SCOPE_NAME_VALIDATOR.test(getCidStruct.cookieName),\n      'The CID scope and cookie name must only use the characters ' +\n        '[a-zA-Z0-9-_.]+\\nInstead found: %s',\n      getCidStruct.scope\n    );\n    return consent\n      .then(() => {\n        return this.ampdoc.whenFirstVisible();\n      })\n      .then(() => {\n        // Check if user has globally opted out of CID, we do this after\n        // consent check since user can optout during consent process.\n        return isOptedOutOfCid(this.ampdoc);\n      })\n      .then((optedOut) => {\n        if (optedOut) {\n          return '';\n        }\n        const cidPromise = this.getExternalCid_(\n          getCidStruct,\n          opt_persistenceConsent || consent\n        );\n        // Getting the CID might involve an HTTP request. We timeout after 10s.\n        return Services.timerFor(this.ampdoc.win)\n          .timeoutPromise(\n            10000,\n            cidPromise,\n            `Getting cid for \"${getCidStruct.scope}\" timed out`\n          )\n          .catch((error) => {\n            rethrowAsync(error);\n          });\n      });\n  }\n\n  /** @override */\n  optOut() {\n    return optOutOfCid(this.ampdoc);\n  }\n\n  /**\n   * Returns the \"external cid\". This is a cid for a specific purpose\n   * (Say Analytics provider X). It is unique per user, userAssert, that purpose\n   * and the AMP origin site.\n   * @param {!GetCidDef} getCidStruct\n   * @param {!Promise} persistenceConsent\n   * @return {!Promise<?string>}\n   */\n  getExternalCid_(getCidStruct, persistenceConsent) {\n    const {scope} = getCidStruct;\n    /** @const {!Location} */\n    const url = parseUrlDeprecated(this.ampdoc.win.location.href);\n    if (!isProxyOrigin(url)) {\n      const apiKey = this.isScopeOptedIn_(scope);\n      if (apiKey) {\n        return this.cidApi_.getScopedCid(apiKey, scope).then((scopedCid) => {\n          if (scopedCid == TokenStatus.OPT_OUT) {\n            return null;\n          }\n          if (scopedCid) {\n            const cookieName = getCidStruct.cookieName || scope;\n            setCidCookie(this.ampdoc.win, cookieName, scopedCid);\n            return scopedCid;\n          }\n          return getOrCreateCookie(this, getCidStruct, persistenceConsent);\n        });\n      }\n      return getOrCreateCookie(this, getCidStruct, persistenceConsent);\n    }\n\n    return this.viewerCidApi_.isSupported().then((supported) => {\n      if (supported) {\n        const apiKey = this.isScopeOptedIn_(scope);\n        return this.viewerCidApi_.getScopedCid(apiKey, scope);\n      }\n\n      if (this.cacheCidApi_.isSupported() && this.isScopeOptedIn_(scope)) {\n        return this.cacheCidApi_.getScopedCid(scope).then((scopedCid) => {\n          if (scopedCid) {\n            return scopedCid;\n          }\n          return this.scopeBaseCid_(persistenceConsent, scope, url);\n        });\n      }\n      return this.scopeBaseCid_(persistenceConsent, scope, url);\n    });\n  }\n\n  /**\n   *\n   * @param {!Promise} persistenceConsent\n   * @param {*} scope\n   * @param {!Location} url\n   * @return {*}\n   */\n  scopeBaseCid_(persistenceConsent, scope, url) {\n    return getBaseCid(this, persistenceConsent).then((baseCid) => {\n      return Services.cryptoFor(this.ampdoc.win).sha384Base64(\n        baseCid + getProxySourceOrigin(url) + scope\n      );\n    });\n  }\n\n  /**\n   * Checks if the page has opted in CID API for the given scope.\n   * Returns the API key that should be used, or null if page hasn't opted in.\n   *\n   * @param {string} scope\n   * @return {string|undefined}\n   */\n  isScopeOptedIn_(scope) {\n    if (!this.apiKeyMap_) {\n      this.apiKeyMap_ = this.getOptedInScopes_();\n    }\n    return this.apiKeyMap_[scope];\n  }\n\n  /**\n   * Reads meta tags for opted in scopes.  Meta tags will have the form\n   * <meta name=\"provider-api-name\" content=\"provider-name\">\n   * @return {!Object<string, string>}\n   */\n  getOptedInScopes_() {\n    const apiKeyMap = {};\n    const optInMeta = this.ampdoc.getMetaByName(GOOGLE_CID_API_META_NAME);\n    if (optInMeta) {\n      optInMeta.split(',').forEach((item) => {\n        item = item.trim();\n        if (item.indexOf('=') > 0) {\n          const pair = item.split('=');\n          const scope = pair[0].trim();\n          apiKeyMap[scope] = pair[1].trim();\n        } else {\n          const clientName = item;\n          const scope = CID_API_SCOPE_ALLOWLIST[clientName];\n          if (scope) {\n            apiKeyMap[scope] = API_KEYS[clientName];\n          } else {\n            user().warn(\n              TAG_,\n              `Unsupported client for Google CID API: ${clientName}.` +\n                `Please remove or correct meta[name=\"${GOOGLE_CID_API_META_NAME}\"]`\n            );\n          }\n        }\n      });\n    }\n    return apiKeyMap;\n  }\n}\n\n/**\n * User will be opted out of Cid issuance for all scopes.\n * When opted-out Cid service will reject all `get` requests.\n *\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise}\n * @visibleForTesting\n */\nexport function optOutOfCid(ampdoc) {\n  // Tell the viewer that user has opted out.\n  Services.viewerForDoc(ampdoc)./*OK*/ sendMessage(\n    CID_OPTOUT_VIEWER_MESSAGE,\n    dict()\n  );\n\n  // Store the optout bit in storage\n  return Services.storageForDoc(ampdoc).then((storage) => {\n    return storage.set(CID_OPTOUT_STORAGE_KEY, true);\n  });\n}\n\n/**\n * Whether user has opted out of Cid issuance for all scopes.\n *\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<boolean>}\n * @visibleForTesting\n */\nexport function isOptedOutOfCid(ampdoc) {\n  return Services.storageForDoc(ampdoc)\n    .then((storage) => {\n      return storage.get(CID_OPTOUT_STORAGE_KEY).then((val) => !!val);\n    })\n    .catch(() => {\n      // If we fail to read the flag, assume not opted out.\n      return false;\n    });\n}\n\n/**\n * Sets a new CID cookie for expire 1 year from now.\n * @param {!Window} win\n * @param {string} scope\n * @param {string} cookie\n */\nfunction setCidCookie(win, scope, cookie) {\n  const expiration = Date.now() + BASE_CID_MAX_AGE_MILLIS;\n  setCookie(win, scope, cookie, expiration, {\n    highestAvailableDomain: true,\n  });\n}\n\n/**\n * Sets a new CID backup in Storage\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {string} cookieName\n * @param {string} cookie\n */\nfunction setCidBackup(ampdoc, cookieName, cookie) {\n  Services.storageForDoc(ampdoc).then((storage) => {\n    const isViewerStorage = storage.isViewerStorage();\n    if (!isViewerStorage) {\n      const key = getStorageKey(cookieName);\n      storage.setNonBoolean(key, cookie);\n    }\n  });\n}\n\n/**\n * @param {string} cookieName\n * @return {string}\n */\nfunction getStorageKey(cookieName) {\n  return CID_BACKUP_STORAGE_KEY + cookieName;\n}\n\n/**\n * Maybe gets the CID from cookie or, if allowed, gets backup CID\n * from Storage.\n * @param {!Cid} cid\n * @param {!GetCidDef} getCidStruct\n * @return {!Promise<?string>}\n */\nfunction maybeGetCidFromCookieOrBackup(cid, getCidStruct) {\n  const {ampdoc, isBackupCidExpOn} = cid;\n  const {win} = ampdoc;\n  const {disableBackup, scope} = getCidStruct;\n  const cookieName = getCidStruct.cookieName || scope;\n  const existingCookie = getCookie(win, cookieName);\n\n  if (existingCookie) {\n    return Promise.resolve(existingCookie);\n  }\n  if (isBackupCidExpOn && !disableBackup) {\n    return Services.storageForDoc(ampdoc)\n      .then((storage) => {\n        const key = getStorageKey(cookieName);\n        return storage.get(key, BASE_CID_MAX_AGE_MILLIS);\n      })\n      .then((backupCid) => {\n        if (!backupCid || typeof backupCid != 'string') {\n          return null;\n        }\n        return backupCid;\n      });\n  }\n  return Promise.resolve(null);\n}\n\n/**\n * If cookie exists it's returned immediately. Otherwise, if instructed, the\n * new cookie is created.\n * @param {!Cid} cid\n * @param {!GetCidDef} getCidStruct\n * @param {!Promise} persistenceConsent\n * @return {!Promise<?string>}\n */\nfunction getOrCreateCookie(cid, getCidStruct, persistenceConsent) {\n  const {ampdoc, isBackupCidExpOn} = cid;\n  const {win} = ampdoc;\n  const {disableBackup, scope} = getCidStruct;\n  const cookieName = getCidStruct.cookieName || scope;\n\n  return maybeGetCidFromCookieOrBackup(cid, getCidStruct).then(\n    (existingCookie) => {\n      if (!existingCookie && !getCidStruct.createCookieIfNotPresent) {\n        return /** @type {!Promise<?string>} */ (Promise.resolve(null));\n      }\n\n      if (existingCookie) {\n        // If we created the cookie, update it's expiration time.\n        if (/^amp-/.test(existingCookie)) {\n          setCidCookie(win, cookieName, existingCookie);\n          if (isBackupCidExpOn && !disableBackup) {\n            setCidBackup(ampdoc, cookieName, existingCookie);\n          }\n        }\n        return /** @type {!Promise<?string>} */ (\n          Promise.resolve(existingCookie)\n        );\n      }\n\n      if (cid.externalCidCache_[scope]) {\n        return /** @type {!Promise<?string>} */ (cid.externalCidCache_[scope]);\n      }\n\n      const newCookiePromise = getRandomString64(win)\n        // Create new cookie, always prefixed with \"amp-\", so that we can see from\n        // the value whether we created it.\n        .then((randomStr) => 'amp-' + randomStr);\n\n      // Store it as a cookie based on the persistence consent.\n      Promise.all([newCookiePromise, persistenceConsent]).then((results) => {\n        // The initial CID generation is inherently racy. First one that gets\n        // consent wins.\n        const newCookie = results[0];\n        const relookup = getCookie(win, cookieName);\n        if (!relookup) {\n          setCidCookie(win, cookieName, newCookie);\n          if (isBackupCidExpOn && !disableBackup) {\n            setCidBackup(ampdoc, cookieName, newCookie);\n          }\n        }\n      });\n      return (cid.externalCidCache_[scope] = newCookiePromise);\n    }\n  );\n}\n\n/**\n * Returns the source origin of an AMP document for documents served\n * on a proxy origin. Throws an error if the doc is not on a proxy origin.\n * @param {!Location} url URL of an AMP document.\n * @return {string} The source origin of the URL.\n * @visibleForTesting BUT if this is needed elsewhere it could be\n *     factored into its own package.\n */\nexport function getProxySourceOrigin(url) {\n  userAssert(isProxyOrigin(url), 'Expected proxy origin %s', url.origin);\n  return getSourceOrigin(url);\n}\n\n/**\n * Returns the base cid for the current user(). This string must not\n * be exposed to users without hashing with the current source origin\n * and the externalCidScope.\n * On a proxy this value is the same for a user across all source\n * origins.\n * @param {!Cid} cid\n * @param {!Promise} persistenceConsent\n * @return {!Promise<string>}\n */\nfunction getBaseCid(cid, persistenceConsent) {\n  if (cid.baseCid_) {\n    return cid.baseCid_;\n  }\n  const {win} = cid.ampdoc;\n\n  return (cid.baseCid_ = read(cid.ampdoc).then((stored) => {\n    let needsToStore = false;\n    let baseCid;\n\n    // See if we have a stored base cid and whether it is still valid\n    // in terms of expiration.\n    if (stored && !isExpired(stored)) {\n      baseCid = Promise.resolve(stored.cid);\n      if (shouldUpdateStoredTime(stored)) {\n        needsToStore = true;\n      }\n    } else {\n      // We need to make a new one.\n      baseCid = Services.cryptoFor(win).sha384Base64(getEntropy(win));\n      needsToStore = true;\n    }\n\n    if (needsToStore) {\n      baseCid.then((baseCid) => {\n        store(cid.ampdoc, persistenceConsent, baseCid);\n      });\n    }\n\n    return baseCid;\n  }));\n}\n\n/**\n * Stores a new cidString in localStorage. Adds the current time to the\n * stored value.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Promise} persistenceConsent\n * @param {string} cidString Actual cid string to store.\n */\nfunction store(ampdoc, persistenceConsent, cidString) {\n  const {win} = ampdoc;\n  if (isIframed(win)) {\n    // If we are being embedded, try to save the base cid to the viewer.\n    viewerBaseCid(ampdoc, createCidData(cidString));\n  } else {\n    // To use local storage, we need user's consent.\n    persistenceConsent.then(() => {\n      try {\n        win.localStorage.setItem('amp-cid', createCidData(cidString));\n      } catch (ignore) {\n        // Setting localStorage may fail. In practice we don't expect that to\n        // happen a lot (since we don't go anywhere near the quota, but\n        // in particular in Safari private browsing mode it always fails.\n        // In that case we just don't store anything, which is just fine.\n      }\n    });\n  }\n}\n\n/**\n * Get/set the Base CID from/to the viewer.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {string=} opt_data Stringified JSON object {cid, time}.\n * @return {!Promise<string|undefined>}\n */\nexport function viewerBaseCid(ampdoc, opt_data) {\n  const viewer = Services.viewerForDoc(ampdoc);\n  return viewer.isTrustedViewer().then((trusted) => {\n    if (!trusted) {\n      return undefined;\n    }\n    // TODO(lannka, #11060): clean up when all Viewers get migrated\n    dev().expectedError('CID', 'Viewer does not provide cap=cid');\n    return viewer.sendMessageAwaitResponse('cid', opt_data).then((data) => {\n      // For backward compatibility: #4029\n      if (data && !tryParseJson(data)) {\n        // TODO(lannka, #11060): clean up when all Viewers get migrated\n        dev().expectedError('CID', 'invalid cid format');\n        return JSON.stringify(\n          dict({\n            'time': Date.now(), // CID returned from old API is always fresh\n            'cid': data,\n          })\n        );\n      }\n      return data;\n    });\n  });\n}\n\n/**\n * Creates a JSON object that contains the given CID and the current time as\n * a timestamp.\n * @param {string} cidString\n * @return {string}\n */\nfunction createCidData(cidString) {\n  return JSON.stringify(\n    dict({\n      'time': Date.now(),\n      'cid': cidString,\n    })\n  );\n}\n\n/**\n * Gets the persisted CID data as a promise. It tries to read from\n * localStorage first then from viewer if it is in embedded mode.\n * Returns null if none was found.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<?BaseCidInfoDef>}\n */\nfunction read(ampdoc) {\n  const {win} = ampdoc;\n  let data;\n  try {\n    data = win.localStorage.getItem('amp-cid');\n  } catch (ignore) {\n    // If reading from localStorage fails, we assume it is empty.\n  }\n  let dataPromise = Promise.resolve(data);\n  if (!data && isIframed(win)) {\n    // If we are being embedded, try to get the base cid from the viewer.\n    dataPromise = viewerBaseCid(ampdoc);\n  }\n  return dataPromise.then((data) => {\n    if (!data) {\n      return null;\n    }\n    const item = parseJson(data);\n    return {\n      time: item['time'],\n      cid: item['cid'],\n    };\n  });\n}\n\n/**\n * Whether the retrieved cid object is expired and should be ignored.\n * @param {!BaseCidInfoDef} storedCidInfo\n * @return {boolean}\n */\nfunction isExpired(storedCidInfo) {\n  const createdTime = storedCidInfo.time;\n  const now = Date.now();\n  return createdTime + BASE_CID_MAX_AGE_MILLIS < now;\n}\n\n/**\n * Whether we should write a new timestamp to the stored cid value.\n * We say yes if it is older than 1 day, so we only do this max once\n * per day to avoid writing to localStorage all the time.\n * @param {!BaseCidInfoDef} storedCidInfo\n * @return {boolean}\n */\nfunction shouldUpdateStoredTime(storedCidInfo) {\n  const createdTime = storedCidInfo.time;\n  const now = Date.now();\n  return createdTime + ONE_DAY_MILLIS < now;\n}\n\n/**\n * Returns an array with a total of 128 of random values based on the\n * `win.crypto.getRandomValues` API. If that is not available concatenates\n * a string of other values that might be hard to guess including\n * `Math.random` and the current time.\n * @param {!Window} win\n * @return {!Uint8Array|string} Entropy.\n */\nfunction getEntropy(win) {\n  // Use win.crypto.getRandomValues to get 128 bits of random value\n  const uint8array = getCryptoRandomBytesArray(win, 16); // 128 bit\n  if (uint8array) {\n    return uint8array;\n  }\n\n  // Support for legacy browsers.\n  return String(\n    win.location.href +\n      Date.now() +\n      win.Math.random() +\n      win.screen.width +\n      win.screen.height\n  );\n}\n\n/**\n * Produces an external CID for use in a cookie.\n * @param {!Window} win\n * @return {!Promise<string>} The cid\n */\nexport function getRandomString64(win) {\n  const entropy = getEntropy(win);\n  if (typeof entropy == 'string') {\n    return Services.cryptoFor(win).sha384Base64(entropy);\n  } else {\n    // If our entropy is a pure random number, we can just directly turn it\n    // into base 64\n    const cast = /** @type {!Uint8Array} */ (entropy);\n    return tryResolve(() =>\n      base64UrlEncodeFromBytes(cast)\n        // Remove trailing padding\n        .replace(/\\.+$/, '')\n    );\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {*} TODO(#23582): Specify return type\n */\nexport function installCidService(ampdoc) {\n  return registerServiceBuilderForDoc(ampdoc, 'cid', Cid);\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Cid}\n * @private visible for testing\n */\nexport function cidServiceForDocForTesting(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'cid', Cid);\n  return getServiceForDoc(ampdoc, 'cid');\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {base64UrlEncodeFromBytes} from '../core/types/string/base64';\nimport {dev, devAssert, user} from '../log';\nimport {getService, registerServiceBuilder} from '../service';\nimport {stringToBytes, utf8Encode} from '../core/types/string/bytes';\n\n/** @const {string} */\nconst TAG = 'Crypto';\n\n/**\n * @typedef {function((string|Uint8Array))}\n */\nlet CryptoPolyfillDef;\n\nexport class Crypto {\n  /**\n   * Creates an instance of Crypto.\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private {!Window} */\n    this.win_ = win;\n\n    let subtle = null;\n    let isLegacyWebkit = false;\n    if (win.crypto) {\n      if (win.crypto.subtle) {\n        subtle = win.crypto.subtle;\n      } else if (win.crypto.webkitSubtle) {\n        subtle = win.crypto.webkitSubtle;\n        isLegacyWebkit = true;\n      }\n    }\n\n    /** @const {{name: string}} */\n    this.pkcsAlgo = {\n      name: 'RSASSA-PKCS1-v1_5',\n      hash: {name: 'SHA-256'},\n    };\n\n    /** @const {?webCrypto.SubtleCrypto} */\n    this.subtle = subtle;\n\n    /** @private @const {boolean} */\n    this.isLegacyWebkit_ = isLegacyWebkit;\n\n    /** @private {?Promise<!CryptoPolyfillDef>} */\n    this.polyfillPromise_ = null;\n  }\n\n  /**\n   * Returns the SHA-384 hash of the input string in a number array.\n   * Input string cannot contain chars out of range [0,255].\n   * @param {string|!Uint8Array} input\n   * @return {!Promise<!Uint8Array>}\n   * @throws {!Error} when input string contains chars out of range [0,255]\n   */\n  sha384(input) {\n    if (typeof input === 'string') {\n      input = stringToBytes(input);\n    }\n\n    if (!this.subtle || this.polyfillPromise_) {\n      // means native Crypto API is not available or failed before.\n      return (this.polyfillPromise_ || this.loadPolyfill_()).then(\n        (polyfillSha384) => polyfillSha384(input)\n      );\n    }\n\n    try {\n      return (\n        this.subtle\n          .digest({name: 'SHA-384'}, input)\n          /** @param {?} buffer */\n          .then(\n            (buffer) => new Uint8Array(buffer),\n            (e) => {\n              // Chrome doesn't allow the usage of Crypto API under\n              // non-secure origin: https://www.chromium.org/Home/chromium-security/prefer-secure-origins-for-powerful-new-features\n              if (e.message && e.message.indexOf('secure origin') < 0) {\n                // Log unexpected fallback.\n                user().error(\n                  TAG,\n                  'SubtleCrypto failed, fallback to closure lib.',\n                  e\n                );\n              }\n              return this.loadPolyfill_().then(() => this.sha384(input));\n            }\n          )\n      );\n    } catch (e) {\n      dev().error(TAG, 'SubtleCrypto failed, fallback to closure lib.', e);\n      return this.loadPolyfill_().then(() => this.sha384(input));\n    }\n  }\n\n  /**\n   * Returns the SHA-384 hash of the input string in the format of web safe\n   * base64 (using -_. instead of +/=).\n   * Input string cannot contain chars out of range [0,255].\n   * @param {string|!Uint8Array} input\n   * @return {!Promise<string>}\n   * @throws {!Error} when input string contains chars out of range [0,255]\n   */\n  sha384Base64(input) {\n    return this.sha384(input).then((buffer) =>\n      base64UrlEncodeFromBytes(buffer)\n    );\n  }\n\n  /**\n   * Returns a uniform hash of the input string as a float number in the range\n   * of [0, 1).\n   * Input string cannot contain chars out of range [0,255].\n   * @param {string|!Uint8Array} input\n   * @return {!Promise<number>}\n   */\n  uniform(input) {\n    return this.sha384(input).then((buffer) => {\n      // Consider the Uint8 array as a base256 fraction number,\n      // then convert it to the decimal form.\n      let result = 0;\n      for (let i = 2; i >= 0; i--) {\n        // 3 base256 digits give enough precision\n        result = (result + buffer[i]) / 256;\n      }\n      return result;\n    });\n  }\n\n  /**\n   * Loads Crypto polyfill library.\n   * @return {!Promise<!CryptoPolyfillDef>}\n   * @private\n   */\n  loadPolyfill_() {\n    if (this.polyfillPromise_) {\n      return this.polyfillPromise_;\n    }\n    return (this.polyfillPromise_ = Services.extensionsFor(this.win_)\n      .preloadExtension('amp-crypto-polyfill')\n      .then(() => getService(this.win_, 'crypto-polyfill')));\n  }\n\n  /**\n   * Checks whether Web Cryptography is available, which is required for PKCS 1\n   * operations. SHA-384 operations do not need this because there's a polyfill.\n   * This could be false if the browser does not support Web Cryptography, or if\n   * the current browsing context is not secure (e.g., it's on an insecure HTTP\n   * page, or an HTTPS iframe embedded in an insecure HTTP page).\n   *\n   * @return {boolean} whether Web Cryptography is available\n   */\n  isPkcsAvailable() {\n    return Boolean(this.subtle) && this.win_['isSecureContext'] !== false;\n  }\n\n  /**\n   * Converts an RSA JSON Web Key object to a browser-native cryptographic key.\n   * As a precondition, `isPkcsAvailable()` must be `true`.\n   *\n   * @param {!Object} jwk a deserialized RSA JSON Web Key, as specified in\n   *     Section 6.3 of RFC 7518\n   * @return {!Promise<!webCrypto.CryptoKey>}\n   * @throws {TypeError} if `jwk` is not an RSA JSON Web Key\n   */\n  importPkcsKey(jwk) {\n    devAssert(this.isPkcsAvailable());\n    // Safari 10 and earlier want this as an ArrayBufferView.\n    const keyData = this.isLegacyWebkit_\n      ? utf8Encode(JSON.stringify(/** @type {!JsonObject} */ (jwk)))\n      : /** @type {!webCrypto.JsonWebKey} */ (jwk);\n    return /** @type {!Promise<!webCrypto.CryptoKey>} */ (\n      this.subtle.importKey('jwk', keyData, this.pkcsAlgo, true, ['verify'])\n    );\n  }\n\n  /**\n   * Verifies an RSASSA-PKCS1-v1_5 signature with a SHA-256 hash. As a\n   * precondition, `isPkcsAvailable()` must be `true`.\n   *\n   * @param {!webCrypto.CryptoKey} key an RSA public key\n   * @param {!Uint8Array} signature an RSASSA-PKCS1-v1_5 signature\n   * @param {!BufferSource} data the data that was signed\n   * @return {!Promise<boolean>} whether the signature is correct for the given\n   *     data and public key\n   */\n  verifyPkcs(key, signature, data) {\n    devAssert(this.isPkcsAvailable());\n    return /** @type {!Promise<boolean>} */ (\n      this.subtle.verify(this.pkcsAlgo, key, signature, data)\n    );\n  }\n}\n\n/**\n * @param {!Window} win\n * @return {*} TODO(#23582): Specify return type\n */\nexport function installCryptoService(win) {\n  return registerServiceBuilder(win, 'crypto', Crypto);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getProxyServingType, getSourceUrl, parseUrlDeprecated} from '../url';\nimport {getRandomString64} from './cid-impl';\nimport {isArray} from '../core/types';\nimport {map} from '../core/types/object';\nimport {parseQueryString} from '../core/types/string/url';\nimport {registerServiceBuilderForDoc} from '../service';\n\n/** @private @const {!Array<string>} */\nconst filteredLinkRels = ['prefetch', 'preload', 'preconnect', 'dns-prefetch'];\n\n/**\n * Properties:\n *     - sourceUrl: the source url of an amp document.\n *     - canonicalUrl: The doc's canonical.\n *     - pageViewId: Id for this page view. Low entropy but should be unique\n *     - pageViewId64: Id for this page view. High entropy but should be unique\n *       for concurrent page views of a user().\n *     - linkRels: A map object of link tag's rel (key) and corresponding\n *       hrefs (value). rel could be 'canonical', 'icon', etc.\n *     - viewport: The global doc's viewport.\n *     - replaceParams: A map object of extra query string parameter names (key)\n *       to corresponding values, used for custom analytics.\n *       Null if not applicable.\n *\n * @typedef {{\n *   sourceUrl: string,\n *   canonicalUrl: string,\n *   pageViewId: string,\n *   pageViewId64: !Promise<string>,\n *   linkRels: !Object<string, string|!Array<string>>,\n *   viewport: ?string,\n *   replaceParams: ?Object<string, string|!Array<string>>\n * }}\n */\nexport let DocumentInfoDef;\n\n/**\n * @param {!Node|!./ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {*} TODO(#23582): Specify return type\n */\nexport function installDocumentInfoServiceForDoc(nodeOrDoc) {\n  return registerServiceBuilderForDoc(nodeOrDoc, 'documentInfo', DocInfo);\n}\n\nexport class DocInfo {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @private @const  */\n    this.ampdoc_ = ampdoc;\n    /** @private {?DocumentInfoDef} */\n    this.info_ = null;\n    /** @private {?Promise<string>} */\n    this.pageViewId64_ = null;\n  }\n\n  /** @return {!DocumentInfoDef} */\n  get() {\n    if (this.info_) {\n      return this.info_;\n    }\n    const ampdoc = this.ampdoc_;\n    const url = ampdoc.getUrl();\n    const sourceUrl = getSourceUrl(url);\n    const rootNode = ampdoc.getRootNode();\n    let canonicalUrl = rootNode && rootNode.AMP && rootNode.AMP.canonicalUrl;\n    if (!canonicalUrl) {\n      const canonicalTag = rootNode.querySelector('link[rel=canonical]');\n      canonicalUrl = canonicalTag\n        ? parseUrlDeprecated(canonicalTag.href).href\n        : sourceUrl;\n    }\n    const pageViewId = getPageViewId(ampdoc.win);\n    const linkRels = getLinkRels(ampdoc.win.document);\n    const viewport = getViewport(ampdoc.win.document);\n    const replaceParams = getReplaceParams(ampdoc);\n\n    return (this.info_ = {\n      /** @return {string} */\n      get sourceUrl() {\n        return getSourceUrl(ampdoc.getUrl());\n      },\n      canonicalUrl,\n      pageViewId,\n      get pageViewId64() {\n        // Must be calculated async since getRandomString64() can load the\n        // amp-crypto-polyfill on some browsers, and extensions service\n        // may not be registered yet.\n        if (!this.pageViewId64_) {\n          this.pageViewId64_ = getRandomString64(ampdoc.win);\n        }\n        return this.pageViewId64_;\n      },\n      linkRels,\n      viewport,\n      replaceParams,\n    });\n  }\n}\n\n/**\n * Returns a relatively low entropy random string.\n * This should be called once per window and then cached for subsequent\n * access to the same value to be persistent per page.\n * @param {!Window} win\n * @return {string}\n */\nfunction getPageViewId(win) {\n  return String(Math.floor(win.Math.random() * 10000));\n}\n\n/**\n * Returns a map object of link tag relations in document head.\n * Key is the link rel, value is a list of corresponding hrefs.\n * @param {!Document} doc\n * @return {!JsonObject<string, string|!Array<string>>}\n */\nfunction getLinkRels(doc) {\n  const linkRels = map();\n  if (doc.head) {\n    const links = doc.head.querySelectorAll('link[rel]');\n    for (let i = 0; i < links.length; i++) {\n      const link = links[i];\n      const {href} = link;\n      const rels = link.getAttribute('rel');\n      if (!rels || !href) {\n        continue;\n      }\n\n      rels.split(/\\s+/).forEach((rel) => {\n        if (filteredLinkRels.indexOf(rel) != -1) {\n          return;\n        }\n\n        let value = linkRels[rel];\n        if (value) {\n          // Change to array if more than one href for the same rel\n          if (!isArray(value)) {\n            value = linkRels[rel] = [value];\n          }\n          value.push(href);\n        } else {\n          linkRels[rel] = href;\n        }\n      });\n    }\n  }\n  return linkRels;\n}\n\n/**\n * Returns the viewport of the document. Note that this is the viewport of the\n * host document for AmpDocShadow instances.\n * @param {!Document} doc\n * @return {?string}\n */\nfunction getViewport(doc) {\n  const viewportEl = doc.head.querySelector('meta[name=\"viewport\"]');\n  return viewportEl ? viewportEl.getAttribute('content') : null;\n}\n\n/**\n * Attempts to retrieve extra parameters from the \"amp_r\" query param,\n * returning null if invalid.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {?JsonObject<string, string|!Array<string>>}\n */\nfunction getReplaceParams(ampdoc) {\n  // The \"amp_r\" parameter is only supported for ads.\n  if (\n    !ampdoc.isSingleDoc() ||\n    getProxyServingType(ampdoc.win.location.href) != 'a'\n  ) {\n    return null;\n  }\n  const url = parseUrlDeprecated(ampdoc.win.location.href);\n  const replaceRaw = parseQueryString(url.search)['amp_r'];\n  if (replaceRaw === undefined) {\n    // Differentiate the case between empty replace params and invalid result\n    return null;\n  }\n  return parseQueryString(replaceRaw);\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ActionTrust} from './core/constants/action-constants';\nimport {\n  SOURCE_ORIGIN_PARAM,\n  assertHttpsUrl,\n  checkCorsUrl,\n  isProxyOrigin,\n} from './url';\nimport {Services} from './services';\nimport {dev, user, userAssert} from './log';\n\n/**\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise}\n */\nexport function installGlobalSubmitListenerForDoc(ampdoc) {\n  // Register global submit event listener only if the amp-form\n  // extension is used. Allowing the usage of native forms, otherwise.\n  return ampdoc.whenExtensionsKnown().then(() => {\n    if (ampdoc.declaresExtension('amp-form')) {\n      ampdoc\n        .getRootNode()\n        .addEventListener('submit', onDocumentFormSubmit_, true);\n    }\n  });\n}\n\n/**\n * Intercept any submit on the current document and prevent invalid submits from\n * going through.\n *\n * @param {!Event} e\n */\nexport function onDocumentFormSubmit_(e) {\n  if (e.defaultPrevented) {\n    return;\n  }\n\n  const form = dev().assertElement(e.target);\n  if (!form || form.tagName != 'FORM') {\n    return;\n  }\n\n  // amp-form extension will add novalidate to all forms to manually trigger\n  // validation. In that case `novalidate` doesn't have the same meaning.\n  const isAmpFormMarked = form.classList.contains('i-amphtml-form');\n  let shouldValidate;\n  if (isAmpFormMarked) {\n    shouldValidate = !form.hasAttribute('amp-novalidate');\n  } else {\n    shouldValidate = !form.hasAttribute('novalidate');\n  }\n\n  // Safari does not trigger validation check on submission, hence we\n  // trigger it manually. In other browsers this would never execute since\n  // the submit event wouldn't be fired if the form is invalid.\n  if (shouldValidate && form.checkValidity && !form.checkValidity()) {\n    e.preventDefault();\n  }\n\n  const inputs = form.elements;\n  for (let i = 0; i < inputs.length; i++) {\n    userAssert(\n      !inputs[i].name || inputs[i].name != SOURCE_ORIGIN_PARAM,\n      'Illegal input name, %s found: %s',\n      SOURCE_ORIGIN_PARAM,\n      inputs[i]\n    );\n  }\n\n  const action = form.getAttribute('action');\n  const actionXhr = form.getAttribute('action-xhr');\n  const method = (form.getAttribute('method') || 'GET').toUpperCase();\n\n  if (actionXhr) {\n    assertHttpsUrl(actionXhr, form, 'action-xhr');\n    userAssert(\n      !isProxyOrigin(actionXhr),\n      'form action-xhr should not be on AMP CDN: %s',\n      form\n    );\n    checkCorsUrl(actionXhr);\n  }\n  if (action) {\n    assertHttpsUrl(action, form, 'action');\n    userAssert(\n      !isProxyOrigin(action),\n      'form action should not be on AMP CDN: %s',\n      form\n    );\n    checkCorsUrl(action);\n  }\n\n  if (method == 'GET') {\n    userAssert(\n      actionXhr || action,\n      'form action-xhr or action attribute is required for method=GET: %s',\n      form\n    );\n  } else if (method == 'POST') {\n    if (action) {\n      const TAG = 'form';\n      user().error(\n        TAG,\n        'action attribute is invalid for method=POST: %s',\n        form\n      );\n    }\n\n    if (!actionXhr) {\n      e.preventDefault();\n      userAssert(\n        false,\n        'Only XHR based (via action-xhr attribute) submissions are support ' +\n          'for POST requests. %s',\n        form\n      );\n    }\n  }\n\n  const target = form.getAttribute('target');\n  if (target) {\n    userAssert(\n      target == '_blank' || target == '_top',\n      'form target=%s is invalid can only be _blank or _top: %s',\n      target,\n      form\n    );\n  } else {\n    form.setAttribute('target', '_top');\n  }\n\n  // For xhr submissions relay the submission event through action service to\n  // allow us to wait for amp-form (and possibly its dependencies) to execute\n  // the actual submission. For non-XHR GET we let the submission go through\n  // to allow _blank target to work.\n  if (actionXhr) {\n    e.preventDefault();\n\n    // It's important to stop propagation of the submission to avoid double\n    // handling of the event in cases were we are delegating to action service\n    // to deliver the submission event.\n    e.stopImmediatePropagation();\n\n    const actions = Services.actionServiceForDoc(form);\n    actions.execute(\n      form,\n      'submit',\n      /*args*/ null,\n      /*source*/ form,\n      /*caller*/ form,\n      e,\n      ActionTrust.HIGH\n    );\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {removeItem} from '../types/array';\n\n/**\n * This class helps to manage observers. Observers can be added, removed or\n * fired through and instance of this class.\n * @template TYPE\n */\nexport class Observable {\n  /**\n   * Creates an instance of Observable.\n   */\n  constructor() {\n    /** @type {?Array<function(TYPE)>} */\n    this.handlers_ = null;\n  }\n\n  /**\n   * Adds the observer to this instance.\n   * @param {function(TYPE)} handler Observer's handler.\n   * @return {!UnlistenDef}\n   */\n  add(handler) {\n    if (!this.handlers_) {\n      this.handlers_ = [];\n    }\n    this.handlers_.push(handler);\n    return () => {\n      this.remove(handler);\n    };\n  }\n\n  /**\n   * Removes the observer from this instance.\n   * @param {function(TYPE)} handler Observer's instance.\n   */\n  remove(handler) {\n    if (!this.handlers_) {\n      return;\n    }\n    removeItem(this.handlers_, handler);\n  }\n\n  /**\n   * Removes all observers.\n   */\n  removeAll() {\n    if (!this.handlers_) {\n      return;\n    }\n    this.handlers_.length = 0;\n  }\n\n  /**\n   * Fires an event. All observers are called.\n   * @param {TYPE=} opt_event\n   */\n  fire(opt_event) {\n    if (!this.handlers_) {\n      return;\n    }\n    for (const handler of this.handlers_) {\n      handler(opt_event);\n    }\n  }\n\n  /**\n   * Returns number of handlers. Mostly needed for tests.\n   * @return {number}\n   */\n  getHandlerCount() {\n    return this.handlers_?.length ?? 0;\n  }\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from '../core/data-structures/observable';\nimport {devAssert} from '../log';\nimport {registerServiceBuilderForDoc} from '../service';\n\n/**\n * MutationObserverInit options to listen for mutations to the `hidden`\n * attribute.\n */\nconst OBSERVER_OPTIONS = {\n  attributes: true,\n  attributeFilter: ['hidden'],\n  subtree: true,\n};\n\n/**\n * A document level service that will listen for mutations on the `hidden`\n * attribute and notify listeners. The `hidden` attribute is used to toggle\n * `display: none` on elements.\n * @implements {../service.Disposable}\n */\nexport class HiddenObserver {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const {!Document|!ShadowRoot} */\n    this.root_ = ampdoc.getRootNode();\n    const doc = this.root_.ownerDocument || this.root_;\n\n    /** @const {!Window} */\n    this.win_ = /** @type {!Window} */ (devAssert(doc.defaultView));\n\n    /** @private {?MutationObserver} */\n    this.mutationObserver_ = null;\n\n    /** @private {?Observable<!Array<!MutationRecord>>} */\n    this.observable_ = null;\n  }\n\n  /**\n   * Adds the observer to this instance.\n   * @param {function(!Array<!MutationRecord>)} handler Observer's handler.\n   * @return {!UnlistenDef}\n   */\n  add(handler) {\n    this.init_();\n\n    const remove = this.observable_.add(handler);\n    return () => {\n      remove();\n      if (this.observable_.getHandlerCount() === 0) {\n        this.dispose();\n      }\n    };\n  }\n\n  /**\n   * Initializes the mutation observer and observable.\n   */\n  init_() {\n    if (this.mutationObserver_) {\n      return;\n    }\n    this.observable_ = new Observable();\n\n    const mo = new this.win_.MutationObserver((mutations) => {\n      if (mutations) {\n        this.observable_.fire(mutations);\n      }\n    });\n    this.mutationObserver_ = mo;\n    mo.observe(this.root_, OBSERVER_OPTIONS);\n  }\n\n  /**\n   * Cleans up the all the mutation observer once the last listener stops\n   * listening, or when the service's doc is disposing.\n   */\n  dispose() {\n    if (!this.mutationObserver_) {\n      return;\n    }\n    this.mutationObserver_.disconnect();\n    this.observable_.removeAll();\n    this.mutationObserver_ = null;\n    this.observable_ = null;\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installHiddenObserverForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'hidden-observer', HiddenObserver);\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Gets state from History.\n * But IE11 throws if there is no state.\n *\n * @param {!History} history\n * @return {*}\n */\nexport function getState(history) {\n  try {\n    return history.state;\n  } catch (e) {\n    return null;\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred, tryResolve} from '../core/data-structures/promise';\nimport {Services} from '../services';\nimport {dev, devAssert} from '../log';\nimport {dict, map} from '../core/types/object';\nimport {getMode} from '../mode';\nimport {\n  getService,\n  registerServiceBuilder,\n  registerServiceBuilderForDoc,\n} from '../service';\nimport {getState} from '../core/window/history';\n\n/** @private @const {string} */\nconst TAG_ = 'History';\n\n/** @private @const {string} */\nconst HISTORY_PROP_ = 'AMP.History';\n\n/** @typedef {number} */\nlet HistoryIdDef;\n\n/**\n * @typedef {{stackIndex: HistoryIdDef, title: string, fragment: string, data: (!JsonObject|undefined)}}\n */\nlet HistoryStateDef;\n\n/**\n * @typedef {{title: (string|undefined), fragment: (string|undefined), url: (string|undefined), canonicalUrl: (string|undefined), data: (!JsonObject|undefined)}}\n */\nlet HistoryStateUpdateDef;\n\n/**\n * Wraps the browser's History API for viewer support and necessary polyfills.\n */\nexport class History {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!HistoryBindingInterface} binding\n   */\n  constructor(ampdoc, binding) {\n    /** @private @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @private @const {!../service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(ampdoc.win);\n\n    /** @private @const {!HistoryBindingInterface} */\n    this.binding_ = binding;\n\n    /** @private {number} */\n    this.stackIndex_ = 0;\n\n    /** @private {!Array<!Function|undefined>} */\n    this.stackOnPop_ = [];\n\n    /**\n     * @private {!Array<!{\n     *   callback: function():!Promise,\n     *   resolve: !Function,\n     *   reject: !Function,\n     *   trace: (!Error|undefined)\n     * }>} */\n    this.queue_ = [];\n\n    this.binding_.setOnStateUpdated(this.onStateUpdated_.bind(this));\n  }\n\n  /** @visibleForTesting */\n  cleanup() {\n    this.binding_.cleanup();\n  }\n\n  /**\n   * Pushes new state into history stack with an optional callback to be called\n   * when this state is popped as well as an object with updates to be applied\n   * to the state.\n   * @param {!Function=} opt_onPop\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise<!HistoryIdDef>}\n   */\n  push(opt_onPop, opt_stateUpdate) {\n    return this.enque_(() => {\n      return this.binding_.push(opt_stateUpdate).then((historyState) => {\n        this.onStateUpdated_(historyState);\n        if (opt_onPop) {\n          this.stackOnPop_[historyState.stackIndex] = opt_onPop;\n        }\n        return historyState.stackIndex;\n      });\n    }, 'push');\n  }\n\n  /**\n   * Pops a previously pushed state from the history stack. If onPop callback\n   * has been registered, it will be called with the state that was associated\n   * with the new head state within the history stack. All states coming\n   * after the supplied state will also be popped, and their\n   * callbacks executed in the same fashion.\n   * @param {!HistoryIdDef} stateId\n   * @return {!Promise}\n   */\n  pop(stateId) {\n    return this.enque_(() => {\n      return this.binding_.pop(stateId).then((historyState) => {\n        this.onStateUpdated_(historyState);\n      });\n    }, 'pop');\n  }\n\n  /**\n   * Replaces the current state, optionally specifying updates to the state\n   * object to be associated with the replacement.\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise}\n   */\n  replace(opt_stateUpdate) {\n    return this.enque_(() => this.binding_.replace(opt_stateUpdate), 'replace');\n  }\n\n  /**\n   * Retrieves the current state, containing the current fragment, title,\n   * and amp-bind state.\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  get() {\n    return this.enque_(() => this.binding_.get(), 'get');\n  }\n\n  /**\n   * Requests navigation one step back. This first attempts to go back within\n   * the context of this document.\n   *\n   * @param {boolean=} navigate\n   * @return {!Promise}\n   */\n  goBack(navigate) {\n    return this.enque_(() => {\n      if (this.stackIndex_ <= 0 && !navigate) {\n        return Promise.resolve();\n      }\n\n      // Pop the current state. The binding will ignore the request if\n      // it cannot satisfy it.\n      return this.binding_.pop(this.stackIndex_).then((historyState) => {\n        this.onStateUpdated_(historyState);\n      });\n    }, 'goBack');\n  }\n\n  /**\n   * Helper method to handle navigation to a local target, e.g. When a user\n   * clicks an anchor link to a local hash - <a href=\"#section1\">Go to section\n   * 1</a>.\n   *\n   * @param {string} target\n   * @return {!Promise}\n   */\n  replaceStateForTarget(target) {\n    devAssert(target[0] == '#', 'target should start with a #');\n    const previousHash = this.ampdoc_.win.location.hash;\n    return this.push(() => {\n      this.ampdoc_.win.location.replace(previousHash || '#');\n    }).then(() => {\n      this.binding_.replaceStateForTarget(target);\n    });\n  }\n\n  /**\n   * Get the fragment from the url or the viewer.\n   * Strip leading '#' in the fragment\n   * @return {!Promise<string>}\n   */\n  getFragment() {\n    return this.binding_.getFragment();\n  }\n\n  /**\n   * Update the page url fragment\n   * @param {string} fragment\n   * @return {!Promise}\n   */\n  updateFragment(fragment) {\n    if (fragment[0] == '#') {\n      fragment = fragment.substr(1);\n    }\n    return this.binding_.updateFragment(fragment);\n  }\n\n  /**\n   * @param {!HistoryStateDef} historyState\n   * @private\n   */\n  onStateUpdated_(historyState) {\n    this.stackIndex_ = historyState.stackIndex;\n    this.doPop_(historyState);\n  }\n\n  /**\n   * @param {!HistoryStateDef} historyState\n   * @private\n   */\n  doPop_(historyState) {\n    if (this.stackIndex_ >= this.stackOnPop_.length - 1) {\n      return;\n    }\n\n    const toPop = [];\n    for (let i = this.stackOnPop_.length - 1; i > this.stackIndex_; i--) {\n      if (this.stackOnPop_[i]) {\n        toPop.push(this.stackOnPop_[i]);\n        this.stackOnPop_[i] = undefined;\n      }\n    }\n    this.stackOnPop_.splice(this.stackIndex_ + 1);\n\n    if (toPop.length > 0) {\n      for (let i = 0; i < toPop.length; i++) {\n        // With the same delay timeouts must observe the order, although\n        // there's no hard requirement in this case to follow the pop order.\n        this.timer_.delay(() => toPop[i](historyState), 1);\n      }\n    }\n  }\n\n  /**\n   * @param {function():!Promise<RESULT>} callback\n   * @param {string} name\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   * @private\n   */\n  enque_(callback, name) {\n    const deferred = new Deferred();\n    const {promise, reject, resolve} = deferred;\n\n    // TODO(dvoytenko, #8785): cleanup after tracing.\n    const trace = new Error('history trace for ' + name + ': ');\n    this.queue_.push({callback, resolve, reject, trace});\n    if (this.queue_.length == 1) {\n      this.deque_();\n    }\n    return promise;\n  }\n\n  /**\n   * @private\n   */\n  deque_() {\n    if (this.queue_.length == 0) {\n      return;\n    }\n\n    const task = this.queue_[0];\n    let promise;\n    try {\n      promise = task.callback();\n    } catch (e) {\n      promise = Promise.reject(e);\n    }\n\n    promise\n      .then(\n        (result) => {\n          task.resolve(result);\n        },\n        (reason) => {\n          dev().error(TAG_, 'failed to execute a task:', reason);\n          // TODO(dvoytenko, #8785): cleanup after tracing.\n          if (task.trace) {\n            task.trace.message += reason;\n            dev().error(TAG_, task.trace);\n          }\n          task.reject(reason);\n        }\n      )\n      .then(() => {\n        this.queue_.splice(0, 1);\n        this.deque_();\n      });\n  }\n}\n\n/**\n * HistoryBindingInterface is an interface that defines an underlying technology\n * behind the {@link History}.\n * @interface\n */\nclass HistoryBindingInterface {\n  /** @protected */\n  cleanup() {}\n\n  /**\n   * Configures a callback to be called when the state has been updated.\n   * @param {function(!HistoryStateDef)} unusedCallback\n   * @protected\n   */\n  setOnStateUpdated(unusedCallback) {}\n\n  /**\n   * Pushes a new state onto the history stack, optionally specifying the state\n   * object associated with the current state.\n   * Returns a promise that yields the new state.\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  push(opt_stateUpdate) {}\n\n  /**\n   * Pops a previously pushed state from the history stack. All history\n   * states coming after this state will also be popped.\n   * Returns a promise that yields the new state.\n   * @param {number} unusedStackIndex\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  pop(unusedStackIndex) {}\n\n  /**\n   * Replaces the current state, optionally specifying updates to the state\n   * object to be associated with the replacement.\n   * Returns a promise that yields the new state.\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  replace(opt_stateUpdate) {}\n\n  /**\n   * Retrieves the current state, containing the current fragment, title,\n   * and amp-bind state.\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  get() {}\n\n  /**\n   * Replaces the state for local target navigation.\n   * @param {string} unusedTarget\n   */\n  replaceStateForTarget(unusedTarget) {}\n\n  /**\n   * Get the fragment from the url or the viewer.\n   * Strip leading '#' in the fragment\n   * @return {!Promise<string>}\n   */\n  getFragment() {}\n\n  /**\n   * Update the page url fragment\n   * @param {string} unusedFragment\n   * @return {!Promise}\n   */\n  updateFragment(unusedFragment) {}\n}\n\n/**\n * Implementation of HistoryBindingInterface based on the native window. It uses\n * window.history properties and events.\n *\n * Visible for testing.\n *\n * @implements {HistoryBindingInterface}\n */\nexport class HistoryBindingNatural_ {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!../service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(win);\n\n    const {history} = this.win;\n\n    /** @private {number} */\n    this.startIndex_ = history.length - 1;\n    const state = getState(history);\n    if (state && state[HISTORY_PROP_] !== undefined) {\n      this.startIndex_ = Math.min(state[HISTORY_PROP_], this.startIndex_);\n    }\n\n    /** @private {number} */\n    this.stackIndex_ = this.startIndex_;\n\n    /**\n     * @private {{promise: !Promise, resolve: !Function,\n     *   reject: !Function}|undefined}\n     */\n    this.waitingState_;\n\n    /** @private {?function(!HistoryStateDef)} */\n    this.onStateUpdated_ = null;\n\n    // A number of browsers do not support history.state. In this cases,\n    // History will track its own version. See unsupportedState_.\n    /** @private {boolean} @const */\n    this.supportsState_ = 'state' in history;\n\n    /** @private {*} */\n    this.unsupportedState_ = this.historyState_(this.stackIndex_);\n\n    // There are still browsers who do not support push/replaceState.\n    let pushState, replaceState;\n    if (history.pushState && history.replaceState) {\n      /** @private @const {function(*, string=, string=)|undefined} */\n      this.origPushState_ =\n        history.originalPushState || history.pushState.bind(history);\n      /** @private @const {function(*, string=, string=)|undefined} */\n      this.origReplaceState_ =\n        history.originalReplaceState || history.replaceState.bind(history);\n      pushState = (state, opt_title, opt_url) => {\n        this.unsupportedState_ = state;\n        this.origPushState_(\n          state,\n          opt_title,\n          // A bug in edge causes paths to become undefined if URL is\n          // undefined, filed here: https://goo.gl/KlImZu\n          opt_url || null\n        );\n      };\n      replaceState = (state, opt_title, opt_url) => {\n        this.unsupportedState_ = state;\n        // NOTE: check for `undefined` since IE11 and Edge\n        // unexpectedly coerces it into a `string`.\n        if (opt_url !== undefined) {\n          this.origReplaceState_(state, opt_title, opt_url);\n        } else {\n          this.origReplaceState_(state, opt_title);\n        }\n      };\n      if (!history.originalPushState) {\n        history.originalPushState = this.origPushState_;\n      }\n      if (!history.originalReplaceState) {\n        history.originalReplaceState = this.origReplaceState_;\n      }\n    } else {\n      pushState = (state, opt_title, opt_url) => {\n        this.unsupportedState_ = state;\n      };\n      replaceState = (state, opt_title, opt_url) => {\n        this.unsupportedState_ = state;\n      };\n    }\n\n    /** @private @const {!Function} */\n    this.pushState_ = pushState;\n\n    /** @private @const {!Function} */\n    this.replaceState_ = replaceState;\n\n    try {\n      this.replaceState_(\n        this.historyState_(this.stackIndex_, /* replace */ true)\n      );\n    } catch (e) {\n      dev().error(TAG_, 'Initial replaceState failed: ' + e.message);\n    }\n\n    history.pushState = this.historyPushState_.bind(this);\n    history.replaceState = this.historyReplaceState_.bind(this);\n\n    this.popstateHandler_ = (e) => {\n      const event = /** @type {!PopStateEvent} */ (e);\n      const state = /** @type {!JsonObject} */ (event.state);\n      dev().fine(\n        TAG_,\n        'popstate event: ' +\n          this.win.history.length +\n          ', ' +\n          JSON.stringify(state)\n      );\n      this.onHistoryEvent_();\n    };\n    this.win.addEventListener('popstate', this.popstateHandler_);\n  }\n\n  /** @override */\n  cleanup() {\n    if (this.origPushState_) {\n      this.win.history.pushState = this.origPushState_;\n    }\n    if (this.origReplaceState_) {\n      this.win.history.replaceState = this.origReplaceState_;\n    }\n    this.win.removeEventListener('popstate', this.popstateHandler_);\n  }\n\n  /**\n   * @param {number} stackIndex\n   * @param {boolean=} opt_replace\n   * @return {*}\n   * @private\n   */\n  historyState_(stackIndex, opt_replace) {\n    const state = map(opt_replace ? this.getState_() : undefined);\n    state[HISTORY_PROP_] = stackIndex;\n    return state;\n  }\n\n  /** @override */\n  setOnStateUpdated(callback) {\n    this.onStateUpdated_ = callback;\n  }\n\n  /** @override */\n  push(opt_stateUpdate) {\n    return this.whenReady_(() => {\n      const newState = this.mergeStateUpdate_(\n        this.getState_(),\n        opt_stateUpdate || {}\n      );\n      this.historyPushState_(\n        newState,\n        /* title */ undefined,\n        newState.fragment ? '#' + newState.fragment : undefined\n      );\n      return tryResolve(() =>\n        this.mergeStateUpdate_(newState, {stackIndex: this.stackIndex_})\n      );\n    });\n  }\n\n  /** @override */\n  pop(stackIndex) {\n    // On pop, stack is not allowed to go prior to the starting point.\n    stackIndex = Math.max(stackIndex, this.startIndex_);\n    return this.whenReady_(() => {\n      return this.back_(this.stackIndex_ - stackIndex + 1);\n    }).then((newStackIndex) => {\n      return this.mergeStateUpdate_(this.getState_(), {\n        stackIndex: newStackIndex,\n      });\n    });\n  }\n\n  /** @override */\n  replace(opt_stateUpdate = {}) {\n    return this.whenReady_(() => {\n      const newState = this.mergeStateUpdate_(\n        this.getState_(),\n        opt_stateUpdate || {}\n      );\n      const url = (newState.url || '').replace(/#.*/, '');\n      const fragment = newState.fragment ? '#' + newState.fragment : '';\n      this.historyReplaceState_(\n        newState,\n        newState.title,\n        url || fragment ? url + fragment : undefined\n      );\n      return tryResolve(() =>\n        this.mergeStateUpdate_(newState, {stackIndex: this.stackIndex_})\n      );\n    });\n  }\n\n  /** @override */\n  get() {\n    return tryResolve(() =>\n      this.mergeStateUpdate_(this.getState_(), {\n        stackIndex: this.stackIndex_,\n      })\n    );\n  }\n\n  /**\n   * @param {number} stackIndex\n   * @return {!Promise}\n   */\n  backTo(stackIndex) {\n    // On pop, stack is not allowed to go prior to the starting point.\n    stackIndex = Math.max(stackIndex, this.startIndex_);\n    return this.whenReady_(() => {\n      return this.back_(this.stackIndex_ - stackIndex);\n    });\n  }\n\n  /** @private */\n  onHistoryEvent_() {\n    let state = this.getState_();\n    dev().fine(\n      TAG_,\n      'history event: ' + this.win.history.length + ', ' + JSON.stringify(state)\n    );\n    const stackIndex = state ? state[HISTORY_PROP_] : undefined;\n    let newStackIndex = this.stackIndex_;\n    const waitingState = this.waitingState_;\n    this.waitingState_ = undefined;\n\n    if (newStackIndex > this.win.history.length - 2) {\n      // Make sure stack has enough space. Whether we are going forward or\n      // backward, the stack should have at least one extra cell.\n      newStackIndex = this.win.history.length - 2;\n      this.updateHistoryState_(\n        this.mergeStateUpdate_(state, {stackIndex: newStackIndex})\n      );\n    }\n\n    if (stackIndex == undefined) {\n      // A new navigation forward by the user.\n      newStackIndex = newStackIndex + 1;\n    } else if (stackIndex < this.win.history.length) {\n      // A simple trip back.\n      newStackIndex = stackIndex;\n    } else {\n      // Generally not possible, but for posterity.\n      newStackIndex = this.win.history.length - 1;\n    }\n\n    // If state index has been updated as the result replace the state.\n    if (!state) {\n      state = {};\n    }\n    state[HISTORY_PROP_] = newStackIndex;\n    this.replaceState_(state, undefined, undefined);\n\n    // Update the stack, pop squeezed states.\n    if (newStackIndex != this.stackIndex_) {\n      this.updateHistoryState_(\n        this.mergeStateUpdate_(state, {stackIndex: newStackIndex})\n      );\n    }\n\n    // User navigation is allowed to move past the starting point of\n    // the history stack.\n    if (newStackIndex < this.startIndex_) {\n      this.startIndex_ = newStackIndex;\n    }\n\n    if (waitingState) {\n      waitingState.resolve();\n    }\n  }\n\n  /** @private */\n  getState_() {\n    if (this.supportsState_) {\n      return getState(this.win.history);\n    }\n    return this.unsupportedState_;\n  }\n\n  /** @private */\n  assertReady_() {\n    devAssert(\n      !this.waitingState_,\n      'The history must not be in the waiting state'\n    );\n  }\n\n  /**\n   * @param {function():!Promise<RESULT>} callback\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   * @private\n   */\n  whenReady_(callback) {\n    if (!this.waitingState_) {\n      return callback();\n    }\n    return this.waitingState_.promise.then(callback, callback);\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  wait_() {\n    this.assertReady_();\n    const deferred = new Deferred();\n    const {reject, resolve} = deferred;\n    const promise = this.timer_.timeoutPromise(500, deferred.promise);\n    this.waitingState_ = {promise, resolve, reject};\n    return promise;\n  }\n\n  /**\n   * @param {number} steps\n   * @return {!Promise}\n   */\n  back_(steps) {\n    this.assertReady_();\n    if (steps <= 0) {\n      return Promise.resolve(this.stackIndex_);\n    }\n    this.unsupportedState_ = this.historyState_(this.stackIndex_ - steps);\n    const promise = this.wait_();\n    this.win.history.go(-steps);\n    return promise.then(() => {\n      return Promise.resolve(this.stackIndex_);\n    });\n  }\n\n  /**\n   * @param {*=} state\n   * @param {(string|undefined)=} title\n   * @param {(string|undefined)=} url\n   * @private\n   */\n  historyPushState_(state, title, url) {\n    this.assertReady_();\n    if (!state) {\n      state = {};\n    }\n    let stackIndex = this.stackIndex_ + 1;\n    state[HISTORY_PROP_] = stackIndex;\n    this.pushState_(state, title, url);\n    if (stackIndex != this.win.history.length - 1) {\n      stackIndex = this.win.history.length - 1;\n      state[HISTORY_PROP_] = stackIndex;\n      this.replaceState_(state);\n    }\n    const newState = this.mergeStateUpdate_(\n      /** @type {!HistoryStateDef} */ (state),\n      {stackIndex}\n    );\n    this.updateHistoryState_(newState);\n  }\n\n  /**\n   * If this is a hash update the choice of `location.replace` vs\n   * `history.replaceState` is important. Due to bugs, not every browser\n   * triggers `:target` pseudo-class when `replaceState` is called.\n   * See http://www.zachleat.com/web/moving-target/ for more details.\n   * location.replace will trigger a `popstate` event, we temporarily\n   * disable handling it.\n   * @param {string} target\n   *\n   * @override\n   */\n  replaceStateForTarget(target) {\n    devAssert(target[0] == '#', 'target should start with a #');\n    this.whenReady_(() => {\n      // location.replace will fire a popstate event which is not a history\n      // event, so temporarily remove the event listener and re-add it after.\n      // As explained above in the function comment, typically we'd just do\n      // replaceState here but in order to trigger :target re-eval we have to\n      // use location.replace.\n      this.win.removeEventListener('popstate', this.popstateHandler_);\n      try {\n        // TODO(mkhatib, #6095): Chrome iOS will add extra states for\n        // location.replace.\n        this.win.location.replace(target);\n      } finally {\n        this.win.addEventListener('popstate', this.popstateHandler_);\n      }\n      this.historyReplaceState_();\n      return Promise.resolve();\n    });\n  }\n\n  /**\n   * @param {*=} state\n   * @param {(string|undefined)=} title\n   * @param {(string|undefined)=} url\n   * @private\n   */\n  historyReplaceState_(state, title, url) {\n    this.assertReady_();\n    if (!state) {\n      state = {};\n    }\n    const stackIndex = Math.min(this.stackIndex_, this.win.history.length - 1);\n    state[HISTORY_PROP_] = stackIndex;\n    this.replaceState_(state, title, url);\n    const newState = this.mergeStateUpdate_(\n      /** @type {!HistoryStateDef} */ (state),\n      {stackIndex}\n    );\n    this.updateHistoryState_(newState);\n  }\n\n  /**\n   * @param {!HistoryStateDef} historyState\n   * @private\n   */\n  updateHistoryState_(historyState) {\n    this.assertReady_();\n    historyState.stackIndex = Math.min(\n      historyState.stackIndex,\n      this.win.history.length - 1\n    );\n    if (this.stackIndex_ != historyState.stackIndex) {\n      dev().fine(\n        TAG_,\n        'stack index changed: ' +\n          this.stackIndex_ +\n          ' -> ' +\n          historyState.stackIndex\n      );\n      this.stackIndex_ = historyState.stackIndex;\n      if (this.onStateUpdated_) {\n        this.onStateUpdated_(historyState);\n      }\n    }\n  }\n\n  /** @override */\n  getFragment() {\n    let {hash} = this.win.location;\n    /* Strip leading '#' */\n    hash = hash.substr(1);\n    return Promise.resolve(hash);\n  }\n\n  /** @override */\n  updateFragment(fragment) {\n    return this.replace({fragment});\n  }\n\n  /**\n   * @param {?HistoryStateDef} state\n   * @param {!HistoryStateUpdateDef} update\n   * @return {!HistoryStateDef}\n   */\n  mergeStateUpdate_(state, update) {\n    const mergedData = /** @type {!JsonObject} */ ({\n      ...((state && state.data) || {}),\n      ...(update.data || {}),\n    });\n    return /** @type {!HistoryStateDef} */ ({\n      ...(state || {}),\n      ...update,\n      data: mergedData,\n    });\n  }\n}\n\n/**\n * Implementation of HistoryBindingInterface that assumes a virtual history that\n * relies on viewer's \"pushHistory\", \"popHistory\" and \"historyPopped\"\n * protocol.\n *\n * Visible for testing.\n *\n * @implements {HistoryBindingInterface}\n */\nexport class HistoryBindingVirtual_ {\n  /**\n   * @param {!Window} win\n   * @param {!./viewer-interface.ViewerInterface} viewer\n   */\n  constructor(win, viewer) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!./viewer-interface.ViewerInterface} */\n    this.viewer_ = viewer;\n\n    /** @private {number} */\n    this.stackIndex_ = 0;\n\n    /** @private {?function(!HistoryStateDef)} */\n    this.onStateUpdated_ = null;\n\n    /** @private {!UnlistenDef} */\n    this.unlistenOnHistoryPopped_ = this.viewer_.onMessage(\n      'historyPopped',\n      (data) => this.onHistoryPopped_(data)\n    );\n  }\n\n  /** @override */\n  replaceStateForTarget(target) {\n    devAssert(target[0] == '#', 'target should start with a #');\n    this.win.location.replace(target);\n  }\n\n  /** @override */\n  cleanup() {\n    this.unlistenOnHistoryPopped_();\n  }\n\n  /** @override */\n  setOnStateUpdated(callback) {\n    this.onStateUpdated_ = callback;\n  }\n\n  /**\n   * Gets the history state from a response. This checks if `maybeHistoryState`\n   * is a history state, and returns it if so, falling back to `fallbackState`\n   * otherwise.\n   * @param {*} maybeHistoryState\n   * @param {!HistoryStateDef} fallbackState\n   * @param {string} debugId\n   * @return {!HistoryStateDef}\n   * @private\n   */\n  toHistoryState_(maybeHistoryState, fallbackState, debugId) {\n    if (this.isHistoryState_(maybeHistoryState)) {\n      return /** @type {!HistoryStateDef} */ (maybeHistoryState);\n    } else {\n      dev().warn(\n        TAG_,\n        'Ignored unexpected \"%s\" data:',\n        debugId,\n        maybeHistoryState\n      );\n    }\n    return fallbackState;\n  }\n\n  /**\n   * @param {*} maybeHistoryState\n   * @return {boolean}\n   */\n  isHistoryState_(maybeHistoryState) {\n    return !!maybeHistoryState && maybeHistoryState['stackIndex'] !== undefined;\n  }\n\n  /**\n   * `pushHistory`\n   *\n   *   Request:  {'stackIndex': string}\n   *   Response: undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  push(opt_stateUpdate) {\n    const message = /** @type {!JsonObject} */ ({\n      'stackIndex': this.stackIndex_ + 1,\n      ...(opt_stateUpdate || {}),\n    });\n    const push = 'pushHistory';\n    return this.viewer_\n      .sendMessageAwaitResponse(push, message)\n      .then((response) => {\n        const fallbackState = /** @type {!HistoryStateDef} */ (message);\n        const newState = this.toHistoryState_(response, fallbackState, push);\n        this.updateHistoryState_(newState);\n        return newState;\n      });\n  }\n\n  /**\n   * `popHistory`\n   *\n   *   Request:  {'stackIndex': string}\n   *   Response: undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  pop(stackIndex) {\n    if (stackIndex > this.stackIndex_) {\n      return this.get();\n    }\n    const message = dict({'stackIndex': this.stackIndex_});\n    const pop = 'popHistory';\n    return this.viewer_\n      .sendMessageAwaitResponse(pop, message)\n      .then((response) => {\n        const fallbackState = /** @type {!HistoryStateDef} */ (\n          dict({\n            'stackIndex': this.stackIndex_ - 1,\n          })\n        );\n        const newState = this.toHistoryState_(response, fallbackState, pop);\n        this.updateHistoryState_(newState);\n        return newState;\n      });\n  }\n\n  /**\n   * `replaceHistory`\n   *\n   *   Request:   {'fragment': string}\n   *   Response:  undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  replace(opt_stateUpdate) {\n    if (opt_stateUpdate && opt_stateUpdate.url) {\n      if (!this.viewer_.hasCapability('fullReplaceHistory')) {\n        // Full URL replacement requested, but not supported by the viewer.\n        // Don't update, and return the current state.\n        const curState = /** @type {!HistoryStateDef} */ (\n          dict({\n            'stackIndex': this.stackIndex_,\n          })\n        );\n        return Promise.resolve(curState);\n      }\n\n      // replace fragment, only explicit fragment param will be sent.\n      const url = opt_stateUpdate.url.replace(/#.*/, '');\n      opt_stateUpdate.url = url;\n    }\n\n    const message = /** @type {!JsonObject} */ ({\n      'stackIndex': this.stackIndex_,\n      ...(opt_stateUpdate || {}),\n    });\n    const replace = 'replaceHistory';\n    return this.viewer_\n      .sendMessageAwaitResponse(replace, message, /* cancelUnsent */ true)\n      .then((response) => {\n        const fallbackState = /** @type {!HistoryStateDef} */ (message);\n        const newState = this.toHistoryState_(response, fallbackState, replace);\n        this.updateHistoryState_(newState);\n        return newState;\n      });\n  }\n\n  /**\n   * Note: Only returns the current `stackIndex`.\n   * @override\n   */\n  get() {\n    // Not sure why this type coercion is necessary, but CC complains otherwise.\n    return Promise.resolve(\n      /** @type {!HistoryStateDef} */ ({\n        data: undefined,\n        fragment: '',\n        stackIndex: this.stackIndex_,\n        title: '',\n      })\n    );\n  }\n\n  /**\n   * `historyPopped` (from viewer)\n   *\n   *   Request:  {'newStackIndex': number} | {'stackIndex': number}\n   *   Response: undefined\n   *\n   * @param {!JsonObject} data\n   * @private\n   */\n  onHistoryPopped_(data) {\n    if (data['newStackIndex'] !== undefined) {\n      data['stackIndex'] = data['newStackIndex'];\n    }\n    if (this.isHistoryState_(data)) {\n      this.updateHistoryState_(/** @type {!HistoryStateDef} */ (data));\n    } else {\n      dev().warn(TAG_, 'Ignored unexpected \"historyPopped\" data:', data);\n    }\n  }\n\n  /**\n   * @param {!HistoryStateDef} state\n   * @private\n   */\n  updateHistoryState_(state) {\n    const {stackIndex} = state;\n    if (this.stackIndex_ != stackIndex) {\n      dev().fine(TAG_, `stackIndex: ${this.stackIndex_} -> ${stackIndex}`);\n      this.stackIndex_ = stackIndex;\n      if (this.onStateUpdated_) {\n        this.onStateUpdated_(state);\n      }\n    }\n  }\n\n  /**\n   * `getFragment`\n   *\n   *   Request:  undefined\n   *   Response: string\n   *\n   * @override\n   */\n  getFragment() {\n    if (!this.viewer_.hasCapability('fragment')) {\n      return Promise.resolve('');\n    }\n    return this.viewer_\n      .sendMessageAwaitResponse(\n        'getFragment',\n        undefined,\n        /* cancelUnsent */ true\n      )\n      .then((data) => {\n        if (!data) {\n          return '';\n        }\n        let hash = dev().assertString(data);\n        /* Strip leading '#'*/\n        if (hash[0] == '#') {\n          hash = hash.substr(1);\n        }\n        return hash;\n      });\n  }\n\n  /**\n   * `replaceHistory`\n   *\n   *   Request:   {'fragment': string}\n   *   Response:  undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  updateFragment(fragment) {\n    if (!this.viewer_.hasCapability('fragment')) {\n      return Promise.resolve();\n    }\n    return /** @type {!Promise} */ (\n      this.viewer_.sendMessageAwaitResponse(\n        'replaceHistory',\n        dict({'fragment': fragment}),\n        /* cancelUnsent */ true\n      )\n    );\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!History}\n * @private\n */\nfunction createHistory(ampdoc) {\n  const viewer = Services.viewerForDoc(ampdoc);\n  let binding;\n  if (\n    viewer.isOvertakeHistory() ||\n    getMode(ampdoc.win).test ||\n    ampdoc.win.__AMP_TEST_IFRAME\n  ) {\n    binding = new HistoryBindingVirtual_(ampdoc.win, viewer);\n  } else {\n    // Only one global \"natural\" binding is allowed since it works with the\n    // global history stack.\n    registerServiceBuilder(\n      ampdoc.win,\n      'global-history-binding',\n      HistoryBindingNatural_\n    );\n    binding = getService(ampdoc.win, 'global-history-binding');\n  }\n  return new History(ampdoc, binding);\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installHistoryServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'history', createHistory);\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * An AMP element's ready state.\n *\n * @enum {string}\n */\nexport const ReadyState = {\n  /**\n   * The element has not been upgraded yet.\n   */\n  UPGRADING: 'upgrading',\n\n  /**\n   * The element has been upgraded and waiting to be built.\n   */\n  BUILDING: 'building',\n\n  /**\n   * The element has been built and waiting to be mounted.\n   */\n  MOUNTING: 'mounting',\n\n  /**\n   * The element has been built and waiting to be loaded.\n   */\n  LOADING: 'loading',\n\n  /**\n   * The element has been built and loaded.\n   */\n  COMPLETE: 'complete',\n\n  /**\n   * The element is in an error state.\n   */\n  ERROR: 'error',\n};\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from './base-element';\n\n// TODO(#31915): completely eliminate this class.\nexport class ElementStub extends BaseElement {}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @typedef {!Array<{query: ?MediaQueryList, value: string}>} */\nlet ExprDef;\n\nconst TRUE_VALUE = '1';\n\nexport class MediaQueryProps {\n  /**\n   * @param {!Window} win\n   * @param {function()} callback\n   */\n  constructor(win, callback) {\n    /** @private @const */\n    this.win_ = win;\n\n    /** @private @const */\n    this.callback_ = callback;\n\n    /** @private {!Object<string, !ExprDef>} */\n    this.exprMap_ = {};\n\n    /** @private {?Object<string, !ExprDef>} */\n    this.prevExprMap_ = null;\n  }\n\n  /**\n   * Starts the resolution pass. After the pass is complete the new queries\n   * will be tracked and the old queries will be untracked.\n   */\n  start() {\n    this.prevExprMap_ = this.exprMap_;\n    this.exprMap_ = {};\n  }\n\n  /**\n   * @param {string} queryString\n   * @return {boolean} value\n   */\n  resolveMatchQuery(queryString) {\n    // This will create a list query like this:\n    // `[{query: matchMedia(queryString), value: true}, {query: null, value: false}]`\n    return (\n      this.resolve_(queryString, parseMediaQueryMatchExpr, TRUE_VALUE) ===\n      TRUE_VALUE\n    );\n  }\n\n  /**\n   * @param {string} exprString\n   * @return {string} value\n   */\n  resolveListQuery(exprString) {\n    return this.resolve_(exprString, parseMediaQueryListExpr, '');\n  }\n\n  /**\n   * Completes the resolution pass. The new queries are tracked for changes\n   * and the old queries are untracked.\n   */\n  complete() {\n    for (const k in this.prevExprMap_) {\n      if (!(k in this.exprMap_)) {\n        toggleOnChange(this.prevExprMap_[k], this.callback_, false);\n      }\n    }\n    this.prevExprMap_ = null;\n  }\n\n  /**\n   * Stops tracking of all queries.\n   */\n  dispose() {\n    for (const k in this.exprMap_) {\n      toggleOnChange(this.exprMap_[k], this.callback_, false);\n    }\n    this.exprMap_ = {};\n  }\n\n  /**\n   * @param {string} exprString\n   * @param {function(!Window, string):!ExprDef} parser\n   * @param {string} emptyExprValue\n   * @return {string} value\n   */\n  resolve_(exprString, parser, emptyExprValue) {\n    if (!exprString.trim()) {\n      return emptyExprValue;\n    }\n    let expr = this.exprMap_[exprString] || this.prevExprMap_[exprString];\n    if (!expr) {\n      expr = parser(this.win_, exprString);\n      toggleOnChange(expr, this.callback_, true);\n    }\n    this.exprMap_[exprString] = expr;\n    return resolveMediaQueryListExpr(expr);\n  }\n}\n\n/**\n * @param {!Window} win\n * @param {string} queryString\n * @return {!ExprDef}\n */\nfunction parseMediaQueryMatchExpr(win, queryString) {\n  const query = win.matchMedia(queryString);\n  return [\n    {query, value: TRUE_VALUE},\n    {query: null, value: ''},\n  ];\n}\n\n/**\n * @param {!Window} win\n * @param {string} exprString\n * @return {!ExprDef}\n */\nfunction parseMediaQueryListExpr(win, exprString) {\n  return (\n    exprString\n      .split(',')\n      .map((part) => {\n        part = part.replace(/\\s+/g, ' ').trim();\n        if (part.length == 0) {\n          return;\n        }\n\n        let queryString;\n        let value;\n\n        // Process the expression from the end.\n        const lastChar = part.charAt(part.length - 1);\n        let div;\n        if (lastChar == ')') {\n          // Value is the CSS function, e.g. `calc(50vw + 10px)`.\n\n          // First, skip to the opening paren.\n          let parens = 1;\n          div = part.length - 2;\n          for (; div >= 0; div--) {\n            const c = part.charAt(div);\n            if (c == '(') {\n              parens--;\n            } else if (c == ')') {\n              parens++;\n            }\n            if (parens == 0) {\n              break;\n            }\n          }\n\n          // Then, skip to the begining to the function's name.\n          const funcEnd = div - 1;\n          if (div > 0) {\n            div--;\n            for (; div >= 0; div--) {\n              const c = part.charAt(div);\n              if (\n                !(\n                  c == '%' ||\n                  c == '-' ||\n                  c == '_' ||\n                  (c >= 'a' && c <= 'z') ||\n                  (c >= 'A' && c <= 'Z') ||\n                  (c >= '0' && c <= '9')\n                )\n              ) {\n                break;\n              }\n            }\n          }\n          if (div >= funcEnd) {\n            // Invalid condition.\n            return null;\n          }\n        } else {\n          // Value is the length or a percent: accept a wide range of values,\n          // including invalid values - they will be later asserted to conform\n          // to exact CSS length or percent value.\n          div = part.length - 2;\n          for (; div >= 0; div--) {\n            const c = part.charAt(div);\n            if (\n              !(\n                c == '%' ||\n                c == '.' ||\n                (c >= 'a' && c <= 'z') ||\n                (c >= 'A' && c <= 'Z') ||\n                (c >= '0' && c <= '9')\n              )\n            ) {\n              break;\n            }\n          }\n        }\n        if (div >= 0) {\n          queryString = part.substring(0, div + 1).trim();\n          value = part.substring(div + 1).trim();\n        } else {\n          value = part;\n          queryString = undefined;\n        }\n\n        if (!value) {\n          return null;\n        }\n\n        const query = queryString ? win.matchMedia(queryString) : null;\n        return {query, value};\n      })\n      // Remove any items that did not match the regex above and are\n      // undefined as a result.\n      .filter(Boolean)\n  );\n}\n\n/**\n * @param {!ExprDef} expr\n * @return {string} value\n */\nfunction resolveMediaQueryListExpr(expr) {\n  for (let i = 0; i < expr.length; i++) {\n    const {query, value} = expr[i];\n    if (!query || query.matches) {\n      return value;\n    }\n  }\n  return '';\n}\n\n/**\n * @param {!ExprDef} expr\n * @param {function()} callback\n * @param {boolean} on\n */\nfunction toggleOnChange(expr, callback, on) {\n  for (let i = 0; i < expr.length; i++) {\n    const {query} = expr[i];\n    if (query) {\n      // The `onchange` API is preferred, but the IE only supports\n      // the `addListener/removeListener` APIs.\n      if (query.onchange !== undefined) {\n        query.onchange = on ? callback : null;\n      } else {\n        if (on) {\n          query.addListener(callback);\n        } else {\n          query.removeListener(callback);\n        }\n      }\n    }\n  }\n}\n\n/**\n * Detect prefers-reduced-motion.\n * Native animations will not run when a device is set up to reduced motion.\n * In that case, we need to disable all animation treatment, and whatever\n * setup changes that depend on an animation running later on.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function prefersReducedMotion(win) {\n  return !!win.matchMedia('(prefers-reduced-motion: reduce)')?.matches;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../core/data-structures/promise';\nimport {Layout} from '../layout';\nimport {Services} from '../services';\nimport {\n  cancellation,\n  isBlockedByConsent,\n  reportError,\n} from '../error-reporting';\nimport {computedStyle, toggle} from '../style';\nimport {dev, devAssert} from '../log';\nimport {\n  layoutRectLtwh,\n  layoutRectSizeEquals,\n  layoutSizeFromRect,\n  moveLayoutRect,\n  rectsOverlap,\n} from '../core/math/layout-rect';\nimport {toWin} from '../core/window';\n\nconst TAG = 'Resource';\nconst RESOURCE_PROP_ = '__AMP__RESOURCE';\nconst OWNER_PROP_ = '__AMP__OWNER';\n\n/**\n * Resource state.\n *\n * @enum {number}\n */\nexport const ResourceState = {\n  /**\n   * The resource has not been built yet. Measures, layouts, preloads or\n   * viewport signals are not allowed.\n   */\n  NOT_BUILT: 0,\n\n  /**\n   * The resource has been built, but not measured yet and not yet ready\n   * for layout.\n   */\n  NOT_LAID_OUT: 1,\n\n  /**\n   * The resource has been built and measured and ready for layout.\n   */\n  READY_FOR_LAYOUT: 2,\n\n  /**\n   * The resource is currently scheduled for layout.\n   */\n  LAYOUT_SCHEDULED: 3,\n\n  /**\n   * The resource has been laid out.\n   */\n  LAYOUT_COMPLETE: 4,\n\n  /**\n   * The latest resource's layout failed.\n   */\n  LAYOUT_FAILED: 5,\n};\n\n/** @typedef {{\n  distance: (boolean|number),\n    viewportHeight: (number|undefined),\n    scrollPenalty: (number|undefined),\n  }} */\nlet ViewportRatioDef;\n\n/**\n * A Resource binding for an AmpElement.\n */\nexport class Resource {\n  /**\n   * @param {!Element} element\n   * @return {!Resource}\n   */\n  static forElement(element) {\n    return /** @type {!Resource} */ (\n      devAssert(\n        Resource.forElementOptional(element),\n        'Missing resource prop on %s',\n        element\n      )\n    );\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {Resource}\n   */\n  static forElementOptional(element) {\n    return /** @type {Resource} */ (element[RESOURCE_PROP_]);\n  }\n\n  /**\n   * Assigns an owner for the specified element. This means that the resources\n   * within this element will be managed by the owner and not Resources manager.\n   * @param {!Element} element\n   * @param {!AmpElement} owner\n   */\n  static setOwner(element, owner) {\n    devAssert(owner.contains(element), 'Owner must contain the element');\n    if (Resource.forElementOptional(element)) {\n      Resource.forElementOptional(element).updateOwner(owner);\n    }\n    element[OWNER_PROP_] = owner;\n\n    // Need to clear owner cache for all child elements\n    const cachedElements = element.getElementsByClassName('i-amphtml-element');\n    for (let i = 0; i < cachedElements.length; i++) {\n      const ele = cachedElements[i];\n      if (Resource.forElementOptional(ele)) {\n        Resource.forElementOptional(ele).updateOwner(undefined);\n      }\n    }\n  }\n\n  /**\n   * @param {number} id\n   * @param {!AmpElement} element\n   * @param {!./resources-interface.ResourcesInterface} resources\n   */\n  constructor(id, element, resources) {\n    element[RESOURCE_PROP_] = this;\n\n    /** @private {number} */\n    this.id_ = id;\n\n    /** @const {!AmpElement} */\n    this.element = element;\n\n    /** @const {string} */\n    this.debugid = element.tagName.toLowerCase() + '#' + id;\n\n    /** @const {!Window} */\n    this.hostWin = toWin(element.ownerDocument.defaultView);\n\n    /** @const @private {!./resources-interface.ResourcesInterface} */\n    this.resources_ = resources;\n\n    /** @const @private {boolean} */\n    this.isPlaceholder_ = element.hasAttribute('placeholder');\n\n    /** @private {boolean} */\n    this.isBuilding_ = false;\n\n    /** @private {!AmpElement|undefined|null} */\n    this.owner_ = undefined;\n\n    /** @private {!ResourceState} */\n    this.state_ = element.isBuilt()\n      ? ResourceState.NOT_LAID_OUT\n      : ResourceState.NOT_BUILT;\n\n    // Race condition: if an element is reparented while building, it'll\n    // receive a newly constructed Resource. Make sure this Resource's\n    // internal state is also \"building\".\n    if (this.state_ == ResourceState.NOT_BUILT && element.isBuilding()) {\n      this.build();\n    }\n\n    /** @private {number} */\n    this.priorityOverride_ = -1;\n\n    /** @private {number} */\n    this.layoutCount_ = 0;\n\n    /**\n     * Used to signal that the current layoutCallback has been aborted by an\n     * unlayoutCallback.\n     * @private {?AbortController}\n     */\n    this.abortController_ = null;\n\n    /** @private {*} */\n    this.lastLayoutError_ = null;\n\n    /** @private {boolean} */\n    this.isFixed_ = false;\n\n    /** @private {!../layout-rect.LayoutRectDef} */\n    this.layoutBox_ = layoutRectLtwh(-10000, -10000, 0, 0);\n\n    /** @private {?../layout-rect.LayoutRectDef} */\n    this.initialLayoutBox_ = null;\n\n    /** @private {boolean} */\n    this.isMeasureRequested_ = false;\n\n    /**\n     * Really, this is a <number, !Deferred> map,\n     * but CC's type system can't handle it.\n     * @private {?Object<string, !Deferred>}\n     */\n    this.withViewportDeferreds_ = null;\n\n    /** @private {?Promise<undefined>} */\n    this.layoutPromise_ = null;\n\n    /**\n     * Pending change size that was requested but could not be satisfied.\n     * @private {!./resources-impl.SizeDef|undefined}\n     */\n    this.pendingChangeSize_ = undefined;\n\n    const deferred = new Deferred();\n\n    /** @private @const {!Promise} */\n    this.loadPromise_ = deferred.promise;\n\n    /** @private {?Function} */\n    this.loadPromiseResolve_ = deferred.resolve;\n\n    // TODO(#30620): remove isInViewport_ and whenWithinViewport.\n    /** @const @private {boolean} */\n    this.isInViewport_ = false;\n  }\n\n  /**\n   * Returns resource's ID.\n   * @return {number}\n   */\n  getId() {\n    return this.id_;\n  }\n\n  /**\n   * Update owner element\n   * @param {AmpElement|undefined} owner\n   */\n  updateOwner(owner) {\n    this.owner_ = owner;\n  }\n\n  /**\n   * Returns an owner element or null.\n   * @return {?AmpElement}\n   */\n  getOwner() {\n    if (this.owner_ === undefined) {\n      for (let n = this.element; n; n = n.parentElement) {\n        if (n[OWNER_PROP_]) {\n          this.owner_ = n[OWNER_PROP_];\n          break;\n        }\n      }\n      if (this.owner_ === undefined) {\n        this.owner_ = null;\n      }\n    }\n    return this.owner_;\n  }\n\n  /**\n   * Whether the resource has an owner.\n   * @return {boolean}\n   */\n  hasOwner() {\n    return !!this.getOwner();\n  }\n\n  /**\n   * Returns the resource's element priority.\n   * @return {number}\n   */\n  getLayoutPriority() {\n    if (this.priorityOverride_ != -1) {\n      return this.priorityOverride_;\n    }\n    return this.element.getLayoutPriority();\n  }\n\n  /**\n   * Overrides the element's priority.\n   * @param {number} newPriority\n   */\n  updateLayoutPriority(newPriority) {\n    this.priorityOverride_ = newPriority;\n  }\n\n  /**\n   * Returns the resource's state. See {@link ResourceState} for details.\n   * @return {!ResourceState}\n   */\n  getState() {\n    return this.state_;\n  }\n\n  /**\n   * Returns whether the resource has been fully built.\n   * @return {boolean}\n   */\n  isBuilt() {\n    return this.element.isBuilt();\n  }\n\n  /**\n   * Returns whether the resource is currently being built.\n   * @return {boolean}\n   */\n  isBuilding() {\n    return this.isBuilding_;\n  }\n\n  /**\n   * Returns promise that resolves when the element has been built.\n   * @return {!Promise}\n   */\n  whenBuilt() {\n    // TODO(dvoytenko): merge with the standard BUILT signal.\n    return this.element.signals().whenSignal('res-built');\n  }\n\n  /**\n   * Requests the resource's element to be built. See {@link AmpElement.build}\n   * for details.\n   * @return {?Promise}\n   */\n  build() {\n    if (this.isBuilding_ || !this.element.isUpgraded()) {\n      return null;\n    }\n    this.isBuilding_ = true;\n    return this.element.buildInternal().then(\n      () => {\n        this.isBuilding_ = false;\n        this.state_ = ResourceState.NOT_LAID_OUT;\n        // TODO(dvoytenko): merge with the standard BUILT signal.\n        this.element.signals().signal('res-built');\n      },\n      (reason) => {\n        this.maybeReportErrorOnBuildFailure(reason);\n        this.isBuilding_ = false;\n        this.element.signals().rejectSignal('res-built', reason);\n        throw reason;\n      }\n    );\n  }\n\n  /**\n   * @param {*} reason\n   * @visibleForTesting\n   */\n  maybeReportErrorOnBuildFailure(reason) {\n    if (!isBlockedByConsent(reason)) {\n      dev().error(TAG, 'failed to build:', this.debugid, reason);\n    }\n  }\n\n  /**\n   * Instructs the element to change its size and transitions to the state\n   * awaiting the measure and possibly layout.\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef=} opt_newMargins\n   */\n  changeSize(newHeight, newWidth, opt_newMargins) {\n    this.element./*OK*/ applySize(newHeight, newWidth, opt_newMargins);\n\n    // Schedule for re-measure and possible re-layout.\n    this.requestMeasure();\n  }\n\n  /**\n   * Informs the element that it's either overflown or not.\n   * @param {boolean} overflown\n   * @param {number|undefined} requestedHeight\n   * @param {number|undefined} requestedWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef|undefined} requestedMargins\n   */\n  overflowCallback(\n    overflown,\n    requestedHeight,\n    requestedWidth,\n    requestedMargins\n  ) {\n    if (overflown) {\n      this.pendingChangeSize_ = {\n        height: requestedHeight,\n        width: requestedWidth,\n        margins: requestedMargins,\n      };\n    }\n    this.element.overflowCallback(\n      overflown,\n      requestedHeight,\n      requestedWidth,\n      requestedMargins\n    );\n  }\n\n  /** reset pending change sizes */\n  resetPendingChangeSize() {\n    this.pendingChangeSize_ = undefined;\n  }\n\n  /**\n   * @return {!./resources-impl.SizeDef|undefined}\n   */\n  getPendingChangeSize() {\n    return this.pendingChangeSize_;\n  }\n\n  /**\n   * Time delay imposed by baseElement upgradeCallback.  If no\n   * upgradeCallback specified or not yet executed, delay is 0.\n   * @return {number}\n   */\n  getUpgradeDelayMs() {\n    return this.element.getUpgradeDelayMs();\n  }\n\n  /**\n   * Measures the resource's boundaries. An upgraded element will be\n   * transitioned to the \"ready for layout\" state.\n   */\n  measure() {\n    // Check if the element is ready to be measured.\n    // Placeholders are special. They are technically \"owned\" by parent AMP\n    // elements, sized by parents, but laid out independently. This means\n    // that placeholders need to at least wait until the parent element\n    // has been stubbed. We can tell whether the parent has been stubbed\n    // by whether a resource has been attached to it.\n    if (\n      this.isPlaceholder_ &&\n      this.element.parentElement &&\n      // Use prefix to recognize AMP element. This is necessary because stub\n      // may not be attached yet.\n      this.element.parentElement.tagName.startsWith('AMP-') &&\n      !(RESOURCE_PROP_ in this.element.parentElement)\n    ) {\n      return;\n    }\n    if (\n      !this.element.ownerDocument ||\n      !this.element.ownerDocument.defaultView\n    ) {\n      // Most likely this is an element who's window has just been destroyed.\n      // This is an issue with FIE embeds destruction. Such elements will be\n      // considered \"not displayable\" until they are GC'ed.\n      this.state_ = ResourceState.NOT_LAID_OUT;\n      return;\n    }\n\n    this.isMeasureRequested_ = false;\n\n    const oldBox = this.layoutBox_;\n    this.computeMeasurements_();\n    const newBox = this.layoutBox_;\n\n    // Note that \"left\" doesn't affect readiness for the layout.\n    const sizeChanges = !layoutRectSizeEquals(oldBox, newBox);\n    if (\n      this.state_ == ResourceState.NOT_LAID_OUT ||\n      oldBox.top != newBox.top ||\n      sizeChanges\n    ) {\n      if (this.element.isUpgraded()) {\n        if (this.state_ == ResourceState.NOT_LAID_OUT) {\n          // If the element isn't laid out yet, then we're now ready for layout.\n          this.state_ = ResourceState.READY_FOR_LAYOUT;\n        } else if (\n          (this.state_ == ResourceState.LAYOUT_COMPLETE ||\n            this.state_ == ResourceState.LAYOUT_FAILED) &&\n          this.element.isRelayoutNeeded()\n        ) {\n          // If the element was already laid out and we need to relayout, then\n          // go back to ready for layout.\n          this.state_ = ResourceState.READY_FOR_LAYOUT;\n        }\n      }\n    }\n\n    if (!this.hasBeenMeasured()) {\n      this.initialLayoutBox_ = newBox;\n    }\n\n    this.element.updateLayoutBox(newBox, sizeChanges);\n  }\n\n  /**\n   * Yields when the resource has been measured.\n   * @return {!Promise}\n   */\n  ensureMeasured() {\n    if (this.hasBeenMeasured()) {\n      return Promise.resolve();\n    }\n    return Services.vsyncFor(this.hostWin).measure(() => this.measure());\n  }\n\n  /**\n   * Computes the current layout box and position-fixed state of the element.\n   * @private\n   */\n  computeMeasurements_() {\n    const viewport = Services.viewportForDoc(this.element);\n    this.layoutBox_ = viewport.getLayoutRect(this.element);\n\n    // Calculate whether the element is currently is or in `position:fixed`.\n    let isFixed = false;\n    if (viewport.supportsPositionFixed() && this.isDisplayed()) {\n      const {win} = this.resources_.getAmpdoc();\n      const {body} = win.document;\n      for (let n = this.element; n && n != body; n = n./*OK*/ offsetParent) {\n        if (n.isAlwaysFixed && n.isAlwaysFixed()) {\n          isFixed = true;\n          break;\n        }\n        if (\n          viewport.isDeclaredFixed(n) &&\n          computedStyle(win, n).position == 'fixed'\n        ) {\n          isFixed = true;\n          break;\n        }\n      }\n    }\n    this.isFixed_ = isFixed;\n\n    if (isFixed) {\n      // For fixed position elements, we need the relative position to the\n      // viewport. When accessing the layoutBox through #getLayoutBox, we'll\n      // return the new absolute position.\n      this.layoutBox_ = moveLayoutRect(\n        this.layoutBox_,\n        -viewport.getScrollLeft(),\n        -viewport.getScrollTop()\n      );\n    }\n  }\n\n  /**\n   * Completes collapse: ensures that the element is `display:none` and\n   * updates layout box.\n   */\n  completeCollapse() {\n    toggle(this.element, false);\n    this.layoutBox_ = layoutRectLtwh(\n      this.layoutBox_.left,\n      this.layoutBox_.top,\n      0,\n      0\n    );\n    this.isFixed_ = false;\n    this.element.updateLayoutBox(this.getLayoutBox());\n    const owner = this.getOwner();\n    if (owner) {\n      owner.collapsedCallback(this.element);\n    }\n  }\n\n  /**\n   * Completes expand: ensures that the element is not `display:none` and\n   * updates measurements.\n   */\n  completeExpand() {\n    toggle(this.element, true);\n    this.requestMeasure();\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isMeasureRequested() {\n    return this.isMeasureRequested_;\n  }\n\n  /**\n   * Checks if the current resource has been measured.\n   * @return {boolean}\n   */\n  hasBeenMeasured() {\n    return !!this.initialLayoutBox_;\n  }\n\n  /**\n   * Requests the element to be remeasured on the next pass.\n   */\n  requestMeasure() {\n    this.isMeasureRequested_ = true;\n  }\n\n  /**\n   * Returns a previously measured layout size.\n   * @return {!../layout-rect.LayoutSizeDef}\n   */\n  getLayoutSize() {\n    return layoutSizeFromRect(this.layoutBox_);\n  }\n\n  /**\n   * Returns a previously measured layout box adjusted to the viewport. This\n   * mainly affects fixed-position elements that are adjusted to be always\n   * relative to the document position in the viewport.\n   * The returned layoutBox is:\n   * - relative to the top of the document for non fixed element,\n   * - relative to the top of the document at current scroll position\n   *   for fixed element.\n   * @return {!../layout-rect.LayoutRectDef}\n   */\n  getLayoutBox() {\n    if (!this.isFixed_) {\n      return this.layoutBox_;\n    }\n    const viewport = Services.viewportForDoc(this.element);\n    return moveLayoutRect(\n      this.layoutBox_,\n      viewport.getScrollLeft(),\n      viewport.getScrollTop()\n    );\n  }\n\n  /**\n   * Returns the first measured layout box.\n   * @return {!../layout-rect.LayoutRectDef}\n   */\n  getInitialLayoutBox() {\n    // Before the first measure, there will be no initial layoutBox.\n    // Luckily, layoutBox will be present but essentially useless.\n    return this.initialLayoutBox_ || this.layoutBox_;\n  }\n\n  /**\n   * Whether the resource is displayed, i.e. if it has non-zero width and\n   * height.\n   * @return {boolean}\n   */\n  isDisplayed() {\n    const isConnected =\n      this.element.ownerDocument && this.element.ownerDocument.defaultView;\n    if (!isConnected) {\n      return false;\n    }\n    const isFluid = this.element.getLayout() == Layout.FLUID;\n    const box = this.getLayoutBox();\n    const hasNonZeroSize = box.height > 0 && box.width > 0;\n    return isFluid || hasNonZeroSize;\n  }\n\n  /**\n   * Whether the element is fixed according to the latest measurement.\n   * @return {boolean}\n   */\n  isFixed() {\n    return this.isFixed_;\n  }\n\n  /**\n   * Whether the element's layout box overlaps with the specified rect.\n   * @param {!../layout-rect.LayoutRectDef} rect\n   * @return {boolean}\n   */\n  overlaps(rect) {\n    return rectsOverlap(this.getLayoutBox(), rect);\n  }\n\n  /**\n   * Whether this element can be pre-rendered.\n   * @return {boolean}\n   */\n  prerenderAllowed() {\n    return this.element.prerenderAllowed();\n  }\n\n  /**\n   * Whether this element has render-blocking service.\n   * @return {boolean}\n   */\n  isBuildRenderBlocking() {\n    return this.element.isBuildRenderBlocking();\n  }\n\n  /**\n   * @param {number|boolean} viewport derived from renderOutsideViewport.\n   * @return {!Promise} resolves when underlying element is built and within the\n   *    viewport range given.\n   */\n  whenWithinViewport(viewport) {\n    // TODO(#30620): remove this method once IntersectionObserver{root:doc} is\n    // polyfilled.\n    devAssert(viewport !== false);\n    // Resolve is already laid out or viewport is true.\n    if (!this.isLayoutPending() || viewport === true) {\n      return Promise.resolve();\n    }\n    // See if pre-existing promise.\n    const viewportNum = dev().assertNumber(viewport);\n    const key = String(viewportNum);\n    if (this.withViewportDeferreds_ && this.withViewportDeferreds_[key]) {\n      return this.withViewportDeferreds_[key].promise;\n    }\n    // See if already within viewport multiplier.\n    if (this.isWithinViewportRatio(viewportNum)) {\n      return Promise.resolve();\n    }\n    // return promise that will trigger when within viewport multiple.\n    this.withViewportDeferreds_ = this.withViewportDeferreds_ || {};\n    this.withViewportDeferreds_[key] = new Deferred();\n    return this.withViewportDeferreds_[key].promise;\n  }\n\n  /** @private resolves promises populated via whenWithinViewport. */\n  resolveDeferredsWhenWithinViewports_() {\n    if (!this.withViewportDeferreds_) {\n      return;\n    }\n    const viewportRatio = this.getDistanceViewportRatio();\n    for (const key in this.withViewportDeferreds_) {\n      if (this.isWithinViewportRatio(parseFloat(key), viewportRatio)) {\n        this.withViewportDeferreds_[key].resolve();\n        delete this.withViewportDeferreds_[key];\n      }\n    }\n  }\n\n  /** @return {!ViewportRatioDef} */\n  getDistanceViewportRatio() {\n    // Numeric interface, element is allowed to render outside viewport when it\n    // is within X times the viewport height of the current viewport.\n    const viewport = Services.viewportForDoc(this.element);\n    const viewportBox = viewport.getRect();\n    const layoutBox = this.getLayoutBox();\n    const scrollDirection = this.resources_.getScrollDirection();\n    let scrollPenalty = 1;\n    let distance = 0;\n\n    if (\n      viewportBox.right < layoutBox.left ||\n      viewportBox.left > layoutBox.right\n    ) {\n      // If outside of viewport's x-axis, element is not in viewport so return\n      // false.\n      return {distance: false};\n    }\n\n    if (viewportBox.bottom < layoutBox.top) {\n      // Element is below viewport\n      distance = layoutBox.top - viewportBox.bottom;\n\n      // If we're scrolling away from the element\n      if (scrollDirection == -1) {\n        scrollPenalty = 2;\n      }\n    } else if (viewportBox.top > layoutBox.bottom) {\n      // Element is above viewport\n      distance = viewportBox.top - layoutBox.bottom;\n\n      // If we're scrolling away from the element\n      if (scrollDirection == 1) {\n        scrollPenalty = 2;\n      }\n    } else {\n      // Element is in viewport so return true for all but boolean false.\n      return {distance: true};\n    }\n    return {distance, scrollPenalty, viewportHeight: viewportBox.height};\n  }\n\n  /**\n   * @param {number|boolean} multiplier\n   * @param {ViewportRatioDef=} opt_viewportRatio\n   * @return {boolean} whether multiplier given is within viewport ratio\n   * @visibleForTesting\n   */\n  isWithinViewportRatio(multiplier, opt_viewportRatio) {\n    if (typeof multiplier === 'boolean') {\n      return multiplier;\n    }\n    const {distance, scrollPenalty, viewportHeight} =\n      opt_viewportRatio || this.getDistanceViewportRatio();\n    if (typeof distance == 'boolean') {\n      return distance;\n    }\n    return distance < (viewportHeight * multiplier) / scrollPenalty;\n  }\n\n  /**\n   * Whether this is allowed to render when not in viewport.\n   * @return {boolean}\n   */\n  renderOutsideViewport() {\n    // The exception is for owned resources, since they only attempt to\n    // render outside viewport when the owner has explicitly allowed it.\n    // TODO(jridgewell, #5803): Resources should be asking owner if it can\n    // prerender this resource, so that it can avoid expensive elements wayyy\n    // outside of viewport. For now, blindly trust that owner knows what it's\n    // doing.\n    this.resolveDeferredsWhenWithinViewports_();\n    return (\n      this.hasOwner() ||\n      this.isWithinViewportRatio(this.element.renderOutsideViewport())\n    );\n  }\n\n  /**\n   * Whether this is allowed to render when scheduler is idle but not in\n   * viewport.\n   * @return {boolean}\n   */\n  idleRenderOutsideViewport() {\n    return this.isWithinViewportRatio(this.element.idleRenderOutsideViewport());\n  }\n\n  /**\n   * Sets the resource's state to LAYOUT_SCHEDULED.\n   * @param {number} scheduleTime The time at which layout was scheduled.\n   */\n  layoutScheduled(scheduleTime) {\n    this.state_ = ResourceState.LAYOUT_SCHEDULED;\n    this.element.layoutScheduleTime = scheduleTime;\n  }\n\n  /**\n   * Undoes `layoutScheduled`.\n   */\n  layoutCanceled() {\n    this.state_ = this.hasBeenMeasured()\n      ? ResourceState.READY_FOR_LAYOUT\n      : ResourceState.NOT_LAID_OUT;\n  }\n\n  /**\n   * Starts the layout of the resource. Returns the promise that will yield\n   * once layout is complete. Only allowed to be called on a upgraded, built\n   * and displayed element.\n   * @return {!Promise}\n   */\n  startLayout() {\n    if (this.layoutPromise_) {\n      return this.layoutPromise_;\n    }\n    if (this.state_ == ResourceState.LAYOUT_COMPLETE) {\n      return Promise.resolve();\n    }\n    if (this.state_ == ResourceState.LAYOUT_FAILED) {\n      return Promise.reject(this.lastLayoutError_);\n    }\n\n    devAssert(\n      this.state_ != ResourceState.NOT_BUILT,\n      'Not ready to start layout: %s (%s)',\n      this.debugid,\n      this.state_\n    );\n    devAssert(this.isDisplayed(), 'Not displayed for layout: %s', this.debugid);\n\n    if (this.state_ != ResourceState.LAYOUT_SCHEDULED) {\n      const err = dev().createError(\n        'startLayout called but not LAYOUT_SCHEDULED',\n        'currently: ',\n        this.state_\n      );\n      reportError(err, this.element);\n      return Promise.reject(err);\n    }\n\n    // Unwanted re-layouts are ignored.\n    if (this.layoutCount_ > 0 && !this.element.isRelayoutNeeded()) {\n      dev().fine(\n        TAG,\n        \"layout canceled since it wasn't requested:\",\n        this.debugid,\n        this.state_\n      );\n      this.state_ = ResourceState.LAYOUT_COMPLETE;\n      return Promise.resolve();\n    }\n\n    dev().fine(TAG, 'start layout:', this.debugid, 'count:', this.layoutCount_);\n    this.layoutCount_++;\n    this.state_ = ResourceState.LAYOUT_SCHEDULED;\n    this.abortController_ = new AbortController();\n    const {signal} = this.abortController_;\n\n    const promise = new Promise((resolve, reject) => {\n      Services.vsyncFor(this.hostWin).mutate(() => {\n        let callbackResult;\n        try {\n          callbackResult = this.element.layoutCallback(signal);\n        } catch (e) {\n          reject(e);\n        }\n        Promise.resolve(callbackResult).then(resolve, reject);\n      });\n      signal.onabort = () => reject(cancellation());\n    }).then(\n      () => this.layoutComplete_(true, signal),\n      (reason) => this.layoutComplete_(false, signal, reason)\n    );\n\n    return (this.layoutPromise_ = promise);\n  }\n\n  /**\n   * @param {boolean} success\n   * @param {!AbortSignal} signal\n   * @param {*=} opt_reason\n   * @return {!Promise|undefined}\n   */\n  layoutComplete_(success, signal, opt_reason) {\n    this.abortController_ = null;\n    if (signal.aborted) {\n      // We hit a race condition, where `layoutCallback` -> `unlayoutCallback`\n      // was called in quick succession. Since the unlayout was called before\n      // the layout completed, we want to remain in the unlayout state.\n      const err = dev().createError('layoutComplete race');\n      err.associatedElement = this.element;\n      dev().expectedError(TAG, err);\n      throw cancellation();\n    }\n    if (this.loadPromiseResolve_) {\n      this.loadPromiseResolve_();\n      this.loadPromiseResolve_ = null;\n    }\n    this.layoutPromise_ = null;\n    this.state_ = success\n      ? ResourceState.LAYOUT_COMPLETE\n      : ResourceState.LAYOUT_FAILED;\n    this.lastLayoutError_ = opt_reason;\n    if (success) {\n      dev().fine(TAG, 'layout complete:', this.debugid);\n    } else {\n      dev().fine(TAG, 'loading failed:', this.debugid, opt_reason);\n      return Promise.reject(opt_reason);\n    }\n  }\n\n  /**\n   * Returns true if the resource layout has not completed or failed.\n   * @return {boolean}\n   */\n  isLayoutPending() {\n    return (\n      this.state_ != ResourceState.LAYOUT_COMPLETE &&\n      this.state_ != ResourceState.LAYOUT_FAILED\n    );\n  }\n\n  /**\n   * Returns a promise that is resolved when this resource is laid out\n   * for the first time and the resource was loaded. Note that the resource\n   * could be unloaded subsequently. This method returns resolved promise for\n   * sunch unloaded elements.\n   * @return {!Promise}\n   */\n  loadedOnce() {\n    if (this.element.R1()) {\n      return this.element.whenLoaded();\n    }\n    return this.loadPromise_;\n  }\n\n  /**\n   * Whether the resource is currently visible in the viewport.\n   * @return {boolean}\n   */\n  isInViewport() {\n    if (this.isInViewport_) {\n      this.resolveDeferredsWhenWithinViewports_();\n    }\n    return this.isInViewport_;\n  }\n\n  /**\n   * Updates the inViewport state of the element.\n   * @param {boolean} inViewport\n   */\n  setInViewport(inViewport) {\n    this.isInViewport_ = inViewport;\n  }\n\n  /**\n   * Calls element's unlayoutCallback callback and resets state for\n   * relayout in case document becomes active again.\n   */\n  unlayout() {\n    if (\n      this.state_ == ResourceState.NOT_BUILT ||\n      this.state_ == ResourceState.NOT_LAID_OUT ||\n      this.state_ == ResourceState.READY_FOR_LAYOUT\n    ) {\n      return;\n    }\n    if (this.abortController_) {\n      this.abortController_.abort();\n      this.abortController_ = null;\n    }\n    this.setInViewport(false);\n    if (this.element.unlayoutCallback()) {\n      this.element.togglePlaceholder(true);\n      this.state_ = ResourceState.NOT_LAID_OUT;\n      this.layoutCount_ = 0;\n      this.layoutPromise_ = null;\n    }\n  }\n\n  /**\n   * Returns the task ID for this resource.\n   * @param {string} localId\n   * @return {string}\n   */\n  getTaskId(localId) {\n    return this.debugid + '#' + localId;\n  }\n\n  /**\n   * Calls element's pauseCallback callback.\n   */\n  pause() {\n    this.element.pause();\n  }\n\n  /**\n   * Calls element's pauseCallback callback.\n   */\n  pauseOnRemove() {\n    this.element.pause();\n  }\n\n  /**\n   * Calls element's resumeCallback callback.\n   */\n  resume() {\n    this.element.resume();\n  }\n\n  /**\n   * Called when a previously visible element is no longer displayed.\n   */\n  unload() {\n    this.element.unmount();\n  }\n\n  /**\n   * Disconnect the resource. Mainly intended for embed resources that do not\n   * receive `disconnectedCallback` naturally via CE API.\n   */\n  disconnect() {\n    delete this.element[RESOURCE_PROP_];\n    this.element.disconnect(/* opt_pretendDisconnected */ true);\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './promise';\nimport {map} from '../types/object';\n\n// typedef imports\nimport {TimestampDef} from '../types/date';\n\n/**\n * This object tracts signals and allows blocking until a signal has been\n * received.\n */\nexport class Signals {\n  /**\n   * Creates an instance of Signals.\n   */\n  constructor() {\n    /**\n     * A mapping from a signal name to the signal response: either time or\n     * an error.\n     * @private @const {!Object<string, (!TimestampDef|!Error)>}\n     */\n    this.map_ = map();\n\n    /**\n     * A mapping from a signal name to the signal promise, resolve and reject.\n     * Only allocated when promise has been requested.\n     * @private {?Object<string, {\n     *   promise: !Promise,\n     *   resolve: (function(!TimestampDef)|undefined),\n     *   reject: (function(!Error)|undefined)\n     * }>}\n     */\n    this.promiseMap_ = null;\n  }\n\n  /**\n   * Returns the current known value of the signal. If signal is not yet\n   * available, `null` is returned.\n   * @param {string} name\n   * @return {number|!Error|null}\n   */\n  get(name) {\n    const v = this.map_[name];\n    return v == null ? null : v;\n  }\n\n  /**\n   * Returns the promise that's resolved when the signal is triggered. The\n   * resolved value is the time of the signal.\n   * @param {string} name\n   * @return {!Promise<!TimestampDef>}\n   */\n  whenSignal(name) {\n    let promiseStruct = this.promiseMap_?.[name];\n    if (!promiseStruct) {\n      const result = this.map_[name];\n      if (result != null) {\n        // Immediately resolve signal.\n        const promise =\n          typeof result == 'number'\n            ? Promise.resolve(result)\n            : Promise.reject(result);\n        promiseStruct = {promise};\n      } else {\n        // Allocate the promise/resolver for when the signal arrives in the\n        // future.\n        promiseStruct = new Deferred();\n      }\n      if (!this.promiseMap_) {\n        this.promiseMap_ = map();\n      }\n      this.promiseMap_[name] = promiseStruct;\n    }\n    return promiseStruct.promise;\n  }\n\n  /**\n   * Triggers the signal with the specified name on the element. The time is\n   * optional; if not provided, the current time is used. The associated\n   * promise is resolved with the resulting TimestampDef.\n   * @param {string} name\n   * @param {!TimestampDef=} opt_time\n   */\n  signal(name, opt_time) {\n    if (this.map_[name] != null) {\n      // Do not duplicate signals.\n      return;\n    }\n    const time = opt_time ?? Date.now();\n    this.map_[name] = time;\n    const promiseStruct = this.promiseMap_?.[name];\n    if (promiseStruct?.resolve) {\n      promiseStruct.resolve(time);\n      promiseStruct.resolve = undefined;\n      promiseStruct.reject = undefined;\n    }\n  }\n\n  /**\n   * Rejects the signal. Indicates that the signal will never succeed. The\n   * associated signal is rejected.\n   * @param {string} name\n   * @param {!Error} error\n   */\n  rejectSignal(name, error) {\n    if (this.map_[name] != null) {\n      // Do not duplicate signals.\n      return;\n    }\n    this.map_[name] = error;\n    const promiseStruct = this.promiseMap_?.[name];\n    if (promiseStruct?.reject) {\n      promiseStruct.reject(error);\n      promiseStruct.promise.catch(() => {});\n      promiseStruct.resolve = undefined;\n      promiseStruct.reject = undefined;\n    }\n  }\n\n  /**\n   * Resets all signals.\n   * @param {string} name\n   */\n  reset(name) {\n    if (this.map_[name]) {\n      delete this.map_[name];\n    }\n    // Reset promise it has already been resolved.\n    const promiseStruct = this.promiseMap_?.[name];\n    if (promiseStruct && !promiseStruct.resolve) {\n      delete this.promiseMap_[name];\n    }\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {dev, devAssert} from './log';\nimport {dict} from './core/types/object';\nimport {internalListenImplementation} from './core/dom/event-helper-listen';\nimport {tryParseJson} from './core/types/object/json';\n\n/** @const */\nconst AMP_MESSAGE_PREFIX = 'amp-';\nexport const CONSTANTS = {\n  responseTypeSuffix: '-result',\n  messageIdFieldName: 'messageId',\n  payloadFieldName: 'payload',\n  contentFieldName: 'content',\n};\n\n/** @enum {string} */\nexport const MessageType = {\n  // For amp-ad\n  SEND_EMBED_STATE: 'send-embed-state',\n  EMBED_STATE: 'embed-state',\n  SEND_EMBED_CONTEXT: 'send-embed-context',\n  EMBED_CONTEXT: 'embed-context',\n  SEND_INTERSECTIONS: 'send-intersections',\n  INTERSECTION: 'intersection',\n  EMBED_SIZE: 'embed-size',\n  EMBED_SIZE_CHANGED: 'embed-size-changed',\n  EMBED_SIZE_DENIED: 'embed-size-denied',\n  NO_CONTENT: 'no-content',\n  GET_HTML: 'get-html',\n  GET_CONSENT_STATE: 'get-consent-state',\n  SIGNAL_INTERACTIVE: 'signal-interactive',\n\n  // For the frame to be placed in full overlay mode for lightboxes\n  FULL_OVERLAY_FRAME: 'full-overlay-frame',\n  FULL_OVERLAY_FRAME_RESPONSE: 'full-overlay-frame-response',\n  CANCEL_FULL_OVERLAY_FRAME: 'cancel-full-overlay-frame',\n  CANCEL_FULL_OVERLAY_FRAME_RESPONSE: 'cancel-full-overlay-frame-response',\n\n  // For amp-inabox\n  SEND_POSITIONS: 'send-positions',\n  POSITION: 'position',\n\n  // For amp-analytics' iframe-transport\n  SEND_IFRAME_TRANSPORT_EVENTS: 'send-iframe-transport-events',\n  IFRAME_TRANSPORT_EVENTS: 'iframe-transport-events',\n  IFRAME_TRANSPORT_RESPONSE: 'iframe-transport-response',\n\n  // For user-error-in-iframe\n  USER_ERROR_IN_IFRAME: 'user-error-in-iframe',\n\n  // For amp-iframe\n  SEND_CONSENT_DATA: 'send-consent-data',\n  CONSENT_DATA: 'consent-data',\n};\n\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listen(element, eventType, listener, opt_evtListenerOpts) {\n  return internalListenImplementation(\n    element,\n    eventType,\n    listener,\n    opt_evtListenerOpts\n  );\n}\n\n/**\n * Serialize an AMP post message. Output looks like:\n * 'amp-011481323099490{\"type\":\"position\",\"sentinel\":\"12345\",\"foo\":\"bar\"}'\n * @param {string} type\n * @param {string} sentinel\n * @param {JsonObject=} data\n * @param {?string=} rtvVersion\n * @return {string}\n */\nexport function serializeMessage(\n  type,\n  sentinel,\n  data = dict(),\n  rtvVersion = null\n) {\n  // TODO: consider wrap the data in a \"data\" field. { type, sentinal, data }\n  const message = data;\n  message['type'] = type;\n  message['sentinel'] = sentinel;\n  return AMP_MESSAGE_PREFIX + (rtvVersion || '') + JSON.stringify(message);\n}\n\n/**\n * Deserialize an AMP post message.\n * Returns null if it's not valid AMP message format.\n *\n * @param {*} message\n * @return {?JsonObject|undefined}\n */\nexport function deserializeMessage(message) {\n  if (!isAmpMessage(message)) {\n    return null;\n  }\n  const startPos = message.indexOf('{');\n  devAssert(startPos != -1, 'JSON missing in %s', message);\n  return tryParseJson(message.substr(startPos), (e) =>\n    dev().error('MESSAGING', 'Failed to parse message: ' + message, e)\n  );\n}\n\n/**\n *  Returns true if message looks like it is an AMP postMessage\n *  @param {*} message\n *  @return {boolean}\n */\nexport function isAmpMessage(message) {\n  return (\n    typeof message == 'string' &&\n    message.indexOf(AMP_MESSAGE_PREFIX) == 0 &&\n    message.indexOf('{') != -1\n  );\n}\n\n/** @typedef {{creativeId: string, message: string}} */\nexport let IframeTransportEvent;\n// An event, and the transport ID of the amp-analytics tags that\n// generated it. For instance if the creative with transport\n// ID 2 sends \"hi\", then an IframeTransportEvent would look like:\n// { creativeId: \"2\", message: \"hi\" }\n// If the creative with transport ID 2 sent that, and also sent \"hello\",\n// and the creative with transport ID 3 sends \"goodbye\" then an *array* of 3\n// AmpAnalyticsIframeTransportEvent would be sent to the 3p frame like so:\n// [\n//   { creativeId: \"2\", message: \"hi\" }, // An AmpAnalyticsIframeTransportEvent\n//   { creativeId: \"2\", message: \"hello\" }, // Another\n//   { creativeId: \"3\", message: \"goodbye\" } // And another\n// ]\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {addAttributesToElement} from './dom';\nimport {closestAncestorElementBySelector} from './core/dom/query';\nimport {deserializeMessage, isAmpMessage} from './3p-frame-messaging';\nimport {dev, devAssert} from './log';\nimport {dict} from './core/types/object';\nimport {getData} from './event-helper';\nimport {parseUrlDeprecated} from './url';\nimport {remove} from './core/types/array';\nimport {setStyle} from './style';\nimport {tryParseJson} from './core/types/object/json';\n\n/**\n * Sentinel used to force unlistening after a iframe is detached.\n * @type {string}\n */\nconst UNLISTEN_SENTINEL = 'unlisten';\n\n/**\n * @typedef {{\n *   frame: !Element,\n *   events: !Object<string, !Array<function(!JsonObject)>>\n * }}\n */\nlet WindowEventsDef;\n\n/**\n * Returns a mapping from a URL's origin to an array of windows and their\n * listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {boolean=} opt_create create the mapping if it does not exist\n * @return {?Object<string, !Array<!WindowEventsDef>>}\n */\nfunction getListenFors(parentWin, opt_create) {\n  let {listeningFors} = parentWin;\n\n  if (!listeningFors && opt_create) {\n    listeningFors = parentWin.listeningFors = Object.create(null);\n  }\n  return listeningFors || null;\n}\n\n/**\n * Returns an array of WindowEventsDef that have had any listenFor listeners\n * registered for this sentinel.\n * @param {?Window} parentWin the window that created the iframe\n * @param {string} sentinel the sentinel of the message\n * @param {boolean=} opt_create create the array if it does not exist\n * @return {?Array<!WindowEventsDef>}\n */\nfunction getListenForSentinel(parentWin, sentinel, opt_create) {\n  const listeningFors = getListenFors(parentWin, opt_create);\n  if (!listeningFors) {\n    return listeningFors;\n  }\n\n  let listenSentinel = listeningFors[sentinel];\n  if (!listenSentinel && opt_create) {\n    listenSentinel = listeningFors[sentinel] = [];\n  }\n  return listenSentinel || null;\n}\n\n/**\n * Returns an mapping of event names to listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {!Element} iframe the iframe element who's context will trigger the\n *     event\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @return {?Object<string, !Array<function(!JsonObject, !Window, string, !MessageEvent)>>}\n */\nfunction getOrCreateListenForEvents(parentWin, iframe, opt_is3P) {\n  const sentinel = getSentinel_(iframe, opt_is3P);\n  const listenSentinel = getListenForSentinel(parentWin, sentinel, true);\n\n  let windowEvents;\n  for (let i = 0; i < listenSentinel.length; i++) {\n    const we = listenSentinel[i];\n    if (we.frame === iframe) {\n      windowEvents = we;\n      break;\n    }\n  }\n\n  if (!windowEvents) {\n    windowEvents = {\n      frame: iframe,\n      events: Object.create(null),\n    };\n    listenSentinel.push(windowEvents);\n  }\n\n  return windowEvents.events;\n}\n\n/**\n * Returns an mapping of event names to listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {string} sentinel the sentinel of the message\n * @param {string} origin the source window's origin\n * @param {?Window} triggerWin the window that triggered the event\n * @return {?Object<string, !Array<function(!JsonObject, !Window, string, !MessageEvent)>>}\n */\nfunction getListenForEvents(parentWin, sentinel, origin, triggerWin) {\n  const listenSentinel = getListenForSentinel(parentWin, sentinel);\n\n  if (!listenSentinel) {\n    return listenSentinel;\n  }\n\n  // Find the entry for the frame.\n  // TODO(@nekodo): Add a WeakMap<Window, WindowEventsDef> cache to\n  //     speed up this process.\n  let windowEvents;\n  for (let i = 0; i < listenSentinel.length; i++) {\n    const we = listenSentinel[i];\n    const {contentWindow} = we.frame;\n    if (!contentWindow) {\n      setTimeout(dropListenSentinel, 0, listenSentinel);\n    } else if (\n      triggerWin == contentWindow ||\n      isDescendantWindow(contentWindow, triggerWin)\n    ) {\n      // 3p code path, we may accept messages from nested frames.\n      windowEvents = we;\n      break;\n    }\n  }\n\n  return windowEvents ? windowEvents.events : null;\n}\n\n/**\n * Checks whether one window is a descendant of another by climbing\n * the parent chain.\n * @param {?Window} ancestor potential ancestor window\n * @param {?Window} descendant potential descendant window\n * @return {boolean}\n */\nfunction isDescendantWindow(ancestor, descendant) {\n  for (let win = descendant; win && win != win.parent; win = win.parent) {\n    if (win == ancestor) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Removes any listenFors registed on listenSentinel that do not have\n * a contentWindow (the frame was removed from the DOM tree).\n * @param {!Array<!WindowEventsDef>} listenSentinel\n */\nfunction dropListenSentinel(listenSentinel) {\n  const noopData = dict({'sentinel': UNLISTEN_SENTINEL});\n\n  for (let i = listenSentinel.length - 1; i >= 0; i--) {\n    const windowEvents = listenSentinel[i];\n\n    if (!windowEvents.frame.contentWindow) {\n      listenSentinel.splice(i, 1);\n\n      const {events} = windowEvents;\n      for (const name in events) {\n        // Splice here, so that each unlisten does not shift the array\n        events[name].splice(0, Infinity).forEach((event) => {\n          event(noopData);\n        });\n      }\n    }\n  }\n}\n\n/**\n * Registers the global listenFor event listener if it has yet to be.\n * @param {?Window} parentWin\n */\nfunction registerGlobalListenerIfNeeded(parentWin) {\n  if (parentWin.listeningFors) {\n    return;\n  }\n  const listenForListener = function (event) {\n    if (!getData(event)) {\n      return;\n    }\n    const data = parseIfNeeded(getData(event));\n\n    if (!data || !data['sentinel']) {\n      return;\n    }\n\n    const listenForEvents = getListenForEvents(\n      parentWin,\n      data['sentinel'],\n      event.origin,\n      event.source\n    );\n    if (!listenForEvents) {\n      return;\n    }\n\n    let listeners = listenForEvents[data['type']];\n    if (!listeners) {\n      return;\n    }\n\n    // We slice to avoid issues with adding another listener or unlistening\n    // during iteration. We could move to a Doubly Linked List with\n    // backtracking, but that's overly complicated.\n    listeners = listeners.slice();\n    for (let i = 0; i < listeners.length; i++) {\n      const listener = listeners[i];\n      listener(data, event.source, event.origin, event);\n    }\n  };\n\n  parentWin.addEventListener('message', listenForListener);\n}\n\n/**\n * Allows listening for message from the iframe. Returns an unlisten\n * function to remove the listener.\n *\n * @param {?Element} iframe\n * @param {string} typeOfMessage\n * @param {?function(!JsonObject, !Window, string, !MessageEvent)} callback Called when a\n *     message of this type arrives for this iframe.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @param {boolean=} opt_includingNestedWindows set to true if messages from\n *     nested frames should also be accepted.\n * @param {boolean=} opt_allowOpaqueOrigin set to true if messages from\n       opaque origins (origin == null) are allowed.\n * @return {!UnlistenDef}\n */\nexport function listenFor(\n  iframe,\n  typeOfMessage,\n  callback,\n  opt_is3P,\n  opt_includingNestedWindows,\n  opt_allowOpaqueOrigin\n) {\n  devAssert(iframe.src, 'only iframes with src supported');\n  devAssert(\n    !iframe.parentNode,\n    'cannot register events on an attached ' +\n      'iframe. It will cause hair-pulling bugs like #2942'\n  );\n  devAssert(callback);\n  const parentWin = iframe.ownerDocument.defaultView;\n\n  registerGlobalListenerIfNeeded(parentWin);\n\n  const listenForEvents = getOrCreateListenForEvents(\n    parentWin,\n    iframe,\n    opt_is3P\n  );\n\n  const iframeOrigin = parseUrlDeprecated(iframe.src).origin;\n  let events =\n    listenForEvents[typeOfMessage] || (listenForEvents[typeOfMessage] = []);\n\n  let unlisten;\n  let listener = function (data, source, origin, event) {\n    const sentinel = data['sentinel'];\n\n    // Exclude messages that don't satisfy amp sentinel rules.\n    if (sentinel == 'amp') {\n      // For `amp` sentinel, nested windows are not allowed\n      if (source != iframe.contentWindow) {\n        return;\n      }\n\n      // For `amp` sentinel origin must match unless opaque origin is allowed\n      const isOpaqueAndAllowed = origin == 'null' && opt_allowOpaqueOrigin;\n      if (iframeOrigin != origin && !isOpaqueAndAllowed) {\n        return;\n      }\n    }\n\n    // Exclude nested frames if necessary.\n    // Note that the source was already verified to be either the contentWindow\n    // of the iframe itself or a descendant window within it.\n    if (!opt_includingNestedWindows && source != iframe.contentWindow) {\n      return;\n    }\n\n    if (data.sentinel == UNLISTEN_SENTINEL) {\n      unlisten();\n      return;\n    }\n    callback(data, source, origin, event);\n  };\n\n  events.push(listener);\n\n  return (unlisten = function () {\n    if (listener) {\n      const index = events.indexOf(listener);\n      if (index > -1) {\n        events.splice(index, 1);\n      }\n      // Make sure references to the unlisten function do not keep\n      // alive too much.\n      listener = null;\n      events = null;\n      callback = null;\n    }\n  });\n}\n\n/**\n * Returns a promise that resolves when one of given messages has been observed\n * for the first time. And remove listener for all other messages.\n * @param {!Element} iframe\n * @param {string|!Array<string>} typeOfMessages\n * @param {boolean=} opt_is3P\n * @return {!Promise<!{data: !JsonObject, source: !Window, origin: string, event: !MessageEvent}>}\n */\nexport function listenForOncePromise(iframe, typeOfMessages, opt_is3P) {\n  const unlistenList = [];\n  if (typeof typeOfMessages == 'string') {\n    typeOfMessages = [typeOfMessages];\n  }\n  return new Promise((resolve) => {\n    for (let i = 0; i < typeOfMessages.length; i++) {\n      const message = typeOfMessages[i];\n      const unlisten = listenFor(\n        iframe,\n        message,\n        (data, source, origin, event) => {\n          for (let i = 0; i < unlistenList.length; i++) {\n            unlistenList[i]();\n          }\n          resolve({data, source, origin, event});\n        },\n        opt_is3P\n      );\n      unlistenList.push(unlisten);\n    }\n  });\n}\n\n/**\n * Posts a message to the iframe.\n * @param {!Element} iframe The iframe.\n * @param {string} type Type of the message.\n * @param {!JsonObject} object Message payload.\n * @param {string} targetOrigin origin of the target.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n */\nexport function postMessage(iframe, type, object, targetOrigin, opt_is3P) {\n  postMessageToWindows(\n    iframe,\n    [{win: iframe.contentWindow, origin: targetOrigin}],\n    type,\n    object,\n    opt_is3P\n  );\n}\n\n/**\n * Posts an identical message to multiple target windows with the same\n * sentinel.\n * The message is serialized only once.\n * @param {!Element} iframe The iframe.\n * @param {!Array<{win: !Window, origin: string}>} targets to send the message\n *     to, pairs of window and its origin.\n * @param {string} type Type of the message.\n * @param {!JsonObject} object Message payload.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n */\nexport function postMessageToWindows(iframe, targets, type, object, opt_is3P) {\n  if (!iframe.contentWindow) {\n    return;\n  }\n  object['type'] = type;\n  object['sentinel'] = getSentinel_(iframe, opt_is3P);\n  let payload = object;\n  if (opt_is3P) {\n    // Serialize ourselves because that is much faster in Chrome.\n    payload = 'amp-' + JSON.stringify(object);\n  }\n  for (let i = 0; i < targets.length; i++) {\n    const target = targets[i];\n    target.win./*OK*/ postMessage(payload, target.origin);\n  }\n}\n\n/**\n * Gets the sentinel string.\n * @param {!Element} iframe The iframe.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @return {string} Sentinel string.\n * @private\n */\nfunction getSentinel_(iframe, opt_is3P) {\n  return opt_is3P ? iframe.getAttribute('data-amp-3p-sentinel') : 'amp';\n}\n\n/**\n * JSON parses event.data if it needs to be\n * @param {*} data\n * @return {?JsonObject} object message\n * @private\n * @visibleForTesting\n */\nexport function parseIfNeeded(data) {\n  if (typeof data == 'string') {\n    if (data.charAt(0) == '{') {\n      data =\n        tryParseJson(data, (e) => {\n          dev().warn(\n            'IFRAME-HELPER',\n            'Postmessage could not be parsed. ' +\n              'Is it in a valid JSON format?',\n            e\n          );\n        }) || null;\n    } else if (isAmpMessage(data)) {\n      data = deserializeMessage(data);\n    } else {\n      data = null;\n    }\n  }\n  return /** @type {?JsonObject} */ (data);\n}\n\n/**\n * Manages a postMessage API for an iframe with a subscription message and\n * a way to broadcast messages to all subscribed windows, which\n * in turn must all be descendants of the contentWindow of the iframe.\n */\nexport class SubscriptionApi {\n  /**\n   * @param {!Element} iframe The iframe.\n   * @param {string} type Type of the subscription message.\n   * @param {boolean} is3p set to true if the iframe is 3p.\n   * @param {function(!JsonObject, !Window, string)} requestCallback Callback\n   *     invoked whenever a new window subscribes.\n   */\n  constructor(iframe, type, is3p, requestCallback) {\n    /** @private @const {!Element} */\n    this.iframe_ = iframe;\n    /** @private @const {boolean} */\n    this.is3p_ = is3p;\n    /** @private @const {!Array<{win: !Window, origin: string}>} */\n    this.clientWindows_ = [];\n\n    /** @private @const {!UnlistenDef} */\n    this.unlisten_ = listenFor(\n      this.iframe_,\n      type,\n      (data, source, origin) => {\n        // This message might be from any window within the iframe, we need\n        // to keep track of which windows want to be sent updates.\n        if (!this.clientWindows_.some((entry) => entry.win == source)) {\n          this.clientWindows_.push({win: source, origin});\n        }\n        requestCallback(data, source, origin);\n      },\n      this.is3p_,\n      // For 3P frames we also allow nested frames within them to subscribe..\n      this.is3p_ /* opt_includingNestedWindows */\n    );\n  }\n\n  /**\n   * Sends a message to all subscribed windows.\n   * @param {string} type Type of the message.\n   * @param {!JsonObject} data Message payload.\n   */\n  send(type, data) {\n    // Remove clients that have been removed from the DOM.\n    remove(this.clientWindows_, (client) => !client.win.parent);\n    postMessageToWindows(\n      this.iframe_,\n      this.clientWindows_,\n      type,\n      data,\n      this.is3p_\n    );\n  }\n\n  /**\n   * Destroys iframe.\n   */\n  destroy() {\n    this.unlisten_();\n    this.clientWindows_.length = 0;\n  }\n}\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nexport function looksLikeTrackingIframe(element) {\n  const {height, width} = element.getLayoutSize();\n  // This heuristic is subject to change.\n  if (width > 10 || height > 10) {\n    return false;\n  }\n  // Iframe is not tracking iframe if open with user interaction\n  return !closestAncestorElementBySelector(element, '.i-amphtml-overlay');\n}\n\n// Most common ad sizes\n// Array of [width, height] pairs.\nconst adSizes = [\n  [300, 250],\n  [320, 50],\n  [300, 50],\n  [320, 100],\n];\n\n/**\n * Guess whether this element might be an ad.\n * @param {!Element} element An amp-iframe element.\n * @return {boolean}\n * @visibleForTesting\n */\nexport function isAdLike(element) {\n  const {height, width} = element.getLayoutSize();\n  for (let i = 0; i < adSizes.length; i++) {\n    const refWidth = adSizes[i][0];\n    const refHeight = adSizes[i][1];\n    if (refHeight > height) {\n      continue;\n    }\n    if (refWidth > width) {\n      continue;\n    }\n    // Fuzzy matching to account for padding.\n    if (height - refHeight <= 20 && width - refWidth <= 20) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * @param {!Element} iframe\n * @return {!Element}\n */\nexport function disableScrollingOnIframe(iframe) {\n  addAttributesToElement(iframe, dict({'scrolling': 'no'}));\n\n  // This shouldn't work, but it does on Firefox.\n  // https://stackoverflow.com/a/15494969\n  setStyle(iframe, 'overflow', 'hidden');\n\n  return iframe;\n}\n\n/**\n * Returns true if win's properties can be accessed and win is defined.\n * This functioned is used to determine if a window is cross-domained\n * from the perspective of the current window.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function canInspectWindow(win) {\n  // TODO: this is not reliable.  The compiler assumes that property reads are\n  // side-effect free.  The recommended fix is to use goog.reflect.sinkValue\n  // but since we're not using the closure library I'm not sure how to do this.\n  // See https://github.com/google/closure-compiler/issues/3156\n  try {\n    // win['test'] could be truthy but not true the compiler shouldn't be able\n    // to optimize this check away.\n    return !!win.location.href && (win['test'] || true);\n  } catch (unusedErr) {\n    return false;\n  }\n}\n\n/** @const {string} */\nexport const FIE_EMBED_PROP = '__AMP_EMBED__';\n\n/**\n * Returns the embed created using `installFriendlyIframeEmbed` or `null`.\n * Caution: This will only return the FIE after the iframe has 'loaded'. If you\n * are checking before this signal you may be in a race condition that returns\n * null.\n * @param {!HTMLIFrameElement} iframe\n * @return {?./friendly-iframe-embed.FriendlyIframeEmbed}\n */\nexport function getFriendlyIframeEmbedOptional(iframe) {\n  return /** @type {?./friendly-iframe-embed.FriendlyIframeEmbed} */ (\n    iframe[FIE_EMBED_PROP]\n  );\n}\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isInFie(element) {\n  return (\n    element.classList.contains('i-amphtml-fie') ||\n    !!closestAncestorElementBySelector(element, '.i-amphtml-fie')\n  );\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {MessageType} from '../3p-frame-messaging';\nimport {SubscriptionApi} from '../iframe-helper';\nimport {dict} from '../core/types/object';\nimport {\n  layoutRectLtwh,\n  moveLayoutRect,\n  rectIntersection,\n} from '../core/math/layout-rect';\n\n/**\n * The structure that defines the rectangle used in intersection observers.\n *\n * @typedef {{\n *   top: number,\n *   bottom: number,\n *   left: number,\n *   right: number,\n *   width: number,\n *   height: number,\n *   x: number,\n *   y: number,\n * }}\n */\nexport let DOMRect;\n\nexport const DEFAULT_THRESHOLD = [\n  0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65,\n  0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1,\n];\n\n/** @typedef {{\n *    element: !Element,\n *    currentThresholdSlot: number,\n *  }}\n */\nlet ElementIntersectionStateDef;\n\n/** @const @private */\nconst INIT_TIME = Date.now();\n\n/**\n * A function to get the element's current IntersectionObserverEntry\n * regardless of the intersetion ratio. Only available when element is not\n * nested in a container iframe.\n * @param {!../layout-rect.LayoutRectDef} element element's rect\n * @param {?../layout-rect.LayoutRectDef} owner element's owner rect\n * @param {!../layout-rect.LayoutRectDef} hostViewport hostViewport's rect\n * @return {!IntersectionObserverEntry} A change entry.\n */\nexport function getIntersectionChangeEntry(element, owner, hostViewport) {\n  const intersection =\n    rectIntersection(element, owner, hostViewport) ||\n    layoutRectLtwh(0, 0, 0, 0);\n  const ratio = intersectionRatio(intersection, element);\n  return calculateChangeEntry(element, hostViewport, intersection, ratio);\n}\n\n/**\n * A class to help amp-iframe and amp-ad nested iframe listen to intersection\n * change.\n */\nexport class IntersectionObserver3pHost {\n  /**\n   * @param {!AMP.BaseElement} baseElement\n   * @param {!Element} iframe\n   */\n  constructor(baseElement, iframe) {\n    /** @private @const {!AMP.BaseElement} */\n    this.baseElement_ = baseElement;\n\n    /** @private {?IntersectionObserver} */\n    this.intersectionObserver_ = null;\n\n    /** @private {?SubscriptionApi} */\n    this.subscriptionApi_ = new SubscriptionApi(\n      iframe,\n      MessageType.SEND_INTERSECTIONS,\n      false, // is3P\n      () => {\n        this.startSendingIntersection_();\n      }\n    );\n\n    this.intersectionObserver_ = new IntersectionObserver(\n      (entries) => {\n        this.subscriptionApi_.send(\n          MessageType.INTERSECTION,\n          dict({'changes': entries.map(cloneEntryForCrossOrigin)})\n        );\n      },\n      {threshold: DEFAULT_THRESHOLD}\n    );\n  }\n\n  /**\n   * Function to start listening to viewport event. and observer intersection\n   * change on the element.\n   */\n  startSendingIntersection_() {\n    this.intersectionObserver_.observe(this.baseElement_.element);\n  }\n\n  /**\n   * Clean all listenrs\n   */\n  destroy() {\n    this.intersectionObserver_.disconnect();\n    this.intersectionObserver_ = null;\n    this.subscriptionApi_.destroy();\n    this.subscriptionApi_ = null;\n  }\n}\n\n/**\n * Returns the ratio of the smaller box's area to the larger box's area.\n * @param {!../layout-rect.LayoutRectDef} smaller\n * @param {!../layout-rect.LayoutRectDef} larger\n * @return {number}\n * @visibleForTesting\n */\nexport function intersectionRatio(smaller, larger) {\n  const smallerBoxArea = smaller.width * smaller.height;\n  const largerBoxArea = larger.width * larger.height;\n\n  // Check for a divide by zero\n  return largerBoxArea === 0 ? 0 : smallerBoxArea / largerBoxArea;\n}\n\n/**\n * Helper function to calculate the IntersectionObserver change entry.\n * @param {!../layout-rect.LayoutRectDef} element element's rect\n * @param {?../layout-rect.LayoutRectDef} hostViewport hostViewport's rect\n * @param {!../layout-rect.LayoutRectDef} intersection\n * @param {number} ratio\n * @return {!IntersectionObserverEntry}}\n */\nfunction calculateChangeEntry(element, hostViewport, intersection, ratio) {\n  // If element not in an iframe.\n  // adjust all LayoutRect to hostViewport Origin.\n  let boundingClientRect = element;\n  let rootBounds = hostViewport;\n  // If no hostViewport is provided, element is inside an non-scrollable iframe.\n  // Every Layoutrect has already adjust their origin according to iframe\n  // rect origin. LayoutRect position is relative to iframe origin,\n  // thus relative to iframe's viewport origin because the viewport is at the\n  // iframe origin. No need to adjust position here.\n\n  if (hostViewport) {\n    // If element not in an iframe.\n    // adjust all LayoutRect to hostViewport Origin.\n    rootBounds = /** @type {!../layout-rect.LayoutRectDef} */ (rootBounds);\n    intersection = moveLayoutRect(\n      intersection,\n      -hostViewport.left,\n      -hostViewport.top\n    );\n    // The element is relative to (0, 0), while the viewport moves. So, we must\n    // adjust.\n    boundingClientRect = moveLayoutRect(\n      boundingClientRect,\n      -hostViewport.left,\n      -hostViewport.top\n    );\n    // Now, move the viewport to (0, 0)\n    rootBounds = moveLayoutRect(\n      rootBounds,\n      -hostViewport.left,\n      -hostViewport.top\n    );\n  }\n\n  return /** @type {!IntersectionObserverEntry} */ ({\n    time:\n      typeof performance !== 'undefined' && performance.now\n        ? performance.now()\n        : Date.now() - INIT_TIME,\n    rootBounds,\n    boundingClientRect,\n    intersectionRect: intersection,\n    intersectionRatio: ratio,\n  });\n}\n\n/**\n * @param {!IntersectionObserverEntry} entry\n * @return {!IntersectionObserverEntry}\n */\nfunction cloneEntryForCrossOrigin(entry) {\n  return /** @type {!IntersectionObserverEntry} */ ({\n    'time': entry.time,\n    'rootBounds': entry.rootBounds,\n    'boundingClientRect': entry.boundingClientRect,\n    'intersectionRect': entry.intersectionRect,\n    'intersectionRatio': entry.intersectionRatio,\n  });\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {string} */\nexport const READY_SCAN_SIGNAL = 'ready-scan';\n\n/**\n * The internal structure of a ChangeHeightRequest.\n * @typedef {{\n *   newMargins: !../layout-rect.LayoutMarginsChangeDef,\n *   currentMargins: !../layout-rect.LayoutMarginsDef\n * }}\n */\nexport let MarginChangeDef;\n\n/**\n * The internal structure of a ChangeHeightRequest.\n * @typedef {{\n *   resource: !./resource.Resource,\n *   newHeight: (number|undefined),\n *   newWidth: (number|undefined),\n *   marginChange: (!MarginChangeDef|undefined),\n *   event: (?Event|undefined),\n *   force: boolean,\n *   callback: (function(boolean)|undefined),\n * }}\n */\nexport let ChangeSizeRequestDef;\n\n/* eslint-disable no-unused-vars */\n/**\n * @interface\n */\nexport class ResourcesInterface {\n  /**\n   * Returns a list of resources.\n   * @return {!Array<!./resource.Resource>}\n   */\n  get() {}\n\n  /**\n   * @return {!./ampdoc-impl.AmpDoc}\n   */\n  getAmpdoc() {}\n\n  /**\n   * Returns the {@link Resource} instance corresponding to the specified AMP\n   * Element. If no Resource is found, the exception is thrown.\n   * @param {!AmpElement} element\n   * @return {!./resource.Resource}\n   */\n  getResourceForElement(element) {}\n\n  /**\n   * Returns the {@link Resource} instance corresponding to the specified AMP\n   * Element. Returns null if no resource is found.\n   * @param {!AmpElement} element\n   * @return {?./resource.Resource}\n   */\n  getResourceForElementOptional(element) {}\n\n  /**\n   * Returns the direction the user last scrolled.\n   *  - -1 for scrolling up\n   *  - 1 for scrolling down\n   *  - Defaults to 1\n   * TODO(lannka): this method should not belong to resources.\n   * @return {number}\n   */\n  getScrollDirection() {}\n\n  /**\n   * Signals that an element has been added to the DOM. Resources manager\n   * will start tracking it from this point on.\n   * @param {!AmpElement} element\n   */\n  add(element) {}\n\n  /**\n   * Signals that an element has been upgraded to the DOM. Resources manager\n   * will perform build and enable layout/viewport signals for this element.\n   * @param {!AmpElement} element\n   */\n  upgraded(element) {}\n\n  /**\n   * Signals that an element has been removed to the DOM. Resources manager\n   * will stop tracking it from this point on.\n   * @param {!AmpElement} element\n   */\n  remove(element) {}\n\n  /**\n   * Schedules layout or preload for the specified resource.\n   * @param {!./resource.Resource} resource\n   * @param {boolean} layout\n   * @param {number=} opt_parentPriority\n   * @param {boolean=} opt_forceOutsideViewport\n   */\n  scheduleLayoutOrPreload(\n    resource,\n    layout,\n    opt_parentPriority,\n    opt_forceOutsideViewport\n  ) {}\n\n  /**\n   * Schedules the work pass at the latest with the specified delay.\n   * @param {number=} opt_delay\n   * @param {boolean=} opt_relayoutAll\n   * @return {boolean}\n   */\n  schedulePass(opt_delay, opt_relayoutAll) {}\n\n  /**\n   * Enqueue, or update if already exists, a mutation task for a resource.\n   * @param {./resource.Resource} resource\n   * @param {ChangeSizeRequestDef} newRequest\n   * @package\n   */\n  updateOrEnqueueMutateTask(resource, newRequest) {}\n\n  /**\n   * Schedules the work pass at the latest with the specified delay.\n   * @package\n   */\n  schedulePassVsync() {}\n\n  /**\n   * Registers a callback to be called when the next pass happens.\n   * @param {function()} callback\n   */\n  onNextPass(callback) {}\n\n  /**\n   * @return {!Promise} when first pass executed.\n   */\n  whenFirstPass() {}\n\n  /**\n   * Called when main AMP binary is fully initialized.\n   * May never be called in Shadow Mode.\n   */\n  ampInitComplete() {}\n\n  /**\n   * @param {number} relayoutTop\n   * @package\n   */\n  setRelayoutTop(relayoutTop) {}\n\n  /**\n   * Flag that the height could have been changed.\n   * @package\n   */\n  maybeHeightChanged() {}\n\n  /**\n   * Updates the priority of the resource. If there are tasks currently\n   * scheduled, their priority is updated as well.\n   * @param {!Element} element\n   * @param {number} newLayoutPriority\n   */\n  updateLayoutPriority(element, newLayoutPriority) {}\n}\n/* eslint-enable no-unused-vars */\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {LayoutPriority} from '../layout';\nimport {READY_SCAN_SIGNAL} from './resources-interface';\nimport {VisibilityState} from '../core/constants/visibility-state';\nimport {containsNotSelf, hasNextNodeInDocumentOrder, isIframed} from '../dom';\nimport {getServiceForDoc, registerServiceBuilderForDoc} from '../service';\nimport {removeItem} from '../core/types/array';\n\nconst ID = 'scheduler';\n\nconst ROOT_MARGIN = '250% 31.25%';\n\n/** @implements {../service.Disposable} */\nexport class Scheduler {\n  /** @param {!./ampdoc-impl.AmpDoc} ampdoc  */\n  constructor(ampdoc) {\n    /** @private @const */\n    this.ampdoc_ = ampdoc;\n\n    const {win} = ampdoc;\n\n    /** @private @const {!IntersectionObserver} */\n    this.observer_ = new win.IntersectionObserver((e) => this.observed_(e), {\n      // Root bounds are not important, so we can use the `root:null` for a\n      // top-level window.\n      root: isIframed(win) ? /** @type {?} */ (win.document) : null,\n      rootMargin: ROOT_MARGIN,\n    });\n\n    /** @private @const {!Map<!Element, !IntersectionObserver>} */\n    this.containerMap_ = new Map();\n\n    /** @private @const {!Map<!AmpElement, {asap: boolean, isIntersecting: boolean}>} */\n    this.targets_ = new Map();\n\n    /** @private {?Array<!AmpElement>} */\n    this.parsingTargets_ = [];\n\n    /** @private {boolean} */\n    this.scheduledReady_ = false;\n\n    ampdoc.whenReady().then(() => this.checkParsing_());\n\n    /** @private {?UnlistenDef} */\n    this.visibilityUnlisten_ = ampdoc.onVisibilityChanged(() =>\n      this.docVisibilityChanged_()\n    );\n  }\n\n  /** @override */\n  dispose() {\n    this.observer_.disconnect();\n    this.targets_.clear();\n    if (this.visibilityUnlisten_) {\n      this.visibilityUnlisten_();\n      this.visibilityUnlisten_ = null;\n    }\n  }\n\n  /**\n   * @param {!AmpElement} target\n   */\n  scheduleAsap(target) {\n    this.targets_.set(target, {asap: true, isIntersecting: false});\n    this.waitParsing_(target);\n  }\n\n  /**\n   * @param {!AmpElement} target\n   */\n  schedule(target) {\n    if (this.targets_.has(target)) {\n      return;\n    }\n\n    if (target.deferredMount()) {\n      this.targets_.set(target, {asap: false, isIntersecting: false});\n      this.observer_.observe(target);\n      if (this.containerMap_.size > 0) {\n        this.containerMap_.forEach((observer, container) => {\n          if (containsNotSelf(container, target)) {\n            observer.observe(target);\n          }\n        });\n      }\n    } else {\n      this.targets_.set(target, {asap: false, isIntersecting: true});\n    }\n\n    this.waitParsing_(target);\n  }\n\n  /**\n   * @param {!AmpElement} target\n   */\n  unschedule(target) {\n    if (!this.targets_.has(target)) {\n      return;\n    }\n\n    this.targets_.delete(target);\n\n    this.observer_.unobserve(target);\n    if (this.containerMap_.size > 0) {\n      this.containerMap_.forEach((observer) => {\n        observer.unobserve(target);\n      });\n    }\n\n    if (this.parsingTargets_) {\n      removeItem(this.parsingTargets_, target);\n      this.checkParsing_();\n    }\n  }\n\n  /**\n   * Adds the observer for the specified container. The first observer to\n   * find an intersection will trigger the element's mount.\n   *\n   * @param {!Element} container\n   * @param {!Element=} opt_scroller\n   */\n  setContainer(container, opt_scroller) {\n    if (this.containerMap_.has(container)) {\n      return;\n    }\n\n    // Create observer.\n    const {win} = this.ampdoc_;\n    const observer = new win.IntersectionObserver((e) => this.observed_(e), {\n      root: opt_scroller || container,\n      rootMargin: ROOT_MARGIN,\n    });\n    this.containerMap_.set(container, observer);\n\n    // Subscribe all pending children. Ignore `asap` targets since they\n    // will be scheduled immediately and do not need an intersection\n    // observer input.\n    this.targets_.forEach(({asap}, target) => {\n      if (!asap && containsNotSelf(container, target)) {\n        observer.observe(target);\n      }\n    });\n  }\n\n  /**\n   * Removes the container and its observer that were set by the `setContainer`.\n   *\n   * @param {!Element} container\n   */\n  removeContainer(container) {\n    const observer = this.containerMap_.get(container);\n    if (!observer) {\n      return;\n    }\n\n    // Disconnect. All children will be unobserved automatically.\n    observer.disconnect();\n    this.containerMap_.delete(container);\n  }\n\n  /** @private*/\n  signalScanReady_() {\n    if (this.ampdoc_.isReady() && !this.scheduledReady_) {\n      this.scheduledReady_ = true;\n      const {win} = this.ampdoc_;\n      win.setTimeout(() => {\n        // This signal mainly signifies that some of the elements have been\n        // discovered and scheduled.\n        this.ampdoc_.signals().signal(READY_SCAN_SIGNAL);\n      }, 50);\n    }\n  }\n\n  /** @private */\n  docVisibilityChanged_() {\n    const vs = this.ampdoc_.getVisibilityState();\n    if (\n      vs == VisibilityState.VISIBLE ||\n      vs == VisibilityState.HIDDEN ||\n      vs == VisibilityState.PRERENDER\n    ) {\n      this.targets_.forEach((_, target) => this.maybeBuild_(target));\n    }\n  }\n\n  /**\n   * @param {!AmpElement} target\n   * @private\n   */\n  waitParsing_(target) {\n    const parsingTargets = this.parsingTargets_;\n    if (parsingTargets) {\n      if (!parsingTargets.includes(target)) {\n        parsingTargets.push(target);\n      }\n      this.checkParsing_();\n    } else {\n      this.maybeBuild_(target);\n    }\n  }\n\n  /** @private */\n  checkParsing_() {\n    const documentReady = this.ampdoc_.isReady();\n    const parsingTargets = this.parsingTargets_;\n    if (parsingTargets) {\n      for (let i = 0; i < parsingTargets.length; i++) {\n        const target = parsingTargets[i];\n        if (\n          documentReady ||\n          hasNextNodeInDocumentOrder(target, this.ampdoc_.getRootNode())\n        ) {\n          parsingTargets.splice(i--, 1);\n\n          this.maybeBuild_(target);\n        }\n      }\n    }\n    if (documentReady) {\n      this.parsingTargets_ = null;\n      this.signalScanReady_();\n    }\n  }\n\n  /**\n   * @param {!Array<!IntersectionObserverEntry>} entries\n   * @private\n   */\n  observed_(entries) {\n    for (let i = 0; i < entries.length; i++) {\n      const {isIntersecting: isThisIntersecting, target} = entries[i];\n      const ampTarget = /** @type {!AmpElement} */ (target);\n\n      const current = this.targets_.get(ampTarget);\n      if (!current) {\n        continue;\n      }\n\n      const isIntersecting = isThisIntersecting || current.isIntersecting;\n      if (isIntersecting !== current.isIntersecting) {\n        this.targets_.set(ampTarget, {asap: current.asap, isIntersecting});\n      }\n      if (isIntersecting) {\n        this.maybeBuild_(ampTarget);\n      }\n    }\n  }\n\n  /**\n   * @param {!AmpElement} target\n   * @private\n   */\n  maybeBuild_(target) {\n    const parsingTargets = this.parsingTargets_;\n    const parsed = !(parsingTargets && parsingTargets.includes(target));\n    const {asap, isIntersecting} = this.targets_.get(target) || {\n      asap: false,\n      isIntersecting: false,\n    };\n    const vs = this.ampdoc_.getVisibilityState();\n    const toBuild =\n      parsed &&\n      (asap || isIntersecting) &&\n      (vs == VisibilityState.VISIBLE ||\n        // Hidden (hidden tab) allows full build.\n        vs == VisibilityState.HIDDEN ||\n        // Prerender can only proceed when allowed.\n        (vs == VisibilityState.PRERENDER && target.prerenderAllowed()));\n    if (!toBuild) {\n      return;\n    }\n\n    this.unschedule(target);\n\n    // The high-priority elements are scheduled via `setTimeout`. All other\n    // elements are scheduled via the `requestIdleCallback`.\n    const {win} = this.ampdoc_;\n    const scheduler =\n      asap || target.getBuildPriority() <= LayoutPriority.CONTENT\n        ? win.setTimeout\n        : win.requestIdleCallback || win.setTimeout;\n    scheduler(() => target.mountInternal());\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Scheduler}\n */\nexport function getSchedulerForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, ID, Scheduler);\n  return /** @type {!Scheduler} */ (getServiceForDoc(ampdoc, ID));\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  CONSENT_POLICY_STATE, // eslint-disable-line no-unused-vars\n} from './core/constants/consent-state';\nimport {Services} from './services';\nimport {dict} from './core/types/object';\n\n/**\n * Returns a promise that resolve when all consent state the policy wait\n * for resolve. Or if consent service is not available.\n * @param {!Element|!ShadowRoot} element\n * @param {string=} policyId\n * @return {!Promise<?CONSENT_POLICY_STATE>}\n */\nexport function getConsentPolicyState(element, policyId = 'default') {\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    (consentPolicy) => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.whenPolicyResolved(/** @type {string} */ (policyId));\n    }\n  );\n}\n\n/**\n * Returns a promise that resolves to a sharedData retrieved from consent\n * remote endpoint.\n * @param {!Element|!ShadowRoot} element\n * @param {string} policyId\n * @return {!Promise<?Object>}\n */\nexport function getConsentPolicySharedData(element, policyId) {\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    (consentPolicy) => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.getMergedSharedData(\n        /** @type {string} */ (policyId)\n      );\n    }\n  );\n}\n\n/**\n * @param {!Element|!ShadowRoot} element\n * @param {string=} policyId\n * @return {!Promise<string>}\n */\nexport function getConsentPolicyInfo(element, policyId = 'default') {\n  // Return the stored consent string.\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    (consentPolicy) => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.getConsentStringInfo(\n        /** @type {string} */ (policyId)\n      );\n    }\n  );\n}\n\n/**\n * @param {!Element|!ShadowRoot} element\n * @param {string=} policyId\n * @return {!Promise<?Object|undefined>}\n */\nexport function getConsentMetadata(element, policyId = 'default') {\n  // Return the stored consent metadata.\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    (consentPolicy) => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.getConsentMetadataInfo(\n        /** @type {string} */ (policyId)\n      );\n    }\n  );\n}\n\n/**\n * Returns a set of consent values to forward to a 3rd party (like an iframe).\n * @param {!Element} element\n * @param {?string=} opt_policyId\n * @return {!Promise<!JsonObject>}\n *   See extensions/amp-consent/customizing-extension-behaviors-on-consent.md:\n *    - consentMetadata\n *    - consentString\n *    - consentPolicyState\n *    - consentPolicySharedData\n */\nexport function getConsentDataToForward(element, opt_policyId) {\n  return Services.consentPolicyServiceForDocOrNull(element).then((policy) => {\n    const gettersOrNull = dict({\n      'consentMetadata': policy && policy.getConsentMetadataInfo,\n      'consentString': policy && policy.getConsentStringInfo,\n      'consentPolicyState': policy && policy.whenPolicyResolved,\n      'consentPolicySharedData': policy && policy.getMergedSharedData,\n    });\n    if (!policy) {\n      return gettersOrNull;\n    }\n    return /** @type {!JsonObject} */ (\n      Promise.all(\n        Object.keys(gettersOrNull).map((key) =>\n          gettersOrNull[key]\n            .call(policy, opt_policyId || 'default')\n            .then((value) => ({[key]: value}))\n        )\n      ).then((objs) => Object.assign.apply({}, objs))\n    );\n  });\n}\n\n/**\n * Determine if an element needs to be blocked by consent based on meta tags.\n * @param {*} element\n * @return {boolean}\n */\nexport function shouldBlockOnConsentByMeta(element) {\n  const ampdoc = element.getAmpDoc();\n  let content = ampdoc.getMetaByName('amp-consent-blocking');\n  if (!content) {\n    return false;\n  }\n\n  // Handles whitespace\n  content = content.toUpperCase().replace(/\\s+/g, '');\n\n  const contents = /** @type {Array<string>} */ (content.split(','));\n  return contents.includes(element.tagName);\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {dev} from './log';\nimport {getData} from './event-helper';\nimport {getServiceForDoc, registerServiceBuilderForDoc} from './service';\nimport {makeBodyVisibleRecovery} from './style-installer';\nimport PriorityQueue from './core/data-structures/priority-queue';\n\n/**\n * @const {string}\n */\nconst TAG = 'CHUNK';\n\n/**\n * @type {boolean}\n */\nlet deactivated = /nochunking=1/.test(self.location.hash);\nlet allowLongTasks = false;\n\n/**\n * @const {!Promise}\n */\nconst resolved = Promise.resolve();\n\n/**\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @return {!Chunks}\n * @private\n */\nfunction chunkServiceForDoc(elementOrAmpDoc) {\n  registerServiceBuilderForDoc(elementOrAmpDoc, 'chunk', Chunks);\n  return getServiceForDoc(elementOrAmpDoc, 'chunk');\n}\n\n/**\n * Run the given function. For visible documents the function will be\n * called in a micro task (Essentially ASAP). If the document is\n * not visible, tasks will yield to the event loop (to give the browser\n * time to do other things) and may even be further delayed until\n * there is time.\n *\n * @param {!Document|!./service/ampdoc-impl.AmpDoc} doc\n * @param {function(?IdleDeadline)} fn\n * @param {boolean=} opt_makesBodyVisible Pass true if this service makes\n *     the body visible. This is relevant because it may influence the\n *     task scheduling strategy.\n */\nexport function startupChunk(doc, fn, opt_makesBodyVisible) {\n  if (deactivated) {\n    resolved.then(fn);\n    return;\n  }\n  const service = chunkServiceForDoc(doc.documentElement || doc);\n  service.runForStartup(fn);\n  if (opt_makesBodyVisible) {\n    service.runForStartup(() => {\n      service.bodyIsVisible_ = true;\n    });\n  }\n}\n\n/**\n * Run the given function sometime in the future without blocking UI.\n *\n * Higher priority tasks are executed before lower priority tasks.\n * Tasks with the same priority are executed in FIFO order.\n *\n * Uses `requestIdleCallback` if available and passes the `IdleDeadline`\n * object to the function, which can be used to perform a variable amount\n * of work depending on the remaining amount of idle time.\n *\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {function(?IdleDeadline)} fn\n * @param {ChunkPriority} priority\n */\nexport function chunk(elementOrAmpDoc, fn, priority) {\n  if (deactivated) {\n    resolved.then(fn);\n    return;\n  }\n  const service = chunkServiceForDoc(elementOrAmpDoc);\n  service.run(fn, priority);\n}\n\n/**\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @return {!Chunks}\n */\nexport function chunkInstanceForTesting(elementOrAmpDoc) {\n  return chunkServiceForDoc(elementOrAmpDoc);\n}\n\n/**\n * Use a standard micro task for every invocation. This should only\n * be called from the AMP bootstrap script if it is known that\n * chunking makes no sense. In particular this is the case when\n * AMP runs in the `amp-shadow` multi document mode.\n */\nexport function deactivateChunking() {\n  deactivated = true;\n}\n\n/**\n * Allow continuing macro tasks after a long task (>5ms).\n * In particular this is the case when AMP runs in the `amp-inabox` ads mode.\n */\nexport function allowLongTasksInChunking() {\n  allowLongTasks = true;\n}\n\n/**\n * @visibleForTesting\n */\nexport function activateChunkingForTesting() {\n  deactivated = false;\n}\n\n/**\n * Runs all currently scheduled chunks.\n * Independent of errors it will unwind the queue. Will afterwards\n * throw the first encountered error.\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n */\nexport function runChunksForTesting(elementOrAmpDoc) {\n  const service = chunkInstanceForTesting(elementOrAmpDoc);\n  const errors = [];\n  while (true) {\n    try {\n      if (!service.execute_(/* idleDeadline */ null)) {\n        break;\n      }\n    } catch (e) {\n      errors.push(e);\n    }\n  }\n  if (errors.length) {\n    throw errors[0];\n  }\n}\n\n/**\n * The priority of a chunk task. Higher priority tasks have higher values.\n * @enum {number}\n */\nexport const ChunkPriority = {\n  HIGH: 20,\n  LOW: 10,\n  BACKGROUND: 0,\n};\n\n/** @enum {string} */\nconst TaskState = {\n  NOT_RUN: 'not_run',\n  RUN: 'run',\n};\n\n/**\n * A default chunkable task.\n * @private\n */\nclass Task {\n  /**\n   * @param {function(?IdleDeadline)} fn\n   */\n  constructor(fn) {\n    /** @public {TaskState} */\n    this.state = TaskState.NOT_RUN;\n\n    /** @private @const {!function(?IdleDeadline)} */\n    this.fn_ = fn;\n  }\n\n  /**\n   * Executes the wrapped function.\n   * @param {?IdleDeadline} idleDeadline\n   * @throws {Error}\n   * @protected\n   */\n  runTask_(idleDeadline) {\n    if (this.state == TaskState.RUN) {\n      return;\n    }\n    this.state = TaskState.RUN;\n    try {\n      this.fn_(idleDeadline);\n    } catch (e) {\n      this.onTaskError_(e);\n      throw e;\n    }\n  }\n\n  /**\n   * @return {string}\n   * @protected\n   */\n  getName_() {\n    return this.fn_.displayName || this.fn_.name;\n  }\n\n  /**\n   * Optional handling when a task run throws an error.\n   * @param {Error} unusedError\n   * @private\n   */\n  onTaskError_(unusedError) {\n    // By default, no-op.\n  }\n\n  /**\n   * Returns true if this task should be run without delay.\n   * @return {boolean}\n   * @protected\n   */\n  immediateTriggerCondition_() {\n    // By default, there are no immediate trigger conditions.\n    return false;\n  }\n\n  /**\n   * Returns true if this task should be scheduled using `requestIdleCallback`.\n   * Otherwise, task is scheduled as macro-task on next event loop.\n   * @return {boolean}\n   * @protected\n   */\n  useRequestIdleCallback_() {\n    // By default, never use requestIdleCallback.\n    return false;\n  }\n}\n\n/**\n * A task that's run as part of AMP's startup sequence.\n * @private\n */\nclass StartupTask extends Task {\n  /**\n   * @param {function(?IdleDeadline)} fn\n   * @param {!Window} win\n   * @param {!Chunks} chunks\n   */\n  constructor(fn, win, chunks) {\n    super(fn);\n\n    /** @private @const */\n    this.chunks_ = chunks;\n  }\n\n  /** @override */\n  onTaskError_(unusedError) {\n    // Startup tasks run early in init. All errors should show the doc.\n    makeBodyVisibleRecovery(self.document);\n  }\n\n  /** @override */\n  immediateTriggerCondition_() {\n    // Run in a micro task when the doc is visible. Otherwise, run after\n    // having yielded to the event queue once.\n    return this.isVisible_();\n  }\n\n  /** @override */\n  useRequestIdleCallback_() {\n    // We only start using requestIdleCallback when the core runtime has\n    // been initialized. Otherwise we risk starving ourselves\n    // before the render-critical work is done.\n    return this.chunks_.coreReady_;\n  }\n\n  /**\n   * @return {boolean}\n   * @private\n   */\n  isVisible_() {\n    return this.chunks_.ampdoc.isVisible();\n  }\n}\n\n/**\n * Handles queueing, scheduling and executing tasks.\n */\nclass Chunks {\n  /**\n   * @param {!./service/ampdoc-impl.AmpDoc} ampDoc\n   */\n  constructor(ampDoc) {\n    /** @protected @const {!./service/ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampDoc;\n    /** @private @const {!Window} */\n    this.win_ = ampDoc.win;\n    /** @private @const {!PriorityQueue<Task>} */\n    this.tasks_ = new PriorityQueue();\n    /** @private @const {function(?IdleDeadline)} */\n    this.boundExecute_ = this.execute_.bind(this);\n    /** @private {number} */\n    this.durationOfLastExecution_ = 0;\n    /** @private @const {boolean} */\n    this.supportsInputPending_ = !!(\n      this.win_.navigator.scheduling &&\n      this.win_.navigator.scheduling.isInputPending\n    );\n\n    /**\n     * Set to true if we scheduled a macro or micro task to execute the next\n     * task. If true, we don't schedule another one.\n     * Not set to true if we use rIC, because we always want to transition\n     * to immeditate invocation from that state.\n     * @private {boolean}\n     */\n    this.scheduledImmediateInvocation_ = false;\n    /** @private {boolean} Whether the document can actually be painted. */\n    this.bodyIsVisible_ = this.win_.document.documentElement.hasAttribute(\n      'i-amphtml-no-boilerplate'\n    );\n\n    this.win_.addEventListener('message', (e) => {\n      if (getData(e) == 'amp-macro-task') {\n        this.execute_(/* idleDeadline */ null);\n      }\n    });\n\n    /** @protected {boolean} */\n    this.coreReady_ = false;\n    Services.viewerPromiseForDoc(ampDoc).then(() => {\n      // Once the viewer has been resolved, most of core runtime has been\n      // initialized as well.\n      this.coreReady_ = true;\n    });\n\n    ampDoc.onVisibilityChanged(() => {\n      if (ampDoc.isVisible()) {\n        this.schedule_();\n      }\n    });\n  }\n\n  /**\n   * Run fn as a \"chunk\".\n   * @param {function(?IdleDeadline)} fn\n   * @param {number} priority\n   */\n  run(fn, priority) {\n    const t = new Task(fn);\n    this.enqueueTask_(t, priority);\n  }\n\n  /**\n   * Run a fn that's part of AMP's startup sequence as a \"chunk\".\n   * @param {function(?IdleDeadline)} fn\n   */\n  runForStartup(fn) {\n    const t = new StartupTask(fn, this.win_, this);\n    this.enqueueTask_(t, Number.POSITIVE_INFINITY);\n  }\n\n  /**\n   * Queues a task to be executed later with given priority.\n   * @param {!Task} task\n   * @param {number} priority\n   * @private\n   */\n  enqueueTask_(task, priority) {\n    this.tasks_.enqueue(task, priority);\n    this.schedule_();\n  }\n\n  /**\n   * Returns the next task that hasn't been run yet.\n   * If `opt_dequeue` is true, remove the returned task from the queue.\n   * @param {boolean=} opt_dequeue\n   * @return {?Task}\n   * @private\n   */\n  nextTask_(opt_dequeue) {\n    let t = this.tasks_.peek();\n    // Dequeue tasks until we find one that hasn't been run yet.\n    while (t && t.state !== TaskState.NOT_RUN) {\n      this.tasks_.dequeue();\n      t = this.tasks_.peek();\n    }\n    // If `opt_dequeue` is true, remove this task from the queue.\n    if (t && opt_dequeue) {\n      this.tasks_.dequeue();\n    }\n    return t;\n  }\n\n  /**\n   * Run a task.\n   * Schedule the next round if there are more tasks.\n   * @param {?IdleDeadline} idleDeadline\n   * @return {boolean} Whether anything was executed.\n   * @private\n   */\n  execute_(idleDeadline) {\n    const t = this.nextTask_(/* opt_dequeue */ true);\n    if (!t) {\n      this.scheduledImmediateInvocation_ = false;\n      this.durationOfLastExecution_ = 0;\n      return false;\n    }\n    let before;\n    try {\n      before = Date.now();\n      t.runTask_(idleDeadline);\n    } finally {\n      // We want to capture the time of the entire task duration including\n      // scheduled immediate (from resolved promises) micro tasks.\n      // Lacking a better way to do this we just scheduled 10 nested\n      // micro tasks.\n      resolved\n        .then()\n        .then()\n        .then()\n        .then()\n        .then()\n        .then()\n        .then()\n        .then()\n        .then(() => {\n          this.scheduledImmediateInvocation_ = false;\n          this.durationOfLastExecution_ += Date.now() - before;\n          dev().fine(\n            TAG,\n            t.getName_(),\n            'Chunk duration',\n            Date.now() - before,\n            this.durationOfLastExecution_\n          );\n\n          this.schedule_();\n        });\n    }\n    return true;\n  }\n\n  /**\n   * Calls `execute_()` asynchronously.\n   * @param {?IdleDeadline} idleDeadline\n   * @private\n   */\n  executeAsap_(idleDeadline) {\n    // If the user-agent supports isInputPending, use it to break to a macro task as necessary.\n    // Otherwise If we've spent over 5 millseconds executing the\n    // last instruction yield back to the main thread.\n    // 5 milliseconds is a magic number.\n    if (\n      !allowLongTasks &&\n      this.bodyIsVisible_ &&\n      (this.supportsInputPending_\n        ? /** @type {!{scheduling: {isInputPending: Function}}} */ (\n            this.win_.navigator\n          ).scheduling.isInputPending()\n        : this.durationOfLastExecution_ > 5)\n    ) {\n      this.durationOfLastExecution_ = 0;\n      this.requestMacroTask_();\n      return;\n    }\n    resolved.then(() => {\n      this.boundExecute_(idleDeadline);\n    });\n  }\n\n  /**\n   * Schedule running the next queued task.\n   * @private\n   */\n  schedule_() {\n    if (this.scheduledImmediateInvocation_) {\n      return;\n    }\n    const nextTask = this.nextTask_();\n    if (!nextTask) {\n      return;\n    }\n    if (nextTask.immediateTriggerCondition_()) {\n      this.scheduledImmediateInvocation_ = true;\n      this.executeAsap_(/* idleDeadline */ null);\n      return;\n    }\n    // If requestIdleCallback exists, schedule a task with it, but\n    // do not wait longer than two seconds.\n    if (nextTask.useRequestIdleCallback_() && this.win_.requestIdleCallback) {\n      onIdle(\n        this.win_,\n        // Wait until we have a budget of at least 15ms.\n        // 15ms is a magic number. Budgets are higher when the user\n        // is completely idle (around 40), but that occurs too\n        // rarely to be usable. 15ms budgets can happen during scrolling\n        // but only if the device is doing super, super well, and no\n        // real processing is done between frames.\n        15 /* minimumTimeRemaining */,\n        2000 /* timeout */,\n        this.boundExecute_\n      );\n      return;\n    }\n    this.requestMacroTask_();\n  }\n\n  /**\n   * Requests executing of a macro task. Yields to the event queue\n   * before executing the task.\n   * Places task on browser message queue which then respectively\n   * triggers dequeuing and execution of a chunk.\n   */\n  requestMacroTask_() {\n    // The message doesn't actually matter.\n    this.win_./*OK*/ postMessage('amp-macro-task', '*');\n  }\n}\n\n/**\n * Delays calling the given function until the browser is notifying us\n * about a certain minimum budget or the timeout is reached.\n * @param {!Window} win\n * @param {number} minimumTimeRemaining Minimum number of millis idle\n *     budget for callback to fire.\n * @param {number} timeout in millis for callback to fire.\n * @param {function(?IdleDeadline)} fn Callback.\n * @visibleForTesting\n */\nexport function onIdle(win, minimumTimeRemaining, timeout, fn) {\n  const startTime = Date.now();\n  /**\n   * @param {!IdleDeadline} info\n   */\n  function rIC(info) {\n    if (info.timeRemaining() < minimumTimeRemaining) {\n      const remainingTimeout = timeout - (Date.now() - startTime);\n      if (remainingTimeout <= 0 || info.didTimeout) {\n        dev().fine(TAG, 'Timed out', timeout, info.didTimeout);\n        fn(info);\n      } else {\n        dev().fine(\n          TAG,\n          'Rescheduling with',\n          remainingTimeout,\n          info.timeRemaining()\n        );\n        win.requestIdleCallback(rIC, {timeout: remainingTimeout});\n      }\n    } else {\n      dev().fine(TAG, 'Running idle callback with ', minimumTimeRemaining);\n      fn(info);\n    }\n  }\n  win.requestIdleCallback(rIC, {timeout});\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dom from './dom';\nimport * as query from './core/dom/query';\nimport {AmpEvents} from './core/constants/amp-events';\nimport {CommonSignals} from './core/constants/common-signals';\nimport {ElementStub} from './element-stub';\nimport {\n  Layout,\n  LayoutPriority,\n  applyStaticLayout,\n  isInternalElement,\n  isLoadingAllowed,\n} from './layout';\nimport {MediaQueryProps} from './core/dom/media-query-props';\nimport {ReadyState} from './core/constants/ready-state';\nimport {ResourceState} from './service/resource';\nimport {Services} from './services';\nimport {Signals} from './core/data-structures/signals';\nimport {\n  blockedByConsentError,\n  cancellation,\n  isBlockedByConsent,\n  isCancellation,\n  reportError,\n} from './error-reporting';\nimport {dev, devAssert, user, userAssert} from './log';\nimport {getIntersectionChangeEntry} from './utils/intersection-observer-3p-host';\nimport {getMode} from './mode';\nimport {getSchedulerForDoc} from './service/scheduler';\nimport {isExperimentOn} from './experiments';\nimport {rethrowAsync} from './core/error';\nimport {setStyle} from './style';\nimport {shouldBlockOnConsentByMeta} from './consent';\nimport {startupChunk} from './chunk';\nimport {toWin} from './core/window';\nimport {tryResolve} from './core/data-structures/promise';\n\nconst TAG = 'CustomElement';\n\n/**\n * @enum {number}\n */\nconst UpgradeState = {\n  NOT_UPGRADED: 1,\n  UPGRADED: 2,\n  UPGRADE_FAILED: 3,\n  UPGRADE_IN_PROGRESS: 4,\n};\n\nconst NO_BUBBLES = {bubbles: false};\nconst RETURN_TRUE = () => true;\n\n/**\n * Caches whether the template tag is supported to avoid memory allocations.\n * @type {boolean|undefined}\n */\nlet templateTagSupported;\n\n/** @type {!Array} */\nexport const stubbedElements = [];\n\n/**\n * Whether this platform supports template tags.\n * @return {boolean}\n */\nfunction isTemplateTagSupported() {\n  if (templateTagSupported === undefined) {\n    const template = self.document.createElement('template');\n    templateTagSupported = 'content' in template;\n  }\n  return templateTagSupported;\n}\n\n/**\n * Creates a named custom element class.\n *\n * @param {!Window} win The window in which to register the custom element.\n * @param {function(!./service/ampdoc-impl.AmpDoc, !AmpElement, ?(typeof BaseElement))} elementConnectedCallback\n * @return {typeof AmpElement} The custom element class.\n */\nexport function createCustomElementClass(win, elementConnectedCallback) {\n  const BaseCustomElement = /** @type {typeof HTMLElement} */ (\n    createBaseCustomElementClass(win, elementConnectedCallback)\n  );\n  // It's necessary to create a subclass, because the same \"base\" class cannot\n  // be registered to multiple custom elements.\n  class CustomAmpElement extends BaseCustomElement {\n    /**\n     * adoptedCallback is only called when using a Native implementation of Custom Elements V1.\n     * Our polyfill does not call this method.\n     */\n    adoptedCallback() {\n      // Work around an issue with Firefox changing the prototype of our\n      // already constructed element to the new document's HTMLElement.\n      if (Object.getPrototypeOf(this) !== customAmpElementProto) {\n        Object.setPrototypeOf(this, customAmpElementProto);\n      }\n    }\n  }\n  const customAmpElementProto = CustomAmpElement.prototype;\n  return /** @type {typeof AmpElement} */ (CustomAmpElement);\n}\n\n/**\n * Creates a base custom element class.\n *\n * @param {!Window} win The window in which to register the custom element.\n * @param {function(!./service/ampdoc-impl.AmpDoc, !AmpElement, ?(typeof BaseElement))} elementConnectedCallback\n * @return {typeof HTMLElement}\n */\nfunction createBaseCustomElementClass(win, elementConnectedCallback) {\n  if (win.__AMP_BASE_CE_CLASS) {\n    return win.__AMP_BASE_CE_CLASS;\n  }\n  const htmlElement = /** @type {typeof HTMLElement} */ (win.HTMLElement);\n\n  /**\n   * @abstract @extends {HTMLElement}\n   */\n  class BaseCustomElement extends htmlElement {\n    /** */\n    constructor() {\n      super();\n      this.createdCallback();\n    }\n\n    /**\n     * Called when elements is created. Sets instance vars since there is no\n     * constructor.\n     * @final\n     */\n    createdCallback() {\n      // Flag \"notbuilt\" is removed by Resource manager when the resource is\n      // considered to be built. See \"setBuilt\" method.\n      /** @private {boolean} */\n      this.built_ = false;\n\n      /**\n       * Several APIs require the element to be connected to the DOM tree, but\n       * the CustomElement lifecycle APIs are async. This lead to subtle bugs\n       * that require state tracking. See #12849, https://crbug.com/821195, and\n       * https://bugs.webkit.org/show_bug.cgi?id=180940.\n       * @private {boolean}\n       */\n      this.isConnected_ = false;\n\n      /** @private {?Promise} */\n      this.buildingPromise_ = null;\n\n      /**\n       * Indicates that the `mountCallback()` has been called and it hasn't\n       * been reversed with an `unmountCallback()` call.\n       * @private {boolean}\n       */\n      this.mounted_ = false;\n\n      /** @private {?Promise} */\n      this.mountPromise_ = null;\n\n      /** @private {?AbortController} */\n      this.mountAbortController_ = null;\n\n      /** @private {!ReadyState} */\n      this.readyState_ = ReadyState.UPGRADING;\n\n      /** @type {boolean} */\n      this.everAttached = false;\n\n      /**\n       * Ampdoc can only be looked up when an element is attached.\n       * @private {?./service/ampdoc-impl.AmpDoc}\n       */\n      this.ampdoc_ = null;\n\n      /**\n       * Resources can only be looked up when an element is attached.\n       * @private {?./service/resources-interface.ResourcesInterface}\n       */\n      this.resources_ = null;\n\n      /** @private {!Layout} */\n      this.layout_ = Layout.NODISPLAY;\n\n      /** @private {number} */\n      this.layoutCount_ = 0;\n\n      /** @private {boolean} */\n      this.isFirstLayoutCompleted_ = false;\n\n      /** @public {boolean} */\n      this.warnOnMissingOverflow = true;\n\n      /**\n       * This element can be assigned by the {@link applyStaticLayout} to a\n       * child element that will be used to size this element.\n       * @package {?Element|undefined}\n       */\n      this.sizerElement = undefined;\n\n      /** @private {?Element|undefined} */\n      this.overflowElement_ = undefined;\n\n      /**\n       * The time at which this element was scheduled for layout relative to\n       * the epoch. This value will be set to 0 until the this element has been\n       * scheduled.\n       * Note that this value may change over time if the element is enqueued,\n       * then dequeued and re-enqueued by the scheduler.\n       * @type {number|undefined}\n       */\n      this.layoutScheduleTime = undefined;\n\n      // Closure compiler appears to mark HTMLElement as @struct which\n      // disables bracket access. Force this with a type coercion.\n      const nonStructThis = /** @type {!Object} */ (this);\n\n      // `opt_implementationClass` is only used for tests.\n      /** @type {?(typeof ../base-element.BaseElement)} */\n      let Ctor =\n        win.__AMP_EXTENDED_ELEMENTS &&\n        win.__AMP_EXTENDED_ELEMENTS[this.localName];\n      if (getMode().test && nonStructThis['implementationClassForTesting']) {\n        Ctor = nonStructThis['implementationClassForTesting'];\n      }\n\n      /** @private {?(typeof ../base-element.BaseElement)} */\n      this.implClass_ = Ctor === ElementStub ? null : Ctor || null;\n\n      if (!this.implClass_) {\n        stubbedElements.push(this);\n      }\n\n      /** @private {?./base-element.BaseElement} */\n      this.impl_ = null;\n\n      /**\n       * An element always starts in a unupgraded state until it's added to DOM\n       * for the first time in which case it can be upgraded immediately or wait\n       * for script download or `upgradeCallback`.\n       * @private {!UpgradeState}\n       */\n      this.upgradeState_ = UpgradeState.NOT_UPGRADED;\n\n      /**\n       * Time delay imposed by baseElement upgradeCallback.  If no\n       * upgradeCallback specified or not yet executed, delay is 0.\n       * @private {number}\n       */\n      this.upgradeDelayMs_ = 0;\n\n      /**\n       * Action queue is initially created and kept around until the element\n       * is ready to send actions directly to the implementation.\n       * - undefined initially\n       * - array if used\n       * - null after unspun\n       * @private {?Array<!./service/action-impl.ActionInvocation>|undefined}\n       */\n      this.actionQueue_ = undefined;\n\n      /**\n       * Whether the element is in the template.\n       * @private {boolean|undefined}\n       */\n      this.isInTemplate_ = undefined;\n\n      /** @private @const */\n      this.signals_ = new Signals();\n\n      if (this.implClass_) {\n        this.signals_.signal(CommonSignals.READY_TO_UPGRADE);\n      }\n\n      const perf = Services.performanceForOrNull(win);\n      /** @private {boolean} */\n      this.perfOn_ = perf && perf.isPerformanceTrackingOn();\n\n      /** @private {?MediaQueryProps} */\n      this.mediaQueryProps_ = null;\n\n      if (nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_RESOLVER]) {\n        nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_RESOLVER](nonStructThis);\n        delete nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_RESOLVER];\n        delete nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_PROMISE];\n      }\n    }\n\n    /** @return {!ReadyState} */\n    get readyState() {\n      return this.readyState_;\n    }\n\n    /** @return {!Signals} */\n    signals() {\n      return this.signals_;\n    }\n\n    /**\n     * Returns the associated ampdoc. Only available after attachment. It throws\n     * exception before the element is attached.\n     * @return {!./service/ampdoc-impl.AmpDoc}\n     * @final\n     * @package\n     */\n    getAmpDoc() {\n      devAssert(this.ampdoc_, 'no ampdoc yet, since element is not attached');\n      return /** @type {!./service/ampdoc-impl.AmpDoc} */ (this.ampdoc_);\n    }\n\n    /**\n     * Returns Resources manager. Only available after attachment. It throws\n     * exception before the element is attached.\n     * @return {!./service/resources-interface.ResourcesInterface}\n     * @final\n     * @package\n     */\n    getResources() {\n      devAssert(\n        this.resources_,\n        'no resources yet, since element is not attached'\n      );\n      return /** @type {!./service/resources-interface.ResourcesInterface} */ (\n        this.resources_\n      );\n    }\n\n    /**\n     * Whether the element has been upgraded yet. Always returns false when\n     * the element has not yet been added to DOM. After the element has been\n     * added to DOM, the value depends on the `BaseElement` implementation and\n     * its `upgradeElement` callback.\n     * @return {boolean}\n     * @final\n     */\n    isUpgraded() {\n      return this.upgradeState_ == UpgradeState.UPGRADED;\n    }\n\n    /** @return {!Promise} */\n    whenUpgraded() {\n      return this.signals_.whenSignal(CommonSignals.UPGRADED);\n    }\n\n    /**\n     * Upgrades the element to the provided new implementation. If element\n     * has already been attached, it's layout validation and attachment flows\n     * are repeated for the new implementation.\n     * @param {typeof ./base-element.BaseElement} newImplClass\n     * @final @package\n     */\n    upgrade(newImplClass) {\n      if (this.isInTemplate_) {\n        return;\n      }\n      if (this.upgradeState_ != UpgradeState.NOT_UPGRADED) {\n        // Already upgraded or in progress or failed.\n        return;\n      }\n\n      this.implClass_ = newImplClass;\n      this.signals_.signal(CommonSignals.READY_TO_UPGRADE);\n      if (this.everAttached) {\n        // Usually, we do an implementation upgrade when the element is\n        // attached to the DOM. But, if it hadn't yet upgraded from\n        // ElementStub, we couldn't. Now that it's upgraded from a stub, go\n        // ahead and do the full upgrade.\n        this.upgradeOrSchedule_();\n      }\n    }\n\n    /**\n     * Time delay imposed by baseElement upgradeCallback.  If no\n     * upgradeCallback specified or not yet executed, delay is 0.\n     * @return {number}\n     */\n    getUpgradeDelayMs() {\n      return this.upgradeDelayMs_;\n    }\n\n    /**\n     * Completes the upgrade of the element with the provided implementation.\n     * @param {!./base-element.BaseElement} newImpl\n     * @param {number} upgradeStartTime\n     * @final @private\n     */\n    completeUpgrade_(newImpl, upgradeStartTime) {\n      this.impl_ = newImpl;\n      this.upgradeDelayMs_ = win.Date.now() - upgradeStartTime;\n      this.upgradeState_ = UpgradeState.UPGRADED;\n      this.setReadyStateInternal(ReadyState.BUILDING);\n      this.classList.remove('amp-unresolved');\n      this.classList.remove('i-amphtml-unresolved');\n      this.assertLayout_();\n      this.dispatchCustomEventForTesting(AmpEvents.ATTACHED);\n      if (!this.R1()) {\n        this.getResources().upgraded(this);\n      }\n      this.signals_.signal(CommonSignals.UPGRADED);\n    }\n\n    /** @private */\n    assertLayout_() {\n      if (\n        this.layout_ != Layout.NODISPLAY &&\n        this.impl_ &&\n        !this.impl_.isLayoutSupported(this.layout_)\n      ) {\n        userAssert(\n          this.getAttribute('layout'),\n          'The element did not specify a layout attribute. ' +\n            'Check https://amp.dev/documentation/guides-and-tutorials/' +\n            'develop/style_and_layout/control_layout and the respective ' +\n            'element documentation for details.'\n        );\n        userAssert(false, `Layout not supported: ${this.layout_}`);\n      }\n    }\n\n    /**\n     * Get the priority to build the element.\n     * @return {number}\n     */\n    getBuildPriority() {\n      return this.implClass_\n        ? this.implClass_.getBuildPriority(this)\n        : LayoutPriority.BACKGROUND;\n    }\n\n    /**\n     * Get the priority to load the element.\n     * @return {number}\n     * TODO(#31915): remove once R1 migration is complete.\n     */\n    getLayoutPriority() {\n      return this.impl_\n        ? this.impl_.getLayoutPriority()\n        : LayoutPriority.BACKGROUND;\n    }\n\n    /**\n     * Get the default action alias.\n     * @return {?string}\n     */\n    getDefaultActionAlias() {\n      devAssert(\n        this.isUpgraded(),\n        'Cannot get default action alias of unupgraded element'\n      );\n      return this.impl_.getDefaultActionAlias();\n    }\n\n    /** @return {boolean} */\n    isBuilding() {\n      return !!this.buildingPromise_;\n    }\n\n    /**\n     * Whether the element has been built. A built element had its\n     * {@link buildCallback} method successfully invoked.\n     * @return {boolean}\n     * @final\n     */\n    isBuilt() {\n      return this.built_;\n    }\n\n    /**\n     * Returns the promise that's resolved when the element has been built. If\n     * the build fails, the resulting promise is rejected.\n     * @return {!Promise}\n     */\n    whenBuilt() {\n      return this.signals_.whenSignal(CommonSignals.BUILT);\n    }\n\n    /**\n     * Requests or requires the element to be built. The build is done by\n     * invoking {@link BaseElement.buildCallback} method.\n     *\n     * Can only be called on a upgraded element. May only be called from\n     * resource.js to ensure an element and its resource are in sync.\n     *\n     * @return {?Promise}\n     * @final\n     * @restricted\n     */\n    buildInternal() {\n      assertNotTemplate(this);\n      devAssert(this.implClass_, 'Cannot build unupgraded element');\n      if (this.buildingPromise_) {\n        return this.buildingPromise_;\n      }\n\n      this.setReadyStateInternal(ReadyState.BUILDING);\n\n      // Create the instance.\n      const implPromise = this.createImpl_();\n\n      // Wait for consent.\n      const consentPromise = implPromise.then(() => {\n        const policyId = this.getConsentPolicy_();\n        const isGranularConsentExperimentOn = isExperimentOn(\n          win,\n          'amp-consent-granular-consent'\n        );\n        const purposeConsents =\n          isGranularConsentExperimentOn && !policyId\n            ? this.getPurposesConsent_()\n            : null;\n\n        if (!policyId && !(isGranularConsentExperimentOn && purposeConsents)) {\n          return;\n        }\n        // Must have policyId or granularExp w/ purposeConsents\n        return Services.consentPolicyServiceForDocOrNull(this)\n          .then((policy) => {\n            if (!policy) {\n              return true;\n            }\n            return policyId\n              ? policy.whenPolicyUnblock(policyId)\n              : policy.whenPurposesUnblock(purposeConsents);\n          })\n          .then((shouldUnblock) => {\n            if (!shouldUnblock) {\n              throw blockedByConsentError();\n            }\n          });\n      });\n\n      // Build callback.\n      const buildPromise = consentPromise.then(() =>\n        devAssert(this.impl_).buildCallback()\n      );\n\n      // Build the element.\n      return (this.buildingPromise_ = buildPromise.then(\n        () => {\n          this.built_ = true;\n          this.classList.add('i-amphtml-built');\n          this.classList.remove('i-amphtml-notbuilt');\n          this.classList.remove('amp-notbuilt');\n          this.signals_.signal(CommonSignals.BUILT);\n\n          if (this.R1()) {\n            this.setReadyStateInternal(\n              this.readyState_ != ReadyState.BUILDING\n                ? this.readyState_\n                : ReadyState.MOUNTING\n            );\n          } else {\n            this.setReadyStateInternal(ReadyState.LOADING);\n            this.preconnect(/* onLayout */ false);\n          }\n\n          if (this.isConnected_) {\n            this.connected_();\n          }\n\n          if (this.actionQueue_) {\n            // Only schedule when the queue is not empty, which should be\n            // the case 99% of the time.\n            Services.timerFor(toWin(this.ownerDocument.defaultView)).delay(\n              this.dequeueActions_.bind(this),\n              1\n            );\n          }\n          if (!this.getPlaceholder()) {\n            const placeholder = this.createPlaceholder();\n            if (placeholder) {\n              this.appendChild(placeholder);\n            }\n          }\n        },\n        (reason) => {\n          this.signals_.rejectSignal(\n            CommonSignals.BUILT,\n            /** @type {!Error} */ (reason)\n          );\n\n          if (this.R1()) {\n            this.setReadyStateInternal(ReadyState.ERROR, reason);\n          }\n\n          if (!isBlockedByConsent(reason)) {\n            reportError(reason, this);\n          }\n          throw reason;\n        }\n      ));\n    }\n\n    /**\n     * @return {!Promise}\n     */\n    build() {\n      if (this.buildingPromise_) {\n        return this.buildingPromise_;\n      }\n\n      const readyPromise = this.signals_.whenSignal(\n        CommonSignals.READY_TO_UPGRADE\n      );\n      return readyPromise.then(() => {\n        if (this.R1()) {\n          const scheduler = getSchedulerForDoc(this.getAmpDoc());\n          scheduler.scheduleAsap(this);\n        }\n        return this.whenBuilt();\n      });\n    }\n\n    /**\n     * Mounts the element by calling the `BaseElement.mountCallback` method.\n     *\n     * Can only be called on a upgraded element. May only be called from\n     * scheduler.js.\n     *\n     * @return {!Promise}\n     * @final\n     * @restricted\n     */\n    mountInternal() {\n      if (this.mountPromise_) {\n        return this.mountPromise_;\n      }\n      this.mountAbortController_ =\n        this.mountAbortController_ || new AbortController();\n      const {signal} = this.mountAbortController_;\n      return (this.mountPromise_ = this.buildInternal()\n        .then(() => {\n          devAssert(this.R1());\n          if (signal.aborted) {\n            // Mounting has been canceled.\n            return;\n          }\n          this.setReadyStateInternal(\n            this.readyState_ != ReadyState.MOUNTING\n              ? this.readyState_\n              : this.implClass_.usesLoading(this)\n              ? ReadyState.LOADING\n              : ReadyState.MOUNTING\n          );\n          this.mounted_ = true;\n          const result = this.impl_.mountCallback(signal);\n          // The promise supports the V0 format for easy migration. If the\n          // `mountCallback` returns a promise, the assumption is that the\n          // element has finished loading when the promise completes.\n          return result ? result.then(RETURN_TRUE) : false;\n        })\n        .then((hasLoaded) => {\n          this.mountAbortController_ = null;\n          if (signal.aborted) {\n            throw cancellation();\n          }\n          this.signals_.signal(CommonSignals.MOUNTED);\n          if (!this.implClass_.usesLoading(this) || hasLoaded) {\n            this.setReadyStateInternal(ReadyState.COMPLETE);\n          }\n        })\n        .catch((reason) => {\n          this.mountAbortController_ = null;\n          if (isCancellation(reason)) {\n            this.mountPromise_ = null;\n          } else {\n            this.signals_.rejectSignal(\n              CommonSignals.MOUNTED,\n              /** @type {!Error} */ (reason)\n            );\n            this.setReadyStateInternal(ReadyState.ERROR, reason);\n          }\n          throw reason;\n        }));\n    }\n\n    /**\n     * Requests the element to be mounted as soon as possible.\n     * @return {!Promise}\n     * @final\n     */\n    mount() {\n      if (this.mountPromise_) {\n        return this.mountPromise_;\n      }\n\n      // Create the abort controller right away to ensure that we the unmount\n      // will properly cancel this operation.\n      this.mountAbortController_ =\n        this.mountAbortController_ || new AbortController();\n      const {signal} = this.mountAbortController_;\n\n      const readyPromise = this.signals_.whenSignal(\n        CommonSignals.READY_TO_UPGRADE\n      );\n      return readyPromise.then(() => {\n        if (!this.R1()) {\n          return this.whenBuilt();\n        }\n        if (signal.aborted) {\n          throw cancellation();\n        }\n        const scheduler = getSchedulerForDoc(this.getAmpDoc());\n        scheduler.scheduleAsap(this);\n        return this.whenMounted();\n      });\n    }\n\n    /**\n     * Unmounts the element and makes it ready for the next mounting\n     * operation.\n     * @final\n     */\n    unmount() {\n      // Ensure that the element is paused.\n      if (this.isConnected_) {\n        this.pause();\n      }\n\n      // Legacy R0 elements simply unlayout.\n      if (!this.R1()) {\n        this.unlayout_();\n        return;\n      }\n\n      // Cancel the currently mounting operation.\n      if (this.mountAbortController_) {\n        this.mountAbortController_.abort();\n        this.mountAbortController_ = null;\n      }\n\n      // Unschedule a currently pending mount request.\n      const scheduler = getSchedulerForDoc(this.getAmpDoc());\n      scheduler.unschedule(this);\n\n      // Try to unmount if the element has been built already.\n      if (this.mounted_) {\n        this.impl_.unmountCallback();\n      }\n\n      // Complete unmount and reset the state.\n      this.mounted_ = false;\n      this.mountPromise_ = null;\n      this.reset_();\n\n      // Prepare for the next mount if the element is connected.\n      if (this.isConnected_) {\n        this.upgradeOrSchedule_(/* opt_disablePreload */ true);\n      }\n    }\n\n    /**\n     * Returns the promise that's resolved when the element has been mounted. If\n     * the mount fails, the resulting promise is rejected.\n     * @return {!Promise}\n     */\n    whenMounted() {\n      return this.signals_.whenSignal(CommonSignals.MOUNTED);\n    }\n\n    /**\n     * @return {!Promise}\n     * @final\n     */\n    whenLoaded() {\n      return this.signals_.whenSignal(CommonSignals.LOAD_END);\n    }\n\n    /**\n     * Ensure that the element is eagerly loaded.\n     *\n     * @param {number=} opt_parentPriority\n     * @return {!Promise}\n     * @final\n     */\n    ensureLoaded(opt_parentPriority) {\n      return this.mount().then(() => {\n        if (this.R1()) {\n          if (this.implClass_.usesLoading(this)) {\n            this.impl_.ensureLoaded();\n          }\n          return this.whenLoaded();\n        }\n\n        // Very ugly! The \"built\" signal must be resolved from the Resource\n        // and not the element itself because the Resource has not correctly\n        // set its state for the downstream to process it correctly.\n        const resource = this.getResource_();\n        return resource.whenBuilt().then(() => {\n          if (resource.getState() == ResourceState.LAYOUT_COMPLETE) {\n            return;\n          }\n          if (\n            resource.getState() != ResourceState.LAYOUT_SCHEDULED ||\n            resource.isMeasureRequested()\n          ) {\n            resource.measure();\n          }\n          if (!resource.isDisplayed()) {\n            return;\n          }\n          this.getResources().scheduleLayoutOrPreload(\n            resource,\n            /* layout */ true,\n            opt_parentPriority,\n            /* forceOutsideViewport */ true\n          );\n          return this.whenLoaded();\n        });\n      });\n    }\n\n    /**\n     * See `BaseElement.setAsContainer`.\n     *\n     * @param {!Element=} opt_scroller A child of the container that should be\n     * monitored. Typically a scrollable element.\n     * @restricted\n     * @final\n     */\n    setAsContainerInternal(opt_scroller) {\n      const builder = getSchedulerForDoc(this.getAmpDoc());\n      builder.setContainer(this, opt_scroller);\n    }\n\n    /**\n     * See `BaseElement.removeAsContainer`.\n     * @restricted\n     * @final\n     */\n    removeAsContainerInternal() {\n      const builder = getSchedulerForDoc(this.getAmpDoc());\n      builder.removeContainer(this);\n    }\n\n    /**\n     * Update the internal ready state.\n     *\n     * @param {!ReadyState} state\n     * @param {*=} opt_failure\n     * @protected\n     * @final\n     */\n    setReadyStateInternal(state, opt_failure) {\n      if (state === this.readyState_) {\n        return;\n      }\n\n      this.readyState_ = state;\n\n      if (!this.R1()) {\n        return;\n      }\n\n      switch (state) {\n        case ReadyState.LOADING:\n          this.signals_.signal(CommonSignals.LOAD_START);\n          this.signals_.reset(CommonSignals.UNLOAD);\n          this.signals_.reset(CommonSignals.LOAD_END);\n          this.classList.add('i-amphtml-layout');\n          // Potentially start the loading indicator.\n          this.toggleLoading(true);\n          this.dispatchCustomEventForTesting(AmpEvents.LOAD_START);\n          return;\n        case ReadyState.COMPLETE:\n          // LOAD_START is set just in case. It won't be overwritten if\n          // it had been set before.\n          this.signals_.signal(CommonSignals.LOAD_START);\n          this.signals_.signal(CommonSignals.LOAD_END);\n          this.signals_.reset(CommonSignals.UNLOAD);\n          this.classList.add('i-amphtml-layout');\n          this.toggleLoading(false);\n          dom.dispatchCustomEvent(this, 'load', null, NO_BUBBLES);\n          this.dispatchCustomEventForTesting(AmpEvents.LOAD_END);\n          return;\n        case ReadyState.ERROR:\n          this.signals_.rejectSignal(\n            CommonSignals.LOAD_END,\n            /** @type {!Error} */ (opt_failure)\n          );\n          this.toggleLoading(false);\n          dom.dispatchCustomEvent(this, 'error', opt_failure, NO_BUBBLES);\n          return;\n      }\n    }\n\n    /**\n     * Called to instruct the element to preconnect to hosts it uses during\n     * layout.\n     * @param {boolean} onLayout Whether this was called after a layout.\n     * TODO(#31915): remove once R1 migration is complete.\n     */\n    preconnect(onLayout) {\n      devAssert(this.isUpgraded());\n      if (onLayout) {\n        this.impl_.preconnectCallback(onLayout);\n      } else {\n        // If we do early preconnects we delay them a bit. This is kind of\n        // an unfortunate trade off, but it seems faster, because the DOM\n        // operations themselves are not free and might delay\n        startupChunk(this.getAmpDoc(), () => {\n          if (!this.ownerDocument || !this.ownerDocument.defaultView) {\n            return;\n          }\n          this.impl_.preconnectCallback(onLayout);\n        });\n      }\n    }\n\n    /**\n     * See `BaseElement.R1()`.\n     *\n     * @return {boolean}\n     * @final\n     */\n    R1() {\n      return this.implClass_ ? this.implClass_.R1() : false;\n    }\n\n    /**\n     * See `BaseElement.deferredMount()`.\n     *\n     * @return {boolean}\n     * @final\n     */\n    deferredMount() {\n      return this.implClass_ ? this.implClass_.deferredMount(this) : false;\n    }\n\n    /**\n     * Whether the custom element declares that it has to be fixed.\n     * @return {boolean}\n     */\n    isAlwaysFixed() {\n      return this.impl_ ? this.impl_.isAlwaysFixed() : false;\n    }\n\n    /**\n     * Updates the layout box of the element.\n     * Should only be called by Resources.\n     * @param {!./layout-rect.LayoutRectDef} layoutBox\n     * @param {boolean} sizeChanged\n     */\n    updateLayoutBox(layoutBox, sizeChanged = false) {\n      if (this.isBuilt()) {\n        this.onMeasure(sizeChanged);\n      }\n    }\n\n    /**\n     * Calls onLayoutMeasure() on the BaseElement implementation.\n     * Should only be called by Resources.\n     */\n    onMeasure() {\n      devAssert(this.isBuilt());\n      try {\n        this.impl_.onLayoutMeasure();\n      } catch (e) {\n        reportError(e, this);\n      }\n    }\n\n    /**\n     * @return {?Element}\n     * @private\n     */\n    getSizer_() {\n      if (\n        this.sizerElement === undefined &&\n        (this.layout_ === Layout.RESPONSIVE ||\n          this.layout_ === Layout.INTRINSIC)\n      ) {\n        // Expect sizer to exist, just not yet discovered.\n        this.sizerElement = this.querySelector('i-amphtml-sizer');\n      }\n      return this.sizerElement || null;\n    }\n\n    /**\n     * @param {Element} sizer\n     * @private\n     */\n    resetSizer_(sizer) {\n      if (this.layout_ === Layout.RESPONSIVE) {\n        setStyle(sizer, 'paddingTop', '0');\n        return;\n      }\n      if (this.layout_ === Layout.INTRINSIC) {\n        const intrinsicSizerImg = sizer.querySelector(\n          '.i-amphtml-intrinsic-sizer'\n        );\n        if (!intrinsicSizerImg) {\n          return;\n        }\n        intrinsicSizerImg.setAttribute('src', '');\n        return;\n      }\n    }\n\n    /** @private */\n    initMediaAttrs_() {\n      const hasMediaAttrs =\n        this.hasAttribute('media') ||\n        (this.hasAttribute('sizes') &&\n          !this.hasAttribute('disable-inline-width')) ||\n        this.hasAttribute('heights');\n      const hadMediaAttrs = !!this.mediaQueryProps_;\n      const win = this.ownerDocument.defaultView;\n      if (hasMediaAttrs != hadMediaAttrs && win) {\n        if (hasMediaAttrs) {\n          this.mediaQueryProps_ = new MediaQueryProps(win, () =>\n            this.applyMediaAttrs_()\n          );\n          this.applyMediaAttrs_();\n        } else {\n          this.disposeMediaAttrs_();\n        }\n      }\n    }\n\n    /** @private */\n    disposeMediaAttrs_() {\n      if (this.mediaQueryProps_) {\n        this.mediaQueryProps_.dispose();\n        this.mediaQueryProps_ = null;\n      }\n    }\n\n    /** @private */\n    applyMediaAttrs_() {\n      const props = this.mediaQueryProps_;\n      if (!props) {\n        return;\n      }\n\n      props.start();\n\n      // Media query.\n      const mediaAttr = this.getAttribute('media') || null;\n      const matchesMedia = mediaAttr\n        ? props.resolveMatchQuery(mediaAttr)\n        : true;\n      this.classList.toggle('i-amphtml-hidden-by-media-query', !matchesMedia);\n\n      // Sizes.\n      const sizesAttr = this.hasAttribute('disable-inline-width')\n        ? null\n        : this.getAttribute('sizes');\n      if (sizesAttr) {\n        setStyle(this, 'width', props.resolveListQuery(sizesAttr));\n      }\n\n      // Heights.\n      const heightsAttr =\n        this.layout_ === Layout.RESPONSIVE\n          ? this.getAttribute('heights')\n          : null;\n      if (heightsAttr) {\n        const sizer = this.getSizer_();\n        if (sizer) {\n          setStyle(sizer, 'paddingTop', props.resolveListQuery(heightsAttr));\n        }\n      }\n\n      props.complete();\n      this.getResource_().requestMeasure();\n    }\n\n    /**\n     * Applies a size change to the element.\n     *\n     * This method is called by Resources and shouldn't be called by anyone\n     * else. This method must always be called in the mutation context.\n     *\n     * @param {number|undefined} newHeight\n     * @param {number|undefined} newWidth\n     * @param {!./layout-rect.LayoutMarginsDef=} opt_newMargins\n     * @final\n     * @package\n     */\n    applySize(newHeight, newWidth, opt_newMargins) {\n      const sizer = this.getSizer_();\n      if (sizer) {\n        // From the moment height is changed the element becomes fully\n        // responsible for managing its height. Aspect ratio is no longer\n        // preserved.\n        this.sizerElement = null;\n        this.resetSizer_(sizer);\n        this.mutateOrInvoke_(() => {\n          if (sizer) {\n            dom.removeElement(sizer);\n          }\n        });\n      }\n      if (newHeight !== undefined) {\n        setStyle(this, 'height', newHeight, 'px');\n      }\n      if (newWidth !== undefined) {\n        setStyle(this, 'width', newWidth, 'px');\n      }\n      if (opt_newMargins) {\n        if (opt_newMargins.top != null) {\n          setStyle(this, 'marginTop', opt_newMargins.top, 'px');\n        }\n        if (opt_newMargins.right != null) {\n          setStyle(this, 'marginRight', opt_newMargins.right, 'px');\n        }\n        if (opt_newMargins.bottom != null) {\n          setStyle(this, 'marginBottom', opt_newMargins.bottom, 'px');\n        }\n        if (opt_newMargins.left != null) {\n          setStyle(this, 'marginLeft', opt_newMargins.left, 'px');\n        }\n      }\n      if (this.isAwaitingSize_()) {\n        this.sizeProvided_();\n      }\n      dom.dispatchCustomEvent(this, AmpEvents.SIZE_CHANGED);\n    }\n\n    /**\n     * Called when the element is first connected to the DOM.\n     *\n     * This callback is guarded by checks to see if the element is still\n     * connected.  Chrome and Safari can trigger connectedCallback even when\n     * the node is disconnected. See #12849, https://crbug.com/821195, and\n     * https://bugs.webkit.org/show_bug.cgi?id=180940. Thankfully,\n     * connectedCallback will later be called when the disconnected root is\n     * connected to the document tree.\n     *\n     * @final\n     */\n    connectedCallback() {\n      if (!isTemplateTagSupported() && this.isInTemplate_ === undefined) {\n        this.isInTemplate_ = !!query.closestAncestorElementBySelector(\n          this,\n          'template'\n        );\n      }\n      if (this.isInTemplate_) {\n        return;\n      }\n\n      if (this.isConnected_ || !dom.isConnectedNode(this)) {\n        return;\n      }\n      this.isConnected_ = true;\n\n      if (!this.everAttached) {\n        this.classList.add('i-amphtml-element');\n        this.classList.add('i-amphtml-notbuilt');\n        this.classList.add('amp-notbuilt');\n      }\n\n      if (!this.ampdoc_) {\n        // Ampdoc can now be initialized.\n        const win = toWin(this.ownerDocument.defaultView);\n        const ampdocService = Services.ampdocServiceFor(win);\n        const ampdoc = ampdocService.getAmpDoc(this);\n        this.ampdoc_ = ampdoc;\n        elementConnectedCallback(ampdoc, this, this.implClass_);\n      }\n      if (!this.resources_) {\n        // Resources can now be initialized since the ampdoc is now available.\n        this.resources_ = Services.resourcesForDoc(this.ampdoc_);\n      }\n      this.getResources().add(this);\n\n      if (this.everAttached) {\n        const reconstruct = this.reconstructWhenReparented();\n        if (reconstruct) {\n          this.reset_();\n        }\n        if (this.isUpgraded()) {\n          if (reconstruct && !this.R1()) {\n            this.getResources().upgraded(this);\n          }\n          this.connected_();\n          this.dispatchCustomEventForTesting(AmpEvents.ATTACHED);\n        }\n        if (this.implClass_ && this.R1()) {\n          this.upgradeOrSchedule_();\n        }\n      } else {\n        this.everAttached = true;\n\n        try {\n          this.layout_ = applyStaticLayout(\n            this,\n            Services.platformFor(toWin(this.ownerDocument.defaultView)).isIe()\n          );\n          this.initMediaAttrs_();\n        } catch (e) {\n          reportError(e, this);\n        }\n        if (this.implClass_) {\n          this.upgradeOrSchedule_();\n        }\n        if (!this.isUpgraded()) {\n          this.classList.add('amp-unresolved');\n          this.classList.add('i-amphtml-unresolved');\n          this.dispatchCustomEventForTesting(AmpEvents.STUBBED);\n        }\n      }\n\n      this.toggleLoading(true);\n    }\n\n    /**\n     * @return {boolean}\n     * @private\n     */\n    isAwaitingSize_() {\n      return this.classList.contains('i-amphtml-layout-awaiting-size');\n    }\n\n    /**\n     * @private\n     */\n    sizeProvided_() {\n      this.classList.remove('i-amphtml-layout-awaiting-size');\n    }\n\n    /**\n     * Upgrade or schedule element based on R1.\n     * @param {boolean=} opt_disablePreload\n     * @private @final\n     */\n    upgradeOrSchedule_(opt_disablePreload) {\n      if (!this.R1()) {\n        this.tryUpgrade_();\n        return;\n      }\n\n      if (this.mountPromise_) {\n        // Already mounting.\n        return;\n      }\n\n      // Schedule build and mount.\n      const scheduler = getSchedulerForDoc(this.getAmpDoc());\n      scheduler.schedule(this);\n\n      if (this.buildingPromise_) {\n        // Already built or building: just needs to be mounted.\n        this.setReadyStateInternal(\n          this.implClass_ && this.implClass_.usesLoading(this)\n            ? ReadyState.LOADING\n            : ReadyState.MOUNTING\n        );\n      } else {\n        // Not built yet: execute prebuild steps.\n        this.setReadyStateInternal(ReadyState.BUILDING);\n\n        // Schedule preconnects.\n        if (!opt_disablePreload) {\n          const urls = this.implClass_.getPreconnects(this);\n          if (urls && urls.length > 0) {\n            // If we do early preconnects we delay them a bit. This is kind of\n            // an unfortunate trade off, but it seems faster, because the DOM\n            // operations themselves are not free and might delay\n            const ampdoc = this.getAmpDoc();\n            startupChunk(ampdoc, () => {\n              const {win} = ampdoc;\n              if (!win) {\n                return;\n              }\n              const preconnect = Services.preconnectFor(win);\n              urls.forEach((url) =>\n                preconnect.url(ampdoc, url, /* alsoConnecting */ false)\n              );\n            });\n          }\n        }\n      }\n    }\n\n    /**\n     * Try to upgrade the element with the provided implementation.\n     * @return {!Promise|undefined}\n     * @private @final\n     */\n    tryUpgrade_() {\n      if (this.isInTemplate_) {\n        return;\n      }\n      if (this.upgradeState_ != UpgradeState.NOT_UPGRADED) {\n        // Already upgraded or in progress or failed.\n        return;\n      }\n\n      const Ctor = devAssert(\n        this.implClass_,\n        'Implementation must not be a stub'\n      );\n\n      const impl = new Ctor(this);\n\n      // The `upgradeCallback` only allows redirect once for the top-level\n      // non-stub class. We may allow nested upgrades later, but they will\n      // certainly be bad for performance.\n      this.upgradeState_ = UpgradeState.UPGRADE_IN_PROGRESS;\n      const startTime = win.Date.now();\n      const res = impl.upgradeCallback();\n      if (!res) {\n        // Nothing returned: the current object is the upgraded version.\n        this.completeUpgrade_(impl, startTime);\n      } else if (typeof res.then == 'function') {\n        // It's a promise: wait until it's done.\n        return res\n          .then((upgrade) => {\n            this.completeUpgrade_(upgrade || impl, startTime);\n          })\n          .catch((reason) => {\n            this.upgradeState_ = UpgradeState.UPGRADE_FAILED;\n            rethrowAsync(reason);\n          });\n      } else {\n        // It's an actual instance: upgrade immediately.\n        this.completeUpgrade_(\n          /** @type {!./base-element.BaseElement} */ (res),\n          startTime\n        );\n      }\n    }\n\n    /**\n     * Called when the element is disconnected from the DOM.\n     *\n     * @final\n     */\n    disconnectedCallback() {\n      this.disconnect(/* pretendDisconnected */ false);\n    }\n\n    /** @private */\n    connected_() {\n      if (this.built_) {\n        this.impl_.attachedCallback();\n      }\n    }\n\n    /**\n     * Called when an element is disconnected from DOM, or when an ampDoc is\n     * being disconnected (the element itself may still be connected to ampDoc).\n     *\n     * This callback is guarded by checks to see if the element is still\n     * connected. See #12849, https://crbug.com/821195, and\n     * https://bugs.webkit.org/show_bug.cgi?id=180940.\n     * If the element is still connected to the document, you'll need to pass\n     * opt_pretendDisconnected.\n     *\n     * @param {boolean} pretendDisconnected Forces disconnection regardless\n     *     of DOM isConnected.\n     */\n    disconnect(pretendDisconnected) {\n      if (this.isInTemplate_ || !this.isConnected_) {\n        return;\n      }\n      if (!pretendDisconnected && dom.isConnectedNode(this)) {\n        return;\n      }\n\n      // This path only comes from Resource#disconnect, which deletes the\n      // Resource instance tied to this element. Therefore, it is no longer\n      // an AMP Element. But, DOM queries for i-amphtml-element assume that\n      // the element is tied to a Resource.\n      if (pretendDisconnected) {\n        this.classList.remove('i-amphtml-element');\n      }\n\n      this.isConnected_ = false;\n      this.getResources().remove(this);\n      if (this.impl_) {\n        this.impl_.detachedCallback();\n      }\n      if (this.R1()) {\n        this.unmount();\n      }\n      this.toggleLoading(false);\n      this.disposeMediaAttrs_();\n    }\n\n    /**\n     * Dispatches a custom event only in testing environment.\n     *\n     * @param {string} name\n     * @param {!Object=} opt_data Event data.\n     * @final\n     */\n    dispatchCustomEventForTesting(name, opt_data) {\n      if (!getMode().test) {\n        return;\n      }\n      dom.dispatchCustomEvent(this, name, opt_data);\n    }\n\n    /**\n     * Whether the element can pre-render.\n     * @return {boolean}\n     * @final\n     */\n    prerenderAllowed() {\n      if (this.hasAttribute('noprerender')) {\n        return false;\n      }\n      return this.implClass_ ? this.implClass_.prerenderAllowed(this) : false;\n    }\n\n    /**\n     * Whether the element has render-blocking service.\n     * @return {boolean}\n     * @final\n     */\n    isBuildRenderBlocking() {\n      return this.impl_ ? this.impl_.isBuildRenderBlocking() : false;\n    }\n\n    /**\n     * Creates a placeholder for the element.\n     * @return {?Element}\n     * @final\n     */\n    createPlaceholder() {\n      return this.impl_ ? this.impl_.createPlaceholderCallback() : null;\n    }\n\n    /**\n     * Creates a loader logo.\n     * @return {{\n     *  content: (!Element|undefined),\n     *  color: (string|undefined),\n     * }}\n     * @final\n     */\n    createLoaderLogo() {\n      return this.implClass_\n        ? this.implClass_.createLoaderLogoCallback(this)\n        : {};\n    }\n\n    /**\n     * Whether the element should ever render when it is not in viewport.\n     * @return {boolean|number}\n     * @final\n     */\n    renderOutsideViewport() {\n      return this.impl_ ? this.impl_.renderOutsideViewport() : false;\n    }\n\n    /**\n     * Whether the element should render outside of renderOutsideViewport when\n     * the scheduler is idle.\n     * @return {boolean|number}\n     * @final\n     */\n    idleRenderOutsideViewport() {\n      return this.impl_ ? this.impl_.idleRenderOutsideViewport() : false;\n    }\n\n    /**\n     * Returns a previously measured layout box adjusted to the viewport. This\n     * mainly affects fixed-position elements that are adjusted to be always\n     * relative to the document position in the viewport.\n     * @return {!./layout-rect.LayoutRectDef}\n     * @final\n     */\n    getLayoutBox() {\n      return this.getResource_().getLayoutBox();\n    }\n\n    /**\n     * Returns a previously measured layout size.\n     * @return {!./layout-rect.LayoutSizeDef}\n     * @final\n     */\n    getLayoutSize() {\n      return this.getResource_().getLayoutSize();\n    }\n\n    /**\n     * @return {?Element}\n     * @final\n     */\n    getOwner() {\n      return this.getResource_().getOwner();\n    }\n\n    /**\n     * Returns a change entry for that should be compatible with\n     * IntersectionObserverEntry.\n     * @return {?IntersectionObserverEntry} A change entry.\n     * @final\n     */\n    getIntersectionChangeEntry() {\n      const box = this.impl_\n        ? this.impl_.getIntersectionElementLayoutBox()\n        : this.getLayoutBox();\n      const owner = this.getOwner();\n      const viewport = Services.viewportForDoc(this.getAmpDoc());\n      const viewportBox = viewport.getRect();\n      // TODO(jridgewell, #4826): We may need to make this recursive.\n      const ownerBox = owner && owner.getLayoutBox();\n      return getIntersectionChangeEntry(box, ownerBox, viewportBox);\n    }\n\n    /**\n     * Returns the resource of the element.\n     * @return {!./service/resource.Resource}\n     * @private\n     */\n    getResource_() {\n      return this.getResources().getResourceForElement(this);\n    }\n\n    /**\n     * Returns the resource ID of the element.\n     * @return {number}\n     */\n    getResourceId() {\n      return this.getResource_().getId();\n    }\n\n    /**\n     * The runtime calls this method to determine if {@link layoutCallback}\n     * should be called again when layout changes.\n     * @return {boolean}\n     * @package @final\n     * TODO(#31915): remove once R1 migration is complete.\n     */\n    isRelayoutNeeded() {\n      return this.impl_ ? this.impl_.isRelayoutNeeded() : false;\n    }\n\n    /**\n     * Returns reference to upgraded implementation.\n     * @param {boolean} waitForBuild If true, waits for element to be built before\n     *   resolving the returned Promise. Default is true.\n     * @return {!Promise<!./base-element.BaseElement>}\n     */\n    getImpl(waitForBuild = true) {\n      const waitFor = waitForBuild ? this.build() : this.createImpl_();\n      return waitFor.then(() => this.impl_);\n    }\n\n    /**\n     * @return {!Promise<!./base-element.BaseElement>}\n     * @private\n     */\n    createImpl_() {\n      return this.signals_\n        .whenSignal(CommonSignals.READY_TO_UPGRADE)\n        .then(() => {\n          this.tryUpgrade_();\n          return this.whenUpgraded();\n        });\n    }\n\n    /**\n     * Returns the object which holds the API surface (the thing we add the\n     * custom methods/properties onto). In Bento, this is the imperative API\n     * object. In AMP, this is the BaseElement instance.\n     *\n     * @return {!Promise<!Object>}\n     */\n    getApi() {\n      return this.getImpl().then((impl) => impl.getApi());\n    }\n\n    /**\n     * Returns the layout of the element.\n     * @return {!Layout}\n     */\n    getLayout() {\n      return this.layout_;\n    }\n\n    /**\n     * Instructs the element to layout its content and load its resources if\n     * necessary by calling the {@link BaseElement.layoutCallback} method that\n     * should be implemented by BaseElement subclasses. Must return a promise\n     * that will yield when the layout and associated loadings are complete.\n     *\n     * This method is always called for the first layout, but for subsequent\n     * layouts the runtime consults {@link isRelayoutNeeded} method.\n     *\n     * Can only be called on a upgraded and built element.\n     *\n     * @param {!AbortSignal} signal\n     * @return {!Promise}\n     * @package @final\n     * TODO(#31915): remove once R1 migration is complete.\n     */\n    layoutCallback(signal) {\n      assertNotTemplate(this);\n      devAssert(this.isBuilt(), 'Must be built to receive viewport events');\n      // A lot of tests call layoutCallback manually, and don't pass a signal.\n      if ((!getMode().test || signal) && signal.aborted) {\n        return Promise.reject(cancellation());\n      }\n\n      this.dispatchCustomEventForTesting(AmpEvents.LOAD_START);\n      const isLoadEvent = this.layoutCount_ == 0; // First layout is \"load\".\n      this.signals_.reset(CommonSignals.UNLOAD);\n      if (isLoadEvent) {\n        this.signals_.signal(CommonSignals.LOAD_START);\n      }\n\n      // Potentially start the loading indicator.\n      this.toggleLoading(true);\n\n      const promise = tryResolve(() => this.impl_.layoutCallback());\n      this.preconnect(/* onLayout */ true);\n      this.classList.add('i-amphtml-layout');\n\n      return promise.then(\n        () => {\n          if ((!getMode().test || signal) && signal.aborted) {\n            throw cancellation();\n          }\n          if (isLoadEvent) {\n            this.signals_.signal(CommonSignals.LOAD_END);\n          }\n          this.setReadyStateInternal(ReadyState.COMPLETE);\n          this.layoutCount_++;\n          this.toggleLoading(false);\n          // Check if this is the first success layout that needs\n          // to call firstLayoutCompleted.\n          if (!this.isFirstLayoutCompleted_) {\n            this.impl_.firstLayoutCompleted();\n            this.isFirstLayoutCompleted_ = true;\n            this.dispatchCustomEventForTesting(AmpEvents.LOAD_END);\n          }\n        },\n        (reason) => {\n          if ((!getMode().test || signal) && signal.aborted) {\n            throw cancellation();\n          }\n          // add layoutCount_ by 1 despite load fails or not\n          if (isLoadEvent) {\n            this.signals_.rejectSignal(\n              CommonSignals.LOAD_END,\n              /** @type {!Error} */ (reason)\n            );\n          }\n          this.setReadyStateInternal(ReadyState.ERROR, reason);\n          this.layoutCount_++;\n          this.toggleLoading(false);\n          throw reason;\n        }\n      );\n    }\n\n    /**\n     * Pauses the element.\n     *\n     * @package @final\n     */\n    pause() {\n      if (!this.isBuilt()) {\n        // Not built yet.\n        return;\n      }\n\n      this.impl_.pauseCallback();\n\n      // Legacy unlayoutOnPause support.\n      if (!this.R1() && this.impl_.unlayoutOnPause()) {\n        this.unlayout_();\n      }\n    }\n\n    /**\n     * Requests the resource to resume its activity when the document returns\n     * from an inactive state. The scope is up to the actual component. Among\n     * other things the active playback of video or audio content may be\n     * resumed.\n     *\n     * @package @final\n     */\n    resume() {\n      if (!this.isBuilt()) {\n        return;\n      }\n      this.impl_.resumeCallback();\n    }\n\n    /**\n     * Requests the element to unload any expensive resources when the element\n     * goes into non-visible state. The scope is up to the actual component.\n     *\n     * Calling this method on unbuilt or unupgraded element has no effect.\n     *\n     * @return {boolean}\n     * @package @final\n     * TODO(#31915): remove once R1 migration is complete.\n     */\n    unlayoutCallback() {\n      assertNotTemplate(this);\n      if (!this.isBuilt()) {\n        return false;\n      }\n      this.signals_.signal(CommonSignals.UNLOAD);\n      const isReLayoutNeeded = this.impl_.unlayoutCallback();\n      if (isReLayoutNeeded) {\n        this.reset_();\n      }\n      this.dispatchCustomEventForTesting(AmpEvents.UNLOAD);\n      return isReLayoutNeeded;\n    }\n\n    /** @private */\n    unlayout_() {\n      this.getResource_().unlayout();\n      if (this.isConnected_ && this.resources_) {\n        this.resources_./*OK*/ schedulePass();\n      }\n    }\n\n    /** @private */\n    reset_() {\n      this.layoutCount_ = 0;\n      this.isFirstLayoutCompleted_ = false;\n      this.signals_.reset(CommonSignals.MOUNTED);\n      this.signals_.reset(CommonSignals.RENDER_START);\n      this.signals_.reset(CommonSignals.LOAD_START);\n      this.signals_.reset(CommonSignals.LOAD_END);\n      this.signals_.reset(CommonSignals.INI_LOAD);\n    }\n\n    /**\n     * Whether the element needs to be reconstructed after it has been\n     * re-parented. Many elements cannot survive fully the reparenting and\n     * are better to be reconstructed from scratch.\n     *\n     * @return {boolean}\n     * @package @final\n     */\n    reconstructWhenReparented() {\n      return this.impl_ ? this.impl_.reconstructWhenReparented() : false;\n    }\n\n    /**\n     * Collapses the element, and notifies its owner (if there is one) that the\n     * element is no longer present.\n     */\n    collapse() {\n      if (this.impl_) {\n        this.impl_./*OK*/ collapse();\n      }\n    }\n\n    /**\n     * Called every time an owned AmpElement collapses itself.\n     * @param {!AmpElement} element\n     */\n    collapsedCallback(element) {\n      if (this.impl_) {\n        this.impl_.collapsedCallback(element);\n      }\n    }\n\n    /**\n     * Expands the element, and notifies its owner (if there is one) that the\n     * element is now present.\n     */\n    expand() {\n      if (this.impl_) {\n        this.impl_./*OK*/ expand();\n      }\n    }\n\n    /**\n     * Called when one or more attributes are mutated.\n     * Note: Must be called inside a mutate context.\n     * Note: Boolean attributes have a value of `true` and `false` when\n     *     present and missing, respectively.\n     * @param {!JsonObject<string, (null|boolean|string|number|Array|Object)>} mutations\n     */\n    mutatedAttributesCallback(mutations) {\n      if (this.impl_) {\n        this.impl_.mutatedAttributesCallback(mutations);\n      }\n    }\n\n    /**\n     * Enqueues the action with the element. If element has been upgraded and\n     * built, the action is dispatched to the implementation right away.\n     * Otherwise the invocation is enqueued until the implementation is ready\n     * to receive actions.\n     * @param {!./service/action-impl.ActionInvocation} invocation\n     * @final\n     */\n    enqueAction(invocation) {\n      assertNotTemplate(this);\n      if (!this.isBuilt()) {\n        if (this.actionQueue_ === undefined) {\n          this.actionQueue_ = [];\n        }\n        devAssert(this.actionQueue_).push(invocation);\n        // Schedule build sooner.\n        this.build();\n      } else {\n        this.executionAction_(invocation, false);\n      }\n    }\n\n    /**\n     * Dequeues events from the queue and dispatches them to the implementation\n     * with \"deferred\" flag.\n     * @private\n     */\n    dequeueActions_() {\n      if (!this.actionQueue_) {\n        return;\n      }\n\n      const actionQueue = devAssert(this.actionQueue_);\n      this.actionQueue_ = null;\n\n      // Notice, the actions are currently not de-duped.\n      actionQueue.forEach((invocation) => {\n        this.executionAction_(invocation, true);\n      });\n    }\n\n    /**\n     * Executes the action immediately. All errors are consumed and reported.\n     * @param {!./service/action-impl.ActionInvocation} invocation\n     * @param {boolean} deferred\n     * @final\n     * @private\n     */\n    executionAction_(invocation, deferred) {\n      try {\n        this.impl_.executeAction(invocation, deferred);\n      } catch (e) {\n        rethrowAsync(\n          'Action execution failed:',\n          e,\n          invocation.node.tagName,\n          invocation.method\n        );\n      }\n    }\n\n    /**\n     * Get the consent policy to follow.\n     * @return {?string}\n     */\n    getConsentPolicy_() {\n      let policyId = this.getAttribute('data-block-on-consent');\n      if (policyId === null) {\n        if (shouldBlockOnConsentByMeta(this)) {\n          policyId = 'default';\n          this.setAttribute('data-block-on-consent', policyId);\n        } else {\n          // data-block-on-consent attribute not set\n          return null;\n        }\n      }\n      if (policyId == '' || policyId == 'default') {\n        // data-block-on-consent value not set, up to individual element\n        // Note: data-block-on-consent and data-block-on-consent='default' is\n        // treated exactly the same\n        return devAssert(this.impl_).getConsentPolicy();\n      }\n      return policyId;\n    }\n\n    /**\n     * Get the purpose consents that should be granted.\n     * @return {Array<string>|undefined}\n     */\n    getPurposesConsent_() {\n      const purposes =\n        this.getAttribute('data-block-on-consent-purposes') || null;\n      return purposes?.replace(/\\s+/g, '')?.split(',');\n    }\n\n    /**\n     * Returns the original nodes of the custom element without any service\n     * nodes that could have been added for markup. These nodes can include\n     * Text, Comment and other child nodes.\n     * @return {!Array<!Node>}\n     * @package @final\n     */\n    getRealChildNodes() {\n      return query.childNodes(this, (node) => !isInternalOrServiceNode(node));\n    }\n\n    /**\n     * Returns the original children of the custom element without any service\n     * nodes that could have been added for markup.\n     * @return {!Array<!Element>}\n     * @package @final\n     */\n    getRealChildren() {\n      return query.childElements(\n        this,\n        (element) => !isInternalOrServiceNode(element)\n      );\n    }\n\n    /**\n     * Returns an optional placeholder element for this custom element.\n     * @return {?Element}\n     * @package @final\n     */\n    getPlaceholder() {\n      return query.lastChildElement(this, (el) => {\n        return (\n          el.hasAttribute('placeholder') &&\n          // Denylist elements that has a native placeholder property\n          // like input and textarea. These are not allowed to be AMP\n          // placeholders.\n          !isInputPlaceholder(el)\n        );\n      });\n    }\n\n    /**\n     * Hides or shows the placeholder, if available.\n     * @param {boolean} show\n     * @package @final\n     */\n    togglePlaceholder(show) {\n      assertNotTemplate(this);\n      if (show) {\n        const placeholder = this.getPlaceholder();\n        if (placeholder) {\n          dev().assertElement(placeholder).classList.remove('amp-hidden');\n        }\n      } else {\n        const placeholders = query.childElementsByAttr(this, 'placeholder');\n        for (let i = 0; i < placeholders.length; i++) {\n          // Don't toggle elements with a native placeholder property\n          // e.g. input, textarea\n          if (isInputPlaceholder(placeholders[i])) {\n            continue;\n          }\n          placeholders[i].classList.add('amp-hidden');\n        }\n      }\n    }\n\n    /**\n     * Returns an optional fallback element for this custom element.\n     * @return {?Element}\n     * @package @final\n     */\n    getFallback() {\n      return query.childElementByAttr(this, 'fallback');\n    }\n\n    /**\n     * Hides or shows the fallback, if available. This function must only\n     * be called inside a mutate context.\n     * @param {boolean} show\n     * @package @final\n     */\n    toggleFallback(show) {\n      assertNotTemplate(this);\n      const resourceState = this.getResource_().getState();\n      // Do not show fallback before layout\n      if (\n        !this.R1() &&\n        show &&\n        (resourceState == ResourceState.NOT_BUILT ||\n          resourceState == ResourceState.NOT_LAID_OUT ||\n          resourceState == ResourceState.READY_FOR_LAYOUT)\n      ) {\n        return;\n      }\n      // This implementation is notably less efficient then placeholder\n      // toggling. The reasons for this are: (a) \"not supported\" is the state of\n      // the whole element, (b) some relayout is expected and (c) fallback\n      // condition would be rare.\n      this.classList.toggle('amp-notsupported', show);\n      if (show == true) {\n        const fallbackElement = this.getFallback();\n        if (fallbackElement) {\n          Services.ownersForDoc(this.getAmpDoc()).scheduleLayout(\n            this,\n            fallbackElement\n          );\n        }\n      }\n    }\n\n    /**\n     * An implementation can call this method to signal to the element that\n     * it has started rendering.\n     * @package @final\n     */\n    renderStarted() {\n      this.signals_.signal(CommonSignals.RENDER_START);\n      this.togglePlaceholder(false);\n      this.toggleLoading(false);\n    }\n\n    /**\n     * Whether the loading can be shown for this element.\n     * @param {boolean} force\n     * @return {boolean}\n     * @private\n     */\n    isLoadingEnabled_(force) {\n      // No loading indicator will be shown if either one of these conditions\n      // true:\n      // 1. The document is A4A.\n      // 2. `noloading` attribute is specified;\n      // 3. The element has already been laid out, and does not support reshowing the indicator (include having loading\n      //    error);\n      // 4. The element is too small or has not yet been measured;\n      // 5. The element has not been allowlisted;\n      // 6. The element is an internal node (e.g. `placeholder` or `fallback`);\n      // 7. The element's layout is not nodisplay.\n\n      const laidOut =\n        this.layoutCount_ > 0 || this.signals_.get(CommonSignals.RENDER_START);\n      if (\n        this.layout_ == Layout.NODISPLAY ||\n        this.hasAttribute('noloading') ||\n        (laidOut && !force) ||\n        !isLoadingAllowed(this) ||\n        isInternalOrServiceNode(this)\n      ) {\n        return false;\n      }\n\n      return true;\n    }\n\n    /**\n     * Turns the loading indicator on or off.\n     * @param {boolean} state\n     * @param {boolean=} force\n     * @public @final\n     */\n    toggleLoading(state, force = false) {\n      // TODO(dvoytenko, #9177): cleanup `this.ownerDocument.defaultView`\n      // once investigation is complete. It appears that we get a lot of\n      // errors here once the iframe is destroyed due to timer.\n      if (!this.ownerDocument || !this.ownerDocument.defaultView) {\n        return;\n      }\n\n      const loadingIndicator = Services.loadingIndicatorOrNull(\n        this.getAmpDoc()\n      );\n      if (loadingIndicator) {\n        state = state && this.isLoadingEnabled_(force);\n        if (state) {\n          loadingIndicator.track(this);\n        } else {\n          loadingIndicator.untrack(this);\n        }\n      }\n    }\n\n    /**\n     * Returns an optional overflow element for this custom element.\n     * @return {?Element}\n     */\n    getOverflowElement() {\n      if (this.overflowElement_ === undefined) {\n        this.overflowElement_ = query.childElementByAttr(this, 'overflow');\n        if (this.overflowElement_) {\n          if (!this.overflowElement_.hasAttribute('tabindex')) {\n            this.overflowElement_.setAttribute('tabindex', '0');\n          }\n          if (!this.overflowElement_.hasAttribute('role')) {\n            this.overflowElement_.setAttribute('role', 'button');\n          }\n        }\n      }\n      return this.overflowElement_;\n    }\n\n    /**\n     * Hides or shows the overflow, if available. This function must only\n     * be called inside a mutate context.\n     * @param {boolean} overflown\n     * @param {number|undefined} requestedHeight\n     * @param {number|undefined} requestedWidth\n     * @package @final\n     */\n    overflowCallback(overflown, requestedHeight, requestedWidth) {\n      this.getOverflowElement();\n      if (!this.overflowElement_) {\n        if (overflown && this.warnOnMissingOverflow) {\n          user().warn(\n            TAG,\n            'Cannot resize element and overflow is not available',\n            this\n          );\n        }\n      } else {\n        this.overflowElement_.classList.toggle('amp-visible', overflown);\n\n        if (overflown) {\n          this.overflowElement_.onclick = () => {\n            const mutator = Services.mutatorForDoc(this.getAmpDoc());\n            mutator.forceChangeSize(this, requestedHeight, requestedWidth);\n            mutator.mutateElement(this, () => {\n              this.overflowCallback(\n                /* overflown */ false,\n                requestedHeight,\n                requestedWidth\n              );\n            });\n          };\n        } else {\n          this.overflowElement_.onclick = null;\n        }\n      }\n    }\n\n    /**\n     * Mutates the element using resources if available.\n     *\n     * @param {function()} mutator\n     * @param {?Element=} opt_element\n     * @param {boolean=} opt_skipRemeasure\n     */\n    mutateOrInvoke_(mutator, opt_element, opt_skipRemeasure = false) {\n      if (this.ampdoc_) {\n        Services.mutatorForDoc(this.getAmpDoc()).mutateElement(\n          opt_element || this,\n          mutator,\n          opt_skipRemeasure\n        );\n      } else {\n        mutator();\n      }\n    }\n  }\n  win.__AMP_BASE_CE_CLASS = BaseCustomElement;\n  return /** @type {typeof HTMLElement} */ (win.__AMP_BASE_CE_CLASS);\n}\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nfunction isInputPlaceholder(element) {\n  return 'placeholder' in element;\n}\n\n/** @param {!Element} element */\nfunction assertNotTemplate(element) {\n  devAssert(!element.isInTemplate_, 'Must never be called in template');\n}\n\n/**\n * Returns \"true\" for internal AMP nodes or for placeholder elements.\n * @param {!Node} node\n * @return {boolean}\n */\nfunction isInternalOrServiceNode(node) {\n  if (isInternalElement(node)) {\n    return true;\n  }\n  if (\n    node.tagName &&\n    (node.hasAttribute('placeholder') ||\n      node.hasAttribute('fallback') ||\n      node.hasAttribute('overflow'))\n  ) {\n    return true;\n  }\n  return false;\n}\n\n/**\n * Creates a new custom element class prototype.\n *\n * @param {!Window} win The window in which to register the custom element.\n * @param {(typeof ./base-element.BaseElement)=} opt_implementationClass For testing only.\n * @param {function(!./service/ampdoc-impl.AmpDoc, !AmpElement, ?(typeof BaseElement))=} opt_elementConnectedCallback\n * @return {!Object} Prototype of element.\n * @visibleForTesting\n */\nexport function createAmpElementForTesting(\n  win,\n  opt_implementationClass,\n  opt_elementConnectedCallback\n) {\n  const Element = createCustomElementClass(\n    win,\n    opt_elementConnectedCallback || (() => {})\n  );\n  if (getMode().test && opt_implementationClass) {\n    Element.prototype.implementationClassForTesting = opt_implementationClass;\n  }\n  return Element;\n}\n\n/**\n * @visibleForTesting\n */\nexport function resetStubsForTesting() {\n  stubbedElements.length = 0;\n}\n\n/**\n * @param {!AmpElement} element\n * @return {?(typeof BaseElement)}\n * @visibleForTesting\n */\nexport function getImplClassSyncForTesting(element) {\n  return element.implClass_;\n}\n\n/**\n * @param {!AmpElement} element\n * @return {!BaseElement}\n * @visibleForTesting\n */\nexport function getImplSyncForTesting(element) {\n  return element.impl_;\n}\n\n/**\n * @param {!AmpElement} element\n * @return {?Array<!./service/action-impl.ActionInvocation>|undefined}\n * @visibleForTesting\n */\nexport function getActionQueueForTesting(element) {\n  return element.actionQueue_;\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ElementStub} from '../element-stub';\nimport {Services} from '../services';\nimport {createCustomElementClass, stubbedElements} from '../custom-element';\nimport {extensionScriptsInNode} from './extension-script';\nimport {reportError} from '../error-reporting';\nimport {userAssert} from '../log';\n\n/** @type {!WeakMap<!./service/ampdoc-impl.AmpDoc, boolean>} */\nconst docInitializedMap = new WeakMap();\n\n/**\n * @param {!Window} win\n * @return {!Object<string, typeof ../base-element.BaseElement>}\n */\nfunction getExtendedElements(win) {\n  if (!win.__AMP_EXTENDED_ELEMENTS) {\n    win.__AMP_EXTENDED_ELEMENTS = {};\n  }\n  return win.__AMP_EXTENDED_ELEMENTS;\n}\n\n/**\n * Registers an element. Upgrades it if has previously been stubbed.\n * @param {!Window} win\n * @param {string} name\n * @param {typeof ../base-element.BaseElement} toClass\n */\nexport function upgradeOrRegisterElement(win, name, toClass) {\n  const waitPromise = waitReadyForUpgrade(win, toClass);\n  if (waitPromise) {\n    waitPromise.then(() => upgradeOrRegisterElementReady(win, name, toClass));\n  } else {\n    upgradeOrRegisterElementReady(win, name, toClass);\n  }\n}\n\n/**\n * Registers an element. Upgrades it if has previously been stubbed.\n * @param {!Window} win\n * @param {string} name\n * @param {typeof ../base-element.BaseElement} toClass\n */\nfunction upgradeOrRegisterElementReady(win, name, toClass) {\n  const knownElements = getExtendedElements(win);\n  if (!knownElements[name]) {\n    registerElement(win, name, toClass);\n    return;\n  }\n  if (knownElements[name] == toClass) {\n    // Already registered this instance.\n    return;\n  }\n  userAssert(\n    knownElements[name] == ElementStub,\n    '%s is already registered. The script tag for ' +\n      '%s is likely included twice in the page.',\n    name,\n    name\n  );\n  knownElements[name] = toClass;\n  for (let i = 0; i < stubbedElements.length; i++) {\n    const element = stubbedElements[i];\n    // There are 3 possible states here:\n    // 1. We never made the stub because the extended impl. loaded first.\n    //    In that case the element won't be in the array.\n    // 2. We made a stub but the browser didn't attach it yet. In\n    //    that case we don't need to upgrade but simply switch to the new\n    //    implementation.\n    // 3. A stub was attached. We upgrade which means we replay the\n    //    implementation.\n    if (\n      element.tagName.toLowerCase() == name &&\n      element.ownerDocument.defaultView == win\n    ) {\n      tryUpgradeElement(element, toClass);\n      // Remove element from array.\n      stubbedElements.splice(i--, 1);\n    }\n  }\n}\n\n/**\n * This method should not be inlined to prevent TryCatch deoptimization.\n * @param {Element} element\n * @param {typeof ../base-element.BaseElement} toClass\n * @private\n */\nfunction tryUpgradeElement(element, toClass) {\n  try {\n    element.upgrade(toClass);\n  } catch (e) {\n    reportError(e, element);\n  }\n}\n\n/**\n * Ensures that the element is ready for upgrade. Either returns immediately\n * with `undefined` indicating that no waiting is necessary, or returns a\n * promise that will resolve when the upgrade can proceed.\n *\n * @param {!Window} win\n * @param {typeof ../base-element.BaseElement} elementClass\n * @return {!Promise|undefind}\n */\nfunction waitReadyForUpgrade(win, elementClass) {\n  // Make sure the polyfill is installed for Shadow DOM if element needs it.\n  if (elementClass.requiresShadowDom() && !win.Element.prototype.attachShadow) {\n    const extensions = Services.extensionsFor(win);\n    return extensions.importUnwrapped(win, 'amp-shadow-dom-polyfill');\n  }\n}\n\n/**\n * Stub extended elements missing an implementation. It can be called multiple\n * times and on partial document in order to start stubbing as early as\n * possible.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function stubElementsForDoc(ampdoc) {\n  const extensions = extensionScriptsInNode(ampdoc.getHeadNode());\n  extensions.forEach(({extensionId, extensionVersion}) => {\n    ampdoc.declareExtension(extensionId, extensionVersion);\n    stubElementIfNotKnown(ampdoc.win, extensionId);\n  });\n  if (ampdoc.isBodyAvailable()) {\n    ampdoc.setExtensionsKnown();\n  }\n}\n\n/**\n * Stub element if not yet known.\n * @param {!Window} win\n * @param {string} name\n */\nexport function stubElementIfNotKnown(win, name) {\n  const knownElements = getExtendedElements(win);\n  if (!knownElements[name]) {\n    registerElement(win, name, ElementStub);\n  }\n}\n\n/**\n * Copies the specified element to child window (friendly iframe). This way\n * all implementations of the AMP elements are shared between all friendly\n * frames.\n * @param {!Window} parentWin\n * @param {!Window} childWin\n * @param {string} name\n */\nexport function copyElementToChildWindow(parentWin, childWin, name) {\n  const toClass = getExtendedElements(parentWin)[name];\n  registerElement(childWin, name, toClass || ElementStub);\n}\n\n/**\n * Registers a new custom element with its implementation class.\n * @param {!Window} win The window in which to register the elements.\n * @param {string} name Name of the custom element\n * @param {typeof ../base-element.BaseElement} implementationClass\n */\nexport function registerElement(win, name, implementationClass) {\n  const knownElements = getExtendedElements(win);\n  knownElements[name] = implementationClass;\n  const klass = createCustomElementClass(win, elementConnectedCallback);\n  win['customElements'].define(name, klass);\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!AmpElement} element\n * @param {?(typeof BaseElement)} implementationClass\n * @visibleForTesting\n */\nexport function elementConnectedCallback(ampdoc, element, implementationClass) {\n  // Make sure that the ampdoc has already been stubbed.\n  if (!docInitializedMap.has(ampdoc)) {\n    docInitializedMap.set(ampdoc, true);\n    stubElementsForDoc(ampdoc);\n  }\n\n  // Load the pre-stubbed legacy extension if needed.\n  const extensionId = element.localName;\n  if (!implementationClass && !ampdoc.declaresExtension(extensionId)) {\n    Services.extensionsFor(ampdoc.win).installExtensionForDoc(\n      ampdoc,\n      extensionId,\n      // The legacy auto-extensions are always 0.1.\n      '0.1'\n    );\n  }\n}\n\n/**\n * In order to provide better error messages we only allow to retrieve\n * services from other elements if those elements are loaded in the page.\n * This makes it possible to mark an element as loaded in a test.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @visibleForTesting\n */\nexport function markElementScheduledForTesting(win, elementName) {\n  const knownElements = getExtendedElements(win);\n  if (!knownElements[elementName]) {\n    knownElements[elementName] = ElementStub;\n  }\n}\n\n/**\n * Resets our scheduled elements.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @visibleForTesting\n */\nexport function resetScheduledElementForTesting(win, elementName) {\n  if (win.__AMP_EXTENDED_ELEMENTS) {\n    delete win.__AMP_EXTENDED_ELEMENTS[elementName];\n  }\n}\n\n/**\n * Returns a currently registered element class.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @return {?function()}\n * @visibleForTesting\n */\nexport function getElementClassForTesting(win, elementName) {\n  const knownElements = win.__AMP_EXTENDED_ELEMENTS;\n  return (knownElements && knownElements[elementName]) || null;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from '../../src/base-element';\nimport {Layout, isLayoutSizeDefined} from '../../src/layout';\nimport {ReadyState} from '../../src/core/constants/ready-state';\nimport {Services} from '../../src/services';\nimport {dev} from '../../src/log';\nimport {guaranteeSrcForSrcsetUnsupportedBrowsers} from '../../src/core/dom/img';\nimport {listen} from '../../src/event-helper';\nimport {propagateObjectFitStyles, setImportantStyles} from '../../src/style';\nimport {registerElement} from '../../src/service/custom-element-registry';\nimport {removeElement} from '../../src/dom';\nimport {scopedQuerySelector} from '../../src/core/dom/query';\n\n/** @const {string} */\nconst TAG = 'amp-img';\n\n/**\n * Attributes to propagate to internal image when changed externally.\n * @type {!Array<string>}\n */\nconst ATTRIBUTES_TO_PROPAGATE = [\n  'alt',\n  'aria-describedby',\n  'aria-label',\n  'aria-labelledby',\n  'crossorigin',\n  'referrerpolicy',\n  'title',\n  'sizes',\n  'srcset',\n  'src',\n];\n\nexport class AmpImg extends BaseElement {\n  /** @override @nocollapse */\n  static R1() {\n    return R1_IMG_DEFERRED_BUILD;\n  }\n\n  /** @override @nocollapse */\n  static prerenderAllowed() {\n    return true;\n  }\n\n  /** @override @nocollapse */\n  static usesLoading() {\n    return true;\n  }\n\n  /** @override @nocollapse */\n  static getPreconnects(element) {\n    const src = element.getAttribute('src');\n    if (src) {\n      return [src];\n    }\n\n    // NOTE(@wassgha): since parseSrcset is computationally expensive and can\n    // not be inside the `buildCallback`, we went with preconnecting to the\n    // `src` url if it exists or the first srcset url.\n    const srcset = element.getAttribute('srcset');\n    if (srcset) {\n      // We try to find the first url in the srcset\n      const srcseturl = /\\S+/.exec(srcset);\n      // Connect to the first url if it exists\n      if (srcseturl) {\n        return [srcseturl[0]];\n      }\n    }\n\n    return null;\n  }\n\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n\n    /** @private {boolean} */\n    this.allowImgLoadFallback_ = true;\n\n    /** @private {?Element} */\n    this.img_ = null;\n\n    /** @private {?UnlistenDef} */\n    this.unlistenLoad_ = null;\n\n    /** @private {?UnlistenDef} */\n    this.unlistenError_ = null;\n\n    /**\n     * The current width used by the automatically generated sizes attribute\n     * @private {number}\n     * */\n    this.sizesWidth_ = 0;\n  }\n\n  /** @override */\n  mutatedAttributesCallback(mutations) {\n    if (this.img_) {\n      const attrs = ATTRIBUTES_TO_PROPAGATE.filter(\n        (value) => mutations[value] !== undefined\n      );\n      // Mutating src should override existing srcset, so remove the latter.\n      if (\n        mutations['src'] &&\n        !mutations['srcset'] &&\n        this.element.hasAttribute('srcset')\n      ) {\n        // propagateAttributes() will remove [srcset] from this.img_.\n        this.element.removeAttribute('srcset');\n        attrs.push('srcset');\n\n        this.user().warn(\n          TAG,\n          'Removed [srcset] since [src] was mutated. Recommend adding a ' +\n            '[srcset] binding to support responsive images.',\n          this.element\n        );\n      }\n      this.propagateAttributes(\n        attrs,\n        this.img_,\n        /* opt_removeMissingAttrs */ true\n      );\n      this.propagateDataset(this.img_);\n\n      if (!IS_ESM) {\n        guaranteeSrcForSrcsetUnsupportedBrowsers(this.img_);\n      }\n\n      if (AmpImg.R1() && !this.img_.complete) {\n        this.setReadyState(ReadyState.LOADING);\n      }\n    }\n  }\n\n  /** @override */\n  preconnectCallback(onLayout) {\n    // NOTE(@wassgha): since parseSrcset is computationally expensive and can\n    // not be inside the `buildCallback`, we went with preconnecting to the\n    // `src` url if it exists or the first srcset url.\n    const src = this.element.getAttribute('src');\n    if (src) {\n      Services.preconnectFor(this.win).url(this.getAmpDoc(), src, onLayout);\n    } else {\n      const srcset = this.element.getAttribute('srcset');\n      if (!srcset) {\n        return;\n      }\n      // We try to find the first url in the srcset\n      const srcseturl = /\\S+/.exec(srcset);\n      // Connect to the first url if it exists\n      if (srcseturl) {\n        Services.preconnectFor(this.win).url(\n          this.getAmpDoc(),\n          srcseturl[0],\n          onLayout\n        );\n      }\n    }\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return isLayoutSizeDefined(layout);\n  }\n\n  /**\n   * Create the actual image element and set up instance variables.\n   * Called lazily in the first `#layoutCallback`.\n   * @return {!Image}\n   */\n  initialize_() {\n    if (this.img_) {\n      return this.img_;\n    }\n    // If this amp-img IS the fallback then don't allow it to have its own\n    // fallback to stop from nested fallback abuse.\n    this.allowImgLoadFallback_ = !this.element.hasAttribute('fallback');\n\n    // For SSR, image will have been written directly to DOM so no need to recreate.\n    const serverRendered = this.element.hasAttribute('i-amphtml-ssr');\n    if (serverRendered) {\n      this.img_ = scopedQuerySelector(this.element, '> img:not([placeholder])');\n    }\n    this.img_ = this.img_ || new Image();\n    this.img_.setAttribute('decoding', 'async');\n    if (this.element.id) {\n      this.img_.setAttribute('amp-img-id', this.element.id);\n    }\n\n    // Remove role=img otherwise this breaks screen-readers focus and\n    // only read \"Graphic\" when using only 'alt'.\n    if (this.element.getAttribute('role') == 'img') {\n      this.element.removeAttribute('role');\n      this.user().error(\n        TAG,\n        'Setting role=img on amp-img elements breaks ' +\n          'screen readers please just set alt or ARIA attributes, they will ' +\n          'be correctly propagated for the underlying <img> element.'\n      );\n    }\n\n    // It is important to call this before setting `srcset` attribute.\n    this.maybeGenerateSizes_(/* sync setAttribute */ true);\n    this.propagateAttributes(ATTRIBUTES_TO_PROPAGATE, this.img_);\n    this.propagateDataset(this.img_);\n    if (!IS_ESM) {\n      guaranteeSrcForSrcsetUnsupportedBrowsers(this.img_);\n    }\n    this.applyFillContent(this.img_, true);\n    propagateObjectFitStyles(this.element, this.img_);\n\n    if (!serverRendered) {\n      this.element.appendChild(this.img_);\n    }\n    return this.img_;\n  }\n\n  /**\n   * This function automatically generates sizes for amp-imgs without\n   * the sizes attribute.\n   * @param {boolean} sync Whether to immediately make the change or schedule\n   *     via mutateElement.\n   * @private\n   */\n  maybeGenerateSizes_(sync) {\n    if (R1_IMG_DEFERRED_BUILD) {\n      // The `getLayoutSize()` is not available for a R1 element. Skip this\n      // codepath. Also: is this feature at all useful? E.g. it doesn't even\n      // execute in the `i-amphtml-ssr` mode.\n      return;\n    }\n    if (!this.img_) {\n      return;\n    }\n    // If the image is server rendered, do not generate sizes.\n    if (this.element.hasAttribute('i-amphtml-ssr')) {\n      return;\n    }\n    // No need to generate sizes if already present.\n    const sizes =\n      this.element.hasAttribute('sizes') || this.img_.hasAttribute('sizes');\n    if (sizes) {\n      return;\n    }\n    // Sizes is useless without the srcset attribute or if the srcset\n    // attribute uses the x descriptor.\n    const srcset = this.element.getAttribute('srcset');\n    if (!srcset || /[0-9]+x(?:,|$)/.test(srcset)) {\n      return;\n    }\n\n    const {width} = this.element.getLayoutSize();\n    if (!this.shouldSetSizes_(width)) {\n      return;\n    }\n\n    const viewportWidth = this.getViewport().getWidth();\n\n    const entry = `(max-width: ${viewportWidth}px) ${width}px, `;\n    let defaultSize = width + 'px';\n\n    if (this.getLayout() !== Layout.FIXED) {\n      const ratio = Math.round((width * 100) / viewportWidth);\n      defaultSize = Math.max(ratio, 100) + 'vw';\n    }\n\n    const generatedSizes = entry + defaultSize;\n\n    if (sync) {\n      this.img_.setAttribute('sizes', generatedSizes);\n    } else {\n      this.mutateElement(() => {\n        this.img_.setAttribute('sizes', generatedSizes);\n      });\n    }\n    this.sizesWidth_ = width;\n  }\n\n  /**\n   * @param {number} newWidth\n   * @return {boolean}\n   * @private\n   */\n  shouldSetSizes_(newWidth) {\n    if (!this.img_.hasAttribute('sizes')) {\n      return true;\n    }\n    return newWidth > this.sizesWidth_;\n  }\n\n  /** @override */\n  reconstructWhenReparented() {\n    return false;\n  }\n\n  /** @override */\n  mountCallback() {\n    const initialized = !!this.img_;\n    const img = this.initialize_();\n    if (!initialized) {\n      listen(img, 'load', () => {\n        this.setReadyState(ReadyState.COMPLETE);\n        this.firstLayoutCompleted();\n        this.hideFallbackImg_();\n      });\n      listen(img, 'error', (reason) => {\n        this.setReadyState(ReadyState.ERROR, reason);\n        this.onImgLoadingError_();\n      });\n    }\n    if (img.complete) {\n      this.setReadyState(ReadyState.COMPLETE);\n      this.firstLayoutCompleted();\n      this.hideFallbackImg_();\n    } else {\n      this.setReadyState(ReadyState.LOADING);\n    }\n  }\n\n  /** @override */\n  unmountCallback() {\n    // Interrupt retrieval of incomplete images to free network resources when\n    // navigating pages in a PWA. Opt for tiny dataURI image instead of empty\n    // src to prevent the viewer from detecting a load error.\n    const img = this.img_;\n    if (img && !img.complete) {\n      img.src =\n        'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACwAAAAAAQABAAACAkQBADs=';\n      removeElement(img);\n      this.img_ = null;\n    }\n  }\n\n  /** @override */\n  ensureLoaded() {\n    const img = dev().assertElement(this.img_);\n    img.loading = 'eager';\n  }\n\n  /** @override */\n  layoutCallback() {\n    this.initialize_();\n    const img = dev().assertElement(this.img_);\n    this.unlistenLoad_ = listen(img, 'load', () => this.hideFallbackImg_());\n    this.unlistenError_ = listen(img, 'error', () => this.onImgLoadingError_());\n    const {width} = this.element.getLayoutSize();\n    if (width <= 0) {\n      return Promise.resolve();\n    }\n    return this.loadPromise(img);\n  }\n\n  /** @override */\n  unlayoutCallback() {\n    if (AmpImg.R1()) {\n      // TODO(#31915): Reconsider if this is still desired for R1. This helps\n      // with network interruption when a document is inactivated.\n      return;\n    }\n\n    if (this.unlistenError_) {\n      this.unlistenError_();\n      this.unlistenError_ = null;\n    }\n    if (this.unlistenLoad_) {\n      this.unlistenLoad_();\n      this.unlistenLoad_ = null;\n    }\n\n    // Interrupt retrieval of incomplete images to free network resources when\n    // navigating pages in a PWA. Opt for tiny dataURI image instead of empty\n    // src to prevent the viewer from detecting a load error.\n    const img = this.img_;\n    if (img && !img.complete) {\n      img.src =\n        'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACwAAAAAAQABAAACAkQBADs=';\n      removeElement(img);\n      this.img_ = null;\n    }\n\n    return true;\n  }\n\n  /** @override */\n  firstLayoutCompleted() {\n    const placeholder = this.getPlaceholder();\n    if (\n      placeholder &&\n      placeholder.classList.contains('i-amphtml-blurry-placeholder')\n    ) {\n      setImportantStyles(placeholder, {'opacity': 0});\n    } else {\n      this.togglePlaceholder(false);\n    }\n  }\n\n  /**\n   * @private\n   */\n  hideFallbackImg_() {\n    if (\n      !this.allowImgLoadFallback_ &&\n      this.img_.classList.contains('i-amphtml-ghost')\n    ) {\n      this.img_.classList.remove('i-amphtml-ghost');\n      this.toggleFallback(false);\n    }\n  }\n\n  /**\n   * If the image fails to load, show a fallback or placeholder instead.\n   * @private\n   */\n  onImgLoadingError_() {\n    if (this.allowImgLoadFallback_) {\n      this.img_.classList.add('i-amphtml-ghost');\n      this.toggleFallback(true);\n      // Hide placeholders, as browsers that don't support webp\n      // Would show the placeholder underneath a transparent fallback\n      this.togglePlaceholder(false);\n      this.allowImgLoadFallback_ = false;\n    }\n  }\n\n  /**\n   * Utility method to propagate data attributes from this element\n   * to the target element. (For use with arbitrary data attributes.)\n   * Removes any data attributes that are missing on this element from\n   * the target element.\n   * AMP Bind attributes are excluded.\n   *\n   * @param {!Element} targetElement\n   */\n  propagateDataset(targetElement) {\n    for (const key in targetElement.dataset) {\n      if (!(key in this.element.dataset)) {\n        delete targetElement.dataset[key];\n      }\n    }\n\n    for (const key in this.element.dataset) {\n      if (key.startsWith('ampBind') && key !== 'ampBind') {\n        continue;\n      }\n      if (targetElement.dataset[key] !== this.element.dataset[key]) {\n        targetElement.dataset[key] = this.element.dataset[key];\n      }\n    }\n  }\n}\n\n/**\n * @param {!Window} win Destination window for the new element.\n * @this {undefined}  // Make linter happy\n */\nexport function installImg(win) {\n  registerElement(win, TAG, AmpImg);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\n\n/**\n * Pass class helps to manage single-pass process. A pass is scheduled using\n * delay method. Only one pass can be pending at a time. If no pass is pending\n * the process is considered to be \"idle\".\n */\nexport class Pass {\n  /**\n   * Creates a new Pass instance.\n   * @param {!Window} win\n   * @param {function()} handler Handler to be executed when pass is triggered.\n   * @param {number=} opt_defaultDelay Default delay to be used when schedule\n   *   is called without one.\n   */\n  constructor(win, handler, opt_defaultDelay) {\n    this.timer_ = Services.timerFor(win);\n\n    /** @private @const {function()} */\n    this.handler_ = handler;\n\n    /** @private @const {number} */\n    this.defaultDelay_ = opt_defaultDelay || 0;\n\n    /** @private {number|string} */\n    this.scheduled_ = -1;\n\n    /** @private {number} */\n    this.nextTime_ = 0;\n\n    /** @private {boolean} */\n    this.running_ = false;\n\n    /**\n     * @private\n     * @const {function()}\n     */\n    this.boundPass_ = () => {\n      this.pass_();\n    };\n  }\n\n  /**\n   * Whether or not a pass is currently pending.\n   * @return {boolean}\n   */\n  isPending() {\n    return this.scheduled_ != -1;\n  }\n\n  /**\n   * Tries to schedule a new pass optionally with specified delay. If the new\n   * requested pass is requested before the pending pass, the pending pass is\n   * canceled. If the new pass is requested after the pending pass, the newly\n   * requested pass is ignored.\n   *\n   * Returns {@code true} if the pass has been scheduled and {@code false} if\n   * ignored.\n   *\n   * @param {number=} opt_delay Delay to schedule the pass. If not specified\n   *   the default delay is used, falling back to 0.\n   * @return {boolean}\n   */\n  schedule(opt_delay) {\n    let delay = opt_delay || this.defaultDelay_;\n    if (this.running_ && delay < 10) {\n      // If we get called recursively, wait at least 10ms for the next\n      // execution.\n      delay = 10;\n    }\n\n    const nextTime = Date.now() + delay;\n    // Schedule anew if nothing is scheduled currently or if the new time is\n    // sooner then previously requested.\n    if (!this.isPending() || nextTime - this.nextTime_ < -10) {\n      this.cancel();\n      this.nextTime_ = nextTime;\n      this.scheduled_ = this.timer_.delay(this.boundPass_, delay);\n\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   *\n   */\n  pass_() {\n    this.scheduled_ = -1;\n    this.nextTime_ = 0;\n    this.running_ = true;\n    this.handler_();\n    this.running_ = false;\n  }\n\n  /**\n   * Cancels the pending pass if any.\n   */\n  cancel() {\n    if (this.isPending()) {\n      this.timer_.cancel(this.scheduled_);\n      this.scheduled_ = -1;\n    }\n  }\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../core/data-structures/promise';\nimport {Observable} from '../core/data-structures/observable';\nimport {Pass} from '../pass';\nimport {READY_SCAN_SIGNAL} from '../service/resources-interface';\nimport {Resource, ResourceState} from '../service/resource';\nimport {Services} from '../services';\nimport {VisibilityState} from '../core/constants/visibility-state';\nimport {dev} from '../log';\nimport {getMode} from '../mode';\nimport {hasNextNodeInDocumentOrder} from '../dom';\nimport {registerServiceBuilderForDoc} from '../service';\n\nconst TAG = 'inabox-resources';\nconst FOUR_FRAME_DELAY = 70;\n\n/**\n * @implements {../service/resources-interface.ResourcesInterface}\n * @implements {../service.Disposable}\n * @visibleForTesting\n */\nexport class InaboxResources {\n  /**\n   * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const {!../service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @const {!Window} */\n    this.win = ampdoc.win;\n\n    /** @private @const {!Array<!Resource>} */\n    this.resources_ = [];\n\n    /** @private {number} */\n    this.resourceIdCounter_ = 0;\n\n    /** @const @private {!Pass} */\n    this.pass_ = new Pass(this.win, this.doPass_.bind(this), FOUR_FRAME_DELAY);\n\n    /** @private @const {!Observable} */\n    this.passObservable_ = new Observable();\n\n    /** @const @private {!Deferred} */\n    this.firstPassDone_ = new Deferred();\n\n    /** @private {?IntersectionObserver} */\n    this.inViewportObserver_ = null;\n\n    const input = Services.inputFor(this.win);\n    input.setupInputModeClasses(ampdoc);\n\n    // TODO(#31246): launch the visibility logic in inabox as well.\n    if (getMode(this.win).runtime != 'inabox') {\n      ampdoc.onVisibilityChanged(() => {\n        switch (ampdoc.getVisibilityState()) {\n          case VisibilityState.PAUSED:\n            this.resources_.forEach((r) => r.pause());\n            break;\n          case VisibilityState.VISIBLE:\n            this.resources_.forEach((r) => r.resume());\n            this./*OK*/ schedulePass();\n            break;\n        }\n      });\n    }\n\n    /** @private {!Array<Resource>} */\n    this.pendingBuildResources_ = [];\n\n    /** @private {boolean} */\n    this.documentReady_ = false;\n\n    this.ampdoc_.whenReady().then(() => {\n      this.documentReady_ = true;\n      this.buildReadyResources_();\n      this./*OK*/ schedulePass(1);\n    });\n  }\n\n  /** @override */\n  dispose() {\n    this.resources_.forEach((r) => r.unload());\n    this.resources_.length = 0;\n    if (this.inViewportObserver_) {\n      this.inViewportObserver_.disconnect();\n      this.inViewportObserver_ = null;\n    }\n  }\n\n  /** @override */\n  get() {\n    return this.resources_.slice(0);\n  }\n\n  /** @override */\n  getAmpdoc() {\n    return this.ampdoc_;\n  }\n\n  /** @override */\n  getResourceForElement(element) {\n    return Resource.forElement(element);\n  }\n\n  /** @override */\n  getResourceForElementOptional(element) {\n    return Resource.forElementOptional(element);\n  }\n\n  /** @override */\n  getScrollDirection() {\n    return 1;\n  }\n\n  /** @override */\n  add(element) {\n    const resource = new Resource(++this.resourceIdCounter_, element, this);\n    this.resources_.push(resource);\n    dev().fine(TAG, 'resource added:', resource.debugid);\n  }\n\n  /** @override */\n  upgraded(element) {\n    const resource = Resource.forElement(element);\n    this.pendingBuildResources_.push(resource);\n    this.buildReadyResources_();\n  }\n\n  /** @override */\n  remove(element) {\n    const resource = Resource.forElementOptional(element);\n    if (!resource) {\n      return;\n    }\n    if (this.inViewportObserver_) {\n      this.inViewportObserver_.unobserve(element);\n    }\n    const index = this.resources_.indexOf(resource);\n    if (index !== -1) {\n      this.resources_.splice(index, 1);\n    }\n    dev().fine(TAG, 'element removed:', resource.debugid);\n  }\n\n  /** @override */\n  scheduleLayoutOrPreload(unusedResource) {\n    this.pass_.schedule();\n  }\n\n  /** @override */\n  schedulePass(opt_delay) {\n    return this.pass_.schedule(opt_delay);\n  }\n\n  /** @override */\n  updateOrEnqueueMutateTask(unusedResource, unusedNewRequest) {}\n\n  /** @override */\n  schedulePassVsync() {}\n\n  /** @override */\n  onNextPass(callback) {\n    this.passObservable_.add(callback);\n  }\n\n  /** @override */\n  ampInitComplete() {}\n\n  /** @override */\n  updateLayoutPriority(unusedElement, unusedNewLayoutPriority) {\n    // concept of element priority does not exist in inabox\n  }\n\n  /** @override */\n  setRelayoutTop(unusedRelayoutTop) {}\n\n  /** @override */\n  maybeHeightChanged() {}\n\n  /**\n   * @return {!Promise} when first pass executed.\n   */\n  whenFirstPass() {\n    return this.firstPassDone_.promise;\n  }\n\n  /**\n   * @private\n   */\n  doPass_() {\n    const now = Date.now();\n    dev().fine(TAG, 'doPass');\n    // measure in a batch\n    this.resources_.forEach((resource) => {\n      if (!resource.isLayoutPending() || resource.element.R1()) {\n        return;\n      }\n      resource.measure();\n    });\n    // mutation in a batch\n    this.resources_.forEach((resource) => {\n      if (\n        !resource.element.R1() &&\n        resource.getState() === ResourceState.READY_FOR_LAYOUT &&\n        resource.isDisplayed()\n      ) {\n        resource.layoutScheduled(now);\n        resource.startLayout();\n      }\n    });\n\n    this.ampdoc_.signals().signal(READY_SCAN_SIGNAL);\n    this.passObservable_.fire();\n    this.firstPassDone_.resolve();\n  }\n\n  /**\n   * Builds any pending resouces if document is ready, or next element has been\n   * added to DOM.\n   * @private\n   */\n  buildReadyResources_() {\n    for (let i = this.pendingBuildResources_.length - 1; i >= 0; i--) {\n      const resource = this.pendingBuildResources_[i];\n      if (\n        this.documentReady_ ||\n        hasNextNodeInDocumentOrder(resource.element, this.ampdoc_.getRootNode())\n      ) {\n        this.pendingBuildResources_.splice(i, 1);\n        resource.build().then(() => this./*OK*/ schedulePass());\n        dev().fine(TAG, 'resource upgraded:', resource.debugid);\n      }\n    }\n  }\n}\n\n/**\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installInaboxResourcesServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'resources', InaboxResources);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from './core/data-structures/observable';\nimport {Services} from './services';\nimport {dev} from './log';\nimport {listenOnce, listenOncePromise} from './event-helper';\nimport {registerServiceBuilder} from './service';\n\nconst TAG_ = 'Input';\n\nconst MAX_MOUSE_CONFIRM_ATTEMPS_ = 3;\nconst CLICK_TIMEOUT_ = 300;\n\n/**\n * Detects and maintains different types of input such as touch, mouse or\n * keyboard.\n */\nexport class Input {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private {!Function} */\n    this.boundOnKeyDown_ = this.onKeyDown_.bind(this);\n\n    /** @private {!Function} */\n    this.boundOnMouseDown_ = this.onMouseDown_.bind(this);\n\n    /** @private {?function(!Event)} */\n    this.boundOnMouseMove_ = null;\n\n    /** @private {?Function} */\n    this.boundMouseCanceled_ = null;\n\n    /** @private {?Function} */\n    this.boundMouseConfirmed_ = null;\n\n    /** @private {boolean} */\n    this.hasTouch_ =\n      'ontouchstart' in win ||\n      (win.navigator['maxTouchPoints'] !== undefined &&\n        win.navigator['maxTouchPoints'] > 0) ||\n      win['DocumentTouch'] !== undefined;\n    dev().fine(TAG_, 'touch detected:', this.hasTouch_);\n\n    /** @private {boolean} */\n    this.keyboardActive_ = false;\n    this.win.document.addEventListener('keydown', this.boundOnKeyDown_);\n    this.win.document.addEventListener('mousedown', this.boundOnMouseDown_);\n\n    /** @private {boolean} */\n    this.hasMouse_ = true;\n\n    /** @private {number} */\n    this.mouseConfirmAttemptCount_ = 0;\n\n    /** @private {!Observable<boolean>} */\n    this.touchDetectedObservable_ = new Observable();\n\n    /** @private {!Observable<boolean>} */\n    this.mouseDetectedObservable_ = new Observable();\n\n    /** @private {!Observable<boolean>} */\n    this.keyboardStateObservable_ = new Observable();\n\n    // If touch available, temporarily set hasMouse to false and wait for\n    // mouse events.\n    if (this.hasTouch_) {\n      this.hasMouse_ = !this.hasTouch_;\n      this.boundOnMouseMove_ = /** @type {function(!Event)} */ (\n        this.onMouseMove_.bind(this)\n      );\n      listenOnce(win.document, 'mousemove', this.boundOnMouseMove_);\n    }\n  }\n\n  /**\n   * See https://github.com/ampproject/amphtml/blob/main/docs/spec/amp-css-classes.md#input-mode-classes\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  setupInputModeClasses(ampdoc) {\n    this.onTouchDetected((detected) => {\n      this.toggleInputClass_(ampdoc, 'amp-mode-touch', detected);\n    }, true);\n    this.onMouseDetected((detected) => {\n      this.toggleInputClass_(ampdoc, 'amp-mode-mouse', detected);\n    }, true);\n    this.onKeyboardStateChanged((active) => {\n      this.toggleInputClass_(ampdoc, 'amp-mode-keyboard-active', active);\n    }, true);\n  }\n\n  /**\n   * Whether the touch input has been detected.\n   * @return {boolean}\n   */\n  isTouchDetected() {\n    return this.hasTouch_;\n  }\n\n  /**\n   * Registers an event handle in case if the touch is detected.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  onTouchDetected(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isTouchDetected());\n    }\n    return this.touchDetectedObservable_.add(handler);\n  }\n\n  /**\n   * Whether the mouse input has been detected.\n   * @return {boolean}\n   */\n  isMouseDetected() {\n    return this.hasMouse_;\n  }\n\n  /**\n   * Registers an event handle in case if the mouse is detected.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  onMouseDetected(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isMouseDetected());\n    }\n    return this.mouseDetectedObservable_.add(handler);\n  }\n\n  /**\n   * Whether the keyboard input is currently active.\n   * @return {boolean}\n   */\n  isKeyboardActive() {\n    return this.keyboardActive_;\n  }\n\n  /**\n   * Registers an event handle for changes in the keyboard input.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  onKeyboardStateChanged(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isKeyboardActive());\n    }\n    return this.keyboardStateObservable_.add(handler);\n  }\n\n  /**\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} clazz\n   * @param {boolean} on\n   * @private\n   */\n  toggleInputClass_(ampdoc, clazz, on) {\n    ampdoc.waitForBodyOpen().then((body) => {\n      const vsync = Services./*OK*/ vsyncFor(this.win);\n      vsync.mutate(() => {\n        body.classList.toggle(clazz, on);\n      });\n    });\n  }\n\n  /**\n   * @param {!Event} e\n   * @private\n   */\n  onKeyDown_(e) {\n    if (this.keyboardActive_) {\n      return;\n    }\n\n    if (e.defaultPrevented) {\n      return;\n    }\n\n    // Ignore inputs.\n    const {target} = e;\n    if (\n      target &&\n      (target.tagName == 'INPUT' ||\n        target.tagName == 'TEXTAREA' ||\n        target.tagName == 'SELECT' ||\n        target.tagName == 'OPTION' ||\n        target.hasAttribute('contenteditable'))\n    ) {\n      return;\n    }\n\n    this.keyboardActive_ = true;\n    this.keyboardStateObservable_.fire(true);\n    dev().fine(TAG_, 'keyboard activated');\n  }\n\n  /** @private */\n  onMouseDown_() {\n    if (!this.keyboardActive_) {\n      return;\n    }\n    this.keyboardActive_ = false;\n    this.keyboardStateObservable_.fire(false);\n    dev().fine(TAG_, 'keyboard deactivated');\n  }\n\n  /**\n   * @param {!Event} e\n   * @return {!Promise|undefined}\n   * @private\n   */\n  onMouseMove_(e) {\n    // The event explicitly states that it's a result of a touch event.\n    if (e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) {\n      this.mouseCanceled_();\n      return undefined;\n    }\n    if (!this.boundMouseConfirmed_) {\n      this.boundMouseConfirmed_ = this.mouseConfirmed_.bind(this);\n      this.boundMouseCanceled_ = this.mouseCanceled_.bind(this);\n    }\n    // If \"click\" arrives within a timeout time, this is most likely a\n    // touch/mouse emulation. Otherwise, if timeout exceeded, this looks\n    // like a legitimate mouse event.\n    let unlisten;\n    const listenPromise = listenOncePromise(\n      this.win.document,\n      'click',\n      /* capture */ undefined,\n      (unlistener) => {\n        unlisten = unlistener;\n      }\n    );\n    return Services.timerFor(this.win)\n      .timeoutPromise(CLICK_TIMEOUT_, listenPromise)\n      .then(this.boundMouseCanceled_, () => {\n        if (unlisten) {\n          unlisten();\n        }\n        this.boundMouseConfirmed_();\n      });\n  }\n\n  /** @private */\n  mouseConfirmed_() {\n    this.hasMouse_ = true;\n    this.mouseDetectedObservable_.fire(true);\n    dev().fine(TAG_, 'mouse detected');\n  }\n\n  /** @private */\n  mouseCanceled_() {\n    // Repeat, if attempts allow.\n    this.mouseConfirmAttemptCount_++;\n    if (this.mouseConfirmAttemptCount_ <= MAX_MOUSE_CONFIRM_ATTEMPS_) {\n      listenOnce(\n        this.win.document,\n        'mousemove',\n        /** @type {function(!Event)} */ (this.boundOnMouseMove_)\n      );\n    } else {\n      dev().fine(TAG_, 'mouse detection failed');\n    }\n  }\n}\n\n/**\n * @param {!Window} win\n */\nexport function installInputService(win) {\n  registerServiceBuilder(win, 'input', Input);\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from '../../src/base-element';\nimport {Layout, isLayoutSizeDefined} from '../../src/layout';\nimport {registerElement} from '../../src/service/custom-element-registry';\n\nclass AmpLayout extends BaseElement {\n  /** @override @nocollapse */\n  static prerenderAllowed() {\n    return true;\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return layout == Layout.CONTAINER || isLayoutSizeDefined(layout);\n  }\n\n  /** @override */\n  buildCallback() {\n    if (this.getLayout() == Layout.CONTAINER) {\n      return;\n    }\n    const container = this.win.document.createElement('div');\n    this.applyFillContent(container);\n    this.getRealChildNodes().forEach((child) => {\n      container.appendChild(child);\n    });\n    this.element.appendChild(container);\n  }\n}\n\n/**\n * @param {!Window} win Destination window for the new element.\n */\nexport function installLayout(win) {\n  registerElement(win, 'amp-layout', AmpLayout);\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {devAssert} from '../src/log';\nimport {getMode} from './mode';\nimport {isIframed} from './dom';\nimport {toWin} from './core/window';\n\n/**\n * Returns an IntersectionObserver tracking the Viewport.\n *\n * @param {function(!Array<!IntersectionObserverEntry>)} ioCallback\n * @param {!Window} win\n * @param {{\n *   threshold: (number|!Array<number>|undefined),\n *   needsRootBounds: (boolean|undefined),\n * }=} opts\n * @return {!IntersectionObserver}\n */\nexport function createViewportObserver(ioCallback, win, opts = {}) {\n  const {needsRootBounds, threshold} = opts;\n  // The Document -> Element type conversion is necessary to satisfy the\n  // `IntersectionObserver` constructor extern that only accepts `Element`.\n  const root =\n    isIframed(win) && needsRootBounds\n      ? /** @type {?} */ (win.document)\n      : undefined;\n  return new win.IntersectionObserver(ioCallback, {\n    threshold,\n    root,\n  });\n}\n\n/** @type {!WeakMap<!Window, !IntersectionObserver>} */\nconst viewportObservers = new WeakMap();\n\n/** @type {!WeakMap<!Element, function(boolean)>} */\nconst viewportCallbacks = new WeakMap();\n\n/**\n * Lazily creates an IntersectionObserver per Window to track when elements\n * enter and exit the viewport. Fires viewportCallback when this happens.\n *\n * @param {!Element} element\n * @param {function(boolean)} viewportCallback\n */\nexport function observeWithSharedInOb(element, viewportCallback) {\n  // There should never be two unique observers of the same element.\n  if (getMode().localDev) {\n    devAssert(\n      !viewportCallbacks.has(element) ||\n        viewportCallbacks.get(element) === viewportCallback\n    );\n  }\n\n  const win = toWin(element.ownerDocument.defaultView);\n  let viewportObserver = viewportObservers.get(win);\n  if (!viewportObserver) {\n    viewportObservers.set(\n      win,\n      (viewportObserver = createViewportObserver(ioCallback, win))\n    );\n  }\n  viewportCallbacks.set(element, viewportCallback);\n  viewportObserver.observe(element);\n}\n\n/**\n * Unobserve an element.\n * @param {!Element} element\n */\nexport function unobserveWithSharedInOb(element) {\n  const win = toWin(element.ownerDocument.defaultView);\n  const viewportObserver = viewportObservers.get(win);\n  if (viewportObserver) {\n    viewportObserver.unobserve(element);\n  }\n  viewportCallbacks.delete(element);\n}\n\n/**\n * Call the registered callbacks for each element that has crossed the\n * viewport boundary.\n *\n * @param {!Array<!IntersectionObserverEntry>} entries\n */\nfunction ioCallback(entries) {\n  for (let i = 0; i < entries.length; i++) {\n    const {isIntersecting, target} = entries[i];\n    const viewportCallback = viewportCallbacks.get(target);\n    if (viewportCallback) {\n      viewportCallback(isIntersecting);\n    }\n  }\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {FocusHistory} from '../focus-history';\nimport {MutatorInterface} from './mutator-interface';\nimport {Resource} from './resource';\nimport {Services} from '../services';\nimport {areMarginsChanged} from '../core/math/layout-rect';\nimport {closest} from '../core/dom/query';\nimport {computedStyle} from '../style';\nimport {dev} from '../log';\nimport {isExperimentOn} from '../experiments';\nimport {registerServiceBuilderForDoc} from '../service';\n\nconst FOUR_FRAME_DELAY_ = 70;\nconst FOCUS_HISTORY_TIMEOUT_ = 1000 * 60; // 1min\nconst TAG_ = 'Mutator';\n\n/**\n * @implements {MutatorInterface}\n */\nexport class MutatorImpl {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @const {!Window} */\n    this.win = ampdoc.win;\n\n    /** @private @const {!./resources-interface.ResourcesInterface} */\n    this.resources_ = Services.resourcesForDoc(ampdoc);\n\n    /** @private @const {!./viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(this.ampdoc);\n\n    /** @private @const {!./vsync-impl.Vsync} */\n    this.vsync_ = Services./*OK*/ vsyncFor(this.win);\n\n    /** @private @const {!FocusHistory} */\n    this.activeHistory_ = new FocusHistory(this.win, FOCUS_HISTORY_TIMEOUT_);\n\n    this.activeHistory_.onFocus((element) => {\n      this.checkPendingChangeSize_(element);\n    });\n  }\n\n  /** @override */\n  forceChangeSize(element, newHeight, newWidth, opt_callback, opt_newMargins) {\n    this.scheduleChangeSize_(\n      Resource.forElement(element),\n      newHeight,\n      newWidth,\n      opt_newMargins,\n      /* event */ undefined,\n      /* force */ true,\n      opt_callback\n    );\n  }\n\n  /** @override */\n  requestChangeSize(element, newHeight, newWidth, opt_newMargins, opt_event) {\n    return new Promise((resolve, reject) => {\n      this.scheduleChangeSize_(\n        Resource.forElement(element),\n        newHeight,\n        newWidth,\n        opt_newMargins,\n        opt_event,\n        /* force */ false,\n        (success) => {\n          if (success) {\n            resolve();\n          } else {\n            reject(new Error('changeSize attempt denied'));\n          }\n        }\n      );\n    });\n  }\n\n  /** @override */\n  expandElement(element) {\n    const resource = Resource.forElement(element);\n    resource.completeExpand();\n    this.resources_.schedulePass(FOUR_FRAME_DELAY_);\n  }\n\n  /** @override */\n  attemptCollapse(element) {\n    return new Promise((resolve, reject) => {\n      this.scheduleChangeSize_(\n        Resource.forElement(element),\n        0,\n        0,\n        /* newMargin */ undefined,\n        /* event */ undefined,\n        /* force */ false,\n        (success) => {\n          if (success) {\n            const resource = Resource.forElement(element);\n            resource.completeCollapse();\n            resolve();\n          } else {\n            reject(dev().createExpectedError('collapse attempt denied'));\n          }\n        }\n      );\n    });\n  }\n\n  /** @override */\n  collapseElement(element) {\n    const box = this.viewport_.getLayoutRect(element);\n    if (box.width != 0 && box.height != 0) {\n      if (isExperimentOn(this.win, 'dirty-collapse-element')) {\n        this.dirtyElement(element);\n      } else {\n        this.resources_.setRelayoutTop(box.top);\n      }\n    }\n\n    const resource = Resource.forElement(element);\n    resource.completeCollapse();\n\n    // Unlike completeExpand(), there's no requestMeasure() call here that\n    // requires another pass (with IntersectionObserver).\n    this.resources_.schedulePass(FOUR_FRAME_DELAY_);\n  }\n\n  /** @override */\n  measureElement(measurer) {\n    return this.vsync_.measurePromise(measurer);\n  }\n\n  /** @override */\n  mutateElement(element, mutator, skipRemeasure) {\n    return this.measureMutateElementResources_(\n      element,\n      null,\n      mutator,\n      skipRemeasure\n    );\n  }\n\n  /** @override */\n  measureMutateElement(element, measurer, mutator) {\n    return this.measureMutateElementResources_(element, measurer, mutator);\n  }\n\n  /**\n   * Returns the layout margins for the resource.\n   * @param {!Resource} resource\n   * @return {!../layout-rect.LayoutMarginsDef}\n   * @private\n   */\n  getLayoutMargins_(resource) {\n    const style = computedStyle(this.win, resource.element);\n    return {\n      top: parseInt(style.marginTop, 10) || 0,\n      right: parseInt(style.marginRight, 10) || 0,\n      bottom: parseInt(style.marginBottom, 10) || 0,\n      left: parseInt(style.marginLeft, 10) || 0,\n    };\n  }\n\n  /**\n   * Handles element mutation (and measurement) APIs in the Resources system.\n   *\n   * @param {!Element} element\n   * @param {?function()} measurer\n   * @param {function()} mutator\n   * @param {boolean} skipRemeasure\n   * @return {!Promise}\n   */\n  measureMutateElementResources_(\n    element,\n    measurer,\n    mutator,\n    skipRemeasure = false\n  ) {\n    const calcRelayoutTop = () => {\n      const box = this.viewport_.getLayoutRect(element);\n      if (box.width != 0 && box.height != 0) {\n        return box.top;\n      }\n      return -1;\n    };\n    let relayoutTop = -1;\n    // TODO(jridgewell): support state\n    return this.vsync_.runPromise({\n      measure: () => {\n        if (measurer) {\n          measurer();\n        }\n\n        if (!skipRemeasure) {\n          relayoutTop = calcRelayoutTop();\n        }\n      },\n      mutate: () => {\n        mutator();\n\n        // `skipRemeasure` is set by callers when we know that `mutator`\n        // cannot cause a change in size/position e.g. toggleLoading().\n        if (skipRemeasure) {\n          return;\n        }\n\n        if (element.classList.contains('i-amphtml-element')) {\n          const r = Resource.forElement(element);\n          r.requestMeasure();\n        }\n        const ampElements = element.getElementsByClassName('i-amphtml-element');\n        for (let i = 0; i < ampElements.length; i++) {\n          const r = Resource.forElement(ampElements[i]);\n          r.requestMeasure();\n        }\n        this.resources_.schedulePass(FOUR_FRAME_DELAY_);\n\n        if (relayoutTop != -1) {\n          this.resources_.setRelayoutTop(relayoutTop);\n        }\n        // Need to measure again in case the element has become visible or\n        // shifted.\n        this.vsync_.measure(() => {\n          const updatedRelayoutTop = calcRelayoutTop();\n          if (updatedRelayoutTop != -1 && updatedRelayoutTop != relayoutTop) {\n            this.resources_.setRelayoutTop(updatedRelayoutTop);\n            this.resources_.schedulePass(FOUR_FRAME_DELAY_);\n          }\n          this.resources_.maybeHeightChanged();\n        });\n      },\n    });\n  }\n\n  /**\n   * Dirties the cached element measurements after a mutation occurs.\n   *\n   * TODO(jridgewell): This API needs to be audited. Common practice is\n   * to pass the amp-element in as the root even though we are only\n   * mutating children. If the amp-element is passed, we invalidate\n   * everything in the parent layer above it, where only invalidating the\n   * amp-element was necessary (only children were mutated, only\n   * amp-element's scroll box is affected).\n   *\n   * @param {!Element} element\n   */\n  dirtyElement(element) {\n    let relayoutAll = false;\n    const isAmpElement = element.classList.contains('i-amphtml-element');\n    if (isAmpElement) {\n      const r = Resource.forElement(element);\n      this.resources_.setRelayoutTop(r.getLayoutBox().top);\n    } else {\n      relayoutAll = true;\n    }\n    this.resources_.schedulePass(FOUR_FRAME_DELAY_, relayoutAll);\n  }\n\n  /**\n   * Reschedules change size request when an overflown element is activated.\n   * @param {!Element} element\n   * @private\n   */\n  checkPendingChangeSize_(element) {\n    const resourceElement = closest(\n      element,\n      (el) => !!Resource.forElementOptional(el)\n    );\n    if (!resourceElement) {\n      return;\n    }\n    const resource = Resource.forElement(resourceElement);\n    const pendingChangeSize = resource.getPendingChangeSize();\n    if (pendingChangeSize !== undefined) {\n      this.scheduleChangeSize_(\n        resource,\n        pendingChangeSize.height,\n        pendingChangeSize.width,\n        pendingChangeSize.margins,\n        /* event */ undefined,\n        /* force */ true\n      );\n    }\n  }\n\n  /**\n   * Schedules change of the element's height.\n   * @param {!Resource} resource\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef|undefined} newMargins\n   * @param {?Event|undefined} event\n   * @param {boolean} force\n   * @param {function(boolean)=} opt_callback A callback function\n   * @private\n   */\n  scheduleChangeSize_(\n    resource,\n    newHeight,\n    newWidth,\n    newMargins,\n    event,\n    force,\n    opt_callback\n  ) {\n    if (resource.hasBeenMeasured() && !newMargins) {\n      this.completeScheduleChangeSize_(\n        resource,\n        newHeight,\n        newWidth,\n        undefined,\n        event,\n        force,\n        opt_callback\n      );\n    } else {\n      // This is a rare case since most of times the element itself schedules\n      // resize requests. However, this case is possible when another element\n      // requests resize of a controlled element. This also happens when a\n      // margin size change is requested, since existing margins have to be\n      // measured in this instance.\n      this.vsync_.measure(() => {\n        if (!resource.hasBeenMeasured()) {\n          resource.measure();\n        }\n        const marginChange = newMargins\n          ? {\n              newMargins,\n              currentMargins: this.getLayoutMargins_(resource),\n            }\n          : undefined;\n        this.completeScheduleChangeSize_(\n          resource,\n          newHeight,\n          newWidth,\n          marginChange,\n          event,\n          force,\n          opt_callback\n        );\n      });\n    }\n  }\n\n  /**\n   * @param {!Resource} resource\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!./resources-interface.MarginChangeDef|undefined} marginChange\n   * @param {?Event|undefined} event\n   * @param {boolean} force\n   * @param {function(boolean)=} opt_callback A callback function\n   * @private\n   */\n  completeScheduleChangeSize_(\n    resource,\n    newHeight,\n    newWidth,\n    marginChange,\n    event,\n    force,\n    opt_callback\n  ) {\n    resource.resetPendingChangeSize();\n    const layoutSize = resource.getLayoutSize();\n    if (\n      (newHeight === undefined || newHeight == layoutSize.height) &&\n      (newWidth === undefined || newWidth == layoutSize.width) &&\n      (marginChange === undefined ||\n        !areMarginsChanged(\n          marginChange.currentMargins,\n          marginChange.newMargins\n        ))\n    ) {\n      if (\n        newHeight === undefined &&\n        newWidth === undefined &&\n        marginChange === undefined\n      ) {\n        dev().error(\n          TAG_,\n          'attempting to change size with undefined dimensions',\n          resource.debugid\n        );\n      }\n      // Nothing to do.\n      if (opt_callback) {\n        opt_callback(/* success */ true);\n      }\n      return;\n    }\n\n    this.resources_.updateOrEnqueueMutateTask(\n      resource,\n      /** {!ChangeSizeRequestDef} */ {\n        resource,\n        newHeight,\n        newWidth,\n        marginChange,\n        event,\n        force,\n        callback: opt_callback,\n      }\n    );\n    // With IntersectionObserver, we still want to schedule a pass to execute\n    // the requested measures of the newly resized element(s).\n    this.resources_.schedulePassVsync();\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installMutatorServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'mutator', MutatorImpl);\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {OwnersInterface} from './owners-interface';\nimport {Resource} from './resource';\nimport {Services} from '../services';\nimport {devAssert} from '../log';\nimport {isArray} from '../core/types';\nimport {registerServiceBuilderForDoc} from '../service';\n\n/**\n * @param {!Element|!Array<!Element>} elements\n * @return {!Array<!Element>}\n */\nfunction elements(elements) {\n  return /** @type {!Array<!Element>} */ (\n    isArray(elements) ? elements : [elements]\n  );\n}\n\n/**\n * @implements {OwnersInterface}\n * @visibleForTesting\n */\nexport class OwnersImpl {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const @private {!./resources-interface.ResourcesInterface} */\n    this.resources_ = Services.resourcesForDoc(ampdoc);\n  }\n\n  /** @override */\n  setOwner(element, owner) {\n    Resource.setOwner(element, owner);\n  }\n\n  /** @override */\n  schedulePreload(parentElement, subElements) {\n    this.scheduleLayoutOrPreloadForSubresources_(\n      this.resources_.getResourceForElement(parentElement),\n      /* layout */ false,\n      elements(subElements)\n    );\n  }\n\n  /** @override */\n  scheduleLayout(parentElement, subElements) {\n    this.scheduleLayoutOrPreloadForSubresources_(\n      this.resources_.getResourceForElement(parentElement),\n      /* layout */ true,\n      elements(subElements)\n    );\n  }\n\n  /** @override */\n  schedulePause(parentElement, subElements) {\n    const parentResource = this.resources_.getResourceForElement(parentElement);\n    subElements = elements(subElements);\n\n    this.findResourcesInElements_(parentResource, subElements, (resource) => {\n      resource.pause();\n    });\n  }\n\n  /** @override */\n  scheduleResume(parentElement, subElements) {\n    const parentResource = this.resources_.getResourceForElement(parentElement);\n    subElements = elements(subElements);\n\n    this.findResourcesInElements_(parentResource, subElements, (resource) => {\n      resource.resume();\n    });\n  }\n\n  /** @override */\n  scheduleUnlayout(parentElement, subElements) {\n    const parentResource = this.resources_.getResourceForElement(parentElement);\n    subElements = elements(subElements);\n\n    this.findResourcesInElements_(parentResource, subElements, (resource) => {\n      resource.unlayout();\n    });\n  }\n\n  /** @override */\n  requireLayout(element, opt_parentPriority) {\n    const promises = [];\n    this.discoverResourcesForElement_(element, (resource) => {\n      promises.push(resource.element.ensureLoaded());\n    });\n    return Promise.all(promises);\n  }\n\n  /**\n   * Finds resources within the parent resource's shallow subtree.\n   * @param {!Resource} parentResource\n   * @param {!Array<!Element>} elements\n   * @param {function(!Resource)} callback\n   * @private\n   */\n  findResourcesInElements_(parentResource, elements, callback) {\n    for (const element of elements) {\n      devAssert(parentResource.element.contains(element));\n      this.discoverResourcesForElement_(element, callback);\n    }\n  }\n\n  /**\n   * @param {!Element} element\n   * @param {function(!Resource)} callback\n   */\n  discoverResourcesForElement_(element, callback) {\n    // Breadth-first search.\n    if (element.classList.contains('i-amphtml-element')) {\n      callback(this.resources_.getResourceForElement(element));\n      // Also schedule amp-element that is a placeholder for the element.\n      const placeholder = element.getPlaceholder();\n      if (placeholder) {\n        this.discoverResourcesForElement_(placeholder, callback);\n      }\n    } else {\n      const ampElements = element.getElementsByClassName('i-amphtml-element');\n      const seen = [];\n      for (let i = 0; i < ampElements.length; i++) {\n        const ampElement = ampElements[i];\n        let covered = false;\n        for (let j = 0; j < seen.length; j++) {\n          if (seen[j].contains(ampElement)) {\n            covered = true;\n            break;\n          }\n        }\n        if (!covered) {\n          seen.push(ampElement);\n          callback(this.resources_.getResourceForElement(ampElement));\n        }\n      }\n    }\n  }\n\n  /**\n   * Schedules layout or preload for the sub-resources of the specified\n   * resource.\n   * @param {!Resource} parentResource\n   * @param {boolean} layout\n   * @param {!Array<!Element>} subElements\n   * @private\n   */\n  scheduleLayoutOrPreloadForSubresources_(parentResource, layout, subElements) {\n    this.findResourcesInElements_(parentResource, subElements, (resource) => {\n      resource.element.ensureLoaded(parentResource.getLayoutPriority());\n    });\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installOwnersServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'owners', OwnersImpl);\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {WindowInterface} from '../src/core/window/interface';\nimport {createElementWithAttributes} from '../src/dom';\nimport {dict} from '../src/core/types/object';\nimport {user} from '../src/log';\n\n/** @const {string} */\nconst TAG = 'pixel';\n\n/**\n * @param {!Window} win\n * @param {string} src\n * @param {?string=} referrerPolicy\n * @return {!Element}\n */\nexport function createPixel(win, src, referrerPolicy) {\n  // Caller need to verify window is not destroyed when creating pixel\n  if (referrerPolicy && referrerPolicy !== 'no-referrer') {\n    user().error(TAG, 'Unsupported referrerPolicy: %s', referrerPolicy);\n  }\n\n  return referrerPolicy === 'no-referrer'\n    ? createNoReferrerPixel(win, src)\n    : createImagePixel(win, src);\n}\n\n/**\n * @param {!Window} win\n * @param {string} src\n * @return {!Element}\n */\nfunction createNoReferrerPixel(win, src) {\n  if (isReferrerPolicySupported()) {\n    return createImagePixel(win, src, true);\n  } else {\n    // if \"referrerPolicy\" is not supported, use iframe wrapper\n    // to scrub the referrer.\n    const iframe = createElementWithAttributes(\n      /** @type {!Document} */ (win.document),\n      'iframe',\n      dict({\n        'src': 'about:blank',\n        'style': 'display:none',\n      })\n    );\n    iframe.onload = () => {\n      createImagePixel(iframe.contentWindow, src);\n    };\n    win.document.body.appendChild(iframe);\n    return iframe;\n  }\n}\n\n/**\n * @param {!Window} win\n * @param {string} src\n * @param {boolean=} noReferrer\n * @return {!Image}\n */\nfunction createImagePixel(win, src, noReferrer = false) {\n  const Image = WindowInterface.getImage(win);\n  const image = new Image();\n  if (noReferrer) {\n    image.referrerPolicy = 'no-referrer';\n  }\n  image.src = src;\n  return image;\n}\n\n/**\n * Check if element attribute \"referrerPolicy\" is supported by the browser.\n * Safari 11.1 does not support it yet.\n *\n * @return {boolean}\n */\nfunction isReferrerPolicySupported() {\n  return 'referrerPolicy' in Image.prototype;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from '../../src/base-element';\nimport {Services} from '../../src/services';\nimport {createPixel} from '../../src/pixel';\nimport {dev, userAssert} from '../../src/log';\nimport {registerElement} from '../../src/service/custom-element-registry';\n\nconst TAG = 'amp-pixel';\n\n/**\n * A simple analytics instrument. Fires as an impression signal.\n */\nexport class AmpPixel extends BaseElement {\n  /** @override */\n  constructor(element) {\n    super(element);\n\n    /** @private {?Promise<!Image>} */\n    this.triggerPromise_ = null;\n  }\n\n  /** @override */\n  isLayoutSupported(unusedLayout) {\n    // No matter what layout is: the pixel is always non-displayed.\n    return true;\n  }\n\n  /** @override */\n  buildCallback() {\n    // Element is invisible.\n    this.element.setAttribute('aria-hidden', 'true');\n\n    /** @private {?string} */\n    this.referrerPolicy_ = this.element.getAttribute('referrerpolicy');\n    if (this.referrerPolicy_) {\n      // Safari doesn't support referrerPolicy yet. We're using an\n      // iframe based trick to remove referrer, which apparently can\n      // only do \"no-referrer\".\n      userAssert(\n        this.referrerPolicy_ == 'no-referrer',\n        `${TAG}: invalid \"referrerpolicy\" value \"${this.referrerPolicy_}\".` +\n          ' Only \"no-referrer\" is supported'\n      );\n    }\n    if (\n      this.element.hasAttribute('i-amphtml-ssr') &&\n      this.element.querySelector('img')\n    ) {\n      dev().info(TAG, 'inabox img already present');\n      return;\n    }\n    // Trigger, but only when visible.\n    this.getAmpDoc().whenFirstVisible().then(this.trigger_.bind(this));\n  }\n\n  /**\n   * Triggers the signal.\n   * @return {*} TODO(#23582): Specify return type\n   * @private\n   */\n  trigger_() {\n    if (this.triggerPromise_) {\n      // TODO(dvoytenko, #8780): monitor, confirm if there's a bug and remove.\n      dev().error(TAG, 'duplicate pixel');\n      return this.triggerPromise_;\n    }\n    // Delay(1) provides a rudimentary \"idle\" signal.\n    // TODO(dvoytenko): use an improved idle signal when available.\n    this.triggerPromise_ = Services.timerFor(this.win)\n      .promise(1)\n      .then(() => {\n        const src = this.element.getAttribute('src');\n        if (!src) {\n          return;\n        }\n        return Services.urlReplacementsForDoc(this.element)\n          .expandUrlAsync(this.assertSource_(src))\n          .then((src) => {\n            if (!this.win) {\n              return;\n            }\n            const pixel = createPixel(this.win, src, this.referrerPolicy_);\n            dev().info(TAG, 'pixel triggered: ', src);\n            return pixel;\n          });\n      });\n  }\n\n  /**\n   * @param {?string} src\n   * @return {string}\n   * @private\n   */\n  assertSource_(src) {\n    userAssert(\n      /^(https\\:\\/\\/|\\/\\/)/i.test(src),\n      'The <amp-pixel> src attribute must start with ' +\n        '\"https://\" or \"//\". Invalid value: ' +\n        src\n    );\n    return /** @type {string} */ (src);\n  }\n}\n\n/**\n * @param {!Window} win Destination window for the new element.\n */\nexport function installPixel(win) {\n  registerElement(win, TAG, AmpPixel);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {registerServiceBuilder} from '../service';\n\n/**\n * A helper class that provides information about device/OS/browser currently\n * running.\n */\nexport class Platform {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const @private {!Navigator} */\n    this.navigator_ = /** @type {!Navigator} */ (win.navigator);\n\n    /** @const @private */\n    this.win_ = win;\n  }\n\n  /**\n   * Whether the current platform an Android device.\n   * @return {boolean}\n   */\n  isAndroid() {\n    return /Android/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current platform an iOS device.\n   * @return {boolean}\n   */\n  isIos() {\n    return /iPhone|iPad|iPod/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current browser is Safari.\n   * @return {boolean}\n   */\n  isSafari() {\n    return (\n      /Safari/i.test(this.navigator_.userAgent) &&\n      !this.isChrome() &&\n      !this.isIe() &&\n      !this.isEdge() &&\n      !this.isFirefox() &&\n      !this.isOpera()\n    );\n  }\n\n  /**\n   * Whether the current browser is a Chrome browser.\n   * @return {boolean}\n   */\n  isChrome() {\n    // Also true for MS Edge :)\n    return (\n      /Chrome|CriOS/i.test(this.navigator_.userAgent) &&\n      !this.isEdge() &&\n      !this.isOpera()\n    );\n  }\n\n  /**\n   * Whether the current browser is a Firefox browser.\n   * @return {boolean}\n   */\n  isFirefox() {\n    return /Firefox|FxiOS/i.test(this.navigator_.userAgent) && !this.isEdge();\n  }\n\n  /**\n   * Whether the current browser is an Opera browser.\n   * @return {boolean}\n   */\n  isOpera() {\n    // Chrome UA on Android may include OPR<v> (build code referring to Oreo),\n    // however real Opera puts put a / after OPR and that's the only tell, so\n    // we check for OPR/ instead of OPR\n    return /OPR\\/|Opera|OPiOS/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current browser is a IE browser.\n   * @return {boolean}\n   */\n  isIe() {\n    if (IS_ESM) {\n      return false;\n    }\n    return /Trident|MSIE|IEMobile/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current browser is an Edge browser.\n   * @return {boolean}\n   */\n  isEdge() {\n    return /Edge/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current browser is based on the WebKit engine.\n   * @return {boolean}\n   */\n  isWebKit() {\n    return /WebKit/i.test(this.navigator_.userAgent) && !this.isEdge();\n  }\n\n  /**\n   * Whether the current browser is running on Windows.\n   * @return {boolean}\n   */\n  isWindows() {\n    return /Windows/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current browser is isStandalone.\n   * @return {boolean}\n   */\n  isStandalone() {\n    return (\n      (this.isIos() && this.navigator_.standalone) ||\n      (this.isChrome() &&\n        this.win_.matchMedia('(display-mode: standalone)').matches)\n    );\n  }\n\n  /**\n   * Whether the current platform matches a bot user agent.\n   * @return {boolean}\n   */\n  isBot() {\n    return /bot/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Returns the major version of the browser.\n   * @return {number}\n   */\n  getMajorVersion() {\n    if (this.isSafari()) {\n      return this.isIos()\n        ? this.getIosMajorVersion() || 0\n        : this.evalMajorVersion_(/\\sVersion\\/(\\d+)/, 1);\n    }\n    if (this.isChrome()) {\n      return this.evalMajorVersion_(/(Chrome|CriOS)\\/(\\d+)/, 2);\n    }\n    if (this.isFirefox()) {\n      return this.evalMajorVersion_(/(Firefox|FxiOS)\\/(\\d+)/, 2);\n    }\n    if (this.isOpera()) {\n      return this.evalMajorVersion_(/(OPR|Opera|OPiOS)\\/(\\d+)/, 2);\n    }\n    if (this.isIe()) {\n      return this.evalMajorVersion_(/MSIE\\s(\\d+)/, 1);\n    }\n    if (this.isEdge()) {\n      return this.evalMajorVersion_(/Edge\\/(\\d+)/, 1);\n    }\n    return 0;\n  }\n\n  /**\n   * @param {!RegExp} expr\n   * @param {number} index The index in the result that's interpreted as the\n   *   major version (integer).\n   * @return {number}\n   */\n  evalMajorVersion_(expr, index) {\n    if (!this.navigator_.userAgent) {\n      return 0;\n    }\n    const res = this.navigator_.userAgent.match(expr);\n    if (!res || index >= res.length) {\n      return 0;\n    }\n    return parseInt(res[index], 10);\n  }\n\n  /**\n   * Returns the minor ios version in string.\n   * The ios version can contain two numbers (10.2) or three numbers (10.2.1).\n   * Direct string equality check is not suggested, use startWith instead.\n   * @return {string}\n   */\n  getIosVersionString() {\n    if (!this.navigator_.userAgent) {\n      return '';\n    }\n    if (!this.isIos()) {\n      return '';\n    }\n    let version = this.navigator_.userAgent.match(\n      /OS ([0-9]+[_.][0-9]+([_.][0-9]+)?)\\b/\n    );\n    if (!version) {\n      return '';\n    }\n    version = version[1].replace(/_/g, '.');\n    return version;\n  }\n\n  /**\n   * Returns the major ios version in number.\n   * @return {?number}\n   */\n  getIosMajorVersion() {\n    const currentIosVersion = this.getIosVersionString();\n    if (currentIosVersion == '') {\n      return null;\n    }\n    return Number(currentIosVersion.split('.')[0]);\n  }\n}\n\n/**\n * @param {!Window} window\n */\nexport function installPlatformService(window) {\n  registerServiceBuilder(window, 'platform', Platform);\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether the document is ready.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isDocumentReady(doc) {\n  return doc.readyState != 'loading' && doc.readyState != 'uninitialized';\n}\n\n/**\n * Whether the document has loaded all the css and sub-resources.\n * @param {!Document} doc\n * @return {boolean}\n */\nfunction isDocumentComplete(doc) {\n  return doc.readyState == 'complete';\n}\n\n/**\n * Calls the callback when document is ready.\n * @param {!Document} doc\n * @param {function(!Document)} callback\n */\nexport function onDocumentReady(doc, callback) {\n  onDocumentState(doc, isDocumentReady, callback);\n}\n\n/**\n * Calls the callback when document's state satisfies the stateFn.\n * @param {!Document} doc\n * @param {function(!Document):boolean} stateFn\n * @param {function(!Document)} callback\n */\nfunction onDocumentState(doc, stateFn, callback) {\n  let ready = stateFn(doc);\n  if (ready) {\n    callback(doc);\n  } else {\n    const readyListener = () => {\n      if (stateFn(doc)) {\n        if (!ready) {\n          ready = true;\n          callback(doc);\n        }\n        doc.removeEventListener('readystatechange', readyListener);\n      }\n    };\n    doc.addEventListener('readystatechange', readyListener);\n  }\n}\n\n/**\n * Returns a promise that is resolved when document is ready.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\nexport function whenDocumentReady(doc) {\n  return new Promise((resolve) => {\n    onDocumentReady(doc, resolve);\n  });\n}\n\n/**\n * Returns a promise that is resolved when document is complete.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\nexport function whenDocumentComplete(doc) {\n  return new Promise((resolve) => {\n    onDocumentState(doc, isDocumentComplete, resolve);\n  });\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Provides a services to preconnect to a url to warm up the\n * connection before the real request can be made.\n */\n\nimport {Services} from './services';\nimport {dev} from './log';\nimport {htmlFor} from './static-template';\nimport {parseUrlDeprecated} from './url';\nimport {registerServiceBuilder} from './service';\nimport {whenDocumentComplete} from './core/document-ready';\n\nconst ACTIVE_CONNECTION_TIMEOUT_MS = 180 * 1000;\nconst PRECONNECT_TIMEOUT_MS = 10 * 1000;\n\n/**\n * @typedef {{\n *   preload: (boolean|undefined),\n *   preconnect: (boolean|undefined)\n * }}\n */\nlet PreconnectFeaturesDef;\n\n/** @private {?PreconnectFeaturesDef} */\nlet preconnectFeatures = null;\n\n/**\n * Detect related features if feature detection is supported by the\n * browser. Even if this fails, the browser may support the feature.\n * @param {!Window} win\n * @return {!PreconnectFeaturesDef}\n */\nfunction getPreconnectFeatures(win) {\n  if (!preconnectFeatures) {\n    const linkTag = win.document.createElement('link');\n    const tokenList = linkTag['relList'];\n    linkTag.as = 'invalid-value';\n    if (!tokenList || !tokenList.supports) {\n      return {};\n    }\n    preconnectFeatures = {\n      preconnect: tokenList.supports('preconnect'),\n      preload: tokenList.supports('preload'),\n      onlyValidAs: linkTag.as != 'invalid-value',\n    };\n  }\n  return preconnectFeatures;\n}\n\n/**\n * @param {?PreconnectFeaturesDef} features\n */\nexport function setPreconnectFeaturesForTesting(features) {\n  preconnectFeatures = features;\n}\n\nexport class PreconnectService {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Document} */\n    this.document_ = win.document;\n\n    /** @private @const {!Element} */\n    this.head_ = dev().assertElement(win.document.head);\n    /**\n     * Origin we've preconnected to and when that connection\n     * expires as a timestamp in MS.\n     * @private @const {!Object<string, number>}\n     */\n    this.origins_ = {};\n    /**\n     * Urls we've prefetched.\n     * @private @const {!Object<string, boolean>}\n     */\n    this.urls_ = {};\n    /** @private @const {!./service/platform-impl.Platform}  */\n    this.platform_ = Services.platformFor(win);\n    // Mark current origin as preconnected.\n    this.origins_[parseUrlDeprecated(win.location.href).origin] = true;\n\n    /**\n     * Detect support for the given resource hints.\n     * Unfortunately not all browsers support this, so this can only\n     * be used as an affirmative signal.\n     * @private @const {!PreconnectFeaturesDef}\n     */\n    this.features_ = getPreconnectFeatures(win);\n\n    /** @private @const {!./service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(win);\n  }\n\n  /**\n   * Preconnects to a URL. Always also does a dns-prefetch because\n   * browser support for that is better.\n   *\n   * It is safe to call this method during prerender with any value,\n   * because no action will be performed until the doc is visible.\n   *\n   * It is safe to call this method with non-HTTP(s) URLs as other URLs\n   * are skipped.\n   *\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} url\n   * @param {boolean=} opt_alsoConnecting Set this flag if you also just\n   *    did or are about to connect to this host. This is for the case\n   *    where preconnect is issued immediate before or after actual connect\n   *    and preconnect is used to flatten a deep HTTP request chain.\n   *    E.g. when you preconnect to a host that an embed will connect to\n   *    when it is more fully rendered, you already know that the connection\n   *    will be used very soon.\n   */\n  url(ampdoc, url, opt_alsoConnecting) {\n    ampdoc.whenFirstVisible().then(() => {\n      this.url_(ampdoc, url, opt_alsoConnecting);\n    });\n  }\n\n  /**\n   * Preconnects to a URL. Always also does a dns-prefetch because\n   * browser support for that is better.\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} url\n   * @param {boolean=} opt_alsoConnecting Set this flag if you also just\n   *    did or are about to connect to this host. This is for the case\n   *    where preconnect is issued immediate before or after actual connect\n   *    and preconnect is used to flatten a deep HTTP request chain.\n   *    E.g. when you preconnect to a host that an embed will connect to\n   *    when it is more fully rendered, you already know that the connection\n   *    will be used very soon.\n   * @private\n   */\n  url_(ampdoc, url, opt_alsoConnecting) {\n    if (!this.isInterestingUrl_(url)) {\n      return;\n    }\n    const {origin} = parseUrlDeprecated(url);\n    const now = Date.now();\n    const lastPreconnectTimeout = this.origins_[origin];\n    if (lastPreconnectTimeout && now < lastPreconnectTimeout) {\n      if (opt_alsoConnecting) {\n        this.origins_[origin] = now + ACTIVE_CONNECTION_TIMEOUT_MS;\n      }\n      return;\n    }\n    // If we are about to use the connection, don't re-preconnect for\n    // 180 seconds.\n    const timeout = opt_alsoConnecting\n      ? ACTIVE_CONNECTION_TIMEOUT_MS\n      : PRECONNECT_TIMEOUT_MS;\n    this.origins_[origin] = now + timeout;\n    // If we know that preconnect is supported, there is no need to do\n    // dedicated dns-prefetch.\n    let dns;\n    if (!this.features_.preconnect) {\n      dns = this.document_.createElement('link');\n      dns.setAttribute('rel', 'dns-prefetch');\n      dns.setAttribute('href', origin);\n      this.head_.appendChild(dns);\n    }\n    const preconnect = this.document_.createElement('link');\n    preconnect.setAttribute('rel', 'preconnect');\n    preconnect.setAttribute('href', origin);\n    preconnect.setAttribute('referrerpolicy', 'origin');\n    this.head_.appendChild(preconnect);\n\n    // Remove the tags eventually to free up memory.\n    this.timer_.delay(() => {\n      if (dns && dns.parentNode) {\n        dns.parentNode.removeChild(dns);\n      }\n      if (preconnect.parentNode) {\n        preconnect.parentNode.removeChild(preconnect);\n      }\n    }, 10000);\n\n    this.preconnectPolyfill_(ampdoc, origin);\n  }\n\n  /**\n   * Asks the browser to preload a URL. Always also does a preconnect\n   * because browser support for that is better.\n   *\n   * It is safe to call this method during prerender with any value,\n   * because no action will be performed until the doc is visible.\n   *\n   * It is safe to call this method with non-HTTP(s) URLs as other URLs\n   * are skipped.\n   *\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} url\n   * @param {string=} opt_preloadAs\n   */\n  preload(ampdoc, url, opt_preloadAs) {\n    if (!this.isInterestingUrl_(url)) {\n      return;\n    }\n    if (this.urls_[url]) {\n      return;\n    }\n    this.urls_[url] = true;\n    this.url(ampdoc, url, /* opt_alsoConnecting */ true);\n    if (!this.features_.preload) {\n      return;\n    }\n    if (opt_preloadAs == 'document' && this.platform_.isSafari()) {\n      // Preloading documents currently does not work in Safari,\n      // because it\n      // - does not support preloading iframes\n      // - and uses a different cache for iframes (when loaded without\n      //   as attribute).\n      return;\n    }\n    ampdoc.whenFirstVisible().then(() => {\n      this.performPreload_(url);\n    });\n  }\n\n  /**\n   * Performs a preload using `<link rel=\"preload\">`.\n   * @param {string} url\n   * @private\n   */\n  performPreload_(url) {\n    const preload = htmlFor(this.document_)`\n        <link rel=\"preload\" referrerpolicy=\"origin\" />`;\n    preload.setAttribute('href', url);\n    // Do not set 'as' attribute to correct value for now, for 2 reasons\n    // - document value is not yet supported and dropped\n    // - script is blocked due to CSP.\n    // Due to spec change we now have to also preload with the \"as\"\n    // being set to `fetch` when it would previously would be empty.\n    // See https://github.com/w3c/preload/issues/80\n    // for details.\n    if (this.features_.onlyValidAs) {\n      preload.as = 'fetch';\n    } else {\n      preload.as = '';\n    }\n    this.head_.appendChild(preload);\n    // As opposed to preconnect we do not clean this tag up, because there is\n    // no expectation as to it having an immediate effect.\n  }\n\n  /**\n   * Skips over non HTTP/HTTPS URL.\n   * @param {string} url\n   * @return {boolean}\n   */\n  isInterestingUrl_(url) {\n    if (url.startsWith('https:') || url.startsWith('http:')) {\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Safari does not support preconnecting, but due to its significant\n   * performance benefits we implement this crude polyfill.\n   *\n   * We make an image connection to a \"well-known\" file on the origin adding\n   * a random query string to bust the cache (no caching because we do want to\n   * actually open the connection).\n   *\n   * This should get us an open SSL connection to these hosts and significantly\n   * speed up the next connections.\n   *\n   * The actual URL is expected to 404. If you see errors for\n   * amp_preconnect_polyfill in your DevTools console or server log:\n   * This is expected and fine to leave as is. Its fine to send a non 404\n   * response, but please make it small :)\n   *\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} origin\n   * @private\n   */\n  preconnectPolyfill_(ampdoc, origin) {\n    // Unfortunately there is no reliable way to feature detect whether\n    // preconnect is supported, so we do this only in Safari, which is\n    // the most important browser without support for it.\n    if (\n      this.features_.preconnect ||\n      !(this.platform_.isSafari() || this.platform_.isIos())\n    ) {\n      return;\n    }\n\n    // Don't attempt to preconnect for ACTIVE_CONNECTION_TIMEOUT_MS since\n    // we effectively create an active connection.\n    // TODO(@cramforce): Confirm actual http2 timeout in Safari.\n    const now = Date.now();\n    this.origins_[origin] = now + ACTIVE_CONNECTION_TIMEOUT_MS;\n    // Make the URL change whenever we want to make a new request,\n    // but make it stay stable in between. While a given page\n    // would not actually make a new request, another page might\n    // and with this it has the same URL. If (and that is a big if)\n    // the server responds with a cacheable response, this reduces\n    // requests we make. More importantly, though, it reduces URL\n    // entropy as seen by servers and thus allows reverse proxies\n    // (read CDNs) to respond more efficiently.\n    const cacheBust = now - (now % ACTIVE_CONNECTION_TIMEOUT_MS);\n    const url =\n      origin +\n      '/robots.txt?_AMP_safari_preconnect_polyfill_cachebust=' +\n      cacheBust;\n    const xhr = new XMLHttpRequest();\n    xhr.open('HEAD', url, true);\n    // We only support credentialed preconnect for now.\n    xhr.withCredentials = true;\n\n    xhr.send();\n  }\n}\n\n/**\n * @param {!Window} window\n */\nexport function installPreconnectService(window) {\n  registerServiceBuilder(window, 'preconnect', PreconnectService);\n}\n\n/**\n * Preconnects to the source URL and canonical domains to make sure\n * outbound navigations are quick. Waits for onload to avoid blocking\n * more high priority loads.\n * @param {!Document} document\n * @return {Promise} When work is done.\n */\nexport function preconnectToOrigin(document) {\n  return whenDocumentComplete(document).then(() => {\n    const win = document.defaultView;\n    if (win) {\n      const preconnect = Services.preconnectFor(win);\n      const info = Services.documentInfoForDoc(document.documentElement);\n      const ampdoc = Services.ampdoc(document);\n      preconnect.url(ampdoc, info.sourceUrl);\n      preconnect.url(ampdoc, info.canonicalUrl);\n    }\n  });\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../core/data-structures/promise';\nimport {FiniteStateMachine} from '../core/data-structures/finite-state-machine';\nimport {FocusHistory} from '../focus-history';\nimport {Pass} from '../pass';\nimport {READY_SCAN_SIGNAL, ResourcesInterface} from './resources-interface';\n\nimport {Resource, ResourceState} from './resource';\nimport {Services} from '../services';\nimport {TaskQueue} from './task-queue';\nimport {VisibilityState} from '../core/constants/visibility-state';\nimport {dev, devAssert} from '../log';\nimport {dict} from '../core/types/object';\nimport {expandLayoutRect} from '../core/math/layout-rect';\nimport {getSourceUrl} from '../url';\nimport {hasNextNodeInDocumentOrder} from '../dom';\nimport {ieIntrinsicCheckAndFix} from './ie-intrinsic-bug';\nimport {ieMediaCheckAndFix} from './ie-media-bug';\nimport {isBlockedByConsent, reportError} from '../error-reporting';\nimport {listen, loadPromise} from '../event-helper';\nimport {registerServiceBuilderForDoc} from '../service';\nimport {remove} from '../core/types/array';\nimport {startupChunk} from '../chunk';\nimport {throttle} from '../core/types/function';\n\nconst TAG_ = 'Resources';\nconst LAYOUT_TASK_ID_ = 'L';\nconst LAYOUT_TASK_OFFSET_ = 0;\nconst PRELOAD_TASK_ID_ = 'P';\nconst PRELOAD_TASK_OFFSET_ = 2;\nconst PRIORITY_BASE_ = 10;\nconst PRIORITY_PENALTY_TIME_ = 1000;\nconst POST_TASK_PASS_DELAY_ = 1000;\nconst MUTATE_DEFER_DELAY_ = 500;\nconst FOCUS_HISTORY_TIMEOUT_ = 1000 * 60; // 1min\nconst FOUR_FRAME_DELAY_ = 70;\n\n/**\n * @implements {ResourcesInterface}\n */\nexport class ResourcesImpl {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @const {!Window} */\n    this.win = ampdoc.win;\n\n    /** @const @private {!./viewer-interface.ViewerInterface} */\n    this.viewer_ = Services.viewerForDoc(ampdoc);\n\n    /** @private {boolean} */\n    this.isRuntimeOn_ = this.viewer_.isRuntimeOn();\n\n    /**\n     * Used primarily for testing to allow build phase to proceed.\n     * @const @private {boolean}\n     */\n    this.isBuildOn_ = false;\n\n    /** @private {number} */\n    this.resourceIdCounter_ = 0;\n\n    /** @private @const {!Array<!Resource>} */\n    this.resources_ = [];\n\n    /** @private {number} */\n    this.addCount_ = 0;\n\n    /** @private {number} */\n    this.buildAttemptsCount_ = 0;\n\n    /** @private {number} */\n    this.buildsThisPass_ = 0;\n\n    /** @private {boolean} */\n    this.visible_ = this.ampdoc.isVisible();\n\n    /** @private {boolean} */\n    this.documentReady_ = false;\n\n    /**\n     * We want to do some work in the first pass after\n     * the document is ready.\n     * @private {boolean}\n     */\n    this.firstPassAfterDocumentReady_ = true;\n\n    /**\n     * Whether AMP has been fully initialized.\n     * @private {boolean}\n     */\n    this.ampInitialized_ = false;\n\n    /**\n     * We also adjust the timeout penalty shortly after the first pass.\n     * @private {number}\n     */\n    this.firstVisibleTime_ = -1;\n\n    /** @private {boolean} */\n    this.relayoutAll_ = true;\n\n    /**\n     * @private {number}\n     */\n    this.relayoutTop_ = -1;\n\n    /** @private {time} */\n    this.lastScrollTime_ = 0;\n\n    /** @private {number} */\n    this.lastVelocity_ = 0;\n\n    /** @const @private {!Pass} */\n    this.pass_ = new Pass(this.win, () => this.doPass());\n\n    /** @const @private {!Pass} */\n    this.remeasurePass_ = new Pass(this.win, () => {\n      this.relayoutAll_ = true;\n      this.schedulePass();\n    });\n\n    /** @const {!TaskQueue} */\n    this.exec_ = new TaskQueue();\n\n    /** @const {!TaskQueue} */\n    this.queue_ = new TaskQueue();\n\n    /** @const {function(./task-queue.TaskDef):number} */\n    this.boundTaskScorer_ = this.calcTaskScore_.bind(this);\n\n    /**\n     * @private {!Array<!./resources-interface.ChangeSizeRequestDef>}\n     */\n    this.requestsChangeSize_ = [];\n\n    /** @private {?Array<!Resource>} */\n    this.pendingBuildResources_ = [];\n\n    /** @private {boolean} */\n    this.isCurrentlyBuildingPendingResources_ = false;\n\n    /** @private @const {!./viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(this.ampdoc);\n\n    /** @private @const {!./vsync-impl.Vsync} */\n    this.vsync_ = Services./*OK*/ vsyncFor(this.win);\n\n    /** @private @const {!FocusHistory} */\n    this.activeHistory_ = new FocusHistory(this.win, FOCUS_HISTORY_TIMEOUT_);\n\n    /** @private {boolean} */\n    this.vsyncScheduled_ = false;\n\n    /** @private {number} */\n    this.contentHeight_ = 0;\n\n    /** @private {boolean} */\n    this.maybeChangeHeight_ = false;\n\n    /** @const @private {!Array<function()>} */\n    this.passCallbacks_ = [];\n\n    /** @const @private {!Array<!Element>} */\n    this.elementsThatScrolled_ = [];\n\n    /** @const @private {!Deferred} */\n    this.firstPassDone_ = new Deferred();\n\n    /** @private @const {!FiniteStateMachine<!VisibilityState>} */\n    this.visibilityStateMachine_ = new FiniteStateMachine(\n      this.ampdoc.getVisibilityState()\n    );\n\n    // When user scrolling stops, run pass to check newly in-viewport elements.\n    // When viewport is resized, we have to re-measure everything.\n    this.viewport_.onChanged((event) => {\n      this.lastScrollTime_ = this.win.Date.now();\n      this.lastVelocity_ = event.velocity;\n      if (event.relayoutAll) {\n        this.relayoutAll_ = true;\n        this.maybeChangeHeight_ = true;\n      }\n\n      this.schedulePass();\n    });\n    this.viewport_.onScroll(() => {\n      this.lastScrollTime_ = this.win.Date.now();\n    });\n\n    // When document becomes visible, e.g. from \"prerender\" mode, do a\n    // simple pass.\n    this.ampdoc.onVisibilityChanged(() => {\n      if (this.firstVisibleTime_ == -1 && this.ampdoc.isVisible()) {\n        this.firstVisibleTime_ = this.win.Date.now();\n      }\n      this.schedulePass();\n    });\n\n    this.viewer_.onRuntimeState((state) => {\n      dev().fine(TAG_, 'Runtime state:', state);\n      this.isRuntimeOn_ = state;\n      this.schedulePass(1);\n    });\n\n    // Schedule initial passes. This must happen in a startup task\n    // to avoid blocking body visible.\n    startupChunk(this.ampdoc, () => {\n      this.setupVisibilityStateMachine_(this.visibilityStateMachine_);\n      this.schedulePass(0);\n    });\n\n    this.rebuildDomWhenReady_();\n\n    /** @private @const */\n    this.throttledScroll_ = throttle(this.win, (e) => this.scrolled_(e), 250);\n\n    listen(this.win.document, 'scroll', this.throttledScroll_, {\n      capture: true,\n      passive: true,\n    });\n  }\n\n  /** @private */\n  rebuildDomWhenReady_() {\n    // Ensure that we attempt to rebuild things when DOM is ready.\n    this.ampdoc.whenReady().then(() => {\n      this.documentReady_ = true;\n      this.buildReadyResources_();\n      this.pendingBuildResources_ = null;\n\n      const input = Services.inputFor(this.win);\n      input.setupInputModeClasses(this.ampdoc);\n\n      if (IS_ESM) {\n        return;\n      }\n\n      ieIntrinsicCheckAndFix(this.win);\n\n      const fixPromise = ieMediaCheckAndFix(this.win);\n      const remeasure = () => this.remeasurePass_.schedule();\n      if (fixPromise) {\n        fixPromise.then(remeasure);\n      } else {\n        // No promise means that there's no problem.\n        remeasure();\n      }\n\n      // Safari 10 and under incorrectly estimates font spacing for\n      // `@font-face` fonts. This leads to wild measurement errors. The best\n      // course of action is to remeasure everything on window.onload or font\n      // timeout (3s), whichever is earlier. This has to be done on the global\n      // window because this is where the fonts are always added.\n      // Unfortunately, `document.fonts.ready` cannot be used here due to\n      // https://bugs.webkit.org/show_bug.cgi?id=174030.\n      // See https://bugs.webkit.org/show_bug.cgi?id=174031 for more details.\n      Promise.race([\n        loadPromise(this.win),\n        Services.timerFor(this.win).promise(3100),\n      ]).then(remeasure);\n\n      // Remeasure the document when all fonts loaded.\n      if (\n        this.win.document.fonts &&\n        this.win.document.fonts.status != 'loaded'\n      ) {\n        this.win.document.fonts.ready.then(remeasure);\n      }\n    });\n  }\n\n  /** @override */\n  get() {\n    return this.resources_.slice(0);\n  }\n\n  /** @override */\n  getAmpdoc() {\n    return this.ampdoc;\n  }\n\n  /** @override */\n  getResourceForElement(element) {\n    return Resource.forElement(element);\n  }\n\n  /** @override */\n  getResourceForElementOptional(element) {\n    return Resource.forElementOptional(element);\n  }\n\n  /** @override */\n  getScrollDirection() {\n    return Math.sign(this.lastVelocity_) || 1;\n  }\n\n  /** @override */\n  add(element) {\n    // Ensure the viewport is ready to accept the first element.\n    this.addCount_++;\n    if (this.addCount_ == 1) {\n      this.viewport_.ensureReadyForElements();\n    }\n\n    // First check if the resource is being reparented and if it requires\n    // reconstruction. Only already built elements are eligible.\n    let resource = Resource.forElementOptional(element);\n    if (\n      resource &&\n      resource.getState() != ResourceState.NOT_BUILT &&\n      !element.reconstructWhenReparented()\n    ) {\n      resource.requestMeasure();\n      dev().fine(TAG_, 'resource reused:', resource.debugid);\n    } else {\n      // Create and add a new resource.\n      resource = new Resource(++this.resourceIdCounter_, element, this);\n      dev().fine(TAG_, 'resource added:', resource.debugid);\n    }\n    this.resources_.push(resource);\n    this.remeasurePass_.schedule(1000);\n  }\n\n  /**\n   * Limits the number of elements being build in pre-render phase to\n   * a finite number. Returns false if the number has been reached.\n   * @return {boolean}\n   */\n  isUnderBuildQuota_() {\n    // For pre-render we want to limit the amount of CPU used, so we limit\n    // the number of elements build. For pre-render to \"seem complete\"\n    // we only need to build elements in the first viewport. We can't know\n    // which are actually in the viewport (because the decision is pre-layout,\n    // so we use a heuristic instead.\n    // Most documents have 10 or less AMP tags. By building 20 we should not\n    // change the behavior for the vast majority of docs, and almost always\n    // catch everything in the first viewport.\n    return this.buildAttemptsCount_ < 20 || this.ampdoc.hasBeenVisible();\n  }\n\n  /**\n   * Builds the element if ready to be built, otherwise adds it to pending\n   * resources.\n   * @param {!Resource} resource\n   * @param {boolean=} checkForDupes\n   * @param {boolean=} ignoreQuota\n   * @private\n   */\n  buildOrScheduleBuildForResource_(\n    resource,\n    checkForDupes = false,\n    ignoreQuota = false\n  ) {\n    const buildingEnabled = this.isRuntimeOn_ || this.isBuildOn_;\n    if (!buildingEnabled) {\n      return;\n    }\n\n    // During prerender mode, don't build elements that aren't allowed to be\n    // prerendered. This avoids wasting our prerender build quota.\n    // See isUnderBuildQuota_() for more details.\n    const shouldBuildResource =\n      this.ampdoc.getVisibilityState() != VisibilityState.PRERENDER ||\n      resource.prerenderAllowed();\n    if (!shouldBuildResource) {\n      return;\n    }\n\n    if (this.documentReady_) {\n      // Build resource immediately, the document has already been parsed.\n      this.buildResourceUnsafe_(resource, ignoreQuota);\n    } else if (!resource.isBuilt() && !resource.isBuilding()) {\n      if (!checkForDupes || !this.pendingBuildResources_.includes(resource)) {\n        // Otherwise add to pending resources and try to build any ready ones.\n        this.pendingBuildResources_.push(resource);\n        this.buildReadyResources_();\n      }\n    }\n  }\n\n  /**\n   * Builds resources that are ready to be built.\n   * @private\n   */\n  buildReadyResources_() {\n    // Avoid cases where elements add more elements inside of them\n    // and cause an infinite loop of building - see #3354 for details.\n    if (this.isCurrentlyBuildingPendingResources_) {\n      return;\n    }\n    try {\n      this.isCurrentlyBuildingPendingResources_ = true;\n      this.buildReadyResourcesUnsafe_();\n    } finally {\n      this.isCurrentlyBuildingPendingResources_ = false;\n    }\n  }\n\n  /**\n   * @private\n   */\n  buildReadyResourcesUnsafe_() {\n    // This will loop over all current pending resources and those that\n    // get added by other resources build-cycle, this will make sure all\n    // elements get a chance to be built.\n    for (let i = 0; i < this.pendingBuildResources_.length; i++) {\n      const resource = this.pendingBuildResources_[i];\n      if (\n        this.documentReady_ ||\n        hasNextNodeInDocumentOrder(resource.element, this.ampdoc.getRootNode())\n      ) {\n        // Remove resource before build to remove it from the pending list\n        // in either case the build succeed or throws an error.\n        this.pendingBuildResources_.splice(i--, 1);\n        this.buildResourceUnsafe_(resource);\n      }\n    }\n  }\n\n  /**\n   * @param {!Resource} resource\n   * @param {boolean=} ignoreQuota\n   * @return {?Promise}\n   * @private\n   */\n  buildResourceUnsafe_(resource, ignoreQuota = false) {\n    if (\n      !ignoreQuota &&\n      !this.isUnderBuildQuota_() &&\n      // Special case: amp-experiment is allowed to bypass prerender build quota.\n      !resource.isBuildRenderBlocking()\n    ) {\n      return null;\n    }\n\n    const promise = resource.build();\n    if (!promise) {\n      return null;\n    }\n    dev().fine(TAG_, 'build resource:', resource.debugid);\n    this.buildAttemptsCount_++;\n    this.buildsThisPass_++;\n    return promise.then(\n      () => this.schedulePass(),\n      (error) => {\n        // Build failed: remove the resource. No other state changes are\n        // needed.\n        this.removeResource_(resource);\n        if (!isBlockedByConsent(error)) {\n          throw error;\n        }\n      }\n    );\n  }\n\n  /** @override */\n  remove(element) {\n    const resource = Resource.forElementOptional(element);\n    if (!resource) {\n      return;\n    }\n    this.removeResource_(resource);\n  }\n\n  /**\n   * @param {!Resource} resource\n   * @private\n   */\n  removeResource_(resource) {\n    const index = this.resources_.indexOf(resource);\n    if (index != -1) {\n      this.resources_.splice(index, 1);\n    }\n    if (resource.isBuilt()) {\n      resource.pauseOnRemove();\n    }\n\n    if (resource.getState() === ResourceState.LAYOUT_SCHEDULED) {\n      resource.layoutCanceled();\n    }\n    this.cleanupTasks_(resource, /* opt_removePending */ true);\n    dev().fine(TAG_, 'resource removed:', resource.debugid);\n  }\n\n  /** @override */\n  upgraded(element) {\n    const resource = Resource.forElement(element);\n    this.buildOrScheduleBuildForResource_(resource);\n    dev().fine(TAG_, 'resource upgraded:', resource.debugid);\n  }\n\n  /** @override */\n  updateLayoutPriority(element, newLayoutPriority) {\n    const resource = Resource.forElement(element);\n\n    resource.updateLayoutPriority(newLayoutPriority);\n\n    // Update affected tasks\n    this.queue_.forEach((task) => {\n      if (task.resource == resource) {\n        task.priority = newLayoutPriority;\n      }\n    });\n\n    this.schedulePass();\n  }\n\n  /** @override */\n  schedulePass(opt_delay) {\n    return this.pass_.schedule(opt_delay);\n  }\n\n  /** @override */\n  updateOrEnqueueMutateTask(resource, newRequest) {\n    let request = null;\n    for (let i = 0; i < this.requestsChangeSize_.length; i++) {\n      if (this.requestsChangeSize_[i].resource == resource) {\n        request = this.requestsChangeSize_[i];\n        break;\n      }\n    }\n    if (request) {\n      request.newHeight = newRequest.newHeight;\n      request.newWidth = newRequest.newWidth;\n      request.marginChange = newRequest.marginChange;\n      request.event = newRequest.event;\n      request.force = newRequest.force || request.force;\n      request.callback = newRequest.callback;\n    } else {\n      this.requestsChangeSize_.push(newRequest);\n    }\n  }\n\n  /** @override */\n  schedulePassVsync() {\n    if (this.vsyncScheduled_) {\n      return;\n    }\n    this.vsyncScheduled_ = true;\n    this.vsync_.mutate(() => this.doPass());\n  }\n\n  /** @override */\n  ampInitComplete() {\n    this.ampInitialized_ = true;\n    dev().fine(TAG_, 'ampInitComplete');\n    this.schedulePass();\n  }\n\n  /** @override */\n  setRelayoutTop(relayoutTop) {\n    if (this.relayoutTop_ == -1) {\n      this.relayoutTop_ = relayoutTop;\n    } else {\n      this.relayoutTop_ = Math.min(relayoutTop, this.relayoutTop_);\n    }\n  }\n\n  /** @override */\n  maybeHeightChanged() {\n    this.maybeChangeHeight_ = true;\n  }\n\n  /** @override */\n  onNextPass(callback) {\n    this.passCallbacks_.push(callback);\n  }\n\n  /**\n   * Runs a pass immediately.\n   *\n   * @visibleForTesting\n   */\n  doPass() {\n    if (!this.isRuntimeOn_) {\n      dev().fine(TAG_, 'runtime is off');\n      return;\n    }\n\n    this.visible_ = this.ampdoc.isVisible();\n    this.buildsThisPass_ = 0;\n\n    const firstPassAfterDocumentReady =\n      this.documentReady_ &&\n      this.firstPassAfterDocumentReady_ &&\n      this.ampInitialized_;\n    if (firstPassAfterDocumentReady) {\n      this.firstPassAfterDocumentReady_ = false;\n      const doc = this.win.document;\n      const documentInfo = Services.documentInfoForDoc(this.ampdoc);\n\n      // TODO(choumx, #26687): Update viewers to read data.viewport instead of\n      // data.metaTags.viewport from 'documentLoaded' message.\n      this.viewer_.sendMessage(\n        'documentLoaded',\n        dict({\n          'title': doc.title,\n          'sourceUrl': getSourceUrl(this.ampdoc.getUrl()),\n          'isStory': doc.body.firstElementChild?.tagName === 'AMP-STORY',\n          'serverLayout': doc.documentElement.hasAttribute('i-amphtml-element'),\n          'linkRels': documentInfo.linkRels,\n          'metaTags': {'viewport': documentInfo.viewport} /* deprecated */,\n          'viewport': documentInfo.viewport,\n        }),\n        /* cancelUnsent */ true\n      );\n\n      this.contentHeight_ = this.viewport_.getContentHeight();\n      this.viewer_.sendMessage(\n        'documentHeight',\n        dict({'height': this.contentHeight_}),\n        /* cancelUnsent */ true\n      );\n      dev().fine(TAG_, 'document height on load: %s', this.contentHeight_);\n    }\n\n    // Once we know the document is fully parsed, we check to see if every AMP Element has been built\n    const firstPassAfterAllBuilt =\n      !this.firstPassAfterDocumentReady_ &&\n      this.firstPassAfterAllBuilt_ &&\n      this.resources_.every(\n        (r) => r.getState() != Resource.NOT_BUILT || r.element.R1()\n      );\n    if (firstPassAfterAllBuilt) {\n      this.firstPassAfterAllBuilt_ = false;\n      this.maybeChangeHeight_ = true;\n    }\n\n    const viewportSize = this.viewport_.getSize();\n    dev().fine(\n      TAG_,\n      'PASS: visible=',\n      this.visible_,\n      ', relayoutAll=',\n      this.relayoutAll_,\n      ', relayoutTop=',\n      this.relayoutTop_,\n      ', viewportSize=',\n      viewportSize.width,\n      viewportSize.height\n    );\n    this.pass_.cancel();\n    this.vsyncScheduled_ = false;\n\n    this.visibilityStateMachine_.setState(this.ampdoc.getVisibilityState());\n\n    this.signalIfReady_();\n\n    if (this.maybeChangeHeight_) {\n      this.maybeChangeHeight_ = false;\n      this.vsync_.measure(() => {\n        const measuredContentHeight = this.viewport_.getContentHeight();\n        if (measuredContentHeight != this.contentHeight_) {\n          this.viewer_.sendMessage(\n            'documentHeight',\n            dict({'height': measuredContentHeight}),\n            /* cancelUnsent */ true\n          );\n          this.contentHeight_ = measuredContentHeight;\n          dev().fine(TAG_, 'document height changed: %s', this.contentHeight_);\n          this.viewport_.contentHeightChanged();\n        }\n      });\n    }\n\n    for (let i = 0; i < this.passCallbacks_.length; i++) {\n      const fn = this.passCallbacks_[i];\n      fn();\n    }\n    this.passCallbacks_.length = 0;\n  }\n\n  /**\n   * If (1) the document is fully parsed, (2) the AMP runtime (services etc.)\n   * is initialized, and (3) we did a first pass on element measurements,\n   * then fire the \"ready\" signal.\n   * @private\n   */\n  signalIfReady_() {\n    if (\n      this.documentReady_ &&\n      this.ampInitialized_ &&\n      !this.ampdoc.signals().get(READY_SCAN_SIGNAL)\n    ) {\n      // This signal mainly signifies that most of elements have been measured\n      // by now. This is mostly used to avoid measuring too many elements\n      // individually. May not be called in shadow mode.\n      this.ampdoc.signals().signal(READY_SCAN_SIGNAL);\n      dev().fine(TAG_, 'signal: ready-scan');\n    }\n  }\n\n  /**\n   * Returns `true` when there's mutate work currently batched.\n   * @return {boolean}\n   * @private\n   */\n  hasMutateWork_() {\n    return this.requestsChangeSize_.length > 0;\n  }\n\n  /**\n   * Performs pre-discovery mutates.\n   * @private\n   */\n  mutateWork_() {\n    // Read all necessary data before mutates.\n    // The height changing depends largely on the target element's position\n    // in the active viewport. When not in prerendering, we also consider the\n    // active viewport the part of the visible viewport below 10% from the top\n    // and above 25% from the bottom.\n    // This is basically the portion of the viewport where the reader is most\n    // likely focused right now. The main goal is to avoid drastic UI changes\n    // in that part of the content. The elements below the active viewport are\n    // freely resized. The elements above the viewport are resized and request\n    // scroll adjustment to avoid active viewport changing without user's\n    // action. The elements in the active viewport are not resized and instead\n    // the overflow callbacks are called.\n    const now = this.win.Date.now();\n    const viewportRect = this.viewport_.getRect();\n    const topOffset = viewportRect.height / 10;\n    const bottomOffset = viewportRect.height / 10;\n    const isScrollingStopped =\n      (Math.abs(this.lastVelocity_) < 1e-2 &&\n        now - this.lastScrollTime_ > MUTATE_DEFER_DELAY_) ||\n      now - this.lastScrollTime_ > MUTATE_DEFER_DELAY_ * 2;\n\n    if (this.requestsChangeSize_.length > 0) {\n      dev().fine(\n        TAG_,\n        'change size requests:',\n        this.requestsChangeSize_.length\n      );\n      const requestsChangeSize = this.requestsChangeSize_;\n      this.requestsChangeSize_ = [];\n\n      // Find minimum top position and run all mutates.\n      let minTop = -1;\n      const scrollAdjSet = [];\n      let aboveVpHeightChange = 0;\n      for (let i = 0; i < requestsChangeSize.length; i++) {\n        const request = requestsChangeSize[i];\n        const {event, resource} =\n          /** @type {!./resources-interface.ChangeSizeRequestDef} */ (request);\n        const box = resource.getLayoutBox();\n\n        let topMarginDiff = 0;\n        let bottomMarginDiff = 0;\n        let leftMarginDiff = 0;\n        let rightMarginDiff = 0;\n        let {bottom: bottomDisplacedBoundary, top: topUnchangedBoundary} = box;\n        let newMargins = undefined;\n        if (request.marginChange) {\n          newMargins = request.marginChange.newMargins;\n          const margins = request.marginChange.currentMargins;\n          if (newMargins.top != undefined) {\n            topMarginDiff = newMargins.top - margins.top;\n          }\n          if (newMargins.bottom != undefined) {\n            bottomMarginDiff = newMargins.bottom - margins.bottom;\n          }\n          if (newMargins.left != undefined) {\n            leftMarginDiff = newMargins.left - margins.left;\n          }\n          if (newMargins.right != undefined) {\n            rightMarginDiff = newMargins.right - margins.right;\n          }\n          if (topMarginDiff) {\n            topUnchangedBoundary = box.top - margins.top;\n          }\n          if (bottomMarginDiff) {\n            // The lowest boundary of the element that would appear to be\n            // resized as a result of this size change. If the bottom margin is\n            // being changed then it is the bottom edge of the margin box,\n            // otherwise it is the bottom edge of the layout box as set above.\n            bottomDisplacedBoundary = box.bottom + margins.bottom;\n          }\n        }\n        const heightDiff = request.newHeight - box.height;\n        const widthDiff = request.newWidth - box.width;\n\n        // Check resize rules. It will either resize element immediately, or\n        // wait until scrolling stops or will call the overflow callback.\n        let resize = false;\n        if (\n          heightDiff == 0 &&\n          topMarginDiff == 0 &&\n          bottomMarginDiff == 0 &&\n          widthDiff == 0 &&\n          leftMarginDiff == 0 &&\n          rightMarginDiff == 0\n        ) {\n          // 1. Nothing to resize.\n        } else if (request.force || !this.visible_) {\n          // 2. An immediate execution requested or the document is hidden.\n          resize = true;\n        } else if (\n          this.activeHistory_.hasDescendantsOf(resource.element) ||\n          (event && event.userActivation && event.userActivation.hasBeenActive)\n        ) {\n          // 3. Active elements are immediately resized. The assumption is that\n          // the resize is triggered by the user action or soon after.\n          resize = true;\n        } else if (\n          topUnchangedBoundary >= viewportRect.bottom - bottomOffset ||\n          (topMarginDiff == 0 &&\n            box.bottom + Math.min(heightDiff, 0) >=\n              viewportRect.bottom - bottomOffset)\n        ) {\n          // 4. Elements under viewport are resized immediately, but only if\n          // an element's boundary is not changed above the viewport after\n          // resize.\n          resize = true;\n        } else if (\n          viewportRect.top > 1 &&\n          bottomDisplacedBoundary <= viewportRect.top + topOffset\n        ) {\n          // 5. Elements above the viewport can only be resized if we are able\n          // to compensate the height change by setting scrollTop and only if\n          // the page has already been scrolled by some amount (1px due to iOS).\n          // Otherwise the scrolling might move important things like the menu\n          // bar out of the viewport at initial page load.\n          if (\n            heightDiff < 0 &&\n            viewportRect.top + aboveVpHeightChange < -heightDiff\n          ) {\n            // Do nothing if height abobe viewport height can't compensate\n            // height decrease\n            continue;\n          }\n          // Can only resized when scrolling has stopped,\n          // otherwise defer util next cycle.\n          if (isScrollingStopped) {\n            // These requests will be executed in the next animation cycle and\n            // adjust the scroll position.\n            aboveVpHeightChange = aboveVpHeightChange + heightDiff;\n            scrollAdjSet.push(request);\n          } else {\n            // Defer till next cycle.\n            this.requestsChangeSize_.push(request);\n          }\n          continue;\n        } else if (this.elementNearBottom_(resource, box)) {\n          // 6. Elements close to the bottom of the document (not viewport)\n          // are resized immediately.\n          resize = true;\n        } else if (\n          heightDiff < 0 ||\n          topMarginDiff < 0 ||\n          bottomMarginDiff < 0\n        ) {\n          // 7. The new height (or one of the margins) is smaller than the\n          // current one.\n        } else if (request.newHeight == box.height) {\n          // 8. Element is in viewport, but this is a width-only expansion.\n          // Check whether this should be reflow-free, in which case,\n          // schedule a size change.\n          this.vsync_.run(\n            {\n              measure: (state) => {\n                state.resize = false;\n                const parent = resource.element.parentElement;\n                if (!parent) {\n                  return;\n                }\n\n                // If the element has siblings, it's possible that a width-expansion will\n                // cause some of them to be pushed down.\n                const parentWidth =\n                  (parent.getLayoutSize && parent.getLayoutSize().width) ||\n                  parent./*OK*/ offsetWidth;\n                let cumulativeWidth = widthDiff;\n                for (let i = 0; i < parent.childElementCount; i++) {\n                  cumulativeWidth += parent.children[i]./*OK*/ offsetWidth;\n                  if (cumulativeWidth > parentWidth) {\n                    return;\n                  }\n                }\n                state.resize = true;\n              },\n              mutate: (state) => {\n                if (state.resize) {\n                  request.resource.changeSize(\n                    request.newHeight,\n                    request.newWidth,\n                    newMargins\n                  );\n                }\n                request.resource.overflowCallback(\n                  /* overflown */ !state.resize,\n                  request.newHeight,\n                  request.newWidth,\n                  newMargins\n                );\n              },\n            },\n            {}\n          );\n        } else {\n          // 9. Element is in viewport don't resize and try overflow callback\n          // instead.\n          request.resource.overflowCallback(\n            /* overflown */ true,\n            request.newHeight,\n            request.newWidth,\n            newMargins\n          );\n        }\n\n        if (resize) {\n          if (box.top >= 0) {\n            minTop = minTop == -1 ? box.top : Math.min(minTop, box.top);\n          }\n          request.resource.changeSize(\n            request.newHeight,\n            request.newWidth,\n            newMargins\n          );\n          request.resource.overflowCallback(\n            /* overflown */ false,\n            request.newHeight,\n            request.newWidth,\n            newMargins\n          );\n          this.maybeChangeHeight_ = true;\n        }\n\n        if (request.callback) {\n          request.callback(/* hasSizeChanged */ resize);\n        }\n      }\n\n      if (minTop != -1) {\n        this.setRelayoutTop(minTop);\n      }\n\n      // Execute scroll-adjusting resize requests, if any.\n      if (scrollAdjSet.length > 0) {\n        this.vsync_.run(\n          {\n            measure: (state) => {\n              state./*OK*/ scrollHeight =\n                this.viewport_./*OK*/ getScrollHeight();\n              state./*OK*/ scrollTop = this.viewport_./*OK*/ getScrollTop();\n            },\n            mutate: (state) => {\n              let minTop = -1;\n              scrollAdjSet.forEach((request) => {\n                const box = request.resource.getLayoutBox();\n                minTop = minTop == -1 ? box.top : Math.min(minTop, box.top);\n                request.resource.changeSize(\n                  request.newHeight,\n                  request.newWidth,\n                  request.marginChange\n                    ? request.marginChange.newMargins\n                    : undefined\n                );\n                if (request.callback) {\n                  request.callback(/* hasSizeChanged */ true);\n                }\n              });\n              if (minTop != -1) {\n                this.setRelayoutTop(minTop);\n              }\n              // Sync is necessary here to avoid UI jump in the next frame.\n              const newScrollHeight = this.viewport_./*OK*/ getScrollHeight();\n              if (newScrollHeight != state./*OK*/ scrollHeight) {\n                this.viewport_.setScrollTop(\n                  state./*OK*/ scrollTop +\n                    (newScrollHeight - state./*OK*/ scrollHeight)\n                );\n              }\n              this.maybeChangeHeight_ = true;\n            },\n          },\n          {}\n        );\n      }\n    }\n  }\n\n  /**\n   * Returns true if element is within 15% and 1000px of document bottom.\n   * Caller can provide current/initial layout boxes as an optimization.\n   * @param {!./resource.Resource} resource\n   * @param {!../layout-rect.LayoutRectDef=} opt_layoutBox\n   * @param {!../layout-rect.LayoutRectDef=} opt_initialLayoutBox\n   * @return {boolean}\n   * @private\n   */\n  elementNearBottom_(resource, opt_layoutBox, opt_initialLayoutBox) {\n    const contentHeight = this.viewport_.getContentHeight();\n    const threshold = Math.max(contentHeight * 0.85, contentHeight - 1000);\n\n    const box = opt_layoutBox || resource.getLayoutBox();\n    const initialBox = opt_initialLayoutBox || resource.getInitialLayoutBox();\n    return box.bottom >= threshold || initialBox.bottom >= threshold;\n  }\n\n  /**\n   * Always returns true unless the resource was previously displayed but is\n   * not displayed now (i.e. the resource should be unloaded).\n   * @param {!Resource} r\n   * @return {boolean}\n   * @private\n   */\n  measureResource_(r) {\n    const wasDisplayed = r.isDisplayed();\n    r.measure();\n    return !(wasDisplayed && !r.isDisplayed());\n  }\n\n  /**\n   * Unloads given resources in an async mutate phase.\n   * @param {!Array<!Resource>} resources\n   * @private\n   */\n  unloadResources_(resources) {\n    if (resources.length) {\n      this.vsync_.mutate(() => {\n        resources.forEach((r) => {\n          r.unload();\n          this.cleanupTasks_(r);\n        });\n        dev().fine(TAG_, 'unload:', resources);\n      });\n    }\n  }\n\n  /**\n   * Discovers work that needs to be done since the last pass. If viewport\n   * has changed, it will try to build new elements, measure changed elements,\n   * and schedule layouts and preloads within a reasonable distance of the\n   * current viewport. Finally, this process also updates inViewport state\n   * of changed elements.\n   *\n   * Layouts and preloads are not executed immediately, but instead scheduled\n   * in the queue with different priorities.\n   *\n   * @private\n   */\n  discoverWork_() {\n    // TODO(dvoytenko): vsync separation may be needed for different phases\n\n    const now = this.win.Date.now();\n\n    // Ensure all resources layout phase complete; when relayoutAll is requested\n    // force re-layout.\n    const {\n      elementsThatScrolled_: elementsThatScrolled,\n      relayoutAll_: relayoutAll,\n      relayoutTop_: relayoutTop,\n    } = this;\n    this.relayoutAll_ = false;\n    this.relayoutTop_ = -1;\n\n    // Phase 1: Build and relayout as needed. All mutations happen here.\n    let relayoutCount = 0;\n    let remeasureCount = 0;\n    for (let i = 0; i < this.resources_.length; i++) {\n      const r = this.resources_[i];\n      if (\n        r.getState() == ResourceState.NOT_BUILT &&\n        !r.isBuilding() &&\n        !r.element.R1()\n      ) {\n        this.buildOrScheduleBuildForResource_(r, /* checkForDupes */ true);\n      }\n\n      if (\n        relayoutAll ||\n        !r.hasBeenMeasured() ||\n        // NOT_LAID_OUT is the state after build() but before measure().\n        r.getState() == ResourceState.NOT_LAID_OUT\n      ) {\n        relayoutCount++;\n      }\n      if (r.isMeasureRequested()) {\n        remeasureCount++;\n      }\n    }\n\n    // Phase 2: Remeasure if there were any relayouts. Unfortunately, currently\n    // there's no way to optimize this. All reads happen here.\n    let toUnload;\n    if (\n      relayoutCount > 0 ||\n      remeasureCount > 0 ||\n      relayoutAll ||\n      relayoutTop != -1 ||\n      elementsThatScrolled.length > 0\n    ) {\n      for (let i = 0; i < this.resources_.length; i++) {\n        const r = this.resources_[i];\n        if ((r.hasOwner() && !r.isMeasureRequested()) || r.element.R1()) {\n          // If element has owner, and measure is not requested, do nothing.\n          continue;\n        }\n        let needsMeasure =\n          relayoutAll ||\n          r.getState() == ResourceState.NOT_LAID_OUT ||\n          !r.hasBeenMeasured() ||\n          r.isMeasureRequested() ||\n          (relayoutTop != -1 && r.getLayoutBox().bottom >= relayoutTop);\n\n        if (!needsMeasure) {\n          for (let i = 0; i < elementsThatScrolled.length; i++) {\n            // TODO(jridgewell): Need to figure out how ShadowRoots and FIEs\n            // should behave in this model. If the ShadowRoot's host scrolls,\n            // do we need to invalidate inside the shadow or light tree? Or if\n            // the FIE's iframe parent scrolls, do we?\n            if (elementsThatScrolled[i].contains(r.element)) {\n              needsMeasure = true;\n              break;\n            }\n          }\n        }\n\n        if (needsMeasure) {\n          const isDisplayed = this.measureResource_(r);\n          if (!isDisplayed) {\n            if (!toUnload) {\n              toUnload = [];\n            }\n            toUnload.push(r);\n          }\n        }\n      }\n    }\n    elementsThatScrolled.length = 0;\n\n    // Unload all in one cycle.\n    if (toUnload) {\n      this.unloadResources_(toUnload);\n    }\n\n    const viewportRect = this.viewport_.getRect();\n    // Load viewport = viewport + 3x up/down when document is visible.\n    let loadRect;\n    if (this.visible_) {\n      loadRect = expandLayoutRect(viewportRect, 0.25, 2);\n    } else {\n      loadRect = viewportRect;\n    }\n\n    const visibleRect = this.visible_\n      ? // When the doc is visible, consider the viewport to be 25% larger,\n        // to minimize effect from small scrolling and notify things that\n        // they are in viewport just before they are actually visible.\n        expandLayoutRect(viewportRect, 0.25, 0.25)\n      : viewportRect;\n\n    // Phase 3: Set inViewport status for resources.\n    for (let i = 0; i < this.resources_.length; i++) {\n      const r = this.resources_[i];\n      if (\n        r.getState() == ResourceState.NOT_BUILT ||\n        r.hasOwner() ||\n        r.element.R1()\n      ) {\n        continue;\n      }\n      // Note that when the document is not visible, neither are any of its\n      // elements to reduce CPU cycles.\n      // TODO(dvoytenko, #3434): Reimplement the use of `isFixed` with\n      // layers. This is currently a short-term fix to the problem that\n      // the fixed elements get incorrect top coord.\n      const shouldBeInViewport =\n        this.visible_ && r.isDisplayed() && r.overlaps(visibleRect);\n      r.setInViewport(shouldBeInViewport);\n    }\n\n    // Phase 4: Schedule elements for layout within a reasonable distance from\n    // current viewport.\n    if (loadRect) {\n      for (let i = 0; i < this.resources_.length; i++) {\n        const r = this.resources_[i];\n        // TODO(dvoytenko): This extra build has to be merged with the\n        // scheduleLayoutOrPreload method below.\n        // Build all resources visible, measured, and in the viewport.\n        if (\n          !r.isBuilt() &&\n          !r.isBuilding() &&\n          !r.hasOwner() &&\n          !r.element.R1() &&\n          r.hasBeenMeasured() &&\n          r.isDisplayed() &&\n          r.overlaps(loadRect)\n        ) {\n          this.buildOrScheduleBuildForResource_(\n            r,\n            /* checkForDupes */ true,\n            /* ignoreQuota */ true\n          );\n        }\n        if (r.getState() != ResourceState.READY_FOR_LAYOUT || r.hasOwner()) {\n          continue;\n        }\n        // TODO(dvoytenko, #3434): Reimplement the use of `isFixed` with\n        // layers. This is currently a short-term fix to the problem that\n        // the fixed elements get incorrect top coord.\n        if (r.isDisplayed() && r.overlaps(loadRect)) {\n          this.scheduleLayoutOrPreload(r, /* layout */ true);\n        }\n      }\n    }\n\n    if (this.visible_ && this.isIdle_(now)) {\n      // Phase 5: Idle Render Outside Viewport layout: layout up to 4 items\n      // with idleRenderOutsideViewport true\n      let idleScheduledCount = 0;\n      for (\n        let i = 0;\n        i < this.resources_.length && idleScheduledCount < 4;\n        i++\n      ) {\n        const r = this.resources_[i];\n        if (\n          r.getState() == ResourceState.READY_FOR_LAYOUT &&\n          !r.hasOwner() &&\n          !r.element.R1() &&\n          r.isDisplayed() &&\n          r.idleRenderOutsideViewport()\n        ) {\n          dev().fine(TAG_, 'idleRenderOutsideViewport layout:', r.debugid);\n          this.scheduleLayoutOrPreload(r, /* layout */ false);\n          idleScheduledCount++;\n        }\n      }\n      // Phase 6: Idle layout: layout more if we are otherwise not doing much.\n      // TODO(dvoytenko): document/estimate IDLE timeouts and other constants\n      for (\n        let i = 0;\n        i < this.resources_.length && idleScheduledCount < 4;\n        i++\n      ) {\n        const r = this.resources_[i];\n        if (\n          r.getState() == ResourceState.READY_FOR_LAYOUT &&\n          !r.hasOwner() &&\n          !r.element.R1() &&\n          r.isDisplayed()\n        ) {\n          dev().fine(TAG_, 'idle layout:', r.debugid);\n          this.scheduleLayoutOrPreload(r, /* layout */ false);\n          idleScheduledCount++;\n        }\n      }\n    }\n  }\n\n  /**\n   * Whether the page is relatively \"idle\". For now, it's checking if it's been\n   * a while since the last element received a layoutCallback.\n   *\n   * @param {number} now\n   * @return {boolean}\n   * @private\n   */\n  isIdle_(now = Date.now()) {\n    const lastDequeueTime = this.exec_.getLastDequeueTime();\n    return (\n      this.exec_.getSize() == 0 &&\n      this.queue_.getSize() == 0 &&\n      now > lastDequeueTime + 5000 &&\n      lastDequeueTime > 0\n    );\n  }\n\n  /**\n   * Dequeues layout and preload tasks from the queue and initiates their\n   * execution.\n   *\n   * There are two main drivers to dequeueing: a task's score and timeout. The\n   * score is built based on the resource's priority and viewport location\n   * (see {@link calcTaskScore_}). Timeout depends on the priority and age\n   * of tasks currently in the execution pool (see {@link calcTaskTimeout_}).\n   *\n   * @return {!time}\n   * @private\n   */\n  work_() {\n    const now = this.win.Date.now();\n\n    let timeout = -1;\n    let task = this.queue_.peek(this.boundTaskScorer_);\n    while (task) {\n      timeout = this.calcTaskTimeout_(task);\n      dev().fine(\n        TAG_,\n        'peek from queue:',\n        task.id,\n        'sched at',\n        task.scheduleTime,\n        'score',\n        this.boundTaskScorer_(task),\n        'timeout',\n        timeout\n      );\n      if (timeout > 16) {\n        break;\n      }\n\n      this.queue_.dequeue(task);\n\n      // Do not override a task in execution. This task will have to wait\n      // until the current one finished the execution.\n      const executing = this.exec_.getTaskById(task.id);\n      if (executing) {\n        // Reschedule post execution.\n        const reschedule = this.reschedule_.bind(this, task);\n        executing.promise.then(reschedule, reschedule);\n      } else {\n        const {resource} = task;\n\n        const stillDisplayed = true;\n        // Remeasure can only update isDisplayed(), not in-viewport state.\n        resource.measure();\n\n        // Check if the element has exited the viewport or the page has changed\n        // visibility since the layout was scheduled.\n        if (\n          stillDisplayed &&\n          this.isLayoutAllowed_(resource, task.forceOutsideViewport)\n        ) {\n          task.promise = task.callback();\n          task.startTime = now;\n          dev().fine(TAG_, 'exec:', task.id, 'at', task.startTime);\n          this.exec_.enqueue(task);\n          task.promise\n            .then(\n              this.taskComplete_.bind(this, task, true),\n              this.taskComplete_.bind(this, task, false)\n            )\n            .catch(/** @type {function (*)} */ (reportError));\n        } else {\n          dev().fine(TAG_, 'cancelled', task.id);\n          resource.layoutCanceled();\n        }\n      }\n\n      task = this.queue_.peek(this.boundTaskScorer_);\n      timeout = -1;\n    }\n\n    dev().fine(\n      TAG_,\n      'queue size:',\n      this.queue_.getSize(),\n      'exec size:',\n      this.exec_.getSize()\n    );\n\n    if (timeout >= 0) {\n      // Still tasks in the queue, but we took too much time.\n      // Schedule the next work pass.\n      return timeout;\n    }\n\n    // No tasks left in the queue.\n    // Schedule the next idle pass.\n    let nextPassDelay = (now - this.exec_.getLastDequeueTime()) * 2;\n    nextPassDelay = Math.max(Math.min(30000, nextPassDelay), 5000);\n    return nextPassDelay;\n  }\n\n  /**\n   * Calculates the task's score. A task with the lowest score will be dequeued\n   * from the queue the first.\n   *\n   * There are three components of the score: element's priority, operation or\n   * offset priority and viewport priority.\n   *\n   * Element's priority is constant of the element's name. E.g. amp-img has a\n   * priority of 0, while amp-ad has a priority of 2.\n   *\n   * The operation (offset) priority is the priority of the task. A layout is\n   * a high-priority task while preload is a lower-priority task.\n   *\n   * Viewport priority is a function of the distance of the element from the\n   * currently visible viewports. The elements in the visible viewport get\n   * higher priority and further away from the viewport get lower priority.\n   * This priority also depends on whether or not the user is scrolling towards\n   * this element or away from it.\n   *\n   * @param {!./task-queue.TaskDef} task\n   * @return {number}\n   * @private\n   */\n  calcTaskScore_(task) {\n    // TODO(jridgewell): these should be taking into account the active\n    // scroller, which may not be the root scroller. Maybe a weighted average\n    // of \"scroller scrolls necessary\" to see the element.\n    // Demo at https://output.jsbin.com/hicigom/quiet\n    const viewport = this.viewport_.getRect();\n    const box = task.resource.getLayoutBox();\n    let posPriority = Math.floor((box.top - viewport.top) / viewport.height);\n    if (Math.sign(posPriority) != this.getScrollDirection()) {\n      posPriority *= 2;\n    }\n    posPriority = Math.abs(posPriority);\n    return task.priority * PRIORITY_BASE_ + posPriority;\n  }\n\n  /**\n   * Calculates the timeout of a task. The timeout depends on two main factors:\n   * the priorities of the tasks currently in the execution pool and their age.\n   * The timeout is calculated against each task in the execution pool and the\n   * maximum value is returned.\n   *\n   * A task is penalized with higher timeout values when it's lower in priority\n   * than the task in the execution pool. However, this penalty is judged\n   * against the age of the executing task. If it has been in executing for\n   * some time, the penalty is reduced.\n   *\n   * @param {!./task-queue.TaskDef} task\n   * @private\n   */\n  calcTaskTimeout_(task) {\n    const now = this.win.Date.now();\n\n    if (this.exec_.getSize() == 0) {\n      // If we've never been visible, return 0. This follows the previous\n      // behavior of not delaying tasks when there's nothing to do.\n      if (this.firstVisibleTime_ === -1) {\n        return 0;\n      }\n\n      // Scale off the first visible time, so penalized tasks must wait a\n      // second or two to run. After we have been visible for a time, we no\n      // longer have to wait.\n      const penalty = task.priority * PRIORITY_PENALTY_TIME_;\n      return Math.max(penalty - (now - this.firstVisibleTime_), 0);\n    }\n\n    let timeout = 0;\n    this.exec_.forEach((other) => {\n      // Higher priority tasks get the head start. Currently 500ms per a drop\n      // in priority (note that priority is 10-based).\n      const penalty = Math.max(\n        (task.priority - other.priority) * PRIORITY_PENALTY_TIME_,\n        0\n      );\n      // TODO(dvoytenko): Consider running total and not maximum.\n      timeout = Math.max(timeout, penalty - (now - other.startTime));\n    });\n\n    return timeout;\n  }\n\n  /**\n   * @param {!./task-queue.TaskDef} task\n   * @private\n   */\n  reschedule_(task) {\n    if (!this.queue_.getTaskById(task.id)) {\n      this.queue_.enqueue(task);\n    }\n  }\n\n  /**\n   * @param {!./task-queue.TaskDef} task\n   * @param {boolean} success\n   * @param {*=} opt_reason\n   * @return {!Promise|undefined}\n   * @private\n   */\n  taskComplete_(task, success, opt_reason) {\n    this.exec_.dequeue(task);\n    this.schedulePass(POST_TASK_PASS_DELAY_);\n    if (!success) {\n      dev().info(\n        TAG_,\n        'task failed:',\n        task.id,\n        task.resource.debugid,\n        opt_reason\n      );\n      return Promise.reject(opt_reason);\n    }\n  }\n\n  /**\n   * Returns whether the resource should be preloaded at this time.\n   * The element must be measured by this time.\n   * @param {!Resource} resource\n   * @param {boolean} forceOutsideViewport\n   * @return {boolean}\n   * @private\n   */\n  isLayoutAllowed_(resource, forceOutsideViewport) {\n    // Only built and displayed elements can be loaded.\n    if (\n      resource.getState() == ResourceState.NOT_BUILT ||\n      !resource.isDisplayed()\n    ) {\n      return false;\n    }\n\n    // Don't schedule elements when we're not visible, or in prerender mode\n    // (and they can't prerender).\n    if (!this.visible_) {\n      if (\n        this.ampdoc.getVisibilityState() != VisibilityState.PRERENDER ||\n        !resource.prerenderAllowed()\n      ) {\n        return false;\n      }\n    }\n\n    // The element has to be in its rendering corridor.\n    if (\n      !forceOutsideViewport &&\n      !resource.isInViewport() &&\n      !resource.renderOutsideViewport() &&\n      !resource.idleRenderOutsideViewport()\n    ) {\n      return false;\n    }\n\n    return true;\n  }\n\n  /** @override */\n  scheduleLayoutOrPreload(\n    resource,\n    layout,\n    opt_parentPriority,\n    opt_forceOutsideViewport\n  ) {\n    if (resource.element.R1()) {\n      return;\n    }\n    const isBuilt = resource.getState() != ResourceState.NOT_BUILT;\n    const isDisplayed = resource.isDisplayed();\n    if (!isBuilt || !isDisplayed) {\n      devAssert(\n        false,\n        'Not ready for layout: %s (%s)',\n        resource.debugid,\n        resource.getState()\n      );\n    }\n    const forceOutsideViewport = opt_forceOutsideViewport || false;\n    if (!this.isLayoutAllowed_(resource, forceOutsideViewport)) {\n      return;\n    }\n\n    if (layout) {\n      this.schedule_(\n        resource,\n        LAYOUT_TASK_ID_,\n        LAYOUT_TASK_OFFSET_,\n        opt_parentPriority || 0,\n        forceOutsideViewport,\n        resource.startLayout.bind(resource)\n      );\n    } else {\n      this.schedule_(\n        resource,\n        PRELOAD_TASK_ID_,\n        PRELOAD_TASK_OFFSET_,\n        opt_parentPriority || 0,\n        forceOutsideViewport,\n        resource.startLayout.bind(resource)\n      );\n    }\n  }\n\n  /**\n   * Schedules a task.\n   * @param {!Resource} resource\n   * @param {string} localId\n   * @param {number} priorityOffset\n   * @param {number} parentPriority\n   * @param {boolean} forceOutsideViewport\n   * @param {function():!Promise} callback\n   * @private\n   */\n  schedule_(\n    resource,\n    localId,\n    priorityOffset,\n    parentPriority,\n    forceOutsideViewport,\n    callback\n  ) {\n    const taskId = resource.getTaskId(localId);\n\n    const task = {\n      id: taskId,\n      resource,\n      priority:\n        Math.max(resource.getLayoutPriority(), parentPriority) + priorityOffset,\n      forceOutsideViewport,\n      callback,\n      scheduleTime: this.win.Date.now(),\n      startTime: 0,\n      promise: null,\n    };\n    dev().fine(TAG_, 'schedule:', task.id, 'at', task.scheduleTime);\n\n    // Only schedule a new task if there's no one enqueued yet or if this task\n    // has a higher priority.\n    const queued = this.queue_.getTaskById(taskId);\n    if (!queued || task.priority < queued.priority) {\n      if (queued) {\n        this.queue_.dequeue(queued);\n      }\n      this.queue_.enqueue(task);\n      this.schedulePass(this.calcTaskTimeout_(task));\n    }\n    task.resource.layoutScheduled(task.scheduleTime);\n  }\n\n  /**\n   * @return {!Promise} when first pass executed.\n   */\n  whenFirstPass() {\n    return this.firstPassDone_.promise;\n  }\n\n  /**\n   * Calls iterator on each sub-resource\n   * @param {!FiniteStateMachine<!VisibilityState>} vsm\n   */\n  setupVisibilityStateMachine_(vsm) {\n    const {\n      HIDDEN: hidden,\n      INACTIVE: inactive,\n      PAUSED: paused,\n      PRERENDER: prerender,\n      VISIBLE: visible,\n    } = VisibilityState;\n    const doWork = () => {\n      // If viewport size is 0, the manager will wait for the resize event.\n      const viewportSize = this.viewport_.getSize();\n      if (viewportSize.height > 0 && viewportSize.width > 0) {\n        // 1. Handle all size-change requests. 1x mutate (+1 vsync measure/mutate for above-fold resizes).\n        if (this.hasMutateWork_()) {\n          this.mutateWork_();\n        }\n        // 2. Build/measure/in-viewport/schedule layouts. 1x mutate & measure.\n        this.discoverWork_();\n        // 3. Execute scheduled layouts and preloads. 1x mutate.\n        let delay = this.work_();\n        // 4. Deferred size-change requests (waiting for scrolling to stop) will shorten delay until next pass.\n        if (this.hasMutateWork_()) {\n          // Overflow mutate work.\n          delay = Math.min(delay, MUTATE_DEFER_DELAY_);\n        }\n        if (this.visible_) {\n          if (this.schedulePass(delay)) {\n            dev().fine(TAG_, 'next pass:', delay);\n          } else {\n            dev().fine(TAG_, 'pass already scheduled');\n          }\n        } else {\n          dev().fine(TAG_, 'document is not visible: no scheduling');\n        }\n        this.firstPassDone_.resolve();\n      }\n    };\n    const noop = () => {};\n    const pause = () => {\n      this.resources_.forEach((r) => r.pause());\n    };\n    const unload = () => {\n      this.resources_.forEach((r) => {\n        r.unload();\n        this.cleanupTasks_(r);\n      });\n      this.unselectText_();\n    };\n    const resume = () => {\n      this.resources_.forEach((r) => r.resume());\n      doWork();\n    };\n\n    vsm.addTransition(prerender, prerender, doWork);\n    vsm.addTransition(prerender, visible, doWork);\n    vsm.addTransition(prerender, hidden, doWork);\n    vsm.addTransition(prerender, inactive, doWork);\n    vsm.addTransition(prerender, paused, doWork);\n\n    vsm.addTransition(visible, visible, doWork);\n    vsm.addTransition(visible, hidden, doWork);\n    vsm.addTransition(visible, inactive, unload);\n    vsm.addTransition(visible, paused, pause);\n\n    vsm.addTransition(hidden, visible, doWork);\n    vsm.addTransition(hidden, hidden, doWork);\n    vsm.addTransition(hidden, inactive, unload);\n    vsm.addTransition(hidden, paused, pause);\n\n    vsm.addTransition(inactive, visible, resume);\n    vsm.addTransition(inactive, hidden, resume);\n    vsm.addTransition(inactive, inactive, noop);\n    vsm.addTransition(inactive, paused, doWork);\n\n    vsm.addTransition(paused, visible, resume);\n    vsm.addTransition(paused, hidden, doWork);\n    vsm.addTransition(paused, inactive, unload);\n    vsm.addTransition(paused, paused, noop);\n  }\n\n  /**\n   * Unselects any selected text\n   * @private\n   */\n  unselectText_() {\n    try {\n      this.win.getSelection().removeAllRanges();\n    } catch (e) {\n      // Selection API not supported.\n    }\n  }\n\n  /**\n   * Cleanup task queues from tasks for elements that has been unloaded.\n   * @param {Resource} resource\n   * @param {boolean=} opt_removePending Whether to remove from pending\n   *     build resources.\n   * @private\n   */\n  cleanupTasks_(resource, opt_removePending) {\n    if (\n      resource.getState() == ResourceState.NOT_LAID_OUT ||\n      resource.getState() == ResourceState.READY_FOR_LAYOUT\n    ) {\n      // If the layout promise for this resource has not resolved yet, remove\n      // it from the task queues to make sure this resource can be rescheduled\n      // for layout again later on.\n      // TODO(mkhatib): Think about how this might affect preload tasks once the\n      // prerender change is in.\n      this.queue_.purge((task) => {\n        return task.resource == resource;\n      });\n      this.exec_.purge((task) => {\n        return task.resource == resource;\n      });\n      remove(this.requestsChangeSize_, (request) => {\n        return request.resource === resource;\n      });\n    }\n\n    if (\n      resource.getState() == ResourceState.NOT_BUILT &&\n      opt_removePending &&\n      this.pendingBuildResources_\n    ) {\n      const pendingIndex = this.pendingBuildResources_.indexOf(resource);\n      if (pendingIndex != -1) {\n        this.pendingBuildResources_.splice(pendingIndex, 1);\n      }\n    }\n  }\n\n  /**\n   * Listens for scroll events on elements (not the root scroller), and marks\n   * them for invalidating all child layout boxes. This is to support native\n   * scrolling elements outside amp-components.\n   *\n   * @param {!Event} event\n   */\n  scrolled_(event) {\n    const {target} = event;\n    // If the target of the scroll event is an element, that means that element\n    // is an overflow scroller.\n    // If the target is the document itself, that means the native root\n    // scroller (`document.scrollingElement`) did the scrolling.\n    if (target.nodeType !== Node.ELEMENT_NODE) {\n      return;\n    }\n    // In iOS <= 12, the scroll hacks cause the scrolling element to be\n    // reported as the target, instead of the document.\n    if (target === this.viewport_.getScrollingElement()) {\n      return;\n    }\n\n    const scrolled = dev().assertElement(target);\n    if (!this.elementsThatScrolled_.includes(scrolled)) {\n      this.elementsThatScrolled_.push(scrolled);\n      this.schedulePass(FOUR_FRAME_DELAY_);\n    }\n  }\n}\n\n/**\n * The internal structure of a ChangeHeightRequest.\n * @typedef {{\n *   height: (number|undefined),\n *   width: (number|undefined),\n *   margins: (!../layout-rect.LayoutMarginsChangeDef|undefined)\n * }}\n */\nexport let SizeDef;\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installResourcesServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'resources', ResourcesImpl);\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ActionTrust} from '../core/constants/action-constants';\nimport {Layout, getLayoutClass} from '../layout';\nimport {Services} from '../services';\nimport {computedStyle, toggle} from '../style';\nimport {dev, user, userAssert} from '../log';\nimport {getAmpdoc, registerServiceBuilderForDoc} from '../service';\nimport {isFiniteNumber} from '../core/types';\nimport {toWin} from '../core/window';\nimport {tryFocus} from '../dom';\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nfunction isShowable(element) {\n  return element.hasAttribute('hidden');\n}\n\n/**\n * @param {!Element} element\n * @return {?Element}\n * @visibleForTesting\n */\nexport function getAutofocusElementForShowAction(element) {\n  if (element.hasAttribute('autofocus')) {\n    return element;\n  }\n  return element.querySelector('[autofocus]');\n}\n\n/** @const {string} */\nconst TAG = 'STANDARD-ACTIONS';\n\n/**\n * Regular expression that identifies AMP CSS classes with 'i-amphtml-' prefixes.\n * @type {!RegExp}\n */\nconst AMP_CSS_RE = /^i-amphtml-/;\n\n/**\n * This service contains implementations of some of the most typical actions,\n * such as hiding DOM elements.\n * @visibleForTesting\n */\nexport class StandardActions {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    const context = ampdoc.getHeadNode();\n\n    /** @const @private {!./mutator-interface.MutatorInterface} */\n    this.mutator_ = Services.mutatorForDoc(ampdoc);\n\n    /** @const @private {!./viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(ampdoc);\n\n    // Explicitly not setting `Action` as a member to scope installation to one\n    // method and for bundle size savings. \uD83D\uDCB0\n    this.installActions_(Services.actionServiceForDoc(context));\n  }\n\n  /**\n   * @param {!./action-impl.ActionService} actionService\n   * @private\n   */\n  installActions_(actionService) {\n    actionService.addGlobalTarget('AMP', this.handleAmpTarget_.bind(this));\n\n    // All standard actions require high trust by default via\n    // addGlobalMethodHandler.\n\n    actionService.addGlobalMethodHandler('hide', this.handleHide_.bind(this));\n\n    actionService.addGlobalMethodHandler('show', this.handleShow_.bind(this));\n\n    actionService.addGlobalMethodHandler(\n      'toggleVisibility',\n      this.handleToggle_.bind(this)\n    );\n\n    actionService.addGlobalMethodHandler(\n      'scrollTo',\n      this.handleScrollTo_.bind(this)\n    );\n\n    actionService.addGlobalMethodHandler('focus', this.handleFocus_.bind(this));\n\n    actionService.addGlobalMethodHandler(\n      'toggleClass',\n      this.handleToggleClass_.bind(this)\n    );\n  }\n\n  /**\n   * Handles global `AMP` actions.\n   * See `amp-actions-and-events.md` for details.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @throws If the invocation method is unrecognized.\n   * @private Visible to tests only.\n   */\n  handleAmpTarget_(invocation) {\n    // All global `AMP` actions require default trust.\n    if (!invocation.satisfiesTrust(ActionTrust.DEFAULT)) {\n      return null;\n    }\n    const {args, method, node} = invocation;\n    const win = getWin(node);\n    switch (method) {\n      case 'pushState':\n      case 'setState':\n        const element =\n          node.nodeType === Node.DOCUMENT_NODE\n            ? /** @type {!Document} */ (node).documentElement\n            : dev().assertElement(node);\n        return Services.bindForDocOrNull(element).then((bind) => {\n          userAssert(bind, 'AMP-BIND is not installed.');\n          return bind.invoke(invocation);\n        });\n\n      case 'navigateTo':\n        return this.handleNavigateTo_(invocation);\n\n      case 'closeOrNavigateTo':\n        return this.handleCloseOrNavigateTo_(invocation);\n\n      case 'scrollTo':\n        userAssert(args['id'], 'AMP.scrollTo must provide element ID');\n        invocation.node = dev().assertElement(\n          getAmpdoc(node).getElementById(args['id']),\n          'scrollTo element ID must exist on page'\n        );\n        return this.handleScrollTo_(invocation);\n\n      case 'goBack':\n        Services.historyForDoc(this.ampdoc).goBack(\n          /* navigate */ !!(args && args['navigate'] === true)\n        );\n        return null;\n\n      case 'print':\n        win.print();\n        return null;\n\n      case 'optoutOfCid':\n        return Services.cidForDoc(this.ampdoc)\n          .then((cid) => cid.optOut())\n          .catch((reason) => {\n            dev().error(TAG, 'Failed to opt out of CID', reason);\n          });\n    }\n    throw user().createError('Unknown AMP action ', method);\n  }\n\n  /**\n   * Handles the `navigateTo` action.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {!Promise}\n   * @private Visible to tests only.\n   */\n  handleNavigateTo_(invocation) {\n    const {args, caller, method, node} = invocation;\n    const win = getWin(node);\n    // Some components have additional constraints on allowing navigation.\n    let permission = Promise.resolve();\n    if (caller.tagName.startsWith('AMP-')) {\n      const ampElement = /** @type {!AmpElement} */ (caller);\n      permission = ampElement.getImpl().then((impl) => {\n        if (typeof impl.throwIfCannotNavigate == 'function') {\n          impl.throwIfCannotNavigate();\n        }\n      });\n    }\n    return permission.then(\n      () => {\n        Services.navigationForDoc(this.ampdoc).navigateTo(\n          win,\n          args['url'],\n          `AMP.${method}`,\n          {target: args['target'], opener: args['opener']}\n        );\n      },\n      /* onrejected */ (e) => {\n        user().error(TAG, e);\n      }\n    );\n  }\n\n  /**\n   * Handles the `handleCloseOrNavigateTo_` action.\n   * This action tries to close the requesting window if allowed, otherwise\n   * navigates the window.\n   *\n   * Window can be closed only from top-level documents that have an opener.\n   * Without an opener or if embedded, it will deny the close method.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {!Promise}\n   * @private Visible to tests only.\n   */\n  handleCloseOrNavigateTo_(invocation) {\n    const {node} = invocation;\n    const win = getWin(node);\n\n    // Don't allow closing if embedded in iframe or does not have an opener or\n    // embedded in a multi-doc shadowDOM case.\n    // Note that browser denies win.close in some of these cases already anyway,\n    // so not every check here is strictly needed but works as a short-circuit.\n    const hasParent = win.parent != win;\n    const canBeClosed = win.opener && this.ampdoc.isSingleDoc() && !hasParent;\n\n    let wasClosed = false;\n    if (canBeClosed) {\n      // Browser may still deny win.close() call, that would be reflected\n      // synchronously in win.closed\n      win.close();\n      wasClosed = win.closed;\n    }\n\n    if (!wasClosed) {\n      return this.handleNavigateTo_(invocation);\n    }\n\n    return Promise.resolve();\n  }\n  /**\n   * Handles the `scrollTo` action where given an element, we smooth scroll to\n   * it with the given animation duration.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleScrollTo_(invocation) {\n    const node = dev().assertElement(invocation.node);\n    const {args} = invocation;\n\n    // Duration and position are optional.\n    // Default values are set by the viewport service, so they're passed through\n    // when undefined or invalid.\n    let posOrUndef = args && args['position'];\n    let durationOrUndef = args && args['duration'];\n\n    if (posOrUndef && !['top', 'bottom', 'center'].includes(posOrUndef)) {\n      posOrUndef = undefined;\n    }\n\n    if (!isFiniteNumber(durationOrUndef)) {\n      durationOrUndef = undefined;\n    }\n\n    // Animate the scroll\n    // Should return a promise instead of null\n    return this.viewport_.animateScrollIntoView(\n      node,\n      posOrUndef,\n      durationOrUndef\n    );\n  }\n\n  /**\n   * Handles the `focus` action where given an element, we give it focus\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleFocus_(invocation) {\n    const node = dev().assertElement(invocation.node);\n\n    // Set focus\n    tryFocus(node);\n\n    return null;\n  }\n\n  /**\n   * Handles \"hide\" action. This is a very simple action where \"display: none\"\n   * is applied to the target element.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleHide_(invocation) {\n    const target = dev().assertElement(invocation.node);\n\n    if (target.classList.contains('i-amphtml-element')) {\n      const ampElement = /** @type {!AmpElement} */ (target);\n      this.mutator_.mutateElement(\n        ampElement,\n        () => ampElement./*OK*/ collapse(),\n        // It is safe to skip measuring, because `mutator-impl.collapseElement`\n        // will set the size of the element as well as trigger a remeasure of\n        // everything below the collapsed element.\n        /* skipRemeasure */ true\n      );\n    } else {\n      this.mutator_.mutateElement(target, () => toggle(target, false));\n    }\n\n    return null;\n  }\n\n  /**\n   * Handles \"show\" action. This is a very simple action where \"display: none\"\n   * is removed from the target element.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleShow_(invocation) {\n    const {node} = invocation;\n    const target = dev().assertElement(node);\n    const ownerWindow = toWin(target.ownerDocument.defaultView);\n\n    if (target.classList.contains(getLayoutClass(Layout.NODISPLAY))) {\n      user().warn(\n        TAG,\n        'Elements with layout=nodisplay cannot be dynamically shown.',\n        target\n      );\n      return null;\n    }\n\n    this.mutator_.measureElement(() => {\n      if (\n        computedStyle(ownerWindow, target).display == 'none' &&\n        !isShowable(target)\n      ) {\n        user().warn(\n          TAG,\n          'Elements can only be dynamically shown when they have the ' +\n            '\"hidden\" attribute set or when they were dynamically hidden.',\n          target\n        );\n      }\n    });\n\n    const autofocusElOrNull = getAutofocusElementForShowAction(target);\n\n    // iOS only honors focus in sync operations.\n    if (autofocusElOrNull && Services.platformFor(ownerWindow).isIos()) {\n      this.handleShowSync_(target, autofocusElOrNull);\n      this.mutator_.mutateElement(target, () => {}); // force a remeasure\n    } else {\n      this.mutator_.mutateElement(target, () => {\n        this.handleShowSync_(target, autofocusElOrNull);\n      });\n    }\n\n    return null;\n  }\n\n  /**\n   * @param {!Element} target\n   * @param {?Element} autofocusElOrNull\n   * @private Visible to tests only.\n   */\n  handleShowSync_(target, autofocusElOrNull) {\n    if (target.classList.contains('i-amphtml-element')) {\n      const ampElement = /** @type {!AmpElement} */ (target);\n      ampElement./*OK*/ expand();\n    } else {\n      toggle(target, true);\n    }\n    if (autofocusElOrNull) {\n      tryFocus(autofocusElOrNull);\n    }\n  }\n\n  /**\n   * Handles \"toggle\" action.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleToggle_(invocation) {\n    if (isShowable(dev().assertElement(invocation.node))) {\n      return this.handleShow_(invocation);\n    }\n    return this.handleHide_(invocation);\n  }\n\n  /**\n   * Handles \"toggleClass\" action.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleToggleClass_(invocation) {\n    const target = dev().assertElement(invocation.node);\n    const {args} = invocation;\n    const className = user().assertString(\n      args['class'],\n      \"Argument 'class' must be a string.\"\n    );\n    // prevent toggling of amp internal classes\n    if (AMP_CSS_RE.test(className)) {\n      return null;\n    }\n\n    this.mutator_.mutateElement(target, () => {\n      if (args['force'] !== undefined) {\n        // must be boolean, won't do type conversion\n        const shouldForce = user().assertBoolean(\n          args['force'],\n          \"Optional argument 'force' must be a boolean.\"\n        );\n        target.classList.toggle(className, shouldForce);\n      } else {\n        target.classList.toggle(className);\n      }\n    });\n\n    return null;\n  }\n}\n\n/**\n * @param {!Node} node\n * @return {!Window}\n */\nfunction getWin(node) {\n  return toWin(\n    (node.ownerDocument || /** @type {!Document} */ (node)).defaultView\n  );\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installStandardActionsForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    'standard-actions',\n    StandardActions,\n    /* opt_instantiate */ true\n  );\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../core/data-structures/promise';\nimport {getServiceForDoc, registerServiceBuilderForDoc} from '../service';\nimport {rootNodeFor} from '../dom';\nimport {scopedQuerySelector} from '../core/dom/query';\nimport {userAssert} from '../log';\n\n/**\n * @fileoverview\n * For the set of decisions made on templating see:\n * {@link https://docs.google.com/document/d/1q-5MPQHnOHLF_uL7lQsGZdzuBgrPTkCy2PdRP-YCbOw/edit#}\n */\n\n/** @private @const {string} */\nconst PROP_ = '__AMP_IMPL_';\n\n/** @private @const {string} */\nconst PROP_PROMISE_ = '__AMP_WAIT_';\n\n/** @private @const {function()} */\nconst EMPTY_FUNC = () => {};\n\n/**\n */\nexport class Templates {\n  /** @param {!./ampdoc-impl.AmpDoc} ampdoc */\n  constructor(ampdoc) {\n    /** @private @const */\n    this.ampdoc_ = ampdoc;\n\n    /**\n     * A map from template type to template's class promise.\n     * @private @const {!Object<string, !Promise<typeof ../base-template.BaseTemplate>>}\n     */\n    this.templateClassMap_ = {};\n\n    /**\n     * A map from template type to template's class promise. This is a transient\n     * storage. As soon as the template class loaded, the entry is removed.\n     * @private @const {!Object<string, function(typeof ../base-template.BaseTemplate)>}\n     */\n    this.templateClassResolvers_ = {};\n  }\n\n  /**\n   * Waits for template to be fully initialized.\n   * @param {!Element} templateElement\n   * @return {!Promise}\n   */\n  whenReady(templateElement) {\n    return this.getImplementation_(templateElement).then(EMPTY_FUNC);\n  }\n\n  /**\n   * Inserts the specified template element.\n   * @param {!Element} templateElement\n   * @param {string} html\n   * @return {!Promise<(!Element|!Array<!Element>)>}\n   */\n  setHtmlForTemplate(templateElement, html) {\n    return this.getImplementation_(templateElement).then((impl) => {\n      return this.setHtml_(impl, html);\n    });\n  }\n\n  /**\n   * Renders the specified template element using the supplied data.\n   * @param {!Element} templateElement\n   * @param {!JsonObject} data\n   * @return {!Promise<!Element>}\n   */\n  renderTemplate(templateElement, data) {\n    return this.getImplementation_(templateElement).then((impl) => {\n      return this.render_(impl, data);\n    });\n  }\n\n  /**\n   * Renders the specified template element using the supplied data.\n   * @param {!Element} templateElement\n   * @param {!JsonObject} data\n   * @return {!Promise<!Element>}\n   */\n  renderTemplateAsString(templateElement, data) {\n    return this.getImplementation_(templateElement).then((impl) => {\n      return impl.renderAsString(data);\n    });\n  }\n\n  /**\n   * Renders the specified template element using the supplied array of data\n   * and returns an array of resulting elements.\n   * @param {!Element} templateElement\n   * @param {!Array<!JsonObject>} array\n   * @return {!Promise<!Array<!Element>>}\n   */\n  renderTemplateArray(templateElement, array) {\n    if (array.length == 0) {\n      return Promise.resolve([]);\n    }\n    return this.getImplementation_(templateElement).then((impl) => {\n      return array.map((item) => {\n        return this.render_(impl, item);\n      });\n    });\n  }\n\n  /**\n   * Discovers the template for the specified parent and renders it using the\n   * supplied data. The template can be specified either via \"template\"\n   * attribute  or as a child \"template\" element. When specified via \"template\"\n   * attribute, the value indicates the ID of the template element.\n   * @param {!Element} parent\n   * @param {!JsonObject} data\n   * @param {string=} opt_querySelector\n   * @return {!Promise<!Element>}\n   */\n  findAndRenderTemplate(parent, data, opt_querySelector) {\n    return this.renderTemplate(\n      this.findTemplate(parent, opt_querySelector),\n      data\n    );\n  }\n\n  /**\n   * Discovers the already rendered template for the specified parent and\n   * inserts it in the DOM. The template can be specified either via \"template\"\n   * attribute  or as a child \"template\" element. When specified via \"template\"\n   * attribute, the value indicates the ID of the template element.\n   * @param {!Element} parent\n   * @param {string} html\n   * @param {string=} opt_querySelector\n   * @return {!Promise<(!Element|!Array<!Element>)>}\n   */\n  findAndSetHtmlForTemplate(parent, html, opt_querySelector) {\n    return this.setHtmlForTemplate(\n      this.findTemplate(parent, opt_querySelector),\n      html\n    );\n  }\n\n  /**\n   * Discovers the template for the specified parent and renders it using the\n   * supplied array of data. The template can be specified either via \"template\"\n   * attribute or as a child \"template\" element. When specified via \"template\"\n   * attribute, the value indicates the ID of the template element. Returns\n   * the array of the rendered elements.\n   * @param {!Element} parent\n   * @param {!Array<!JsonObject>} array\n   * @param {string=} opt_querySelector\n   * @return {!Promise<!Array<!Element>>}\n   */\n  findAndRenderTemplateArray(parent, array, opt_querySelector) {\n    return this.renderTemplateArray(\n      this.findTemplate(parent, opt_querySelector),\n      array\n    );\n  }\n\n  /**\n   * Detect if a template is present inside the parent.\n   * @param {!Element} parent\n   * @param {string=} opt_querySelector\n   * @return {boolean}\n   */\n  hasTemplate(parent, opt_querySelector) {\n    return !!this.maybeFindTemplate(parent, opt_querySelector);\n  }\n\n  /**\n   * Find a specified template inside the parent. Fail if the template is\n   * not present.\n   * @param {!Element} parent\n   * @param {string=} opt_querySelector\n   * @return {!Element}\n   */\n  findTemplate(parent, opt_querySelector) {\n    const templateElement = this.maybeFindTemplate(parent, opt_querySelector);\n    userAssert(templateElement, 'Template not found for %s', parent);\n    const templateTagName = templateElement.tagName;\n    userAssert(\n      templateTagName == 'TEMPLATE' ||\n        (templateTagName == 'SCRIPT' &&\n          templateElement.getAttribute('type') === 'text/plain'),\n      'Template must be defined in a <template> or ' +\n        '<script type=\"text/plain\"> tag'\n    );\n    return templateElement;\n  }\n\n  /**\n   * Find a specified template inside the parent. Returns null if not present.\n   * The template can be specified either via \"template\" attribute or as a\n   * child \"template\" element. When specified via \"template\" attribute,\n   * the value indicates the ID of the template element. The template\n   * can be defined either via the <template> or <script> tag.\n   * @param {!Element} parent\n   * @param {string=} opt_querySelector\n   * @return {?Element}\n   */\n  maybeFindTemplate(parent, opt_querySelector) {\n    const templateId = parent.getAttribute('template');\n    if (templateId) {\n      const rootNode = /** @type {!Document|!ShadowRoot} */ (\n        rootNodeFor(parent)\n      );\n      return rootNode.getElementById(templateId);\n    } else if (opt_querySelector) {\n      return scopedQuerySelector(parent, opt_querySelector);\n    } else {\n      return parent.querySelector('template[type], script[type=\"text/plain\"]');\n    }\n  }\n\n  /**\n   * Returns the promise that will eventually yield the template implementation\n   * for the specified template element.\n   * @param {!Element} element\n   * @return {!Promise<!../base-template.BaseTemplate>}\n   * @private\n   */\n  getImplementation_(element) {\n    /** @const {!../base-template.BaseTemplate} */\n    const impl = element[PROP_];\n    if (impl) {\n      return Promise.resolve(impl);\n    }\n\n    let type = '';\n    const {tagName} = element;\n    if (tagName == 'TEMPLATE') {\n      type = element.getAttribute('type');\n    } else if (tagName == 'SCRIPT') {\n      type = element.getAttribute('template');\n    }\n    userAssert(type, 'Type must be specified: %s', element);\n\n    let promise = element[PROP_PROMISE_];\n    if (promise) {\n      return promise;\n    }\n\n    promise = this.waitForTemplateClass_(element, type).then(\n      (templateClass) => {\n        // This is ugly workaround for https://github.com/google/closure-compiler/issues/2630.\n        const Constr = /** @type {function(new:Object, !Element, !Window)} */ (\n          templateClass\n        );\n        const impl = (element[PROP_] = new Constr(element, this.ampdoc_.win));\n        delete element[PROP_PROMISE_];\n        return impl;\n      }\n    );\n    element[PROP_PROMISE_] = promise;\n    return promise;\n  }\n\n  /**\n   * Returns the promise that will eventually yield the template class. This\n   * will wait until the actual template script has been downloaded and parsed.\n   * @param {!Element} element\n   * @param {string} type\n   * @return {!Promise<typeof ../base-template.BaseTemplate>}\n   * @private\n   */\n  waitForTemplateClass_(element, type) {\n    if (this.templateClassMap_[type]) {\n      return this.templateClassMap_[type];\n    }\n\n    const deferred = new Deferred();\n    const {promise, resolve} = deferred;\n\n    this.templateClassMap_[type] = promise;\n    this.templateClassResolvers_[type] = resolve;\n    return promise;\n  }\n\n  /**\n   * Registers an extended template. This function should typically be called\n   * through the registerTemplate method on the AMP runtime.\n   * @param {string} type\n   * @param {typeof ../base-template.BaseTemplate} templateClass\n   * @private\n   * @restricted\n   */\n  registerTemplate_(type, templateClass) {\n    if (!this.templateClassMap_[type]) {\n      this.templateClassMap_[type] = Promise.resolve(templateClass);\n    } else {\n      const resolver = this.templateClassResolvers_[type];\n      userAssert(resolver, 'Duplicate template type: %s', type);\n      delete this.templateClassResolvers_[type];\n      resolver(templateClass);\n    }\n  }\n\n  /**\n   * @param {!../base-template.BaseTemplate} impl\n   * @param {!JsonObject} data\n   * @return {!Element}\n   * @private\n   */\n  render_(impl, data) {\n    return impl.render(data);\n  }\n\n  /**\n   * @param {!../base-template.BaseTemplate} impl\n   * @param {string} html\n   * @return {!Element|!Array<!Element>}\n   * @private\n   */\n  setHtml_(impl, html) {\n    return impl.setHtml(html);\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installTemplatesServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'templates', Templates);\n}\n\n/**\n * Registers an extended template. This function should typically be called\n * through the registerTemplate method on the AMP runtime.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {string} type\n * @param {typeof ../base-template.BaseTemplate} templateClass\n * @return {undefined}\n */\nexport function registerExtendedTemplateForDoc(ampdoc, type, templateClass) {\n  const templatesService = getServiceForDoc(ampdoc, 'templates');\n  return templatesService.registerTemplate_(type, templateClass);\n}\n\n/**\n * @param {!Templates} templates\n * @param {string} type\n * @return {!Promise<typeof ../base-template.BaseTemplate>|undefined}\n * @visibleForTesting\n */\nexport function getTemplateClassForTesting(templates, type) {\n  return templates.templateClassMap_[type];\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from '../mode';\nimport {\n  registerServiceBuilder,\n  registerServiceBuilderInEmbedWin,\n} from '../service';\nimport {reportError} from '../error-reporting';\nimport {user} from '../log';\n\nconst TAG = 'timer';\nlet timersForTesting;\n\n/**\n * Helper with all things Timer.\n */\nexport class Timer {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!Promise}  */\n    this.resolved_ = this.win.Promise.resolve();\n\n    this.taskCount_ = 0;\n\n    this.canceled_ = {};\n\n    /** @const {number} */\n    this.startTime_ = Date.now();\n  }\n\n  /**\n   * Returns time since start in milliseconds.\n   * @return {number}\n   */\n  timeSinceStart() {\n    return Date.now() - this.startTime_;\n  }\n\n  /**\n   * Runs the provided callback after the specified delay. This uses a micro\n   * task for 0 or no specified time. This means that the delay will actually\n   * be close to 0 and this will NOT yield to the event queue.\n   *\n   * Returns the timer ID that can be used to cancel the timer (cancel method).\n   * @param {function()} callback\n   * @param {number=} opt_delay\n   * @return {number|string}\n   */\n  delay(callback, opt_delay) {\n    if (!opt_delay) {\n      // For a delay of zero,  schedule a promise based micro task since\n      // they are predictably fast.\n      const id = 'p' + this.taskCount_++;\n      this.resolved_\n        .then(() => {\n          if (this.canceled_[id]) {\n            delete this.canceled_[id];\n            return;\n          }\n          callback();\n        })\n        .catch(reportError);\n      return id;\n    }\n    const wrapped = () => {\n      try {\n        callback();\n      } catch (e) {\n        reportError(e);\n        throw e;\n      }\n    };\n    const index = this.win.setTimeout(wrapped, opt_delay);\n    if (getMode().test) {\n      if (!timersForTesting) {\n        timersForTesting = [];\n      }\n      timersForTesting.push(index);\n    }\n    return index;\n  }\n\n  /**\n   * Cancels the previously scheduled callback.\n   * @param {number|string|null} timeoutId\n   */\n  cancel(timeoutId) {\n    if (typeof timeoutId == 'string') {\n      this.canceled_[timeoutId] = true;\n      return;\n    }\n    this.win.clearTimeout(timeoutId);\n  }\n\n  /**\n   * Returns a promise that will resolve after the delay. Optionally, the\n   * resolved value can be provided as opt_result argument.\n   * @param {number=} opt_delay\n   * @return {!Promise}\n   */\n  promise(opt_delay) {\n    return new this.win.Promise((resolve) => {\n      // Avoid wrapping in closure if no specific result is produced.\n      const timerKey = this.delay(resolve, opt_delay);\n      if (timerKey == -1) {\n        throw new Error('Failed to schedule timer.');\n      }\n    });\n  }\n\n  /**\n   * Returns a promise that will fail after the specified delay. Optionally,\n   * this method can take opt_racePromise parameter. In this case, the\n   * resulting promise will either fail when the specified delay expires or\n   * will resolve based on the opt_racePromise, whichever happens first.\n   * @param {number} delay\n   * @param {?Promise<RESULT>|undefined} opt_racePromise\n   * @param {string=} opt_message\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   */\n  timeoutPromise(delay, opt_racePromise, opt_message) {\n    let timerKey;\n    const delayPromise = new this.win.Promise((_resolve, reject) => {\n      timerKey = this.delay(() => {\n        reject(user().createError(opt_message || 'timeout'));\n      }, delay);\n\n      if (timerKey == -1) {\n        throw new Error('Failed to schedule timer.');\n      }\n    });\n    if (!opt_racePromise) {\n      return delayPromise;\n    }\n    const cancel = () => {\n      this.cancel(timerKey);\n    };\n    opt_racePromise.then(cancel, cancel);\n    return this.win.Promise.race([delayPromise, opt_racePromise]);\n  }\n\n  /**\n   * Returns a promise that resolves after `predicate` returns true.\n   * Polls with interval `delay`\n   * @param {number} delay\n   * @param {function():boolean} predicate\n   * @return {!Promise}\n   */\n  poll(delay, predicate) {\n    return new this.win.Promise((resolve) => {\n      const interval = this.win.setInterval(() => {\n        if (predicate()) {\n          this.win.clearInterval(interval);\n          resolve();\n        }\n      }, delay);\n    });\n  }\n}\n\n/**\n * @param {!Window} window\n */\nexport function installTimerService(window) {\n  registerServiceBuilder(window, TAG, Timer);\n}\n\n/**\n * @param {!Window} embedWin\n */\nexport function installTimerInEmbedWindow(embedWin) {\n  registerServiceBuilderInEmbedWin(embedWin, TAG, Timer);\n}\n\n/**\n * Cancels all timers scheduled during the current test\n */\nexport function cancelTimersForTesting() {\n  if (!timersForTesting) {\n    return;\n  }\n  timersForTesting.forEach(clearTimeout);\n  timersForTesting = null;\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {LruCache} from '../core/data-structures/lru-cache';\nimport {\n  assertAbsoluteHttpOrHttpsUrl,\n  assertHttpsUrl,\n  getSourceOrigin,\n  getSourceUrl,\n  isProtocolValid,\n  isProxyOrigin,\n  isSecureUrlDeprecated,\n  parseUrlWithA,\n  resolveRelativeUrl,\n} from '../url';\nimport {registerServiceBuilderForDoc} from '../service';\nimport {urls} from '../config';\n\nconst SERVICE = 'url';\n\n/**\n */\nexport class Url {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    const root = ampdoc.getRootNode();\n    const doc = root.ownerDocument || root;\n\n    /** @private @const {!HTMLAnchorElement} */\n    this.anchor_ = /** @type {!HTMLAnchorElement} */ (doc.createElement('a'));\n\n    /** @private @const {?LruCache} */\n    this.cache_ = IS_ESM ? null : new LruCache(100);\n  }\n\n  /**\n   * Parses the URL in the context of the current document.\n   *\n   * @param {string} url\n   * @param {boolean=} opt_nocache\n   *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n   * @return {!Location}\n   */\n  parse(url, opt_nocache) {\n    return parseUrlWithA(\n      this.anchor_,\n      url,\n      IS_ESM || opt_nocache ? null : this.cache_\n    );\n  }\n\n  /**\n   * @param {string|!Location} url\n   * @return {!Location}\n   * @private\n   */\n  parse_(url) {\n    if (typeof url !== 'string') {\n      return url;\n    }\n    return this.parse(url);\n  }\n\n  /**\n   * Returns whether the URL has valid protocol.\n   * Deep link protocol is valid, but not javascript etc.\n   * @param {string|!Location} url\n   * @return {boolean}\n   */\n  isProtocolValid(url) {\n    return isProtocolValid(url);\n  }\n\n  /**\n   * Returns the source origin of an AMP document for documents served\n   * on a proxy origin or directly.\n   * @param {string|!Location} url URL of an AMP document.\n   * @return {string} The source origin of the URL.\n   */\n  getSourceOrigin(url) {\n    return getSourceOrigin(this.parse_(url));\n  }\n\n  /**\n   * Returns the source URL of an AMP document for documents served\n   * on a proxy origin or directly.\n   * @param {string|!Location} url URL of an AMP document.\n   * @return {string}\n   */\n  getSourceUrl(url) {\n    return getSourceUrl(this.parse_(url));\n  }\n\n  /**\n   * Returns absolute URL resolved based on the relative URL and the base.\n   * @param {string} relativeUrlString\n   * @param {string|!Location} baseUrl\n   * @return {string}\n   */\n  resolveRelativeUrl(relativeUrlString, baseUrl) {\n    return resolveRelativeUrl(relativeUrlString, this.parse_(baseUrl));\n  }\n\n  /**\n   * Asserts that a given url is HTTPS or protocol relative. It's a user-level\n   * assert.\n   *\n   * Provides an exception for localhost.\n   *\n   * @param {?string|undefined} urlString\n   * @param {!Element|string} elementContext Element where the url was found.\n   * @param {string=} sourceName Used for error messages.\n   * @return {string}\n   */\n  assertHttpsUrl(urlString, elementContext, sourceName = 'source') {\n    return assertHttpsUrl(urlString, elementContext, sourceName);\n  }\n\n  /**\n   * Asserts that a given url is an absolute HTTP or HTTPS URL.\n   * @param {string} urlString\n   * @return {string}\n   */\n  assertAbsoluteHttpOrHttpsUrl(urlString) {\n    return assertAbsoluteHttpOrHttpsUrl(urlString);\n  }\n\n  /**\n   * Returns whether the URL has the origin of a proxy.\n   * @param {string|!Location} url URL of an AMP document.\n   * @return {boolean}\n   */\n  isProxyOrigin(url) {\n    return isProxyOrigin(this.parse_(url));\n  }\n\n  /**\n   * Returns `true` if the URL is secure: either HTTPS or localhost (for\n   * testing).\n   * @param {string} url\n   * @return {boolean}\n   */\n  isSecure(url) {\n    return isSecureUrlDeprecated(this.parse_(url));\n  }\n\n  /**\n   * Returns the correct origin for a given window.\n   * @param {!Window} win\n   * @return {string} origin\n   */\n  getWinOrigin(win) {\n    return win.origin || this.parse_(win.location.href).origin;\n  }\n\n  /**\n   * If the resource URL is referenced from the publisher's origin,\n   * convert the URL to be referenced from the cache.\n   * @param {string} resourceUrl The URL of the document to load\n   * @return {string}\n   */\n  getCdnUrlOnOrigin(resourceUrl) {\n    if (isProxyOrigin(resourceUrl)) {\n      return resourceUrl;\n    }\n\n    const {hash, host, pathname, search} = this.parse_(resourceUrl);\n    const encodedHost = encodeURIComponent(host);\n    return `${urls.cdn}/c/${encodedHost}${pathname}${search}${hash}`;\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installUrlForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    SERVICE,\n    Url,\n    /* opt_instantiate */ true\n  );\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {Services} from '../services';\nimport {devAssert} from '../log';\nimport {isAmp4Email} from '../format';\nimport {isFiniteNumber} from '../core/types';\nimport {loadPromise} from '../event-helper';\nimport {whenDocumentComplete} from '../core/document-ready';\n\n/** @typedef {string|number|boolean|undefined|null} */\nexport let ResolverReturnDef;\n\n/** @typedef {function(...string):ResolverReturnDef} */\nexport let SyncResolverDef;\n\n/** @typedef {function(...string):!Promise<ResolverReturnDef>} */\nexport let AsyncResolverDef;\n\n/** @typedef {{sync: SyncResolverDef, async: AsyncResolverDef}} */\nlet ReplacementDef;\n\n/**\n * A list of events that the navTiming needs to wait for.\n * Sort event in order\n * @enum {number}\n */\nconst WAITFOR_EVENTS = {\n  VIEWER_FIRST_VISIBLE: 1,\n  DOCUMENT_COMPLETE: 2,\n  LOAD: 3,\n  LOAD_END: 4,\n};\n\n/**\n * A list of events on which event they should wait\n * @const {!Object<string, WAITFOR_EVENTS>}\n */\nconst NAV_TIMING_WAITFOR_EVENTS = {\n  // ready on viewer first visible\n  'navigationStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'redirectStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'redirectEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'fetchStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'domainLookupStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'domainLookupEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'connectStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'secureConnectionStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'connectEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'requestStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'responseStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'responseEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  // ready on document complte\n  'domLoading': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  'domInteractive': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  'domContentLoaded': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  'domComplete': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  // ready on load\n  'loadEventStart': WAITFOR_EVENTS.LOAD,\n  // ready on load complete\n  'loadEventEnd': WAITFOR_EVENTS.LOAD_END,\n};\n\n/**\n * Returns navigation timing information based on the start and end events.\n * The data for the timing events is retrieved from performance.timing API.\n * If start and end events are both given, the result is the difference between\n * the two. If only start event is given, the result is the timing value at\n * start event.\n * @param {!Window} win\n * @param {string} startEvent\n * @param {string=} endEvent\n * @return {!Promise<ResolverReturnDef>}\n */\nexport function getTimingDataAsync(win, startEvent, endEvent) {\n  // Fallback to load event if we don't know what to wait for\n  const startWaitForEvent =\n    NAV_TIMING_WAITFOR_EVENTS[startEvent] || WAITFOR_EVENTS.LOAD;\n  const endWaitForEvent = endEvent\n    ? NAV_TIMING_WAITFOR_EVENTS[endEvent] || WAITFOR_EVENTS.LOAD\n    : startWaitForEvent;\n\n  const waitForEvent = Math.max(startWaitForEvent, endWaitForEvent);\n\n  // set wait for onload to be default\n  let readyPromise;\n  if (waitForEvent === WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE) {\n    readyPromise = Promise.resolve();\n  } else if (waitForEvent === WAITFOR_EVENTS.DOCUMENT_COMPLETE) {\n    readyPromise = whenDocumentComplete(win.document);\n  } else if (waitForEvent === WAITFOR_EVENTS.LOAD) {\n    readyPromise = loadPromise(win);\n  } else if (waitForEvent === WAITFOR_EVENTS.LOAD_END) {\n    // performance.timing.loadEventEnd returns 0 before the load event handler\n    // has terminated, that's when the load event is completed.\n    // To wait for the event handler to terminate, wait 1ms and defer to the\n    // event loop.\n    const timer = Services.timerFor(win);\n    readyPromise = loadPromise(win).then(() => timer.promise(1));\n  }\n\n  devAssert(readyPromise, 'waitForEvent not supported ' + waitForEvent);\n\n  return readyPromise.then(() => {\n    return getTimingDataSync(win, startEvent, endEvent);\n  });\n}\n\n/**\n * Returns navigation timing information based on the start and end events.\n * The data for the timing events is retrieved from performance.timing API.\n * If start and end events are both given, the result is the difference between\n * the two. If only start event is given, the result is the timing value at\n * start event. Enforces synchronous evaluation.\n * @param {!Window} win\n * @param {string} startEvent\n * @param {string=} endEvent\n * @return {ResolverReturnDef} undefined if API is not available, empty string\n *    if it is not yet available, or value as string\n */\nexport function getTimingDataSync(win, startEvent, endEvent) {\n  const timingInfo = win['performance'] && win['performance']['timing'];\n  if (!timingInfo || timingInfo['navigationStart'] == 0) {\n    // Navigation timing API is not supported.\n    return;\n  }\n\n  const metric =\n    endEvent === undefined\n      ? timingInfo[startEvent]\n      : timingInfo[endEvent] - timingInfo[startEvent];\n\n  if (!isFiniteNumber(metric) || metric < 0) {\n    // The metric is not supported.\n    return;\n  } else {\n    return metric;\n  }\n}\n\n/**\n * Returns navigation information from the current browsing context.\n * @param {!Window} win\n * @param {string} attribute\n * @return {ResolverReturnDef}\n */\nexport function getNavigationData(win, attribute) {\n  const navigationInfo = win['performance'] && win['performance']['navigation'];\n  if (!navigationInfo || navigationInfo[attribute] === undefined) {\n    // PerformanceNavigation interface is not supported or attribute is not\n    // implemented.\n    return;\n  }\n  return navigationInfo[attribute];\n}\n\n/**\n * A class to provide variable substitution related features. Extend this class\n * and override initialize() to add more supported variables.\n */\nexport class VariableSource {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @protected @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @private @const {!Object<string, !ReplacementDef>} */\n    this.replacements_ = Object.create(null);\n\n    /** @private {boolean} */\n    this.initialized_ = false;\n\n    this.getUrlMacroAllowlist_();\n  }\n\n  /**\n   * Lazily initialize the default replacements.\n   * @private\n   */\n  initialize_() {\n    this.initialize();\n    this.initialized_ = true;\n  }\n\n  /**\n   * Override this method to set all the variables supported by derived class.\n   */\n  initialize() {\n    // Needs to be implemented by derived classes.\n  }\n\n  /**\n   * Method exists to assist stubbing in tests.\n   * @param {string} name\n   * @return {!ReplacementDef}\n   */\n  get(name) {\n    if (!this.initialized_) {\n      this.initialize_();\n    }\n\n    return this.replacements_[name];\n  }\n\n  /**\n   * Sets a synchronous value resolver for the variable with the specified name.\n   * The value resolver may optionally take an extra parameter.\n   * Can be called in conjunction with setAsync to allow for additional\n   * asynchronous resolver where expand will use async and expandSync the sync\n   * version.\n   * @param {string} varName\n   * @param {!SyncResolverDef} syncResolver\n   * @return {!VariableSource}\n   */\n  set(varName, syncResolver) {\n    devAssert(varName.indexOf('RETURN') == -1);\n    this.replacements_[varName] = this.replacements_[varName] || {\n      sync: undefined,\n      async: undefined,\n    };\n    this.replacements_[varName].sync = syncResolver;\n    return this;\n  }\n\n  /**\n   * Sets an async value resolver for the variable with the specified name.\n   * The value resolver may optionally take an extra parameter.\n   * Can be called in conjuction with setAsync to allow for additional\n   * asynchronous resolver where expand will use async and expandSync the sync\n   * version.\n   * @param {string} varName\n   * @param {!AsyncResolverDef} asyncResolver\n   * @return {!VariableSource}\n   */\n  setAsync(varName, asyncResolver) {\n    devAssert(varName.indexOf('RETURN') == -1);\n    this.replacements_[varName] = this.replacements_[varName] || {\n      sync: undefined,\n      async: undefined,\n    };\n    this.replacements_[varName].async = asyncResolver;\n    return this;\n  }\n\n  /**\n   * Helper method to set both sync and async resolvers.\n   * @param {string} varName\n   * @param {!SyncResolverDef} syncResolver\n   * @param {!AsyncResolverDef} asyncResolver\n   * @return {!VariableSource}\n   */\n  setBoth(varName, syncResolver, asyncResolver) {\n    return this.set(varName, syncResolver).setAsync(varName, asyncResolver);\n  }\n\n  /**\n   * Returns a Regular expression that can be used to detect all the variables\n   * in a template.\n   * @param {!Object<string, *>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_allowlist Optional allowlist of names\n   *   that can be substituted.\n   * @return {!RegExp}\n   */\n  getExpr(opt_bindings, opt_allowlist) {\n    if (!this.initialized_) {\n      this.initialize_();\n    }\n    const all = {...this.replacements_, ...opt_bindings};\n    return this.buildExpr_(Object.keys(all), opt_allowlist);\n  }\n\n  /**\n   * @param {!Array<string>} keys\n   * @param {!Object<string, boolean>=} opt_allowlist Optional allowlist of names\n   *   that can be substituted.\n   * @return {!RegExp}\n   * @private\n   */\n  buildExpr_(keys, opt_allowlist) {\n    // If a allowlist is present, the keys must belong to the allowlist.\n    // We filter the keys one last time to ensure no unallowlisted key is\n    // allowed.\n    if (this.getUrlMacroAllowlist_()) {\n      keys = keys.filter((key) => this.getUrlMacroAllowlist_().includes(key));\n    }\n    // If a allowlist is passed into the call to GlobalVariableSource.expand_\n    // then we only resolve values contained in the allowlist.\n    if (opt_allowlist) {\n      keys = keys.filter((key) => opt_allowlist[key]);\n    }\n    if (keys.length === 0) {\n      const regexThatMatchesNothing = /_^/g; // lgtm [js/regex/unmatchable-caret]\n      return regexThatMatchesNothing;\n    }\n    // The keys must be sorted to ensure that the longest keys are considered\n    // first. This avoids a problem where a RANDOM conflicts with RANDOM_ONE.\n    keys.sort((s1, s2) => s2.length - s1.length);\n    // Keys that start with a `$` need to be escaped so that they do not\n    // interfere with the regex that is constructed.\n    const escaped = keys.map((key) => {\n      if (key[0] === '$') {\n        return '\\\\' + key;\n      }\n      return key;\n    });\n\n    const all = escaped.join('|');\n    // Match the given replacement patterns, as well as optionally\n    // arguments to the replacement behind it in parentheses.\n    // Example string that match\n    // FOO_BAR\n    // FOO_BAR(arg1)\n    // FOO_BAR(arg1,arg2)\n    // FOO_BAR(arg1, arg2)\n    const regexStr = '\\\\$?(' + all + ')';\n    return new RegExp(regexStr, 'g');\n  }\n\n  /**\n   * For email documents, all URL macros are disallowed by default.\n   * @return {Array<string>|undefined} The allowlist of substitutable AMP variables\n   * @private\n   */\n  getUrlMacroAllowlist_() {\n    if (this.variableAllowlist_) {\n      return this.variableAllowlist_;\n    }\n\n    // Disallow all URL macros for AMP4Email format documents.\n    if (this.ampdoc.isSingleDoc()) {\n      const doc = /** @type {!Document} */ (this.ampdoc.getRootNode());\n      if (isAmp4Email(doc)) {\n        /**\n         * The allowlist of variables allowed for variable substitution.\n         * @private {?Array<string>}\n         */\n        this.variableAllowlist_ = [''];\n        return this.variableAllowlist_;\n      }\n    }\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {hasOwn} from '../../core/types/object';\nimport {rethrowAsync} from '../../core/error';\nimport {trimStart} from '../../core/types/string';\nimport {tryResolve} from '../../core/data-structures/promise';\nimport {user} from '../../log';\n\n/** @private @const {string} */\nconst PARSER_IGNORE_FLAG = '`';\n\n/** @private @const {string} */\nconst TAG = 'Expander';\n\n/**\n * @typedef {{\n *   name: string,\n *   prioritized: (!BindingInfoDef|undefined),\n *   encode: boolean,\n *   sync: ../variable-source.SyncResolverDef,\n *   async: ../variable-source.AsyncResolverDef,\n * }}\n */\nlet BindingInfoDef;\n\n/**\n * @typedef {{\n *   start: number,\n *   stop: number,\n *   name: string,\n *   length: number,\n * }}\n */\nlet MatchDef;\n\n/** Rudamentary parser to handle nested Url replacement. */\nexport class Expander {\n  /**\n   * Link this instance of parser to the calling UrlReplacment\n   * @param {?../variable-source.VariableSource} variableSource the keywords to replace\n   * @param {!Object<string, *>=} opt_bindings additional one-off bindings\n   * @param {!Object<string, *>=} opt_collectVars Object passed in to collect\n   *   variable resolutions.\n   * @param {boolean=} opt_sync If the method should resolve syncronously.\n   * @param {!Object<string, boolean>=} opt_allowlist Optional allowlist of names\n   *   that can be substituted.\n   * @param {boolean=} opt_noEncode Should not urlEncode macro resolution.\n   */\n  constructor(\n    variableSource,\n    opt_bindings,\n    opt_collectVars,\n    opt_sync,\n    opt_allowlist,\n    opt_noEncode\n  ) {\n    /** @const {?../variable-source.VariableSource} */\n    this.variableSource_ = variableSource;\n\n    /**@const {!Object<string, *>|undefined} */\n    this.bindings_ = opt_bindings;\n\n    // TODO(ccordry): Remove this output object passed into constructor.\n    /**@const {!Object<string, *>|undefined} */\n    this.collectVars_ = opt_collectVars;\n\n    /**@const {boolean|undefined} */\n    this.sync_ = opt_sync;\n\n    /**@const {!Object<string, boolean>|undefined} */\n    this.allowlist_ = opt_allowlist;\n\n    /**@const {boolean|undefined} */\n    this.encode_ = !opt_noEncode;\n  }\n\n  /**\n   * take the template url and return a promise of its evaluated value\n   * @param {string} url url to be substituted\n   * @return {!Promise<string>|string}\n   */\n  expand(url) {\n    if (!url.length) {\n      return this.sync_ ? url : Promise.resolve(url);\n    }\n    const expr = this.variableSource_.getExpr(this.bindings_, this.allowlist_);\n\n    const matches = this.findMatches_(url, expr);\n    // if no keywords move on\n    if (!matches.length) {\n      return this.sync_ ? url : Promise.resolve(url);\n    }\n    return this.parseUrlRecursively_(url, matches);\n  }\n\n  /**\n   * Return any macros that exist in the given url.\n   * @param {string} url\n   * @return {!Array}\n   */\n  getMacroNames(url) {\n    const expr = this.variableSource_.getExpr(this.bindings_, this.allowlist_);\n    const matches = url.match(expr);\n    if (matches) {\n      return matches;\n    }\n    return [];\n  }\n\n  /**\n   * Structures the regex matching into the desired format\n   * @param {string} url url to be substituted\n   * @param {RegExp} expression regex containing all keywords\n   * @return {!Array<!MatchDef>} array of matching keywords.\n   */\n  findMatches_(url, expression) {\n    const matches = /** @type {!Array<!MatchDef>} */ ([]);\n    url.replace(expression, (match, name, startPosition) => {\n      const {length} = match;\n      const stopPosition = length + startPosition - 1;\n      const info = {\n        start: startPosition,\n        stop: stopPosition,\n        name,\n        length,\n      };\n      matches.push(info);\n    });\n    return matches;\n  }\n\n  /**\n   * @param {string} url\n   * @param {!Array<!MatchDef>} matches Array of matching keywords.\n   * @return {!Promise<string>|string}\n   */\n  parseUrlRecursively_(url, matches) {\n    const stack = [];\n    let urlIndex = 0;\n    let matchIndex = 0;\n    let match = matches[matchIndex];\n    let numOfPendingCalls = 0;\n    let ignoringChars = false;\n\n    const evaluateNextLevel = (encode) => {\n      let builder = '';\n      let results = [];\n      const args = [];\n\n      while (urlIndex < url.length && matchIndex <= matches.length) {\n        const trimmedBuilder = builder.trim();\n        if (match && urlIndex === match.start) {\n          // Collect any chars that may be prefixing the macro, if we are in\n          // a nested context trim the args.\n          if (trimmedBuilder) {\n            results.push(numOfPendingCalls ? trimStart(builder) : builder);\n          }\n\n          // If we know we are at the start of a macro, we figure out how to\n          // resolve it, and move our pointer to after the token.\n          let binding;\n          // Find out where this macro is coming from. Could be from the passed\n          // in optional bindings, or the global variable source.\n          if (this.bindings_ && hasOwn(this.bindings_, match.name)) {\n            // Macro is from optional bindings.\n            binding = /** @type {!BindingInfoDef} */ ({\n              // This construction helps us save the match name and determine\n              // precedence of resolution choices in #expandBinding_ later.\n              name: match.name,\n              prioritized: this.bindings_[match.name],\n              encode,\n            });\n          } else {\n            // Macro is from the global source.\n            binding = /** @type {!BindingInfoDef} */ ({\n              ...this.variableSource_.get(match.name),\n              name: match.name,\n              encode,\n            });\n          }\n\n          urlIndex = match.stop + 1;\n          match = matches[++matchIndex];\n\n          if (url[urlIndex] === '(') {\n            // When we see a `(` we know we need to resolve one level deeper\n            // before continuing. We push the binding in the stack for\n            // resolution later, and then make the recursive call.\n            urlIndex++;\n            numOfPendingCalls++;\n            stack.push(binding);\n            results.push(evaluateNextLevel(/* encode */ false));\n          } else {\n            // Many macros do not take arguments, in this case we do not need to\n            // recurse, we just start resolution in it's position.\n            results.push(this.evaluateBinding_(binding));\n          }\n\n          builder = '';\n        } else if (url[urlIndex] === PARSER_IGNORE_FLAG) {\n          if (!ignoringChars) {\n            ignoringChars = true;\n            // Collect any chars that may exist before backticks, eg FOO(a`b`)\n            if (trimmedBuilder) {\n              results.push(trimmedBuilder);\n            }\n          } else {\n            ignoringChars = false;\n            // Collect any chars inside backticks without trimming whitespace.\n            if (builder.length) {\n              results.push(builder);\n            }\n          }\n          builder = '';\n          urlIndex++;\n        } else if (\n          numOfPendingCalls &&\n          url[urlIndex] === ',' &&\n          !ignoringChars\n        ) {\n          // Commas tell us to create a new argument when in nested context and\n          // we push any string built so far, create a new array for the next\n          // argument, and reset our string builder.\n          if (trimmedBuilder) {\n            results.push(trimmedBuilder);\n          }\n          args.push(results);\n          results = [];\n          // Support existing two comma format by pushing an empty string as\n          // argument. eg CLIENT_ID(__ga,,ga-url)\n          if (url[urlIndex + 1] === ',') {\n            args.push(['']);\n            urlIndex++;\n          }\n          builder = '';\n          urlIndex++;\n        }\n\n        // Invoke a function on every right parenthesis unless the stack is\n        // empty. This is where we actually evaluate any macro that takes an\n        // argument. We pop the macro resover off the stack, and take anying left\n        // in our string builder and add it as the final section of the final\n        // arg. Then we call the resolver.\n        else if (numOfPendingCalls && url[urlIndex] === ')' && !ignoringChars) {\n          urlIndex++;\n          numOfPendingCalls--;\n          const binding = stack.pop();\n          if (trimmedBuilder) {\n            results.push(trimmedBuilder);\n          }\n          args.push(results);\n          const value = this.evaluateBinding_(binding, /* opt_args */ args);\n          return value;\n        } else {\n          // This is the most common case. Just building a string as we walk\n          // along.\n          builder += url[urlIndex];\n          urlIndex++;\n        }\n\n        // Capture any trailing characters.\n        if (urlIndex === url.length && builder.length) {\n          results.push(builder);\n        }\n      }\n\n      // TODO: If there is a single item in results, we should preserve it's\n      // type when returning here and the async version below.\n      if (this.sync_) {\n        return results.join('');\n      }\n\n      return Promise.all(results)\n        .then((promiseArray) => promiseArray.join(''))\n        .catch((e) => {\n          rethrowAsync(e);\n          return '';\n        });\n    };\n\n    return evaluateNextLevel(this.encode_);\n  }\n\n  /**\n   * Called when a binding is ready to be resolved. Determines which version of\n   * binding to use and if syncronous or asyncronous version should be called.\n   * @param {!BindingInfoDef} bindingInfo An object containing the name of\n   *    macro and value to be resolved.\n   * @param {Array=} opt_args Arguments passed to the macro. Arguments come as\n   *    an array of arrays that will be eventually passed to a function.apply\n   *    invocation. For example: FOO(BARBAR, 123) => When we are ready to evaluate\n   *    the FOO binding opt_args will be [[Result of BAR, Result of BAR], [123]].\n   *    This structure is so that the outer array will have the correct number of\n   *    arguments, but we still can resolve each macro separately.\n   * @return {string|!Promise<string>}\n   */\n  evaluateBinding_(bindingInfo, opt_args) {\n    const {encode, name} = bindingInfo;\n    let binding;\n    if (bindingInfo.prioritized != undefined) {\n      // Has to explicity check for undefined because bindingInfo.priorityized\n      // could not be a function but a false value. For example {FOO: 0}\n      // If a binding is passed in through the bindings argument it always takes\n      // precedence.\n      binding = bindingInfo.prioritized;\n    } else if (this.sync_ && bindingInfo.sync != undefined) {\n      // Use the sync resolution if avaliable when called synchronously.\n      binding = bindingInfo.sync;\n    } else if (this.sync_) {\n      // If there is no sync resolution we can not wait.\n      user().error(TAG, 'ignoring async replacement key: ', bindingInfo.name);\n      binding = '';\n    } else {\n      // Prefer the async over the sync but it may not exist.\n      binding = bindingInfo.async || bindingInfo.sync;\n    }\n\n    if (this.sync_) {\n      const result = this.evaluateBindingSync_(binding, name, opt_args);\n      return encode ? encodeURIComponent(result) : result;\n    } else {\n      return this.evaluateBindingAsync_(binding, name, opt_args).then(\n        (result) => (encode ? encodeURIComponent(result) : result)\n      );\n    }\n  }\n\n  /**\n   * Resolves binding to value to be substituted asyncronously.\n   * @param {*} binding Container for sync/async resolutions.\n   * @param {string} name\n   * @param {?Array=} opt_args Arguments to be passed if binding is function.\n   * @return {!Promise<string>} Resolved value.\n   */\n  evaluateBindingAsync_(binding, name, opt_args) {\n    let value;\n    try {\n      if (typeof binding === 'function') {\n        const bindingFunc = binding;\n        if (opt_args) {\n          value = this.processArgsAsync_(opt_args).then((args) =>\n            bindingFunc.apply(null, args)\n          );\n        } else {\n          value = tryResolve(bindingFunc);\n        }\n      } else {\n        value = Promise.resolve(binding);\n      }\n      return value\n        .then((val) => {\n          this.maybeCollectVars_(name, val, opt_args);\n\n          let result;\n\n          if (val == null) {\n            result = '';\n          } else {\n            result = val;\n          }\n          return result;\n        })\n        .catch((e) => {\n          rethrowAsync(e);\n          this.maybeCollectVars_(name, '', opt_args);\n          return Promise.resolve('');\n        });\n    } catch (e) {\n      // Report error, but do not disrupt URL replacement. This will\n      // interpolate as the empty string.\n      rethrowAsync(e);\n      this.maybeCollectVars_(name, '', opt_args);\n      return Promise.resolve('');\n    }\n  }\n\n  /**\n   * Flattens the inner layer of an array of arrays so that the result can be\n   * passed to a function.apply call. Must wait for any inner macros to resolve.\n   * This will cast all arguments to string before calling the macro.\n   *  [[Result of BAR, Result of BAR], 123]. => ['resultresult', '123']\n   * @param {!Array<!Array>} argsArray\n   * @return {!Promise<Array<string>>}\n   */\n  processArgsAsync_(argsArray) {\n    return Promise.all(\n      argsArray.map((argArray) => {\n        return Promise.all(argArray).then((resolved) => resolved.join(''));\n      })\n    );\n  }\n\n  /**\n   * Resolves binding to value to be substituted asyncronously.\n   * @param {*} binding Container for sync/async resolutions.\n   * @param {string} name\n   * @param {?Array=} opt_args Arguments to be passed if binding is function.\n   * @return {string} Resolved value.\n   */\n  evaluateBindingSync_(binding, name, opt_args) {\n    try {\n      let value = binding;\n      if (typeof binding === 'function') {\n        value = binding.apply(null, this.processArgsSync_(opt_args));\n      }\n\n      let result;\n\n      if (value && typeof value.then == 'function') {\n        // If binding is passed in as opt_binding we try to resolve it and it\n        // may return a promise. NOTE: We do not collect this discarded value,\n        // even if collectVars exists.\n        user().error(TAG, 'ignoring async macro resolution');\n        result = '';\n      } else if (\n        typeof value === 'string' ||\n        typeof value === 'number' ||\n        typeof value === 'boolean'\n      ) {\n        // Normal case.\n        this.maybeCollectVars_(name, value, opt_args);\n        // TODO: We should try to preserve type here.\n        result = value.toString();\n      } else {\n        // Most likely a broken binding gets us here.\n        this.maybeCollectVars_(name, '', opt_args);\n        result = '';\n      }\n\n      return result;\n    } catch (e) {\n      // Report error, but do not disrupt URL replacement. This will\n      // interpolate as the empty string.\n      rethrowAsync(e);\n      this.maybeCollectVars_(name, '', opt_args);\n      return '';\n    }\n  }\n\n  /**\n   * Flattens the inner layer of an array of arrays so that the result can be\n   * passed to a function.apply call. Will not wait for any promise to resolve.\n   * This will cast all arguments to string before calling the macro.\n   *  [[Result of BAR, Result of BAR], 123]. => ['resultresult', '123']\n   * @param {Array<!Array>|undefined} argsArray\n   * @return {Array<string>|undefined}\n   */\n  processArgsSync_(argsArray) {\n    if (!argsArray) {\n      return argsArray;\n    }\n    return argsArray.map((argArray) => {\n      return argArray.join('');\n    });\n  }\n\n  /**\n   * Collect vars if given the optional object. Handles formatting of kv pairs.\n   * @param {string} name Name of the macro.\n   * @param {*} value Raw macro resolution value.\n   * @param {?Array=} opt_args Arguments to be passed if binding is function.\n   */\n  maybeCollectVars_(name, value, opt_args) {\n    if (!this.collectVars_) {\n      return;\n    }\n\n    let args = '';\n    if (opt_args) {\n      const rawArgs = opt_args.filter((arg) => arg !== '').join(',');\n      args = `(${rawArgs})`;\n    }\n    this.collectVars_[`${name}${args}`] = value || '';\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AsyncResolverDef,\n  ResolverReturnDef,\n  SyncResolverDef,\n  VariableSource,\n  getNavigationData,\n  getTimingDataAsync,\n  getTimingDataSync,\n} from './variable-source';\nimport {Expander} from './url-expander/expander';\nimport {Services} from '../services';\nimport {WindowInterface} from '../core/window/interface';\nimport {\n  addMissingParamsToUrl,\n  addParamsToUrl,\n  getSourceUrl,\n  isProtocolValid,\n  parseUrlDeprecated,\n  removeAmpJsParamsFromUrl,\n  removeFragment,\n} from '../url';\nimport {dev, devAssert, user, userAssert} from '../log';\nimport {getTrackImpressionPromise} from '../impression.js';\nimport {hasOwn} from '../core/types/object';\nimport {\n  installServiceInEmbedDoc,\n  registerServiceBuilderForDoc,\n} from '../service';\nimport {internalRuntimeVersion} from '../internal-version';\nimport {parseQueryString} from '../core/types/string/url';\n\n/** @private @const {string} */\nconst TAG = 'UrlReplacements';\nconst EXPERIMENT_DELIMITER = '!';\nconst VARIANT_DELIMITER = '.';\nconst GEO_DELIM = ',';\nconst ORIGINAL_HREF_PROPERTY = 'amp-original-href';\nconst ORIGINAL_VALUE_PROPERTY = 'amp-original-value';\n\n/**\n * Returns a function that executes method on a new Date instance. This is a\n * byte saving hack.\n *\n * @param {string} method\n * @return {!SyncResolverDef}\n */\nfunction dateMethod(method) {\n  return () => new Date()[method]();\n}\n\n/**\n * Returns a function that returns property of screen. This is a byte saving\n * hack.\n *\n * @param {!Screen} screen\n * @param {string} property\n * @return {!SyncResolverDef}\n */\nfunction screenProperty(screen, property) {\n  return () => screen[property];\n}\n\n/**\n * Class to provide variables that pertain to top level AMP window.\n */\nexport class GlobalVariableSource extends VariableSource {\n  /**\n   * Utility function for setting resolver for timing data that supports\n   * sync and async.\n   * @param {string} varName\n   * @param {string} startEvent\n   * @param {string=} endEvent\n   * @return {!VariableSource}\n   * @private\n   */\n  setTimingResolver_(varName, startEvent, endEvent) {\n    return this.setBoth(\n      varName,\n      () => {\n        return getTimingDataSync(this.ampdoc.win, startEvent, endEvent);\n      },\n      () => {\n        return getTimingDataAsync(this.ampdoc.win, startEvent, endEvent);\n      }\n    );\n  }\n\n  /** @override */\n  initialize() {\n    const {win} = this.ampdoc;\n    const element = this.ampdoc.getHeadNode();\n\n    /** @const {!./viewport/viewport-interface.ViewportInterface} */\n    const viewport = Services.viewportForDoc(this.ampdoc);\n\n    // Returns a random value for cache busters.\n    this.set('RANDOM', () => Math.random());\n\n    // Provides a counter starting at 1 per given scope.\n    const counterStore = Object.create(null);\n    this.set('COUNTER', (scope) => {\n      return (counterStore[scope] = (counterStore[scope] | 0) + 1);\n    });\n\n    // Returns the canonical URL for this AMP document.\n    this.set('CANONICAL_URL', () => this.getDocInfo_().canonicalUrl);\n\n    // Returns the host of the canonical URL for this AMP document.\n    this.set(\n      'CANONICAL_HOST',\n      () => parseUrlDeprecated(this.getDocInfo_().canonicalUrl).host\n    );\n\n    // Returns the hostname of the canonical URL for this AMP document.\n    this.set(\n      'CANONICAL_HOSTNAME',\n      () => parseUrlDeprecated(this.getDocInfo_().canonicalUrl).hostname\n    );\n\n    // Returns the path of the canonical URL for this AMP document.\n    this.set(\n      'CANONICAL_PATH',\n      () => parseUrlDeprecated(this.getDocInfo_().canonicalUrl).pathname\n    );\n\n    // Returns the referrer URL.\n    this.setAsync(\n      'DOCUMENT_REFERRER',\n      /** @type {AsyncResolverDef} */ (\n        () => {\n          return Services.viewerForDoc(this.ampdoc).getReferrerUrl();\n        }\n      )\n    );\n\n    // Like DOCUMENT_REFERRER, but returns null if the referrer is of\n    // same domain or the corresponding CDN proxy.\n    this.setAsync(\n      'EXTERNAL_REFERRER',\n      /** @type {AsyncResolverDef} */ (\n        () => {\n          return Services.viewerForDoc(this.ampdoc)\n            .getReferrerUrl()\n            .then((referrer) => {\n              if (!referrer) {\n                return null;\n              }\n              const referrerHostname = parseUrlDeprecated(\n                getSourceUrl(referrer)\n              ).hostname;\n              const currentHostname = WindowInterface.getHostname(win);\n              return referrerHostname === currentHostname ? null : referrer;\n            });\n        }\n      )\n    );\n\n    // Returns the title of this AMP document.\n    this.set('TITLE', () => {\n      // The environment may override the title and set originalTitle. Prefer\n      // that if available.\n      const doc = win.document;\n      return doc['originalTitle'] || doc.title;\n    });\n\n    // Returns the URL for this AMP document.\n    this.set('AMPDOC_URL', () => {\n      return removeFragment(this.addReplaceParamsIfMissing_(win.location.href));\n    });\n\n    // Returns the host of the URL for this AMP document.\n    this.set('AMPDOC_HOST', () => {\n      const url = parseUrlDeprecated(win.location.href);\n      return url && url.host;\n    });\n\n    // Returns the hostname of the URL for this AMP document.\n    this.set('AMPDOC_HOSTNAME', () => {\n      const url = parseUrlDeprecated(win.location.href);\n      return url && url.hostname;\n    });\n\n    // Returns the Source URL for this AMP document.\n    const expandSourceUrl = () => {\n      const docInfo = this.getDocInfo_();\n      return removeFragment(this.addReplaceParamsIfMissing_(docInfo.sourceUrl));\n    };\n    this.setBoth(\n      'SOURCE_URL',\n      () => expandSourceUrl(),\n      () => getTrackImpressionPromise().then(() => expandSourceUrl())\n    );\n\n    // Returns the host of the Source URL for this AMP document.\n    this.set(\n      'SOURCE_HOST',\n      () => parseUrlDeprecated(this.getDocInfo_().sourceUrl).host\n    );\n\n    // Returns the hostname of the Source URL for this AMP document.\n    this.set(\n      'SOURCE_HOSTNAME',\n      () => parseUrlDeprecated(this.getDocInfo_().sourceUrl).hostname\n    );\n\n    // Returns the path of the Source URL for this AMP document.\n    this.set(\n      'SOURCE_PATH',\n      () => parseUrlDeprecated(this.getDocInfo_().sourceUrl).pathname\n    );\n\n    // Returns a random string that will be the constant for the duration of\n    // single page view. It should have sufficient entropy to be unique for\n    // all the page views a single user is making at a time.\n    this.set('PAGE_VIEW_ID', () => this.getDocInfo_().pageViewId);\n\n    // Returns a random string that will be the constant for the duration of\n    // single page view. It should have sufficient entropy to be unique for\n    // all the page views a single user is making at a time.\n    this.setAsync('PAGE_VIEW_ID_64', () => this.getDocInfo_().pageViewId64);\n\n    this.setBoth(\n      'QUERY_PARAM',\n      (param, defaultValue = '') => {\n        return this.getQueryParamData_(param, defaultValue);\n      },\n      (param, defaultValue = '') => {\n        return getTrackImpressionPromise().then(() => {\n          return this.getQueryParamData_(param, defaultValue);\n        });\n      }\n    );\n\n    // Returns the value of the given field name in the fragment query string.\n    // Second parameter is an optional default value.\n    // For example, if location is 'pub.com/amp.html?x=1#y=2' then\n    // FRAGMENT_PARAM(y) returns '2' and FRAGMENT_PARAM(z, 3) returns 3.\n    this.set('FRAGMENT_PARAM', (param, defaultValue = '') => {\n      return this.getFragmentParamData_(param, defaultValue);\n    });\n\n    /**\n     * Stores client ids that were generated during this page view\n     * indexed by scope.\n     * @type {?Object<string, string>}\n     */\n    let clientIds = null;\n    // Synchronous alternative. Only works for scopes that were previously\n    // requested using the async method.\n    this.setBoth(\n      'CLIENT_ID',\n      (scope) => {\n        if (!clientIds) {\n          return null;\n        }\n        return clientIds[scope];\n      },\n      (scope, opt_userNotificationId, opt_cookieName, opt_disableBackup) => {\n        userAssert(\n          scope,\n          'The first argument to CLIENT_ID, the fallback' +\n            /*OK*/ ' Cookie name, is required'\n        );\n\n        let consent = Promise.resolve();\n\n        // If no `opt_userNotificationId` argument is provided then\n        // assume consent is given by default.\n        if (opt_userNotificationId) {\n          consent = Services.userNotificationManagerForDoc(element).then(\n            (service) => {\n              return service.get(opt_userNotificationId);\n            }\n          );\n        }\n        return Services.cidForDoc(this.ampdoc)\n          .then((cid) => {\n            opt_disableBackup = opt_disableBackup == 'true' ? true : false;\n            return cid.get(\n              {\n                /** @type {string} */ scope,\n                createCookieIfNotPresent: true,\n                cookieName: opt_cookieName || undefined,\n                disableBackup: opt_disableBackup,\n              },\n              consent\n            );\n          })\n          .then((cid) => {\n            if (!clientIds) {\n              clientIds = Object.create(null);\n            }\n\n            // A temporary work around to extract Client ID from _ga cookie. #5761\n            // TODO: replace with \"filter\" when it's in place. #2198\n            const cookieName = opt_cookieName || scope;\n            if (cid && cookieName == '_ga') {\n              if (typeof cid === 'string') {\n                cid = extractClientIdFromGaCookie(cid);\n              } else {\n                // TODO(@jridgewell, #11120): remove once #11120 is figured out.\n                // Do not log the CID directly, that's PII.\n                dev().error(\n                  TAG,\n                  'non-string cid, what is it?',\n                  Object.keys(cid)\n                );\n              }\n            }\n\n            clientIds[scope] = cid;\n            return cid;\n          });\n      }\n    );\n\n    // Returns assigned variant name for the given experiment.\n    this.setAsync(\n      'VARIANT',\n      /** @type {AsyncResolverDef} */ (\n        (experiment) => {\n          return this.getVariantsValue_((variants) => {\n            const variant = variants[/** @type {string} */ (experiment)];\n            userAssert(\n              variant !== undefined,\n              'The value passed to VARIANT() is not a valid experiment in <amp-experiment>:' +\n                experiment\n            );\n            // When no variant assigned, use reserved keyword 'none'.\n            return variant === null ? 'none' : /** @type {string} */ (variant);\n          }, 'VARIANT');\n        }\n      )\n    );\n\n    // Returns all assigned experiment variants in a serialized form.\n    this.setAsync(\n      'VARIANTS',\n      /** @type {AsyncResolverDef} */ (\n        () => {\n          return this.getVariantsValue_((variants) => {\n            const experiments = [];\n            for (const experiment in variants) {\n              const variant = variants[experiment];\n              experiments.push(\n                experiment + VARIANT_DELIMITER + (variant || 'none')\n              );\n            }\n            return experiments.join(EXPERIMENT_DELIMITER);\n          }, 'VARIANTS');\n        }\n      )\n    );\n\n    // Returns assigned geo value for geoType or all groups.\n    this.setAsync(\n      'AMP_GEO',\n      /** @type {AsyncResolverDef} */ (\n        (geoType) => {\n          return this.getGeo_((geos) => {\n            if (geoType) {\n              userAssert(\n                geoType === 'ISOCountry',\n                'The value passed to AMP_GEO() is not valid name:' + geoType\n              );\n              return /** @type {string} */ (geos[geoType] || 'unknown');\n            }\n            return /** @type {string} */ (\n              geos.matchedISOCountryGroups.join(GEO_DELIM)\n            );\n          }, 'AMP_GEO');\n        }\n      )\n    );\n\n    // Returns the number of milliseconds since 1 Jan 1970 00:00:00 UTC.\n    this.set('TIMESTAMP', dateMethod('getTime'));\n\n    // Returns the human readable timestamp in format of\n    // 2011-01-01T11:11:11.612Z.\n    this.set('TIMESTAMP_ISO', dateMethod('toISOString'));\n\n    // Returns the user's time-zone offset from UTC, in minutes.\n    this.set('TIMEZONE', dateMethod('getTimezoneOffset'));\n\n    // Returns a promise resolving to viewport.getScrollHeight.\n    this.set('SCROLL_HEIGHT', () => viewport.getScrollHeight());\n\n    // Returns a promise resolving to viewport.getScrollWidth.\n    this.set('SCROLL_WIDTH', () => viewport.getScrollWidth());\n\n    // Returns the viewport height.\n    this.set('VIEWPORT_HEIGHT', () => viewport.getHeight());\n\n    // Returns the viewport width.\n    this.set('VIEWPORT_WIDTH', () => viewport.getWidth());\n\n    const {screen} = win;\n    // Returns screen.width.\n    this.set('SCREEN_WIDTH', screenProperty(screen, 'width'));\n\n    // Returns screen.height.\n    this.set('SCREEN_HEIGHT', screenProperty(screen, 'height'));\n\n    // Returns screen.availHeight.\n    this.set('AVAILABLE_SCREEN_HEIGHT', screenProperty(screen, 'availHeight'));\n\n    // Returns screen.availWidth.\n    this.set('AVAILABLE_SCREEN_WIDTH', screenProperty(screen, 'availWidth'));\n\n    // Returns screen.ColorDepth.\n    this.set('SCREEN_COLOR_DEPTH', screenProperty(screen, 'colorDepth'));\n\n    // Returns document characterset.\n    this.set('DOCUMENT_CHARSET', () => {\n      const doc = win.document;\n      return doc.characterSet || doc.charset;\n    });\n\n    // Returns the browser language.\n    this.set('BROWSER_LANGUAGE', () => {\n      const nav = win.navigator;\n      return (\n        nav.language ||\n        // Only used on IE.\n        nav['userLanguage'] ||\n        nav.browserLanguage ||\n        ''\n      ).toLowerCase();\n    });\n\n    // Returns the user agent.\n    this.set('USER_AGENT', () => {\n      return win.navigator.userAgent;\n    });\n\n    // Returns the time it took to load the whole page. (excludes amp-* elements\n    // that are not rendered by the system yet.)\n    this.setTimingResolver_(\n      'PAGE_LOAD_TIME',\n      'navigationStart',\n      'loadEventStart'\n    );\n\n    // Returns the time it took to perform DNS lookup for the domain.\n    this.setTimingResolver_(\n      'DOMAIN_LOOKUP_TIME',\n      'domainLookupStart',\n      'domainLookupEnd'\n    );\n\n    // Returns the time it took to connect to the server.\n    this.setTimingResolver_('TCP_CONNECT_TIME', 'connectStart', 'connectEnd');\n\n    // Returns the time it took for server to start sending a response to the\n    // request.\n    this.setTimingResolver_(\n      'SERVER_RESPONSE_TIME',\n      'requestStart',\n      'responseStart'\n    );\n\n    // Returns the time it took to download the page.\n    this.setTimingResolver_(\n      'PAGE_DOWNLOAD_TIME',\n      'responseStart',\n      'responseEnd'\n    );\n\n    // Returns the time it took for redirects to complete.\n    this.setTimingResolver_('REDIRECT_TIME', 'navigationStart', 'fetchStart');\n\n    // Returns the time it took for DOM to become interactive.\n    this.setTimingResolver_(\n      'DOM_INTERACTIVE_TIME',\n      'navigationStart',\n      'domInteractive'\n    );\n\n    // Returns the time it took for content to load.\n    this.setTimingResolver_(\n      'CONTENT_LOAD_TIME',\n      'navigationStart',\n      'domContentLoadedEventStart'\n    );\n\n    // Access: Reader ID.\n    this.setAsync(\n      'ACCESS_READER_ID',\n      /** @type {AsyncResolverDef} */ (\n        () => {\n          return this.getAccessValue_((accessService) => {\n            return accessService.getAccessReaderId();\n          }, 'ACCESS_READER_ID');\n        }\n      )\n    );\n\n    // Access: data from the authorization response.\n    this.setAsync(\n      'AUTHDATA',\n      /** @type {AsyncResolverDef} */ (\n        (field) => {\n          userAssert(\n            field,\n            'The first argument to AUTHDATA, the field, is required'\n          );\n          return this.getAccessValue_((accessService) => {\n            return accessService.getAuthdataField(field);\n          }, 'AUTHDATA');\n        }\n      )\n    );\n\n    // Returns an identifier for the viewer.\n    this.setAsync('VIEWER', () => {\n      return Services.viewerForDoc(this.ampdoc)\n        .getViewerOrigin()\n        .then((viewer) => {\n          return viewer == undefined ? '' : viewer;\n        });\n    });\n\n    // Returns the total engaged time since the content became viewable.\n    this.setAsync('TOTAL_ENGAGED_TIME', () => {\n      return Services.activityForDoc(element).then((activity) => {\n        return activity.getTotalEngagedTime();\n      });\n    });\n\n    // Returns the incremental engaged time since the last push under the\n    // same name.\n    this.setAsync('INCREMENTAL_ENGAGED_TIME', (name, reset) => {\n      return Services.activityForDoc(element).then((activity) => {\n        return activity.getIncrementalEngagedTime(\n          /** @type {string} */ (name),\n          reset !== 'false'\n        );\n      });\n    });\n\n    this.set('NAV_TIMING', (startAttribute, endAttribute) => {\n      userAssert(\n        startAttribute,\n        'The first argument to NAV_TIMING, the ' +\n          'start attribute name, is required'\n      );\n      return getTimingDataSync(\n        win,\n        /**@type {string}*/ (startAttribute),\n        /**@type {string}*/ (endAttribute)\n      );\n    });\n    this.setAsync('NAV_TIMING', (startAttribute, endAttribute) => {\n      userAssert(\n        startAttribute,\n        'The first argument to NAV_TIMING, the ' +\n          'start attribute name, is required'\n      );\n      return getTimingDataAsync(\n        win,\n        /**@type {string}*/ (startAttribute),\n        /**@type {string}*/ (endAttribute)\n      );\n    });\n\n    this.set('NAV_TYPE', () => {\n      return getNavigationData(win, 'type');\n    });\n\n    this.set('NAV_REDIRECT_COUNT', () => {\n      return getNavigationData(win, 'redirectCount');\n    });\n\n    // returns the AMP version number\n    this.set('AMP_VERSION', () => internalRuntimeVersion());\n\n    this.set('BACKGROUND_STATE', () => {\n      return this.ampdoc.isVisible() ? '0' : '1';\n    });\n\n    this.setAsync('VIDEO_STATE', (id, property) => {\n      return Services.videoManagerForDoc(this.ampdoc).getVideoStateProperty(\n        id,\n        property\n      );\n    });\n\n    this.setAsync('AMP_STATE', (key) => {\n      // This is safe since AMP_STATE is not an A4A allowlisted variable.\n      const root = this.ampdoc.getRootNode();\n      const element = /** @type {!Element|!ShadowRoot} */ (\n        root.documentElement || root\n      );\n      return Services.bindForDocOrNull(element).then((bind) => {\n        if (!bind) {\n          return '';\n        }\n        return bind.getStateValue(/** @type {string} */ (key)) || '';\n      });\n    });\n  }\n\n  /**\n   * Merges any replacement parameters into a given URL's query string,\n   * preferring values set in the original query string.\n   * @param {string} orig The original URL\n   * @return {string} The resulting URL\n   * @private\n   */\n  addReplaceParamsIfMissing_(orig) {\n    const {replaceParams} = this.getDocInfo_();\n    if (!replaceParams) {\n      return orig;\n    }\n    return addMissingParamsToUrl(\n      removeAmpJsParamsFromUrl(orig),\n      /** @type {!JsonObject} */ (replaceParams)\n    );\n  }\n\n  /**\n   * Return the document info for the current ampdoc.\n   * @return {./document-info-impl.DocumentInfoDef}\n   */\n  getDocInfo_() {\n    return Services.documentInfoForDoc(this.ampdoc);\n  }\n\n  /**\n   * Resolves the value via access service. If access service is not configured,\n   * the resulting value is `null`.\n   * @param {function(!../../extensions/amp-access/0.1/access-vars.AccessVars):(T|!Promise<T>)} getter\n   * @param {string} expr\n   * @return {?T}\n   * @template T\n   * @private\n   */\n  getAccessValue_(getter, expr) {\n    const element = this.ampdoc.getHeadNode();\n    return Promise.all([\n      Services.accessServiceForDocOrNull(element),\n      Services.subscriptionsServiceForDocOrNull(element),\n    ]).then((services) => {\n      const accessService =\n        /** @type {?../../extensions/amp-access/0.1/access-vars.AccessVars} */ (\n          services[0]\n        );\n      const subscriptionService =\n        /** @type {?../../extensions/amp-access/0.1/access-vars.AccessVars} */ (\n          services[1]\n        );\n      const service = accessService || subscriptionService;\n      if (!service) {\n        // Access/subscriptions service is not installed.\n        user().error(\n          TAG,\n          'Access or subsciptions service is not installed to access: ',\n          expr\n        );\n        return null;\n      }\n\n      // If both an access and subscription service are present, prefer\n      // subscription then fall back to access because access can be namespaced.\n      if (accessService && subscriptionService) {\n        return getter(subscriptionService) || getter(accessService);\n      }\n\n      return getter(service);\n    });\n  }\n\n  /**\n   * Return the QUERY_PARAM from the current location href\n   * @param {string} param\n   * @param {string} defaultValue\n   * @return {string}\n   * @private\n   */\n  getQueryParamData_(param, defaultValue) {\n    userAssert(\n      param,\n      'The first argument to QUERY_PARAM, the query string ' +\n        'param is required'\n    );\n    const url = parseUrlDeprecated(\n      removeAmpJsParamsFromUrl(this.ampdoc.win.location.href)\n    );\n    const params = parseQueryString(url.search);\n    const {replaceParams} = this.getDocInfo_();\n    if (typeof params[param] !== 'undefined') {\n      return params[param];\n    }\n    if (replaceParams && typeof replaceParams[param] !== 'undefined') {\n      return /** @type {string} */ (replaceParams[param]);\n    }\n    return defaultValue;\n  }\n\n  /**\n   * Return the FRAGMENT_PARAM from the original location href\n   * @param {*} param\n   * @param {string} defaultValue\n   * @return {string}\n   * @private\n   */\n  getFragmentParamData_(param, defaultValue) {\n    userAssert(\n      param,\n      'The first argument to FRAGMENT_PARAM, the fragment string ' +\n        'param is required'\n    );\n    userAssert(typeof param == 'string', 'param should be a string');\n    const hash = this.ampdoc.win.location['originalHash'];\n    const params = parseQueryString(hash);\n    return params[param] === undefined ? defaultValue : params[param];\n  }\n\n  /**\n   * Resolves the value via amp-experiment's variants service.\n   * @param {function(!Object<string, string>):(?string)} getter\n   * @param {string} expr\n   * @return {!Promise<?string>}\n   * @template T\n   * @private\n   */\n  getVariantsValue_(getter, expr) {\n    return Services.variantsForDocOrNull(this.ampdoc.getHeadNode())\n      .then((variants) => {\n        userAssert(\n          variants,\n          'To use variable %s, amp-experiment should be configured',\n          expr\n        );\n        return variants.getVariants();\n      })\n      .then((variantsMap) => getter(variantsMap));\n  }\n\n  /**\n   * Resolves the value via geo service.\n   * @param {function(!../../extensions/amp-geo/0.1/amp-geo.GeoDef)} getter\n   * @param {string} expr\n   * @return {!Promise<Object<string,(string|Array<string>)>>}\n   * @template T\n   * @private\n   */\n  getGeo_(getter, expr) {\n    const element = this.ampdoc.getHeadNode();\n    return Services.geoForDocOrNull(element).then((geo) => {\n      userAssert(geo, 'To use variable %s, amp-geo should be configured', expr);\n      return getter(geo);\n    });\n  }\n}\n\n/**\n * This class replaces substitution variables with their values.\n * Document new values in ../docs/spec/amp-var-substitutions.md\n * @package For export\n */\nexport class UrlReplacements {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!VariableSource} variableSource\n   */\n  constructor(ampdoc, variableSource) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @type {VariableSource} */\n    this.variableSource_ = variableSource;\n  }\n\n  /**\n   * Synchronously expands the provided source by replacing all known variables\n   * with their resolved values. Optional `opt_bindings` can be used to add new\n   * variables or override existing ones.  Any async bindings are ignored.\n   * @param {string} source\n   * @param {!Object<string, (ResolverReturnDef|!SyncResolverDef)>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_allowlist Optional allowlist of\n   *     names that can be substituted.\n   * @return {string}\n   */\n  expandStringSync(source, opt_bindings, opt_allowlist) {\n    return /** @type {string} */ (\n      new Expander(\n        this.variableSource_,\n        opt_bindings,\n        /* opt_collectVars */ undefined,\n        /* opt_sync */ true,\n        opt_allowlist,\n        /* opt_noEncode */ true\n      )./*OK*/ expand(source)\n    );\n  }\n\n  /**\n   * Expands the provided source by replacing all known variables with their\n   * resolved values. Optional `opt_bindings` can be used to add new variables\n   * or override existing ones.\n   * @param {string} source\n   * @param {!Object<string, *>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_allowlist\n   * @return {!Promise<string>}\n   */\n  expandStringAsync(source, opt_bindings, opt_allowlist) {\n    return /** @type {!Promise<string>} */ (\n      new Expander(\n        this.variableSource_,\n        opt_bindings,\n        /* opt_collectVars */ undefined,\n        /* opt_sync */ undefined,\n        opt_allowlist,\n        /* opt_noEncode */ true\n      )./*OK*/ expand(source)\n    );\n  }\n\n  /**\n   * Synchronously expands the provided URL by replacing all known variables\n   * with their resolved values. Optional `opt_bindings` can be used to add new\n   * variables or override existing ones.  Any async bindings are ignored.\n   * @param {string} url\n   * @param {!Object<string, (ResolverReturnDef|!SyncResolverDef)>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_allowlist Optional allowlist of\n   *     names that can be substituted.\n   * @return {string}\n   */\n  expandUrlSync(url, opt_bindings, opt_allowlist) {\n    return this.ensureProtocolMatches_(\n      url,\n      /** @type {string} */ (\n        new Expander(\n          this.variableSource_,\n          opt_bindings,\n          /* opt_collectVars */ undefined,\n          /* opt_sync */ true,\n          opt_allowlist\n        )./*OK*/ expand(url)\n      )\n    );\n  }\n\n  /**\n   * Expands the provided URL by replacing all known variables with their\n   * resolved values. Optional `opt_bindings` can be used to add new variables\n   * or override existing ones.\n   * @param {string} url\n   * @param {!Object<string, *>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_allowlist Optional allowlist of names\n   *     that can be substituted.\n   * @param {boolean=} opt_noEncode should not encode URL\n   * @return {!Promise<string>}\n   */\n  expandUrlAsync(url, opt_bindings, opt_allowlist, opt_noEncode) {\n    return /** @type {!Promise<string>} */ (\n      new Expander(\n        this.variableSource_,\n        opt_bindings,\n        /* opt_collectVars */ undefined,\n        /* opt_sync */ undefined,\n        opt_allowlist,\n        opt_noEncode\n      )\n        ./*OK*/ expand(url)\n        .then((replacement) => this.ensureProtocolMatches_(url, replacement))\n    );\n  }\n\n  /**\n   * Expands an input element value attribute with variable substituted.\n   * @param {!HTMLInputElement} element\n   * @return {!Promise<string>}\n   */\n  expandInputValueAsync(element) {\n    return /** @type {!Promise<string>} */ (\n      this.expandInputValue_(element, /*opt_sync*/ false)\n    );\n  }\n\n  /**\n   * Expands an input element value attribute with variable substituted.\n   * @param {!HTMLInputElement} element\n   * @return {string} Replaced string for testing\n   */\n  expandInputValueSync(element) {\n    return /** @type {string} */ (\n      this.expandInputValue_(element, /*opt_sync*/ true)\n    );\n  }\n\n  /**\n   * Expands in input element value attribute with variable substituted.\n   * @param {!HTMLInputElement} element\n   * @param {boolean=} opt_sync\n   * @return {string|!Promise<string>}\n   */\n  expandInputValue_(element, opt_sync) {\n    devAssert(\n      element.tagName == 'INPUT' &&\n        (element.getAttribute('type') || '').toLowerCase() == 'hidden',\n      'Input value expansion only works on hidden input fields: %s',\n      element\n    );\n\n    const allowlist = this.getAllowlistForElement_(element);\n    if (!allowlist) {\n      return opt_sync ? element.value : Promise.resolve(element.value);\n    }\n    if (element[ORIGINAL_VALUE_PROPERTY] === undefined) {\n      element[ORIGINAL_VALUE_PROPERTY] = element.value;\n    }\n    const result = new Expander(\n      this.variableSource_,\n      /* opt_bindings */ undefined,\n      /* opt_collectVars */ undefined,\n      /* opt_sync */ opt_sync,\n      /* opt_allowlist */ allowlist\n    )./*OK*/ expand(element[ORIGINAL_VALUE_PROPERTY] || element.value);\n\n    if (opt_sync) {\n      return (element.value = result);\n    }\n    return result.then((newValue) => {\n      element.value = newValue;\n      return newValue;\n    });\n  }\n\n  /**\n   * Returns a replacement allowlist from elements' data-amp-replace attribute.\n   * @param {!Element} element\n   * @param {!Object<string, boolean>=} opt_supportedReplacement Optional supported\n   * replacement that filters allowlist to a subset.\n   * @return {!Object<string, boolean>|undefined}\n   */\n  getAllowlistForElement_(element, opt_supportedReplacement) {\n    const allowlist = element.getAttribute('data-amp-replace');\n    if (!allowlist) {\n      return;\n    }\n    const requestedReplacements = {};\n    allowlist\n      .trim()\n      .split(/\\s+/)\n      .forEach((replacement) => {\n        if (\n          !opt_supportedReplacement ||\n          hasOwn(opt_supportedReplacement, replacement)\n        ) {\n          requestedReplacements[replacement] = true;\n        } else {\n          user().warn('URL', 'Ignoring unsupported replacement', replacement);\n        }\n      });\n    return requestedReplacements;\n  }\n\n  /**\n   * Returns whether variable substitution is allowed for given url.\n   * @param {!Location} url\n   * @return {boolean}\n   */\n  isAllowedOrigin_(url) {\n    const docInfo = Services.documentInfoForDoc(this.ampdoc);\n    if (\n      url.origin == parseUrlDeprecated(docInfo.canonicalUrl).origin ||\n      url.origin == parseUrlDeprecated(docInfo.sourceUrl).origin\n    ) {\n      return true;\n    }\n\n    const meta = this.ampdoc.getMetaByName('amp-link-variable-allowed-origin');\n    if (meta) {\n      const allowlist = meta.trim().split(/\\s+/);\n      for (let i = 0; i < allowlist.length; i++) {\n        if (url.origin == parseUrlDeprecated(allowlist[i]).origin) {\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Replaces values in the link of an anchor tag if\n   * - the link opts into it (via data-amp-replace argument)\n   * - the destination is the source or canonical origin of this doc.\n   * @param {!Element} element An anchor element.\n   * @param {?string} defaultUrlParams to expand link if caller request.\n   * @return {string|undefined} Replaced string for testing\n   */\n  maybeExpandLink(element, defaultUrlParams) {\n    devAssert(element.tagName == 'A');\n    const aElement = /** @type {!HTMLAnchorElement} */ (element);\n    const supportedReplacements = {\n      'CLIENT_ID': true,\n      'QUERY_PARAM': true,\n      'PAGE_VIEW_ID': true,\n      'PAGE_VIEW_ID_64': true,\n      'NAV_TIMING': true,\n    };\n    let additionalUrlParameters =\n      aElement.getAttribute('data-amp-addparams') || '';\n    const allowlist = this.getAllowlistForElement_(\n      aElement,\n      supportedReplacements\n    );\n\n    if (!allowlist && !additionalUrlParameters && !defaultUrlParams) {\n      return;\n    }\n    // ORIGINAL_HREF_PROPERTY has the value of the href \"pre-replacement\".\n    // We set this to the original value before doing any work and use it\n    // on subsequent replacements, so that each run gets a fresh value.\n    let href = dev().assertString(\n      aElement[ORIGINAL_HREF_PROPERTY] || aElement.getAttribute('href')\n    );\n    const url = parseUrlDeprecated(href);\n    if (aElement[ORIGINAL_HREF_PROPERTY] == null) {\n      aElement[ORIGINAL_HREF_PROPERTY] = href;\n    }\n\n    const isAllowedOrigin = this.isAllowedOrigin_(url);\n    if (additionalUrlParameters) {\n      additionalUrlParameters = isAllowedOrigin\n        ? this.expandSyncIfAllowedList_(additionalUrlParameters, allowlist)\n        : additionalUrlParameters;\n      href = addParamsToUrl(href, parseQueryString(additionalUrlParameters));\n    }\n\n    if (!isAllowedOrigin) {\n      if (allowlist) {\n        user().warn(\n          'URL',\n          'Ignoring link replacement %s' +\n            \" because the link does not go to the document's\" +\n            ' source, canonical, or allowlisted origin.',\n          href\n        );\n      }\n      return (aElement.href = href);\n    }\n\n    // Note that defaultUrlParams is treated differently than\n    // additionalUrlParameters in two ways #1: If the outgoing url origin is not\n    // allowlisted: additionalUrlParameters are always appended by not expanded,\n    // defaultUrlParams will not be appended. #2: If the expansion function is\n    // not allowlisted: additionalUrlParamters will not be expanded,\n    // defaultUrlParams will by default support QUERY_PARAM, and will still be\n    // expanded.\n    if (defaultUrlParams) {\n      if (!allowlist || !allowlist['QUERY_PARAM']) {\n        // override allowlist and expand defaultUrlParams;\n        const overrideAllowlist = {'QUERY_PARAM': true};\n        defaultUrlParams = this.expandUrlSync(\n          defaultUrlParams,\n          /* opt_bindings */ undefined,\n          /* opt_allowlist */ overrideAllowlist\n        );\n      }\n      href = addParamsToUrl(href, parseQueryString(defaultUrlParams));\n    }\n\n    href = this.expandSyncIfAllowedList_(href, allowlist);\n\n    return (aElement.href = href);\n  }\n\n  /**\n   * @param {string} href\n   * @param {!Object<string, boolean>|undefined} allowlist\n   * @return {string}\n   */\n  expandSyncIfAllowedList_(href, allowlist) {\n    return allowlist\n      ? this.expandUrlSync(\n          href,\n          /* opt_bindings */ undefined,\n          /* opt_allowlist */ allowlist\n        )\n      : href;\n  }\n\n  /**\n   * Collects all substitutions in the provided URL and expands them to the\n   * values for known variables. Optional `opt_bindings` can be used to add\n   * new variables or override existing ones.\n   * @param {string} url\n   * @param {!Object<string, *>=} opt_bindings\n   * @return {!Promise<!Object<string, *>>}\n   */\n  collectVars(url, opt_bindings) {\n    const vars = Object.create(null);\n    return new Expander(this.variableSource_, opt_bindings, vars)\n      ./*OK*/ expand(url)\n      .then(() => vars);\n  }\n\n  /**\n   * Collects substitutions in the `src` attribute of the given element\n   * that are _not_ allowlisted via `data-amp-replace` opt-in attribute.\n   * @param {!Element} element\n   * @return {!Array<string>}\n   */\n  collectDisallowedVarsSync(element) {\n    const url = element.getAttribute('src');\n    const macroNames = new Expander(this.variableSource_).getMacroNames(url);\n    const allowlist = this.getAllowlistForElement_(element);\n    if (allowlist) {\n      return macroNames.filter((v) => !allowlist[v]);\n    } else {\n      // All vars are unallowlisted if the element has no allowlist.\n      return macroNames;\n    }\n  }\n\n  /**\n   * Ensures that the protocol of the original url matches the protocol of the\n   * replacement url. Returns the replacement if they do, the original if they\n   * do not.\n   * @param {string} url\n   * @param {string} replacement\n   * @return {string}\n   */\n  ensureProtocolMatches_(url, replacement) {\n    const newProtocol = parseUrlDeprecated(\n      replacement,\n      /* opt_nocache */ true\n    ).protocol;\n    const oldProtocol = parseUrlDeprecated(\n      url,\n      /* opt_nocache */ true\n    ).protocol;\n    if (newProtocol != oldProtocol) {\n      user().error(TAG, 'Illegal replacement of the protocol: ', url);\n      return url;\n    }\n    userAssert(\n      isProtocolValid(replacement),\n      'The replacement url has invalid protocol: %s',\n      replacement\n    );\n\n    return replacement;\n  }\n\n  /**\n   * @return {VariableSource}\n   */\n  getVariableSource() {\n    return this.variableSource_;\n  }\n}\n\n/**\n * Extracts client ID from a _ga cookie.\n * https://developers.google.com/analytics/devguides/collection/analyticsjs/cookies-user-id\n * @param {string} gaCookie\n * @return {string}\n */\nexport function extractClientIdFromGaCookie(gaCookie) {\n  return gaCookie.replace(/^(GA1|1)\\.[\\d-]+\\./, '');\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installUrlReplacementsServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'url-replace', function (doc) {\n    return new UrlReplacements(doc, new GlobalVariableSource(doc));\n  });\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!VariableSource} varSource\n */\nexport function installUrlReplacementsForEmbed(ampdoc, varSource) {\n  installServiceInEmbedDoc(\n    ampdoc,\n    'url-replace',\n    new UrlReplacements(ampdoc, varSource)\n  );\n}\n\n/**\n * @typedef {{incomingFragment: string, outgoingFragment: string}}\n */\nlet ShareTrackingFragmentsDef;\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isString} from '../types';\n\n/**\n * Number between 0 and 1 that designates normalized time, as in \"from start to\n * end\".\n * @typedef {number}\n */\nexport let NormTimeDef;\n\n/**\n * A CurveDef is a function that returns a normtime value (0 to 1) for another\n * normtime value.\n * @typedef {function(NormTimeDef): NormTimeDef}\n */\nexport let CurveDef;\n\n/**\n * Returns a cubic bezier curve.\n * @param {number} x1 X coordinate of the first control point.\n * @param {number} y1 Y coordinate of the first control point.\n * @param {number} x2 X coordinate of the second control point.\n * @param {number} y2 Y coordinate of the second control point.\n * @return {!CurveDef}\n */\nexport function bezierCurve(x1, y1, x2, y2) {\n  return (xVal) =>\n    Bezier.solveYValueFromXValue(xVal, 0, 0, x1, y1, x2, y2, 1, 1);\n}\n\n/**\n * Thanks to\n * https://closure-library.googlecode.com/git-history/docs/local_closure_goog_math_bezier.js.source.html\n */\nclass Bezier {\n  /**\n   * Computes the y coordinate of a point on the curve given its x coordinate.\n   * @param {number} xVal The x coordinate of the point on the curve.\n   * @param {number} x0 X coordinate of the start point.\n   * @param {number} y0 Y coordinate of the start point.\n   * @param {number} x1 X coordinate of the first control point.\n   * @param {number} y1 Y coordinate of the first control point.\n   * @param {number} x2 X coordinate of the second control point.\n   * @param {number} y2 Y coordinate of the second control point.\n   * @param {number} x3 X coordinate of the end point.\n   * @param {number} y3 Y coordinate of the end point.\n   * @return {number} The y coordinate of the point on the curve.\n   */\n  static solveYValueFromXValue(xVal, x0, y0, x1, y1, x2, y2, x3, y3) {\n    return Bezier.getPointY_(\n      Bezier.solvePositionFromXValue_(xVal, x0, x1, x2, x3),\n      y0,\n      y1,\n      y2,\n      y3\n    );\n  }\n\n  /**\n   * Computes the position t of a point on the curve given its x coordinate.\n   * That is, for an input xVal, finds t s.t. getPointX(t) = xVal.\n   * As such, the following should always be true up to some small epsilon:\n   * t ~ solvePositionFromXValue(getPointX(t)) for t in [0, 1].\n   * @param {number} xVal The x coordinate of the point to find on the curve.\n   * @param {number} x0 X coordinate of the start point.\n   * @param {number} x1 X coordinate of the first control point.\n   * @param {number} x2 X coordinate of the second control point.\n   * @param {number} x3 X coordinate of the end point.\n   * @return {number} The position t.\n   * @private\n   */\n  static solvePositionFromXValue_(xVal, x0, x1, x2, x3) {\n    // Desired precision on the computation.\n    const epsilon = 1e-6;\n\n    // Initial estimate of t using linear interpolation.\n    let t = (xVal - x0) / (x3 - x0);\n    if (t <= 0) {\n      return 0;\n    } else if (t >= 1) {\n      return 1;\n    }\n\n    // Try gradient descent to solve for t. If it works, it is very fast.\n    let tMin = 0;\n    let tMax = 1;\n    let value = 0;\n    for (let i = 0; i < 8; i++) {\n      value = Bezier.getPointX_(t, x0, x1, x2, x3);\n      const derivative =\n        (Bezier.getPointX_(t + epsilon, x0, x1, x2, x3) - value) / epsilon;\n      if (Math.abs(value - xVal) < epsilon) {\n        return t;\n      } else if (Math.abs(derivative) < epsilon) {\n        break;\n      } else {\n        if (value < xVal) {\n          tMin = t;\n        } else {\n          tMax = t;\n        }\n        t -= (value - xVal) / derivative;\n      }\n    }\n\n    // If the gradient descent got stuck in a local minimum, e.g. because\n    // the derivative was close to 0, use a Dichotomy refinement instead.\n    // We limit the number of iterations to 8.\n    for (let i = 0; Math.abs(value - xVal) > epsilon && i < 8; i++) {\n      if (value < xVal) {\n        tMin = t;\n        t = (t + tMax) / 2;\n      } else {\n        tMax = t;\n        t = (t + tMin) / 2;\n      }\n      value = Bezier.getPointX_(t, x0, x1, x2, x3);\n    }\n    return t;\n  }\n\n  /**\n   * Computes the curve's X coordinate at a point between 0 and 1.\n   * @param {number} t The point on the curve to find.\n   * @param {number} x0 X coordinate of the start point.\n   * @param {number} x1 X coordinate of the first control point.\n   * @param {number} x2 X coordinate of the second control point.\n   * @param {number} x3 X coordinate of the end point.\n   * @return {number} The computed coordinate.\n   * @private\n   */\n  static getPointX_(t, x0, x1, x2, x3) {\n    // Special case start and end.\n    if (t == 0) {\n      return x0;\n    } else if (t == 1) {\n      return x3;\n    }\n\n    // Step one - from 4 points to 3\n    let ix0 = Bezier.lerp_(x0, x1, t);\n    let ix1 = Bezier.lerp_(x1, x2, t);\n    const ix2 = Bezier.lerp_(x2, x3, t);\n\n    // Step two - from 3 points to 2\n    ix0 = Bezier.lerp_(ix0, ix1, t);\n    ix1 = Bezier.lerp_(ix1, ix2, t);\n\n    // Final step - last point\n    return Bezier.lerp_(ix0, ix1, t);\n  }\n\n  /**\n   * Computes the curve's Y coordinate at a point between 0 and 1.\n   * @param {number} t The point on the curve to find.\n   * @param {number} y0 Y coordinate of the start point.\n   * @param {number} y1 Y coordinate of the first control point.\n   * @param {number} y2 Y coordinate of the second control point.\n   * @param {number} y3 Y coordinate of the end point.\n   * @return {number} The computed coordinate.\n   * @private\n   */\n  static getPointY_(t, y0, y1, y2, y3) {\n    // Special case start and end.\n    if (t == 0) {\n      return y0;\n    } else if (t == 1) {\n      return y3;\n    }\n\n    // Step one - from 4 points to 3\n    let iy0 = Bezier.lerp_(y0, y1, t);\n    let iy1 = Bezier.lerp_(y1, y2, t);\n    const iy2 = Bezier.lerp_(y2, y3, t);\n\n    // Step two - from 3 points to 2\n    iy0 = Bezier.lerp_(iy0, iy1, t);\n    iy1 = Bezier.lerp_(iy1, iy2, t);\n\n    // Final step - last point\n    return Bezier.lerp_(iy0, iy1, t);\n  }\n\n  /**\n   * Performs linear interpolation between values a and b. Returns the value\n   * between a and b proportional to x (when x is between 0 and 1. When x is\n   * outside this range, the return value is a linear extrapolation).\n   * @param {number} a A number.\n   * @param {number} b A number.\n   * @param {number} x The proportion between a and b.\n   * @return {number} The interpolated value between a and b.\n   * @private\n   */\n  static lerp_(a, b, x) {\n    return a + x * (b - a);\n  }\n}\n\n/**\n * A collection of common curves.\n * See https://developer.mozilla.org/en-US/docs/Web/CSS/timing-function\n * @enum {!CurveDef}\n */\nexport const Curves = {\n  /**\n   * linear\n   * @param {!NormTimeDef} xVal\n   * @return {!NormTimeDef}\n   */\n  LINEAR(xVal) {\n    return xVal;\n  },\n\n  /**\n   * ease\n   * @param {!NormTimeDef} xVal\n   * @return {!NormTimeDef}\n   */\n  EASE(xVal) {\n    return Bezier.solveYValueFromXValue(xVal, 0, 0, 0.25, 0.1, 0.25, 1.0, 1, 1);\n  },\n\n  /**\n   * ease-in: slow out, fast in\n   * @param {!NormTimeDef} xVal\n   * @return {!NormTimeDef}\n   */\n  EASE_IN(xVal) {\n    return Bezier.solveYValueFromXValue(xVal, 0, 0, 0.42, 0.0, 1.0, 1.0, 1, 1);\n  },\n\n  /**\n   * ease-out: fast out, slow in\n   * @param {!NormTimeDef} xVal\n   * @return {!NormTimeDef}\n   */\n  EASE_OUT(xVal) {\n    return Bezier.solveYValueFromXValue(xVal, 0, 0, 0.0, 0.0, 0.58, 1.0, 1, 1);\n  },\n\n  /**\n   * ease-in-out\n   * @param {!NormTimeDef} xVal\n   * @return {!NormTimeDef}\n   */\n  EASE_IN_OUT(xVal) {\n    return Bezier.solveYValueFromXValue(xVal, 0, 0, 0.42, 0.0, 0.58, 1.0, 1, 1);\n  },\n};\n\n/**\n * @const {!Object<string, !CurveDef>}\n */\nconst NAME_MAP = {\n  'linear': Curves.LINEAR,\n  'ease': Curves.EASE,\n  'ease-in': Curves.EASE_IN,\n  'ease-out': Curves.EASE_OUT,\n  'ease-in-out': Curves.EASE_IN_OUT,\n};\n\n/**\n * If the argument is a string, this methods matches an existing curve by name.\n * @param {?CurveDef|string|undefined} curve\n * @return {?CurveDef}\n */\nexport function getCurve(curve) {\n  if (!curve) {\n    return null;\n  }\n  if (isString(curve)) {\n    curve = /** @type {string} */ (curve);\n    // If the curve is a custom cubic-bezier curve\n    if (curve.indexOf('cubic-bezier') != -1) {\n      const match = curve.match(/cubic-bezier\\((.+)\\)/);\n      if (match) {\n        const values = match[1].split(',').map(parseFloat);\n        if (values.length == 4) {\n          for (let i = 0; i < 4; i++) {\n            if (isNaN(values[i])) {\n              return null;\n            }\n          }\n          return bezierCurve(values[0], values[1], values[2], values[3]);\n        }\n      }\n      return null;\n    }\n    return NAME_MAP[curve];\n  }\n  return /** @type {!CurveDef} */ (curve);\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {VisibilityState} from '../core/constants/visibility-state';\nimport {getVendorJsPropertyName} from '../style';\n\n/**\n * @param {!Document} doc\n * @return {!VisibilityState}\n */\nexport function getDocumentVisibilityState(doc) {\n  // New API: `document.visibilityState` property.\n  const visibilityStateProp = getVendorJsPropertyName(\n    doc,\n    'visibilityState',\n    true\n  );\n  if (doc[visibilityStateProp]) {\n    return doc[visibilityStateProp];\n  }\n\n  // Old API: `document.hidden` property.\n  const hiddenProp = getVendorJsPropertyName(doc, 'hidden', true);\n  if (doc[hiddenProp]) {\n    return doc[hiddenProp] ? VisibilityState.HIDDEN : VisibilityState.VISIBLE;\n  }\n\n  return VisibilityState.VISIBLE;\n}\n\n/**\n * Returns the value of \"document.hidden\" property. The reasons why it may\n * not be visible include document in a non-active tab or when the document\n * is being pre-rendered via link with rel=\"prerender\".\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isDocumentHidden(doc) {\n  return getDocumentVisibilityState(doc) != VisibilityState.VISIBLE;\n}\n\n/**\n * @param {!Document} doc\n * @param {function()} handler\n */\nexport function addDocumentVisibilityChangeListener(doc, handler) {\n  if (!doc.addEventListener) {\n    return;\n  }\n  const visibilityChangeEvent = getVisibilityChangeEvent(doc);\n  if (visibilityChangeEvent) {\n    doc.addEventListener(visibilityChangeEvent, handler);\n  }\n}\n\n/**\n * @param {!Document} doc\n * @param {function()} handler\n */\nexport function removeDocumentVisibilityChangeListener(doc, handler) {\n  if (!doc.removeEventListener) {\n    return;\n  }\n  const visibilityChangeEvent = getVisibilityChangeEvent(doc);\n  if (visibilityChangeEvent) {\n    doc.removeEventListener(visibilityChangeEvent, handler);\n  }\n}\n\n/**\n * @param {!Document} doc\n * @return {?string}\n */\nfunction getVisibilityChangeEvent(doc) {\n  const hiddenProp = getVendorJsPropertyName(doc, 'hidden', true);\n  const vendorStop = hiddenProp.indexOf('Hidden');\n  return vendorStop != -1\n    ? hiddenProp.substring(0, vendorStop) + 'Visibilitychange'\n    : 'visibilitychange';\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../core/data-structures/promise';\nimport {Pass} from '../pass';\nimport {Services} from '../services';\nimport {\n  addDocumentVisibilityChangeListener,\n  isDocumentHidden,\n  removeDocumentVisibilityChangeListener,\n} from '../utils/document-visibility';\nimport {cancellation} from '../error-reporting';\nimport {dev, devAssert} from '../log';\nimport {getService, registerServiceBuilder} from '../service';\nimport {installTimerService} from './timer-impl';\nimport {rethrowAsync} from '../core/error';\n\n/** @const {time} */\nconst FRAME_TIME = 16;\n\n/**\n * @typedef {!Object<string, *>}\n */\nlet VsyncStateDef;\n\n/**\n * @typedef {{\n *   measure: (function(!VsyncStateDef):undefined|undefined),\n *   mutate: (function(!VsyncStateDef):undefined|undefined)\n * }}\n */\nlet VsyncTaskSpecDef;\n\n/**\n * Abstraction over requestAnimationFrame (rAF) that batches DOM read (measure)\n * and write (mutate) tasks in a single frame, to eliminate layout thrashing.\n *\n * NOTE: If the document is invisible due to prerendering (this includes\n * application-level prerendering where the doc is rendered in a hidden\n * iframe or webview), then no frame will be scheduled.\n * @package Visible for type.\n * @implements {../service.Disposable}\n */\nexport class Vsync {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!./ampdoc-impl.AmpDocService} */\n    this.ampdocService_ = Services.ampdocServiceFor(this.win);\n\n    /** @private @const {function(function())}  */\n    this.raf_ = this.getRaf_();\n\n    /**\n     * Tasks to run in the next frame.\n     * @private {!Array<!VsyncTaskSpecDef>}\n     */\n    this.tasks_ = [];\n\n    /**\n     * Double buffer for tasks.\n     * @private {!Array<!VsyncTaskSpecDef>}\n     */\n    this.nextTasks_ = [];\n\n    /**\n     * States for tasks in the next frame in the same order.\n     * @private {!Array<!VsyncStateDef>}\n     */\n    this.states_ = [];\n\n    /**\n     * Double buffer for states.\n     * @private {!Array<!VsyncStateDef>}\n     */\n    this.nextStates_ = [];\n\n    /**\n     * Whether a new animation frame has been scheduled.\n     * @private {boolean}\n     */\n    this.scheduled_ = false;\n\n    /** @private {?Promise} */\n    this.nextFramePromise_ = null;\n\n    /** @protected {?function()} */\n    this.nextFrameResolver_ = null;\n\n    /** @const {!Function} */\n    this.boundRunScheduledTasks_ = this.runScheduledTasks_.bind(this);\n\n    /**\n     * If the doc is invisible we use this instead of rAF because rAF\n     * does not run in that scenario.\n     * However, we only do this for non-animation tasks as running\n     * animations doesn't make sense when not visible.\n     * @const {!Pass}\n     */\n    this.invisiblePass_ = new Pass(\n      this.win,\n      this.boundRunScheduledTasks_,\n      FRAME_TIME\n    );\n\n    /**\n     * Similar to this.invisiblePass_, but backing up a real rAF call. If we\n     * somehow failed to know that we are throttled we use a timer (which\n     * may also be throttled but at least runs eventually) to make sure\n     * we continue to get work done.\n     * @const {!Pass}\n     */\n    this.backupPass_ = new Pass(\n      this.win,\n      this.boundRunScheduledTasks_,\n      // We cancel this when rAF fires and really only want it to fire\n      // if rAF doesn't work at all.\n      FRAME_TIME * 2.5\n    );\n\n    // When the document changes visibility, vsync has to reschedule the queue\n    // processing.\n    /** @private {function()} */\n    this.boundOnVisibilityChanged_ = this.onVisibilityChanged_.bind(this);\n    if (this.ampdocService_.isSingleDoc()) {\n      // In a single-doc mode, the visibility of the doc == global visibility.\n      // Thus, it's more efficient to only listen to it once.\n      this.ampdocService_\n        .getSingleDoc()\n        .onVisibilityChanged(this.boundOnVisibilityChanged_);\n    } else {\n      // In multi-doc mode, we track separately the global visibility and\n      // per-doc visibility when necessary.\n      addDocumentVisibilityChangeListener(\n        this.win.document,\n        this.boundOnVisibilityChanged_\n      );\n    }\n  }\n\n  /** @override */\n  dispose() {\n    removeDocumentVisibilityChangeListener(\n      this.win.document,\n      this.boundOnVisibilityChanged_\n    );\n  }\n\n  /** @private */\n  onVisibilityChanged_() {\n    if (this.scheduled_) {\n      this.forceSchedule_();\n    }\n  }\n\n  /**\n   * Runs vsync task: measure followed by mutate.\n   *\n   * If state is not provided, the value passed to the measure and mutate\n   * will be undefined.\n   *\n   * @param {!VsyncTaskSpecDef} task\n   * @param {!VsyncStateDef=} opt_state\n   */\n  run(task, opt_state) {\n    this.tasks_.push(task);\n    this.states_.push(opt_state || undefined);\n    this.schedule_();\n  }\n\n  /**\n   * Runs vsync task: measure followed by mutate. Returns the promise that\n   * will be resolved as soon as the task has been completed.\n   *\n   * If state is not provided, the value passed to the measure and mutate\n   * will be undefined.\n   *\n   * @param {!VsyncTaskSpecDef} task\n   * @param {!VsyncStateDef=} opt_state\n   * @return {!Promise}\n   */\n  runPromise(task, opt_state) {\n    this.run(task, opt_state);\n    if (this.nextFramePromise_) {\n      return this.nextFramePromise_;\n    }\n    const deferred = new Deferred();\n    this.nextFrameResolver_ = deferred.resolve;\n    return (this.nextFramePromise_ = deferred.promise);\n  }\n\n  /**\n   * Creates a function that will call {@link run} method.\n   * @param {!VsyncTaskSpecDef} task\n   * @return {function(!VsyncStateDef=)}\n   */\n  createTask(task) {\n    return /** @type {function(!VsyncStateDef=)} */ (\n      (opt_state) => {\n        this.run(task, opt_state);\n      }\n    );\n  }\n\n  /**\n   * Runs the mutate operation via vsync.\n   * @param {function():undefined} mutator\n   */\n  mutate(mutator) {\n    this.run({\n      measure: undefined, // For uniform hidden class.\n      mutate: mutator,\n    });\n  }\n\n  /**\n   * Runs `mutate` wrapped in a promise.\n   * @param {function():undefined} mutator\n   * @return {!Promise}\n   */\n  mutatePromise(mutator) {\n    return this.runPromise({\n      measure: undefined,\n      mutate: mutator,\n    });\n  }\n\n  /**\n   * Runs the measure operation via vsync.\n   * @param {function():undefined} measurer\n   */\n  measure(measurer) {\n    this.run({\n      measure: measurer,\n      mutate: undefined, // For uniform hidden class.\n    });\n  }\n\n  /**\n   * Runs `measure` wrapped in a promise.\n   * @param {function():TYPE} measurer\n   * @return {!Promise<TYPE>}\n   * @template TYPE\n   */\n  measurePromise(measurer) {\n    return new Promise((resolve) => {\n      this.measure(() => {\n        resolve(measurer());\n      });\n    });\n  }\n\n  /**\n   * Whether the runtime is allowed to animate at this time.\n   * @param {!Node} contextNode\n   * @return {boolean}\n   */\n  canAnimate(contextNode) {\n    return this.canAnimate_(devAssert(contextNode));\n  }\n\n  /**\n   * @param {!Node=} opt_contextNode\n   * @return {boolean}\n   * @private\n   */\n  canAnimate_(opt_contextNode) {\n    // Window level: animations allowed only when global window is visible.\n    if (isDocumentHidden(this.win.document)) {\n      return false;\n    }\n\n    // Single doc: animations allowed when single doc is visible.\n    if (this.ampdocService_.isSingleDoc()) {\n      return this.ampdocService_.getSingleDoc().isVisible();\n    }\n\n    // Multi-doc: animations depend on the state of the relevant doc.\n    if (opt_contextNode) {\n      const ampdoc = this.ampdocService_.getAmpDocIfAvailable(opt_contextNode);\n      return !ampdoc || ampdoc.isVisible();\n    }\n\n    return true;\n  }\n\n  /**\n   * Runs the animation vsync task. This operation can only run when animations\n   * are allowed. Otherwise, this method returns `false` and exits.\n   * @param {!Node} contextNode\n   * @param {!VsyncTaskSpecDef} task\n   * @param {!VsyncStateDef=} opt_state\n   * @return {boolean}\n   */\n  runAnim(contextNode, task, opt_state) {\n    // Do not request animation frames when the document is not visible.\n    if (!this.canAnimate_(contextNode)) {\n      dev().warn(\n        'VSYNC',\n        'Did not schedule a vsync request, because document was invisible'\n      );\n      return false;\n    }\n    this.run(task, opt_state);\n    return true;\n  }\n\n  /**\n   * Creates an animation vsync task. This operation can only run when\n   * animations are allowed. Otherwise, this closure returns `false` and exits.\n   * @param {!Node} contextNode\n   * @param {!VsyncTaskSpecDef} task\n   * @return {function(!VsyncStateDef=):boolean}\n   */\n  createAnimTask(contextNode, task) {\n    return /** @type {function(!VsyncStateDef=):boolean} */ (\n      (opt_state) => {\n        return this.runAnim(contextNode, task, opt_state);\n      }\n    );\n  }\n\n  /**\n   * Runs the series of mutates until the mutator returns a false value.\n   * @param {!Node} contextNode\n   * @param {function(time, time, !VsyncStateDef):boolean} mutator The\n   *   mutator callback. Only expected to do DOM writes, not reads. If the\n   *   returned value is true, the vsync task will be repeated, otherwise it\n   *   will be completed. The arguments are: timeSinceStart:time,\n   *   timeSincePrev:time and state:VsyncStateDef.\n   * @param {number=} opt_timeout Optional timeout that will force the series\n   *   to complete and reject the promise.\n   * @return {!Promise} Returns the promise that will either resolve on when\n   *   the vsync series are completed or reject in case of failure, such as\n   *   timeout.\n   */\n  runAnimMutateSeries(contextNode, mutator, opt_timeout) {\n    if (!this.canAnimate_(contextNode)) {\n      return Promise.reject(cancellation());\n    }\n    return new Promise((resolve, reject) => {\n      const startTime = Date.now();\n      let prevTime = 0;\n      const task = this.createAnimTask(contextNode, {\n        mutate: (state) => {\n          const timeSinceStart = Date.now() - startTime;\n          const res = mutator(timeSinceStart, timeSinceStart - prevTime, state);\n          if (!res) {\n            resolve();\n          } else if (opt_timeout && timeSinceStart > opt_timeout) {\n            reject(new Error('timeout'));\n          } else {\n            prevTime = timeSinceStart;\n            task(state);\n          }\n        },\n      });\n      task({});\n    });\n  }\n\n  /** @private */\n  schedule_() {\n    if (this.scheduled_) {\n      return;\n    }\n    // Schedule actual animation frame and then run tasks.\n    this.scheduled_ = true;\n    this.forceSchedule_();\n  }\n\n  /** @private */\n  forceSchedule_() {\n    if (this.canAnimate_()) {\n      this.raf_(this.boundRunScheduledTasks_);\n      this.backupPass_.schedule();\n    } else {\n      this.invisiblePass_.schedule();\n    }\n  }\n\n  /**\n   * Runs all scheduled tasks. This is typically called in an RAF\n   * callback. Tests may call this method to force execution of\n   * tasks without waiting.\n   * @private\n   */\n  runScheduledTasks_() {\n    this.backupPass_.cancel();\n    this.scheduled_ = false;\n\n    const {nextFrameResolver_: resolver, states_: states, tasks_: tasks} = this;\n    this.nextFrameResolver_ = null;\n    this.nextFramePromise_ = null;\n    // Double buffering\n    this.tasks_ = this.nextTasks_;\n    this.states_ = this.nextStates_;\n    for (let i = 0; i < tasks.length; i++) {\n      if (tasks[i].measure) {\n        if (!callTask_(tasks[i].measure, states[i])) {\n          // Ensure that the mutate is not executed when measure fails.\n          tasks[i].mutate = undefined;\n        }\n      }\n    }\n    for (let i = 0; i < tasks.length; i++) {\n      if (tasks[i].mutate) {\n        callTask_(tasks[i].mutate, states[i]);\n      }\n    }\n    // Swap last arrays into double buffer.\n    this.nextTasks_ = tasks;\n    this.nextStates_ = states;\n    this.nextTasks_.length = 0;\n    this.nextStates_.length = 0;\n    if (resolver) {\n      resolver();\n    }\n  }\n\n  /**\n   * @return {function(function())} requestAnimationFrame or polyfill.\n   */\n  getRaf_() {\n    const raf =\n      this.win.requestAnimationFrame || this.win.webkitRequestAnimationFrame;\n    if (raf) {\n      return raf.bind(this.win);\n    }\n    let lastTime = 0;\n    return (fn) => {\n      const now = Date.now();\n      // By default we take 16ms between frames, but if the last frame is say\n      // 10ms ago, we only want to wait 6ms.\n      const timeToCall = Math.max(0, FRAME_TIME - (now - lastTime));\n      lastTime = now + timeToCall;\n      this.win.setTimeout(fn, timeToCall);\n    };\n  }\n}\n\n/**\n * For optimization reasons to stop try/catch from blocking optimization.\n * @param {function(!VsyncStateDef):undefined|undefined} callback\n * @param {!VsyncStateDef} state\n * @return {boolean}\n */\nfunction callTask_(callback, state) {\n  devAssert(callback);\n  try {\n    const ret = callback(state);\n    if (ret !== undefined) {\n      dev().error(\n        'VSYNC',\n        'callback returned a value but vsync cannot propogate it: %s',\n        callback.toString()\n      );\n    }\n  } catch (e) {\n    rethrowAsync(e);\n    return false;\n  }\n  return true;\n}\n\n/**\n * @param {!Window} window\n * @return {!Vsync}\n */\nexport function vsyncForTesting(window) {\n  installVsyncService(window);\n  return getService(window, 'vsync');\n}\n\n/**\n * @param {!Window} window\n */\nexport function installVsyncService(window) {\n  installTimerService(window);\n  registerServiceBuilder(window, 'vsync', Vsync);\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  adoptServiceFactoryForEmbedDoc,\n  adoptServiceForEmbedDoc,\n} from '../service';\nimport {devAssert} from '../log';\nimport {installActionServiceForDoc} from './action-impl';\nimport {installBatchedXhrService} from './batched-xhr-impl';\nimport {installCidService} from './cid-impl';\nimport {installCryptoService} from './crypto-impl';\nimport {installDocumentInfoServiceForDoc} from './document-info-impl';\nimport {installGlobalNavigationHandlerForDoc} from './navigation';\nimport {installGlobalSubmitListenerForDoc} from '../document-submit';\nimport {installHiddenObserverForDoc} from './hidden-observer-impl';\nimport {installHistoryServiceForDoc} from './history-impl';\nimport {installImg} from '../../builtins/amp-img/amp-img';\nimport {installInaboxResourcesServiceForDoc} from '../inabox/inabox-resources';\nimport {installInputService} from '../input';\nimport {installLayout} from '../../builtins/amp-layout/amp-layout';\nimport {installLoadingIndicatorForDoc} from './loading-indicator';\nimport {installMutatorServiceForDoc} from './mutator-impl';\nimport {installOwnersServiceForDoc} from './owners-impl';\nimport {installPixel} from '../../builtins/amp-pixel/amp-pixel';\nimport {installPlatformService} from './platform-impl';\nimport {installPreconnectService} from '../preconnect';\nimport {installResourcesServiceForDoc} from './resources-impl';\nimport {installStandardActionsForDoc} from './standard-actions-impl';\nimport {installStorageServiceForDoc} from './storage-impl';\nimport {installTemplatesServiceForDoc} from './template-impl';\nimport {installTimerService} from './timer-impl';\nimport {installUrlForDoc} from './url-impl';\nimport {installUrlReplacementsServiceForDoc} from './url-replacements-impl';\nimport {installViewerServiceForDoc} from './viewer-impl';\nimport {installViewportServiceForDoc} from './viewport/viewport-impl';\nimport {installVsyncService} from './vsync-impl';\nimport {installXhrService} from './xhr-impl';\n\n/**\n * Install builtins.\n * @param {!Window} win\n * @restricted\n */\nexport function installBuiltinElements(win) {\n  installImg(win);\n  installPixel(win);\n  installLayout(win);\n}\n\n/**\n * Install runtime-level services.\n * @param {!Window} global Global scope to adopt.\n * @restricted\n */\nexport function installRuntimeServices(global) {\n  installCryptoService(global);\n  installBatchedXhrService(global);\n  installPlatformService(global);\n  installTimerService(global);\n  installVsyncService(global);\n  installXhrService(global);\n  installInputService(global);\n  installPreconnectService(global);\n}\n\n/**\n * Install ampdoc-level services.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @restricted\n */\nexport function installAmpdocServices(ampdoc) {\n  devAssert(!ampdoc.getParent());\n  installAmpdocServicesInternal(ampdoc, /* isEmbedded */ false);\n}\n\n/**\n * Install ampdoc-level services for an embedded doc.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @restricted\n */\nexport function installAmpdocServicesForEmbed(ampdoc) {\n  devAssert(!!ampdoc.getParent());\n  installAmpdocServicesInternal(ampdoc, /* isEmbedded */ true);\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {boolean} isEmbedded\n */\nfunction installAmpdocServicesInternal(ampdoc, isEmbedded) {\n  // This function is constructed to DCE embedded-vs-non-embedded path when\n  // a constant value passed in the `isEmbedded` arg.\n\n  // When making changes to this method:\n  // 1. Order is important!\n  // 2. Consider to install same services to amp-inabox.js\n  installUrlForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceFactoryForEmbedDoc(ampdoc, 'templates')\n    : installTemplatesServiceForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'documentInfo')\n    : installDocumentInfoServiceForDoc(ampdoc);\n  // those services are installed in amp-inabox.js\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'cid')\n    : installCidService(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'viewer')\n    : installViewerServiceForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'viewport')\n    : installViewportServiceForDoc(ampdoc);\n  installHiddenObserverForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'history')\n    : installHistoryServiceForDoc(ampdoc);\n\n  isEmbedded\n    ? installInaboxResourcesServiceForDoc(ampdoc)\n    : installResourcesServiceForDoc(ampdoc);\n  installOwnersServiceForDoc(ampdoc);\n  installMutatorServiceForDoc(ampdoc);\n\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'url-replace')\n    : installUrlReplacementsServiceForDoc(ampdoc);\n  installActionServiceForDoc(ampdoc);\n  installStandardActionsForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'storage')\n    : installStorageServiceForDoc(ampdoc);\n  installGlobalNavigationHandlerForDoc(ampdoc);\n  installGlobalSubmitListenerForDoc(ampdoc);\n  if (!isEmbedded) {\n    // Embeds do not show loading indicators, since the whole embed is\n    // usually behind a parent loading indicator.\n    installLoadingIndicatorForDoc(ampdoc);\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../core/data-structures/promise';\nimport {Services} from '../services';\nimport {\n  copyElementToChildWindow,\n  stubElementIfNotKnown,\n  upgradeOrRegisterElement,\n} from './custom-element-registry';\nimport {createExtensionScript, getExtensionScripts} from './extension-script';\nimport {dev, devAssert, user} from '../log';\nimport {getMode} from '../mode';\nimport {installStylesForDoc} from '../style-installer';\nimport {map} from '../core/types/object';\nimport {registerExtendedTemplateForDoc} from './template-impl';\nimport {registerServiceBuilder, registerServiceBuilderForDoc} from '../service';\nimport {rethrowAsync} from '../core/error';\n\nexport const LEGACY_ELEMENTS = ['amp-ad', 'amp-embed', 'amp-video'];\nconst TAG = 'extensions';\nconst DEFAULT_VERSION = '0.1';\nconst LATEST_VERSION = 'latest';\nconst UNKNOWN_EXTENSION = '_UNKNOWN_';\nconst LOADER_PROP = '__AMP_EXT_LDR';\nconst SCRIPT_LOADED_PROP = '__AMP_SCR_LOADED';\n\n/**\n * Contains data for the declaration of a custom element.\n *\n * @typedef {{\n *   implementationClass:\n *       typeof ../base-element.BaseElement,\n *   css: (?string|undefined),\n * }}\n */\nlet ExtensionElementDef;\n\n/**\n * Contains data for the declaration of an extension service.\n *\n * @typedef {{serviceName: string, serviceClass: function(new:Object, !./ampdoc-impl.AmpDoc)}}\n */\nlet ExtensionServiceDef;\n\n/**\n * The structure that contains the resources declared by an extension.\n *\n * @typedef {{\n *   elements: !Object<string, !ExtensionElementDef>,\n *   services: !Object<string, !ExtensionServiceDef>,\n * }}\n */\nlet ExtensionDef;\n\n/**\n * Internal structure that maintains the state of an extension through loading.\n *\n * @typedef {{\n *   version: string,\n *   latest: boolean,\n *   extension: !ExtensionDef,\n *   auto: boolean,\n *   docFactories: !Array<function(!./ampdoc-impl.AmpDoc)>,\n *   promise: (!Promise<!ExtensionDef>|undefined),\n *   resolve: (function(!ExtensionDef)|undefined),\n *   reject: (function(!Error)|undefined),\n *   loaded: (boolean|undefined),\n *   error: (!Error|undefined),\n *   scriptPresent: (boolean|undefined),\n * }}\n * @private\n */\nlet ExtensionHolderDef;\n\n/**\n * Install extensions service.\n * @param {!Window} window\n * @restricted\n */\nexport function installExtensionsService(window) {\n  registerServiceBuilder(window, 'extensions', Extensions);\n}\n\n/**\n * The services that manages extensions in the runtime.\n * @visibleForTesting\n */\nexport class Extensions {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @const @private */\n    this.ampdocService_ = Services.ampdocServiceFor(win);\n\n    /** @private @const {!Object<string, !ExtensionHolderDef>} */\n    this.extensions_ = {};\n\n    /** @private {?string} */\n    this.currentExtensionId_ = null;\n\n    /** @private {?string} */\n    this.currentExtensionVersion_ = null;\n\n    /** @private {?boolean} */\n    this.currentExtensionLatest_ = null;\n  }\n\n  /**\n   * Register and process the specified extension. The factory is called\n   * immediately, which in turn is expected to register elements, templates,\n   * services and document factories. This method is called by the extension's\n   * script itself when it's loaded using the regular `AMP.push()` callback.\n   * @param {string} extensionId\n   * @param {string} version\n   * @param {boolean} latest\n   * @param {function(!Object, !Object)} factory\n   * @param {!Object} arg\n   * @restricted\n   */\n  registerExtension(extensionId, version, latest, factory, arg) {\n    const latestHolder = latest\n      ? this.extensions_[extensionKey(extensionId, LATEST_VERSION)]\n      : null;\n    const holder = this.getExtensionHolder_(\n      extensionId,\n      version,\n      // Inherit the `auto` (auto-install) flag from the \"latest\" version\n      // when available. If the \"latest\" has been added as a non-auto-install\n      // then this registration should not auto-install either. If the numeric\n      // version was independently added to the document, then it's auto-install\n      // will be preserved.\n      latestHolder?.auto ?? true\n    );\n    holder.latest = latest;\n\n    if (holder.loaded) {\n      // This extension has already been registered. This could be a\n      // a \"latest\" script requested for a previously loaded numeric\n      // version or vice versa.\n      return;\n    }\n\n    // Replace the \"latest\": both numerical and \"latest\" will be pointing to\n    // the same record.\n    if (latest) {\n      this.extensions_[extensionKey(extensionId, LATEST_VERSION)] = holder;\n    }\n\n    try {\n      this.currentExtensionId_ = extensionId;\n      this.currentExtensionVersion_ = version;\n      this.currentExtensionLatest_ = latest;\n      factory(arg, arg['_']);\n      if (getMode(this.win).localDev || getMode(this.win).test) {\n        if (Object.freeze) {\n          const m = holder.extension;\n          m.elements = Object.freeze(m.elements);\n          holder.extension = Object.freeze(m);\n        }\n      }\n      holder.loaded = true;\n      holder.resolve?.(holder.extension);\n      latestHolder?.resolve?.(holder.extension);\n    } catch (e) {\n      holder.error = e;\n      holder.reject?.(e);\n      latestHolder?.reject?.(e);\n      throw e;\n    } finally {\n      this.currentExtensionId_ = null;\n      this.currentExtensionVersion_ = null;\n      this.currentExtensionLatest_ = null;\n    }\n  }\n\n  /**\n   * Waits for the previously included extension to complete\n   * loading/registration.\n   * @param {string} extensionId\n   * @param {string} version\n   * @return {!Promise<?ExtensionDef>}\n   */\n  waitForExtension(extensionId, version) {\n    const wait = this.waitFor_(this.getExtensionHolder_(extensionId, version));\n\n    return Services.timerFor(this.win)\n      .timeoutPromise(16000, wait)\n      .catch((err) => {\n        if (!err.message.includes('timeout')) {\n          throw err;\n        }\n\n        user().error(TAG, `Waited over 16s to load extension ${extensionId}.`);\n        return wait;\n      });\n  }\n\n  /**\n   * Returns the promise that will be resolved when the extension has been\n   * loaded. If necessary, adds the extension script to the page.\n   * @param {string} extensionId\n   * @param {string=} version\n   * @return {!Promise<!ExtensionDef>}\n   */\n  preloadExtension(extensionId, version = DEFAULT_VERSION) {\n    if (extensionId == 'amp-embed') {\n      extensionId = 'amp-ad';\n    }\n    const holder = this.getExtensionHolder_(extensionId, version);\n    this.insertExtensionScriptIfNeeded_(extensionId, version, holder);\n    return this.waitFor_(holder);\n  }\n\n  /**\n   * Returns the promise that will be resolved when the extension has been\n   * loaded. If necessary, adds the extension script to the page.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} extensionId\n   * @param {string=} version\n   * @return {!Promise<!ExtensionDef>}\n   */\n  installExtensionForDoc(ampdoc, extensionId, version = DEFAULT_VERSION) {\n    const rootNode = ampdoc.getRootNode();\n    let extLoaders = rootNode[LOADER_PROP];\n    if (!extLoaders) {\n      extLoaders = rootNode[LOADER_PROP] = map();\n    }\n    if (extLoaders[extensionId]) {\n      return extLoaders[extensionId];\n    }\n    ampdoc.declareExtension(extensionId, version);\n    stubElementIfNotKnown(ampdoc.win, extensionId);\n    return (extLoaders[extensionId] = this.preloadExtension(\n      extensionId,\n      version\n    ).then(() => this.installExtensionInDoc(ampdoc, extensionId, version)));\n  }\n\n  /**\n   * Reloads the new version of the extension.\n   * @param {string} extensionId\n   * @param {string} version\n   * @param {boolean} latest\n   * @return {!Promise<!ExtensionDef>}\n   */\n  reloadExtension(extensionId, version, latest) {\n    // Ignore inserted script elements to prevent recursion.\n    const els = getExtensionScripts(\n      this.win,\n      extensionId,\n      version,\n      latest,\n      /* includeInserted */ false\n    );\n    // The previously awaited extension loader must not have finished or\n    // failed.\n    const holder = this.extensions_[extensionKey(extensionId, version)];\n    if (holder) {\n      devAssert(!holder.loaded && !holder.error);\n      holder.scriptPresent = false;\n    }\n    els.forEach((el) =>\n      el.setAttribute('i-amphtml-loaded-new-version', extensionId)\n    );\n    return this.preloadExtension(extensionId, version);\n  }\n\n  /**\n   * @param {!Window} win\n   * @param {string} extensionId\n   * @param {string=} version\n   * @param {boolean=} latest\n   * @return {!Promise}\n   */\n  importUnwrapped(win, extensionId, version = DEFAULT_VERSION, latest = true) {\n    const scriptsInHead = getExtensionScripts(\n      win,\n      extensionId,\n      version,\n      latest\n    );\n    let scriptElement = scriptsInHead.length > 0 ? scriptsInHead[0] : null;\n    let promise;\n    if (scriptElement) {\n      promise = scriptElement[SCRIPT_LOADED_PROP];\n    } else {\n      scriptElement = createExtensionScript(this.win, extensionId, version);\n      promise = scriptElement[SCRIPT_LOADED_PROP] = new Promise(\n        (resolve, reject) => {\n          scriptElement.onload = resolve;\n          scriptElement.onerror = reject;\n        }\n      );\n      win.document.head.appendChild(scriptElement);\n    }\n    return promise;\n  }\n\n  /**\n   * Returns the promise that will be resolved with the extension element's\n   * class when the extension has been loaded. If necessary, adds the extension\n   * script to the page.\n   * @param {string} elementName\n   * @param {string} version\n   * @return {!Promise<typeof ../base-element.BaseElement>}\n   */\n  loadElementClass(elementName, version = DEFAULT_VERSION) {\n    return this.preloadExtension(elementName, version).then((extension) => {\n      const element = devAssert(\n        extension.elements[elementName],\n        'Element not found: %s',\n        elementName\n      );\n      return element.implementationClass;\n    });\n  }\n\n  /**\n   * Add an element to the extension currently being registered. This is a\n   * restricted method and it's allowed to be called only during the overall\n   * extension registration.\n   * @param {string} name\n   * @param {typeof ../base-element.BaseElement} implementationClass\n   * @param {?string|undefined} css\n   * @restricted\n   */\n  addElement(name, implementationClass, css) {\n    const holder = this.getCurrentExtensionHolder_(name);\n    holder.extension.elements[name] = {implementationClass, css};\n    this.addDocFactory((ampdoc) => {\n      this.installElement_(ampdoc, name, implementationClass, css);\n    });\n  }\n\n  /**\n   * Add a template type to the extension currently being registered. This is a\n   * restricted method and it's allowed to be called only during the overall\n   * extension registration.\n   * @param {string} name\n   * @param {typeof ../base-template.BaseTemplate} implementationClass\n   * @restricted\n   */\n  addTemplate(name, implementationClass) {\n    this.addDocFactory((ampdoc) => {\n      registerExtendedTemplateForDoc(ampdoc, name, implementationClass);\n    });\n  }\n\n  /**\n   * Installs the specified element implementation in the ampdoc.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} name\n   * @param {typeof ../base-element.BaseElement} implementationClass\n   * @param {?string|undefined} css\n   * @private\n   */\n  installElement_(ampdoc, name, implementationClass, css) {\n    if (css) {\n      installStylesForDoc(\n        ampdoc,\n        css,\n        () => {\n          this.registerElementInWindow_(ampdoc.win, name, implementationClass);\n        },\n        /* isRuntimeCss */ false,\n        name\n      );\n    } else {\n      this.registerElementInWindow_(ampdoc.win, name, implementationClass);\n    }\n  }\n\n  /**\n   * @param {!Window} win\n   * @param {string} name\n   * @param {typeof ../base-element.BaseElement} implementationClass\n   * @private\n   */\n  registerElementInWindow_(win, name, implementationClass) {\n    // Register the element in the window.\n    upgradeOrRegisterElement(win, name, implementationClass);\n    // Register this extension to resolve its Service Promise.\n    registerServiceBuilder(win, name, emptyService);\n  }\n\n  /**\n   * Add a service to the extension currently being registered. This is a\n   * restricted method and it's allowed to be called only during the overall\n   * extension registration.\n   * @param {string} name\n   * @param {function(new:Object, !./ampdoc-impl.AmpDoc)} implementationClass\n   */\n  addService(name, implementationClass) {\n    const holder = this.getCurrentExtensionHolder_(name);\n    holder.extension.services.push(\n      /** @type {!ExtensionServiceDef} */ ({\n        serviceName: name,\n        serviceClass: implementationClass,\n      })\n    );\n    this.addDocFactory((ampdoc) => {\n      registerServiceBuilderForDoc(\n        ampdoc,\n        name,\n        implementationClass,\n        /* instantiate */ true\n      );\n    });\n  }\n\n  /**\n   * Add a ampdoc factory to the extension currently being registered. This is a\n   * restricted method and it's allowed to be called only during the overall\n   * extension registration.\n   * @param {function(!./ampdoc-impl.AmpDoc)} factory\n   * @param {string=} opt_forName\n   * @restricted\n   */\n  addDocFactory(factory, opt_forName) {\n    const holder = this.getCurrentExtensionHolder_(opt_forName);\n    holder.docFactories.push(factory);\n\n    // If a single-doc mode, run factory right away if it's included by the doc.\n    if (this.currentExtensionId_ && this.ampdocService_.isSingleDoc()) {\n      const ampdoc = this.ampdocService_.getAmpDoc(this.win.document);\n      const extensionId = dev().assertString(this.currentExtensionId_);\n      const version = dev().assertString(this.currentExtensionVersion_);\n      const latest = this.currentExtensionLatest_ || false;\n      // Note that this won't trigger for FIE extensions that are not present\n      // in the parent doc.\n      if (\n        ampdoc.declaresExtension(extensionId, version) ||\n        (latest && ampdoc.declaresExtension(extensionId, LATEST_VERSION)) ||\n        holder.auto\n      ) {\n        factory(ampdoc);\n      }\n    }\n  }\n\n  /**\n   * Preinstalls built-ins and legacy elements in the emebedded ampdoc.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Array<{extensionId: string, extensionVersion: string}>} extensions\n   * @restricted\n   */\n  preinstallEmbed(ampdoc, extensions) {\n    const topWin = this.win;\n    const childWin = ampdoc.win;\n\n    // Install built-ins and legacy elements.\n    copyBuiltinElementsToChildWindow(topWin, childWin);\n    stubLegacyElements(childWin);\n\n    // Stub extensions.\n    extensions.forEach(({extensionId, extensionVersion}) => {\n      // Declare the extension version on ampdoc so it doesn't request the\n      // extension again.\n      ampdoc.declareExtension(extensionId, extensionVersion);\n\n      // This will extend automatic upgrade of custom elements from top\n      // window to the child window.\n      if (!LEGACY_ELEMENTS.includes(extensionId)) {\n        stubElementIfNotKnown(childWin, extensionId);\n      }\n    });\n  }\n\n  /**\n   * Installs all ampdoc factories previously registered with\n   * `addDocFactory`.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Array<{extensionId: string, extensionVersion: string}>} extensions\n   * @return {!Promise}\n   * @restricted\n   */\n  installExtensionsInDoc(ampdoc, extensions) {\n    return Promise.all(\n      extensions.map(({extensionId, extensionVersion}) =>\n        this.installExtensionInDoc(ampdoc, extensionId, extensionVersion)\n      )\n    );\n  }\n\n  /**\n   * Installs all ampdoc factories for the specified extension.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} extensionId\n   * @param {string=} version\n   * @return {!Promise}\n   */\n  installExtensionInDoc(ampdoc, extensionId, version = DEFAULT_VERSION) {\n    ampdoc.declareExtension(extensionId, version);\n    return this.waitFor_(this.getExtensionHolder_(extensionId, version)).then(\n      () => {\n        const holder = this.getExtensionHolder_(extensionId, version);\n        holder.docFactories.forEach((factory) => {\n          try {\n            factory(ampdoc);\n          } catch (e) {\n            rethrowAsync('Doc factory failed: ', e, extensionId);\n          }\n        });\n      }\n    );\n  }\n\n  /**\n   * Creates or returns an existing extension holder.\n   * @param {string} extensionId\n   * @param {string} version\n   * @param {boolean=} opt_auto\n   * @return {!ExtensionHolderDef}\n   * @private\n   */\n  getExtensionHolder_(extensionId, version, opt_auto) {\n    const key = extensionKey(extensionId, version);\n    let holder = this.extensions_[key];\n    if (!holder) {\n      const extension = /** @type {ExtensionDef} */ ({\n        elements: {},\n        services: [],\n      });\n      holder = /** @type {ExtensionHolderDef} */ ({\n        version,\n        // Usually a version starts \"unknown\" and the latest becomes known\n        // when it has been loaded.\n        latest: version == LATEST_VERSION,\n        extension,\n        auto: opt_auto || false,\n        docFactories: [],\n        promise: undefined,\n        resolve: undefined,\n        reject: undefined,\n        loaded: undefined,\n        error: undefined,\n        scriptPresent: undefined,\n      });\n      this.extensions_[key] = holder;\n    }\n    return holder;\n  }\n\n  /**\n   * Returns the holder for the extension currently being registered.\n   * @param {string=} opt_forName Used for logging only.\n   * @return {!ExtensionHolderDef}\n   * @private\n   */\n  getCurrentExtensionHolder_(opt_forName) {\n    if (!this.currentExtensionId_ && !getMode(this.win).test) {\n      dev().error(TAG, 'unknown extension for ', opt_forName);\n    }\n    return this.getExtensionHolder_(\n      this.currentExtensionId_ || UNKNOWN_EXTENSION,\n      this.currentExtensionVersion_ || ''\n    );\n  }\n\n  /**\n   * Creates or returns an existing promise that will yield as soon as the\n   * extension has been loaded.\n   * @param {!ExtensionHolderDef} holder\n   * @return {!Promise<!ExtensionDef>}\n   * @private\n   */\n  waitFor_(holder) {\n    if (!holder.promise) {\n      if (holder.loaded) {\n        holder.promise = Promise.resolve(holder.extension);\n      } else if (holder.error) {\n        holder.promise = Promise.reject(holder.error);\n      } else {\n        const deferred = new Deferred();\n        holder.promise = deferred.promise;\n        holder.resolve = deferred.resolve;\n        holder.reject = deferred.reject;\n      }\n    }\n    return holder.promise;\n  }\n\n  /**\n   * Ensures that the script has already been injected in the page.\n   * @param {string} extensionId\n   * @param {string} version\n   * @param {!ExtensionHolderDef} holder\n   * @private\n   */\n  insertExtensionScriptIfNeeded_(extensionId, version, holder) {\n    if (this.isExtensionScriptRequired_(extensionId, version, holder)) {\n      const scriptElement = createExtensionScript(\n        this.win,\n        extensionId,\n        version\n      );\n      this.win.document.head.appendChild(scriptElement);\n      holder.scriptPresent = true;\n    }\n  }\n\n  /**\n   * Determine the need to add amp extension script to document.\n   * @param {string} extensionId\n   * @param {string} version\n   * @param {!ExtensionHolderDef} holder\n   * @return {boolean}\n   * @private\n   */\n  isExtensionScriptRequired_(extensionId, version, holder) {\n    if (holder.loaded || holder.error) {\n      return false;\n    }\n    if (holder.scriptPresent === undefined) {\n      const scriptsInHead = getExtensionScripts(\n        this.win,\n        extensionId,\n        version,\n        holder.latest\n      );\n      holder.scriptPresent = scriptsInHead.length > 0;\n    }\n    return !holder.scriptPresent;\n  }\n}\n\n/**\n * @param {!Window} win\n */\nexport function stubLegacyElements(win) {\n  LEGACY_ELEMENTS.forEach((name) => {\n    stubElementIfNotKnown(win, name);\n  });\n}\n\n/**\n * Copy builtins to a child window.\n * @param {!Window} parentWin\n * @param {!Window} childWin\n */\nfunction copyBuiltinElementsToChildWindow(parentWin, childWin) {\n  copyElementToChildWindow(parentWin, childWin, 'amp-img');\n  copyElementToChildWindow(parentWin, childWin, 'amp-pixel');\n}\n\n/**\n * @return {!Object}\n */\nfunction emptyService() {\n  // All services need to resolve to an object.\n  return {};\n}\n\n/**\n * @param {string} extensionId\n * @param {string} version\n * @return {string}\n */\nfunction extensionKey(extensionId, version) {\n  return `${extensionId}:${version}`;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from './base-element';\nimport {\n  LogLevel, // eslint-disable-line no-unused-vars\n  dev,\n  initLogConstructor,\n  overrideLogLevel,\n  setReportError,\n} from './log';\nimport {MultidocManager} from './multidoc-manager';\nimport {Services} from './services';\nimport {cssText as ampDocCss} from '../build/ampdoc.css';\nimport {cssText as ampSharedCss} from '../build/ampshared.css';\nimport {config} from './config';\nimport {getMode} from './mode';\nimport {hasRenderDelayingServices} from './render-delaying-services';\nimport {\n  installAmpdocServices,\n  installRuntimeServices,\n} from './service/core-services';\nimport {\n  installExtensionsService,\n  stubLegacyElements,\n} from './service/extensions-impl';\nimport {internalRuntimeVersion} from './internal-version';\nimport {isExperimentOn, toggleExperiment} from './experiments';\nimport {reportErrorForWin} from './error-reporting';\nimport {setStyle} from './style';\nimport {shouldLoadPolyfill as shouldLoadInObPolyfill} from './polyfills/stubs/intersection-observer-stub';\nimport {shouldLoadPolyfill as shouldLoadResObPolyfill} from './polyfills/stubs/resize-observer-stub';\nimport {startupChunk} from './chunk';\nimport {stubElementsForDoc} from './service/custom-element-registry';\nimport {waitForBodyOpenPromise} from './dom';\n\ninitLogConstructor();\nsetReportError(reportErrorForWin.bind(null, self));\n\n/** @const @private {string} */\nconst TAG = 'runtime';\n\n/**\n * @typedef {{\n *  url: (string|undefined),\n *  title: (string|undefined),\n *  canonicalUrl: (string|undefined),\n *  head: (Element|undefined),\n *  ampdoc: (!./service/ampdoc-impl.AmpDoc | undefined),\n *  setVisibilityState: (function(!VisibilityState)|undefined),\n *  postMessage: (function()|undefined),\n *  onMessage: (function()|undefined),\n *  close: (function()|undefined),\n *  getState: (function()|undefined),\n *  setState: (function()|undefined),\n *  toggleRuntime: (function()|undefined),\n *  resources: (!./service/resources-interface.ResourcesInterface | undefined)\n * }}\n */\nexport let ShadowDoc;\n\n/**\n * Applies the runtime to a given global scope for a single-doc mode. Multi\n * frame support is currently incomplete.\n * @param {!Window} global Global scope to adopt.\n * @param {function(!Window, !./service/extensions-impl.Extensions):!Promise} callback\n * @return {!Promise}\n */\nfunction adoptShared(global, callback) {\n  // Tests can adopt the same window twice. sigh.\n  if (global.__AMP_TAG) {\n    return Promise.resolve();\n  }\n  global.__AMP_TAG = true;\n  // If there is already a global AMP object we assume it is an array\n  // of functions\n  /** @const {!Array<function(!Object)|!ExtensionPayload>} */\n  const preregisteredExtensions = global.AMP || [];\n\n  installExtensionsService(global);\n  /** @const {!./service/extensions-impl.Extensions} */\n  const extensions = Services.extensionsFor(global);\n  installRuntimeServices(global);\n  stubLegacyElements(global);\n\n  global.AMP = {\n    win: global,\n    // Might not be available in tests.\n    '_': global.AMP ? global.AMP['_'] : undefined,\n  };\n\n  // `AMP.extension()` function is only installed in a non-minified mode.\n  // This function is meant to play the same role for development and testing\n  // as `AMP.push()` in production.\n  if (!getMode().minified) {\n    /**\n     * @param {string} unusedName\n     * @param {string} unusedVersion\n     * @param {function(!Object)} installer\n     * @const\n     */\n    global.AMP.extension = function (unusedName, unusedVersion, installer) {\n      installer(global.AMP);\n    };\n  }\n\n  /** @const */\n  global.AMP.config = config;\n\n  global.AMP.BaseElement = BaseElement;\n\n  /**\n   * Registers an extended element and installs its styles.\n   * @param {string} name\n   * @param {typeof BaseElement} implementationClass\n   * @param {?string|undefined} css\n   */\n  global.AMP.registerElement = extensions.addElement.bind(extensions);\n\n  /**\n   * Registers an extended template.\n   * @param {string} name\n   * @param {typeof ./base-template.BaseTemplate} implementationClass\n   */\n  global.AMP.registerTemplate = extensions.addTemplate.bind(extensions);\n\n  /**\n   * Registers an ampdoc service.\n   * @param {string} name\n   * @param {function(new:Object, !./service/ampdoc-impl.AmpDoc)} implementationClass\n   */\n  global.AMP.registerServiceForDoc = extensions.addService.bind(extensions);\n\n  // Experiments.\n  /**\n   * @param {string} experimentId\n   * @return {boolean}\n   */\n  global.AMP.isExperimentOn = isExperimentOn.bind(null, global);\n\n  /**\n   * @param {string} experimentId\n   * @param {boolean=} opt_on\n   * @return {boolean}\n   */\n  global.AMP.toggleExperiment = toggleExperiment.bind(null, global);\n\n  /**\n   * @param {!LogLevel} level\n   */\n  global.AMP.setLogLevel = overrideLogLevel.bind(null);\n\n  /**\n   * Sets the function to forward tick events to.\n   * @param {function(string,?string=,number=)} unusedFn\n   * @param {function()=} opt_flush\n   * @deprecated\n   */\n  global.AMP.setTickFunction = (unusedFn, opt_flush) => {};\n\n  // Run specific setup for a single-doc or shadow-doc mode.\n  const iniPromise = callback(global, extensions);\n\n  /**\n   * @param {function(!Object,!Object)|!ExtensionPayload} fnOrStruct\n   */\n  function installExtension(fnOrStruct) {\n    const register = () => {\n      iniPromise.then(() => {\n        if (typeof fnOrStruct == 'function') {\n          fnOrStruct(global.AMP, global.AMP._);\n        } else {\n          extensions.registerExtension(\n            fnOrStruct.n,\n            fnOrStruct.ev,\n            fnOrStruct.l,\n            fnOrStruct.f,\n            global.AMP\n          );\n        }\n      });\n    };\n\n    startRegisterOrChunk(global, fnOrStruct, register);\n  }\n\n  // Handle high priority extensions now, and if necessary issue\n  // requests for new extensions (used for experimental version\n  // locking).\n  for (let i = 0; i < preregisteredExtensions.length; i++) {\n    const fnOrStruct = preregisteredExtensions[i];\n    if (maybeLoadCorrectVersion(global, fnOrStruct)) {\n      preregisteredExtensions.splice(i--, 1);\n    } else if (typeof fnOrStruct == 'function' || fnOrStruct.p == 'high') {\n      try {\n        installExtension(fnOrStruct);\n      } catch (e) {\n        // Throw errors outside of loop in its own micro task to\n        // avoid on error stopping other extensions from loading.\n        dev().error(TAG, 'Extension failed: ', e, fnOrStruct.n);\n      }\n      // We handled the entry. Remove from set for future execution.\n      preregisteredExtensions.splice(i--, 1);\n    }\n  }\n\n  maybePumpEarlyFrame(global, () => {\n    /**\n     * Registers a new custom element.\n     * @param {function(!Object, !Object)|!ExtensionPayload} fnOrStruct\n     */\n    global.AMP.push = function (fnOrStruct) {\n      if (maybeLoadCorrectVersion(global, fnOrStruct)) {\n        return;\n      }\n      installExtension(fnOrStruct);\n    };\n    // Execute asynchronously scheduled elements.\n    for (let i = 0; i < preregisteredExtensions.length; i++) {\n      const fnOrStruct = preregisteredExtensions[i];\n      if (maybeLoadCorrectVersion(global, fnOrStruct)) {\n        continue;\n      }\n      try {\n        installExtension(fnOrStruct);\n      } catch (e) {\n        // Throw errors outside of loop in its own micro task to\n        // avoid on error stopping other extensions from loading.\n        dev().error(TAG, 'Extension failed: ', e, fnOrStruct.n);\n      }\n    }\n    // Make sure we empty the array of preregistered extensions.\n    // Technically this is only needed for testing, as everything should\n    // go out of scope here, but just making sure.\n    preregisteredExtensions.length = 0;\n  });\n  // If the closure passed to maybePumpEarlyFrame didn't execute\n  // immediately we need to keep pushing onto preregisteredExtensions\n  if (!global.AMP.push) {\n    global.AMP.push =\n      /** @type {function((ExtensionPayload|function(!Object, !Object): ?))} */ (\n        preregisteredExtensions.push.bind(preregisteredExtensions)\n      );\n  }\n\n  // For iOS we need to set `cursor:pointer` to ensure that click events are\n  // delivered.\n  if (Services.platformFor(global).isIos()) {\n    setStyle(global.document.documentElement, 'cursor', 'pointer');\n  }\n\n  // Some deferred polyfills.\n  const extensionsFor = Services.extensionsFor(global);\n  if (shouldLoadResObPolyfill(global)) {\n    extensionsFor.preloadExtension('amp-resize-observer-polyfill');\n  }\n  if (shouldLoadInObPolyfill(global)) {\n    extensionsFor.preloadExtension('amp-intersection-observer-polyfill');\n  }\n\n  return iniPromise;\n}\n\n/**\n * @param {!Window} global Global scope to adopt.\n * @param {function(!Object, !Object)|!ExtensionPayload} fnOrStruct\n * @param {function()} register\n */\nfunction startRegisterOrChunk(global, fnOrStruct, register) {\n  if (typeof fnOrStruct == 'function' || fnOrStruct.p == 'high') {\n    // \"High priority\" extensions do not go through chunking.\n    // This should be used for extensions that need to run early.\n    // One example would be viewer communication that is required\n    // to transition document from pre-render to visible (which\n    // affects chunking itself).\n    // We consider functions as high priority, because\n    // - if in doubt, that is a better default\n    // - the only actual  user is a viewer integration that should\n    //   be high priority.\n    Promise.resolve().then(register);\n  } else {\n    register.displayName = fnOrStruct.n;\n    startupChunk(global.document, register);\n  }\n}\n\n/**\n * Applies the runtime to a given global scope for a single-doc mode.\n * Multi frame support is currently incomplete.\n * @param {!Window} global Global scope to adopt.\n * @return {!Promise}\n */\nexport function adopt(global) {\n  return adoptShared(global, (global) => {\n    // Shared runtimes variables between both multi-doc and single-doc pages\n    adoptServicesAndResources(global);\n\n    return waitForBodyOpenPromise(global.document).then(() => {\n      // Ensure that all declared extensions are marked and stubbed.\n      stubElementsForDoc(global.AMP.ampdoc);\n    });\n  });\n}\n\n/**\n * Applies the runtime to a given global scope for a single-doc mode.\n * Multi frame support is currently incomplete.\n * @param {!Window} global Global scope to adopt.\n * @return {!Promise}\n */\nexport function adoptWithMultidocDeps(global) {\n  return adoptShared(global, (global) => {\n    // Shared runtimes variables between both multi-doc and single-doc pages\n    adoptServicesAndResources(global);\n\n    // Dependencies to the MultiDocManager\n    adoptMultiDocDeps(global);\n\n    return waitForBodyOpenPromise(global.document).then(() => {\n      // Ensure that all declared extensions are marked and stubbed.\n      stubElementsForDoc(global.AMP.ampdoc);\n    });\n  });\n}\n\n/**\n * Adopt shared runtimes variables between both multi-doc and single-doc pages\n * @param {!Window} global Global scope to adopt.\n */\nfunction adoptServicesAndResources(global) {\n  const {documentElement} = global.document;\n\n  const ampdocService = Services.ampdocServiceFor(global);\n  const ampdoc = ampdocService.getSingleDoc();\n  global.AMP.ampdoc = ampdoc;\n\n  const viewer = Services.viewerForDoc(documentElement);\n  global.AMP.viewer = viewer;\n\n  if (getMode().development) {\n    global.AMP.toggleRuntime = viewer.toggleRuntime.bind(viewer);\n    global.AMP.resources = Services.resourcesForDoc(documentElement);\n  }\n\n  const viewport = Services.viewportForDoc(documentElement);\n  global.AMP.viewport = {};\n  global.AMP.viewport.getScrollLeft = viewport.getScrollLeft.bind(viewport);\n  global.AMP.viewport.getScrollWidth = viewport.getScrollWidth.bind(viewport);\n  global.AMP.viewport.getWidth = viewport.getWidth.bind(viewport);\n}\n\n/**\n * Adopt MultiDocManager dependencies\n * @param {!Window} global Global scope to adopt.\n */\nfunction adoptMultiDocDeps(global) {\n  global.AMP.installAmpdocServices = installAmpdocServices.bind(null);\n  if (IS_ESM) {\n    const style = global.document.querySelector('style[amp-runtime]');\n    global.AMP.combinedCss = style ? style.textContent : '';\n  } else {\n    global.AMP.combinedCss = ampDocCss + ampSharedCss;\n  }\n}\n\n/**\n * Applies the runtime to a given global scope for shadow mode.\n * @param {!Window} global Global scope to adopt.\n * @return {!Promise}\n */\nexport function adoptShadowMode(global) {\n  return adoptShared(global, (global, extensions) => {\n    // shadow mode already adopted\n    if (global.AMP.attachShadowDoc) {\n      return Promise.resolve();\n    }\n\n    // Dependencies to the MultiDocManager\n    adoptMultiDocDeps(global);\n\n    const manager = new MultidocManager(\n      global,\n      Services.ampdocServiceFor(global),\n      extensions,\n      Services.timerFor(global)\n    );\n\n    /**\n     * Registers a shadow root document via a fully fetched document.\n     * @param {!Element} hostElement\n     * @param {!Document} doc\n     * @param {string} url\n     * @param {!Object<string, string>=} opt_initParams\n     * @return {!Object}\n     */\n    global.AMP.attachShadowDoc = manager.attachShadowDoc.bind(manager);\n\n    /**\n     * Registers a shadow root document via a stream.\n     * @param {!Element} hostElement\n     * @param {string} url\n     * @param {!Object<string, string>=} opt_initParams\n     * @return {!Object}\n     */\n    global.AMP.attachShadowDocAsStream =\n      manager.attachShadowDocAsStream.bind(manager);\n\n    return waitForBodyOpenPromise(global.document);\n  });\n}\n\n/**\n * For a given extension, checks that its version is the same\n * as the version of the main AMP binary.\n * If yes, returns false and does nothing else.\n * If they are different, returns false, and initiates a load\n * of the respective extension via a versioned URL.\n *\n * @param {!Window} win\n * @param {function(!Object, !Object)|!ExtensionPayload} fnOrStruct\n * @return {boolean}\n */\nfunction maybeLoadCorrectVersion(win, fnOrStruct) {\n  if (getMode().localDev && isExperimentOn(win, 'disable-version-locking')) {\n    return false;\n  }\n  if (typeof fnOrStruct == 'function') {\n    return false;\n  }\n\n  if (IS_ESM) {\n    // If we're in a module runtime, trying to execute a nomodule extension\n    // simply remove the nomodule extension so that it is not executed.\n    if (!fnOrStruct.m) {\n      return true;\n    }\n  } else {\n    // If we're in a nomodule runtime, trying to execute a module extension\n    // simply remove the module extension so that it is not executed.\n    if (fnOrStruct.m) {\n      return true;\n    }\n  }\n\n  const {v} = fnOrStruct;\n  // This is non-obvious, but we only care about the release version,\n  // not about the full rtv version, because these only differ\n  // in the config that is fully determined by the primary binary.\n  if (internalRuntimeVersion() == v) {\n    return false;\n  }\n  Services.extensionsFor(win).reloadExtension(\n    fnOrStruct.n,\n    fnOrStruct.ev,\n    fnOrStruct.l\n  );\n  return true;\n}\n\n/**\n * If it makes sense, let the browser paint the current frame before\n * executing the callback.\n * @param {!Window} win\n * @param {function()} cb Callback that should run after a frame was\n *     pumped.\n */\nfunction maybePumpEarlyFrame(win, cb) {\n  // There is definitely nothing to draw yet, so we might as well\n  // proceed.\n  if (!win.document.body) {\n    cb();\n    return;\n  }\n  if (hasRenderDelayingServices(win)) {\n    cb();\n    return;\n  }\n  Services.timerFor(win).delay(cb, 1);\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {escapeCssSelectorIdent} from './core/dom/css-selectors';\nimport {onDocumentReady} from './core/document-ready';\nimport {urls} from './config';\n\n/**\n * While browsers put a timeout on font downloads (3s by default,\n * some less on slow connections), there is no such timeout for style\n * sheets. In the case of AMP external stylesheets are ONLY used to\n * download fonts, but browsers have no reasonable timeout for\n * stylesheets. Users may thus wait a long time for these to download\n * even though all they do is reference fonts.\n *\n * For that reasons this function identifies (or rather infers) font\n * stylesheets that have not downloaded within timeout period of the page\n * response starting and reinserts equivalent link tags  dynamically. This\n * removes their page-render-blocking nature and lets the doc render.\n *\n * @param {!Window} win\n */\nexport function fontStylesheetTimeout(win) {\n  onDocumentReady(win.document, () => maybeTimeoutFonts(win));\n}\n\n/**\n * @param {!Window} win\n */\nfunction maybeTimeoutFonts(win) {\n  // Educated guess \uD83D\uDE05, but we're calculating the correct value further down\n  // if available.\n  let timeSinceNavigationStart = 1500;\n  // If available, we start counting from the time the HTTP request\n  // for the page started. The preload scanner should then quickly\n  // start the CSS download.\n  const perf = win.performance;\n  if (perf && perf.timing && perf.timing.navigationStart) {\n    timeSinceNavigationStart = Date.now() - perf.timing.navigationStart;\n  }\n  // Set timeout such that we have some time to paint fonts in time for\n  // the desired goal of a 2500ms for LCP.\n  const timeout = Math.max(\n    1,\n    2500 - 400 /* Estimated max time to paint */ - timeSinceNavigationStart\n  );\n\n  // Avoid timer dependency since this runs very early in execution.\n  win.setTimeout(() => {\n    // Try again, more fonts might have loaded.\n    timeoutFontFaces(win);\n    const {styleSheets} = win.document;\n    if (!styleSheets) {\n      return;\n    }\n    // Find all stylesheets that aren't loaded from the AMP CDN (those are\n    // critical if they are present).\n    const styleLinkElements = win.document.querySelectorAll(\n      `link[rel~=\"stylesheet\"]:not([href^=\"${escapeCssSelectorIdent(\n        urls.cdn\n      )}\"])`\n    );\n    // Compare external sheets against elements of document.styleSheets.\n    // They do not appear in this list until they have been loaded.\n    const timedoutStyleSheets = [];\n    for (let i = 0; i < styleLinkElements.length; i++) {\n      const link = styleLinkElements[i];\n      let found = false;\n      for (let n = 0; n < styleSheets.length; n++) {\n        if (styleSheets[n].ownerNode == link) {\n          found = true;\n          break;\n        }\n      }\n      if (!found) {\n        timedoutStyleSheets.push(link);\n      }\n    }\n\n    for (let i = 0; i < timedoutStyleSheets.length; i++) {\n      const link = timedoutStyleSheets[i];\n      // To avoid blocking the render, we assign a non-matching media\n      // attribute first\u2026\n      const media = link.media || 'all';\n      link.media = 'print';\n      // And then switch it back to the original after the stylesheet\n      // loaded.\n      link.onload = () => {\n        link.media = media;\n        timeoutFontFaces(win);\n      };\n      link.setAttribute('i-amphtml-timeout', timeout);\n      // Pop/insert the same link. This causes Chrome to unblock, and doesn't\n      // blank out Safari. #12521\n      link.parentNode.insertBefore(link, link.nextSibling);\n    }\n  }, timeout);\n}\n\n/**\n * Sets font faces that haven't been loaded by the time this was called to\n * `font-display: swap` in supported browsers.\n * See https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display\n * for details on behavior.\n * Swap effectively leads to immediate display of the fallback font with\n * the custom font being displayed when possible.\n * While this is not the most desirable setting, it is compatible with the\n * default (which does that but only waiting for 3 seconds).\n * Ideally websites would opt into `font-display: optional` which provides\n * nicer UX for non-icon fonts.\n * If fonts set a non default display mode, this does nothing.\n * @param {!Window} win\n */\nfunction timeoutFontFaces(win) {\n  const doc = win.document;\n  // TODO(@cramforce) Switch to .values when FontFaceSet extern supports it.\n  if (!doc.fonts || !doc.fonts['values']) {\n    return;\n  }\n  const it = doc.fonts['values']();\n  let entry;\n  while ((entry = it.next())) {\n    const fontFace = entry.value;\n    if (!fontFace) {\n      return;\n    }\n    if (fontFace.status != 'loading') {\n      continue;\n    }\n    // Not supported or non-default value.\n    // If the publisher specified a non-default, we respect that, of course.\n    if (!('display' in fontFace) || fontFace.display != 'auto') {\n      continue;\n    }\n    fontFace.display = 'swap';\n  }\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {READY_SCAN_SIGNAL} from './service/resources-interface';\nimport {Services} from './services';\nimport {isIframed} from './dom';\n\n/** @const {!Array<string>} */\nconst EXCLUDE_INI_LOAD = [\n  'AMP-AD',\n  'AMP-ANALYTICS',\n  'AMP-PIXEL',\n  'AMP-AD-EXIT',\n];\n\n/**\n * Returns the promise that will be resolved when all content elements\n * have been loaded in the initially visible set.\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {!Window} hostWin\n * @param {!./layout-rect.LayoutRectDef} rect\n * @param {boolean=} opt_prerenderableOnly signifies if we are in prerender mode.\n * @return {!Promise}\n */\nexport function whenContentIniLoad(\n  elementOrAmpDoc,\n  hostWin,\n  rect,\n  opt_prerenderableOnly\n) {\n  if (INI_LOAD_INOB) {\n    return whenContentIniLoadInOb(elementOrAmpDoc, opt_prerenderableOnly);\n  }\n  return whenContentIniLoadMeasure(\n    elementOrAmpDoc,\n    hostWin,\n    rect,\n    opt_prerenderableOnly\n  );\n}\n\n/**\n * A legacy way using direct measurement.\n *\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {!Window} hostWin\n * @param {!./layout-rect.LayoutRectDef} rect\n * @param {boolean=} opt_prerenderableOnly signifies if we are in prerender mode.\n * @return {!Promise}\n * @visibleForTesting\n * TODO(#31915): remove, once launched.\n */\nexport function whenContentIniLoadMeasure(\n  elementOrAmpDoc,\n  hostWin,\n  rect,\n  opt_prerenderableOnly\n) {\n  const ampdoc = Services.ampdoc(elementOrAmpDoc);\n  return getMeasuredResources(ampdoc, hostWin, (r) => {\n    // TODO(jridgewell): Remove isFixed check here once the position\n    // is calculted correctly in a separate layer for embeds.\n    if (\n      !r.isDisplayed() ||\n      (!r.overlaps(rect) && !r.isFixed()) ||\n      (opt_prerenderableOnly && !r.prerenderAllowed())\n    ) {\n      return false;\n    }\n    return true;\n  }).then((resources) => {\n    const promises = [];\n    resources.forEach((r) => {\n      if (!EXCLUDE_INI_LOAD.includes(r.element.tagName)) {\n        promises.push(r.loadedOnce());\n      }\n    });\n    return Promise.all(promises);\n  });\n}\n\n/**\n * A new way using direct measurement.\n *\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {boolean=} opt_prerenderableOnly signifies if we are in prerender mode.\n * @return {!Promise}\n * @visibleForTesting\n * TODO(#31915): remove visibility\n */\nexport function whenContentIniLoadInOb(elementOrAmpDoc, opt_prerenderableOnly) {\n  const ampdoc = Services.ampdoc(elementOrAmpDoc);\n  // First, wait for the `ready-scan` signal. Waiting for each element\n  // individually is too expensive and `ready-scan` will cover most of\n  // the initially parsed elements.\n  const whenReady = ampdoc.signals().whenSignal(READY_SCAN_SIGNAL);\n  return whenReady.then(() => {\n    // Filter elements.\n    const resources = Services.resourcesForDoc(ampdoc);\n    const elements = resources\n      .get()\n      .filter((r) => {\n        if (opt_prerenderableOnly && !r.prerenderAllowed()) {\n          return false;\n        }\n        return !EXCLUDE_INI_LOAD.includes(r.element.tagName);\n      })\n      .map((r) => r.element);\n\n    if (elements.length === 0) {\n      return Promise.resolve([]);\n    }\n\n    // Find intersecting elements.\n    return new Promise((resolve) => {\n      const {win} = ampdoc;\n      const io = new win.IntersectionObserver(\n        (entries) => {\n          io.disconnect();\n          const intersecting = [];\n          for (let i = 0; i < entries.length; i++) {\n            const {isIntersecting, target} = entries[i];\n            if (isIntersecting) {\n              intersecting.push(target);\n            }\n          }\n          resolve(intersecting);\n        },\n        {\n          // We generally always want `root: document` here. However, in\n          // many browsers this is still polyfilled and `{root: null}` is\n          // a lot faster.\n          root: isIframed(win) ? /** @type {?} */ (win.document) : null,\n          threshold: 0.01,\n        }\n      );\n      // Limit check to the first 100 elements.\n      for (let i = 0; i < Math.min(elements.length, 100); i++) {\n        io.observe(elements[i]);\n      }\n    }).then((elements) => {\n      return Promise.all(elements.map((element) => element.whenLoaded()));\n    });\n  });\n}\n\n/**\n * Returns a subset of resources which are (1) belong to the specified host\n * window, and (2) meet the filterFn given.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {!Window} hostWin\n * @param {function(!./service/resource.Resource):boolean} filterFn\n * @return {!Promise<!Array<!./service/resource.Resource>>}\n */\nexport function getMeasuredResources(ampdoc, hostWin, filterFn) {\n  // First, wait for the `ready-scan` signal. Waiting for each element\n  // individually is too expensive and `ready-scan` will cover most of\n  // the initially parsed elements.\n  return ampdoc\n    .signals()\n    .whenSignal(READY_SCAN_SIGNAL)\n    .then(() => {\n      // Second, wait for any left-over elements to complete measuring.\n      const measurePromiseArray = [];\n      const resources = Services.resourcesForDoc(ampdoc);\n      resources.get().forEach((r) => {\n        if (!r.hasBeenMeasured() && r.hostWin == hostWin && !r.hasOwner()) {\n          measurePromiseArray.push(r.ensureMeasured());\n        }\n      });\n      return Promise.all(measurePromiseArray);\n    })\n    .then(() => {\n      const resources = Services.resourcesForDoc(ampdoc);\n      return resources.get().filter((r) => {\n        return (\n          r.hostWin == hostWin &&\n          !r.hasOwner() &&\n          r.hasBeenMeasured() &&\n          filterFn(r)\n        );\n      });\n    });\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {createCustomEvent} from '../event-helper.js';\nimport {whenContentIniLoad} from '../ini-load';\n\n/**\n * Registers ini-load listener that will fire custom 'amp-ini-load' event\n * on window (accessible if creative is friendly to ad tag) and postMessage to\n * window parent.\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function registerIniLoadListener(ampdoc) {\n  const {win} = ampdoc;\n  const root = ampdoc.getRootNode();\n  whenContentIniLoad(\n    ampdoc,\n    win,\n    Services.viewportForDoc(ampdoc).getLayoutRect(\n      root.documentElement || root.body || root\n    )\n  ).then(() => {\n    win.dispatchEvent(\n      createCustomEvent(win, 'amp-ini-load', /* detail */ null, {bubbles: true})\n    );\n    if (win.parent) {\n      win.parent./*OK*/ postMessage('amp-ini-load', '*');\n    }\n  });\n}\n\n/**\n * Function to get the amp4ads-identifier from the meta tag on the document\n * @param {!Window} win\n * @return {?string}\n */\nexport function getA4AId(win) {\n  const a4aIdMetaTag = win.document.head.querySelector(\n    'meta[name=\"amp4ads-id\"]'\n  );\n\n  if (a4aIdMetaTag) {\n    return a4aIdMetaTag.getAttribute('content');\n  }\n\n  return null;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  CONSTANTS,\n  deserializeMessage,\n  listen,\n  serializeMessage,\n} from '../src/3p-frame-messaging';\nimport {Observable} from '../src/core/data-structures/observable';\nimport {dev} from '../src/log';\nimport {dict, map} from '../src/core/types/object';\nimport {getData} from '../src/event-helper';\nimport {getMode} from '../src/mode';\n\nexport class IframeMessagingClient {\n  /**\n   * @param {!Window} win A window object.\n   * @param {Window=} hostWindow The host window to send messages to. If not set\n   * then we'll broadcast our messages to all parent windows and choose the\n   * first one with a valid response to be the host window.\n   */\n  constructor(win, hostWindow) {\n    /** @private {!Window} */\n    this.win_ = win;\n    /** @private {?string} */\n    this.rtvVersion_ = getMode().rtvVersion || null;\n    /** @private {?Window} */\n    this.hostWindow_ = hostWindow || null;\n    /** @private {?string} */\n    this.sentinel_ = null;\n    /** @type {number} */\n    this.nextMessageId_ = 1;\n    /**\n     * Map messageType keys to observables to be fired when messages of that\n     * type are received.\n     * @private {!Object}\n     */\n    this.observableFor_ = map();\n    this.setupEventListener_();\n  }\n\n  /**\n   * Retrieves data from host.\n   *\n   * @param {string} requestType\n   * @param {?Object} payload\n   * @param {function(*)} callback\n   */\n  getData(requestType, payload, callback) {\n    const responseType = requestType + CONSTANTS.responseTypeSuffix;\n    const messageId = this.nextMessageId_++;\n    const unlisten = this.registerCallback(responseType, (result) => {\n      if (result[CONSTANTS.messageIdFieldName] === messageId) {\n        unlisten();\n        callback(result[CONSTANTS.contentFieldName]);\n      }\n    });\n    const data = dict();\n    data[CONSTANTS.payloadFieldName] = payload;\n    data[CONSTANTS.messageIdFieldName] = messageId;\n    this.sendMessage(requestType, data);\n  }\n\n  /**\n   * Make an event listening request.\n   *\n   * @param {string} requestType The type of the request message.\n   * @param {string} responseType The type of the response message.\n   * @param {function(JsonObject)} callback The callback function to call\n   *   when a message with type responseType is received.\n   * @return {function()}\n   */\n  makeRequest(requestType, responseType, callback) {\n    const unlisten = this.registerCallback(responseType, callback);\n    this.sendMessage(requestType);\n    return unlisten;\n  }\n\n  /**\n   * Make a one time event listening request.\n   * Will unlisten after response is received.\n   *\n   * @param {string} requestType The type of the request message.\n   * @param {string} responseType The type of the response message.\n   * @param {function(Object)} callback The callback function to call\n   *   when a message with type responseType is received.\n   * @return {*} TODO(#23582): Specify return type\n   */\n  requestOnce(requestType, responseType, callback) {\n    const unlisten = this.registerCallback(responseType, (event) => {\n      unlisten();\n      callback(event);\n    });\n    this.sendMessage(requestType);\n    return unlisten;\n  }\n\n  /**\n   * Register callback function for message with type messageType.\n   * @param {string} messageType The type of the message.\n   * @param {function(?JsonObject)} callback The callback function to call\n   *   when a message with type messageType is received.\n   * @return {function()}\n   */\n  registerCallback(messageType, callback) {\n    // NOTE : no validation done here. any callback can be register\n    // for any callback, and then if that message is received, this\n    // class *will execute* that callback\n    return this.getOrCreateObservableFor_(messageType).add(callback);\n  }\n\n  /**\n   * Send a postMessage to Host Window, or all parent windows if host window is\n   * not set.\n   * @param {string} type The type of message to send.\n   * @param {JsonObject=} opt_payload The payload of message to send.\n   */\n  sendMessage(type, opt_payload) {\n    const msg = serializeMessage(\n      type,\n      dev().assertString(this.sentinel_),\n      opt_payload,\n      this.rtvVersion_\n    );\n\n    if (!this.hostWindow_) {\n      for (\n        let j = 0, hostWin = this.win_;\n        j < 10 && hostWin != this.win_.top;\n        j++\n      ) {\n        hostWin = hostWin.parent;\n        this.sendMessageInternal_(hostWin, msg);\n        j++;\n      }\n    } else {\n      this.sendMessageInternal_(this.hostWindow_, msg);\n    }\n  }\n\n  /**\n   * @param {!Window} win\n   * @param {string} msg\n   * private\n   */\n  sendMessageInternal_(win, msg) {\n    // opt in the userActivation feature\n    // see https://github.com/dtapuska/useractivation\n    if (this.isMessageOptionsSupported_(win)) {\n      this.postMessageWithUserActivation_(win, msg);\n    } else {\n      win./*OK*/ postMessage(msg, '*');\n    }\n  }\n\n  /**\n   * @param {!Window} win\n   * @param {string} msg\n   * @suppress {checkTypes} // Can be removed after closure compiler update their externs.\n   */\n  postMessageWithUserActivation_(win, msg) {\n    win./*OK*/ postMessage(\n      msg,\n      dict({\n        'targetOrigin': '*',\n        'includeUserActivation': true,\n      })\n    );\n  }\n\n  /**\n   * Sets up event listener for post messages of the desired type.\n   *   The actual implementation only uses a single event listener for all of\n   *   the different messages, and simply diverts the message to be handled\n   *   by different callbacks.\n   *   To add new messages to listen for, call registerCallback with the\n   *   messageType to listen for, and the callback function.\n   * @private\n   */\n  setupEventListener_() {\n    listen(this.win_, 'message', (event) => {\n      // If we have set a host window, strictly check that it's from it.\n      if (this.hostWindow_ && event.source != this.hostWindow_) {\n        return;\n      }\n\n      // Does it look like a message from AMP?\n      const message = deserializeMessage(getData(event));\n      if (!message || message['sentinel'] != this.sentinel_) {\n        return;\n      }\n\n      // At this point the message is valid; serialize necessary information and\n      // set its source as the host window if we don't have it set (aka in\n      // broadcast mode).\n      message['origin'] = event.origin;\n\n      if (!this.hostWindow_) {\n        this.hostWindow_ = event.source;\n      }\n\n      this.fireObservable_(message['type'], message);\n    });\n  }\n\n  /**\n   * @param {string} sentinel\n   */\n  setSentinel(sentinel) {\n    this.sentinel_ = sentinel;\n  }\n\n  /**\n   * @param {string} messageType\n   * @return {!Observable<?JsonObject>}\n   */\n  getOrCreateObservableFor_(messageType) {\n    if (!(messageType in this.observableFor_)) {\n      this.observableFor_[messageType] = new Observable();\n    }\n    return this.observableFor_[messageType];\n  }\n\n  /**\n   * @param {string} messageType\n   * @param {Object} message\n   */\n  fireObservable_(messageType, message) {\n    if (messageType in this.observableFor_) {\n      this.observableFor_[messageType].fire(message);\n    }\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {boolean}\n   */\n  isMessageOptionsSupported_(win) {\n    // Learned from https://github.com/dtapuska/useractivation\n    return win.postMessage.length == 1;\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {IframeMessagingClient} from '../../3p/iframe-messaging-client';\nimport {canInspectWindow} from '../iframe-helper';\nimport {getExistingServiceOrNull, registerServiceBuilder} from '../service';\nimport {tryParseJson} from '../core/types/object/json';\n\n/**\n * @param {!Window} win\n * @return {?../../3p/iframe-messaging-client.IframeMessagingClient}\n */\nexport function iframeMessagingClientFor(win) {\n  return /** @type {?../../3p/iframe-messaging-client.IframeMessagingClient} */ (\n    getExistingServiceOrNull(win, 'iframeMessagingClient')\n  );\n}\n\n/**\n * @param {!Window} win\n */\nexport function installIframeMessagingClient(win) {\n  if (!canInspectWindow(win.top)) {\n    registerServiceBuilder(\n      win,\n      'iframeMessagingClient',\n      createIframeMessagingClient.bind(null, win),\n      /* opt_instantiate */ true\n    );\n  }\n}\n\n/**\n * @param {!Window} win\n * @return {!../../3p/iframe-messaging-client.IframeMessagingClient}\n */\nfunction createIframeMessagingClient(win) {\n  const iframeClient = new IframeMessagingClient(win);\n  //  Try read sentinel from window first.\n  const dataObject = tryParseJson(win.name);\n  let sentinel = null;\n  if (dataObject && dataObject['_context']) {\n    sentinel = dataObject['_context']['sentinel'];\n  }\n  iframeClient.setSentinel(sentinel || getRandom(win));\n  return iframeClient;\n}\n\n/**\n * @param {!Window} win\n * @return {string}\n */\nfunction getRandom(win) {\n  return String(win.Math.random()).substr(2);\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CidDef} from '../service/cid-impl';\nimport {registerServiceBuilderForDoc} from '../service';\n\n/**\n * A dummy impl of CID service as CLIENT_ID is not supported\n * in inabox.\n *\n * @implements {CidDef}\n */\nclass InaboxCid {\n  /** @override */\n  get() {\n    return Promise.resolve(null);\n  }\n\n  /** @override */\n  optOut() {}\n}\n\n/**\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n * @return {*} TODO(#23582): Specify return type\n */\nexport function installInaboxCidService(ampdoc) {\n  return registerServiceBuilderForDoc(ampdoc, 'cid', InaboxCid);\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {registerServiceBuilderForDoc} from '../service';\n\n/**\n * @implements {../service/mutator-interface.MutatorInterface}\n */\nexport class InaboxMutator {\n  /**\n   * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const @private {!../service/resources-interface.ResourcesInterface} */\n    this.resources_ = Services.resourcesForDoc(ampdoc);\n\n    /** @private @const {!../service/vsync-impl.Vsync} */\n    this.vsync_ = Services./*OK*/ vsyncFor(ampdoc.win);\n  }\n\n  /** @override */\n  forceChangeSize(element, newHeight, newWidth, opt_callback, opt_newMargins) {\n    this.requestChangeSize(element, newHeight, newWidth, opt_newMargins).then(\n      () => {\n        if (opt_callback) {\n          opt_callback();\n        }\n      }\n    );\n  }\n\n  /** @override */\n  requestChangeSize(element, newHeight, newWidth, opt_newMargins) {\n    return this.mutateElement(element, () => {\n      this.resources_\n        .getResourceForElement(element)\n        .changeSize(newHeight, newWidth, opt_newMargins);\n    });\n  }\n\n  /** @override */\n  expandElement(element) {\n    const resource = this.resources_.getResourceForElement(element);\n    resource.completeExpand();\n    this.resources_./*OK*/ schedulePass();\n  }\n\n  /** @override */\n  attemptCollapse(element) {\n    return this.mutateElement(element, () => {\n      this.resources_.getResourceForElement(element).completeCollapse();\n    });\n  }\n\n  /** @override */\n  collapseElement(element) {\n    this.resources_.getResourceForElement(element).completeCollapse();\n    this.resources_./*OK*/ schedulePass();\n  }\n\n  /** @override */\n  measureElement(measurer) {\n    return this.vsync_.measurePromise(measurer);\n  }\n\n  /** @override */\n  mutateElement(element, mutator) {\n    return this.measureMutateElement(element, null, mutator);\n  }\n\n  /** @override */\n  measureMutateElement(element, measurer, mutator) {\n    return this.vsync_.runPromise({\n      measure: () => {\n        if (measurer) {\n          measurer();\n        }\n      },\n      mutate: () => {\n        mutator();\n        this.resources_./*OK*/ schedulePass();\n      },\n    });\n  }\n}\n\n/**\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installInaboxMutatorServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'mutator', InaboxMutator);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ViewerInterface} from '../service/viewer-interface';\nimport {registerServiceBuilderForDoc} from '../service';\n\n/**\n * A dummy impl of ViewerInterface for inabox.\n *\n * @implements {ViewerInterface}\n */\nclass InaboxViewer {\n  /**\n   * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const {!../service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n  }\n\n  /** @override */\n  getAmpDoc() {\n    return this.ampdoc_;\n  }\n\n  /** @override */\n  getParam(name) {\n    return this.ampdoc_.getParam(name);\n  }\n\n  /** @override */\n  hasCapability() {\n    return false;\n  }\n\n  /** @override */\n  isEmbedded() {\n    return false;\n  }\n\n  /** @override */\n  isWebviewEmbedded() {\n    return false;\n  }\n\n  /** @override */\n  isCctEmbedded() {\n    return false;\n  }\n\n  /** @override */\n  isProxyOrigin() {\n    return false;\n  }\n\n  /** @override */\n  maybeUpdateFragmentForCct() {}\n\n  /**\n   * @return {boolean}\n   */\n  isRuntimeOn() {\n    return true;\n  }\n\n  /** @override */\n  toggleRuntime() {}\n\n  /** @override */\n  onRuntimeState() {\n    return () => {};\n  }\n\n  /** @override */\n  isOvertakeHistory() {\n    return false;\n  }\n\n  /** @override */\n  getResolvedViewerUrl() {\n    return this.ampdoc_.win.location.href;\n  }\n\n  /** @override */\n  maybeGetMessagingOrigin() {\n    return null;\n  }\n\n  /** @override */\n  getUnconfirmedReferrerUrl() {\n    return this.ampdoc_.win.document.referrer;\n  }\n\n  /** @override */\n  getReferrerUrl() {\n    return Promise.resolve(this.getUnconfirmedReferrerUrl());\n  }\n\n  /** @override */\n  isTrustedViewer() {\n    return Promise.resolve(false);\n  }\n\n  /** @override */\n  getViewerOrigin() {\n    return Promise.resolve('');\n  }\n\n  /** @override */\n  onMessage() {\n    return () => {};\n  }\n\n  /** @override */\n  onMessageRespond() {\n    return () => {};\n  }\n\n  /** @override */\n  receiveMessage() {}\n\n  /** @override */\n  setMessageDeliverer() {}\n\n  /** @override */\n  sendMessage() {}\n\n  /** @override */\n  sendMessageAwaitResponse() {\n    return Promise.resolve();\n  }\n\n  /** @override */\n  broadcast() {\n    return Promise.resolve(false);\n  }\n\n  /** @override */\n  onBroadcast() {\n    return () => {};\n  }\n\n  /** @override */\n  whenMessagingReady() {\n    return null;\n  }\n\n  /** @override */\n  replaceUrl() {}\n}\n\n/**\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installInaboxViewerServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    'viewer',\n    InaboxViewer,\n    /* opt_instantiate */ true\n  );\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {px, resetStyles, setStyles, translate} from './style';\n\n/**\n * Centers a frame with a translate transition.\n * This function does direct DOM manipulation, so it needs to run under vsync\n * mutate context.\n * @param {!HTMLIFrameElement} iframe\n * @param {!ClientRect} iframeRect\n * @param {{width: number, height: number}} viewportSize\n * @param {number} transitionTimeMs\n */\nexport function centerFrameUnderVsyncMutate(\n  iframe,\n  iframeRect,\n  viewportSize,\n  transitionTimeMs\n) {\n  // TODO(alanorozco): Place a sentinel sibling on inabox to account for\n  // gap necessary for position: fixed.\n\n  const translateX = px(\n    viewportSize.width / 2 - iframeRect.width / 2 - iframeRect.left\n  );\n\n  const translateY = px(\n    viewportSize.height / 2 - iframeRect.height / 2 - iframeRect.top\n  );\n\n  setStyles(iframe, {\n    'position': 'fixed',\n    'top': px(iframeRect.top),\n    'right': px(viewportSize.width - (iframeRect.left + iframeRect.width)),\n    'left': px(iframeRect.left),\n    'bottom': px(viewportSize.height - (iframeRect.top + iframeRect.height)),\n    'height': px(iframeRect.height),\n    'width': px(iframeRect.width),\n    'transition': `transform ${transitionTimeMs}ms ease`,\n    'transform': translate(translateX, translateY),\n    'margin': 0,\n  });\n}\n\n/**\n * Expands frame to fill the entire viewport.\n * This function does direct DOM manipulation, so it needs to run under vsync\n * mutate context.\n * @param {!HTMLIFrameElement} iframe\n */\nexport function expandFrameUnderVsyncMutate(iframe) {\n  setStyles(iframe, {\n    'position': 'fixed',\n    'z-index': 1000,\n    'left': 0,\n    'right': 0,\n    'top': 0,\n    'bottom': 0,\n    'width': '100vw',\n    'height': '100vh',\n    'transition': null,\n    'transform': null,\n    'margin': 0,\n    'border': 0,\n  });\n}\n\n/**\n * Resets frame that was previously expanded to fill the entire viewport.\n * This function does direct DOM manipulation, so it needs to run under vsync\n * mutate context.\n * @param {!HTMLIFrameElement} iframe\n */\nexport function collapseFrameUnderVsyncMutate(iframe) {\n  resetStyles(iframe, [\n    'position',\n    'z-index',\n    'left',\n    'right',\n    'top',\n    'bottom',\n    'width',\n    'height',\n    'margin',\n    'border',\n  ]);\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Executes a \"restricted\" read/write vsync cycle.\n * This function exists mainly since the vsync service is not available for the\n * inabox host script.\n * It also helps with maintainability. Since the passed tasks have to define\n * measure and mutate callbacks, it makes it harder for the calling code to be\n * changed in a way that screws up the read-write order.\n * Please note that this is NOT real vsync. Concurrent reads and writes ARE NOT\n * BATCHED. This means that using this can still cause layout thrashing if it's\n * being called more than once within the same frame. Use with caution.\n * @param {!Window} win\n * @param {{measure: (Function|undefined), mutate: (Function|undefined)}} task\n * @param {!Object=} opt_state\n * @visibleForTesting\n * TODO(alanorozco): Figure out a longer-term solution\n */\nexport function restrictedVsync(win, task, opt_state) {\n  win.requestAnimationFrame(() => {\n    if (task.measure) {\n      task.measure(opt_state);\n    }\n    if (task.mutate) {\n      task.mutate(opt_state);\n    }\n  });\n}\n\n/**\n * Executes a function after a certain time.\n * The timer service is not available for the inabox host script, hence this\n * function.\n * Not using setTimeout directly allows us to execute the callback directly on\n * tests.\n * @param {!Function} callback\n * @param {number} timeMs\n * @visibleForTesting\n */\nexport function timer(callback, timeMs) {\n  setTimeout(callback, timeMs);\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  LayoutRectDef,\n  layoutRectFromDomRect,\n  layoutRectLtwh,\n} from '../../src/core/math/layout-rect';\nimport {\n  centerFrameUnderVsyncMutate,\n  collapseFrameUnderVsyncMutate,\n  expandFrameUnderVsyncMutate,\n} from '../../src/full-overlay-frame-helper';\nimport {resetStyles, setImportantStyles} from '../../src/style';\nimport {restrictedVsync, timer} from './util';\n\nconst CENTER_TRANSITION_TIME_MS = 150;\nconst CENTER_TRANSITION_END_WAIT_TIME_MS = 50;\n\n/**\n * Places the child frame in full overlay mode.\n * @param {!Window} win Host window.\n * @param {!HTMLIFrameElement} iframe\n * @param {function(!LayoutRectDef, !LayoutRectDef)} onFinish\n * @private\n */\nconst expandFrameImpl = function (win, iframe, onFinish) {\n  restrictedVsync(\n    win,\n    {\n      measure(state) {\n        state.viewportSize = {\n          width: win./*OK*/ innerWidth,\n          height: win./*OK*/ innerHeight,\n        };\n        state.rect = layoutRectFromDomRect(\n          iframe./*OK*/ getBoundingClientRect()\n        );\n      },\n      mutate(state) {\n        const {height, width} = state.viewportSize;\n        const expandedRect = layoutRectLtwh(0, 0, width, height);\n\n        centerFrameUnderVsyncMutate(\n          iframe,\n          state.rect,\n          state.viewportSize,\n          CENTER_TRANSITION_TIME_MS\n        );\n\n        // To prevent double click during transition;\n        setImportantStyles(iframe, {'pointer-events': 'none'});\n\n        timer(() => {\n          restrictedVsync(win, {\n            mutate() {\n              resetStyles(iframe, ['pointer-events']);\n              expandFrameUnderVsyncMutate(iframe);\n              onFinish(state.rect, expandedRect);\n            },\n          });\n        }, CENTER_TRANSITION_TIME_MS + CENTER_TRANSITION_END_WAIT_TIME_MS);\n      },\n    },\n    {}\n  );\n};\n\n/**\n * Resets the frame from full overlay mode.\n * @param {!Window} win Host window.\n * @param {!HTMLIFrameElement} iframe\n * @param {function()} onFinish\n * @param {function(!LayoutRectDef)} onMeasure\n * @private\n */\nconst collapseFrameImpl = function (win, iframe, onFinish, onMeasure) {\n  restrictedVsync(win, {\n    mutate() {\n      collapseFrameUnderVsyncMutate(iframe);\n\n      onFinish();\n\n      // remeasure so client knows about updated dimensions\n      restrictedVsync(win, {\n        measure() {\n          onMeasure(\n            layoutRectFromDomRect(iframe./*OK*/ getBoundingClientRect())\n          );\n        },\n      });\n    },\n  });\n};\n\n/**\n * Places the child frame in full overlay mode.\n * @param {!Window} win Host window.\n * @param {!HTMLIFrameElement} iframe\n * @param {function(!LayoutRectDef, !LayoutRectDef)} onFinish\n */\nexport let expandFrame = expandFrameImpl;\n\n/**\n * @param {!Function} implFn\n * @visibleForTesting\n */\nexport function stubExpandFrameForTesting(implFn) {\n  expandFrame = implFn;\n}\n\n/**\n * @visibleForTesting\n */\nexport function resetExpandFrameForTesting() {\n  expandFrame = expandFrameImpl;\n}\n\n/**\n * Places the child frame in full overlay mode.\n * @param {!Window} win Host window.\n * @param {!HTMLIFrameElement} iframe\n * @param {function()} onFinish\n * @param {function(!LayoutRectDef)} onMeasure\n */\nexport let collapseFrame = collapseFrameImpl;\n\n/**\n * @param {!Function} implFn\n * @visibleForTesting\n */\nexport function stubCollapseFrameForTesting(implFn) {\n  collapseFrame = implFn;\n}\n\n/**\n * @visibleForTesting\n */\nexport function resetCollapseFrameForTesting() {\n  collapseFrame = collapseFrameImpl;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {collapseFrame, expandFrame} from './frame-overlay-helper';\n\n/** @const */\nconst AMP_INABOX_FRAME_OVERLAY_MANAGER = 'ampInaboxFrameOverlayManager';\n\n/**\n * Inabox host manager for full overlay frames.\n */\nexport class FrameOverlayManager {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {boolean} */\n    this.isExpanded_ = false;\n\n    /** @private {boolean} */\n    this.viewportChangedSinceExpand_ = false;\n\n    // TODO(alanorozco): type\n    /** @private {?} */\n    this.collapsedRect_ = null;\n\n    this.listenToViewportChanges_();\n  }\n\n  /** @private */\n  listenToViewportChanges_() {\n    this.win_.addEventListener('resize', () => this.onWindowResize());\n  }\n\n  /** @visibleForTesting */\n  onWindowResize() {\n    if (this.isExpanded_) {\n      this.viewportChangedSinceExpand_ = true;\n    }\n  }\n\n  /**\n   * Expands an iframe to full overlay.\n   * @param {!HTMLIFrameElement} iframe\n   * @param {!Function} callback Gets executed when expanded with the new box\n   *  rect.\n   */\n  expandFrame(iframe, callback) {\n    expandFrame(this.win_, iframe, (collapsedRect, expandedRect) => {\n      this.isExpanded_ = true;\n      this.viewportChangedSinceExpand_ = false;\n      this.collapsedRect_ = collapsedRect;\n      callback(expandedRect);\n    });\n  }\n\n  /**\n   * Collapses an iframe back from full overlay.\n   * @param {!HTMLIFrameElement} iframe\n   * @param {!Function} callback Gets executed when collapsed with the new box\n   *  rect.\n   */\n  collapseFrame(iframe, callback) {\n    // There is a delay of one animation frame between collapsing and measuring\n    // the box rect. collapseFrame() takes a callback for each event.\n    //\n    // We know what the collapsed box was. If the viewport has not changed while\n    // expanded, we can immediately notify the consumer of the collapsed\n    // box rect since it should be the same. Otherwise, we wait for remeasure.\n    collapseFrame(\n      this.win_,\n      iframe,\n      () => {\n        this.isExpanded_ = false;\n\n        if (!this.viewportChangedSinceExpand_) {\n          callback(this.collapsedRect_);\n        }\n      },\n      (collapsedRect) => {\n        this.collapsedRect_ = collapsedRect;\n\n        if (this.viewportChangedSinceExpand_) {\n          callback(this.collapsedRect_);\n        }\n      }\n    );\n  }\n}\n\n/**\n * Use an existing frame overlay manager within the window, if any.\n * @param {!Window} win\n * @return {!FrameOverlayManager}\n */\nexport function getFrameOverlayManager(win) {\n  win[AMP_INABOX_FRAME_OVERLAY_MANAGER] =\n    win[AMP_INABOX_FRAME_OVERLAY_MANAGER] || new FrameOverlayManager(win);\n  return win[AMP_INABOX_FRAME_OVERLAY_MANAGER];\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  LayoutRectDef,\n  layoutRectFromDomRect,\n  layoutRectLtwh,\n  moveLayoutRect,\n} from '../../src/core/math/layout-rect';\nimport {Observable} from '../../src/core/data-structures/observable';\nimport {throttle} from '../../src/core/types/function';\n\n/**\n * @typedef {{\n *   viewportRect: !LayoutRectDef,\n *   targetRect: !LayoutRectDef,\n * }}\n */\nlet PositionEntryDef;\n\n/** @const */\nconst MIN_EVENT_INTERVAL_IN_MS = 100;\n\n/** @const */\nconst AMP_INABOX_POSITION_OBSERVER = 'ampInaboxPositionObserver';\n\nexport class PositionObserver {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private {!Window} */\n    this.win_ = win;\n    /** @private {?Observable} */\n    this.positionObservable_ = null;\n    /** @protected {!Element} */\n    this.scrollingElement_ = getScrollingElement(this.win_);\n    /** @private {?LayoutRectDef} */\n    this.viewportRect_ = null;\n  }\n\n  /**\n   * Start to observe the target element's position change and trigger callback.\n   * TODO: maybe take DOM mutation into consideration\n   * @param {!Element} element\n   * @param {function(!PositionEntryDef)} callback\n   * @return {!UnlistenDef}\n   */\n  observe(element, callback) {\n    if (!this.positionObservable_) {\n      this.positionObservable_ = new Observable();\n      const listener = throttle(\n        this.win_,\n        () => {\n          this.update_();\n          this.positionObservable_.fire();\n        },\n        MIN_EVENT_INTERVAL_IN_MS\n      );\n      this.update_();\n      this.win_.addEventListener('scroll', listener, true);\n      this.win_.addEventListener('resize', listener, true);\n    }\n    // Send the 1st ping immediately\n    callback(this.getPositionEntry_(element));\n    return this.positionObservable_.add(() => {\n      callback(this.getPositionEntry_(element));\n    });\n  }\n\n  /**\n   * Updates viewport rect.\n   */\n  update_() {\n    this.viewportRect_ = this.getViewportRect();\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {!PositionEntryDef}\n   * @private\n   */\n  getPositionEntry_(element) {\n    return {\n      'viewportRect': /** @type {!LayoutRectDef} */ (this.viewportRect_),\n      // relative position to viewport\n      'targetRect': this.getTargetRect(element),\n    };\n  }\n\n  /**\n   * A  method to get viewport rect\n   * @return {LayoutRectDef}\n   */\n  getViewportRect() {\n    const {scrollingElement_: scrollingElement, win_: win} = this;\n\n    const scrollLeft =\n      scrollingElement./*OK*/ scrollLeft || win./*OK*/ pageXOffset;\n    const scrollTop =\n      scrollingElement./*OK*/ scrollTop || win./*OK*/ pageYOffset;\n    return layoutRectLtwh(\n      Math.round(scrollLeft),\n      Math.round(scrollTop),\n      win./*OK*/ innerWidth,\n      win./*OK*/ innerHeight\n    );\n  }\n\n  /**\n   * Get the element's layout rect relative to the viewport. Attempt to walk up\n   * the DOM and add the offset of all nested parent iframes since\n   * getBoundingClientRect() is only relative to the immediate window. Assumes\n   * that all parent frames are friendly and can be inspected (because the\n   * element itself can be inspected as well).\n   * @param {!Element} element\n   * @return {!LayoutRectDef}\n   */\n  getTargetRect(element) {\n    let targetRect = layoutRectFromDomRect(\n      element./*OK*/ getBoundingClientRect()\n    );\n    const parentWin = element.ownerDocument.defaultView;\n    for (\n      let j = 0, tempWin = parentWin;\n      j < 10 &&\n      // win can be null if the ad iframe is already destroyed\n      tempWin &&\n      tempWin != this.win_ &&\n      tempWin != this.win_.top;\n      j++, tempWin = tempWin.parent\n    ) {\n      const parentFrameRect = layoutRectFromDomRect(\n        tempWin.frameElement./*OK*/ getBoundingClientRect()\n      );\n      targetRect = moveLayoutRect(\n        targetRect,\n        parentFrameRect.left,\n        parentFrameRect.top\n      );\n    }\n    return targetRect;\n  }\n}\n\n/**\n * @param {!Window} win\n * @return {!Element}\n */\nfunction getScrollingElement(win) {\n  const doc = win.document;\n  if (doc./*OK*/ scrollingElement) {\n    return doc./*OK*/ scrollingElement;\n  }\n  if (\n    doc.body &&\n    // Due to https://bugs.webkit.org/show_bug.cgi?id=106133, WebKit\n    // browsers have to use `body` and NOT `documentElement` for\n    // scrolling purposes. This has mostly being resolved via\n    // `scrollingElement` property, but this branch is still necessary\n    // for backward compatibility purposes.\n    isWebKit(win.navigator.userAgent)\n  ) {\n    return doc.body;\n  }\n  return doc.documentElement;\n}\n\n/**\n * Whether the current browser is based on the WebKit engine.\n * @param {string} ua\n * @return {boolean}\n */\nfunction isWebKit(ua) {\n  return /WebKit/i.test(ua) && !/Edge/i.test(ua);\n}\n\n/**\n * Use an existing position observer within the window, if any.\n * @param {!Window} win\n * @return {!PositionObserver}\n */\nexport function getPositionObserver(win) {\n  win[AMP_INABOX_POSITION_OBSERVER] =\n    win[AMP_INABOX_POSITION_OBSERVER] || new PositionObserver(win);\n  return win[AMP_INABOX_POSITION_OBSERVER];\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {MessageType} from '../../src/3p-frame-messaging';\nimport {Observable} from '../core/data-structures/observable';\nimport {Services} from '../services';\nimport {ViewportBindingDef} from '../service/viewport/viewport-binding-def';\nimport {ViewportInterface} from '../service/viewport/viewport-interface';\nimport {canInspectWindow} from '../iframe-helper';\nimport {dev} from '../log';\nimport {devAssert, devAssertElement} from '../core/assert';\nimport {getFrameOverlayManager} from '../../ads/inabox/frame-overlay-manager.js';\nimport {getPositionObserver} from '../../ads/inabox/position-observer';\nimport {iframeMessagingClientFor} from './inabox-iframe-messaging-client';\nimport {isIframed} from '../dom';\nimport {\n  layoutRectFromDomRect,\n  layoutRectLtwh,\n  moveLayoutRect,\n} from '../core/math/layout-rect';\nimport {px, resetStyles, setImportantStyles} from '../style';\nimport {registerServiceBuilderForDoc} from '../service';\nimport {throttle} from '../core/types/function';\n\n/** @const {string} */\nconst TAG = 'inabox-viewport';\n\n/** @const {number} */\nconst MIN_EVENT_INTERVAL = 100;\n\n/**\n * @param {!Window} win\n * @param {!Element} bodyElement\n * @return {!Promise}\n * @visibleForTesting\n */\nexport function prepareBodyForOverlay(win, bodyElement) {\n  return Services.vsyncFor(win).runPromise(\n    {\n      measure: (state) => {\n        state.width = win./*OK*/ innerWidth;\n        state.height = win./*OK*/ innerHeight;\n      },\n      mutate: (state) => {\n        // We need to override runtime-level !important rules\n        setImportantStyles(bodyElement, {\n          'background': 'transparent',\n          'left': '50%',\n          'top': '50%',\n          'right': 'auto',\n          'bottom': 'auto',\n          'position': 'absolute',\n          'height': px(state.height),\n          'width': px(state.width),\n          'margin-top': px(-state.height / 2),\n          'margin-left': px(-state.width / 2),\n        });\n      },\n    },\n    {}\n  );\n}\n\n/**\n * @param {!Window} win\n * @param {!Element} bodyElement\n * @return {!Promise}\n * @visibleForTesting\n */\nexport function resetBodyForOverlay(win, bodyElement) {\n  return Services.vsyncFor(win).mutatePromise(() => {\n    // We're not resetting background here as it's supposed to remain\n    // transparent.\n    resetStyles(bodyElement, [\n      'position',\n      'left',\n      'top',\n      'right',\n      'bottom',\n      'width',\n      'height',\n      'margin-left',\n      'margin-top',\n    ]);\n  });\n}\n\n/**\n * This object represents the viewport. It tracks scroll position, resize\n * and other events and notifies interesting parties when viewport has changed\n * and how.\n * @implements {ViewportInterface}\n */\nclass InaboxViewportImpl {\n  /**\n   * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {!ViewportBindingDef} binding\n   */\n  constructor(ampdoc, binding) {\n    const {win} = ampdoc;\n\n    /** @const {!../service/ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @const {!ViewportBindingDef} */\n    this.binding_ = binding;\n\n    /**\n     * Used to cache the rect of the viewport.\n     * @private {?../layout-rect.LayoutRectDef}\n     */\n    this.rect_ = null;\n\n    /** @private @const {!Observable<!../service/viewport/viewport-interface.ViewportChangedEventDef>} */\n    this.changeObservable_ = new Observable();\n\n    /** @private @const {!Observable} */\n    this.scrollObservable_ = new Observable();\n\n    /** @private @const {!Observable<!../service/viewport/viewport-interface.ViewportResizedEventDef>} */\n    this.resizeObservable_ = new Observable();\n\n    this.binding_.onScroll(this.scroll_.bind(this));\n    this.binding_.onResize(this.resize_.bind(this));\n\n    /** @private {boolean} */\n    this.visible_ = false;\n    this.ampdoc.onVisibilityChanged(this.updateVisibility_.bind(this));\n    this.updateVisibility_();\n\n    // Workaround for Safari not firing visibilityChange when the page is\n    // unloaded (https://bugs.webkit.org/show_bug.cgi?id=151234).\n    // TODO(zombifier): Remove this when ampdoc can handle this event.\n    /** @private @const {function()} */\n    this.boundDispose_ = this.dispose.bind(this);\n    win.addEventListener('pagehide', this.boundDispose_);\n\n    // Top-level mode classes.\n    const docElement = win.document.documentElement;\n    docElement.classList.add('i-amphtml-singledoc');\n    docElement.classList.add('i-amphtml-standalone');\n    if (isIframed(win)) {\n      docElement.classList.add('i-amphtml-iframed');\n    }\n  }\n\n  /** @override */\n  dispose() {\n    this.binding_.disconnect();\n    this.ampdoc.win.removeEventListener('pagehide', this.boundDispose_);\n  }\n\n  /** @override */\n  ensureReadyForElements() {}\n\n  /** @override */\n  getPaddingTop() {\n    return 0;\n  }\n\n  /** @override */\n  getScrollTop() {\n    return this.binding_.getScrollTop();\n  }\n\n  /** @override */\n  getScrollLeft() {\n    return this.binding_.getScrollLeft();\n  }\n\n  /** @override */\n  setScrollTop(unusedScrollPos) {}\n\n  /** @override */\n  updatePaddingBottom(unusedPaddingBottom) {}\n\n  /** @override */\n  getSize() {\n    return this.binding_.getSize();\n  }\n\n  /** @override */\n  getHeight() {\n    return this.getSize().height;\n  }\n\n  /** @override */\n  getWidth() {\n    return this.getSize().width;\n  }\n\n  /** @override */\n  getScrollWidth() {\n    return this.binding_.getScrollWidth();\n  }\n\n  /** @override */\n  getScrollHeight() {\n    return this.binding_.getScrollHeight();\n  }\n\n  /** @override */\n  getContentHeight() {\n    return this.binding_.getContentHeight();\n  }\n\n  /** @override */\n  contentHeightChanged() {}\n\n  /** @override */\n  getRect() {\n    if (this.rect_ == null) {\n      const size = this.getSize();\n      this.rect_ = layoutRectLtwh(\n        this.getScrollLeft(),\n        this.getScrollTop(),\n        size.width,\n        size.height\n      );\n    }\n    return this.rect_;\n  }\n\n  /** @override */\n  getLayoutRect(el) {\n    return this.binding_.getLayoutRect(el);\n  }\n\n  /**\n   * @override\n   * Note: This method does not taking intersection into account.\n   * TODO(@zhouyx): We may need to return info on the intersectionRect.\n   */\n  getClientRectAsync(el) {\n    const local = el./*OK*/ getBoundingClientRect();\n    return this.binding_.getRootClientRectAsync().then((root) => {\n      if (!root) {\n        return layoutRectFromDomRect(local);\n      }\n      return moveLayoutRect(local, root.left, root.top);\n    });\n  }\n\n  /** @override */\n  supportsPositionFixed() {\n    return false;\n  }\n\n  /** @override */\n  isDeclaredFixed(unusedElement) {\n    return false;\n  }\n\n  /** @override */\n  scrollIntoView(unusedElement) {\n    return Promise.resolve();\n  }\n\n  /** @override */\n  animateScrollIntoView(unusedElement, unusedPos, opt_duration, opt_curve) {\n    return Promise.resolve();\n  }\n\n  /** @override */\n  animateScrollWithinParent(\n    unusedElement,\n    unusedParent,\n    unusedPos,\n    opt_duration,\n    opt_curve\n  ) {\n    return Promise.resolve();\n  }\n\n  /** @override */\n  getScrollingElement() {\n    return this.binding_.getScrollingElement();\n  }\n\n  /** @override */\n  onChanged(handler) {\n    return this.changeObservable_.add(handler);\n  }\n\n  /** @override */\n  onScroll(handler) {\n    return this.scrollObservable_.add(handler);\n  }\n\n  /** @override */\n  onResize(handler) {\n    return this.resizeObservable_.add(handler);\n  }\n\n  /** @override */\n  enterLightboxMode(opt_requestingElement, opt_onComplete) {\n    this.enterOverlayMode();\n    return this.binding_.updateLightboxMode(true);\n  }\n\n  /** @override */\n  leaveLightboxMode(opt_requestingElement) {\n    this.leaveOverlayMode();\n    return this.binding_.updateLightboxMode(false);\n  }\n\n  /** @override */\n  enterOverlayMode() {\n    this.disableTouchZoom();\n    this.disableScroll();\n  }\n\n  /** @override */\n  leaveOverlayMode() {\n    this.resetScroll();\n    this.restoreOriginalTouchZoom();\n  }\n\n  /** @override */\n  disableScroll() {}\n\n  /** @override */\n  resetScroll() {}\n\n  /** @override */\n  resetTouchZoom() {}\n\n  /** @override */\n  disableTouchZoom() {\n    return false;\n  }\n\n  /** @override */\n  restoreOriginalTouchZoom() {\n    return false;\n  }\n\n  /** @override */\n  updateFixedLayer() {\n    return Promise.resolve();\n  }\n\n  /** @override */\n  addToFixedLayer(unusedElement, opt_forceTransfer) {\n    return Promise.resolve();\n  }\n\n  /** @override */\n  removeFromFixedLayer(unusedElement) {}\n\n  /** @override */\n  createFixedLayer(unusedConstructor) {}\n\n  /**\n   * @private\n   */\n  changed_() {\n    const size = this.getSize();\n    const scrollTop = this.getScrollTop();\n    const scrollLeft = this.getScrollLeft();\n    this.changeObservable_.fire({\n      relayoutAll: false,\n      top: scrollTop,\n      left: scrollLeft,\n      width: size.width,\n      height: size.height,\n      velocity: 0,\n    });\n  }\n\n  /** @private */\n  scroll_() {\n    this.rect_ = null;\n    if (this.binding_.getScrollTop() < 0) {\n      // iOS and some other browsers use negative values of scrollTop for\n      // overscroll. Overscroll does not affect the viewport and thus should\n      // be ignored here.\n      return;\n    }\n    this.changed_();\n    this.scrollObservable_.fire();\n  }\n\n  /** @private */\n  resize_() {\n    this.rect_ = null;\n    const newSize = this.getSize();\n    this.changed_();\n    this.resizeObservable_.fire({\n      relayoutAll: false,\n      width: newSize.width,\n      height: newSize.height,\n    });\n  }\n\n  /** @private */\n  updateVisibility_() {\n    const visible = this.ampdoc.isVisible();\n    if (visible != this.visible_) {\n      this.visible_ = visible;\n      if (visible) {\n        this.binding_.connect();\n        // Check the size again in case it has changed between `disconnect` and\n        // `connect`.\n        this.resize_();\n      } else {\n        this.binding_.disconnect();\n      }\n    }\n  }\n}\n\n/**\n * Implementation of ViewportBindingDef that works inside an non-scrollable\n * iframe box by listening to host doc for position and resize updates.\n *\n * @visibleForTesting\n * @implements {ViewportBindingDef}\n */\nexport class ViewportBindingInabox {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!Observable} */\n    this.scrollObservable_ = new Observable();\n\n    /** @private @const {!Observable} */\n    this.resizeObservable_ = new Observable();\n\n    const boxWidth = win./*OK*/ innerWidth;\n    const boxHeight = win./*OK*/ innerHeight;\n\n    /**\n     * The current viewport rect.\n     * Before hearing from host doc, we're blind about the viewport position\n     * and iframe position. 0 scroll is not a bad guess.\n     * Meanwhile, use iframe box size as the viewport size gives a good\n     * initial resource scheduling.\n     * @private {!../layout-rect.LayoutRectDef}\n     */\n    this.viewportRect_ = layoutRectLtwh(0, 0, boxWidth, boxHeight);\n\n    /**\n     * The current layout rect of the iframe box.\n     * TODO(lannka, #7971): The best way to stop visibility from firing\n     * is to move this functionality to the InOb polyfill.\n     * ~To not trigger amp-analytics visibility immediately,\n     * we start with an initial position right below the fold.~\n     * @private {!../layout-rect.LayoutRectDef}\n     */\n    this.boxRect_ = layoutRectLtwh(0, boxHeight + 1, boxWidth, boxHeight);\n\n    /** @private @const {?../../3p/iframe-messaging-client.IframeMessagingClient} */\n    this.iframeClient_ = iframeMessagingClientFor(win);\n\n    /** @private {?Promise<!../layout-rect.LayoutRectDef>} */\n    this.requestPositionPromise_ = null;\n\n    /** @private {function()} */\n    this.fireScrollThrottle_ = throttle(\n      this.win,\n      () => {\n        this.scrollObservable_.fire();\n      },\n      MIN_EVENT_INTERVAL\n    );\n\n    /** @private @const {boolean} */\n    this.isFriendlyIframed_ = canInspectWindow(this.win.top);\n\n    /** @private {?../../ads/inabox/position-observer.PositionObserver} */\n    this.topWindowPositionObserver_ = this.isFriendlyIframed_\n      ? getPositionObserver(this.win.top)\n      : null;\n\n    /** @private {?../../ads/inabox/frame-overlay-manager.FrameOverlayManager} */\n    this.topWindowFrameOverlayManager_ = this.isFriendlyIframed_\n      ? getFrameOverlayManager(this.win.top)\n      : null;\n\n    /** @private {?UnlistenDef} */\n    this.unobserveFunction_ = null;\n\n    dev().fine(TAG, 'initialized inabox viewport');\n  }\n\n  /** @override */\n  connect() {\n    if (this.isFriendlyIframed_) {\n      return this.listenForPositionSameDomain_();\n    } else {\n      return this.listenForPosition_();\n    }\n  }\n\n  /** @private */\n  listenForPosition_() {\n    this.iframeClient_.makeRequest(\n      MessageType.SEND_POSITIONS,\n      MessageType.POSITION,\n      (data) => {\n        dev().fine(TAG, 'Position changed: ', data);\n        this.updateLayoutRects_(data['viewportRect'], data['targetRect']);\n      }\n    );\n    return Promise.resolve();\n  }\n\n  /** @private */\n  listenForPositionSameDomain_() {\n    // Set up listener but only after the resources service is properly\n    // registered (since it's registered after the inabox services so it won't\n    // be available immediately).\n    // TODO(lannka): Investigate why this is the case.\n    return Services.resourcesPromiseForDoc(\n      this.win.document.documentElement\n    ).then(() => {\n      this.unobserveFunction_ =\n        this.unobserveFunction_ ||\n        this.topWindowPositionObserver_.observe(\n          // If the window is the top window (not sitting in an iframe) then\n          // frameElement doesn't exist. In that case we observe the scrolling\n          // element.\n          /** @type {!HTMLIFrameElement|!HTMLElement} */\n          (this.win.frameElement || this.getScrollingElement()),\n          (data) => {\n            this.updateLayoutRects_(data['viewportRect'], data['targetRect']);\n          }\n        );\n    });\n  }\n\n  /**\n   * @private\n   * @param {!../layout-rect.LayoutRectDef} viewportRect\n   * @param {!../layout-rect.LayoutRectDef} targetRect\n   */\n  updateLayoutRects_(viewportRect, targetRect) {\n    const oldViewportRect = this.viewportRect_;\n    this.viewportRect_ = viewportRect;\n    this.updateBoxRect_(targetRect);\n    if (isResized(this.viewportRect_, oldViewportRect)) {\n      this.resizeObservable_.fire();\n    }\n    if (isMoved(this.viewportRect_, oldViewportRect)) {\n      this.fireScrollThrottle_();\n    }\n  }\n\n  /** @override */\n  getLayoutRect(el) {\n    const b = el./*OK*/ getBoundingClientRect();\n    const {left, top} = b;\n    return layoutRectLtwh(\n      Math.round(left + this.boxRect_.left),\n      Math.round(top + this.boxRect_.top),\n      Math.round(b.width),\n      Math.round(b.height)\n    );\n  }\n\n  /** @override */\n  onScroll(callback) {\n    this.scrollObservable_.add(callback);\n  }\n\n  /** @override */\n  onResize(callback) {\n    this.resizeObservable_.add(callback);\n  }\n\n  /** @override */\n  getSize() {\n    return {\n      width: this.viewportRect_.width,\n      height: this.viewportRect_.height,\n    };\n  }\n\n  /** @override */\n  getScrollTop() {\n    return this.viewportRect_.top;\n  }\n\n  /** @override */\n  getScrollLeft() {\n    return this.viewportRect_.left;\n  }\n\n  /** @override */\n  getScrollingElement() {\n    return this.getBodyElement();\n  }\n\n  /** @override */\n  getScrollingElementScrollsLikeViewport() {\n    return true;\n  }\n\n  /** @override */\n  supportsPositionFixed() {\n    return false;\n  }\n\n  /**\n   * @param {?../layout-rect.LayoutRectDef|undefined} positionRect\n   * @private\n   */\n  updateBoxRect_(positionRect) {\n    if (!positionRect) {\n      return;\n    }\n\n    const boxRect = moveLayoutRect(\n      positionRect,\n      this.viewportRect_.left,\n      this.viewportRect_.top\n    );\n\n    if (isChanged(boxRect, this.boxRect_)) {\n      dev().fine(TAG, 'Updating viewport box rect: ', boxRect);\n\n      this.boxRect_ = boxRect;\n      // Remeasure all AMP elements once iframe position or size are changed.\n      // Because all layout boxes are calculated relatively to the\n      // iframe position.\n      this.remeasureAllElements_();\n      // TODO: fire DOM mutation event once we handle them\n    }\n  }\n\n  /**\n   * @return {!Array<!../service/resource.Resource>}\n   * @visibleForTesting\n   */\n  getChildResources() {\n    return Services.resourcesForDoc(this.win.document.documentElement).get();\n  }\n\n  /** @private */\n  remeasureAllElements_() {\n    this.getChildResources().forEach((resource) => resource.measure());\n  }\n\n  /** @override */\n  updateLightboxMode(lightboxMode) {\n    if (lightboxMode) {\n      return this.tryToEnterOverlayMode_();\n    }\n    return this.leaveOverlayMode_();\n  }\n\n  /** @override */\n  getRootClientRectAsync() {\n    if (this.isFriendlyIframed_) {\n      // Set up the listener if we haven't already.\n      return this.listenForPositionSameDomain_().then(() =>\n        this.topWindowPositionObserver_.getTargetRect(\n          /** @type {!HTMLIFrameElement|!HTMLElement} */\n          (this.win.frameElement || this.getScrollingElement())\n        )\n      );\n    }\n    if (!this.requestPositionPromise_) {\n      this.requestPositionPromise_ = new Promise((resolve) => {\n        this.iframeClient_.requestOnce(\n          MessageType.SEND_POSITIONS,\n          MessageType.POSITION,\n          (data) => {\n            this.requestPositionPromise_ = null;\n            devAssert(data['targetRect'], 'Host should send targetRect');\n            resolve(data['targetRect']);\n          }\n        );\n      });\n    }\n    return this.requestPositionPromise_;\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  tryToEnterOverlayMode_() {\n    return this.prepareBodyForOverlay_().then(() =>\n      this.requestFullOverlayFrame_()\n    );\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  leaveOverlayMode_() {\n    return this.requestCancelFullOverlayFrame_().then(() =>\n      this.resetBodyForOverlay_()\n    );\n  }\n\n  /**\n   * Prepares the \"fixed\" container before expanding frame.\n   * @return {!Promise}\n   * @private\n   */\n  prepareBodyForOverlay_() {\n    return prepareBodyForOverlay(this.win, this.getBodyElement());\n  }\n\n  /**\n   * Resets the \"fixed\" container to its original position after collapse.\n   * @return {!Promise}\n   * @private\n   */\n  resetBodyForOverlay_() {\n    return resetBodyForOverlay(this.win, this.getBodyElement());\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  requestFullOverlayFrame_() {\n    return new Promise((resolve, reject) => {\n      if (this.isFriendlyIframed_) {\n        const iframe = /** @type {?HTMLIFrameElement}*/ (this.win.frameElement);\n        if (iframe) {\n          this.topWindowFrameOverlayManager_.expandFrame(iframe, (boxRect) => {\n            this.updateBoxRect_(boxRect);\n            resolve();\n          });\n        } else {\n          reject('Request to open lightbox failed; frame does not exist.');\n        }\n      } else {\n        this.iframeClient_.requestOnce(\n          MessageType.FULL_OVERLAY_FRAME,\n          MessageType.FULL_OVERLAY_FRAME_RESPONSE,\n          (response) => {\n            if (response['success']) {\n              this.updateBoxRect_(response['boxRect']);\n              resolve();\n            } else {\n              reject('Request to open lightbox rejected by host document');\n            }\n          }\n        );\n      }\n    });\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  requestCancelFullOverlayFrame_() {\n    return new Promise((resolve, reject) => {\n      if (this.isFriendlyIframed_) {\n        const iframe = /** @type {?HTMLIFrameElement}*/ (this.win.frameElement);\n        if (iframe) {\n          this.topWindowFrameOverlayManager_.collapseFrame(\n            iframe,\n            (boxRect) => {\n              this.updateBoxRect_(boxRect);\n              resolve();\n            }\n          );\n        } else {\n          reject('Request to open lightbox failed; frame does not exist.');\n        }\n      } else {\n        this.iframeClient_.requestOnce(\n          MessageType.CANCEL_FULL_OVERLAY_FRAME,\n          MessageType.CANCEL_FULL_OVERLAY_FRAME_RESPONSE,\n          (response) => {\n            this.updateBoxRect_(response['boxRect']);\n            resolve();\n          }\n        );\n      }\n    });\n  }\n\n  /** @visibleForTesting */\n  getBodyElement() {\n    return devAssertElement(this.win.document.body);\n  }\n\n  /** @override */\n  disconnect() {\n    if (this.unobserveFunction_) {\n      this.unobserveFunction_();\n      this.unobserveFunction_ = null;\n    }\n  }\n\n  /** @override */\n  getScrollWidth() {\n    // Get actual width of document body, regardless of iframe size.\n    return this.getScrollingElement()./*OK*/ offsetWidth;\n  }\n\n  /** @override */\n  getScrollHeight() {\n    // Get actual height of document body, regardless of iframe size.\n    return this.getScrollingElement()./*OK*/ offsetHeight;\n  }\n\n  /** @override */\n  getContentHeight() {\n    return this.getScrollHeight();\n  }\n\n  /** @override */ updatePaddingTop() {\n    /* no-op */\n  }\n  /** @override */ hideViewerHeader() {\n    /* no-op */\n  }\n  /** @override */ showViewerHeader() {\n    /* no-op */\n  }\n  /** @override */ disableScroll() {\n    /* no-op */\n  }\n  /** @override */ resetScroll() {\n    /* no-op */\n  }\n  /** @override */ ensureReadyForElements() {\n    /* no-op */\n  }\n  /** @override */ setScrollTop() {\n    /* no-op */\n  }\n  /** @override */ contentHeightChanged() {}\n  /** @override */ getBorderTop() {\n    return 0;\n  }\n  /** @override */ requiresFixedLayerTransfer() {\n    return false;\n  }\n  /** @override */ overrideGlobalScrollTo() {\n    return false;\n  }\n}\n\n/**\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installInaboxViewportService(ampdoc) {\n  const binding = new ViewportBindingInabox(ampdoc.win);\n  registerServiceBuilderForDoc(\n    ampdoc,\n    'viewport',\n    function () {\n      return new InaboxViewportImpl(ampdoc, binding);\n    },\n    /* opt_instantiate */ true\n  );\n}\n\n/**\n * @param {!../layout-rect.LayoutRectDef} newRect\n * @param {!../layout-rect.LayoutRectDef} oldRect\n * @return {boolean}\n */\nfunction isChanged(newRect, oldRect) {\n  return isMoved(newRect, oldRect) || isResized(newRect, oldRect);\n}\n\n/**\n * @param {!../layout-rect.LayoutRectDef} newRect\n * @param {!../layout-rect.LayoutRectDef} oldRect\n * @return {boolean}\n */\nfunction isMoved(newRect, oldRect) {\n  return newRect.left != oldRect.left || newRect.top != oldRect.top;\n}\n\n/**\n * @param {!../layout-rect.LayoutRectDef} newRect\n * @param {!../layout-rect.LayoutRectDef} oldRect\n * @return {boolean}\n */\nfunction isResized(newRect, oldRect) {\n  return newRect.width != oldRect.width || newRect.height != oldRect.height;\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {installActionServiceForDoc} from '../service/action-impl';\nimport {installDocumentInfoServiceForDoc} from '../service/document-info-impl';\nimport {installGlobalNavigationHandlerForDoc} from '../service/navigation';\nimport {installGlobalSubmitListenerForDoc} from '../document-submit';\nimport {installHiddenObserverForDoc} from '../service/hidden-observer-impl';\nimport {installHistoryServiceForDoc} from '../service/history-impl';\nimport {installIframeMessagingClient} from './inabox-iframe-messaging-client';\nimport {installInaboxCidService} from './inabox-cid';\nimport {installInaboxMutatorServiceForDoc} from './inabox-mutator';\nimport {installInaboxResourcesServiceForDoc} from './inabox-resources';\nimport {installInaboxViewerServiceForDoc} from './inabox-viewer';\nimport {installInaboxViewportService} from './inabox-viewport';\nimport {installOwnersServiceForDoc} from '../service/owners-impl';\nimport {installStandardActionsForDoc} from '../service/standard-actions-impl';\nimport {installTemplatesServiceForDoc} from '../service/template-impl';\nimport {installUrlForDoc} from '../service/url-impl';\nimport {installUrlReplacementsServiceForDoc} from '../service/url-replacements-impl';\nimport {rejectServicePromiseForDoc} from '../service';\n\n/**\n * Install ampdoc-level services.\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installAmpdocServicesForInabox(ampdoc) {\n  // Order is important!\n  installIframeMessagingClient(ampdoc.win); // this is an inabox-only service\n  installUrlForDoc(ampdoc);\n  installTemplatesServiceForDoc(ampdoc);\n  installDocumentInfoServiceForDoc(ampdoc);\n  installInaboxCidService(ampdoc);\n  installInaboxViewerServiceForDoc(ampdoc);\n  installInaboxViewportService(ampdoc);\n  installHiddenObserverForDoc(ampdoc);\n  installHistoryServiceForDoc(ampdoc);\n  installInaboxResourcesServiceForDoc(ampdoc);\n  installOwnersServiceForDoc(ampdoc);\n  installInaboxMutatorServiceForDoc(ampdoc);\n  installUrlReplacementsServiceForDoc(ampdoc);\n  installActionServiceForDoc(ampdoc);\n  installStandardActionsForDoc(ampdoc);\n  // For security, Storage is not installed in inabox.\n  unsupportedService(ampdoc, 'storage');\n  installGlobalNavigationHandlerForDoc(ampdoc);\n  installGlobalSubmitListenerForDoc(ampdoc);\n}\n\n/**\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} name\n */\nfunction unsupportedService(ampdoc, name) {\n  rejectServicePromiseForDoc(\n    ampdoc,\n    name,\n    new Error('Un-supported service: ' + name)\n  );\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../core/data-structures/promise';\nimport {Observable} from '../core/data-structures/observable';\nimport {Signals} from '../core/data-structures/signals';\nimport {VisibilityState} from '../core/constants/visibility-state';\nimport {WindowInterface} from '../core/window/interface';\nimport {\n  addDocumentVisibilityChangeListener,\n  getDocumentVisibilityState,\n  removeDocumentVisibilityChangeListener,\n} from '../utils/document-visibility';\nimport {dev, devAssert} from '../log';\nimport {\n  disposeServicesForDoc,\n  getParentWindowFrameElement,\n  registerServiceBuilder,\n} from '../service';\nimport {isDocumentReady, whenDocumentReady} from '../core/document-ready';\nimport {isEnumValue} from '../core/types';\nimport {iterateCursor, rootNodeFor, waitForBodyOpenPromise} from '../dom';\nimport {map} from '../core/types/object';\nimport {parseQueryString} from '../core/types/string/url';\n\n/** @const {string} */\nconst AMPDOC_PROP = '__AMPDOC';\n\n/** @const {string} */\nconst PARAMS_SENTINEL = '__AMP__';\n\n/**\n * @typedef {{\n *   params: (!Object<string, string>|undefined),\n *   signals: (?Signals|undefined),\n *   visibilityState: (?VisibilityState|undefined),\n * }}\n */\nexport let AmpDocOptions;\n\n/**\n * Private ampdoc signals.\n * @enum {string}\n */\nconst AmpDocSignals = {\n  // A complete preinstalled list of extensions is known.\n  EXTENSIONS_KNOWN: '-ampdoc-ext-known',\n  // Signals the document has become visible for the first time.\n  FIRST_VISIBLE: '-ampdoc-first-visible',\n  // Signals when the document becomes visible the next time.\n  NEXT_VISIBLE: '-ampdoc-next-visible',\n};\n\n/**\n * This service helps locate an ampdoc (`AmpDoc` instance) for any node,\n * either in the single-doc or shadow-doc environments.\n *\n * In the single-doc environment an ampdoc is equivalent to the\n * `window.document`. In the shadow-doc mode, any number of AMP documents\n * could be hosted in shadow roots in the same global `window.document`.\n *\n * @package\n */\nexport class AmpDocService {\n  /**\n   * @param {!Window} win\n   * @param {boolean} isSingleDoc\n   * @param {!Object<string, string>=} opt_initParams\n   */\n  constructor(win, isSingleDoc, opt_initParams) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private {?AmpDoc} */\n    this.singleDoc_ = null;\n    if (isSingleDoc) {\n      this.singleDoc_ = new AmpDocSingle(win, {\n        params: extractSingleDocParams(win, opt_initParams),\n      });\n      win.document[AMPDOC_PROP] = this.singleDoc_;\n    }\n  }\n\n  /**\n   * Whether the runtime in the single-doc mode. Alternative is the shadow-doc\n   * mode that supports multiple documents per a single window.\n   * @return {boolean}\n   */\n  isSingleDoc() {\n    // TODO(#22733): remove when ampdoc-fie is launched.\n    return !!this.singleDoc_;\n  }\n\n  /**\n   * Returns the document in the single-doc mode. In a multi-doc mode, an\n   * error will be thrown.\n   * @return {!AmpDoc}\n   */\n  getSingleDoc() {\n    // TODO(#22733): once docroot migration is done, this should be renamed\n    // to `getTopDoc()` method.\n    return devAssert(this.singleDoc_);\n  }\n\n  /**\n   * If the node is an AMP custom element, retrieves the AmpDoc reference.\n   * @param {!Node} node\n   * @return {?AmpDoc} The AmpDoc reference, if one exists.\n   */\n  getCustomElementAmpDocReference_(node) {\n    // We can only look up the AmpDoc from a custom element if it has been\n    // attached at some point. If it is not a custom element, one or both of\n    // these checks should fail.\n    if (!node.everAttached || typeof node.getAmpDoc !== 'function') {\n      return null;\n    }\n\n    return node.getAmpDoc();\n  }\n\n  /**\n   * Returns the instance of the ampdoc (`AmpDoc`) that contains the specified\n   * node.\n   *\n   * @param {!Node} node\n   * @return {?AmpDoc}\n   */\n  getAmpDocIfAvailable(node) {\n    let n = node;\n    while (n) {\n      // A custom element may already have the reference. If we are looking\n      // for the closest AmpDoc, the element might have a reference to the\n      // global AmpDoc, which we do not want. This occurs when using\n      // <amp-next-page>.\n\n      const cachedAmpDoc = this.getCustomElementAmpDocReference_(node);\n      if (cachedAmpDoc) {\n        return cachedAmpDoc;\n      }\n\n      // Root note: it's either a document, or a shadow document.\n      const rootNode = rootNodeFor(n);\n      if (!rootNode) {\n        break;\n      }\n      const ampdoc = rootNode[AMPDOC_PROP];\n      if (ampdoc) {\n        return ampdoc;\n      }\n\n      // Try to iterate to the host of the current root node.\n      // First try the shadow root's host.\n      if (rootNode.host) {\n        n = rootNode.host;\n      } else {\n        // Then, traverse the boundary of a friendly iframe.\n        n = getParentWindowFrameElement(rootNode, this.win);\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Returns the instance of the ampdoc (`AmpDoc`) that contains the specified\n   * node. If the runtime is in the single-doc mode, the one global `AmpDoc`\n   * instance is returned, unless specfically looking for a closer `AmpDoc`.\n   * Otherwise, this method locates the `AmpDoc` that contains the specified\n   * node and, if necessary, initializes it.\n   *\n   * An Error is thrown in development if no `AmpDoc` is found.\n   * @param {!Node} node\n   * @return {!AmpDoc}\n   */\n  getAmpDoc(node) {\n    const ampdoc = this.getAmpDocIfAvailable(node);\n    if (!ampdoc) {\n      throw dev().createError('No ampdoc found for', node);\n    }\n    return ampdoc;\n  }\n\n  /**\n   * Creates and installs the ampdoc for the shadow root.\n   * @param {string} url\n   * @param {!ShadowRoot} shadowRoot\n   * @param {!AmpDocOptions=} opt_options\n   * @return {!AmpDocShadow}\n   * @restricted\n   */\n  installShadowDoc(url, shadowRoot, opt_options) {\n    devAssert(\n      !shadowRoot[AMPDOC_PROP],\n      'The shadow root already contains ampdoc'\n    );\n    const ampdoc = new AmpDocShadow(this.win, url, shadowRoot, opt_options);\n    shadowRoot[AMPDOC_PROP] = ampdoc;\n    return ampdoc;\n  }\n\n  /**\n   * Creates and installs the ampdoc for the fie root.\n   * @param {string} url\n   * @param {!Window} childWin\n   * @param {!AmpDocOptions=} opt_options\n   * @return {!AmpDocFie}\n   * @restricted\n   */\n  installFieDoc(url, childWin, opt_options) {\n    const doc = childWin.document;\n    devAssert(!doc[AMPDOC_PROP], 'The fie already contains ampdoc');\n    const frameElement = devAssert(childWin.frameElement);\n    const ampdoc = new AmpDocFie(\n      childWin,\n      url,\n      this.getAmpDoc(frameElement),\n      opt_options\n    );\n    doc[AMPDOC_PROP] = ampdoc;\n    return ampdoc;\n  }\n}\n\n/**\n * This class represents a single ampdoc. `AmpDocService` can contain only one\n * global ampdoc or multiple, depending on the runtime mode: single-doc or\n * shadow-doc.\n * @abstract\n * @package\n */\nexport class AmpDoc {\n  /**\n   * @param {!Window} win\n   * @param {?AmpDoc} parent\n   * @param {!AmpDocOptions=} opt_options\n   */\n  constructor(win, parent, opt_options) {\n    /** @public @const {!Window} */\n    this.win = win;\n\n    /** @private {!Object<../enums.AMPDOC_SINGLETON_NAME, boolean>} */\n    this.registeredSingleton_ = map();\n\n    /** @public @const {?AmpDoc} */\n    this.parent_ = parent;\n\n    /** @private @const */\n    this.signals_ = (opt_options && opt_options.signals) || new Signals();\n\n    /** @private {!Object<string, string>} */\n    this.params_ = (opt_options && opt_options.params) || map();\n\n    /** @protected {?Object<string, string>} */\n    this.meta_ = null;\n\n    /** @private @const {!Object<string, string>} */\n    this.declaredExtensions_ = {};\n\n    const paramsVisibilityState = this.params_['visibilityState'];\n    devAssert(\n      !paramsVisibilityState ||\n        isEnumValue(VisibilityState, paramsVisibilityState)\n    );\n\n    /** @private {?VisibilityState} */\n    this.visibilityStateOverride_ =\n      (opt_options && opt_options.visibilityState) ||\n      paramsVisibilityState ||\n      null;\n\n    // Start with `null` to be updated by updateVisibilityState_ in the end\n    // of the constructor to ensure the correct \"update\" logic and promise\n    // resolution.\n    /** @private {?VisibilityState} */\n    this.visibilityState_ = null;\n\n    /** @private @const {!Observable<!VisibilityState>} */\n    this.visibilityStateHandlers_ = new Observable();\n\n    /** @private {?time} */\n    this.lastVisibleTime_ = null;\n\n    /** @private @const {!Array<!UnlistenDef>} */\n    this.unsubsribes_ = [];\n\n    const boundUpdateVisibilityState = this.updateVisibilityState_.bind(this);\n    if (this.parent_) {\n      this.unsubsribes_.push(\n        this.parent_.onVisibilityChanged(boundUpdateVisibilityState)\n      );\n    }\n    addDocumentVisibilityChangeListener(\n      this.win.document,\n      boundUpdateVisibilityState\n    );\n    this.unsubsribes_.push(() =>\n      removeDocumentVisibilityChangeListener(\n        this.win.document,\n        boundUpdateVisibilityState\n      )\n    );\n    this.updateVisibilityState_();\n  }\n\n  /**\n   * Dispose the document.\n   */\n  dispose() {\n    disposeServicesForDoc(this);\n    this.unsubsribes_.forEach((unsubsribe) => unsubsribe());\n  }\n\n  /**\n   * Whether the runtime in the single-doc mode. Alternative is the shadow-doc\n   * mode that supports multiple documents per a single window.\n   * @return {boolean}\n   */\n  isSingleDoc() {\n    // TODO(#22733): remove when ampdoc-fie is launched.\n    return /** @type {?} */ (devAssert(null, 'not implemented'));\n  }\n\n  /**\n   * @return {?AmpDoc}\n   */\n  getParent() {\n    return this.parent_;\n  }\n\n  /**\n   * DO NOT CALL. Retained for backward compat during rollout.\n   * @return {!Window}\n   * @deprecated Use `ampdoc.win` instead.\n   */\n  getWin() {\n    return this.win;\n  }\n\n  /** @return {!Signals} */\n  signals() {\n    return this.signals_;\n  }\n\n  /**\n   * Returns the value of a ampdoc's startup parameter with the specified\n   * name or `null` if the parameter wasn't defined at startup time.\n   * @param {string} name\n   * @return {?string}\n   */\n  getParam(name) {\n    const v = this.params_[name];\n    return v == null ? null : v;\n  }\n\n  /**\n   * Initializes (if necessary) cached map of an ampdoc's meta name values to\n   * their associated content values and returns the map.\n   * @return {!Object<string, string>}\n   */\n  getMeta() {\n    if (this.meta_) {\n      return map(this.meta_);\n    }\n\n    this.meta_ = map();\n    const metaEls = dev()\n      .assertElement(this.win.document.head)\n      .querySelectorAll('meta[name]');\n    iterateCursor(metaEls, (metaEl) => {\n      const name = metaEl.getAttribute('name');\n      const content = metaEl.getAttribute('content');\n      if (!name || content === null) {\n        return;\n      }\n\n      // Retain only the first meta content value for a given name\n      if (this.meta_[name] === undefined) {\n        this.meta_[name] = content;\n      }\n    });\n    return map(this.meta_);\n  }\n\n  /**\n   * Returns the value of an ampdoc's meta tag content for a given name, or\n   * `null` if the meta tag does not exist.\n   * @param {string} name\n   * @return {?string}\n   */\n  getMetaByName(name) {\n    if (!name) {\n      return null;\n    }\n\n    const content = this.getMeta()[name];\n    return content !== undefined ? content : null;\n  }\n\n  /**\n   * Stores the value of an ampdoc's meta tag content for a given name. To be\n   * implemented by subclasses.\n   * @param {string} unusedName\n   * @param {string} unusedContent\n   *\n   * Avoid using this method in components. It is only meant to be used by the\n   * runtime for AmpDoc subclasses where <meta> elements do not exist and name/\n   * content pairs must be stored in this.meta_.\n   */\n  setMetaByName(unusedName, unusedContent) {\n    devAssert(null, 'not implemented');\n  }\n\n  /**\n   * Returns whether the specified extension has been declared on this ampdoc.\n   * @param {string} extensionId\n   * @param {string=} opt_version\n   * @return {boolean}\n   */\n  declaresExtension(extensionId, opt_version) {\n    const declared = this.declaredExtensions_[extensionId];\n    if (!declared) {\n      return false;\n    }\n    return !opt_version || declared === opt_version;\n  }\n\n  /**\n   * Adds a declared extension to an ampdoc.\n   * @param {string} extensionId\n   * @param {string} version\n   * @restricted\n   */\n  declareExtension(extensionId, version) {\n    devAssert(\n      !this.declaredExtensions_[extensionId] ||\n        this.declaredExtensions_[extensionId] === version,\n      'extension already declared %s',\n      extensionId\n    );\n    this.declaredExtensions_[extensionId] = version;\n  }\n\n  /**\n   * @param {string} extensionId\n   * @return {?string}\n   */\n  getExtensionVersion(extensionId) {\n    return this.declaredExtensions_[extensionId] || null;\n  }\n\n  /**\n   * Signal that the initial document set of extensions is known.\n   * @restricted\n   */\n  setExtensionsKnown() {\n    this.signals_.signal(AmpDocSignals.EXTENSIONS_KNOWN);\n  }\n\n  /**\n   * Resolved when the initial document set of extension is known.\n   * @return {!Promise}\n   */\n  whenExtensionsKnown() {\n    return this.signals_.whenSignal(AmpDocSignals.EXTENSIONS_KNOWN);\n  }\n\n  /**\n   * Returns the root node for this ampdoc. It will either be a `Document` for\n   * the single-doc runtime mode, or a `ShadowRoot` for shadow-doc mode. This\n   * node can be used, among other things, to add ampdoc-wide event listeners.\n   *\n   * @return {!Document|!ShadowRoot}\n   */\n  getRootNode() {\n    return /** @type {?} */ (devAssert(null, 'not implemented'));\n  }\n\n  /**\n   * Returns the head node. It's either an element or a shadow root.\n   * @return {!Element|!ShadowRoot}\n   * @abstract\n   */\n  getHeadNode() {}\n\n  /**\n   * Returns `true` if the ampdoc's body is available.\n   *\n   * @return {boolean}\n   */\n  isBodyAvailable() {\n    return /** @type {?} */ (devAssert(false, 'not implemented'));\n  }\n\n  /**\n   * Returns the ampdoc's body. Requires the body to already be available.\n   *\n   * See `isBodyAvailable` and `waitForBodyOpen`.\n   *\n   * @return {!Element}\n   */\n  getBody() {\n    return /** @type {?} */ (devAssert(null, 'not implemented'));\n  }\n\n  /**\n   * Returns a promise that will be resolved when the ampdoc's body is\n   * available.\n   * @return {!Promise<!Element>}\n   */\n  waitForBodyOpen() {\n    return /** @type {?} */ (devAssert(null, 'not implemented'));\n  }\n\n  /**\n   * Returns `true` if document is ready.\n   *\n   * See `whenReady`.\n   *\n   * @return {boolean}\n   */\n  isReady() {\n    return /** @type {?} */ (devAssert(null, 'not implemented'));\n  }\n\n  /**\n   * Returns a promise that will be resolved when the ampdoc's DOM is fully\n   * ready.\n   * @return {!Promise}\n   */\n  whenReady() {\n    return /** @type {?} */ (devAssert(null, 'not implemented'));\n  }\n\n  /**\n   * Returns the URL from which the document was loaded.\n   * @return {string}\n   */\n  getUrl() {\n    return /** @type {?} */ (devAssert(null, 'not implemented'));\n  }\n\n  /**\n   * Locates an element with the specified ID within the ampdoc. In the\n   * shadow-doc mode, when multiple documents could be present, this method\n   * localizes search only to the DOM subtree specific to this ampdoc.\n   *\n   * @param {string} id\n   * @return {?Element}\n   */\n  getElementById(id) {\n    return this.getRootNode().getElementById(id);\n  }\n\n  /**\n   * Whether the node is currently contained in the DOM of the root.\n   * @param {?Node} node\n   * @return {boolean}\n   */\n  contains(node) {\n    return this.getRootNode().contains(node);\n  }\n\n  /**\n   * @param {!VisibilityState} visibilityState\n   * @restricted\n   */\n  overrideVisibilityState(visibilityState) {\n    if (this.visibilityStateOverride_ != visibilityState) {\n      this.visibilityStateOverride_ = visibilityState;\n      this.updateVisibilityState_();\n    }\n  }\n\n  /** @private */\n  updateVisibilityState_() {\n    // Natural visibility state.\n    const naturalVisibilityState = getDocumentVisibilityState(\n      this.win.document\n    );\n\n    // Parent visibility: pick the first non-visible state.\n    let parentVisibilityState = VisibilityState.VISIBLE;\n    for (let p = this.parent_; p; p = p.getParent()) {\n      if (p.getVisibilityState() != VisibilityState.VISIBLE) {\n        parentVisibilityState = p.getVisibilityState();\n        break;\n      }\n    }\n\n    // Pick the most restricted visibility state.\n    let visibilityState;\n    const visibilityStateOverride =\n      this.visibilityStateOverride_ || VisibilityState.VISIBLE;\n    if (\n      visibilityStateOverride == VisibilityState.VISIBLE &&\n      parentVisibilityState == VisibilityState.VISIBLE &&\n      naturalVisibilityState == VisibilityState.VISIBLE\n    ) {\n      visibilityState = VisibilityState.VISIBLE;\n    } else if (\n      naturalVisibilityState == VisibilityState.HIDDEN &&\n      visibilityStateOverride == VisibilityState.PAUSED\n    ) {\n      // Hidden document state overrides \"paused\".\n      visibilityState = naturalVisibilityState;\n    } else if (\n      visibilityStateOverride == VisibilityState.PAUSED ||\n      visibilityStateOverride == VisibilityState.INACTIVE\n    ) {\n      visibilityState = visibilityStateOverride;\n    } else if (\n      parentVisibilityState == VisibilityState.PAUSED ||\n      parentVisibilityState == VisibilityState.INACTIVE\n    ) {\n      visibilityState = parentVisibilityState;\n    } else if (\n      visibilityStateOverride == VisibilityState.PRERENDER ||\n      naturalVisibilityState == VisibilityState.PRERENDER ||\n      parentVisibilityState == VisibilityState.PRERENDER\n    ) {\n      visibilityState = VisibilityState.PRERENDER;\n    } else {\n      visibilityState = VisibilityState.HIDDEN;\n    }\n\n    if (this.visibilityState_ != visibilityState) {\n      this.visibilityState_ = visibilityState;\n      if (visibilityState == VisibilityState.VISIBLE) {\n        this.lastVisibleTime_ = Date.now();\n        this.signals_.signal(AmpDocSignals.FIRST_VISIBLE);\n        this.signals_.signal(AmpDocSignals.NEXT_VISIBLE);\n      } else {\n        this.signals_.reset(AmpDocSignals.NEXT_VISIBLE);\n      }\n      this.visibilityStateHandlers_.fire();\n    }\n  }\n\n  /**\n   * Returns a Promise that only ever resolved when the current\n   * AMP document first becomes visible.\n   * @return {!Promise}\n   */\n  whenFirstVisible() {\n    return this.signals_\n      .whenSignal(AmpDocSignals.FIRST_VISIBLE)\n      .then(() => undefined);\n  }\n\n  /**\n   * Returns a Promise that resolve when current doc becomes visible.\n   * The promise resolves immediately if doc is already visible.\n   * @return {!Promise}\n   */\n  whenNextVisible() {\n    return this.signals_\n      .whenSignal(AmpDocSignals.NEXT_VISIBLE)\n      .then(() => undefined);\n  }\n\n  /**\n   * Returns the time when the document has become visible for the first time.\n   * If document has not yet become visible, the returned value is `null`.\n   * @return {?time}\n   */\n  getFirstVisibleTime() {\n    return /** @type {?number} */ (\n      this.signals_.get(AmpDocSignals.FIRST_VISIBLE)\n    );\n  }\n\n  /**\n   * Returns the time when the document has become visible for the last time.\n   * If document has not yet become visible, the returned value is `null`.\n   * @return {?time}\n   */\n  getLastVisibleTime() {\n    return this.lastVisibleTime_;\n  }\n\n  /**\n   * Returns visibility state configured by the viewer.\n   * See {@link isVisible}.\n   * @return {!VisibilityState}\n   */\n  getVisibilityState() {\n    return devAssert(this.visibilityState_);\n  }\n\n  /**\n   * Whether the AMP document currently visible. The reasons why it might not\n   * be visible include user switching to another tab, browser running the\n   * document in the prerender mode or viewer running the document in the\n   * prerender mode.\n   * @return {boolean}\n   */\n  isVisible() {\n    return this.visibilityState_ == VisibilityState.VISIBLE;\n  }\n\n  /**\n   * Whether the AMP document has been ever visible before. Since the visiblity\n   * state of a document can be flipped back and forth we sometimes want to know\n   * if a document has ever been visible.\n   * @return {boolean}\n   */\n  hasBeenVisible() {\n    return this.getLastVisibleTime() != null;\n  }\n\n  /**\n   * Adds a \"visibilitychange\" event listener for viewer events. The\n   * callback can check {@link isVisible} and {@link getPrefetchCount}\n   * methods for more info.\n   * @param {function(!VisibilityState)} handler\n   * @return {!UnlistenDef}\n   */\n  onVisibilityChanged(handler) {\n    return this.visibilityStateHandlers_.add(handler);\n  }\n\n  /**\n   * Attempt to register a singleton for each ampdoc.\n   * Caller need to handle user error when registration returns false.\n   * @param {!../enums.AMPDOC_SINGLETON_NAME} name\n   * @return {boolean}\n   */\n  registerSingleton(name) {\n    if (!this.registeredSingleton_[name]) {\n      this.registeredSingleton_[name] = true;\n      return true;\n    }\n    return false;\n  }\n}\n\n/**\n * The version of `AmpDoc` in the single-doc mode that corresponds to the\n * global `window.document`.\n * @package @visibleForTesting\n */\nexport class AmpDocSingle extends AmpDoc {\n  /**\n   * @param {!Window} win\n   * @param {!AmpDocOptions=} opt_options\n   */\n  constructor(win, opt_options) {\n    super(win, /* parent */ null, opt_options);\n\n    /** @private @const {!Promise<!Element>} */\n    this.bodyPromise_ = this.win.document.body\n      ? Promise.resolve(this.win.document.body)\n      : waitForBodyOpenPromise(this.win.document).then(() => this.getBody());\n\n    /** @private @const {!Promise} */\n    this.readyPromise_ = whenDocumentReady(this.win.document);\n  }\n\n  /** @override */\n  isSingleDoc() {\n    return true;\n  }\n\n  /** @override */\n  getRootNode() {\n    return this.win.document;\n  }\n\n  /** @override */\n  getUrl() {\n    return WindowInterface.getLocation(this.win).href;\n  }\n\n  /** @override */\n  getHeadNode() {\n    return dev().assertElement(this.win.document.head);\n  }\n\n  /** @override */\n  isBodyAvailable() {\n    return !!this.win.document.body;\n  }\n\n  /** @override */\n  getBody() {\n    return dev().assertElement(this.win.document.body, 'body not available');\n  }\n\n  /** @override */\n  waitForBodyOpen() {\n    return this.bodyPromise_;\n  }\n\n  /** @override */\n  isReady() {\n    return isDocumentReady(this.win.document);\n  }\n\n  /** @override */\n  whenReady() {\n    return this.readyPromise_;\n  }\n}\n\n/**\n * The version of `AmpDoc` in the shadow-doc mode that is allocated for each\n * ampdoc hosted within a shadow root.\n * @package @visibleForTesting\n */\nexport class AmpDocShadow extends AmpDoc {\n  /**\n   * @param {!Window} win\n   * @param {string} url\n   * @param {!ShadowRoot} shadowRoot\n   * @param {!AmpDocOptions=} opt_options\n   */\n  constructor(win, url, shadowRoot, opt_options) {\n    super(win, /* parent */ null, opt_options);\n    /** @private @const {string} */\n    this.url_ = url;\n    /** @private @const {!ShadowRoot} */\n    this.shadowRoot_ = shadowRoot;\n\n    /** @private {?Element} */\n    this.body_ = null;\n\n    const bodyDeferred = new Deferred();\n\n    /** @private {!Promise<!Element>} */\n    this.bodyPromise_ = bodyDeferred.promise;\n\n    /** @private {function(!Element)|undefined} */\n    this.bodyResolver_ = bodyDeferred.resolve;\n\n    /** @private {boolean} */\n    this.ready_ = false;\n\n    const readyDeferred = new Deferred();\n\n    /** @private {!Promise} */\n    this.readyPromise_ = readyDeferred.promise;\n\n    /** @private {function()|undefined} */\n    this.readyResolver_ = readyDeferred.resolve;\n  }\n\n  /** @override */\n  isSingleDoc() {\n    return false;\n  }\n\n  /** @override */\n  getRootNode() {\n    return this.shadowRoot_;\n  }\n\n  /** @override */\n  getUrl() {\n    return this.url_;\n  }\n\n  /** @override */\n  getHeadNode() {\n    return this.shadowRoot_;\n  }\n\n  /** @override */\n  isBodyAvailable() {\n    return !!this.body_;\n  }\n\n  /** @override */\n  getBody() {\n    return dev().assertElement(this.body_, 'body not available');\n  }\n\n  /**\n   * Signals that the shadow doc has a body.\n   * @param {!Element} body\n   * @restricted\n   */\n  setBody(body) {\n    devAssert(!this.body_, 'Duplicate body');\n    this.body_ = body;\n    this.bodyResolver_(body);\n    this.bodyResolver_ = undefined;\n  }\n\n  /** @override */\n  waitForBodyOpen() {\n    return this.bodyPromise_;\n  }\n\n  /** @override */\n  isReady() {\n    return this.ready_;\n  }\n\n  /**\n   * Signals that the shadow doc is ready.\n   * @restricted\n   */\n  setReady() {\n    devAssert(!this.ready_, 'Duplicate ready state');\n    this.ready_ = true;\n    this.readyResolver_();\n    this.readyResolver_ = undefined;\n  }\n\n  /** @override */\n  whenReady() {\n    return this.readyPromise_;\n  }\n\n  /** @override */\n  getMeta() {\n    return /** @type {!Object<string,string>} */ (map(this.meta_));\n  }\n\n  /** @override */\n  setMetaByName(name, content) {\n    devAssert(name, 'Attempted to store invalid meta name/content pair');\n    if (!this.meta_) {\n      this.meta_ = map();\n    }\n    this.meta_[name] = content;\n  }\n}\n\n/**\n * The version of `AmpDoc` for FIE embeds.\n * @package @visibleForTesting\n */\nexport class AmpDocFie extends AmpDoc {\n  /**\n   * @param {!Window} win\n   * @param {string} url\n   * @param {!AmpDoc} parent\n   * @param {!AmpDocOptions=} opt_options\n   */\n  constructor(win, url, parent, opt_options) {\n    super(win, parent, opt_options);\n\n    /** @private @const {string} */\n    this.url_ = url;\n\n    /** @private @const {!Promise<!Element>} */\n    this.bodyPromise_ = this.win.document.body\n      ? Promise.resolve(this.win.document.body)\n      : waitForBodyOpenPromise(this.win.document).then(() => this.getBody());\n\n    /** @private {boolean} */\n    this.ready_ = false;\n\n    const readyDeferred = new Deferred();\n    /** @private {!Promise} */\n    this.readyPromise_ = readyDeferred.promise;\n    /** @private {function()|undefined} */\n    this.readyResolver_ = readyDeferred.resolve;\n  }\n\n  /** @override */\n  isSingleDoc() {\n    return false;\n  }\n\n  /** @override */\n  getRootNode() {\n    return this.win.document;\n  }\n\n  /** @override */\n  getUrl() {\n    return this.url_;\n  }\n\n  /** @override */\n  getHeadNode() {\n    return dev().assertElement(this.win.document.head);\n  }\n\n  /** @override */\n  isBodyAvailable() {\n    return !!this.win.document.body;\n  }\n\n  /** @override */\n  getBody() {\n    return dev().assertElement(this.win.document.body, 'body not available');\n  }\n\n  /** @override */\n  waitForBodyOpen() {\n    return this.bodyPromise_;\n  }\n\n  /** @override */\n  isReady() {\n    return this.ready_;\n  }\n\n  /** @override */\n  whenReady() {\n    return this.readyPromise_;\n  }\n\n  /**\n   * Signals that the FIE doc is ready.\n   * @restricted\n   */\n  setReady() {\n    devAssert(!this.ready_, 'Duplicate ready state');\n    this.ready_ = true;\n    this.readyResolver_();\n    this.readyResolver_ = undefined;\n  }\n}\n\n/**\n * @param {!Window} win\n * @param {!Object<string, string>|undefined} initParams\n * @return {!Object<string, string>}\n */\nfunction extractSingleDocParams(win, initParams) {\n  const params = map();\n  if (initParams) {\n    // The initialization params take the highest precedence.\n    Object.assign(params, initParams);\n  } else {\n    // Params can be passed via iframe hash/name with hash taking precedence.\n    if (win.name && win.name.indexOf(PARAMS_SENTINEL) == 0) {\n      Object.assign(\n        params,\n        parseQueryString(win.name.substring(PARAMS_SENTINEL.length))\n      );\n    }\n    if (win.location && win.location.hash) {\n      Object.assign(params, parseQueryString(win.location.hash));\n    }\n  }\n  return params;\n}\n\n/**\n * Install the ampdoc service and immediately configure it for either a\n * single-doc or a shadow-doc mode. The mode cannot be changed after the\n * initial configuration.\n * @param {!Window} win\n * @param {boolean} isSingleDoc\n * @param {!Object<string, string>=} opt_initParams\n */\nexport function installDocService(win, isSingleDoc, opt_initParams) {\n  registerServiceBuilder(win, 'ampdoc', function () {\n    return new AmpDocService(win, isSingleDoc, opt_initParams);\n  });\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {closestAncestorElementBySelector} from '../core/dom/query';\nimport {waitForChildPromise} from '../dom';\n\n/**\n * Checks if an element descends from `amp-story` in order to configure\n * story-specific behavior.\n *\n * This utility has a tree-scanning cost.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function descendsFromStory(element) {\n  return !!closestAncestorElementBySelector(element, 'amp-story');\n}\n\n/**\n * Returns true if the document is an amp-story.\n * Times out after `timeout` ms (default is 2000).\n *\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<boolean>}\n */\nexport function isStoryDocument(ampdoc) {\n  return ampdoc.waitForBodyOpen().then(() => {\n    const body = ampdoc.getBody();\n    const childPromise = waitForChildPromise(\n      body,\n      () => !!body.firstElementChild\n    );\n    // 2s timeout for edge case where body has no element children.\n    return Services.timerFor(ampdoc.win)\n      .timeoutPromise(2000, childPromise)\n      .then(\n        () => body.firstElementChild.tagName === 'AMP-STORY',\n        () => false\n      );\n  });\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {Signals} from '../core/data-structures/signals';\nimport {TickLabel} from '../core/constants/enums';\nimport {VisibilityState} from '../core/constants/visibility-state';\nimport {createCustomEvent} from '../event-helper';\nimport {dev, devAssert} from '../log';\nimport {dict, map} from '../core/types/object';\nimport {getMode} from '../mode';\nimport {getService, registerServiceBuilder} from '../service';\nimport {isStoryDocument} from '../utils/story';\nimport {layoutRectLtwh} from '../core/math/layout-rect';\nimport {throttle} from '../core/types/function';\nimport {whenContentIniLoad} from '../ini-load';\nimport {whenDocumentComplete, whenDocumentReady} from '../core/document-ready';\n\n/**\n * Maximum number of tick events we allow to accumulate in the performance\n * instance's queue before we start dropping those events and can no longer\n * be forwarded to the actual `tick` function when it is set.\n */\nconst QUEUE_LIMIT = 50;\n\nconst TAG = 'Performance';\n\n/**\n * Fields:\n * {{\n *   label: string,\n *   delta: (number|null|undefined),\n *   value: (number|null|undefined)\n * }}\n * @typedef {!JsonObject}\n */\nlet TickEventDef;\n\n/**\n * Performance holds the mechanism to call `tick` to stamp out important\n * events in the lifecycle of the AMP runtime. It can hold a small amount\n * of tick events to forward to the external `tick` function when it is set.\n */\nexport class Performance {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @const @private {!Array<TickEventDef>} */\n    this.events_ = [];\n\n    /** @const @private {number} */\n    this.timeOrigin_ =\n      win.performance.timeOrigin || win.performance.timing.navigationStart;\n\n    /** @private {?./ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = null;\n\n    /** @private {?./viewer-interface.ViewerInterface} */\n    this.viewer_ = null;\n\n    /** @private {?./resources-interface.ResourcesInterface} */\n    this.resources_ = null;\n\n    /** @private {?./document-info-impl.DocumentInfoDef} */\n    this.documentInfo_ = null;\n\n    /** @private {boolean} */\n    this.isMessagingReady_ = false;\n\n    /** @private {boolean} */\n    this.isPerformanceTrackingOn_ = false;\n\n    /** @private {!Object<string,boolean>} */\n    this.enabledExperiments_ = map();\n\n    /** @private {string|undefined} */\n    this.ampexp_ = undefined;\n\n    /** @private {Signals} */\n    this.metrics_ = new Signals();\n\n    /**\n     * How many times a layout shift metric has been ticked.\n     *\n     * @private {number}\n     */\n    this.shiftScoresTicked_ = 0;\n\n    /**\n     * The collection of layout shift events from the Layout Instability API.\n     * @private {Array<LayoutShift>}\n     */\n    this.layoutShifts_ = [];\n\n    const supportedEntryTypes =\n      (this.win.PerformanceObserver &&\n        this.win.PerformanceObserver.supportedEntryTypes) ||\n      [];\n\n    // If Paint Timing API is not supported, cannot determine first contentful paint\n    if (!supportedEntryTypes.includes('paint')) {\n      this.metrics_.rejectSignal(\n        TickLabel.FIRST_CONTENTFUL_PAINT,\n        dev().createExpectedError('First Contentful Paint not supported')\n      );\n    }\n\n    /**\n     * Whether the user agent supports the Layout Instability API that shipped\n     * with Chromium 77.\n     *\n     * @private {boolean}\n     */\n    this.supportsLayoutShift_ = supportedEntryTypes.includes('layout-shift');\n\n    if (!this.supportsLayoutShift_) {\n      this.metrics_.rejectSignal(\n        TickLabel.CUMULATIVE_LAYOUT_SHIFT,\n        dev().createExpectedError('Cumulative Layout Shift not supported')\n      );\n    }\n\n    /**\n     * Whether the user agent supports the Event Timing API that shipped\n     * with Chromium 77.\n     *\n     * @private {boolean}\n     */\n    this.supportsEventTiming_ = supportedEntryTypes.includes('first-input');\n\n    if (!this.supportsEventTiming_) {\n      this.metrics_.rejectSignal(\n        TickLabel.FIRST_INPUT_DELAY,\n        dev().createExpectedError('First Input Delay not supported')\n      );\n    }\n\n    /**\n     * Whether the user agent supports the Largest Contentful Paint metric.\n     *\n     * @private {boolean}\n     */\n    this.supportsLargestContentfulPaint_ = supportedEntryTypes.includes(\n      'largest-contentful-paint'\n    );\n\n    if (!this.supportsLargestContentfulPaint_) {\n      this.metrics_.rejectSignal(\n        TickLabel.LARGEST_CONTENTFUL_PAINT_VISIBLE,\n        dev().createExpectedError('Largest Contentful Paint not supported')\n      );\n    }\n\n    /**\n     * Whether the user agent supports the navigation timing API\n     *\n     * @private {boolean}\n     */\n    this.supportsNavigation_ = supportedEntryTypes.includes('navigation');\n\n    /**\n     * The latest reported largest contentful paint time, where the loadTime\n     * is specified.\n     *\n     * @private {?number}\n     */\n    this.largestContentfulPaintLoadTime_ = null;\n\n    /**\n     * The latest reported largest contentful paint time, where the renderTime\n     * is specified.\n     *\n     * @private {?number}\n     */\n    this.largestContentfulPaintRenderTime_ = null;\n\n    this.onAmpDocVisibilityChange_ = this.onAmpDocVisibilityChange_.bind(this);\n\n    // Add RTV version as experiment ID, so we can slice the data by version.\n    this.addEnabledExperiment('rtv-' + getMode(this.win).rtvVersion);\n\n    // Tick document ready event.\n    whenDocumentReady(win.document).then(() => {\n      this.tick(TickLabel.DOCUMENT_READY);\n      this.flush();\n    });\n\n    // Tick window.onload event.\n    whenDocumentComplete(win.document).then(() => this.onload_());\n    this.registerPerformanceObserver_();\n    this.registerFirstInputDelayPolyfillListener_();\n  }\n\n  /**\n   * Listens to viewer and resource events.\n   * @return {!Promise}\n   */\n  coreServicesAvailable() {\n    const {documentElement} = this.win.document;\n    this.ampdoc_ = Services.ampdoc(documentElement);\n    this.viewer_ = Services.viewerForDoc(documentElement);\n    this.resources_ = Services.resourcesForDoc(documentElement);\n    this.documentInfo_ = Services.documentInfoForDoc(this.ampdoc_);\n\n    this.isPerformanceTrackingOn_ =\n      this.viewer_.isEmbedded() && this.viewer_.getParam('csi') === '1';\n\n    // This is for redundancy. Call flush on any visibility change.\n    this.ampdoc_.onVisibilityChanged(this.flush.bind(this));\n\n    // Does not need to wait for messaging ready since it will be queued\n    // if it isn't ready.\n    this.measureUserPerceivedVisualCompletenessTime_();\n\n    // Can be null which would mean this AMP page is not embedded\n    // and has no messaging channel.\n    const channelPromise = this.viewer_.whenMessagingReady();\n\n    this.ampdoc_.whenFirstVisible().then(() => {\n      this.tick(TickLabel.ON_FIRST_VISIBLE);\n      this.flush();\n    });\n\n    const registerVisibilityChangeListener =\n      this.supportsLargestContentfulPaint_ || this.supportsLayoutShift_;\n    // Register a handler to record metrics when the page enters the hidden\n    // lifecycle state.\n    if (registerVisibilityChangeListener) {\n      this.ampdoc_.onVisibilityChanged(this.onAmpDocVisibilityChange_);\n    }\n\n    // We don't check `isPerformanceTrackingOn` here since there are some\n    // events that we call on the viewer even though performance tracking\n    // is off we only need to know if the AMP page has a messaging\n    // channel or not.\n    if (!channelPromise) {\n      return Promise.resolve();\n    }\n\n    return channelPromise\n      .then(() => {\n        // Tick the \"messaging ready\" signal.\n        this.tickDelta(TickLabel.MESSAGING_READY, this.win.performance.now());\n\n        // Tick timeOrigin so that epoch time can be calculated by consumers.\n        this.tick(TickLabel.TIME_ORIGIN, undefined, this.timeOrigin_);\n\n        const usqp = this.ampdoc_.getMetaByName('amp-usqp');\n        if (usqp) {\n          usqp.split(',').forEach((exp) => {\n            this.addEnabledExperiment('ssr-' + exp);\n          });\n        }\n\n        return this.maybeAddStoryExperimentId_();\n      })\n      .then(() => {\n        this.isMessagingReady_ = true;\n\n        // Forward all queued ticks to the viewer since messaging\n        // is now ready.\n        this.flushQueuedTicks_();\n\n        // Send all csi ticks through.\n        this.flush();\n      });\n  }\n\n  /**\n   * Add a story experiment ID in order to slice the data for amp-story.\n   * @return {!Promise}\n   * @private\n   */\n  maybeAddStoryExperimentId_() {\n    const ampdoc = Services.ampdocServiceFor(this.win).getSingleDoc();\n    return isStoryDocument(ampdoc).then((isStory) => {\n      if (isStory) {\n        this.addEnabledExperiment('story');\n      }\n    });\n  }\n\n  /**\n   * Callback for onload.\n   */\n  onload_() {\n    this.tick(TickLabel.ON_LOAD);\n    this.tickLegacyFirstPaintTime_();\n    this.flush();\n  }\n\n  /**\n   * Reports performance metrics first paint, first contentful paint,\n   * and first input delay.\n   * See https://github.com/WICG/paint-timing\n   */\n  registerPerformanceObserver_() {\n    // Turn off performanceObserver derived metrics for inabox as there\n    // will never be a viewer to report to.\n    // TODO(ccordry): we are still doing some other unnecessary measurements for\n    // the inabox case, but would need a larger refactor.\n    if (getMode(this.win).runtime === 'inabox') {\n      return;\n    }\n\n    // These state vars ensure that we only report a given value once, because\n    // the backend doesn't support updates.\n    let recordedFirstPaint = false;\n    let recordedFirstContentfulPaint = false;\n    let recordedFirstInputDelay = false;\n    let recordedNavigation = false;\n    const processEntry = (entry) => {\n      if (entry.name == 'first-paint' && !recordedFirstPaint) {\n        this.tickDelta(TickLabel.FIRST_PAINT, entry.startTime + entry.duration);\n        recordedFirstPaint = true;\n      } else if (\n        entry.name == 'first-contentful-paint' &&\n        !recordedFirstContentfulPaint\n      ) {\n        const value = entry.startTime + entry.duration;\n        this.tickDelta(TickLabel.FIRST_CONTENTFUL_PAINT, value);\n        this.tickSinceVisible(TickLabel.FIRST_CONTENTFUL_PAINT_VISIBLE, value);\n        recordedFirstContentfulPaint = true;\n      } else if (\n        entry.entryType === 'first-input' &&\n        !recordedFirstInputDelay\n      ) {\n        const value = entry.processingStart - entry.startTime;\n        this.tickDelta(TickLabel.FIRST_INPUT_DELAY, value);\n        recordedFirstInputDelay = true;\n      } else if (entry.entryType === 'layout-shift') {\n        // Ignore layout shift that occurs within 500ms of user input, as it is\n        // likely in response to the user's action.\n        // 1000 here is a magic number to prevent unbounded growth. We don't expect it to be reached.\n        if (!entry.hadRecentInput && this.layoutShifts_.length < 1000) {\n          this.layoutShifts_.push(entry);\n        }\n      } else if (entry.entryType === 'largest-contentful-paint') {\n        if (entry.loadTime) {\n          this.largestContentfulPaintLoadTime_ = entry.loadTime;\n        }\n        if (entry.renderTime) {\n          this.largestContentfulPaintRenderTime_ = entry.renderTime;\n        }\n      } else if (entry.entryType == 'navigation' && !recordedNavigation) {\n        [\n          'domComplete',\n          'domContentLoadedEventEnd',\n          'domContentLoadedEventStart',\n          'domInteractive',\n          'loadEventEnd',\n          'loadEventStart',\n          'requestStart',\n          'responseStart',\n        ].forEach((label) => this.tick(label, entry[label]));\n        recordedNavigation = true;\n      }\n    };\n\n    const entryTypesToObserve = [];\n    if (this.win.PerformancePaintTiming) {\n      // Programmatically read once as currently PerformanceObserver does not\n      // report past entries as of Chromium 61.\n      // https://bugs.chromium.org/p/chromium/issues/detail?id=725567\n      this.win.performance.getEntriesByType('paint').forEach(processEntry);\n      entryTypesToObserve.push('paint');\n    }\n\n    if (this.supportsEventTiming_) {\n      this.createPerformanceObserver_(processEntry, {\n        type: 'first-input',\n        buffered: true,\n      });\n    }\n\n    if (this.supportsLayoutShift_) {\n      this.createPerformanceObserver_(processEntry, {\n        type: 'layout-shift',\n        buffered: true,\n      });\n    }\n\n    if (this.supportsLargestContentfulPaint_) {\n      // lcpObserver\n      this.createPerformanceObserver_(processEntry, {\n        type: 'largest-contentful-paint',\n        buffered: true,\n      });\n    }\n\n    if (this.supportsNavigation_) {\n      // Wrap in a try statement as there are some browsers (ex. chrome 73)\n      // that will say it supports navigation but throws.\n      this.createPerformanceObserver_(processEntry, {\n        type: 'navigation',\n        buffered: true,\n      });\n    }\n\n    if (entryTypesToObserve.length > 0) {\n      this.createPerformanceObserver_(processEntry, {\n        entryTypes: entryTypesToObserve,\n      });\n    }\n  }\n\n  /**\n   * @param {function(!PerformanceEntry)} processEntry\n   * @param {!PerformanceObserverInit} init\n   * @return {!PerformanceObserver}\n   * @private\n   */\n  createPerformanceObserver_(processEntry, init) {\n    try {\n      const obs = new this.win.PerformanceObserver((list) => {\n        list.getEntries().forEach(processEntry);\n        this.flush();\n      });\n      obs.observe(init);\n    } catch (err) {\n      dev().warn(TAG, err);\n    }\n  }\n\n  /**\n   * Reports the first input delay value calculated by a polyfill, if present.\n   * @see https://github.com/GoogleChromeLabs/first-input-delay\n   */\n  registerFirstInputDelayPolyfillListener_() {\n    if (!this.win.perfMetrics || !this.win.perfMetrics.onFirstInputDelay) {\n      return;\n    }\n    this.win.perfMetrics.onFirstInputDelay((delay) => {\n      this.tickDelta(TickLabel.FIRST_INPUT_DELAY_POLYFILL, delay);\n      this.flush();\n    });\n  }\n\n  /**\n   * When the viewer visibility state of the document changes to inactive or hidden,\n   * send the layout score.\n   * @private\n   */\n  onAmpDocVisibilityChange_() {\n    const state = this.ampdoc_.getVisibilityState();\n    if (\n      state === VisibilityState.INACTIVE ||\n      state === VisibilityState.HIDDEN\n    ) {\n      this.tickCumulativeMetrics_();\n    }\n  }\n\n  /**\n   * Tick the metrics whose values change over time.\n   * @private\n   */\n  tickCumulativeMetrics_() {\n    if (this.supportsLayoutShift_) {\n      this.tickLayoutShiftScore_();\n    }\n    if (this.supportsLargestContentfulPaint_) {\n      this.tickLargestContentfulPaint_();\n    }\n  }\n\n  /**\n   * Tick the layout shift score metric.\n   *\n   * A value of the metric is recorded in under two names, `cls` and `cls-2`,\n   * for the first two times the page transitions into a hidden lifecycle state\n   * (when the page is navigated a way from, the tab is backgrounded for\n   * another tab, or the user backgrounds the browser application).\n   *\n   * Since we can't reliably detect when a page session finally ends,\n   * recording the value for these first two events should provide a fair\n   * amount of visibility into this metric.\n   */\n  tickLayoutShiftScore_() {\n    const cls = this.layoutShifts_.reduce((sum, entry) => sum + entry.value, 0);\n    const fcp = this.metrics_.get(TickLabel.FIRST_CONTENTFUL_PAINT) ?? 0; // fallback to 0, so that we never overcount.\n    const ofv = this.metrics_.get(TickLabel.ON_FIRST_VISIBLE) ?? 0;\n\n    // TODO(#33207): Remove after data collection\n    const clsBeforeFCP = this.layoutShifts_.reduce((sum, entry) => {\n      if (entry.startTime < fcp) {\n        return sum + entry.value;\n      }\n      return sum;\n    }, 0);\n    const clsBeforeOFV = this.layoutShifts_.reduce((sum, entry) => {\n      if (entry.startTime < ofv) {\n        return sum + entry.value;\n      }\n      return sum;\n    }, 0);\n\n    if (this.shiftScoresTicked_ === 0) {\n      this.tick(TickLabel.CUMULATIVE_LAYOUT_SHIFT_BEFORE_VISIBLE, clsBeforeOFV);\n      this.tickDelta(\n        TickLabel.CUMULATIVE_LAYOUT_SHIFT_BEFORE_FCP,\n        clsBeforeFCP\n      );\n      this.tickDelta(TickLabel.CUMULATIVE_LAYOUT_SHIFT, cls);\n      this.flush();\n      this.shiftScoresTicked_ = 1;\n    } else if (this.shiftScoresTicked_ === 1) {\n      this.tickDelta(TickLabel.CUMULATIVE_LAYOUT_SHIFT_2, cls);\n      this.flush();\n      this.shiftScoresTicked_ = 2;\n    }\n  }\n\n  /**\n   * Tick fp time based on Chromium's legacy paint timing API when\n   * appropriate.\n   * `registerPaintTimingObserver_` calls the standards based API and this\n   * method does nothing if it is available.\n   */\n  tickLegacyFirstPaintTime_() {\n    // Detect deprecated first paint time API\n    // https://bugs.chromium.org/p/chromium/issues/detail?id=621512\n    // We'll use this until something better is available.\n    if (\n      !this.win.PerformancePaintTiming &&\n      this.win.chrome &&\n      typeof this.win.chrome.loadTimes == 'function'\n    ) {\n      const fpTime =\n        this.win.chrome.loadTimes()['firstPaintTime'] * 1000 -\n        this.win.performance.timing.navigationStart;\n      if (fpTime <= 1) {\n        // Throw away bad data generated from an apparent Chromium bug\n        // that is fixed in later Chromium versions.\n        return;\n      }\n      this.tickDelta(TickLabel.FIRST_PAINT, fpTime);\n    }\n  }\n\n  /**\n   * Tick the largest contentful paint metrics.\n   */\n  tickLargestContentfulPaint_() {\n    /** @type {?number} */ let end;\n    if (this.largestContentfulPaintLoadTime_ !== null) {\n      this.tickDelta(\n        TickLabel.LARGEST_CONTENTFUL_PAINT_LOAD,\n        this.largestContentfulPaintLoadTime_\n      );\n      end = this.largestContentfulPaintLoadTime_;\n    }\n    if (this.largestContentfulPaintRenderTime_ !== null) {\n      this.tickDelta(\n        TickLabel.LARGEST_CONTENTFUL_PAINT_RENDER,\n        this.largestContentfulPaintRenderTime_\n      );\n      end = end || this.largestContentfulPaintRenderTime_;\n    }\n    if (end !== null) {\n      this.tickSinceVisible(TickLabel.LARGEST_CONTENTFUL_PAINT_VISIBLE, end);\n    }\n    this.flush();\n  }\n\n  /**\n   * Measure the delay the user perceives of how long it takes\n   * to load the initial viewport.\n   * @private\n   */\n  measureUserPerceivedVisualCompletenessTime_() {\n    const didStartInPrerender = !this.ampdoc_.hasBeenVisible();\n\n    let docVisibleTime = -1;\n    this.ampdoc_.whenFirstVisible().then(() => {\n      docVisibleTime = this.win.performance.now();\n      // Mark this first visible instance in the browser timeline.\n      this.mark('visible');\n    });\n\n    this.whenViewportLayoutComplete_().then(() => {\n      if (didStartInPrerender) {\n        const userPerceivedVisualCompletenesssTime =\n          docVisibleTime > -1\n            ? this.win.performance.now() - docVisibleTime\n            : //  Prerender was complete before visibility.\n              0;\n        this.ampdoc_.whenFirstVisible().then(() => {\n          // We only tick this if the page eventually becomes visible,\n          // since otherwise we heavily skew the metric towards the\n          // 0 case, since pre-renders that are never used are highly\n          // likely to fully load before they are never used :)\n          this.tickDelta(\n            TickLabel.FIRST_VIEWPORT_READY,\n            userPerceivedVisualCompletenesssTime\n          );\n        });\n        this.prerenderComplete_(userPerceivedVisualCompletenesssTime);\n        // Mark this instance in the browser timeline.\n        this.mark(TickLabel.FIRST_VIEWPORT_READY);\n      } else {\n        // If it didnt start in prerender, no need to calculate anything\n        // and we just need to tick `pc`. (it will give us the relative\n        // time since the viewer initialized the timer)\n        this.tick(TickLabel.FIRST_VIEWPORT_READY);\n        this.prerenderComplete_(this.win.performance.now() - docVisibleTime);\n      }\n      this.flush();\n    });\n  }\n\n  /**\n   * Returns a promise that is resolved when resources in viewport\n   * have been finished being laid out.\n   * @return {!Promise}\n   * @private\n   */\n  whenViewportLayoutComplete_() {\n    return this.resources_.whenFirstPass().then(() => {\n      const {documentElement} = this.win.document;\n      const size = Services.viewportForDoc(documentElement).getSize();\n      const rect = layoutRectLtwh(0, 0, size.width, size.height);\n      return whenContentIniLoad(\n        documentElement,\n        this.win,\n        rect,\n        /* isInPrerender */ true\n      );\n    });\n  }\n\n  /**\n   * Ticks a timing event.\n   *\n   * @param {TickLabel} label The variable name as it will be reported.\n   *     See TICKEVENTS.md for available metrics, and edit this file\n   *     when adding a new metric.\n   * @param {number=} opt_delta The delta. Call tickDelta instead of setting\n   *     this directly.\n   * @param {number=} opt_value The value to use. Overrides default calculation.\n   */\n  tick(label, opt_delta, opt_value) {\n    devAssert(\n      opt_delta == undefined || opt_value == undefined,\n      'You may not set both opt_delta and opt_value.'\n    );\n\n    const data = dict({'label': label});\n    let delta;\n\n    if (opt_delta != undefined) {\n      data['delta'] = delta = Math.max(opt_delta, 0);\n    } else if (opt_value != undefined) {\n      data['value'] = opt_value;\n    } else {\n      // Marking only makes sense for non-overridden values (and no deltas).\n      this.mark(label);\n      delta = this.win.performance.now();\n      data['value'] = this.timeOrigin_ + delta;\n    }\n\n    // Emit events. Used by `amp performance`.\n    this.win.dispatchEvent(\n      createCustomEvent(\n        this.win,\n        'perf',\n        /** @type {JsonObject} */ ({label, delta})\n      )\n    );\n\n    if (this.isMessagingReady_ && this.isPerformanceTrackingOn_) {\n      this.viewer_.sendMessage('tick', data);\n    } else {\n      this.queueTick_(data);\n    }\n\n    this.metrics_.signal(label, delta);\n  }\n\n  /**\n   * Add browser performance timeline entries for simple ticks.\n   * These are for example exposed in WPT.\n   * See https://developer.mozilla.org/en-US/docs/Web/API/Performance/mark\n   * @param {string} label\n   */\n  mark(label) {\n    if (\n      this.win.performance &&\n      this.win.performance.mark &&\n      arguments.length == 1\n    ) {\n      this.win.performance.mark(label);\n    }\n  }\n\n  /**\n   * Tick a very specific value for the label. Use this method if you\n   * measure the time it took to do something yourself.\n   * @param {TickLabel} label The variable name as it will be reported.\n   * @param {number} value The value in milliseconds that should be ticked.\n   */\n  tickDelta(label, value) {\n    this.tick(label, value);\n  }\n\n  /**\n   * Tick time delta since the document has become visible.\n   * @param {TickLabel} label The variable name as it will be reported.\n   * @param {number=} opt_delta The optional delta value in milliseconds.\n   */\n  tickSinceVisible(label, opt_delta) {\n    const delta =\n      opt_delta == undefined ? this.win.performance.now() : opt_delta;\n    const end = this.timeOrigin_ + delta;\n\n    // Order is timeOrigin -> firstVisibleTime -> end.\n    const visibleTime = this.ampdoc_ && this.ampdoc_.getFirstVisibleTime();\n    const v = visibleTime ? Math.max(end - visibleTime, 0) : 0;\n    this.tickDelta(label, v);\n  }\n\n  /**\n   * Ask the viewer to flush the ticks\n   */\n  flush() {\n    if (this.isMessagingReady_ && this.isPerformanceTrackingOn_) {\n      if (this.ampexp_ == null) {\n        this.ampexp_ = Object.keys(this.enabledExperiments_).join(',');\n      }\n      this.viewer_.sendMessage(\n        'sendCsi',\n        dict({\n          'ampexp': this.ampexp_,\n          'canonicalUrl': this.documentInfo_.canonicalUrl,\n        }),\n        /* cancelUnsent */ true\n      );\n    }\n  }\n\n  /**\n   * Flush with a rate limit of 10 per second.\n   */\n  throttledFlush() {\n    if (!this.throttledFlush_) {\n      /** @private {function()} */\n      this.throttledFlush_ = throttle(this.win, this.flush.bind(this), 100);\n    }\n    this.throttledFlush_();\n  }\n\n  /**\n   * @param {string} experimentId\n   */\n  addEnabledExperiment(experimentId) {\n    this.enabledExperiments_[experimentId] = true;\n    this.ampexp_ = undefined;\n  }\n\n  /**\n   * Queues the events to be flushed when tick function is set.\n   *\n   * @param {TickEventDef} data Tick data to be queued.\n   * @private\n   */\n  queueTick_(data) {\n    // Start dropping the head of the queue if we've reached the limit\n    // so that we don't take up too much memory in the runtime.\n    if (this.events_.length >= QUEUE_LIMIT) {\n      this.events_.shift();\n    }\n\n    this.events_.push(data);\n  }\n\n  /**\n   * Forwards all queued ticks to the viewer tick method.\n   * @private\n   */\n  flushQueuedTicks_() {\n    if (!this.viewer_) {\n      return;\n    }\n\n    if (!this.isPerformanceTrackingOn_) {\n      // drop all queued ticks to not leak\n      this.events_.length = 0;\n      return;\n    }\n\n    this.events_.forEach((tickEvent) => {\n      this.viewer_.sendMessage('tick', tickEvent);\n    });\n    this.events_.length = 0;\n  }\n\n  /**\n   * @private\n   * @param {number} value\n   */\n  prerenderComplete_(value) {\n    if (this.viewer_) {\n      this.viewer_.sendMessage(\n        'prerenderComplete',\n        dict({'value': value}),\n        /* cancelUnsent */ true\n      );\n    }\n  }\n\n  /**\n   * Identifies if the viewer is able to track performance. If the document is\n   * not embedded, there is no messaging channel, so no performance tracking is\n   * needed since there is nobody to forward the events.\n   * @return {boolean}\n   */\n  isPerformanceTrackingOn() {\n    return this.isPerformanceTrackingOn_;\n  }\n\n  /**\n   * Retrieve a promise for tick label, resolved with metric. Used by amp-analytics\n   *\n   * @param {TickLabel} label\n   * @return {!Promise<time>}\n   */\n  getMetric(label) {\n    return this.metrics_.whenSignal(label);\n  }\n}\n\n/**\n * @param {!Window} window\n */\nexport function installPerformanceService(window) {\n  registerServiceBuilder(window, 'performance', Performance);\n}\n\n/**\n * @param {!Window} window\n * @return {!Performance}\n */\nexport function performanceFor(window) {\n  return getService(window, 'performance');\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {px, setStyle, setStyles} from '../../../src/style';\n\n/** @const {number} Fixed button height from design spec. */\nconst MAX_HEIGHT = 32;\n\n/** @enum {number} From design spec. */\nconst FontSizes = {\n  MIN: 12,\n  MAX: 14,\n};\n\nexport class ButtonTextFitter {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const @private {!../../../src/service/mutator-interface.MutatorInterface} */\n    this.mutator_ = Services.mutatorForDoc(ampdoc);\n\n    /** @private {!Document} */\n    this.doc_ = ampdoc.win.document;\n\n    /** @private {!Element} */\n    this.measurer_ = this.doc_.createElement('div');\n\n    this.mutator_.mutateElement(this.measurer_, () => {\n      this.doc_.body.appendChild(this.measurer_);\n      setStyles(this.measurer_, {\n        position: 'absolute',\n        top: 0,\n        left: 0,\n        zIndex: 1,\n        visibility: 'hidden',\n        'font-weight': 'bold',\n        'letter-spacing': '0.2px',\n      });\n    });\n  }\n\n  /**\n   * @param {!Element} pageElement\n   * @param {!Element} container\n   * @param {string} content\n   * @return {Promise<boolean>}\n   */\n  fit(pageElement, container, content) {\n    let success = false;\n    return this.mutator_\n      .mutateElement(container, () => {\n        this.measurer_.textContent = content;\n        const fontSize = calculateFontSize(\n          this.measurer_,\n          MAX_HEIGHT,\n          this.getMaxWidth_(pageElement),\n          FontSizes.MIN,\n          FontSizes.MAX\n        );\n        if (fontSize >= FontSizes.MIN) {\n          this.updateFontSize_(container, fontSize);\n          success = true;\n        }\n      })\n      .then(() => {\n        return success;\n      });\n  }\n\n  /**\n   * Called on each button creation, in case of window resize.\n   * Page width - (2 x 32px of padding on each side) + (2 x 10px padding on button).\n   * @param {!Element} pageElement\n   * @return {number}\n   * @private\n   */\n  getMaxWidth_(pageElement) {\n    return pageElement./*OK*/ offsetWidth - 84;\n  }\n\n  /**\n   * @param {!Element} container\n   * @param {number} fontSize\n   */\n  updateFontSize_(container, fontSize) {\n    setStyle(container, 'fontSize', px(fontSize));\n  }\n}\n\n/**\n * This used to be binary search, but since range is so small just try the 3\n * values. If range gets larger, reevaluate.\n * @param {Element} measurer\n * @param {number} expectedHeight\n * @param {number} expectedWidth\n * @param {number} minFontSize\n * @param {number} maxFontSize\n * @return {number}\n */\nfunction calculateFontSize(\n  measurer,\n  expectedHeight,\n  expectedWidth,\n  minFontSize,\n  maxFontSize\n) {\n  for (let fontSize = maxFontSize; fontSize >= minFontSize; fontSize--) {\n    setStyle(measurer, 'fontSize', px(fontSize));\n    const height = measurer./*OK*/ offsetHeight;\n    const width = measurer./*OK*/ offsetWidth;\n    if (height < expectedHeight && width < expectedWidth) {\n      return fontSize;\n    }\n  }\n  // Did not fit within design spec.\n  return minFontSize - 1;\n}\n", "export const CSS = \".i-amphtml-story-ad-attribution{position:absolute;bottom:0!important;left:0!important;max-height:15px!important;z-index:4!important}.i-amphtml-story-ad-fullbleed.i-amphtml-story-ad-attribution{bottom:12.5vh!important;left:50%!important;transform:translateX(-22.5vh)!important}\\n/*# sourceURL=/extensions/amp-story-auto-ads/0.1/amp-story-auto-ads-attribution.css*/\";\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {\n  assertHttpsUrl,\n  getSourceOrigin,\n  isProxyOrigin,\n  resolveRelativeUrl,\n} from '../../../src/url';\nimport {\n  closestAncestorElementBySelector,\n  scopedQuerySelectorAll,\n} from '../../../src/core/dom/query';\nimport {createShadowRoot} from '../../../src/shadow-embed';\nimport {dev, user, userAssert} from '../../../src/log';\nimport {getMode} from '../../../src/mode';\n\nimport {setStyle, toggle} from '../../../src/style';\n\n/**\n * Returns millis as number if given a string(e.g. 1s, 200ms etc)\n * @param {string} time\n * @param {number=} fallbackMs Used when `time` is not a valid time string.\n * @return {number|undefined}\n */\nexport function timeStrToMillis(time, fallbackMs = NaN) {\n  const match = time.toLowerCase().match(/^([0-9\\.]+)\\s*(s|ms)$/);\n\n  const num = match ? match[1] : undefined;\n  const units = match ? match[2] : undefined;\n\n  if (!match || match.length !== 3 || (units !== 's' && units !== 'ms')) {\n    return fallbackMs;\n  }\n\n  return Math.round((units == 's' ? 1000 : 1) * parseFloat(num));\n}\n\n/**\n * Determines whether the specified element has an action for its on=\"tap:...\"\n * handler.\n * @param {!Element} el\n * @return {boolean}\n */\nexport function hasTapAction(el) {\n  // There are better ways to determine this, but they're all bound to action\n  // service race conditions. This is good enough for our use case.\n  return (\n    el.hasAttribute('on') && !!el.getAttribute('on').match(/(^|;)\\s*tap\\s*:/)\n  );\n}\n\n/**\n * Calculates a client rect without applying scaling transformations.\n * Note: must be run in a vsync measure context.\n * @param {!Element} el\n * @return {!ClientRect}\n */\nexport function unscaledClientRect(el) {\n  const {height, left, top, width} = el./*OK*/ getBoundingClientRect();\n\n  const scaleFactorX = width == 0 ? 1 : width / el./*OK*/ offsetWidth;\n  const scaleFactorY = height == 0 ? 1 : height / el./*OK*/ offsetHeight;\n\n  return /** @type {!ClientRect} */ ({\n    left: left / scaleFactorX,\n    top: top / scaleFactorY,\n    width: width / scaleFactorX,\n    height: height / scaleFactorY,\n  });\n}\n\n/**\n * Finds an amp-video/amp-audio ancestor.\n * @param {!Element} el\n * @return {?AmpElement}\n */\nexport function ampMediaElementFor(el) {\n  return closestAncestorElementBySelector(el, 'amp-video, amp-audio');\n}\n\n/**\n * Creates a shadow root for the provided container, and appends the element\n * along with its CSS.\n * @param  {!Element} container\n * @param  {!Element} element\n * @param  {string} css\n */\nexport function createShadowRootWithStyle(container, element, css) {\n  const style = self.document.createElement('style');\n  style./*OK*/ textContent = css;\n\n  const containerToUse = getMode().test\n    ? container\n    : createShadowRoot(container);\n\n  containerToUse.appendChild(style);\n  containerToUse.appendChild(element);\n}\n\n/**\n * Parses the resolved CSS color property, that is always in the form of\n * `rgba(0, 0, 0, 1)` or `rgb(0, 0, 0)`, that can be retrieved using\n * `getComputedStyle`.\n * Returns an object containing the R, G, and B 8bit numbers.\n * @param  {string} cssValue\n * @return {!Object<string, number>}\n */\nexport function getRGBFromCssColorValue(cssValue) {\n  const regexPattern = /rgba?\\((\\d{1,3}), (\\d{1,3}), (\\d{1,3})/;\n\n  if (!cssValue.match(regexPattern)) {\n    user().error(\n      'UTILS',\n      'getRGBFromCssColorValue expects a parameter in ' +\n        `the form of 'rgba(0, 0, 0, 1)' or 'rgb(0, 0, 0)' but got ${cssValue}`\n    );\n    // Returns a fallback value, to fail 'gracefully' in case a browser we don't\n    // know about gave an unexpected value.\n    return {r: 0, g: 0, b: 0};\n  }\n\n  const matches = regexPattern.exec(cssValue);\n\n  return {\n    r: Number(matches[1]),\n    g: Number(matches[2]),\n    b: Number(matches[3]),\n  };\n}\n\n/**\n * Returns the color, either black or white, that has the best contrast ratio\n * against the provided RGB 8bit values.\n * @param  {!Object<string, number>} rgb  ie: {r: 0, g: 0, b: 0}\n * @return {string} '#fff' or '#000'\n */\nexport function getTextColorForRGB(rgb) {\n  const {b, g, r} = rgb;\n  // Calculates the relative luminance L.\n  // https://www.w3.org/TR/2008/REC-WCAG20-20081211/#relativeluminancedef\n  const getLinearRGBValue = (x) => {\n    // 8bit to sRGB.\n    x /= 255;\n\n    // Converts the gamma-compressed RGB values to linear RGB.\n    return x <= 0.03928 ? x / 12.92 : Math.pow((x + 0.055) / 1.055, 2.4);\n  };\n\n  const linearR = getLinearRGBValue(r);\n  const linearG = getLinearRGBValue(g);\n  const linearB = getLinearRGBValue(b);\n\n  const L = 0.2126 * linearR + 0.7152 * linearG + 0.0722 * linearB;\n\n  // Determines which one of the white and black text have a better contrast\n  // ratio against the used background color.\n  // https://www.w3.org/TR/2008/REC-WCAG20-20081211/#contrast-ratiodef\n  // @TODO(gmajoulet): Improve the text color for high contrast ratio.\n  // 1 is L for #FFF, and 0 is L for #000.\n  // (1 + 0.05) / (L + 0.05) > (L + 0.05) / (0 + 0.05) toggles for L = 0.179.\n  return L > 0.179 ? '#000' : '#FFF';\n}\n\n/**\n * Sets given attribute to the given element in next `mutate` phase.\n * @param {!AMP.BaseElement} elementImpl\n * @param {string} name\n * @param {string=} opt_value\n */\nexport function setAttributeInMutate(elementImpl, name, opt_value) {\n  const value = opt_value || '';\n  elementImpl.mutateElement(() => {\n    elementImpl.element.setAttribute(name, value);\n  });\n}\n\n/**\n * Removes given attribute from the given element in next `mutate` phase.\n * @param {!AMP.BaseElement} elementImpl\n * @param {string} name\n */\nexport function removeAttributeInMutate(elementImpl, name) {\n  elementImpl.mutateElement(() => {\n    elementImpl.element.removeAttribute(name);\n  });\n}\n\n/**\n * @param {!Element} element\n * @param {string|!Location} url\n */\nexport function userAssertValidProtocol(element, url) {\n  userAssert(\n    Services.urlForDoc(element).isProtocolValid(url),\n    'Unsupported protocol for URL %s',\n    url\n  );\n}\n\n/**\n * Gets the origin url for elements that display a url. It\n * trims the protocol prefix and returns only the hostname of the origin.\n * @param {!Element} element\n * @param {string} url\n * @return {string}\n */\nexport function getSourceOriginForElement(element, url) {\n  let domainName;\n\n  try {\n    domainName = getSourceOrigin(Services.urlForDoc(element).parse(url));\n    // Remove protocol prefix.\n    domainName = Services.urlForDoc(element).parse(domainName).hostname;\n  } catch (e) {\n    // Unknown path prefix in url.\n    domainName = Services.urlForDoc(element).parse(url).hostname;\n  }\n  return domainName;\n}\n\n/**\n * Resolves an image url and optimizes it if served from the cache.\n * @param {!Window} win\n * @param {string} url\n * @return {string}\n */\nexport function resolveImgSrc(win, url) {\n  let urlSrc = resolveRelativeUrl(url, win.location);\n  if (isProxyOrigin(win.location.href)) {\n    // TODO(Enriqe): add extra params for resized image, for example:\n    // (/ii/w${width}/s)\n    urlSrc = urlSrc.replace('/c/s/', '/i/s/');\n  }\n  return urlSrc;\n}\n\n/**\n * Whether a Story should show the URL info dialog.\n * @param {!../../../src/service/viewer-interface.ViewerInterface} viewer\n * @return {boolean}\n */\nexport function shouldShowStoryUrlInfo(viewer) {\n  const showStoryUrlInfo = viewer.getParam('showStoryUrlInfo');\n  return showStoryUrlInfo ? showStoryUrlInfo !== '0' : viewer.isEmbedded();\n}\n\n/**\n * Retrieves an attribute src from the <amp-story> element.\n * @param {!Element} element\n * @param {string} attribute\n * @param {string=} warn\n * @return {?string}\n */\nexport function getStoryAttributeSrc(element, attribute, warn = false) {\n  const storyEl = dev().assertElement(\n    closestAncestorElementBySelector(element, 'AMP-STORY')\n  );\n  const attrSrc = storyEl && storyEl.getAttribute(attribute);\n\n  if (attrSrc) {\n    assertHttpsUrl(attrSrc, storyEl, attribute);\n  } else if (warn) {\n    user().warn('AMP-STORY', `Expected ${attribute} attribute on <amp-story>`);\n  }\n\n  return attrSrc;\n}\n\n/**\n * The attribute name for text background color\n * @private @const {string}\n */\nconst TEXT_BACKGROUND_COLOR_ATTRIBUTE_NAME = 'data-text-background-color';\n\n/**\n * The selector for text background color\n * @private @const {string}\n */\nconst TEXT_BACKGROUND_COLOR_SELECTOR = `[${TEXT_BACKGROUND_COLOR_ATTRIBUTE_NAME}]`;\n\n/**\n * Styles text with a background color based on the value of\n * the data-text-background-color attribute\n * @param {!Element} element\n */\nexport function setTextBackgroundColor(element) {\n  const elementsToUpgradeStyles = scopedQuerySelectorAll(\n    element,\n    TEXT_BACKGROUND_COLOR_SELECTOR\n  );\n\n  Array.prototype.forEach.call(elementsToUpgradeStyles, (el) => {\n    const color = el.getAttribute(TEXT_BACKGROUND_COLOR_ATTRIBUTE_NAME);\n    setStyle(el, 'background-color', color);\n  });\n}\n\n/**\n * Click a clone of the anchor in the context of the light dom.\n * Used to apply linker logic on shadow-dom anchors.\n * @param {!Element} anchorElement\n * @param {!Element} domElement element from the light dom\n */\nexport function triggerClickFromLightDom(anchorElement, domElement) {\n  const outerAnchor = anchorElement.cloneNode();\n  toggle(outerAnchor, false);\n  domElement.appendChild(outerAnchor);\n  outerAnchor.click();\n  outerAnchor.remove();\n}\n", "export const CSS = \".i-amphtml-story-ad-link{background-color:#fff!important;border-radius:20px!important;box-sizing:border-box!important;bottom:32px!important;box-shadow:0px 2px 12px rgba(0,0,0,0.16)!important;color:#4285f4!important;font-family:Roboto,sans-serif!important;font-weight:700!important;height:36px!important;letter-spacing:0.2px!important;line-height:36px!important;overflow:hidden!important;opacity:0;padding:0 10px!important;position:absolute!important;text-align:center!important;text-decoration:none!important;min-width:120px!important;max-width:calc(100vw - 64px)}[cta-active].i-amphtml-story-ad-link{animation-delay:100ms!important;animation-duration:300ms!important;animation-timing-function:cubic-bezier(0.4,0,0.2,1)!important;animation-fill-mode:forwards!important;animation-name:ad-cta!important}@keyframes ad-cta{0%{opacity:0;transform:scale(0)}to{opacity:1;transform:scale(1)}}\\n/*# sourceURL=/extensions/amp-story-auto-ads/0.1/amp-story-auto-ads-cta-button.css*/\";\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assertHttpsUrl} from '../../../src/url';\nimport {CSS as attributionCSS} from '../../../build/amp-story-auto-ads-attribution-0.1.css';\nimport {\n  createElementWithAttributes,\n  iterateCursor,\n  openWindowDialog,\n} from '../../../src/dom';\nimport {createShadowRootWithStyle} from '../../amp-story/1.0/utils';\nimport {CSS as ctaButtonCSS} from '../../../build/amp-story-auto-ads-cta-button-0.1.css';\nimport {dev, user} from '../../../src/log';\nimport {dict, map} from '../../../src/core/types/object';\n\n/**\n * @typedef {{\n *  cta-type: ?string,\n *  cta-url: ?string,\n *  cta-landing-page-type: ?string,\n *  attribution-icon: ?string,\n *  attribution-url: ?string,\n * }}\n */\nexport let StoryAdUIMetadata;\n\n/** @const {string} */\nconst TAG = 'amp-story-auto-ads:ui';\n\n/** @const {string} */\nconst CTA_META_PREFIX = 'amp-cta-';\n\n/** @const {string} */\nconst A4A_VARS_META_PREFIX = 'amp4ads-vars-';\n\nexport const START_CTA_ANIMATION_ATTR = 'cta-active';\n\n/** @enum {string} */\nexport const A4AVarNames = {\n  ATTRIBUTION_ICON: 'attribution-icon',\n  ATTRIBUTION_URL: 'attribution-url',\n  CTA_TYPE: 'cta-type',\n  CTA_URL: 'cta-url',\n};\n\n/** @enum {string} */\nconst DataAttrs = {\n  CTA_TYPE: 'data-vars-ctatype',\n  CTA_URL: 'data-vars-ctaurl',\n};\n\n/**\n * Finds all meta tags starting with `amp4ads-vars-` or `amp-cta`.\n * @param {Document} doc\n * @return {!IArrayLike}\n */\nexport function getStoryAdMetaTags(doc) {\n  const selector = 'meta[name^=amp4ads-vars-],meta[name^=amp-cta-]';\n  return doc.querySelectorAll(selector);\n}\n\n/**\n * Creates object containing information extracted from the creative\n * that is needed to render story ad ui e.g. cta, attribution, etc.\n * @param {!Document} doc\n * @return {StoryAdUIMetadata}\n */\nexport function getStoryAdMetadataFromDoc(doc) {\n  const storyMetaTags = getStoryAdMetaTags(doc);\n  const vars = map();\n  iterateCursor(storyMetaTags, (tag) => {\n    const {content, name} = tag;\n    if (name.startsWith(CTA_META_PREFIX)) {\n      const key = name.split('amp-')[1];\n      vars[key] = content;\n    } else if (name.startsWith(A4A_VARS_META_PREFIX)) {\n      const key = name.split(A4A_VARS_META_PREFIX)[1];\n      vars[key] = content;\n    }\n  });\n  return vars;\n}\n\n/**\n * Gets story ad UI metadata from the <amp-ad> element.\n * @param {!Element} adElement\n * @return {!Object}\n */\nexport function getStoryAdMetadataFromElement(adElement) {\n  const ctaUrl = adElement.getAttribute(DataAttrs.CTA_URL);\n  const ctaType = adElement.getAttribute(DataAttrs.CTA_TYPE);\n  return {\n    [A4AVarNames.CTA_TYPE]: ctaType,\n    [A4AVarNames.CTA_URL]: ctaUrl,\n  };\n}\n\n/**\n * Returns a boolean indicating if there is sufficent metadata to render CTA.\n * @param {!StoryAdUIMetadata} metadata\n * @param {boolean=} opt_inabox\n * @return {boolean}\n */\nexport function validateCtaMetadata(metadata, opt_inabox) {\n  // If making a CTA layer we need a button name & outlink url.\n  if (!metadata[A4AVarNames.CTA_TYPE] || !metadata[A4AVarNames.CTA_URL]) {\n    // Don't polute inabox logs, as we don't know when this is intended to\n    // be a story ad.\n    !opt_inabox &&\n      user().error(TAG, 'Both CTA Type & CTA Url are required in ad response.');\n    return false;\n  }\n  return true;\n}\n\n/**\n * Creates ad attribution UI if sufficent metadata. Returns element if\n * successfully created.\n * @param {!Window} win\n * @param {!StoryAdUIMetadata} metadata\n * @param {!Element} container\n * @return {?Element}\n */\nexport function maybeCreateAttribution(win, metadata, container) {\n  const doc = win.document;\n\n  try {\n    const href = metadata[A4AVarNames.ATTRIBUTION_URL];\n    const src = metadata[A4AVarNames.ATTRIBUTION_ICON];\n\n    // Ad attribution is optional, but need both to render.\n    if (!href || !src) {\n      return null;\n    }\n\n    assertHttpsUrl(\n      href,\n      dev().assertElement(container),\n      'amp-story-auto-ads attribution url'\n    );\n\n    assertHttpsUrl(\n      src,\n      dev().assertElement(container),\n      'amp-story-auto-ads attribution icon'\n    );\n\n    const root = createElementWithAttributes(\n      doc,\n      'div',\n      dict({\n        'role': 'button',\n        'class': 'i-amphtml-attribution-host',\n      })\n    );\n\n    const adChoicesIcon = createElementWithAttributes(\n      doc,\n      'img',\n      dict({\n        'class': 'i-amphtml-story-ad-attribution',\n        'src': src,\n      })\n    );\n\n    adChoicesIcon.addEventListener('click', (unusedEvent) =>\n      handleAttributionClick(win, href)\n    );\n\n    createShadowRootWithStyle(root, adChoicesIcon, attributionCSS);\n    container.appendChild(root);\n\n    return adChoicesIcon;\n  } catch (e) {\n    // If something goes wrong creating the attribution, we still want to\n    // show the ad.\n    return null;\n  }\n}\n\n/**\n * Opens attribution click in new window.\n * @param {!Window} win\n * @param {string} href\n */\nexport function handleAttributionClick(win, href) {\n  openWindowDialog(win, href, '_blank');\n}\n\n/**\n * @param {!Document} doc\n * @param {!./story-ad-button-text-fitter.ButtonTextFitter} buttonFitter\n * @param {!Element} container\n * @param {!StoryAdUIMetadata} uiMetadata\n * @return {!Promise<?Element>} If anchor was successfully created.\n */\nexport function createCta(doc, buttonFitter, container, uiMetadata) {\n  const ctaUrl = uiMetadata[A4AVarNames.CTA_URL];\n  const ctaText = uiMetadata[A4AVarNames.CTA_TYPE];\n\n  const a = createElementWithAttributes(\n    doc,\n    'a',\n    dict({\n      'class': 'i-amphtml-story-ad-link',\n      'target': '_blank',\n      'href': ctaUrl,\n    })\n  );\n\n  const fitPromise = buttonFitter.fit(\n    dev().assertElement(container),\n    a, // Container\n    ctaText // Content\n  );\n\n  return fitPromise.then((success) => {\n    if (!success) {\n      user().warn(TAG, 'CTA button text is too long. Ad was discarded.');\n      return null;\n    }\n\n    a.href = ctaUrl;\n    a.textContent = ctaText;\n\n    if (a.protocol !== 'https:' && a.protocol !== 'http:') {\n      user().warn(TAG, 'CTA url is not valid. Ad was discarded');\n      return null;\n    }\n\n    const ctaLayer = doc.createElement('amp-story-cta-layer');\n    ctaLayer.className = 'i-amphtml-cta-container';\n\n    const linkRoot = createElementWithAttributes(\n      doc,\n      'div',\n      dict({\n        'class': 'i-amphtml-story-ad-link-root',\n        'role': 'button',\n      })\n    );\n\n    createShadowRootWithStyle(linkRoot, a, ctaButtonCSS);\n\n    ctaLayer.appendChild(linkRoot);\n    container.appendChild(ctaLayer);\n    return a;\n  });\n}\n", "export const CSS = \"amp-story-cta-layer{display:block!important;position:absolute!important;top:80%!important;right:0!important;bottom:0!important;left:0!important;margin:0!important;z-index:3!important}\\n/*# sourceURL=/extensions/amp-story-auto-ads/0.1/amp-story-auto-ads-inabox.css*/\";\n", "export const CSS = \".i-amphtml-story-ad-link-root{all:initial!important;color:initial!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-direction:column!important;flex-direction:column!important;-ms-flex-align:center!important;align-items:center!important}\\n/*# sourceURL=/extensions/amp-story-auto-ads/0.1/amp-story-auto-ads-shared.css*/\";\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ButtonTextFitter} from '../../extensions/amp-story-auto-ads/0.1/story-ad-button-text-fitter';\nimport {\n  START_CTA_ANIMATION_ATTR,\n  createCta,\n  getStoryAdMetadataFromDoc,\n  maybeCreateAttribution,\n  validateCtaMetadata,\n} from '../../extensions/amp-story-auto-ads/0.1/story-ad-ui';\nimport {CSS as inaboxCSS} from '../../build/amp-story-auto-ads-inabox-0.1.css';\nimport {installStylesForDoc} from '../style-installer';\nimport {CSS as sharedCSS} from '../../build/amp-story-auto-ads-shared-0.1.css';\n\n/**\n * If story ad metatags exist, render this creative as a story ad.\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function maybeRenderInaboxAsStoryAd(ampdoc) {\n  const {win} = ampdoc;\n  const doc = win.document;\n  const storyAdMetadata = getStoryAdMetadataFromDoc(doc);\n  if (!validateCtaMetadata(storyAdMetadata, true /* opt_inabox */)) {\n    return;\n  }\n  installStylesForDoc(ampdoc, sharedCSS + inaboxCSS, () => {});\n  maybeCreateAttribution(win, storyAdMetadata, doc.body);\n\n  const buttonFitter = new ButtonTextFitter(ampdoc);\n  const ctaContainer = doc.createElement('div');\n\n  // TODO(ccordry): maybe use inOb for visible signal to fire animation\n  // across amp & inabox environments.\n  createCta(doc, buttonFitter, ctaContainer, storyAdMetadata).then(\n    (ctaAnchor) =>\n      ctaAnchor && ctaAnchor.setAttribute(START_CTA_ANIMATION_ATTR, '')\n  );\n\n  doc.body.appendChild(ctaContainer);\n\n  if (win.parent) {\n    win.parent./*OK*/ postMessage('amp-story-ad-load', '*');\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode, isModeDevelopment} from './mode';\nimport {loadPromise} from './event-helper';\nimport {parseQueryString} from './core/types/string/url';\nimport {urls} from './config';\n\n/**\n * Triggers validation for the current document if there is a script in the\n * page that has a \"development\" attribute and the bypass validation via\n * #validate=0 is absent.\n *\n * @param {!Window} win Destination window for the new element.\n */\nexport function maybeValidate(win) {\n  const filename = win.location.href;\n  if (filename.startsWith('about:')) {\n    // Should only happen in tests.\n    return;\n  }\n  let validator = false;\n  if (isModeDevelopment(win)) {\n    const hash = parseQueryString(\n      win.location['originalHash'] || win.location.hash\n    );\n    validator = hash['validate'] !== '0';\n  }\n\n  if (validator) {\n    loadScript(win.document, `${urls.cdn}/v0/validator_wasm.js`).then(() => {\n      /* global amp: false */\n      amp.validator.validateUrlAndLog(filename, win.document);\n    });\n  } else if (getMode().examiner) {\n    loadScript(win.document, `${urls.cdn}/examiner.js`);\n  }\n}\n\n/**\n * Loads script\n *\n * @param {Document} doc\n * @param {string} url\n * @return {!Promise}\n */\nexport function loadScript(doc, url) {\n  const script = /** @type {!HTMLScriptElement} */ (\n    doc.createElement('script')\n  );\n  script.src = url;\n\n  // Propagate nonce to all generated script tags.\n  const currentScript = doc.head.querySelector('script[nonce]');\n  if (currentScript) {\n    script.setAttribute('nonce', currentScript.getAttribute('nonce'));\n  }\n\n  const promise = loadPromise(script).then(\n    () => {\n      doc.head.removeChild(script);\n    },\n    () => {}\n  );\n  doc.head.appendChild(script);\n  return promise;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * The entry point for AMP inabox runtime (inabox-v0.js).\n */\n\nimport '../polyfills';\nimport {Navigation} from '../service/navigation';\nimport {Services} from '../services';\nimport {TickLabel} from '../core/constants/enums';\nimport {adopt} from '../runtime';\nimport {allowLongTasksInChunking, startupChunk} from '../chunk';\nimport {cssText as ampSharedCss} from '../../build/ampshared.css';\nimport {doNotTrackImpression} from '../impression';\nimport {fontStylesheetTimeout} from '../font-stylesheet-timeout';\nimport {getA4AId, registerIniLoadListener} from './utils';\nimport {getMode} from '../mode';\nimport {installAmpdocServicesForInabox} from './inabox-services';\nimport {\n  installBuiltinElements,\n  installRuntimeServices,\n} from '../service/core-services';\nimport {installDocService} from '../service/ampdoc-impl';\nimport {installErrorReporting} from '../error-reporting';\nimport {installPerformanceService} from '../service/performance-impl';\nimport {installPlatformService} from '../service/platform-impl';\nimport {\n  installStylesForDoc,\n  makeBodyVisible,\n  makeBodyVisibleRecovery,\n} from '../style-installer';\nimport {internalRuntimeVersion} from '../internal-version';\nimport {maybeRenderInaboxAsStoryAd} from './inabox-story-ad';\nimport {maybeValidate} from '../validator-integration';\nimport {stubElementsForDoc} from '../service/custom-element-registry';\n\ngetMode(self).runtime = 'inabox';\ngetMode(self).a4aId = getA4AId(self);\n\n// TODO(lannka): only install the necessary services.\n\n/** @type {!../service/ampdoc-impl.AmpDocService} */\nlet ampdocService;\n// We must under all circumstances call makeBodyVisible.\n// It is much better to have AMP tags not rendered than having\n// a completely blank page.\ntry {\n  // Should happen first.\n  installErrorReporting(self); // Also calls makeBodyVisibleRecovery on errors.\n\n  // Declare that this runtime will support a single root doc. Should happen\n  // as early as possible.\n  installDocService(self, /* isSingleDoc */ true);\n  ampdocService = Services.ampdocServiceFor(self);\n} catch (e) {\n  // In case of an error call this.\n  makeBodyVisibleRecovery(self.document);\n  throw e;\n}\nallowLongTasksInChunking();\nstartupChunk(self.document, function initial() {\n  /** @const {!../service/ampdoc-impl.AmpDoc} */\n  const ampdoc = ampdocService.getAmpDoc(self.document);\n  installPlatformService(self);\n  installPerformanceService(self);\n  /** @const {!../service/performance-impl.Performance} */\n  const perf = Services.performanceFor(self);\n  perf.tick(TickLabel.INSTALL_STYLES);\n\n  self.document.documentElement.classList.add('i-amphtml-inabox');\n  installStylesForDoc(\n    ampdoc,\n    // TODO: Can this be eliminated in ESM mode?\n    ampSharedCss +\n      'html.i-amphtml-inabox{width:100%!important;height:100%!important}',\n    () => {\n      startupChunk(self.document, function services() {\n        // Core services.\n        installRuntimeServices(self);\n        fontStylesheetTimeout(self);\n        installAmpdocServicesForInabox(ampdoc);\n        // We need the core services (viewer/resources) to start instrumenting\n        perf.coreServicesAvailable();\n        doNotTrackImpression();\n        registerIniLoadListener(ampdoc);\n      });\n      startupChunk(self.document, function builtins() {\n        // Builtins.\n        installBuiltinElements(self);\n      });\n      startupChunk(self.document, function adoptWindow() {\n        adopt(self);\n      });\n      startupChunk(self.document, function stub() {\n        // Pre-stub already known elements.\n        stubElementsForDoc(ampdoc);\n      });\n      startupChunk(\n        self.document,\n        function final() {\n          Navigation.installAnchorClickInterceptor(ampdoc, self);\n          maybeRenderInaboxAsStoryAd(ampdoc);\n          maybeValidate(self);\n          makeBodyVisible(self.document);\n        },\n        /* makes the body visible */ true\n      );\n      startupChunk(self.document, function finalTick() {\n        perf.tick(TickLabel.END_INSTALL_STYLES);\n        Services.resourcesForDoc(ampdoc).ampInitComplete();\n        // TODO(erwinm): move invocation of the `flush` method when we have the\n        // new ticks in place to batch the ticks properly.\n        perf.flush();\n      });\n    },\n    /* opt_isRuntimeCss */ true,\n    /* opt_ext */ 'amp-runtime'\n  );\n});\n\n// Output a message to the console and add an attribute to the <html>\n// tag to give some information that can be used in error reports.\n// (At least by sophisticated users).\nif (self.console) {\n  (console.info || console.log).call(\n    console,\n    `Powered by AMP \u26A1 HTML \u2013 Version ${internalRuntimeVersion()}`,\n    self.location.href\n  );\n}\nself.document.documentElement.setAttribute(\n  'amp-version',\n  internalRuntimeVersion()\n);\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;MAiBM,mBAAA,2BAAA;AAEJ,gCAAc;AAAA,sBAAA,MAAA;AAEZ,WAAK,UAAU,IAAI;;;;aAIrB,iBAAQ;AACN,YAAI,KAAK,QAAQ,YAAY;AAE3B;;AAEF,aAAK,QAAQ,aAAa;AAC1B,YAAI,KAAK,QAAQ,UAAU;AACzB,cAAM,QAA+B;YACnC,QAAQ;YACR,WAAW;YACX,cAAc;YACd,UAAU,KAAK;YACf,iBAAiB,KAAK;;AAExB,eAAK,QAAQ,SAAS;;;;;WAK1B,eAAa;AACX,eAAO,KAAK;;;;;MAKV,cAAA,2BAAA;AAEJ,4BAAc;AAAA,sBAAA,MAAA;AAEZ,WAAK,aAAa;AAElB,WAAK,WAAW;;;;WAIlB,eAAc;AACZ,eAAO,KAAK;;;;WAId,eAAc;AACZ,eAAO,KAAK;;WAId,aAAY,OAAO;AACjB,aAAK,WAAW;;;;;AAQb,mBAAiB,KAAK;AAC3B,QAAI,IAAI,iBAAiB;AACvB;;AAEF,WAAO,eAAe,KAAK,mBAAmB;MAC5C,cAAc;MACd,YAAY;MACZ,UAAU;MACV,OAAO;;AAET,WAAO,eAAe,KAAK,eAAe;MACxC,cAAc;MACd,YAAY;MACZ,UAAU;MACV,OAAO;;;;;ACrEX,oBAAkB,OAAO,eAAe;AACtC,QAAM,YAAY,iBAAiB;AAEnC,QAAM,MAAM,KAAK;AACjB,QAAI,IAAI,aAAa,IAAI,YAAY,KAAK,IAAI,MAAM,WAAW;AAC/D,WAAO,IAAI,KAAK,KAAK;AAEnB,UAAM,QAAQ,KAAK;AAGnB,UAAI,UAAU,SAAU,UAAU,SAAS,UAAU,OAAQ;AAC3D,eAAO;;;AAGX,WAAO;;AAOF,oBAAiB,KAAK;AAC3B,QAAI,CAAC,IAAI,MAAM,UAAU,UAAU;AACjC,UAAI,OAAO,eAAe,IAAI,MAAM,WAAW,YAAY;QACzD,YAAY;QACZ,cAAc;QACd,UAAU;QACV,OAAO;;;;;;;;;;;ACnCb,MAAI;AASG,6BAA2B;AAChC,QAAI,UAAU;AACZ,aAAO;;AAMT,eAAW,QAAQ,QAAQ;AAC3B,WAAO;;AAwBT,MAAa,WAEX,qBAAc;AAAA,QAAA,QAAA;AAAA,qBAAA,MAAA;AAEZ,SAAK,UAAU,IAAW,QAAQ,SAAC,KAAK,KAAQ;AAE9C,YAAK,UAAU;AAEf,YAAK,SAAS;;;AAab,sBAAoB,IAAI;AAC7B,WAAO,IAAI,QAAQ,SAAC,SAAY;AAC9B,cAAQ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChEZ,MAAA,oBAAuD,OAAO;AAA9D,MAAuB,UAAvB,kBAAO;AAAP,MAA0C,YAA1C,kBAAgC;AAOzB,oBAAkB,OAAO;AAC9B,WAAO,UAAU,KAAK,WAAW;;AAW5B,eAAa,aAAa;AAC/B,QAAM,MAAM,OAAO,OAAO;AAC1B,QAAI,aAAa;AACf,aAAO,OAAO,KAAK;;AAErB,WAAO;;AAcF,gBAAc,aAAa;AAGhC,WAAmC,eAAe;;AAW7C,kBAAgB,KAAK,KAAK;AAC/B,WAAO,QAAQ,KAAK,KAAK;;AAuJpB,2BAAyB,KAAK,MAAM;AAEzC,QAAI,QAAQ,KAAK;AACf,aAAO;;AAGT,QAAM,QAAQ,KAAK,MAAM;AACzB,QAAI,QAAQ;AACZ,aAAA,YAAA,gCAAmB,QAAnB,OAAA,CAAA,SAAA,aAAA,QAA0B;AAAA,UAAf,OAAe,MAAA;AACxB,UACE,QACA,SACA,MAAM,UAAU,UAChB,OAAO,SAAS,YAChB,OAAO,OAAO,OACd;AACA,gBAAQ,MAAM;AACd;;AAEF,cAAQ;AACR;;AAEF,WAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9NF,qCAAmC,OAAO;AAC/C,QAAM,kBAAkB,OAAO,yBAAyB,OAAO;AAC/D,QAAI,mBAAJ,QAAI,gBAAiB,UAAU;AAC7B,aAAO;;AAGT,QAAO,UAAkB,MAAlB,SAAS,QAAS,MAAT;AAChB,QAAM,IAAI,IAAI,MAAM;AAEpB,aAAW,QAAQ,OAAO;AACxB,QAAE,QAAQ,MAAM;;AAGlB,MAAE,QAAQ;AACV,WAAO;;AAQF,4BAA0B,UAAU;AACzC,QAAI,QAAQ;AACZ,QAAI,UAAU;AACd,aAAA,YAAA,iCAAkB,YAAlB,OAAA,CAAA,SAAA,aAAA,QAA6B;AAAA,UAAlB,MAAkB,MAAA;AAC3B,UAAI,eAAe,SAAS,CAAC,OAAO;AAClC,gBAAQ,0BAA0B;aAC7B;AACL,YAAI,SAAS;AACX,qBAAW;;AAEb,mBAAW;;;AAIf,QAAI,CAAC,OAAO;AACV,cAAQ,IAAI,MAAM;eACT,SAAS;AAClB,YAAM,UAAU,UAAU,OAAO,MAAM;;AAEzC,WAAO;;AAQF,wBAAsB,UAAU;AACrC,QAAM,QAAQ,iBAAiB,MAAM,MAAM;AAC3C,eAAW,WAAM;AAGf,WAAK,sBAAL,OAAA,SAAA,KAAK,mBAAqB;AAC1B,YAAM;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClCV,MAAM,aAAa;AACnB,MAAM,gBAAgB,CACpB,kBACA,iBACA,aACA,iBACA,iBACA,oBACA,kBACA;AAMF,MAAM,gBAAgB;IACpB,aAAa;IACb,WAAW;;AASb,2BAAyB,aAAa,MAAM;AAC1C,QAAI,CAAC,WAAW,KAAK,SAAS,cAAc,SAAS,OAAO;AAC1D,YAAM,IAAI,YAAJ,kCAAgD,OAAhD;;;AAUV,6BAA2B,KAAK;AAC9B,QAAO,iBAAkB,IAAlB;AAEP,WAAO,CAAC,CACN,mBACA,eAAe,UACf,eAAe,OACf,eAAe;;AAUnB,qBAAmB,KAAK;AACtB,QAAM,MAAM,IAAI,YAAY;AAC5B,WAAO,IAAI,QAAQ,qBAAqB;;MAMpC,wBAAA,2BAAA;AAKJ,oCAAY,KAAK,UAAU;AAAA,uBAAA,MAAA;AAEzB,WAAK,OAAO;AAGZ,WAAK,YAAY;AAGjB,WAAK,kBAAkB;;;;aAUzB,gBAAO,MAAM,MAAM,SAAS;AAC1B,aAAK,UAAU,OAAO,MAAM,MAAM;AAIlC,YAAM,UAAU,KAAK;AACrB,YAAM,WAAW,QAAQ;AACzB,YAAI,UAAU;AACZ,mBAAS;AACT,iBAAO,QAAQ;;;;;aAUnB,aAAI,MAAM;AACR,YAAM,MAAM,KAAK,UAAU,UAAU;AACrC,YAAI,KAAK;AACP,iBAAO,IAAI;;;;;aAWf,qBAAY,MAAM;AAChB,YAAA,aAA+B,KAAK,MAA7B,WAAP,WAAO,SAAS,cAAhB,WAAgB;AAChB,wBAAgB,aAAa;AAE7B,YAAI,KAAK,UAAU,UAAU,OAAO;AAClC,iBAAO;;AAGT,YAAM,UAAU,KAAK;AACrB,YAAI,WAAW,QAAQ;AACvB,YAAI,CAAC,UAAU;AACb,qBAAW,IAAI;AACf,kBAAQ,QAAQ;;AAGlB,eAAO,SAAS;;;;aAQlB,iBAAQ,MAAM;AACZ,aAAK,UAAU,QAAQ;;;;;MASrB,WAAA,2BAAA;AAIJ,uBAAY,KAAK;AAAA,uBAAA,MAAA;AAEf,WAAK,OAAO;AAGZ,WAAK,eAAe;AAMpB,WAAK,SAAS;AAMd,WAAK,WAAW;AAQhB,WAAK,oBAAoB;AAOzB,WAAK,SAAS,CAAC,IAAI;;;;aAerB,mBAAU;AACR,YAAM,WAAU,KAAK;AACrB,aAAK,WAAW;AAChB,eAAO;;;;aAST,mBAAU,MAAM;AACd,YAAM,aAAa,KAAK,aAAa;AACrC,YAAI,YAAY;AACd,iBAAO;;;;;aAUX,0BAAiB,MAAM;AACrB,YAAM,cAAc,KAAK;AAEzB,iBAAW,QAAQ,aAAa;AAC9B,cAAM,MAAM,YAAY;AACxB,cAAI,IAAI,SAAS,MAAM;AACrB,mBAAO;;;;;;aAab,gBAAO,MAAM,MAAM,SAAS;AAC1B,YAAA,cAA6B,KAAK,MAA3B,SAAP,YAAO,OAAO,cAAd,YAAc;AAEd,YAAI,SAAS;AACX,gBAAM,IAAI,OAAM;;AAGlB,wBAAgB,aAAa;AAE7B,YAAI,KAAK,UAAU,SAAS,KAAK,iBAAiB,OAAO;AACvD,gBAAM,IAAI,OAAJ,2BAAmC,OAAnC;;AAMR,aAAK,aAAa,QAAQ;UACxB;UACA;;AAGF,aAAK,SAAS;AACd,iBAAA,YAAA,iCAAmB,KAAK,SAAxB,OAAA,CAAA,SAAA,aAAA,QAAgC;AAAA,cAArB,OAAqB,MAAA;AAC9B,eAAK,QAAQ,MAAM;;;;;aAavB,iBAAQ,MAAM,WAAW;AAIvB,YAAM,eAAe,CAAC,CAAC;AACvB,YAAM,SAAQ,aAAa,KAAK;AAChC,YAAM,oBAAoB,KAAK,UAAU,MAAM;AAE/C,iBAAA,aAAA,iCAAwB,oBAAxB,QAAA,CAAA,UAAA,cAAA,QAA2C;AAAA,cAAhC,YAAgC,OAAA;AACzC,cAAI,cAAc;AAChB,iBAAK,mBAAmB;iBACnB;AACL,iBAAK,YAAY;;;;;;aAWvB,qBAAY,MAAM;AAChB,YAAM,MAAM,KAAK,UAAU,KAAK;AAChC,YAAI,CAAC,KAAK;AACR;;AAGF,aAAK,aAAsC,MAAO;;;;aAQpD,mBAAU,MAAM,QAAO;AACrB,YAAI,CAAC,UAAS,CAAC,KAAK,kBAAkB;AAEpC,iBAAO;;AAGT,eAAO,KAAK,iBAAiB;;;;aAS/B,sBAAa,MAAM,KAAK;AACtB,YAAO,OAAQ,IAAR;AACP,YAAI,gBAAgB,MAAM;AACxB;;AAQF,aAAK,WAAW;AAChB,YAAI;AACF,cAAM,KAAK,IAAI;AAEf,cAAI,OAAO,MAAM;AACf,kBAAM,IAAI,KAAK,KAAK,MAClB;;iBAGG,GAAP;AACA,uBAAa;;;;;aAWjB,4BAAmB,MAAM;AACvB,YAAM,MAAM,KAAK,UAAU,KAAK;AAChC,YAAI,CAAC,KAAK;AACR;;AAEF,eAAoC;AACpC,aAAK,aAAa,MAAM;AAKxB,YAAI,KAAK,mBAAmB;AAC1B,cAAI;AACF,iBAAK;mBACE,GAAP;AACA,yBAAa;;;;;;aAUnB,+BAAsB,MAAM;AAG1B,eAAoC;AACpC,YAAI,KAAK,sBAAsB;AAC7B,cAAI;AACF,iBAAK;mBACE,GAAP;AACA,yBAAa;;;;;;aAoBnB,kBAAS,MAAM;AAAA,YAAA,QAAA;AACb,YAAI,KAAK,QAAQ;AACf,eAAK,UAAL,MAAmB;AACnB;;AAGF,aAAK,SAAS;AAGd,YAAM,KAAK,IAAI,KAAK,KAAK,iBAAiB,SAAC,SAAY;AACrD,cAAI,SAAS;AACX,kBAAK,eAAe;;;AAGxB,aAAK,oBAAoB;AAKzB,iBAAA,aAAA,iCAAmB,KAAK,SAAxB,QAAA,CAAA,UAAA,cAAA,QAAgC;AAAA,cAArB,OAAqB,OAAA;AAC9B,aAAG,QAAQ,MAAM;;AAGnB,uBAAe,KAAK,MAAM;;;;aAQ5B,iBAAQ,MAAM;AACZ,aAAK,OAAO,KAAK;AACjB,YAAI,KAAK,mBAAmB;AAC1B,eAAK,kBAAkB,QAAQ,MAAM;;;;;aASzC,gBAAO;AACL,YAAI,KAAK,mBAAmB;AAC1B,eAAK,eAAe,KAAK,kBAAkB;;;;;aAY/C,wBAAe,SAAS;AACtB,iBAAA,aAAA,iCAAqB,UAArB,QAAA,CAAA,UAAA,cAAA,QAA8B;AAAA,cAAnB,SAAmB,OAAA;AAC5B,cAAI,CAAC,QAAQ;AACX;;AAGF,cAAO,aAA4B,OAA5B,YAAY,eAAgB,OAAhB;AACnB,mBAAA,aAAA,iCAAmB,aAAnB,QAAA,CAAA,UAAA,cAAA,QAA+B;AAAA,gBAApB,OAAoB,OAAA;AAC7B,gBAAM,sBAAsB,KAAK,UAAU,MAAM,KAAK;AACtD,iBAAK,mBAAmB;AACxB,qBAAA,aAAA,iCAAwB,sBAAxB,QAAA,CAAA,UAAA,cAAA,QAA6C;AAAA,kBAAlC,YAAkC,OAAA;AAC3C,mBAAK,mBAAmB;;;AAI5B,mBAAA,aAAA,iCAAmB,eAAnB,QAAA,CAAA,UAAA,cAAA,QAAiC;AAAA,gBAAtB,QAAsB,OAAA;AAC/B,gBAAM,yBAAyB,KAAK,UAAU,OAAM,KAAK;AACzD,iBAAK,sBAAsB;AAC3B,qBAAA,aAAA,iCAAwB,yBAAxB,QAAA,CAAA,UAAA,cAAA,QAAgD;AAAA,kBAArC,aAAqC,OAAA;AAC9C,mBAAK,sBAAsB;;;;;;;;AAYrC,0BAAwB,KAAK,UAAU;AAAA,QAAA;AACrC,QAAO,WAAqC,IAArC,UAAU,WAA2B,IAA3B,SAAS,QAAkB,IAAlB,MAAM,WAAY,IAAZ;AAChC,QAAM,WAAW,SAAS;AAC1B,QAAM,UAAU,SAAQ;AACxB,QAAM,YAAY,MAAK;AACvB,QAAO,gBAA6B,SAA7B,eAAe,aAAc,SAAd;AACtB,QAAO,cACL,UADK,aAAa,YAClB,UADkB,WAAW,eAC7B,UAD6B,cAAc,cAC3C,UAD2C,aAAa,eACxD,UADwD;AAM1D,aAAS,gBAAgB,SAAU,MAAM;AACvC,UAAM,MAAM,SAAS,UAAU;AAC/B,UAAI,KAAK;AACP,eAAO,IAAI,IAAI;;AAEjB,aAAO,cAAc,MAAM,MAAM;;AAKnC,aAAS,aAAa,WAAY;AAChC,UAAM,WAAW,WAAW,MAAM,MAAM;AAQxC,UAAI,YAAY,SAAS,UAAU;AACjC,iBAAS,YAAY;AACrB,iBAAS,QAAQ;;AAEnB,aAAO;;AAIT,cAAU,cAAc,WAAY;AAClC,UAAM,WAAW,YAAY,MAAM,MAAM;AACzC,eAAS;AACT,aAAO;;AAIT,cAAU,eAAe,WAAY;AACnC,UAAM,WAAW,aAAa,MAAM,MAAM;AAC1C,eAAS;AACT,aAAO;;AAIT,cAAU,cAAc,WAAY;AAClC,UAAM,UAAU,YAAY,MAAM,MAAM;AACxC,eAAS;AACT,aAAO;;AAIT,cAAU,eAAe,WAAY;AACnC,UAAM,WAAW,aAAa,MAAM,MAAM;AAC1C,eAAS;AACT,aAAO;;AAIT,cAAU,YAAY,WAAY;AAChC,UAAM,SAAS,UAAU,MAAM,MAAM;AAKrC,UAAI,OAAO,kBAAkB,UAAU;AACrC,iBAAS,YAAY;AACrB,iBAAS,QAAQ;;AAEnB,aAAO;;AAMT,QAAI,iBAAiB;AACrB,QAAI,gBAAgB,OAAO,yBACzB,gBACA;AAEF,QAAI,CAAC,eAAe;AAGlB,uBAAiB,OAAO,eAAe,IAAI,YAAY;AACvD,sBAAgB,OAAO,yBACrB,gBACA;;AAGJ,QAAA,kBAAI,kBAAJ,QAAI,eAAe,cAAc;AAC/B,UAAM,kBAAkB,cAAc;AACtC,oBAAc,MAAM,SAAU,OAAM;AAClC,wBAAgB,KAAK,MAAM;AAC3B,iBAAS,QAAQ;;AAEnB,aAAO,eACmB,gBACxB,aACA;;;AASN,oBAAkB,KAAK;AACrB,QAAO,WAAkC,IAAlC,SAAS,cAAyB,IAAzB,aAAa,WAAY,IAAZ;AAC7B,QAAO,gBAAiB,SAAjB;AAEP,QAAM,WAAW,IAAI,SAAS;AAC9B,QAAM,iBAAiB,IAAI,sBAAsB,KAAK;AAKtD,WAAO,eAAe,KAAK,kBAAkB;MAC3C,YAAY;MACZ,cAAc;MAEd,OAAO;;AAKT,QAAM,UAAU,SAAQ;AACxB,QAAO,eAAkC,QAAlC,cAAc,oBAAoB,QAApB;AACrB,QAAI,cAAc;AAKhB,cAAQ,eAAe,SAAU,QAAQ;AACvC,YAAM,SAAS,aAAa,MAAM,MAAM;AACxC,iBAAS,QAAQ;AACjB,eAAO;;AAGT,cAAQ,aAAa,WAAW,WAAY;AAC1C,eAAO,aAAa;;;AAGxB,QAAI,mBAAkB;AAEpB,cAAQ,mBAAmB,WAAY;AACrC,YAAM,SAAS,kBAAiB,MAAM,MAAM;AAC5C,iBAAS,QAAQ;AACjB,eAAO;;AAGT,cAAQ,iBAAiB,WAAW,WAAY;AAC9C,eAAO,kBAAiB;;;AAU5B,mCAA+B;AAC7B,UAAO,cAAe,KAAf;AAIP,UAAI,KAAK,SAAS;AAclB,UAAI,CAAC,IAAI;AAKP,YAAM,MAAM,SAAS,iBAAiB;AACtC,aAAK,cAAc,KAAK,UAAU,IAAI;;AAOxC,qBAAe,IAAI,YAAY;AAC/B,aAAO;;AAET,aAAS,aAAa;AAGtB,QAAI,kBAAkB,IAAI;AAC1B,QAAI,cAAc;AAQlB,QAAI,CAAC,oBAAoB,MAAM;AAC7B,0BAAoB,QAAQ,IAAI,SAAS;AACzC,0BAAoB,OAAO,IAAI,SAAS;AACxC,0BAAoB,OAAO,IAAI,SAAS;;;AAc5C,2BAAyB,KAAK;AAC5B,QAAO,cAAwB,IAAxB,aAAa,WAAW,IAAX;AAEpB,kCAA8B;AAC5B,UAAM,OAAkD,KAAK;AAK7D,aAAO,SAAQ,UAAU,aAAa,IAAI;;AAE5C,aAAS,aAAa;AAGtB,QAAI,kBAAkB,IAAI;AAC1B,QAAI,cAAc;;AAWpB,oBAAkB,YAAY,WAAU;AAGtC,cAAS,YAAY,OAAO,OAAO,WAAW,WAAW;MACvD,aAAa;QAEX,cAAc;QACd,UAAU;QACV,OAAO;;;AAGX,mBAAe,WAAU;;AAQ3B,gCAA8B;AAC5B,QAAM,QAAQ;MAAC,QAAQ;;AACvB,QAAM,MAAM;AACZ,QAAI,YAAY;AAChB,WAAO,CAAC,CAAC,IAAI;;AAUf,0BAAwB,KAAK,WAAW;AACtC,QAAc,OAAO,gBAAgB;AAEnC,aAAO,eAAe,KAAK;eAClB,sBAAsB;AAE/B,UAAI,YAAY;WACX;AAEL,qBAAe,KAAK;;;AAYjB,0BAAwB,KAAK,WAAW;AAC7C,QAAI,UAAU;AACd,WAAO,YAAY,MAAM;AACvB,UAAI,OAAO,cAAc,KAAK,SAAS,MAAM;AAC3C;;AAGF,eAAA,aAAA,iCAAmB,OAAO,oBAAoB,WAA9C,QAAA,CAAA,UAAA,cAAA,QAAwD;AAAA,YAA7C,OAA6C,OAAA;AACtD,YAAI,OAAO,eAAe,KAAK,KAAK,OAAO;AACzC;;AAGF,YAAM,OACJ,OAAO,yBAAyB,SAAS;AAE3C,eAAO,eAAe,KAAK,MAAM;;AAGnC,gBAAU,OAAO,eAAe;;;AAoB7B,oBAAiB,KAAK,MAAM;AAEjC,QAAM,iBAAgB,IAAI;AAC1B,QAAM,QAAQ,kBAAkB;AAChC,QAAI,CAAC,kBAAkB,SAAS,UAAU,MAAO;AAC/C;;AAGF,QAAI,YAAU;AACd,QAAI,iBAAiB;AAErB,QAAI,QAAQ,OAAO;AAIjB,UAAI;AACF,YAAO,WAAW,IAAX;AAMP,YAAM,WAAqC,OAAO,OAAO,KAAK;AAM9D,iBAAS,KAAK,KAAK,MAAM;AAIzB,yBAAiB,CAAC,CAAC,aAAD,QAAC,SAAS;eACrB,GAAP;AAGA,oBAAU;;;AAId,QAAI,gBAAgB;AAClB,sBAAgB;eACP,WAAS;AAClB,eAAS;;;;;ACx5Bb,sCAAoC,OAAO,WAAW;AAEpD,QAAM,UAAS,cAAc,SAAY,KAAK,SAAS,SAAS,CAAC;AACjE,QAAI,SAAQ;AAEV,WAAK,OAAO;AACZ,aAAO;WACF;AAEL,WAAK,IAAI;AACT,aAAO;;;AASJ,oBAAiB,KAAK;AAC3B,QAAI,KAAK,QAAQ,IAAI,cAAc;AACjC,UAAI,OAAO,eAAe,IAAI,aAAa,WAAW,UAAU;QAC9D,YAAY;QACZ,cAAc;QACd,UAAU;QACV,OAAO;;AAGT,UAAO,MAAO,IAAI,aAAa,UAAxB;AACP,UAAI,aAAa,UAAU,MAAM,WAAY;AAC3C,iBAAS,IAAI,GAAG,IAAI,UAAU,QAAQ,KAAK;AACzC,cAAI,KAAK,MAAM,UAAU;;;;;AAWjC,gBAAc,KAAK;AACjB,WAAO,yBAAyB,KAAK,IAAI,UAAU;;;;AC5CrD,oCAAkC,MAAM;AAKtC,WAAO,QAAQ,QAAQ,KAAK,gBAAgB,SAAS;;AAOhD,oBAAiB,KAAK;AAG3B,QAAM,gBAAgB,IAAI,gBAAgB,IAAI;AAC9C,QAAI,iBAAiB,CAAC,cAAc,UAAU,UAAU;AACtD,UAAI,OAAO,eAAe,cAAc,WAAW,YAAY;QAC7D,YAAY;QACZ,cAAc;QACd,UAAU;QACV,OAAO;;;;;;ACvBN,mBAAiB,WAAW;AACjC,WAAO,YAAY,MAAM,UAAU,MAAM,KAAK,aAAa;;AAQtD,MAAO,UAAW,MAAX;AAkDP,kBAAgB,OAAO,cAAc;AAC1C,QAAM,UAAU;AAChB,QAAI,QAAQ;AACZ,aAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,UAAM,OAAO,MAAM;AACnB,UAAI,aAAa,MAAM,GAAG,QAAQ;AAChC,gBAAQ,KAAK;aACR;AACL,YAAI,QAAQ,GAAG;AACb,gBAAM,SAAS;;AAEjB;;;AAGJ,QAAI,QAAQ,MAAM,QAAQ;AACxB,YAAM,SAAS;;AAEjB,WAAO;;AAYF,qBAAmB,OAAO,WAAW;AAC1C,aAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,UAAI,UAAU,MAAM,IAAI,GAAG,QAAQ;AACjC,eAAO;;;AAGX,WAAO;;AAUF,wBAAsB,UAAU;AACrC,QAAM,QAAQ;AACd,aAAS,IAAI,SAAS,QAAQ,CAAC,EAAE,MAAM,IAAI,SAAS,QAAQ;AAC1D,YAAM,KAAK,EAAE;;AAEf,WAAO;;AA4BF,sBAAoB,OAAO,MAAM;AACtC,QAAM,QAAQ,MAAM,QAAQ;AAC5B,QAAI,SAAS,IAAI;AACf,aAAO;;AAET,UAAM,OAAO,OAAO;AACpB,WAAO;;;;AC7IF,uBAAqB,SAAS,KAAK;AACxC,aAAW,KAAK,SAAS;AACvB,UAAI,QAAQ,OAAO,KAAK;AACtB,eAAO;;;AAGX,WAAO;;;;ACoCF,oBAAkB,QAAQ,QAAQ;AACvC,QAAM,QAAQ,OAAO,SAAS,OAAO;AACrC,WAAO,SAAS,KAAK,OAAO,QAAQ,QAAQ,UAAU;;AAUjD,qBAAkB,QAAQ,WAAW,OAAO;AACjD,QAAI,OAAO,UAAU,UAAU;AAC7B,cAAQ;;AAEV,QAAI,QAAQ,UAAU,SAAS,OAAO,QAAQ;AAC5C,aAAO;;AAET,WAAO,OAAO,QAAQ,WAAW,WAAW;;AAqEvC,qBAAmB,KAAK;AAC7B,QAAI,IAAI,WAAW;AACjB,aAAO,IAAI;;AAGb,WAAQ,OAAM,KAAK,OAAO,MAAM,GAAG;;AA2D9B,oBAAkB,GAAG;AAC1B,WAAO,OAAO,KAAK;;;;AChMd,qBAAmB,OAAO;AAC/B,WAAO,UAAK,OAAL,SAAA,MAAO,aAAoC;;AAU7C,0BAAwB,OAAO;AACpC,WAAO,OAAO,UAAU,YAAY,SAAS;;;;ACZxC,MAAM,sBAAsB;AAQ5B,mCAAiC,KAAK;AAE3C,QAAI,UAAU,MAAM;AAClB,YAA8B;AAC9B,aAAO,IAAI,QAAQ,gBAAiB,KAAI,KAAJ,MAAa,IAAI,KAAO;;AAE9D,WAAO;;AAQF,8BAA4B,SAAS;AAC1C,WAAO,QAAQ,QAAQ,wBAAwB;;;;ACA1C,kBACL,UACA,gBACA,aACA,UACA;AAAA,QAFA,gBAEA,QAAA;AAFA,oBAAc;;AAGd,QAAI,gBAAgB;AAClB,aAAO;;AAIT,QAAI,YAAY,CAAC,UAAS,aAAa,WAAW;AAChD,qBAAe;;AAMjB,QAAI,IAAI;AAGR,QAAM,eAAe,YAAY,MAAM;AACvC,QAAI,UAAU,aAAa;AAC3B,QAAM,eAAe,CAAC;AAEtB,WAAO,aAAa,QAAQ;AAC1B,UAAM,WAAW,UAAU;AAC3B,UAAM,eAAe,aAAa;AAElC,iBAAW,wBAAwB,YAAY;AAC/C,mBAAa,KAAK,UAAU,aAAa;;AAG3C,QAAM,QAAQ,IAAI,MAAM;AACxB,UAAM,eAAe,OAAO,cAAc,SAAC,GAAD;AAAA,aAAO,MAAM;;AAIvD,SAAK,sBAAL,OAAA,SAAA,KAAK,mBAAqB;AAC1B,UAAM;;AAoBR,uBACE,UACA,SACA,gBACA,gBACA,aACA;AACA,QAAI,QAAQ,cAAc;AACxB,eACE,gBACuB,YAAa,OAAO,CAAC;WAEzC;AACL,eAAS,gBAAmB,gBAAe,kBAAnC,QAAyD;;AAGnE,WAAO;;AAeF,yBAAuB,UAAU,iBAAiB,aAAa;AACpE,WACE,YACE,UACA,iBACA,UAAU,kBACV,oBACA;;AAkBC,wBAAsB,UAAU,gBAAgB,aAAa;AAClE,WACE,YACE,UACA,gBACA,SAAS,iBACT,mBACA;;AAmBC,wBAAsB,UAAU,gBAAgB,aAAa;AAClE,WACE,YACE,UACA,gBACA,OAAO,kBAAkB,UACzB,mBACA;;AAkBC,uBAAqB,UAAU,eAAe,aAAa;AAChE,WACE,YACE,UACA,eACA,QAAQ,gBACR,kBACA;;AAiBC,yBAAuB,UAAU,iBAAiB,aAAa;AACpE,WACE,YACE,UACA,iBACA,CAAC,CAAC,oBAAoB,iBACtB,oBACA;;;;AC9NC,oCAAkC;AACvC,WAAO;;;;ACRT,MAAM,qBAAqB;AAUpB,iCAA+B,WAAW,UAAe;AAAA,QAAf,aAAe,QAAA;AAAf,iBAAW;;AAC1D,QAAI;AACF,aAAO,mBAAmB;aACnB,GAAP;AACA,aAAO;;;AAWJ,4BAA0B,aAAa;AAC5C,QAAM,SAAS;AACf,QAAI,CAAC,aAAa;AAChB,aAAO;;AAGT,QAAI;AACJ,WAAQ,QAAQ,mBAAmB,KAAK,cAAe;AACrD,UAAM,OAAO,sBAAsB,MAAM,IAAI,MAAM;AACnD,UAAM,QAAQ,MAAM,KAChB,sBAAsB,MAAM,GAAG,QAAQ,OAAO,MAAM,MAAM,MAC1D;AACJ,aAAO,QAAQ;;AAEjB,WAAO;;;;AChBT,MAAI,aAAa;AAOV,mBAAiB,SAAS;AAC/B,QAAM,MAAM,WAAW;AACvB,QAAI,IAAI,YAAY;AAClB,aAAO,IAAI;;AAEb,WAAQ,IAAI,aAAa,SAAS;;AAQpC,oBAAkB,KAAK;AAErB,QAAM,aAAa,KAAK,cAAc;AAMtC,QAAM,gBAAgB;AACtB,QAAM,eAAc;AAEpB,QAAM,eACJ,iBAAiB,CAAC,CAAE,YAAW,QAAQ,IAAI,cAAc,IAAI;AAC/D,QAAM,aAAa,iBAAkB,EAAC,CAAC,WAAW,YAAY;AAC9D,QAAM,YAAY,iBAGhB,IAAI,SAAS,mBAAmB,IAAI,SAAS;AAG/C,QAAI,CAAC,YAAY;AACf,mBAAa,cAAc;;AAO7B,WAAO;MACL,UAAU;MACV,aAAa,kBAAkB;MAC/B,UAAU,UAAU,kBAAkB;MACtC,KAAG;MAEH,aAAa,UAAU;MACvB,UAAU;MACV,MAAM;MACN,KAAK,UAAU;MACf,SAAS;MACT;;;AAWJ,yBAAuB,KAAK;AAC1B,QAAI,IAAI,cAAc,IAAI,WAAW,GAAG;AACtC,aAAO,IAAI,WAAW;;AAQxB,WAAA,OAAY;;AAUP,6BAA2B,KAAK;AACrC,QAAM,YAAY,iBAChB,IAAI,SAAS,mBAAmB,IAAI,SAAS;AAE/C,WAAO,CAAC,CACN,EAAC,KAAK,WAAW,OAAO,WAAW,aAAa,SAC9C,UAAU,mBACP,IAAI;;;;AC5GN,gBAAc,IAAI;AACvB,QAAI,YAAY;AAChB,QAAI,WAAW;AACf,QAAI,WAAW;AACf,WAAO,WAAa;AAClB,UAAI,CAAC,WAAW;AAAA,iBAAA,OAAA,UAAA,QADP,OACO,IAAA,MAAA,OAAA,OAAA,GAAA,OAAA,MAAA,QAAA;AADP,eACO,QAAA,UAAA;;AACd,mBAAW,SAAS,MAAM,MAAM;AAChC,oBAAY;AACZ,mBAAW;;AAEb,aAAO;;;AAgBJ,oBAAkB,KAAK,UAAU,aAAa;AACnD,QAAI,SAAS;AACb,QAAI,eAAe;AAKnB,kBAAc,MAAM;AAClB,qBAAe;AAEf,eAAS,IAAI,WAAW,QAAQ;AAEhC,eAAS,MAAM,MAAM;;AAMvB,sBAAkB;AAChB,eAAS;AAET,UAAI,cAAc;AAChB,aAAK;;;AAIT,WAAO,WAAmB;AAAA,eAAA,QAAA,UAAA,QAAN,OAAM,IAAA,MAAA,QAAA,QAAA,GAAA,QAAA,OAAA,SAAA;AAAN,aAAM,SAAA,UAAA;;AACxB,UAAI,QAAQ;AACV,uBAAe;aACV;AACL,aAAK;;;;AAiBJ,oBAAkB,KAAK,UAAU,aAAa;AACnD,QAAI,SAAS;AACb,QAAI,YAAY;AAChB,QAAI,eAAe;AAKnB,kBAAc,MAAM;AAClB,qBAAe;AACf,eAAS,MAAM,MAAM;;AAMvB,sBAAkB;AAChB,eAAS;AACT,UAAM,YAAY,cAAe,KAAI,KAAK,QAAQ;AAClD,UAAI,YAAY,GAAG;AACjB,iBAAS,IAAI,WAAW,QAAQ;aAC3B;AACL,aAAK;;;AAIT,WAAO,WAAmB;AACxB,kBAAY,IAAI,KAAK;AADG,eAAA,QAAA,UAAA,QAAN,OAAM,IAAA,MAAA,QAAA,QAAA,GAAA,QAAA,OAAA,SAAA;AAAN,aAAM,SAAA,UAAA;;AAExB,qBAAe;AACf,UAAI,CAAC,QAAQ;AACX,iBAAS,IAAI,WAAW,QAAQ;;;;;;AC9GtC,MAAM,MAAM,KAAK,cAAc;AAE/B,MAAM,uBACH,QAAO,IAAI,2BAA2B,WACnC,IAAI,OAAO,IAAI,2BACf,IAAI,4BAA4B;AAEtC,MAAM,gBACH,QAAO,IAAI,oBAAoB,WAC5B,IAAI,OAAO,IAAI,oBACf,IAAI,qBACR;AAYF,sBAAoB,MAAM;AAExB,QAAI,CAAC,KAAK,YAAY,CAAC,KAAK,SAAS,MAAM;AACzC,aAAO;;AAIT,QAAI,KAAK,YAAY,cAAc,KAAK,KAAK,SAAS,SAAS;AAC7D,aAAO;;AAGT,QAAM,SAAS,KAAK,SAAS,KAAY,cAA1B,gBACC,OADD;AAGf,WAAQ,UAAU,OAAO,aAAa,cAAe;;AAkBhD,MAAM,OAAO;IAClB,YAAY,IAAI,oBAAoB;IACpC,qBAAqB,IAAI,0BAA0B;IACnD;IACA,KACE,IAAI,aAAa,WAAW,mBAAmB;IAIjD;IACA,gBAAgB;IAChB,gBACE,IAAI,wBACJ;IACF,oBACE,IAAI,4BACJ;IACF,UAAU,IAAI,eAAe;IAU7B,oBAAoB,CAClB,qDACA;IAGF,QAAQ,IAAI,gBAAgB,WAAW;;AAGlC,MAAM,SAAS;IACpB;;;;;;;;;;;;;;;;;;;;;;;;;;ACpFF,MAAM,OAAO,iBAAM;;AAWZ,MAAM,4BAA4B;AAMlC,4BAA0B,SAAS;AACxC,WAAO,QAAQ,QAAQ,8BAA8B;;AAMhD,MAAM,WAAW;IACtB,KAAK;IACL,OAAO;IACP,MAAM;IACN,MAAM;IACN,MAAM;;AAQD,0BAAwB,IAAI;AACjC,SAAK,qBAAqB;;AAO5B,MAAI,iBAAiB;AAKd,4BAA0B,OAAO;AACtC,qBAAiB;;AASnB,MAAM,gBAAgB,0BAAA;AAAA,WAAA,OAAW;;AAQjC,MAAM,qBAAqB,6BAAC,IAAI,mBAAL;AAAA,WACzB,kBAAkB,OAChB,SAAC,QAAQ,KAAT;AAAA,aAAoB,SAApB,UAAkC,6BAA6B;OADjE,4BAE4B,kBAF5B,SAEkD,mBAAmB;;AAQvE,MAAM,iCAAiC,2CAAA;AAAA,WAClC,KAAK,MAD6B,UAClB,kBADkB;;AAOvC,MAAM,+BAA+B,uCAAC,KAAD;AAAA,WACnC,mBAAmB,OAAO,wBAAwB;;AAYpD,MAAa,MAAb,2BAAA;AAYE,kBAAY,KAAK,WAAW,YAAiB;AAAA,UAAA,QAAA;AAAA,UAAjB,eAAiB,QAAA;AAAjB,qBAAa;;AAAI,uBAAA,MAAA;AAM3C,WAAK,MAAM,UAAU,QAAQ,IAAI,oBAAoB,IAAI,SAAS;AAGlE,WAAK,aAAa;AAGlB,WAAK,SAAS,KAAK;AAGnB,WAAK,UAAU;AAGf,WAAK,YAAY;AAEjB,WAAK,6BAA6B,KAAK,WAAM;AAC3C,YACG,MAAM,kCACN,KAAK,SAAC,UAAD;AAAA,iBAAc,SAAS;WAAQ,MACpC,KAAK,SAAC,cAAiB;AACtB,cAAI,cAAc;AAChB,kBAAK,YAAwC;;;;AAUrD,WAAK,iBACH,KAAK,OAAO,KAAK;;AAjDvB,kBAAA,MAAA,CAAA;MAAA,KAAA;MAAA,OAyDE,qBAAY;AACV,eAAO,mBAAmB,SAAY,iBAAiB,KAAK;;OA1DhE;MAAA,KAAA;MAAA,OAiEE,yBAAgB;AAEd,YAAI,CAAC,KAAK,IAAI,WAAW,CAAC,KAAK,IAAI,QAAQ,KAAK;AAC9C,iBAAO,SAAS;;AAIlB,YAAI,UAAU,OAAO,KAAK;AACxB,iBAAO,SAAS;;AAIlB,YAAI,UAAU,QAAQ,KAAK,IAAI,YAAY;AACzC,iBAAO,SAAS;;AAIlB,YAAI,UAAU,YAAY,CAAC,UAAU,KAAK;AACxC,iBAAO,SAAS;;AAGlB,eAAO,KAAK;;OAtFhB;MAAA,KAAA;MAAA,OA6FE,iCAAwB;AAEtB,eAAO,KAAK,WAAW,SAAS,UAAU,KAAK,KAAK,UAAU;;OA/FlE;MAAA,KAAA;MAAA,OAwGE,cAAK,KAAK,OAAO,UAAU;AACzB,YAAI,KAAK,cAAc,OAAO;AAC5B,iBAAO;;AAET,YAAI,KAAK,KAAK,IAAI,QAAQ;AAC1B,YAAI,SAAS,SAAS,OAAO;AAC3B,eAAK,KAAK,IAAI,QAAQ,SAAS;mBACtB,SAAS,SAAS,MAAM;AACjC,eAAK,KAAK,IAAI,QAAQ,QAAQ;mBACrB,SAAS,SAAS,MAAM;AACjC,eAAK,KAAK,IAAI,QAAQ,QAAQ;;AAEhC,YAAM,OAAO,KAAK,wBAAwB;AAE1C,YAAM,SAAM,MAAO,MAAP;AACZ,YAAI,OAAO,KAAK,OAAO,UAAU;AAE/B,eAAK,KAAK,SAAS,MAAM,KAAK;eACzB;AACL,eAAK,QAAQ;;AAEf,WAAG,MAAM,KAAK,IAAI,SAAS;AAC3B,eAAO;;OA9HX;MAAA,KAAA;MAAA,OAqIE,sBAAY;AACV,eAAO,KAAK,eAAe,SAAS;;OAtIxC;MAAA,KAAA;MAAA,OA8IE,cAAK,KAAc;AAAA,iBAAA,OAAA,UAAA,QAAN,OAAM,IAAA,MAAA,OAAA,IAAA,OAAA,IAAA,IAAA,OAAA,GAAA,OAAA,MAAA,QAAA;AAAN,eAAM,OAAA,KAAA,UAAA;;AACjB,aAAK,KAAK,KAAK,SAAS,MAAM;;OA/IlC;MAAA,KAAA;MAAA,OAuJE,cAAK,KAAc;AAAA,iBAAA,QAAA,UAAA,QAAN,OAAM,IAAA,MAAA,QAAA,IAAA,QAAA,IAAA,IAAA,QAAA,GAAA,QAAA,OAAA,SAAA;AAAN,eAAM,QAAA,KAAA,UAAA;;AACjB,aAAK,KAAK,KAAK,SAAS,MAAM;;OAxJlC;MAAA,KAAA;MAAA,OAgKE,cAAK,KAAc;AAAA,iBAAA,QAAA,UAAA,QAAN,OAAM,IAAA,MAAA,QAAA,IAAA,QAAA,IAAA,IAAA,QAAA,GAAA,QAAA,OAAA,SAAA;AAAN,eAAM,QAAA,KAAA,UAAA;;AACjB,aAAK,KAAK,KAAK,SAAS,MAAM;;OAjKlC;MAAA,KAAA;MAAA,OA4KE,gBAAO,KAAc;AAAA,iBAAA,QAAA,UAAA,QAAN,OAAM,IAAA,MAAA,QAAA,IAAA,QAAA,IAAA,IAAA,QAAA,GAAA,QAAA,OAAA,SAAA;AAAN,eAAM,QAAA,KAAA,UAAA;;AACnB,YAAI,CAAC,KAAK,KAAK,KAAK,SAAS,OAAO,OAAO;AACzC,iBAAO,KAAK,YAAY,MAAM,MAAM;;;OA9K1C;MAAA,KAAA;MAAA,OAuLE,eAAM,KAAK,UAAU;AACnB,YAAM,SAAQ,KAAK,OAAO,MAAM,MAAM;AACtC,YAAI,QAAO;AAET,iBAAM,OAAO,OAAO,OAAM;AAE1B,eAAK,mBAAmB;;;OA7L9B;MAAA,KAAA;MAAA,OAuME,uBAAc,WAAW,UAAU;AACjC,YAAM,QAAQ,KAAK,OAAO,MAAM,MAAM;AACtC,YAAI,OAAO;AACT,gBAAM,WAAW;AAEjB,eAAK,mBAAmB;;;OA5M9B;MAAA,KAAA;MAAA,OAqNE,qBAAY,UAAU;AACpB,YAAM,QAAQ,iBAAiB,MAAM,MAAM;AAC3C,aAAK,cAAc;AACnB,eAAO;;OAxNX;MAAA,KAAA;MAAA,OAgOE,6BAAoB,UAAU;AAC5B,YAAM,QAAQ,iBAAiB,MAAM,MAAM;AAC3C,aAAK,cAAc;AACnB,cAAM,WAAW;AACjB,eAAO;;OApOX;MAAA,KAAA;MAAA,OA4PE,iBAAO,iBAAiB,aAAa,UAAU;AAC7C,YAAI,QAAQ,cAAc;AACxB,iBAAO,KAAK,OAAO,MACjB,MACA,CAAC,iBAAiB,OAChB,KAAK,mBAA0C;;AAKrD,eAAO,AAAW,OAAO,MACvB,MACA,CAAC,KAAK,SAAS,OAAO,MAAM,UAAU,MAAM,KAAK;;OAxQvD;MAAA,KAAA;MAAA,OAsRE,wBAAc,iBAAiB,aAAa;AAC1C,eAAO,AAAW,cAChB,KAAK,gBACL,iBACA;;OA1RN;MAAA,KAAA;MAAA,OAySE,uBAAa,gBAAgB,aAAa;AACxC,eAAO,AAAW,aAChB,KAAK,gBACL,gBACA;;OA7SN;MAAA,KAAA;MAAA,OA6TE,uBAAa,gBAAgB,aAAa;AACxC,eAAO,AAAW,aAChB,KAAK,gBACL,gBACA;;OAjUN;MAAA,KAAA;MAAA,OA8UE,sBAAY,eAAe,aAAa;AACtC,eAAO,AAAW,YAChB,KAAK,gBACL,eACA;;OAlVN;MAAA,KAAA;MAAA,OAgWE,wBAAc,iBAAiB,aAAa;AAC1C,eAAO,AAAW,cAChB,KAAK,gBACL,iBACA;;OApWN;MAAA,KAAA;MAAA,OA4WE,uBAAc,OAAO;AACnB,gBAAQ,0BAA0B;AAElC,YAAI,KAAK,SAAS;AAChB,cAAI,CAAC,MAAM,SAAS;AAClB,kBAAM,UAAU,KAAK;qBACZ,MAAM,QAAQ,QAAQ,KAAK,YAAY,IAAI;AACpD,kBAAM,WAAW,KAAK;;mBAEf,mBAAmB,MAAM,UAAU;AAC5C,gBAAM,UAAU,MAAM,QAAQ,QAAQ,qBAAqB;;;OAtXjE;MAAA,KAAA;MAAA,OA+XE,iCAAwB,MAAM;AAC5B,YAAI,QAAQ,KAAK,KAAK;AACpB,iBAAO,KAAK,mBAA0C,KAAK;;AAE7D,eAAO;;OAnYX;MAAA,KAAA;MAAA,OAkZE,4BAAmB,OAAO;AAExB,YAAM,KAAK,MAAM;AAKjB,YAAI,QAAQ,KAAK,KAAK,aAAa;AACjC,eAAK;;AAEP,YAAI,KAAK,aAAa,MAAM,KAAK,WAAW;AAC1C,iBAAO,CAAC,KAAK,UAAU,KAAK,OAAO;;AAErC,eAAO,CAAA,kBAAiB,mBAAmB,IAAI;;;AA/ZnD,WAAA;;AAwaA,OAAK,YAAY,KAAK,aAAa;IACjC,MAAM;IACN,KAAK;IACL,cAAc;;AAGhB,MAAM,OAAO,KAAK;AAQlB,MAAI,iBAAiB;AAKd,gCAA8B;AACnC,qBAAiB;AASjB;AACA;;AAsBK,gBAAc,aAAa;AAChC,QAAI,CAAC,KAAK,MAAM;AACd,WAAK,OAAO,cAAc;;AAE5B,QAAI,CAAC,YAAY,KAAK,KAAK,KAAK,cAAc;AAC5C,aAAO,KAAK;WACP;AACL,UAAI,KAAK,cAAc;AACrB,eAAO,KAAK;;AAEd,aAAQ,KAAK,eAAe,cAAc;;;AAS9C,yBAAuB,QAAQ;AAC7B,QAAI,CAAC,gBAAgB;AACnB,YAAM,IAAI,MAAM;;AAElB,WAAO,IAAI,eACT,MACA,SAAC,QAAQ,aAAgB;AACvB,UAAI,eAAe,UAAU,GAAG;AAC9B,eAAO,SAAS;;AAElB,aAAO,SAAS;OAElB;;AAgBG,iBAAe;AACpB,QAAI,KAAK,KAAK;AACZ,aAAO,KAAK;;AAEd,QAAI,CAAC,gBAAgB;AACnB,YAAM,IAAI,MAAM;;AAElB,WAAQ,KAAK,MAAM,IAAI,eAAe,MAAM,SAAC,QAAW;AACtD,UAAI,UAAU,GAAG;AACf,eAAO,SAAS;;AAElB,UAAI,UAAU,GAAG;AACf,eAAO,SAAS;;AAElB,aAAO,SAAS;;;AASb,uBAAqB,KAAK,aAAa;AAC5C,QAAI,CAAC,aAAa;AAChB,aAAO;;AAET,WAAO,YAAY,cAAc,eAAe;;AAgC3C,qBACL,iBACA,aACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA;AACA,QAAI,UAAU,UAAU;AACtB,aAAO;;AAET,QAAI,KAAK,uBAAuB;AAK9B,cACG,IAAI;;AAGT,WAAO,MAAoB,OACzB,iBACA,aACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA;;AAiCG,sBACL,iBACA,aACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA;AACA,WAAO,OAAqB,OAC1B,iBACA,aACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA;;;;AClxBJ,MAAM,cAAc;AAMb,4BAA0B;AAC/B,WAAO;;;;ACKT,+BAA6B;AAC3B,QAAI,KAAK,uBAAuB;AAC9B,cACG,IAAI;;;AAuBJ,sBACL,gBACA,aACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA;AACA,QAAI,kBAAkB;AACpB,aAAO;;AAET;AAEA,WAAO,AAAW,OAChB,IACA,gBACA,aACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA;;AAeG,4BAA0B,iBAAiB,aAAa;AAC7D,QAAI,kBAAkB;AACpB,aAAgC;;AAElC;AAEA,WAAO,AAAW,cACiC,YACjD,iBACA;;;;ACpDG,uBACL,gBACA,aACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA;AACA,WAAO,AAAW,OAChB,qBACA,gBACA,aACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA;;;;ACjBG,qBAAmB,MAAM;AAC9B,WAAmC,KAAK,MAAM;;AAYzC,wBAAsB,MAAM,cAAc;AAC/C,QAAI;AACF,aAAO,UAAU;aACV,GAAP;AACA,sBAAY,OAAZ,SAAA,aAAe;AACf,aAAO;;;;;AChDJ,sBAAoB,QAAQ;AACjC,QAAI,OAAO,gBAAgB,aAAa;AACtC,aAAO,IAAI,YAAY,SAAS,OAAO;;AAEzC,WAAO,cAAc,SAAS,mBAAmB;;AAU5C,yBAAuB,KAAK;AACjC,QAAM,QAAQ,IAAI,WAAW,IAAI;AACjC,aAAS,IAAI,GAAG,IAAI,IAAI,QAAQ,KAAK;AACnC,UAAM,WAAW,IAAI,WAAW;AAChC,iBAAU,YAAY,KAAK;AAC3B,YAAM,KAAK;;AAEb,WAAO;;AAQF,yBAAuB,OAAO;AAGnC,QAAM,QAAQ,IAAI,MAAM,MAAM;AAC9B,aAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,YAAM,KAAK,OAAO,aAAa,MAAM;;AAEvC,WAAO,MAAM,KAAK;;AA6Bb,qCAAmC,KAAK,QAAQ;AACrD,QAAK,SAAU,IAAV;AAGL,QAAI,MAAS;AACX,eACE,UAAU,IAAI;AAEhB,UAAI,CAAC,UAAU,CAAC,OAAO,iBAAiB;AACtC,eAAO;;;AAMX,QAAM,aAAa,IAAI,WAAW;AAClC,WAAO,gBAAgB;AACvB,WAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/FT,MAAM,oBAAoB;IACxB,UAAU;IACV,MAAM;;AAIR,MAAM,iBAAiB,CAAC,OAAO;AA2BxB,yBAAuB,OAAO,MAAW;AAAA,QAAX,SAAW,QAAA;AAAX,aAAO;;AAC1C,WAAO,IAAI,QAAQ,SAAU,SAAS,QAAQ;AAC5C,UAAM,gBAAgB,gBAAgB,KAAK,UAAU;AACrD,UAAM,MAAM,iBAAiB,eAAe;AAE5C,UAAI,KAAK,eAAe,WAAW;AACjC,YAAI,kBAAkB;;AAGxB,UAAI,KAAK,gBAAgB,mBAAmB;AAC1C,YAAI,eAAe,KAAK;;AAG1B,UAAI,KAAK,SAAS;AAChB,eAAO,KAAK,KAAK,SAAS,QAAQ,SAAU,QAAQ;AAClD,cAAI,iBAAiB,QAAQ,KAAK,QAAQ;;;AAI9C,UAAI,qBAAqB,WAAM;AAC7B,YAAI,IAAI,aAAmC,GAAG;AAC5C;;AAEF,YAAI,IAAI,SAAS,OAAO,IAAI,SAAS,KAAK;AACxC,cAAI,qBAAqB;AACzB,iBAAO,OAAO,oBAAP,yBAAkD,IAAI;AAC7D;;AAMF,YAAI,IAAI,cAA6B,GAAG;AACtC,kBAAQ,IAAI,cAAc;;;AAG9B,UAAI,UAAU,WAAM;AAClB,eAAO,OAAO,oBAAoB;;AAEpC,UAAI,UAAU,WAAM;AAClB,eAAO,OAAO,oBAAoB;;AAGpC,UAAI,iBAAiB,QAAQ;AAC3B,YAAI,KAAK,KAAK;aACT;AACL,YAAI;;;;AAUV,4BAA0B,QAAQ,KAAK;AACrC,QAAM,MAAM,IAAI;AAChB,QAAI,qBAAqB,KAAK;AAC5B,UAAI,KAAK,QAAQ,KAAK;WACjB;AACL,YAAM,MAAM,oBAAoB;;AAElC,WAAO;;MAQH,gBAAA,2BAAA;AAIJ,4BAAY,KAAK;AAAA,uBAAA,MAAA;AAEf,WAAK,OAAO;AAGZ,WAAK,SAAS,KAAK,KAAK;AAGxB,WAAK,aAAa,KAAK,KAAK;AAG5B,WAAK,KAAK,KAAK,UAAU,OAAO,KAAK,SAAS;AAG9C,WAAK,UAAU,IAAI,qBAAqB;AAGxC,WAAK,WAAW;AAGhB,WAAK,OAAO;AAGZ,WAAK,MAAM,IAAI;;;;aAOjB,iBAAQ;AACN,mBAAU,CAAC,KAAK,UAAU;AAC1B,eAAO,IAAI,eAAc,KAAK;;;;aAQhC,sBAAa;AACX,mBAAU,CAAC,KAAK,UAAU;AAC1B,aAAK,WAAW;AAChB,eAAO,QAAQ,QAAQ,KAAK,KAAK;;;;aAQnC,gBAAO;AACL,eAAO,KAAK;;;;aAOd,gBAAO;AACL,eACE,KAAK,aAAa,KAAK;;;;aAS3B,uBAAc;AACZ,eACE,KAAK,aAAa,KAAK;;;;;AAW7B,2BAAyB,QAAQ;AAC/B,QAAI,WAAW,QAAW;AACxB,aAAO;;AAET,aAAS,OAAO;AAChB,eACE,eAAe,SAAS,SACxB,+CACA,eAAe,KAAK,OACpB;AAEF,WAAO;;MAOH,uBAAA,2BAAA;AAIJ,mCAAY,KAAK;AAAA,uBAAA,MAAA;AAEf,WAAK,OAAO;;;;aAOd,aAAI,MAAM;AACR,eAAO,KAAK,KAAK,kBAAkB;;;;aAOrC,aAAI,MAAM;AACR,eAAO,KAAK,KAAK,kBAAkB,SAAS;;;;;AAIhD,MAAa,YAAb,yBAAA,gBAAA;AAAA,cAAA,WAAA;AAAA,QAAA,SAAA,aAAA;AAME,uBAAY,MAAM,MAAW;AAAA,UAAX,SAAW,QAAA;AAAX,eAAO;;AAAI,uBAAA,MAAA;AAC3B,UAAM,oBAAoB;AAC1B,UAAM,OAAI,SAAA;QACR,QAAQ;QACR,YAAY;QACZ,cAAc,OAAO,OAAO,QAAQ;QACpC,mBAJQ,2BAIU,MAAM;AACtB,cAAM,aAAa,OAAO,MAAM;AAChC,iBAAO,OAAO,mBAAmB,cAC7B,kBAAkB,cAClB;;SAEH;AAGL,WAAK,SAAS,KAAK,WAAW,SAAY,MAAM,SAAS,KAAK,QAAQ;AAEtE,UAAI,QAAQ,KAAK,UAAU;AACF,aAAK,QAAS,QAAQ,SAAC,OAAU;AACtD,cAAM,aAAa,MAAM;AACzB,cAAM,cAAc,MAAM;AAC1B,4BAAkB,OAAO,YAAY,iBACnC,OAAO;;iBAEF,SAAS,KAAK,UAAU;AACjC,iBAAW,OAAO,KAAK,SAAS;AAC9B,4BAAkB,OAAO,KAAK,iBAAiB,OAC7C,KAAK,QAAQ;;;AAKnB,UAAI,KAAK,YAAY;AACnB,aAAK,aAAa,OAAO,KAAK;;AAjCL,aAAA,OAAA,KAAA,MAoCa;;AA1C5C,WAAA;IAA8B;AAkDvB,oBAAiB,KAAK;AAC3B,QAAI,CAAC,IAAI,OAAO;AACd,aAAO,eAAe,KAAK,SAAS;QAClC,OAAO;QACP,UAAU;QACV,YAAY;QACZ,cAAc;;AAEhB,aAAO,eAAe,KAAK,YAAY;QACrC,OAAO;QACP,UAAU;QACV,YAAY;QACZ,cAAc;;;;;;AC3Nb,0BAAwB,MAAM,KAAK,OAAO,QAAQ;AACvD,WAAO;MACL;MACA;MACA;MACA;MACA,QAAQ,MAAM;MACd,OAAO,OAAO;MACd,GAAG;MACH,GAAG;;;AAUA,iCAA+B,MAAM;AAC1C,WAAO,eACL,OAAO,KAAK,OACZ,OAAO,KAAK,MACZ,OAAO,KAAK,QACZ,OAAO,KAAK;;AAUT,wBAAsB,IAAI,IAAI;AACnC,WACE,GAAG,OAAO,GAAG,UACb,GAAG,OAAO,GAAG,UACb,GAAG,QAAQ,GAAG,SACd,GAAG,QAAQ,GAAG;;AASX,4BAA0B,UAAU;AACzC,QAAI,KAAK;AACT,QAAI,KAAK;AACT,QAAI,KAAK;AACT,QAAI,KAAK;AACT,aAAS,IAAI,GAAG,IAAI,UAAU,QAAQ,KAAK;AACzC,UAAM,UAAU,UAAU;AAC1B,UAAI,CAAC,SAAS;AACZ;;AAEF,WAAK,KAAK,IAAI,IAAI,QAAQ;AAC1B,WAAK,KAAK,IAAI,IAAI,QAAQ,OAAO,QAAQ;AACzC,WAAK,KAAK,IAAI,IAAI,QAAQ;AAC1B,WAAK,KAAK,IAAI,IAAI,QAAQ,MAAM,QAAQ;AACxC,UAAI,KAAK,MAAM,KAAK,IAAI;AACtB,eAAO;;;AAGX,QAAI,MAAM,UAAU;AAClB,aAAO;;AAET,WAAO,eAAe,IAAI,IAAI,KAAK,IAAI,KAAK;;AAsEvC,0BAAwB,MAAM,IAAI,IAAI;AAC3C,QAAK,MAAM,KAAK,MAAM,KAAO,KAAK,SAAS,KAAK,KAAK,UAAU,GAAI;AACjE,aAAO;;AAET,WAAO,eAAe,KAAK,OAAO,IAAI,KAAK,MAAM,IAAI,KAAK,OAAO,KAAK;;AAsBjE,gCAA8B,MAAM,IAAI;AAC7C,WAAO,KAAK,SAAS,GAAG,SAAS,KAAK,WAAW,GAAG;;AAwC/C,8BAA4B,MAAM;AACvC,QAAO,SAAiB,KAAjB,QAAQ,QAAS,KAAT;AACf,WAAO;MAAC;MAAO;;;;;ACrTjB,AAoBA,MAAI,QAAQ;AAEZ,mBAAiB,OAAO,KAAK,MAAM,WAAW,OAAO;AAEnD,QAAI,OAAO;AACT,aAAO;;AAGT,QAAI,KAAK;AACP,aAAO;;AAKT,QAAI,WAAW;AACb,aAAO,MAAM,MAAM,GAAG,MAAM,OAAO,MAAM,MAAM,IAAI,WAAW,GAAG,SAAS,MAAM;;AAIlF,WAAO,OAAO;;AAQT,qBAAmB,OAAO;AAC/B,WAAO,OAAO,OAAO,QAAQ,OAAO;;;;AC1BtC,MAAI;AAeG,oCAAkC,IAAI;AAC3C,QAAI,2BAA2B,QAAW;AACxC,aAAO;;AAGT,WAAQ,yBAAyB,kBAAkB;;AAQrD,6BAA2B,IAAI;AAC7B,QAAI;AACF,UAAM,MAAM,GAAG;AACf,UAAM,cAAc,IAAI,cAAc;AACtC,UAAM,YAAY,IAAI,cAAc;AACpC,kBAAY,YAAY;AAGxB,aAAO,YAAmB,cAAc,kBAAkB;aACnD,GAAP;AACA,aAAO;;;AAsBJ,gCAA8B,UAAU,YAAY;AACzD,WAAO,SAAS,QAAQ,QAAjB,OAA8B,aAA9B;;AAYF,kCAAgC,OAAO;AAG5C,QAAA,OAAY;AACV,aAAO,IAAI,OAAO;;AAEpB,WAAO,UAAU;;;;AC1EnB,wBAAsB,MAAM;AAC1B,eACE,WAAW,KAAK,OADT,eAEM,OAFN;;AAgBX,wCAAsC,MAAM,UAAU;AACpD,QAAM,SAAS;AACf,SAAK,UAAU,IAAI;AACnB,QAAM,iBAAiB,qBAAqB,UAAD,MAAe;AAC1D,QAAM,YAAW,KAAY,iBAAiB;AAC9C,SAAK,UAAU,OAAO;AACtB,WAAO;;AAYF,+BAA6B,MAAM,UAAU;AAClD,QAAc,yBAAyB,OAAO;AAC5C,aAAO,KAAY,cAAc,qBAAqB,UAAU;;AAIlE,QAAM,iBAAiB,6BAA6B,MAAM;AAC1D,WAAO,eAAe,OAAO,SAAY,OAAO,eAAe;;AAY1D,kCAAgC,MAAM,UAAU;AACrD,QAAc,yBAAyB,OAAO;AAC5C,aAAO,KAAY,iBACjB,qBAAqB,UAAU;;AAKnC,WAAO,6BAA6B,MAAM;;AASrC,mBAAiB,IAAI,UAAU;AACpC,QAAM,UACJ,GAAG,WACH,GAAG,yBACH,GAAG,sBACH,GAAG,qBACH,GAAG;AACL,QAAI,SAAS;AACX,aAAO,QAAQ,KAAK,IAAI;;AAE1B,WAAO;;AAWF,mBAAiB,SAAS,UAAU,YAAY;AACrD,aAAS,KAAK,SAAS,MAAM,OAAO,YAAY,KAAK,GAAG,eAAe;AACrE,UAAI,SAAS,KAAK;AAChB,eAAO;;;AAGX,WAAO;;AA0BF,4CAA0C,SAAS,UAAU;AAClE,WAAO,QAAQ,UACX,QAAQ,QAAQ,YAChB,QAAQ,SAAS,SAAC,IAAD;AAAA,aAAQ,QAAQ,IAAI;;;AA8DpC,4BAA0B,QAAQ,UAAU;AACjD,aACM,QAAQ,OAAO,kBACnB,OACA,QAAQ,MAAM,wBACd;AACA,UAAI,SAAS,QAAQ;AACnB,eAAO;;;AAGX,WAAO;;AASF,yBAAuB,QAAQ,UAAU;AAC9C,QAAM,WAAW;AACjB,aACM,QAAQ,OAAO,mBACnB,OACA,QAAQ,MAAM,oBACd;AACA,UAAI,SAAS,QAAQ;AACnB,iBAAS,KAAK;;;AAGlB,WAAO;;AAUF,sBAAoB,QAAQ,UAAU;AAC3C,QAAM,QAAQ;AACd,aAAS,QAAQ,OAAO,YAAY,OAAO,QAAQ,MAAM,aAAa;AACpE,UAAI,SAAS,QAAQ;AACnB,cAAM,KAAK;;;AAGf,WAAO;;AASF,8BAA4B,QAAQ,MAAM;AAC/C,iBAAa;AACb,WAAc,oBAAoB,QAAD,QAAe,OAAf;;AAsB5B,+BAA6B,QAAQ,MAAM;AAChD,iBAAa;AACb,WAAc,uBAAuB,QAAD,QAAe,OAAf;;;;AChR/B,iBAAe,WAAW;AAC/B,WAA+B;;;;ACO1B,MAAM,mCAAmC;AAGzC,MAAM,oCAAoC;AAWjD,MAAM,+BAA+B;IAAC,SAAS;IAAM,YAAY;;AAU1D,wBAAsB,QAAQ,WAAW,UAAU;AACxD,QAAI,UAAU,SAAS;AACrB;AACA;;AAGF,QAAM,MAAM,MAAM,OAAO,cAAc;AACvC,QAAc,IAAI,kBAAkB;AAElC,UAAM,WAAW,IAAI,IAAI,iBAAiB,WAAM;AAC9C,YAAI,UAAU,SAAS;AACrB,mBAAS;AACT;;;AAGJ,eAAS,QAAQ,QAAQ;QAAC,WAAW;;WAChC;AAEL,UAAM,WAAW,IAAI,YAAY,WAAM;AACrC,YAAI,UAAU,SAAS;AACrB,cAAI,cAAc;AAClB;;SAEkB;;;AAWnB,+BAA6B,QAAQ,WAAW;AACrD,WAAO,IAAI,QAAQ,SAAC,SAAY;AAC9B,mBAAa,QAAQ,WAAW;;;AAS7B,2BAAyB,KAAK,UAAU;AAC7C,iBAAa,IAAI,iBAAiB,WAAA;AAAA,aAAM,CAAC,CAAC,IAAI;OAAM;;AAQ/C,kCAAgC,KAAK;AAC1C,WAAO,IAAI,QAAQ,SAAC,SAAD;AAAA,aAAa,gBAAgB,KAAK;;;AAOhD,yBAAuB,SAAS;AACrC,QAAI,QAAQ,eAAe;AACzB,cAAQ,cAAc,YAAY;;;AAoC/B,gCAA8B,MAAM,SAAS,OAAc;AAAA,QAAd,UAAc,QAAA;AAAd,cAAQ;;AAC1D,QAAI,CAAC,OAAO;AACV,oBAAc,MAAM;AACpB;;AAEF,QAAM,SAAS,MAAM;AACrB,SAAK,aAAa,SAAS;;AAStB,yBAAuB,MAAM,SAAS;AAC3C,SAAK,aAAa,SAAS,KAAK;;AAS3B,kCAAgC,SAAS,YAAY;AAC1D,aAAW,QAAQ,YAAY;AAC7B,cAAQ,aAAa,MAAM,WAAW;;AAExC,WAAO;;AAUF,uCAAqC,KAAK,SAAS,YAAY;AACpE,QAAM,UAAU,IAAI,cAAc;AAClC,WAAO,uBAAuB,SAAS;;AASlC,2BAAyB,MAAM;AACpC,QAAM,YAAY,KAAK;AACvB,QAAI,cAAc,QAAW;AAC3B,aAAO;;AAIT,QAAI,IAAI;AACR,OAAG;AACD,UAAI,YAAY;AAChB,UAAI,EAAE,MAAM;AACV,YAAI,EAAE;aACD;AACL;;aAEK;AACT,WAAO,EAAE,aAAa,KAAK;;AAQtB,uBAAqB,MAAM;AAChC,QAAI,KAAK,UAAU,aAAa;AAE9B,aAAO,KAAK,iBAAiB;;AAE/B,QAAI;AAEJ,SACE,IAAI,MACJ,CAAC,CAAC,EAAE,cAAc,CAAC,aAAyC,IAC5D,IAAI,EAAE,YACN;;AACF,WAAO;;AAQF,wBAAsB,OAAO;AAClC,QAAI,CAAC,OAAO;AACV,aAAO;;AAIT,QAAI,MAAM,WAAW,yBAAyB;AAC5C,aAAO;;AAET,WACE,MAAM,YAAoC,MAC1C,OAAO,UAAU,SAAS,KAAK,WAAW;;AAyCvC,sCAAoC,SAAS,cAAc;AAChE,QAAI,iBAAiB;AACrB,OAAG;AACD,UAAI,eAAe,aAAa;AAC9B,eAAO;;aAGR,kBAAiB,eAAe,eACjC,kBAAkB;AAEpB,WAAO;;AA6BF,yBAAuB,UAAU,IAAI;AAC1C,QAAO,SAAU,SAAV;AACP,aAAS,IAAI,GAAG,IAAI,QAAQ,KAAK;AAC/B,SAAG,SAAS,IAAI;;;AAiBb,4BAA0B,KAAK,KAAK,QAAQ,cAAc;AAI/D,QAAI;AACJ,QAAI;AACF,YAAM,IAAI,KAAK,KAAK,QAAQ;aACrB,GAAP;AACA,YAAM,MAAM,OAAO,kCAAkC,QAAQ;;AAI/D,QAAI,CAAC,OAAO,UAAU,UAAU,CAAC,UAAS,gBAAgB,IAAI,aAAa;AACzE,YAAM,IAAI,KAAK,KAAK;;AAEtB,WAAO;;AAkEF,oBAAkB,SAAS;AAChC,QAAI;AACF,cAAe;aACR,GAAP;;;AAUG,qBAAmB,KAAK;AAC7B,WAAO,IAAI,UAAU,IAAI,UAAU;;AAkD9B,qBAAmB,SAAS;AACjC,WAAO,CAAE,SAAQ,YAAY,QAAQ,SAAS;;AA2FzC,+BAA6B,MAAM,MAAM,UAAU,aAAa;AACrE,QAAM,OAAO,YAAY;AAEzB,QAAM,QAAQ,KAAK,cAAc,YAAY;AAG7B,UAAO,OAAO;AAE9B,QAAA,OAA8B,eAAe,8BAAtC,UAAP,KAAO,SAAS,aAAhB,KAAgB;AAChB,UAAM,UAAU,MAAM,SAAS;AAC/B,SAAK,cAAc;;AAUd,2BAAyB,QAAQ,OAAO;AAC7C,WAAO,UAAU,UAAU,OAAO,SAAS;;;;AC/kB7C,MAAI;AAQJ,mCAAiC;AAE/B,QAAc,gBAAgB,OAAO;AACnC,aAAO,iBAAiB,KAAK;;AAG/B,WAAO,eAAe,GAAG,GAAG,GAAG;;AASjC,yBAAuB,KAAK;AAC1B,QAAA,OAAY;AACV,aAAO;;AAIT,QAAI,CAAC,IAAI,UAAU;AACjB,aAAO;;AAGT,QAAI;AACF,UAAM,MAAM,IAAI,SAAS,cAAc;AACvC,UAAM,OAAO,IAAW;AACxB,aAAO,KAAK,QAAQ;aACb,GAAP;AAEA,aAAO;;;AASJ,oBAAiB,KAAK;AAC3B,QAAI,cAAc,MAAM;AACtB,yBAAmB,QAAQ,UAAU;AACrC,UAAI,OAAO,eAAe,IAAI,QAAQ,WAAW,yBAAyB;QACxE,OAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtDb,MAAM,YAAY;AAClB,MAAM,SAAS;AACf,MAAM,OAAO;AAON,8BAA4B,KAAK;AACtC,WACE,CAAC,IAAI,wBACL,CAAC,IAAI,6BACL,CAAC,CAAC,IAAI,qBAAqB,SAC3B,CAAC,qBAAqB,QACtB,SAAS;;AAab,oBAAkB,KAAK;AAGrB,WAAO,SAAS,KAAK,IAAI,UAAU;;AAQrC,6CAA2C,QAAQ,UAAU;AAM3D,kBAAc,YAAY,MAAM;AAAA,UAAA;AAC9B,UAAI,SAAI,OAAJ,SAAA,cAAA,KAAM,SAAN,OAAA,SAAA,WAAY,cAAsC,GAAG;AACvD,eAAO,IAAI,SAAS,YAAY;aAC3B;AACL,eAAO,IAAI,OAAO,YAAY;;;AAGlC,WAAO;;AAUF,uBAAqB,KAAK;AAC/B,QAAI,CAAC,IAAI,sBAAsB;AAC7B,UAAI,uBAAuB;AAC3B,UAAI,qBAAqB,QAAQ;AACjC;;AAGF,QAAM,SAAS,IAAI;AACnB,QAAI,uBAAuB,kCACzB,IAAI,sBACJ;AAEF,QAAI,qBAAqB,QAAQ;AACjC,QAAI,qBAAqB,UAAU;;AAQ9B,gCAA8B,KAAK;AACxC,QAAI;AACF,UAAI,IAAI,qBAAqB,WAAM;SAAI;QAGrC,MAAwB,IAAI;;AAE9B,aAAO;aACP,SAAA;AACA,aAAO;;;AAkDX,MAAa,2BAAb,2BAAA;AAKE,uCAAY,UAAU,SAAS;AAAA,uBAAA,MAAA;AAE7B,WAAK,YAAY;AAGjB,WAAK,WAAL,UAAA;QACE,MAAM;QACN,YAAY;SACT;AAIL,WAAK,YAAY;AAGjB,WAAK,QAAQ;AAGb,gCAAyB,WAAW,KAAK,KAAK,SAAS,KAAK;;AAvBhE,kBAAA,2BAAA,CAAA;MAAA,KAAA;MAAA,KA2BE,eAAW;AACT,YAAI,KAAK,OAAO;AACd,iBAAO,KAAK,MAAM;;AAEpB,eAAO,KAAK,SAAS,QAAQ;;OA/BjC;MAAA,KAAA;MAAA,KAmCE,eAAiB;AACf,YAAI,KAAK,OAAO;AACd,iBAAO,KAAK,MAAM;;AAKpB,eAA8B,KAAK,SAAS;;OA1ChD;MAAA,KAAA;MAAA,KA8CE,eAAiB;AACf,YAAI,KAAK,OAAO;AACd,iBAAO,KAAK,MAAM;;AAEpB,eAAO,GAAG,OAAO,KAAK,SAAS,aAAa;;OAlDhD;MAAA,KAAA;MAAA,OAsDE,sBAAa;AACX,YAAI,KAAK,OAAO;AACd,eAAK,MAAM;eACN;AACL,eAAK,UAAU,SAAS;;;OA1D9B;MAAA,KAAA;MAAA,OA+DE,uBAAc;AACZ,YAAI,KAAK,OAAO;AACd,iBAAO,KAAK,MAAM;;AAEpB,eAAO;;OAnEX;MAAA,KAAA;MAAA,OAuEE,iBAAQ,QAAQ;AACd,YAAI,KAAK,OAAO;AACd,eAAK,MAAM,QAAQ;eACd;AACL,cAAI,KAAK,UAAU,QAAQ,WAAW,IAAI;AACxC,iBAAK,UAAU,KAAK;;;;OA5E5B;MAAA,KAAA;MAAA,OAkFE,mBAAU,QAAQ;AAChB,YAAI,KAAK,OAAO;AACd,eAAK,MAAM,UAAU;eAChB;AACL,cAAM,QAAQ,KAAK,UAAU,QAAQ;AACrC,cAAI,SAAS,IAAI;AACf,iBAAK,UAAU,OAAO,OAAO;;;;OAxFrC;MAAA,KAAA;MAAA,OAiGE,kBAAS,MAAM;AACb,YAAM,OAAO,IAAI,KAAK,KAAK,WAAW,KAAK;AAC3C,aAAK,QAAQ;AACb,iBAAA,YAAA,iCAAgB,KAAK,YAArB,OAAA,CAAA,SAAA,aAAA,QAAgC;AAAA,cAArB,IAAqB,MAAA;AAC9B,eAAK,QAAQ;;AAEf,aAAK,UAAU,SAAS;;;AAvG5B,WAAA;;AA4GA,2BAAyB,aAAa;;;ACpP/B,oBAAiB,KAAK;AAC3B,QAAI,mBAAmB,MAAM;AAC3B,kBAAY;;AAEd,aAAS;;AAqBX,oBAAkB,KAAK;AAGrB,QACE,IAAI,6BACJ,CAAE,qBAAoB,IAAI,0BAA0B,YACpD;AACA,aAAO,eACL,IAAI,0BAA0B,WAC9B,kBACA;QACE,YAAY;QACZ,cAAc;QACd,KAHF,eAGQ;AACJ,iBAAO,KAAK,oBAAoB;;;;;;;ACnDnC,oBAAiB,KAAK;AAC3B,QAAO,OAAO,IAAP;AACP,QAAM,IAAI,IAAI;AACd,QAAI,EAAE,IAAI,GAAG,OAAO,GAAG;AACrB,UAAO,MAAO,EAAP;AAEP,UAAI,OAAO,eAAe,KAAI,WAAW,OAAO;QAC9C,YAAY;QACZ,cAAc;QACd,UAAU;QACV,OAAO,iBAAY;AACjB,cAAI,MAAM,MAAM;AAChB,iBAAO;;;;;;;ACVR,gBAAc,GAAG;AACtB,QAAI,OAAO;AAGX,QAAI,CAAC,GAAG;AACN,aAAO;;AAGT,WAAO,IAAI,IAAI,IAAI;;AAOd,qBAAiB,KAAK;AAC3B,QAAI,CAAC,IAAI,KAAK,MAAM;AAClB,UAAI,OAAO,eAAe,IAAI,MAAM,QAAQ;QAC1C,YAAY;QACZ,cAAc;QACd,UAAU;QACV,OAAO;;;;;;AC7Bb,MAAO,iBAAkB,OAAO,UAAzB;AAUA,kBAAgB,QAAQ,UAAU;AACvC,QAAI,UAAU,MAAM;AAClB,YAAM,IAAI,UAAU;;AAGtB,QAAM,SAAS,OAAO;AACtB,aAAS,IAAI,GAAG,IAAI,UAAU,QAAQ,KAAK;AACzC,UAAM,SAAS,UAAU;AACzB,UAAI,UAAU,MAAM;AAClB,iBAAW,OAAO,QAAQ;AACxB,cAAI,eAAe,KAAK,QAAQ,MAAM;AACpC,mBAAO,OAAO,OAAO;;;;;AAK7B,WAAO;;AAOF,qBAAiB,KAAK;AAC3B,QAAI,CAAC,IAAI,OAAO,QAAQ;AACtB,UAAI,OAAO,eAAe,IAAI,QAAQ,UAAU;QAC9C,YAAY;QACZ,cAAc;QACd,UAAU;QACV,OAAO;;;;;;AChCN,kBAAgB,QAAQ;AAC7B,WAAO,OAAO,KAAK,QAAQ,IAAI,SAAC,GAAD;AAAA,aAAO,OAAO;;;AAOxC,qBAAiB,KAAK;AAC3B,QAAI,CAAC,IAAI,OAAO,QAAQ;AACtB,UAAI,OAAO,eAAe,IAAI,QAAQ,UAAU;QAC9C,cAAc;QACd,UAAU;QACV,OAAO;;;;;;ACpCb;AAQA,oBAAiB,UAAU;AACzB,QAAI,CAAE,iBAAgB,WAAU;AAC9B,YAAM,IAAI,UAAU;;AAEtB,QAAI,CAAC,WAAW,WAAW;AACzB,YAAM,IAAI,UAAU;;AAOtB,SAAK,SAAS;AAMd,SAAK,SAAS;AAMd,SAAK,cAAc;AAEnB,cACE,MACA,QAAQ,MAAM,mBACd,QAAQ,MAAM,kBACd;MAAE,MAAM;;;AAeZ,WAAQ,UAAU,OAAO,SAAS,aAAa,YAAY;AACzD,kBAAc,WAAW,eAAe,cAAc;AACtD,iBAAa,WAAW,cAAc,aAAa;AAEnD,QAAI,eAAe,YAAY;AAC7B,WAAK,cAAc;;AAGrB,WAAO,KAAK,OACV,KAAK,QACL,aACA;;AAUJ,WAAQ,UAAU,QAAQ,SAAS,YAAY;AAC7C,WAAO,KAAK,KAAK,QAAQ;;AAe3B,WAAQ,UAAU,SAAS,OAAO;AAChC,QAAI,cAAc;AAClB,QAAI;AAEJ,QAAI,UAAS,UAAU,iBAAiB,MAAM;AAC5C,gBAAU;WACL;AACL,gBAAU,IAAI,YAAY,SAAS,SAAS;AAC1C,gBAAQ;;;AAIZ,WAA+B;;AAUjC,WAAQ,SAAS,SAAS,QAAQ;AAChC,QAAI,cAAc;AAClB,QAAI,UAAU,IAAI,YAAY,SAAS,GAAG,QAAQ;AAChD,aAAO;;AAGT,WAA+B;;AAYjC,WAAQ,MAAM,SAAS,UAAU;AAC/B,QAAI,cAAc;AAClB,QAAI,UAAU,IAAI,YAAY,SAAS,SAAS,QAAQ;AACtD,UAAI,SAAS,SAAS;AACtB,UAAI,UAAS,IAAI,MAAM;AAEvB,UAAI,WAAW,GAAG;AAChB,eAAO,QAAQ;;AAGjB,WAAK,UAAU,SAAS,UAAS,OAAO;AACtC,oBAAY,QAAQ,UAAS,KAAK,SAAS,OAAO;AAChD,kBAAO,SAAS;AAChB,cAAI,EAAE,WAAW,GAAG;AAClB,oBAAQ;;WAET;;;AAIP,WAA+B;;AAWjC,WAAQ,OAAO,SAAS,UAAU;AAChC,QAAI,cAAc;AAClB,QAAI,UAAU,IAAI,YAAY,SAAS,SAAS,QAAQ;AACtD,eAAS,IAAI,GAAG,IAAI,SAAS,QAAQ,KAAK;AACxC,oBAAY,QAAQ,SAAS,IAAI,KAAK,SAAS;;;AAInD,WAA+B;;AAGjC,MAAI,+BAA+B,uCAAS,QAAQ,SAAS;AAC3D,UAAM;;AAMR,WAAQ,qCAAqC,SAAS,SAAS;AAC7D,mCAA+B;;AAyBjC,4BAA0B,OAAO,aAAa,QAAQ,UAAU;AAC9D,QAAI,CAAC,aAAa;AAChB,oBAAc,UAAU,kBAAkB;AAC1C,aAAO;;AAET,QAAI,CAAC,UAAU;AACb,iBAAW,IAAI,UAAS,KAAK;;AAE/B,UAAM,iBAAiB,UAAU,aAAa;AAC9C,WAAO,SAAS;;AAqBlB,2BAAyB,QAAQ,QAAQ,YAAY,UAAU;AAC7D,QAAI,CAAC,YAAY;AACf,oBAAc,UAAU,iBAAiB;AACzC,aAAO;;AAET,QAAI,CAAC,UAAU;AACb,iBAAW,IAAI,UAAS,KAAK;;AAE/B,UAAM,iBAAiB,UAAU,YAAY;AAC7C,WAAO,SAAS;;AAqBlB,0BAAwB,OAAO,aAAa,YAAY,UAAU;AAChE,QAAI,CAAC,UAAU;AACb,UAAI,CAAC,eAAe,CAAC,YAAY;AAAE,eAAO;;AAC1C,iBAAW,IAAI,UAAS,KAAK;;AAE/B,UAAM,KAAK;MACT;MACA,aAAa,eAAe,SAAS;MACrC,YAAY,cAAc,SAAS;;AAErC,WAAO,SAAS;;AASlB,qBAAkB,UAAS;AACzB,QAAI,WAAW;AAEf,SAAK,UAAU,IAAI,SAAQ,SAAS,SAAS,QAAQ;AAEnD,eAAS,UAAU;AAGnB,eAAS,SAAS;;AAEpB,WAAO;;AAWT,iBAAe,SAAS,OAAO,OAAO,SAAS;AAC7C,QAAI,QAAQ,QAAQ;AACpB,YAAQ,SAAS;AACjB,YAAQ,SAAS;AAEjB,QAAI,WAAW,UAAU,gBAAgB;AACvC,cAAQ,OAAO,OAAO,QAAQ,QAAQ;QACpC;QACA,SAAS;QACT,QAAQ;;;AAIZ,aAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,UAAI,OAAO,MAAM;AACjB,cAAQ,OACN,OACA,KAAK,aACL,KAAK,YACL,KAAK;;AAGT,UAAM,SAAS;AAIf,QAAI,SAAS;AACX,cAAQ,cAAc;;AAIxB,QAAI,UAAU,mBAAmB,QAAQ,aAAa;AACpD,iBAAW,WAAW;AACpB,YAAI,QAAQ,aAAa;AACvB,uCAA6B,OAAO;;SAErC;;;AAWP,mBAAiB,SAAS,OAAO;AAC/B,WAAO,SAAS,OAAO;AACrB,YAAM,SAAS,OAAO;;;AAY1B,yBAAuB,UAAU,OAAO,OAAO;AAC7C,QAAI,UAAU;AACZ,UAAI,UAAU,SAAS;AACvB,cAAQ,SAAS;AACjB,cAAQ,SAAS;;;AAOrB,mBAAgB;;AAQhB,sBAAoB,IAAI;AACtB,WAAO,OAAO,OAAO;;AASvB,qBAAkB,KAAK;AACrB,WAAO,QAAQ,OAAO;;AAUxB,gBAAc,YAAY,UAAU;AAClC,aAAS,IAAI,GAAG,IAAI,WAAW,QAAQ,KAAK;AAC1C,eAAS,WAAW,IAAI;;;AAa5B,4BAA0B,UAAU,IAAI,KAAK;AAC3C,QAAI,UAAU,SAAS;AACvB,QAAI,UAAU,SAAS;AACvB,QAAI,SAAS,SAAS;AACtB,WAAO,WAAW;AAChB,UAAI;AACF,YAAI,SAAS,GAAG;AAChB,kBAAU,SAAS,SAAS,QAAQ,QAAQ;eACrC,GAAP;AACA,eAAO;;;;AAQb,MAAI,QAAS,WAAW;AAItB,QAAI;AACJ,QAAI,OAAO,WAAW,eAAe,OAAO,aAAa;AACvD,aAAO,iBAAiB,WAAW;AACnC,sBAAgB,0BAAW;AACzB,eAAO,YAAY,cAAc;;WAE9B;AACL,sBAAgB,0BAAW;AACzB,mBAAW,OAAO;;;AAItB,QAAI,QAAQ,IAAI,MAAM;AACtB,QAAI,SAAS;AAEb,qBAAiB;AACf,eAAS,IAAI,GAAG,IAAI,QAAQ,KAAK;AAC/B,YAAI,KAAK,MAAM;AACf,cAAM,KAAK;AACX;;AAEF,eAAS;;AAMX,oBAAe,IAAI;AACjB,UAAI,WAAW,GAAG;AAAE;;AACpB,YAAM,YAAY;;AAGpB,WAAO;;AAaT,qBAAmB,SAAS,SAAS,QAAQ,OAAO,SAAS;AAC3D,QAAI,WAAU;AACd,QAAI;AACJ,QAAI;AACJ,QAAI;AACF,UAAI,UAAU,SAAS;AACrB,cAAM,IAAI,UAAU;;AAEtB,UAAI,QAAQ,UAAS;AACrB,UAAI,SAAS,iBAAiB,QAAQ,aAAa;AACjD,cAAM,SAAS,MAAM,QAAQ,MAAM,QAAQ;iBAClC,SAAU,QAAO,MAAM,SAAS,WAAW,OAAO;AAC3D,oBAAW,kBAAS,QAAO;AACzB,sBAAW,WAAU;AACrB,oBAAU,SAAS,SAAS,QAAQ,QAAO;;AAE7C,mBAAU,iBAAS,QAAQ;AACzB,sBAAW,WAAU;AACrB,iBAAO;;AAET,aAAK,KACH,SACA,SAAS,QAAO;AAAE,oBAAS;WAC3B,SAAS,QAAQ;AAAE,mBAAQ;;aAExB;AACL,gBAAQ;;aAEH,GAAP;AACA,eAAQ;;;AAIZ,MAAA,kBAAe;;;AClfR,qBAAiB,KAAK;AAC3B,QAAI,CAAC,IAAI,SAAS;AAChB,UAAI,UAAU;AAGd,UAAI,gBAAQ,SAAS;AACnB,YAAI,UAAU,gBAAQ;;AAIxB,UAAI,QAAQ,UAAU,gBAAQ;AAC9B,UAAI,QAAQ,SAAS,gBAAQ;AAC7B,UAAI,QAAQ,MAAM,gBAAQ;AAC1B,UAAI,QAAQ,OAAO,gBAAQ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACP/B,MAAM,aAAY;AAClB,MAAM,QAAO;AAON,+BAA4B,KAAK;AACtC,WAAO,CAAC,IAAI,kBAAkB,CAAC,CAAC,IAAI,eAAe;;AAQ9C,wBAAqB,KAAK;AAC/B,QAAI,IAAI,gBAAgB;AACtB;;AAGF,QAAI,iBAAiB;AACrB,QAAI,eAAe,SAAQ;;AA0C7B,MAAa,qBAAb,2BAAA;AAEE,iCAAY,UAAU;AAAA,uBAAA,MAAA;AAEpB,WAAK,YAAY;AAGjB,WAAK,YAAY;AAGjB,WAAK,QAAQ;AAGb,0BAAmB,YAAW,KAAK,KAAK,SAAS,KAAK;;AAb1D,kBAAA,qBAAA,CAAA;MAAA,KAAA;MAAA,OAiBE,sBAAa;AACX,YAAI,KAAK,OAAO;AACd,eAAK,MAAM;eACN;AACL,eAAK,UAAU,SAAS;;;OArB9B;MAAA,KAAA;MAAA,OA0BE,iBAAQ,QAAQ;AACd,YAAI,KAAK,OAAO;AACd,eAAK,MAAM,QAAQ;eACd;AACL,cAAI,KAAK,UAAU,QAAQ,WAAW,IAAI;AACxC,iBAAK,UAAU,KAAK;;;;OA/B5B;MAAA,KAAA;MAAA,OAqCE,mBAAU,QAAQ;AAChB,YAAI,KAAK,OAAO;AACd,eAAK,MAAM,UAAU;eAChB;AACL,cAAM,QAAQ,KAAK,UAAU,QAAQ;AACrC,cAAI,SAAS,IAAI;AACf,iBAAK,UAAU,OAAO,OAAO;;;;OA3CrC;MAAA,KAAA;MAAA,OAoDE,kBAAS,MAAM;AACb,YAAM,OAAO,IAAI,KAAK,KAAK;AAC3B,aAAK,QAAQ;AACb,iBAAA,aAAA,iCAAgB,KAAK,YAArB,QAAA,CAAA,UAAA,cAAA,QAAgC;AAAA,cAArB,IAAqB,OAAA;AAC9B,eAAK,QAAQ;;AAEf,aAAK,UAAU,SAAS;;;AA1D5B,WAAA;;AA+DA,qBAAmB,cAAa;;;AC/HzB,qBAAiB,KAAK;AAC3B,QAAI,oBAAmB,MAAM;AAC3B,mBAAY;;;;;ACTT,qBAAiB,KAAK;AAC3B,QAAO,MAAO,IAAP;AACP,QAAM,IAAI,IAAI;AACd,QAAI,EAAE,IAAI,OAAO,GAAG;AAClB,UAAO,MAAO,EAAP;AAEP,UAAI,OAAO,eAAe,IAAI,WAAW,OAAO;QAC9C,YAAY;QACZ,cAAc;QACd,UAAU;QACV,OAAO,iBAAY;AACjB,cAAI,MAAM,MAAM;AAChB,iBAAO;;;;;;;ACTf,sBAAoB,QAAQ,QAAQ;AAClC,QAAM,MAAM,SAAS,IAAI,SAAS,IAAI;AAEtC,WAAO,KAAK,OAAO,KAAK,OAAO,YAAY;;AAOtC,qBAAiB,KAAK;AAC3B,QAAI,CAAC,IAAI,OAAO,UAAU,YAAY;AACpC,UAAI,OAAO,eAAe,IAAI,OAAO,WAAW,cAAc;QAC5D,YAAY;QACZ,cAAc;QACd,UAAU;QACV,OAAO;;;;;;ACnBN,qBAAiB,KAAK;AAC3B,QAAO,WAAW,IAAX;AACP,QAAM,IAAI,IAAI;AACd,QAAI,EAAE,IAAI,IAAI,OAAO,GAAG;AACtB,UAAO,MAAO,EAAP;AAEP,UAAI,OAAO,eAAe,SAAQ,WAAW,OAAO;QAClD,YAAY;QACZ,cAAc;QACd,UAAU;QACV,OAAO,iBAAY;AACjB,cAAI,MAAM,MAAM;AAChB,iBAAO;;;;;;;;;;;;ACEf,MAAI,MAAS;AACX,aAAa;AACb,cAAgB;AAChB,cAAoB;AACpB,cAAoB;AACpB,cAAe;AACf,aAAqB;AACrB,aAAc;AACd,cAAkB;AAClB,cAAc;AACd,cAAwB;;AAI1B,MAAI,KAAK,UAAU;AACjB,QAAI,MAAS;AACX,eAAoB;AACpB,eAAmB;AACnB,eAA6B;;AAI/B,QAAI,MAAS;AACX,eAAsB,MAAD,2BAAA;AAAA,0BAAA;AAAA,2BAAA,MAAA;;AAAA,eAAA;;AACrB,eAA4B;AAC5B,gBAAsB;AACtB,cAAuB;;;;;ACqCpB,kCAAgC,KAAK,IAAI,aAAa,iBAAiB;AAC5E,UAAM,aAAa;AACnB,4BAAwB,KAAK,KAAK,IAAI;AACtC,QAAI,iBAAiB;AACnB,yBAAmB,KAAK;;;AAYrB,wCACL,WACA,IACA,aACA,iBACA;AACA,QAAM,SAAS,UAAU;AACzB,QAAM,SAAS,uBAAuB;AACtC,4BAAwB,QAAQ,QAAQ,IAAI;AAC5C,QAAI,iBAAiB;AACnB,yBAAmB,QAAQ;;;AAUxB,sCAAoC,WAAW,IAAI,OAAO;AAC/D,QAAM,SAAS,UAAU;AACzB,QAAM,SAAS,uBAAuB;AACtC,iCAA6B,QAAQ,IAAI;;AAapC,sBAAoB,KAAK,IAAI;AAClC,UAAM,aAAa;AACnB,WAAO,mBAAmB,KAAK;;AAW1B,gCAA8B,KAAK,IAAI;AAC5C,WAAO,mBAAmB,KAAK;;AAa1B,6BAA2B,KAAK,IAAI;AACzC,WAAO,0BAA0B,KAAK;;AASjC,oCAAkC,KAAK,IAAI;AAChD,UAAM,aAAa;AACnB,QAAI,oBAAoB,KAAK,KAAK;AAChC,aAAO,mBAAmB,KAAK;WAC1B;AACL,aAAO;;;AAUJ,mCAAiC,KAAK,IAAI;AAC/C,WAAO,gCAAgC,KAAK;;AAWvC,4BAA0B,iBAAiB,IAAI;AACpD,QAAM,SAAS,UAAU;AACzB,QAAM,SAAS,uBAAuB;AACtC,WAAO,mBAAmB,QAAQ;;AAU7B,kCAAgC,iBAAiB,IAAI;AAC1D,QAAM,SAAS,UAAU;AACzB,QAAM,SAAS,uBAAuB;AACtC,QAAI,oBAAoB,QAAQ,KAAK;AACnC,aAAO,mBAAmB,QAAQ;WAC7B;AACL,aAAO;;;AAYJ,mCAAiC,iBAAiB,IAAI;AAC3D,WAAO,0BAA0B,uBAAuB,kBAAkB;;AAUrE,yCAAuC,iBAAiB,IAAI;AACjE,WAAO,gCACL,uBAAuB,kBACvB;;AA6BG,wBAAsB,KAAK;AAChC,WAAO,IAAI,aAAc,KAAI,YAAY;;AASpC,uCAAqC,MAAM,YAAY;AAC5D,QAAM,WAAY,MAAK,iBAAiB,MAAM;AAC9C,QAAM,SAAS,cAAc,aAAa;AAC1C,QAAI,YAAY,YAAY,UAAU,aAAa,aAAa,QAAQ;AACtE,UAAI;AACF,eAA0C,SAAS;eAC5C,GAAP;;;AAIJ,WAAO;;AAOF,qBAAmB,WAAW;AACnC,QAAI,UAAU,UAAU;AACtB,UAAM,MAAM,MACgB,WAAU,iBAAiB,WAClD;AAEL,aAAO,iBAAiB,KAAK,UAAgC;;AAE/D,WAAqD;;AAOvD,kCAAgC,WAAW;AACzC,QAAM,SAAS,UAAU;AACzB,WAAO,OAAO,gBAAgB,OAAO,MAAM;;AAS7C,4BAA0B,KAAK;AAC7B,WACE,WAAW,KAAK;;AAWpB,8BAA4B,QAAQ,IAAI;AACtC,cACE,oBAAoB,QAAQ,KADrB,sBAEa,KAFb;AAIT,QAAM,WAAW,YAAY;AAC7B,QAAM,IAAI,SAAS;AACnB,QAAI,CAAC,EAAE,KAAK;AACV,gBAAU,EAAE,MAAH,aAAoB,KAApB;AACT,gBAAU,EAAE,SAAH,aAAuB,KAAvB;AACT,QAAE,MAAM,IAAI,EAAE,KAAK,EAAE;AACrB,gBAAU,EAAE,KAAH,aAAmB,KAAnB;AACT,QAAE,UAAU;AAGZ,UAAI,EAAE,SAAS;AACb,UAAE,QAAQ,EAAE;;;AAGhB,WAAO,EAAE;;AAWX,mCACE,QACA,SACA,IACA,MACA,cACA,oBACA;AACA,QAAM,WAAW,YAAY;AAC7B,QAAI,IAAI,SAAS;AAEjB,QAAI,CAAC,GAAG;AACN,UAAI,SAAS,MAAM;QACjB,KAAK;QACL,SAAS;QACT,SAAS;QACT,QAAQ;QACR,SAAS;QACT,MAAM;QACN,gBAAgB,sBAAsB;;;AAI1C,QAAI,CAAC,gBAAgB,EAAE,MAAM;AAE3B;;AAGF,MAAE,OAAO;AACT,MAAE,UAAU;AACZ,MAAE,iBAAiB,sBAAsB;AAIzC,QAAI,EAAE,SAAS;AAEb,yBAAmB,QAAQ;;;AAS/B,qCAAmC,QAAQ,IAAI;AAC7C,QAAM,SAAS,gCAAgC,QAAQ;AACvD,QAAI,QAAQ;AACV,aAAO;;AAMT,QAAM,WAAW,YAAY;AAC7B,aAAS,MAAM;AACf,WAAyC,SAAS,IAAI;;AAQxD,wCAAsC,QAAQ,IAAI,OAAO;AACvD,QAAM,WAAW,YAAY;AAC7B,QAAM,IAAI,SAAS;AACnB,QAAI,GAAG;AACL,UAAI,EAAE,QAAQ;AACZ,UAAE,OAAO;;AAEX;;AAGF,aAAS,MAAM;AACf,aAAS,IAAI,OAAO;;AAUtB,2CAAyC,QAAQ,IAAI;AACnD,QAAM,WAAW,YAAY;AAC7B,QAAM,IAAI,SAAS;AACnB,QAAI,GAAG;AACL,UAAI,EAAE,SAAS;AACb,eAAO,EAAE;aACJ;AAEL,2BAAmB,QAAQ;AAC3B,eAAQ,EAAE,UAAU,QAAQ,QAAgC,EAAE;;;AAGlE,WAAO;;AAQT,uBAAqB,QAAQ;AAC3B,QAAI,WAAW,OAAO;AACtB,QAAI,CAAC,UAAU;AACb,iBAAW,OAAO,iBAAiB;;AAErC,WAAO;;AAQF,wBAAsB,SAAS;AACpC,WAAO,OAAO,QAAQ,WAAW;;AAS5B,4BAA0B,SAAS;AACxC,cAAU,aAAa,UAAU;AACjC,WAAmC;;AAQ9B,iCAA+B,QAAQ;AAC5C,4BAAwB;;AAe1B,mCAAiC,QAAQ;AACvC,QAAM,WAAW,YAAY;AADU,QAAA,QAAA,gBAE5B,KAF4B;AAGrC,UAAI,CAAC,OAAO,UAAU,eAAe,KAAK,UAAU,MAAK;AACvD,eAAA;;AAEF,UAAM,gBAAgB,SAAS;AAC/B,UAAI,cAAc,gBAAgB;AAChC,eAAA;;AAEF,UAAI,cAAc,KAAK;AACrB,+BAAuB,KAAI,cAAc;iBAChC,cAAc,SAAS;AAChC,sBAAc,QAAQ,KAAK,SAAC,UAAD;AAAA,iBACzB,uBAAuB,KAAI;;;;AAZjC,aAAW,MAAM,UAAU;AAAA,UAAA,OAAA,MAAhB;AAAgB,UAAA,SAAA;AAMvB;;;AAgBN,kCAAgC,IAAI,SAAS;AAC3C,QAAI,CAAC,aAAa,UAAU;AAC1B;;AAEF,QAAI;AACF,uBAAiB,SAAS;aACnB,GAAP;AAGA,YAAM,MAAM,WAAW,6BAA6B,IAAI;;;AAwE5D,+BAA6B,QAAQ,IAAI;AACvC,QAAM,UAAU,OAAO,kBAAkB,OAAO,eAAe;AAE/D,WAAO,CAAC,CAAE,YAAW,QAAQ;;AAI/B,2CAAyC;AACvC,QAAM,WAAW,IAAI;AACrB,QAAO,UAA4B,SAA5B,SAAS,SAAmB,SAAnB,QAAQ,UAAW,SAAX;AACxB,YAAQ,MAAM,WAAM;;AACpB,WAAO;MACL,KAAK;MACL;MACA;MACA;MACA,SAAS;MACT,MAAM;;;;;ACloBV,MAAM,mBAAmB,CAAC;AAC1B,MAAM,iBAAiB;AAQhB,kCAAgC,UAAU,gBAAgB;AAC/D,QAAI,gBAAgB;AAClB,UAAI,SAAY,SAAS,WAAf,OAA4B,SAAS;AAC/C,UACE,SAAS,YAAY,YACrB,SAAS,YAAY,WACrB,SAAS,YAAY,SACrB;AACA,iBAAS;;AAEX,aAAU,SAAV;;AAEF,WAAO,KAAK;;AAWP,uCACL,UACA,aACA,SACA,gBACA;AACA,QAAM,gBAAgB,UAAU,MAAM,SAAS;AAC/C,QAAM,OAAO,uBAAuB,UAAU;AAC9C,QAAM,MAAM,UAAU;AACtB,QAAM,mBAAmB,UAAU,MAAM,UAAU;AACnD,WAAU,OAAV,UAAsB,MAAtB,SAAgC,cAAc,mBAAmB;;AAkC5D,6BAA2B,WAAW;AAC3C,QAAI,CAAC,WAAW;AACd,aAAO;;AAGT,QAAM,WAAU,UAAU,MACxB;AAEF,QAAM,cAAc,WAAU,SAAQ,KAAK;AAC3C,QAAM,mBAAmB,WAAU,SAAQ,KAAK;AAChD,QAAI,CAAC,eAAe,CAAC,kBAAkB;AACrC,aAAO;;AAET,WAAO;MAAC;MAAa;;;AAUhB,iCAA+B,KAAK,aAAa,SAAS;AAC/D,QAAM,gBAAgB,IAAI,SAAS,cAAc;AACjD,kBAAc,QAAQ;AACtB,QAAI,wBAAwB,cAAc;AACxC,gBAAU;WACL;AACL,oBAAc,aACZ,iBAAiB,QAAQ,gBAAgB,IACrC,oBACA,kBACJ;;AAGJ,kBAAc,aAAa,eAAe;AAC1C,kBAAc,aAAa,sBAAsB;AACjD,QAAI,UAAU,KAAK;AACjB,oBAAc,aAAa,QAAQ;;AAIrC,QAAM,gBAAgB,IAAI,SAAS,KAAK,cAAc;AACtD,QAAI,eAAe;AACjB,oBAAc,aAAa,SAAS,cAAc,aAAa;;AAKjE,kBAAc,aAAa,eAAe;AAC1C,QAAI,MAAM,IAAI;AACd,QAAI,QAAQ,KAAK,QAAQ,IAAI,cAAc;AACzC,YAAM,IAAI;;AAEZ,QAAM,YAAY,4BAChB,KACA,aACA,SACA,QAAQ,KAAK;AAEf,kBAAc,MAAM;AACpB,WAAO;;AAcF,+BACL,KACA,aACA,SACA,QACA,iBACA;AAAA,QADA,oBACA,QAAA;AADA,wBAAkB;;AAGlB,QAAM,WACJ,yCACC,mBAAkB,KAAK;AAG1B,QAAM,WAAU,IAAI,SAAS,KAAY,iBAAzB,mBACG,cADH,QACoB;AAEpC,QAAM,WAAW;AACjB,aAAS,IAAI,GAAG,IAAI,SAAQ,QAAQ,KAAK;AACvC,UAAM,QAAQ,SAAQ;AACtB,UAAM,WAAW,kBAAkB,MAAM;AACzC,UAAI,CAAC,UAAU;AACb;;AAEF,UACe,oBAEX,SAFF,aACkB,yBAChB,SADF;AAEF,UACE,qBAAqB,eACpB,yBAAwB,gBACvB,0BAA0B,WACzB,0BAA0B,kBAAkB,SAC/C;AACA,iBAAS,KAAK;;;AAGlB,WAAO;;AAQF,kCAAgC,MAAM;AAE3C,QAAI,CAAC,MAAM;AACT,aAAO;;AAIT,QAAM,OAAO,KAAK,iBAChB;AAEF,QAAM,UAAU;AAChB,aAAS,IAAI,GAAG,IAAI,KAAK,QAAQ,KAAK;AACpC,UAAM,SAAS,KAAK;AACpB,UAAM,cACJ,OAAO,aAAa,qBACpB,OAAO,aAAa;AACtB,UAAM,WAAW,kBAAkB,OAAO;AAC1C,UAAI,eAAe,UAAU;AAC3B,gBAAQ,KAAK;UAAC;UAAa,kBAAkB,SAAS;;;;AAG1D,WAAO;;AAWF,iCAA+B,KAAK,IAAI,SAAS;AACtD,WAAO,uBAAuB,IAAI,SAAS,MAAM,KAC/C,SAAA,MAAA;AAAA,UAAE,cAAF,KAAE,aAAa,mBAAf,KAAe;AAAf,aACE,MAAM,eAAe,WAAW;;;AAQtC,mCAAiC,aAAa;AAC5C,WAAO,YAAY,WAAW;;;;AC1NzB,wCACL,KACA,IACA,WACA,SACA,aACA;AACA,QAAM,IAAI,wBAAwB,KAAK;AACvC,QAAI,GAAG;AACL,aAAyC;;AAE3C,WAAO,+BACL,KACA,IACA,WACA,SACA;;AAkBG,mCAAiC,SAAS,IAAI,WAAW,aAAa;AAC3E,WAAO,mCACL,SACA,IACA,WACA,aACA,KAAK,SAAC,SAAD;AAAA,aAAa,cAAc,SAAS,IAAI;;;AAc1C,8CACL,SACA,IACA,WACA,aACA;AACA,QAAM,IAAI,8BAA8B,SAAS;AACjD,QAAI,GAAG;AACL,aAAyC;;AAE3C,QAAM,SAAS,UAAU;AACzB,WAAO,OACJ,sBACA,KAAK,WAAM;AACV,UAAM,UAAU,OAAO,oBAAoB;AAC3C,UAAI,CAAC,SAAS;AACZ,eAAO;;AAET,UAAM,aAAa,WAAW,OAAO,KAAK;AAC1C,aAAO,WAAW,iBAAiB,WAAW;OAE/C,KAAK,SAAC,KAAQ;AACb,UAAI,CAAC,KAAK;AACR,eAAO;;AAIT,UAAI,aAAa;AACf,eAAO,8BAA8B,SAAS;;AAEhD,aAAO,wBAAwB,SAAS;;;AAevC,0DACL,SACA,IACA,WACA;AACA,QAAM,IAAI,uBAAuB,SAAS;AAC1C,QAAI,GAAG;AACL,aAAyC,QAAQ,QAAQ;;AAE3D,WAAO,mCAAmC,SAAS,IAAI;;AAYzD,yBAAuB,SAAS,IAAI,WAAW;AAC7C,WACE,WACE,SACA,mKAGA,IACA,WACA,WACA;;AAgBN,0CACE,KACA,IACA,WACA,SACA,aACA;AACA,WAAO,AACJ,uBAAuB,IAAI,UAC3B,KAAK,WAAM;AAMV,UAAM,aAAa,WAAW,KAAK;AAInC,UAAI,CAAC,sBAAsB,WAAW,KAAK,WAAW,UAAU;AAC9D,eAAO;;AAET,aAAO,WAAW,iBAAiB,WAAW;OAE/C,KAAK,SAAC,KAAQ;AACb,UAAI,CAAC,KAAK;AACR,eAAO;;AAIT,UAAI,aAAa;AACf,eAAO,wBAAwB,KAAK;;AAEtC,aAAO,kBAAkB,KAAK;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzLpC,MAAa,WAAb,2BAAA;AAAA,yBAAA;AAAA,uBAAA,MAAA;;AAAA,kBAAA,WAAA,MAAA,CAAA;MAAA,KAAA;MAAA,OAWE,6BAA2B,SAAS;AAClC,eACE,wBAAwB,SAAS,UAAU;;OAbjD;MAAA,KAAA;MAAA,OAuBE,mCAAiC,SAAS;AACxC,eACE,mCAAmC,SAAS,UAAU;;OAzB5D;MAAA,KAAA;MAAA,OAkCE,oCAAkC,SAAS;AACzC,eACE,wBAAwB,SAAS,iBAAiB;;OApCxD;MAAA,KAAA;MAAA,OA6CE,0CAAwC,SAAS;AAC/C,eACE,mCACE,SACA,iBACA;;OAlDR;MAAA,KAAA;MAAA,OA2DE,6BAA2B,SAAS;AAClC,eACE,uBAAuB,SAAS;;OA7DtC;MAAA,KAAA;MAAA,OAqEE,+BAA6B,SAAS;AACpC,eACE,uBAAuB,SAAS;;OAvEtC;MAAA,KAAA;MAAA,OA+EE,wBAAsB,SAAS;AAC7B,eACE,wBAAwB,SAAS,YAAY;;OAjFnD;MAAA,KAAA;MAAA,OA4FE,0BAAwB,SAAQ;AAC9B,eACE,WAAW,SAAQ;;OA9FzB;MAAA,KAAA;MAAA,OAuGE,gBAAc,cAAc;AAC1B,eAAO,UAAU;;OAxGrB;MAAA,KAAA;MAAA,OAgHE,yBAAuB,SAAS,eAAuB;AAAA,YAAvB,kBAAuB,QAAA;AAAvB,0BAAgB;;AAC9C,YAAI,eAAe;AAEjB,cAAM,SAAS,UAAU;AACzB,oBAAS,cAAc,OAAO,KAAY,uBACxC,QACA;;AAGJ,eACE,wBACE,SACA,iCACA;;OA7HR;MAAA,KAAA;MAAA,OAsIE,+BAA6B,SAAS;AACpC,eACE,mCACE,SACA,iCACA;;OA3IR;MAAA,KAAA;MAAA,OAoJE,uBAAqB,SAAQ;AAC3B,eACE,WAAW,SAAQ;;OAtJzB;MAAA,KAAA;MAAA,OA8JE,0BAAwB,SAAS;AAC/B,eACE,+CACE,SACA,QACA;;OAnKR;MAAA,KAAA;MAAA,OA4KE,4BAA0B,SAAS;AACjC,eACE,+CACE,SACA,cACA;;OAjLR;MAAA,KAAA;MAAA,OA0LE,mBAAiB,iBAAiB;AAChC,eACE,wBAAwB,iBAAiB;;OA5L/C;MAAA,KAAA;MAAA,OAoME,0BAAwB,iBAAiB;AACvC,eACE,iBAAiB,iBAAiB;;OAtMxC;MAAA,KAAA;MAAA,OA8ME,6BAA2B,SAAS;AAClC,eACE,wBAAwB,SAAS,UAAU;;OAhNjD;MAAA,KAAA;MAAA,OAwNE,iCAA+B,SAAS;AACtC,eACE,wBAAwB,SAAS,cAAc;;OA1NrD;MAAA,KAAA;MAAA,OAkOE,mBAAiB,SAAQ;AACvB,eACE,WAAW,SAAQ;;OApOzB;MAAA,KAAA;MAAA,OA4OE,4BAA0B,iBAAiB;AACzC,eACE,iBAAiB,iBAAiB,gBAClC;;OA/ON;MAAA,KAAA;MAAA,OAsPE,uBAAqB,SAAQ;AAC3B,eACE,WAAW,SAAQ;;OAxPzB;MAAA,KAAA;MAAA,OAkQE,0BAAwB,iBAAiB;AACvC,eACE,wBAAwB,iBAAiB;;OApQ/C;MAAA,KAAA;MAAA,OA6QE,8BAA4B,SAAS;AACnC,eACE,uBAAuB,SAAS;;OA/QtC;MAAA,KAAA;MAAA,OAwRE,uBAAqB,iBAAiB;AACpC,eACE,iBAAiB,iBAAiB;;OA1RxC;MAAA,KAAA;MAAA,OAkSE,kBAAgB,KAAK;AACnB,eAAO,WAAW,KAAK;;OAnS3B;MAAA,KAAA;MAAA,OA2SE,sCAAoC,SAAS;AAC3C,eACE,mCAAmC,SAAS,aAAa;;OA7S/D;MAAA,KAAA;MAAA,OAqTE,gCAA8B,iBAAiB;AAC7C,eACE,uBAAuB,iBAAiB;;OAvT9C;MAAA,KAAA;MAAA,OA+TE,+BAA6B,iBAAiB;AAC5C,eACE,iBAAiB,iBAAiB;;OAjUxC;MAAA,KAAA;MAAA,OAyUE,uBAAqB,iBAAiB;AACpC,eACE,iBAAiB,iBAAiB;;OA3UxC;MAAA,KAAA;MAAA,OAmVE,sBAAoB,iBAAiB;AACnC,eACE,iBAAiB,iBAAiB;;OArVxC;MAAA,KAAA;MAAA,OA6VE,wBAAsB,SAAQ;AAC5B,eACE,WAAW,SAAQ;;OA/VzB;MAAA,KAAA;MAAA,OAuWE,8BAA4B,SAAQ;AAClC,eACE,yBAAyB,SAAQ;;OAzWvC;MAAA,KAAA;MAAA,OAiXE,qBAAmB,SAAQ;AACzB,eACE,WAAW,SAAQ;;OAnXzB;MAAA,KAAA;MAAA,OA6XE,gCAA8B,SAAS;AACrC,eACE,iBAAiB,SAAS;;OA/XhC;MAAA,KAAA;MAAA,OAuYE,uBAAqB,SAAQ;AAC3B,eAAO,WAAW,SAAQ;;OAxY9B;MAAA,KAAA;MAAA,OA+YE,yBAAuB,iBAAiB;AACtC,eACE,iBAAiB,iBAAiB;;OAjZxC;MAAA,KAAA;MAAA,OAyZE,gCAA8B,iBAAiB;AAC7C,eACE,wBAAwB,iBAAiB;;OA3Z/C;MAAA,KAAA;MAAA,OAmaE,uCAAqC,KAAK;AACxC,eAEG,6BAA6B,KAAK,kBAAkB,aAAa;;OAtaxE;MAAA,KAAA;MAAA,OA8aE,8BAA4B,KAAK;AAC/B,eAEG,yBAAyB,KAAK;;OAjbrC;MAAA,KAAA;MAAA,OA2bE,oCAAkC,KAAK;AACrC,eAEG,6BAA6B,KAAK,eAAe,aAAa;;OA9brE;MAAA,KAAA;MAAA,OAscE,2BAAyB,KAAK;AAC5B,eAEG,yBAAyB,KAAK;;OAzcrC;MAAA,KAAA;MAAA,OAidE,gCAA8B,KAAK;AACjC,eAEG,yBAAyB,KAAK;;OApdrC;MAAA,KAAA;MAAA,OA6dE,sCAAoC,KAAK;AACvC,eAEG,6BAA6B,KAAK,iBAAiB,aAAa;;OAhevE;MAAA,KAAA;MAAA,OAweE,6BAA2B,KAAK;AAC9B,eAEG,yBAAyB,KAAK;;OA3erC;MAAA,KAAA;MAAA,OAmfE,wCAAsC,KAAK;AACzC,eAEG,yBAAyB,KAAK;;OAtfrC;MAAA,KAAA;MAAA,OA8fE,sCAAoC,IAAI;AACtC,eACE,wBAAwB,IAAI;;OAhgBlC;MAAA,KAAA;MAAA,OAwgBE,4BAA0B,SAAS;AACjC,eACE,uBAAuB,SAAS;;OA1gBtC;MAAA,KAAA;MAAA,OAmhBE,wCAAsC,KAAK;AACzC,eAGI,6BACE,KACA,mBACA,aACA,OACA;;OA5hBV;MAAA,KAAA;MAAA,OAsiBE,+BAA6B,KAAK;AAChC,eAEG,yBAAyB,KAAK;;OAziBrC;MAAA,KAAA;MAAA,OAijBE,gCAA8B,SAAS;AACrC,eAEG,wBAAwB,SAAS,iBAAiB;;OApjBzD;MAAA,KAAA;MAAA,OA4jBE,8BAA4B,iBAAiB;AAC3C,eACE,wBAAwB,iBAAiB;;OA9jB/C;MAAA,KAAA;MAAA,OAskBE,uBAAqB,iBAAiB;AACpC,eACE,wBAAwB,iBAAiB;;OAxkB/C;MAAA,KAAA;MAAA,OAilBE,+BAA6B,iBAAiB;AAC5C,YAAM,aAAa,UAAS,OAAO;AACnC,YAAM,iBAAgB,UAAS,iBAAiB,WAAW;AAC3D,YAAM,YAAY,eAAc,gBAC5B,eAAc,iBACd;AAGJ,YAAM,SACJ,aAAa,UAAU,OAAO,WAAW,MAAM,YAAY;AAC7D,eACE,wBAAwB,QAAQ;;OA5lBtC;MAAA,KAAA;MAAA,OAomBE,yBAAuB,iBAAiB;AACtC,eACE,iBAAiB,iBAAiB;;OAtmBxC;MAAA,KAAA;MAAA,OA8mBE,kBAAgB,SAAQ;AAEtB,eACE,qBAAqB,SAAQ;;OAjnBnC;MAAA,KAAA;MAAA,OAynBE,+BAA6B,SAAS;AACpC,eACE,uBAAuB,SAAS;;OA3nBtC;MAAA,KAAA;MAAA,OAmoBE,uCAAqC,SAAS;AAC5C,eAGI,wBACE,SACA,2BACA;;OA1oBV;MAAA,KAAA;MAAA,OAspBE,0CAAwC,SAAS;AAC/C,eAGI,mCACE,SACA,wBACA;;OA7pBV;MAAA,KAAA;MAAA,OAyqBE,yBAAuB,SAAS;AAC9B,eACE,mCAAmC,SAAS,OAAO,WAAW;;OA3qBpE;MAAA,KAAA;MAAA,OAqrBE,mBAAiB,SAAS;AACxB,eACE,uBAAuB,SAAS;;OAvrBtC;MAAA,KAAA;MAAA,OAisBE,8BAA4B,SAAS;AACnC,eACE,mCACE,SACA,WACA,kBACA;;OAvsBR;MAAA,KAAA;MAAA,OAgtBE,4BAA0B,iBAAiB;AACzC,eACE,iBAAiB,iBAAiB;;OAltBxC;MAAA,KAAA;MAAA,OA0tBE,sBAAoB,iBAAiB;AACnC,eACE,iBAAiB,iBAAiB;;OA5tBxC;MAAA,KAAA;MAAA,OAuuBE,6BAA2B,iBAAiB;AAC1C,eACE,wBAAwB,iBAAiB;;OAzuB/C;MAAA,KAAA;MAAA,OAivBE,kBAAgB,SAAQ;AACtB,eACE,WAAW,SAAQ;;OAnvBzB;MAAA,KAAA;MAAA,OA2vBE,wBAAsB,iBAAiB;AACrC,eACE,iBAAiB,iBAAiB;;OA7vBxC;MAAA,KAAA;MAAA,OAqwBE,gBAAc,SAAQ;AACpB,eAA+C,WAAW,SAAQ;;OAtwBtE;MAAA,KAAA;MAAA,OA6wBE,oCAAkC,iBAAiB;AACjD,eACE,iBAAiB,iBAAiB;;OA/wBxC;MAAA,KAAA;MAAA,OAuxBE,qCAAmC,iBAAiB;AAClD,eACE,iBAAiB,iBAAiB;;OAzxBxC;MAAA,KAAA;MAAA,OAiyBE,sCAAoC,iBAAiB;AACnD,eACE,wBAAwB,iBAAiB;;;AAnyB/C,WAAA;;;;;;;;;;;;;;;;;;;;;;;;;;ACdA,MAAa,kBAAb,2BAAA;AAAA,gCAAA;AAAA,wBAAA,MAAA;;AAAA,kBAAA,kBAAA,MAAA,CAAA;MAAA,KAAA;MAAA,OAME,gBAAc,KAAK;AACjB,eAAO,IAAI;;OAPf;MAAA,KAAA;MAAA,OAeE,qBAAmB,KAAK;AACtB,eAAO,IAAI;;OAhBf;MAAA,KAAA;MAAA,OAwBE,6BAA2B,KAAK;AAC9B,eAAO,IAAI,SAAS;;OAzBxB;MAAA,KAAA;MAAA,OAiCE,qBAAmB,KAAK;AACtB,eAAO,IAAI,SAAS;;OAlCxB;MAAA,KAAA;MAAA,OA0CE,sBAAoB,KAAK;AACvB,eAAO,IAAI,UAAU;;OA3CzB;MAAA,KAAA;MAAA,OAmDE,yBAAuB,KAAK;AAG1B,eAAO,IAAI,UAAU,mBAAmB,IAAI,UAAU;;OAtD1D;MAAA,KAAA;MAAA,OA6DE,+BAA6B;AAE3B,eAAO,KAAK,oBAAoB;;OA/DpC;MAAA,KAAA;MAAA,OAuEE,uBAAqB,KAAK;AACxB,YAAI,CAAC,IAAI,UAAU,YAAY;AAC7B,iBAAO;;AAET,eAAO,IAAI,UAAU,WAAW,KAAK,IAAI;;OA3E7C;MAAA,KAAA;MAAA,OAmFE,2BAAyB,KAAK;AAC5B,eAAO,IAAI;;OApFf;MAAA,KAAA;MAAA,OA4FE,kBAAgB,KAAK;AACnB,eAAO,IAAI;;;AA7Ff,WAAA;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA,MAAa,WAAb,2BAAA;AAIE,uBAAY,UAAU;AAAA,wBAAA,MAAA;AAEpB,WAAK,YAAY;AAGjB,WAAK,QAAQ;AAMb,WAAK,UAAU;AAGf,WAAK,SAAS;;AAlBlB,kBAAA,WAAA,CAAA;MAAA,KAAA;MAAA,OA2BE,aAAI,KAAK;AACP,eAAO,CAAC,CAAC,KAAK,OAAO;;OA5BzB;MAAA,KAAA;MAAA,OAmCE,aAAI,KAAK;AACP,YAAM,YAAY,KAAK,OAAO;AAC9B,YAAI,WAAW;AACb,oBAAU,SAAS,EAAE,KAAK;AAC1B,iBAAO,UAAU;;AAEnB,eAAO;;OAzCX;MAAA,KAAA;MAAA,OAgDE,aAAI,KAAK,SAAS;AAChB,YAAI,CAAC,KAAK,IAAI,MAAM;AAClB,eAAK;;AAEP,aAAK,OAAO,OAAO;UAAC;UAAS,QAAQ,KAAK;;AAC1C,aAAK;;OArDT;MAAA,KAAA;MAAA,OA2DE,kBAAS;AACP,YAAI,KAAK,SAAS,KAAK,WAAW;AAChC;;AAGF,YAAM,SAAQ,KAAK;AACnB,YAAI,SAAS,KAAK,UAAU;AAC5B,YAAI;AACJ,iBAAW,OAAO,QAAO;AACvB,cAAO,SAAU,OAAM,KAAhB;AACP,cAAI,SAAS,QAAQ;AACnB,qBAAS;AACT,wBAAY;;;AAIhB,YAAI,cAAc,QAAW;AAC3B,iBAAO,OAAM;AACb,eAAK;;;;AA7EX,WAAA;;;;ACOA,MAAM,sBAAsB,KAAK;IAE/B,KAAK;IAEL,KAAK;IAEL,KAAK;IAEL,MAAM;;AAOR,MAAI;AAQJ,MAAI;AAGJ,MAAM,sBAAsB;AAG5B,MAAM,uBAAuB;AAG7B,MAAM,qBAAqB;AAG3B,MAAM,uBAAuB;AAG7B,MAAM,iCAAiC;AAEvC,MAAM,oBAAoB;IACI;IACA;IACA;;AAIvB,MAAM,sBAAsB;AAO5B,wBAAsB,KAAK;AAChC,WAAO,IAAI,UAAU,mBAAmB,IAAI,SAAS,MAAM;;AAatD,8BAA4B,KAAK,aAAa;AACnD,QAAI,CAAC,GAAG;AACN,UAAuC,KAAK,SAAS,cAAc;AACnE,cAAQ,QACJ,OACA,KAAK,mBAAoB,MAAK,kBAAkB,IAAI,SAAS;;AAGnE,WAAO,cAAc,GAAG,KAAK,AAAU,cAAc,OAAO;;AAevD,yBAAuB,IAAG,KAAK,WAAW;AAC/C,QAAA,OAAY;AACV,SAAE,OAAO;AACT,aAAyB,IAAI,IAAI,KAAK,GAAE;;AAG1C,QAAI,aAAa,UAAU,IAAI,MAAM;AACnC,aAAO,UAAU,IAAI;;AAGvB,OAAE,OAAO;AAIT,QAAI,CAAC,GAAE,UAAU;AACf,SAAE,OAAO,GAAE;;AAGb,QAAM,OAAiC;MACrC,MAAM,GAAE;MACR,UAAU,GAAE;MACZ,MAAM,GAAE;MACR,UAAU,GAAE;MACZ,MAAM,GAAE,QAAQ,MAAM,KAAK,GAAE;MAC7B,UAAU,GAAE;MACZ,QAAQ,GAAE;MACV,MAAM,GAAE;MACR,QAAQ;;AAKV,QAAI,KAAK,SAAS,OAAO,KAAK;AAC5B,WAAK,WAAW,MAAM,KAAK;;AAK7B,QACG,KAAK,YAAY,WAAW,KAAK,QAAQ,MACzC,KAAK,YAAY,YAAY,KAAK,QAAQ,KAC3C;AACA,WAAK,OAAO;AACZ,WAAK,OAAO,KAAK;;AAKnB,QAAI;AACJ,QAAI,GAAE,UAAU,GAAE,UAAU,QAAQ;AAClC,eAAS,GAAE;eACF,KAAK,YAAY,WAAW,CAAC,KAAK,MAAM;AACjD,eAAS,KAAK;WACT;AACL,eAAS,KAAK,WAAW,OAAO,KAAK;;AAEvC,SAAK,SAAS;AAGd,QAAM,SAAS,UAAU,QAAQ,OAAO,SAAS,OAAO,OAAO,QAAQ;AAEvE,QAAI,WAAW;AACb,gBAAU,IAAI,KAAK;;AAGrB,WAAO;;AAWF,yCACL,KACA,aACA,gBACA;AACA,QAAI,CAAC,aAAa;AAChB,aAAO;;AAET,QAAM,kBAAkB,IAAI,MAAM,KAAK;AACvC,QAAM,eAAe,gBAAgB,GAAG,MAAM,KAAK;AAEnD,QAAI,SACF,aAAa,KACZ,cAAa,KACV,iBAAc,MACR,cADQ,MACO,aAAa,KADpB,MAER,aAAa,KAFL,MAEW,cAH5B,MAIO;AACV,cAAU,gBAAgB,KAAhB,MAAyB,gBAAgB,KAAO;AAC1D,WAAO;;AAWF,yBAAuB,KAAK,KAAK,OAAO,gBAAgB;AAC7D,QAAM,QAAW,mBAAmB,OAAzB,MAAiC,mBAAmB;AAC/D,WAAO,8BAA8B,KAAK,OAAO;;AAU5C,0BAAwB,KAAK,QAAQ;AAC1C,WAAO,8BAA8B,KAAK,qBAAqB;;AAU1D,iCAA+B,KAAK,QAAQ;AACjD,QAAM,WAAW,mBAAmB;AACpC,QAAM,iBAAiB,iBAAiB,SAAS;AACjD,QAAM,cAAc,KAAK;AACzB,QAAM,OAAO,OAAO,KAAK;AACzB,aAAS,IAAI,GAAG,IAAI,KAAK,QAAQ,KAAK;AACpC,UAAI,CAAC,OAAO,gBAAgB,KAAK,KAAK;AACpC,oBAAY,KAAK,MAAM,OAAO,KAAK;;;AAGvC,WAAO,eAAe,KAAK;;AAStB,gCAA8B,QAAQ;AAC3C,QAAM,IAAI;AACV,aAAW,KAAK,QAAQ;AACtB,UAAM,IAAI,OAAO;AACjB,UAAI,KAAK,MAAM;AACb;iBACS,QAAQ,IAAI;AACrB,iBAAS,IAAI,GAAG,IAAI,EAAE,QAAQ,KAAK;AACjC,cAAM,KAA4B,EAAE;AACpC,YAAE,KAAQ,mBAAmB,KAA7B,MAAmC,mBAAmB;;aAEnD;AACL,YAAM,MAA4B;AAClC,UAAE,KAAQ,mBAAmB,KAA7B,MAAmC,mBAAmB;;;AAG1D,WAAO,EAAE,KAAK;;AAQT,iCAA+B,KAAK;AACzC,QAAI,OAAO,OAAO,UAAU;AAC1B,YAAM,mBAAmB;;AAE3B,WACE,IAAI,YAAY,YAChB,IAAI,YAAY,eAChB,IAAI,YAAY,eAChB,SAAS,IAAI,UAAU;;AAepB,0BACL,WACA,gBACA,YACA;AAAA,QADA,eACA,QAAA;AADA,mBAAa;;AAEb,eACE,aAAa,MACb,2BACA,gBACA;AAGF,QAAM,eAAsC;AAC5C,eACE,sBAAsB,iBAAiB,UAAU,KAAK,eACtD,6HAGA,gBACA,YACA;AAEF,WAAO;;AAQF,wCAAsC,WAAW;AACtD,eACE,aAAa,KAAK,YAClB,kEACA;AAEF,WAAO,mBAAmB,WAAW;;AAShC,0BAAwB,KAAK;AAClC,QAAM,QAAQ,IAAI,QAAQ;AAC1B,QAAI,SAAS,IAAI;AACf,aAAO;;AAET,WAAO,IAAI,UAAU,GAAG;;AAsBnB,yBAAuB,KAAK;AACjC,QAAI,OAAO,OAAO,UAAU;AAC1B,YAAM,mBAAmB;;AAE3B,WAAO,KAAK,cAAc,KAAK,IAAI;;AAkB9B,+BAA6B,KAAK;AACvC,QAAI,OAAO,OAAO,UAAU;AAC1B,YAAM,mBAAmB;;AAE3B,QAAI,CAAC,cAAc,MAAM;AACvB,aAAO;;AAET,QAAM,OAAO,IAAI,SAAS,MAAM,KAAK;AACrC,WAAO,KAAK;;AAQP,6BAA2B,KAAK;AACrC,QAAI,OAAO,OAAO,UAAU;AAC1B,YAAM,mBAAmB;;AAE3B,WAAO,KAAK,eAAe,KAAK,IAAI;;AAS/B,2BAAyB,KAAK;AACnC,QAAI,CAAC,KAAK;AACR,aAAO;;AAET,QAAI,OAAO,OAAO,UAAU;AAC1B,YAAM,mBAAmB;;AAE3B,WAAO,CAAC,kBAAkB,SAAS,IAAI;;AAQlC,oCAAkC,KAAK;AAC5C,QAAM,SAAS,mBAAmB;AAClC,QAAM,SAAS,4BAA4B,OAAO;AAClD,WAAO,OAAO,SAAS,OAAO,WAAW,SAAS,OAAO;;AAuB3D,uCAAqC,WAAW;AAC9C,QAAI,CAAC,aAAa,aAAa,KAAK;AAClC,aAAO;;AAET,QAAM,SAAS,UACZ,QAAQ,qBAAqB,IAC7B,QAAQ,sBAAsB,IAC9B,QAAQ,oBAAoB,IAC5B,QAAQ,sBAAsB,IAC9B,QAAQ,gCAAgC,IACxC,QAAQ,SAAS;AACpB,WAAO,SAAS,MAAM,SAAS;;AA0B1B,wBAAsB,KAAK;AAChC,QAAI,OAAO,OAAO,UAAU;AAC1B,YAAM,mBAAmB;;AAI3B,QAAI,CAAC,cAAc,MAAM;AACvB,aAAO,IAAI;;AAOb,QAAM,OAAO,IAAI,SAAS,MAAM;AAChC,QAAM,SAAS,KAAK;AACpB,eACE,oBAAoB,SACpB,iCACA,IAAI;AAEN,QAAM,sBAAsB,KAAK;AACjC,QAAM,SACJ,uBAAuB,MACnB,aAAa,mBAAmB,KAAK,MACrC,YAAY,mBAAmB;AAErC,eAAW,OAAO,QAAQ,OAAO,GAAG,6BAA6B;AACjE,SAAK,OAAO,GAAG,uBAAuB,MAAM,IAAI;AAChD,WACE,SACA,KAAK,KAAK,OACV,4BAA4B,IAAI,UAC/B,KAAI,QAAQ;;AAUV,2BAAyB,KAAK;AACnC,WAAO,mBAAmB,aAAa,MAAM;;AASxC,8BAA4B,mBAAmB,SAAS;AAC7D,QAAI,OAAO,WAAW,UAAU;AAC9B,gBAAU,mBAAmB;;AAE/B,QAAc,OAAO,OAAO,YAAY;AACtC,aAAO,IAAI,IAAI,mBAAmB,QAAQ,MAAM;;AAElD,WAAO,4BAA4B,mBAAmB;;AAUjD,uCAAqC,mBAAmB,SAAS;AACtE,QAAI,OAAO,WAAW,UAAU;AAC9B,gBAAU,mBAAmB;;AAE/B,wBAAoB,kBAAkB,QAAQ,OAAO;AACrD,QAAM,cAAc,mBAAmB;AAGvC,QAAI,kBAAkB,cAAc,WAAW,YAAY,WAAW;AACpE,aAAO,YAAY;;AAIrB,QAAI,kBAAkB,WAAW,OAAO;AACtC,aAAO,QAAQ,WAAW;;AAI5B,QAAI,kBAAkB,WAAW,MAAM;AACrC,aAAO,QAAQ,SAAS;;AAI1B,WACE,QAAQ,SACR,QAAQ,SAAS,QAAQ,YAAY,OACrC;;AAUG,sBAAoB,KAAK,KAAK;AACnC,iBAAa;AACb,QAAM,eAAe,gBAAgB,IAAI,SAAS;AAClD,WAAO,cAAc,KAAK,qBAAqB;;AAO1C,wBAAsB,KAAK;AAChC,QAAM,YAAY,mBAAmB;AACrC,QAAM,SAAQ,iBAAiB,UAAU;AACzC,eACE,CAAE,wBAAuB,SACzB,sCACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3lBJ,MAAM,MAAM;AAGZ,MAAM,oBAAoB;AAG1B,MAAM,0BAA0B;AAOzB,oBAAkB,KAAK;AAAA,QAAA;AAC5B,WAAO,CAAC,CAAA,oBAAC,IAAI,eAAL,QAAC,gBAAgB;;AAQpB,yBAAuB,KAAK;AAAA,QAAA;AACjC,WAAO,qBAAA,IAAI,eAAJ,OAAA,SAAA,iBAAgB,SAAQ;;AAS1B,0BAAwB,KAAK,cAAc;AAChD,QAAM,UAAU,kBAAkB;AAClC,WAAO,CAAC,CAAC,QAAQ;;AAeZ,4BACL,KACA,cACA,QACA,yBACA;AACA,QAAM,cAAc,eAAe,KAAY;AAC/C,QAAM,KAAK,UAAH,OAAG,SAAU,CAAC;AACtB,QAAI,MAAM,aAAa;AACrB,UAAM,UAAU,kBAAkB;AAClC,cAAQ,gBAAgB;AAExB,UAAI,CAAC,yBAAyB;AAC5B,YAAM,gBAAgB,qBAAqB;AAC3C,sBAAc,gBAAgB;AAC9B,8BAAsB,KAAK;AAE3B,YAAI,CAAC,UAAU,MAAM;AACnB,iBAAO,KACL,KACA,sHACA,cACA,KAAK,YAAY,YACjB,IAAI,SAAS;;;;AAKrB,WAAO;;AASF,6BAA2B,KAAK;AAAA,QAAA,kBAAA;AACrC,QAAI,IAAI,0BAA0B;AAChC,aAAO,IAAI;;AAEb,QAAI,2BAA2B;AAC/B,QAAM,UAAU,IAAI;AAGpB,QAAI,IAAI,YAAY;AAClB,eAAW,gBAAgB,IAAI,YAAY;AACzC,YAAM,YAAY,IAAI,WAAW;AACjC,YAAI,OAAO,cAAc,YAAY,aAAa,KAAK,aAAa,GAAG;AACrE,kBAAQ,gBAAgB,KAAK,WAAW;;;;AAK9C,QAAM,kBAAe,oBAAG,IAAI,eAAP,OAAA,SAAG,iBAAiB;AACzC,QAAI,QAAQ,oBAAoB,gBAAgB,QAAQ;AACtD,UAAM,OAAO,IAAI,SAAS,KAAK,cAC7B;AAEF,UAAI,MAAM;AACR,YAAM,qBAAqB,KAAK,aAAa,WAAW,MAAM;AAC9D,iBAAA,YAAA,iCAAyB,qBAAzB,OAAA,CAAA,SAAA,aAAA,QAA6C;AAAA,cAAlC,aAAkC,MAAA;AAC3C,cAAI,MAAM,YAAY,iBAAiB,SAAS,aAAa;AAC3D,oBAAQ,cAAc;;;;;AAM9B,WAAO,OAAO,SAAS,qBAAqB;AAE5C,QAAM,kBAAe,oBAAG,IAAI,eAAP,OAAA,SAAG,iBAAiB;AACzC,QAAI,QAAQ,oBAAoB,gBAAgB,QAAQ;AACtD,UAAM,OAAO,IAAI,SAAS,mBAAmB,IAAI,SAAS;AAC1D,UAAM,SAAS,iBAAiB;AAChC,eAAA,aAAA,iCAAyB,kBAAzB,QAAA,CAAA,UAAA,cAAA,QAA0C;AAAA,YAA/B,cAA+B,OAAA;AACxC,YAAM,QAAQ,OAAM,OAAM;AAC1B,YAAI,SAAS,KAAK;AAChB,kBAAQ,eAAc;;AAExB,YAAI,SAAS,KAAK;AAChB,kBAAQ,eAAc;;;;AAI5B,WAAO;;AASF,mCAAiC,KAAK;AAC3C,WAAO,IAAI,4BAA4B;;AAQzC,gCAA8B,KAAK;AAAA,QAAA;AACjC,QAAI,oBAAoB;AACxB,QAAI;AACF,UAAI,kBAAkB,KAAK;AACzB,4BAAoB,IAAI,aAAa,QAAQ;;aAE/C,SAAA;AACA,YAAM,KAAK,KAAK;;AAElB,QAAM,SAAS,uBAAA,sBAAiB,OAAjB,SAAA,mBAAmB,MAAM,gBAAe;AAEvD,QAAM,UAAU;AAChB,aAAA,aAAA,iCAAoB,SAApB,QAAA,CAAA,UAAA,cAAA,QAA4B;AAAA,UAAjB,QAAiB,OAAA;AAC1B,UAAI,CAAC,OAAO;AACV;;AAEF,UAAI,MAAM,MAAM,KAAK;AACnB,gBAAQ,MAAM,OAAO,MAAM;aACtB;AACL,gBAAQ,SAAS;;;AAGrB,WAAO;;AAQT,iCAA+B,KAAK,SAAS;AAC3C,QAAM,gBAAgB;AACtB,aAAW,cAAc,SAAS;AAChC,oBAAc,KAAM,SAAQ,gBAAgB,QAAQ,MAAM,MAAM;;AAElE,QAAI;AAAA,UAAA;AACF,MAAA,qBAAA,IAAI,iBAAJ,OAAA,SAAA,kBAAkB,QAAQ,mBAAmB,cAAc,KAAK;aACzD,GAAP;AACA,aAAO,MAAM,KAAK;;;;;ACrMtB,MAAI,yBAAyB;AAE7B,MAAM,2BAA2B,CAAC,SAAS;AAuBpC,uCAAqC;AAC1C,WAAO,WAAW,wBAAwB;;AA+DrC,kCAAgC;AACrC,6BAAyB;;AAgLpB,mCAAiC,QAAQ;AAC9C,WAAO,OAAO,YAAY,KAAK,WAAM;AACnC,aAAO,CAAC,CAAC,OACN,UACA,cAAc;;;AAUd,6BAA2B,KAAK,QAAQ;AAE7C,QAAM,MAAM,mBAAmB,gBAAgB,YAAY,KAAK;AAChE,QAAM,SAAS,iBAAiB,IAAI;AACpC,QAAM,eAAe;AACrB,aAAS,IAAI,GAAG,IAAI,yBAAyB,QAAQ,KAAK;AACxD,UAAM,QAAQ,yBAAyB;AACvC,UAAI,OAAO,OAAO,WAAW,aAAa;AACxC,qBAAa,KAAK;;;AAKtB,QAAM,sBAAsB,OAAO,aAAa;AAChD,QAAK,OAAQ,OAAR;AACL,QAAI,qBAAqB;AACvB,aAAO,eAAe,MAAM,iBAAiB;;AAE/C,QAAM,MAAM,mBAAmB;AAC/B,QAAM,cAAc,iBAAiB,IAAI;AACzC,aAAS,KAAI,aAAa,SAAS,GAAG,MAAK,GAAG,MAAK;AACjD,UAAM,SAAQ,aAAa;AAC3B,UAAI,OAAO,YAAY,YAAW,aAAa;AAC7C,qBAAa,OAAO,IAAG;;;AAG3B,WAAO,iBAAiB;;AAQ1B,4BAA0B,QAAQ;AAChC,QAAI,MAAM;AACV,aAAS,IAAI,GAAG,IAAI,OAAO,QAAQ,KAAK;AACtC,UAAM,QAAQ,OAAO;AACrB,aACE,KAAK,IACE,QADP,kBAC4B,QAD5B,MAAA,MAEQ,QAFR,kBAE6B,QAF7B;;AAIJ,WAAO;;;;;;;;;;;;;;;;;;;;;;;;;;MC1UY,gBAAA,2BAAA;AAInB,8BAAc;AAAA,wBAAA,MAAA;AAEZ,WAAK,SAAS;;;;aAOhB,gBAAO;AACL,YAAM,IAAI,KAAK;AACf,YAAI,CAAC,GAAG;AACN,iBAAO;;AAET,eAAO,KAAK,OAAO,IAAI,GAAG;;;;aAQ5B,iBAAQ,MAAM,UAAU;AACtB,YAAI,MAAM,WAAW;AACnB,gBAAM,IAAI,MAAM;;AAElB,YAAM,IAAI,KAAK,cAAc;AAC7B,aAAK,OAAO,OAAO,GAAG,GAAG;UAAC;UAAM;;;;;aASlC,uBAAc,QAAQ;AACpB,YAAI,IAAI;AACR,YAAI,KAAK;AACT,YAAI,KAAK,KAAK;AACd,eAAO,MAAM,IAAI;AACf,cAAI,KAAK,MAAO,MAAK,MAAM;AAE3B,cAAI,MAAM,KAAK,QAAQ;AACrB;;AAKF,cAAI,KAAK,OAAO,GAAG,WAAW,QAAQ;AACpC,iBAAK,IAAI;qBACA,IAAI,KAAK,KAAK,OAAO,IAAI,GAAG,YAAY,QAAQ;AACzD,iBAAK,IAAI;iBACJ;AACL;;;AAGJ,eAAO;;;;aAMT,iBAAQ,UAAU;AAChB,YAAI,QAAQ,KAAK;AACjB,eAAO,SAAS;AACd,mBAAS,KAAK,OAAO,OAAO;;;;;aAShC,mBAAU;AACR,YAAI,CAAC,KAAK,QAAQ;AAChB,iBAAO;;AAET,eAAO,KAAK,OAAO,MAAM;;;;WAO3B,eAAa;AACX,eAAO,KAAK,OAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClFvB,MAAM,OAAM;AAGZ,MAAM,mBAAmB;AAGzB,MAAM,0BAA0B;AAEhC,MAAM,gBAAgB,CAAC,QAAQ;AAG/B,MAAM,sBAAsB;AAM5B,MAAM,2BAA2B;AAmB1B,gDAA8C,QAAQ;AAC3D,iCACE,QACA,MACA,YACsB;;AAkB1B,MAAa,aAAb,2BAAA;AAIE,yBAAY,QAAQ;AAAA,UAAA,QAAA;AAAA,wBAAA,MAAA;AAElB,WAAK,SAAS;AAGd,WAAK,YAAY,OAAO;AAGxB,WAAK,YAAY,SAAS,eAAe,KAAK;AAG9C,WAAK,UAAU,SAAS,aAAa,KAAK;AAG1C,WAAK,WAAW,SAAS,cAAc,KAAK;AAG5C,WAAK,YAAY,SAAS,YAAY,KAAK,OAAO;AAGlD,WAAK,eAAe,KAAK,UAAU,WAAW,KAAK,UAAU;AAG7D,WAAK,aACH,UAAU,KAAK,OAAO,QAAQ,KAAK,QAAQ;AAG7C,WAAK,WACH,KAAK,aAAa,KAAK,OAAO,iBAAiB,CAAC,CAAC,KAAK,OAAO;AAG/D,WAAK,YAAY,QAAQ,KAAK,OAAO,KAAK,WAAW;AAMrD,WAAK,kBACH,KAAK,UAAU,YAAY,KAAK,gBAC5B,KAAK,UAAU,kBACf,KAAK;AAIX,WAAK,eAAe,KAAK,QAAQ,KAAK;AACtC,WAAK,UAAU,iBAAiB,kBAAkB,KAAK;AACvD,WAAK,UAAU,iBAAiB,yBAAyB,KAAK;AAE9D,WAAK,qBAAqB;AAC1B,8BAAwB,KAAK,QAAQ,KAAK,SAAC,KAAQ;AACjD,cAAK,qBAAqB;;AAI5B,WAAK,mBAAmB;AAExB,WAAK,iBAAiB;AACtB,cAAQ,IAAI,CACV,KAAK,QAAQ,mBACb,KAAK,QAAQ,oBACZ,KAAK,SAAC,SAAW;AAClB,cAAK,mBAAmB,QAAO;AAC/B,cAAK,iBAAiB,kBAAkB,QAAO;;AAOjD,WAAK,eAAe;AAOpB,WAAK,kBAAkB,IAAI;AAO3B,WAAK,sBAAsB,IAAI;;AAvFnC,mBAAA,aAAA,CAAA;MAAA,KAAA;MAAA,OA2GE,mBAAU;AACR,YAAI,KAAK,cAAc;AACrB,eAAK,UAAU,oBAAoB,kBAAkB,KAAK;AAC1D,eAAK,UAAU,oBACb,yBACA,KAAK;;;OAhHb;MAAA,KAAA;MAAA,OA8HE,oBAAW,KAAK,KAAK,QAAQ,QAAQ;AACnC,YAAI,UAAU;AAMd,YAAK,MAAK,UAAU,WAAW,CAAC,KAAK,UAAU,eAAe,CAAC,QAAQ;AACrE,qBAAW;;AAGb,YAAM,SAAS,iBAAiB,KAAK,KAAK,QAAQ;AAElD,YAAI,UAAU,CAAC,QAAQ;AACrB,iBAAO,SAAS;;;OA5ItB;MAAA,KAAA;MAAA,OA8JE,oBAAW,KAAK,KAAK,iBAAiB,SAAc;AAAA,YAAd,YAAc,QAAA;AAAd,oBAAU;;AAC9C,YAAA,WAA0C,SAA1C,kBAAA,SAAO,QAAA,SAAP,oBAAA,SAAgB,QAAhB,iBAAA,kBAAA,SAAuB,QAAA,SAAvB,oBAAA,SAAgC,SAAhC;AACA,cAAM,KAAK,yBAAyB;AACpC,YAAM,aAAa,SAAS,UAAU,KAAK;AAC3C,YAAI,CAAC,WAAW,gBAAgB,MAAM;AACpC,iBAAO,MAAM,MAAK,0CAA0C;AAC5D;;AAGF,mBACE,cAAc,SAAS,SADf,aAEG,SAFH;AAMV,YAAM,YAAY,WAAW,aAAa,IAAI;AAC9C,cAAM,WAAW,mBAAmB,KAAK;AAKzC,YAAI,UAAU,UAAU;AACtB,eAAK,WAAW,KAAK,KAAK,QAAQ;AAClC;;AAKF,YAAI,iBAAiB;AACnB,cAAI,CAAC,KAAK,cAAc;AACtB,iBAAK,eAAe,KAAK;;AAE3B,cAAI,KAAK,aAAa,SAAS,kBAAkB;AAC/C,gBAAI,KAAK,iBAAiB,KAAK,kBAAkB;AAC/C;;;;AAMN,YAAI,IAAI,SAAS,OAAO;;OAtM5B;MAAA,KAAA;MAAA,OAmNE,0BAAiB,KAAK,aAAa;AACjC,YAAI,KAAK,QAAQ,cAAc,QAAQ;AACrC,eAAK,QAAQ,YACX,eACA,KAAK;YACH,OAAO;YACP,eAAe;;AAGnB,iBAAO;;AAET,eAAO;;OA9NX;MAAA,KAAA;MAAA,OAqOE,6BAAoB;AAClB,YAAM,OAAO,KAAK,UAAU,cAC1B;AAEF,YAAI,QAAQ,KAAK,aAAa,YAAY;AACxC,iBAAO,KACJ,aAAa,WACb,MAAM,KACN,IAAI,SAAC,GAAD;AAAA,mBAAO,EAAE;;;AAElB,eAAO;;OA/OX;MAAA,KAAA;MAAA,OA4PE,iBAAQ,GAAG;AACT,YAAI,EAAE,kBAAkB;AACtB;;AAEF,YAAM,UAAU,MAAM,cACpB,EAAE,6BAA6B,EAAE;AAEnC,YAAM,SAAS,iCAAiC,SAAS;AACzD,YAAI,CAAC,UAAU,CAAC,OAAO,MAAM;AAC3B;;AAEF,YAAI,EAAE,QAAQ,kBAAkB;AAC9B,eAAK,aAAa,QAAQ;mBACjB,EAAE,QAAQ,yBAAyB;AAC5C,eAAK,wBAAwB,QAAQ;;;OA1Q3C;MAAA,KAAA;MAAA,OAmRE,sBAAa,SAAS,GAAG;AACvB,aAAK,qBAAqB;AAE1B,YAAI,aAAa,KAAK,UAAU,QAAQ;AAGxC,YAAI,KAAK,gBAAgB,GAAG,SAAS,aAAa;AAChD;;AAIF,YAAI,KAAK,2BAA2B,GAAG,SAAS,aAAa;AAC3D;;AAGF,YAAM,eAAe,KAAK;AAK1B,YAAI,iBAAiB,eAAe,iBAAiB,eAAe;AAClE,eAAK,qBAAqB,SAAS;AACnC,uBAAa,KAAK,UAAU,QAAQ;;AAItC,aAAK,kBAAkB,GAAG,SAAS,YAAY;;OA7SnD;MAAA,KAAA;MAAA,OAsTE,iCAAwB,SAAS,GAAG;AAElC,aAAK,qBAAqB;AAC1B,aAAK,qBAAqB,SAAS;;OAzTvC;MAAA,KAAA;MAAA,OAiUE,8BAAqB,SAAS,GAAG;AAC/B,aAAK,gBAAgB,QAAQ,SAAC,eAAkB;AAC9C,wBAAc,SAAS;;;OAnU7B;MAAA,KAAA;MAAA,OA4UE,kCAAyB,KAAK;AAC5B,aAAK,oBAAoB,QAAQ,SAAC,SAAY;AAC5C,gBAAM,QAAQ;;AAEhB,eAAO;;OAhVX;MAAA,KAAA;MAAA,OAuVE,8BAAqB,IAAI;AAEvB,YAAI,yBAAyB;AAC7B,YAAI,KAAK,sBAAsB,CAAC,KAAK,UAAU;AAE7C,mCAAyB,kBAAkB,KAAK,OAAO,KAAK;;AAG9D,YAAM,kBAAkB,SAAS,sBAAsB;AACvD,wBAAgB,gBAAgB,IAAI;;OAhWxC;MAAA,KAAA;MAAA,OA4WE,oCAA2B,GAAG,SAAS,UAAU;AAE/C,YAAI,CAAC,KAAK,YAAY;AACpB,iBAAO;;AAIT,YAAM,MAAM,MAAM,QAAQ,cAAc;AACxC,YAAM,MAAM,QAAQ;AACpB,YAAO,WAAY,SAAZ;AAKP,YAAM,QAAQ,YAAY;AAG1B,YAAI,OAAO;AACT,2BAAiB,KAAK,KAAK;AAC3B,YAAE;AACF,iBAAO;;AAGT,YAAM,mBAAmB,qBAAqB,KAAK;AACnD,YAAI,KAAK,gBAAgB,CAAC,kBAAkB;AAC1C,2BAAiB,KAAK,KAAK;AAG3B,YAAE;AACF,iBAAO;;AAGT,eAAO;;OA5YX;MAAA,KAAA;MAAA,OAwZE,yBAAgB,GAAG,SAAS,UAAU;AACpC,YAAI,CAAC,QAAQ,aAAa,QAAQ;AAChC,iBAAO;;AAET,YAAM,YAAY,QACf,aAAa,OACb,MAAM,KACN,IAAI,SAAC,GAAD;AAAA,iBAAO,EAAE;;AAChB,YAAI,CAAC,UAAU,SAAS,YAAY;AAClC,iBAAO;;AAGT,YAAI,KAAK,iBAAiB,SAAS,MAAM,oBAAoB;AAC3D,YAAE;AACF,iBAAO;;AAET,eAAO;;OAxaX;MAAA,KAAA;MAAA,OAmbE,2BAAkB,GAAG,SAAS,YAAY,cAAc;AACtD,YAAM,KAAK,iBAAiB;AAC5B,YAAM,OAAO,iBAAiB;AAG9B,YAAI,WAAW,QAAQ,MAAM,MAAM;AACjC,eAAK,sBAAsB,GAAG,YAAY;eACrC;AAEL,cAAI,SAAU,SAAQ,aAAa,aAAa,IAAI;AAEpD,cAAI,KAAK,YAAY,KAAK,WAAW;AAEnC,gBAAI,UAAU,UAAU,UAAU,UAAU;AAC1C,uBAAS;AACT,sBAAQ,aAAa,UAAU;;;AAKnC,cAAO,MAAO,KAAK,OAAZ;AACP,cAAM,WAAW,SAAS,YAAY;AACtC,cAAM,SAAS,SAAS,aAAa;AACrC,cACE,aAAa,UACb,SAAS,cACT,SAAS,qBAAqB,MAC9B,OAAO,mBACP,OAAO,cACP;AACA,iBAAK,mCAAmC,KAAK,cAAc;;AAG7D,cAAI,KAAK,2BAA2B,IAAI,oBAAoB;AAC1D,cAAE;;;;OArdV;MAAA,KAAA;MAAA,OAkeE,4CAAmC,KAAK,cAAc,QAAQ;AAC5D,cAAM,KACJ,MACA,mDACA,aAAa;AAEf,YAAM,WAAW,aAAa;AAC9B,YAAM,UAAO,KAAM,aAAa,SAAS,aAAa,WAAW,aAAa;AAC9E,YAAI,QAAQ,aAAa,MAAM,IAAI;AAEnC,YAAM,eAAe,yBAAM;AACzB,cAAM,cAAc,IAAI,SAAS;AACjC,cAAI,eAAe,SAAS;AAC1B,kBAAM,KAAK,MAAK,0CAA0C;AAC1D,gBAAI,QAAQ,aAAa,MAAM,IAAI;iBAC9B;AACL,kBAAM,MAAM,MAAK,iCAAiC,aAAa;;;AAKnE,YAAI,WAAW,UAAU;AACvB,cAAI,WAAW,cAAc;eACxB;AAGL,cAAI,iBAAiB,YAAY,oBAAoB,GAAG;AACtD,gBAAI,EAAE,WAAW;AACf;AACA,kBAAI,oBAAoB,YAAY;;;;;OA/f9C;MAAA,KAAA;MAAA,OA4gBE,+BAAsB,GAAG,YAAY,cAAc;AAAA,YAAA,SAAA;AAKjD,YAAe,SAAS,YAAY,KAAK,OAAO,KAAK,QAAQ;AAC3D,cAAM,KAAK,WAAW,KAAK,UAAU;AACrC,cAAM,gBAAgB,KAAK,OAAO,eAAe;AACjD,cAAI,eAAe;AACjB,gBACE,CAAC,wCAAwC,KAAK,cAAc,UAC5D;AACA,4BAAc,WAAW;;AAE3B,qBAAS;;;AAOb,UAAE;AAIF,YAAI,KAAK,UAAU;AACjB;;AAIF,YAAM,OAAO,WAAW,KAAK,MAAM;AACnC,YAAI,KAAK;AACT,YAAI,MAAM;AACR,cAAM,cAAc,uBAAuB;AAC3C,eACE,KAAK,UAAU,eAAe,SAG9B,KAAK,UAAiB,cAAtB,aAA+C,cAA/C;;AAKJ,YAAI,WAAW,QAAQ,aAAa,MAAM;AACxC,eAAK,SAAS,sBAAsB,WAAW,MAAM,KAAK,WAAM;AAC9D,mBAAK,iBAAiB,IAAI;;eAEvB;AAEL,eAAK,iBAAiB,IAAI;;;OA7jBhC;MAAA,KAAA;MAAA,OAqkBE,+BAAsB,UAAU,UAAU;AACxC,aAAK,gBAAgB,QAAQ,UAAU;;OAtkB3C;MAAA,KAAA;MAAA,OA6kBE,mCAA0B,UAAU,UAAU;AAC5C,aAAK,oBAAoB,QAAQ,UAAU;;OA9kB/C;MAAA,KAAA;MAAA,OAulBE,0BAAiB,MAAM,MAAM;AAAA,YAAA,SAAA;AAE3B,YAAI,MAAM;AASR,eAAK,UAAiB,eAAe;AACrC,mBAAS,SAAS,KAAK,OAAO,KAAK,MACjC,WAAA;AAAA,mBAAM,OAAK,UAAiB,eAAe,MAAM,cAAc;aAC/D;eAEG;AACL,gBAAM,KACJ,MADF,oCAEoC,OAFpC,gBAEsD,OAFtD;;;OAxmBN;MAAA,KAAA;MAAA,OAonBE,mBAAU,KAAK;AACb,eAAO,SAAS,UAAU,KAAK,iBAAiB,MAAM;;OArnB1D;MAAA,KAAA;MAAA,OA4nBE,wBAAe;AAGb,YAAM,WACJ,UAAU,QAAQ,CAAC,KAAK,WAAW,KAAK,OAAO,IAAI,SAAS,OAAO;AACrE,eAAO,KAAK,UAAU;;OAjoB1B;MAAA,KAAA;MAAA,OAmpBE,oCAA2B,KAAK,aAAa;AAC3C,YAAM,sBAAsB,KAAK,QAAQ,cACvC;AAEF,YAAM,aACJ,KAAK,OAAO,iBACZ,KAAK,OACF,cACA,gBAAgB,aAAa;AAElC,YACE,CAAC,uBACD,CAAC,cACD,CAAE,MAAK,oBAAoB,KAAK,iBAChC;AACA,iBAAO;;AAGT,aAAK,QAAQ,YACX,cACA,KAAK;UACH,OAAO;UACP,eAAe;;AAGnB,eAAO;;QA5qBX,CAAA;MAAA,KAAA;MAAA,OAgGE,uCAAqC,QAAQ,KAAK;AAChD,YAAI,SAAS,gBAAgB,iBAC3B,SACA,qBAAqB,KAAK,MAAM,SAClB;;;AApGpB,WAAA;;AAurBA,gCAA8B,QAAQ,GAAG;AACvC,QAAM,SAAS,iCACb,MAAM,cAAc,EAAE,SACtB;AAEF,QAAI,CAAC,UAAU,CAAC,OAAO,MAAM;AAE3B;;AAEF,QAAM,eACJ,OAAO,aAAa,wBAAwB,OAAO,aAAa;AAClE,QAAI,CAAC,cAAc;AACjB;;AAEF,QAAM,OAAO;MACX,WAAW,mBAAM;AACf,eAAO,EAAE;;MAEX,WAAW,mBAAM;AACf,eAAO,EAAE;;;AAGb,QAAM,UAAU,SAAS,sBAAsB,QAAQ,cACrD,cACA,MACoB;MAIlB,WAAW;MACX,WAAW;;AAGf,QAAI,WAAW,cAAc;AAG3B,UAAI,CAAC,OAAO,aAAa,sBAAsB;AAC7C,eAAO,aAAa,qBAAqB;;AAE3C,aAAO,aAAa,QAAQ;;;AAShC,4BAA0B,UAAU;AAClC,WAAA,KAAU,SAAS,SAAS,SAAS,WAAW,SAAS;;;;ACnyBpD,MAAM,YAAY;IACvB,sBAAsB;IACtB,8BAA8B;IAC9B,kBAAkB;IAClB,YAAY;IACZ,cAAc;IACd,sBAAsB;IACtB,yBAAyB;IACzB,2BAA2B;IAE3B,oCAAoC;IACpC,wCAAwC;IACxC,gBAAgB;IAChB,oBAAoB;IACpB,wBAAwB;IACxB,gCAAgC;IAChC,aAAa;IACb,mBAAmB;IACnB,4BAA4B;IAC5B,sBAAsB;IACtB,wBAAwB;IACxB,gBAAgB;IAChB,kCAAkC;IAClC,+BAA+B;IAC/B,iCAAiC;IACjC,kBAAkB;IAClB,iBAAiB;IACjB,mBAAmB;IACnB,iBAAiB;IACjB,kBAAkB;IAClB,SAAS;IACT,aAAa;IACb,mBAAmB;IACnB,aAAa;IACb,qBAAqB;IACrB,qBAAqB;IACrB,kCAAkC;IAClC,iBAAiB;IACjB,qBAAqB;IACrB,kBAAkB;;;;ACtCb,MAAM,sBAAsB;AAO5B,MAAM,iBAAiB;AAQvB,MAAM,cAAc;IAQzB,KAAK;IASL,SAAS;IAOT,MAAM;;AAOD,+BAA6B,aAAa;AAC/C,YAAQ;WACD,YAAY;AACf,eAAO;WACJ,YAAY;AACf,eAAO;;AAEP,mBAAU,gBAAgB,YAAY;AACtC,eAAO;;;;;ACjEb,MAAI;AASG,mBAAiB,WAAW;AACjC,QAAM,MAAM,UAAU,iBAAiB;AACvC,QAAI,CAAC,iBAAiB,cAAc,kBAAkB,KAAK;AACzD,sBAAgB,IAAI,cAAc;;AAGpC,WAAO;;AAkDT,gBAAc,SAAS;AACrB,WAAO,WAAW,eAAe;;AASnC,sBAAoB,WAAW,SAAS;AACtC,cAAU,QAAQ,WAAW,GAAG;AAChC,cAAiB,YAAY,QAAQ;AAErC,QAAM,KAAK,UAAU;AACrB,cAAU,IAAI;AACd,cAAU,CAAC,GAAG,oBAAoB;AAGlC,cAAU,YAAY;AAEtB,WAAO;;;;ACpFT,MAAI;AAGJ,MAAM,iBAAiB,CAAC,UAAU,UAAU,OAAO,OAAO,MAAM,KAAK;AAErE,MAAM,wBAA6D;IACjE,uBAAuB,+BAAA;AAAA,aAAM;;IAC7B,oBAAoB,4BAAA;AAAA,aAAM;;;AAOrB,gCAA8B,WAAW;AAC9C,WAAO,UAAU,OAAO,GAAG,gBAAgB,UAAU,MAAM;;AAW7D,oCAAkC,OAAO,WAAW;AAClD,aAAS,IAAI,GAAG,IAAI,eAAe,QAAQ,KAAK;AAC9C,UAAM,eAAe,eAAe,KAAK;AACzC,UAAI,MAAM,kBAAkB,QAAW;AACrC,eAAO;;;AAGX,WAAO;;AAaF,mCAAiC,OAAO,WAAW,iBAAiB;AACzE,QAAI,MAAM,YAAY;AAEpB,aAAO;;AAET,QAAI,CAAC,mBAAmB;AACtB,0BAAoB;;AAEtB,QAAI,eAAe,kBAAkB;AACrC,QAAI,CAAC,gBAAgB,iBAAiB;AACpC,qBAAe;AACf,UAAI,MAAM,eAAe,QAAW;AAClC,YAAM,YAAY,qBAAqB;AACvC,YAAM,uBAAuB,yBAAyB,OAAO;AAE7D,YAAI,MAAM,0BAA0B,QAAW;AAC7C,yBAAe;;;AAGnB,UAAI,CAAC,iBAAiB;AACpB,0BAAkB,aAAa;;;AAGnC,WAAO;;AASF,8BAA4B,SAAS,QAAQ;AAClD,QAAO,QAAS,QAAT;AACP,aAAW,KAAK,QAAQ;AACtB,YAAM,YACJ,wBAAwB,OAAO,IAC/B,OAAO,OAAO,KACd;;;AAaC,oBAAkB,SAAS,UAAU,OAAO,WAAW,iBAAiB;AAC7E,QAAM,eAAe,wBACnB,QAAQ,OACR,UACA;AAEF,QAAI,CAAC,cAAc;AACjB;;AAEF,QAAM,aACJ,YAAY,QAAQ,YAAY;AAElC,QAAI,MAAM,eAAe;AACvB,cAAQ,MAAM,YAAY,cAAc;WACnC;AACL,cAAQ,MAAM,gBAAgB;;;AAgC3B,qBAAmB,SAAS,QAAQ;AACzC,aAAW,KAAK,QAAQ;AACtB,eAAS,SAAS,GAAG,OAAO;;;AAyEzB,kBAAgB,SAAS,aAAa;AAC3C,QAAI,gBAAgB,QAAW;AAC7B,oBAAc,QAAQ,aAAa;;AAErC,QAAI,aAAa;AACf,cAAQ,gBAAgB;WACnB;AACL,cAAQ,aAAa,UAAU;;;AAS5B,cAAY,OAAO;AACxB,WAAU,QAAV;;AA8BK,qBAAmB,GAAG,OAAO;AAClC,QAAI,OAAO,KAAK,UAAU;AACxB,UAAI,GAAG;;AAET,QAAI,UAAU,QAAW;AACvB,aAAA,eAAoB,IAApB;;AAEF,QAAI,OAAO,SAAS,UAAU;AAC5B,cAAQ,GAAG;;AAEb,WAAA,eAAoB,IAApB,OAA0B,QAA1B;;AA8CK,yBAAuB,KAAK,IAAI;AACrC,QAAM,QAA6C,IAAI,iBAAiB;AACxE,WAAO,SAAS;;AAQX,uBAAqB,SAAS,YAAY;AAC/C,aAAS,IAAI,GAAG,IAAI,WAAW,QAAQ,KAAK;AAC1C,eAAS,SAAS,WAAW,IAAI;;;AAS9B,oCAAkC,QAAQ,MAAM;AACrD,QAAI,OAAO,aAAa,eAAe;AACrC,eAAS,MAAM,cAAc,OAAO,aAAa;;AAGnD,QAAI,OAAO,aAAa,oBAAoB;AAC1C,eAAS,MAAM,mBAAmB,OAAO,aAAa;;;AAQ1D,iBAAe,UAAU;AACvB,WAAO,SAAS,WAAW;;;;ACtWtB,oDAAkD,KAAK;AAE5D,QAAI,CAAC,IAAI,aAAa,UAAU,YAAY,OAAO,OAAO;AACxD,UAAM,SAAS,IAAI,aAAa;AAChC,UAAM,WAAU,MAAM,KAAK;AAC3B,UAAI,YAAW,MAAM;AACnB;;AAEF,UAAM,YAAY,SAAQ;AAC1B,UAAI,aAAa,OAAO;;;AAYrB,0BAAwB,KAAK,OAAO,QAAQ;AACjD,QAAM,SACJ,IAAI,cAAc;AAEpB,WAAO,QAAQ;AACf,WAAO,SAAS;AAKhB,WAAO,OAAO;;;;;;;;;;;;ACpBT,MAAM,SAAS;IACpB,WAAW;IACX,OAAO;IACP,cAAc;IACd,YAAY;IACZ,WAAW;IACX,MAAM;IACN,WAAW;IACX,OAAO;IACP,WAAW;;AAQN,MAAM,iBAAiB;IAC5B,SAAS;IACT,UAAU;IACV,KAAK;IACL,YAAY;;AA2BP,MAAM,qBAAqB;IAChC,aAAa;MAAC,OAAO;MAAO,QAAQ;;IACpC,iBAAiB;MAAC,OAAO;MAAO,QAAQ;;IAExC,aAAa;IACb,oBAAoB;MAAC,OAAO;MAAQ,QAAQ;;;AAUvC,MAAM,oBAAoB;IAC/B,UAAU;IACV,YAAY;IACZ,aAAa;IACb,gBAAgB;IAChB,yBAAyB;IACzB,qBAAqB;IACrB,6BAA6B;IAC7B,cAAc;IACd,WAAW;IACX,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,gBAAgB;IAChB,cAAc;IACd,eAAe;;AAQjB,MAAM,uBACJ;AAMF,MAAI,sBAAsB;AAOnB,uBAAqB,GAAG;AAC7B,aAAW,KAAK,QAAQ;AACtB,UAAI,OAAO,MAAM,GAAG;AAClB,eAAO,OAAO;;;AAGlB,WAAO;;AAOF,0BAAwB,QAAQ;AACrC,WAAO,sBAAsB;;AAQxB,+BAA6B,QAAQ;AAC1C,WACE,UAAU,OAAO,SACjB,UAAU,OAAO,gBACjB,UAAU,OAAO,cACjB,UAAU,OAAO,QACjB,UAAU,OAAO,aACjB,UAAU,OAAO,SACjB,UAAU,OAAO;;AAkBd,6BAA2B,KAAK;AACrC,QAAM,UAAU,OAAO,OAAO,WAAW,MAAM,IAAI;AACnD,WAAO,WAAW,QAAQ,cAAc,WAAW;;AAS9C,uBAAqB,GAAG;AAC7B,QAAI,OAAO,KAAK,UAAU;AACxB,aAAO,IAAI;;AAEb,QAAI,CAAC,GAAG;AACN,aAAO;;AAET,QAAI,CAAC,6DAA6D,KAAK,IAAI;AACzE,aAAO;;AAET,QAAI,gBAAgB,KAAK,IAAI;AAC3B,aAAO,IAAI;;AAEb,WAAO;;AASF,wBAAsB,QAAQ;AACnC,eACE,4DAA4D,KAAK,SACjE,4BACA;AAEF,WAAkC;;AAwB7B,0BAAwB,QAAQ;AACrC,iBAAa;AACb,QAAM,IAAI,WACR,UAAU,KAAK,SACf,gCACA;AAEF,WAAO,EAAE;;AAQJ,4BAA0B,QAAQ;AACvC,QAAM,MAAM,WAAW;AACvB,WAAO,eAAe,OAAO,MAAM;;AAS9B,gCAA8B,SAAS;AAC5C,cAAU,QAAQ;AAClB,WAAO,mBAAmB,aAAa;;AAWlC,gCAA8B,SAAS;AAC5C,QAAM,UAAU,QAAQ,QAAQ;AAChC,cAAU,mBAAmB,aAAa;AAC1C,QAAI,CAAC,mBAAmB,UAAU;AAChC,UAAM,MAAM,QAAQ;AACpB,UAAM,iBAAiB,QAAQ,QAAQ,UAAU;AACjD,UAAM,OAAO,IAAI,cAAc;AAE/B,WAAK,WAAW;AAChB,gBAAU,MAAM;QACd,UAAU;QACV,YAAY;;AAEd,UAAI,KAAK,YAAY;AACrB,yBAAmB,WAAW;QAC5B,OAAQ,MAAY,eAAe,KAAK;QACxC,QAAS,MAAY,gBAAgB,KAAK;;AAE5C,UAAI,KAAK,YAAY;;AAEvB,WAAqC,mBAAmB;;AAUnD,4BAA0B,SAAS;AACxC,QAAM,UAAU,QAAQ,QAAQ;AAChC,WAAO,kBAAkB,YAAY,6BAA6B;;AAU7D,wCAAsC,SAAS;AACpD,QAAI,WAAW,aAAa;AAC1B,aAAO;;AAET,WAAO,qBAAqB,KAAK;;AAoB5B,6BAA2B,SAAS,gBAAwB;AAAA,QAAxB,mBAAwB,QAAA;AAAxB,uBAAiB;;AAK1D,QAAM,sBAAsB,QAAQ,aAAa;AACjD,QAAI,qBAAqB;AACvB,UAAM,UACJ,UAAU,YAAY;AAExB,UACG,YAAU,OAAO,cAAc,WAAU,OAAO,cACjD,QAAQ,mBACR;AAEA,gBAAQ,eACN,QAAQ,cAAc,sBAAsB;AAC9C,YAAI,QAAQ,cAAc;AACxB,kBAAQ,aAAa,aAAa,QAAQ;;iBAEnC,WAAU,OAAO,WAAW;AACrC,eAAO,SAAS;AAGhB,gBAAQ,SAAS,aAAa;;AAEhC,aAAO;;AAQT,QAAM,aAAa,QAAQ,aAAa;AACxC,QAAM,YAAY,QAAQ,aAAa;AACvC,QAAM,aAAa,QAAQ,aAAa;AACxC,QAAM,YAAY,QAAQ,aAAa;AACvC,QAAM,cAAc,QAAQ,aAAa;AAGzC,QAAM,cAAc,aAAa,YAAY,cAAc;AAC3D,eACE,gBAAgB,QAChB,kCACA,YACA;AAGF,QAAM,aACJ,aAAa,aAAa,SAAS,YAAY,aAAa;AAC9D,eACE,eAAe,QACf,iCACA,WACA;AAGF,QAAM,cACJ,cAAc,cAAc,UAAU,YAAY,cAAc;AAClE,eACE,gBAAgB,QAChB,kCACA,YACA;AAIF,QAAI;AACJ,QAAI;AACJ,QAAI;AAGJ,QACG,EAAC,eACA,eAAe,OAAO,SACtB,eAAe,OAAO,iBACvB,EAAC,cAAc,CAAC,gBACjB,qBAAqB,QAAQ,UAC7B;AAGA,UAAM,aAAa,qBAAqB;AACxC,cACE,cAAc,eAAe,OAAO,eAChC,aACA,WAAW;AACjB,eAAS,eAAe,WAAW;WAC9B;AACL,cAAQ;AACR,eAAS;;AAIX,QAAI,aAAa;AACf,eAAS;eACA,CAAC,SAAS,CAAC,QAAQ;AAC5B,eAAS,OAAO;eACP,UAAU,SAAS;AAC5B,eAAS,OAAO;eACP,UAAW,EAAC,SAAS,SAAS,SAAS;AAChD,eAAS,OAAO;eACP,UAAU,SAAU,cAAa,cAAc;AACxD,eAAS,OAAO;WACX;AACL,eAAS,OAAO;;AAIlB,QACE,UAAU,OAAO,SACjB,UAAU,OAAO,gBACjB,UAAU,OAAO,cACjB,UAAU,OAAO,WACjB;AACA,iBAAW,QAAQ,yCAAyC;;AAE9D,QAAI,UAAU,OAAO,cAAc;AACjC,iBACE,CAAC,SAAS,SAAS,QACnB,uDACA;;AAGJ,QACE,UAAU,OAAO,SACjB,UAAU,OAAO,cACjB,UAAU,OAAO,WACjB;AACA,iBACE,SAAS,SAAS,QAClB,4DACA;;AAIJ,QAAI,UAAU,OAAO,cAAc,UAAU,OAAO,WAAW;AAC7D,iBACE,eAAe,UAAU,eAAe,SACxC,wEACA,WACA,YACA;WAEG;AACL,iBACE,gBAAgB,MAChB,2CACA;;AAKJ,YAAQ,UAAU,IAAI,eAAe;AACrC,QAAI,oBAAoB,SAAS;AAC/B,cAAQ,UAAU,IAAI;;AAExB,QAAI,UAAU,OAAO,WAAW;AAG9B,aAAO,SAAS;AAGhB,cAAQ,SAAS,aAAa;eACrB,UAAU,OAAO,OAAO;AACjC,gBAAU,SAAS;QACjB,OAAO,MAAM,aAAa;QAC1B,QAAQ,MAAM,aAAa;;eAEpB,UAAU,OAAO,cAAc;AACxC,eAAS,SAAS,UAAU,MAAM,aAAa;eACtC,UAAU,OAAO,YAAY;AACtC,UAAI,wBAAwB,MAAM,QAAQ,cAAc,eAAe;AACrE,iBACE,SACA,gBACG,iBAAiB,SAHd,MAGwB,iBAAiB;aAE5C;AACL,YAAM,QAAQ,QAAQ,cAAc,cAAc;AAClD,cAAM,aAAa,QAAQ;AAC3B,kBAAU,OAAO;UACf,YACG,iBAAiB,UAAU,iBAAiB,SAAU,MAAM;;AAEjE,gBAAQ,aAAa,OAAO,QAAQ;AACpC,gBAAQ,eAAe;;eAEhB,UAAU,OAAO,WAAW;AAIrC,UAAM,SAAQ,QAAQ,SAAX,mBAAA,mBAAA,4BAAA,CAAA;AAKX,UAAM,iBAAiB,OAAM;AAC7B,qBAAe,aACb,OACA,AAAW,kBAAkB,QAAQ,gBACjC,eACE,QAAQ,eACR,MAAM,aAAa,iBAAiB,SACpC,MAAM,aAAa,iBAAiB,YAJ1C,mDAMqD,SANrD,cAMuE,QANvE;AAQF,cAAQ,aAAa,QAAO,QAAQ;AACpC,cAAQ,eAAe;eACd,UAAU,OAAO,MAAM;eAEvB,UAAU,OAAO,WAAW;eAI5B,UAAU,OAAO,WAAW;AAGrC,UAAI,OAAO;AACT,iBAAS,SAAS,SAAS;;AAE7B,UAAI,QAAQ;AACV,iBAAS,SAAS,UAAU;;eAErB,UAAU,OAAO,OAAO;AACjC,cAAQ,UAAU,IAAI;AACtB,UAAI,OAAO;AACT,iBAAS,SAAS,SAAS;;AAE7B,eAAS,SAAS,UAAU;;AAI9B,YAAQ,aAAa,oBAAoB;AACzC,WAAO;;AAST,mCAAiC,KAAK;AACpC,QAAI,uBAAuB,MAAM;AAC/B,4BACG,eAAe,KAAK,8BACnB,IAAI,OACJ,IAAI,IAAI,YACR,IAAI,IAAI,SAAS,wBACnB;;AAEJ,WAAO;;;;ACpkBT,MAAI;AAgCG,wCACL,SACA,WACA,UACA,qBACA;AACA,QAAI,eAAe;AACnB,QAAI,gBAAgB;AAEpB,QAAI,UAAU,kBAAC,OAAU;AACvB,UAAI;AACF,eAAO,cAAc;eACd,GAAP;AAEA,aAAK,sBAAL,OAAA,SAAA,KAAK,mBAAqB;AAC1B,cAAM;;;AAGV,QAAM,iBAAgB;AACtB,QAAM,UAAU,CAAC,CAAC,wBAAD,QAAC,oBAAqB;AAEvC,iBAAa,iBACX,WACA,SACA,iBAAgB,sBAAsB;AAExC,WAAO,WAAM;AAAA,UAAA;AACX,MAAA,iBAAA,iBAAY,OAAZ,SAAA,cAAc,oBACZ,WACA,SACA,iBAAgB,sBAAsB;AAGxC,sBAAgB;AAChB,qBAAe;AACf,gBAAU;;;AAUP,0CAAwC;AAE7C,QAAI,kBAAkB,QAAW;AAC/B,aAAO;;AAGT,oBAAgB;AAChB,QAAI;AAEF,UAAM,UAAU;YACV,UAAU;AACZ,0BAAgB;;;AAGpB,WAAK,iBAAiB,gBAAgB,MAAM;AAC5C,WAAK,oBAAoB,gBAAgB,MAAM;aACxC,KAAP;;AAGF,WAAO;;;;AChGT,MAAM,sBAAsB;AAGrB,MAAM,kCAAkC;AAUxC,6BAA2B,KAAK,MAAM,QAAQ,eAAe;AAClE,QAAM,YAA6C;MAAC;;AACpD,WAAO,OAAO,WAAW;AAGzB,QAAc,OAAO,IAAI,eAAe,YAAY;AAClD,aAAO,IAAI,IAAI,YAAY,MAAM;WAC5B;AAEL,UAAM,IAAI,IAAI,SAAS,YAAY;AACnC,QAAE,gBACA,MACA,CAAC,CAAC,UAAU,SACZ,CAAC,CAAC,UAAU,YACZ;AAEF,aAAO;;;AAYJ,kBAAgB,SAAS,WAAW,UAAU,qBAAqB;AACxE,WAAO,6BACL,SACA,WACA,UACA;;AASG,mBAAiB,OAAO;AAC7B,WAAoD,MAAM;;AAQrD,qBAAmB,OAAO;AAC/B,WAAoD,MAAM;;AAYrD,sBAAoB,SAAS,WAAW,UAAU,qBAAqB;AAC5E,QAAI,gBAAgB;AACpB,QAAM,WAAW,6BACf,SACA,WACA,SAAC,OAAU;AACT,UAAI;AACF,sBAAc;gBADhB;AAIE,wBAAgB;AAChB;;OAGJ;AAEF,WAAO;;AAcF,6BACL,SACA,WACA,qBACA,YACA;AACA,QAAI;AACJ,QAAM,eAAe,IAAI,QAAQ,SAAC,SAAY;AAC5C,iBAAW,WAAW,SAAS,WAAW,SAAS;;AAErD,iBAAa,KAAK,UAAU;AAC5B,QAAI,YAAY;AACd,iBAAW;;AAEb,WAAO;;AAQF,oBAAkB,aAAa;AACpC,WAAO,CAAC,CACN,aAAY,YACZ,YAAY,cAAc,cACzB,mBAAmB,gBAAgB,YAAY,aAAa,KAG5D,YAAY,YAAY,YAAY,SAAS,cAAc;;AAYzD,uBAAqB,aAAa;AACvC,QAAI;AACJ,QAAI;AACJ,QAAI,SAAS,cAAc;AACzB,aAAO,QAAQ,QAAQ;;AAEzB,QAAM,iBAAiB,mBAAmB;AAC1C,QACE,kBACA,YAAY,qCAAqC,YAAY,YAC7D;AACA,aAAO,QAAQ,OAAO;;AAExB,QAAM,iBAAiB,IAAI,QAAQ,SAAC,SAAS,QAAW;AAGtD,UAAI,gBAAgB;AAGlB,uBAAe,WAAW,aAAa,kBAAkB,SAAS;UAChE,SAAS;;aAEN;AACL,uBAAe,WAAW,aAAa,QAAQ;;AAGjD,UAAI,CAAC,YAAY,SAAS;AACxB;;AAEF,UAAI,cAAc;AAIlB,UAAI,kBAAkB,CAAC,YAAY,aAAa,QAAQ;AACtD,sBAAc,iBACZ,aACA,SAAC,OAAD;AAAA,iBAAW,MAAM,YAAY;;AAE/B,YAAI,CAAC,aAAa;AAChB,iBAAO,OAAO,IAAI,MAAM;;;AAG5B,sBAAgB,WAAW,aAAa,SAAS;;AAGnD,WAAO,eAAe,KACpB,WAAM;AACJ,UAAI,eAAe;AACjB;;AAEF,aAAO;OAET,WAAM;AACJ,UAAI,cAAc;AAChB;;AAEF,mBAAa;;;AAUnB,wBAAsB,aAAa;AAIjC,QAAI,mBAAmB,cAAc;AACnC,kBAAY,mCACV,YAAY,cAAc;;AAK9B,QAAI,SAAS;AACb,QAAI,UAAU,OAAO,KAAK;AACxB,eAAS,OAAO;;AAElB,UAAM,OAAO,YAAY,qBAAqB;;AAQhD,8BAA4B,aAAa;AACvC,WAAO,YAAY,YAAY,WAAW,YAAY,YAAY;;AAQ7D,8BAA4B,SAAS;AAC1C,WAAO,QAAQ,QAAQ,wBAAwB;;;;;;;;;;;;;;;;;;;;;;;;;;AClKjD,MAAa,cAAb,2BAAA;AA0HE,0BAAY,SAAS;AAAA,wBAAA,MAAA;AAEnB,WAAK,UAAU;AAGf,WAAK,MAAM,MAAM,QAAQ,cAAc;AAsBvC,WAAK,gBAAgB;AAGrB,WAAK,yBAAyB;;AAxJlC,mBAAA,cAAA,CAAA;MAAA,KAAA;MAAA,OA+JE,mBAAU;AACR,eAAO,KAAK,QAAQ;;OAhKxB;MAAA,KAAA;MAAA,OAuKE,iCAAwB;AACtB,eAAO,KAAK;;OAxKhB;MAAA,KAAA;MAAA,OAsLE,6BAAoB;AAClB,eAAO,eAAe;;OAvL1B;MAAA,KAAA;MAAA,OAqME,8BAAqB,mBAAmB;AACtC,aAAK,QACF,eACA,qBAAqB,KAAK,SAAS;;OAxM1C;MAAA,KAAA;MAAA,OA4ME,qBAAY;AACV,eAAO,KAAK,QAAQ;;OA7MxB;MAAA,KAAA;MAAA,OAuNE,wBAAe;AACb,eAAO,KAAK,QAAQ;;OAxNxB;MAAA,KAAA;MAAA,OAgOE,yBAAgB;AACd,eAAO,KAAK,QAAQ;;OAjOxB;MAAA,KAAA;MAAA,OAyOE,mBAAS;AACP,eAAO,KAAK;;OA1OhB;MAAA,KAAA;MAAA,OAkPE,qBAAY;AACV,eAAO,KAAK,QAAQ;;OAnPxB;MAAA,KAAA;MAAA,OA0PE,oBAAW;AACT,eAAO,SAAS,SAAS,KAAK;;OA3PlC;MAAA,KAAA;MAAA,OAqQE,4BAAmB;AACjB,YAAI,WAAW;AACf,YAAI,KAAK,QAAQ,aAAa,0BAA0B;AACtD,qBACE,KAAK,QAAQ,aAAa,4BAA4B;;AAE1D,eAAO;;OA3QX;MAAA,KAAA;MAAA,OAsRE,2BAAkB,QAAQ;AACxB,eAAO,UAAU,OAAO;;OAvR5B;MAAA,KAAA;MAAA,OAgSE,yBAAgB;AACd,eAAO;;OAjSX;MAAA,KAAA;MAAA,OAiTE,2BAAkB;AAEhB,eAAO;;OAnTX;MAAA,KAAA;MAAA,OAoUE,yBAAgB;;OApUlB;MAAA,KAAA;MAAA,OA+UE,4BAAmB,cAAc;;OA/UnC;MAAA,KAAA;MAAA,OAyVE,4BAAmB;;OAzVrB;MAAA,KAAA;MAAA,OAiWE,4BAAmB;;OAjWrB;MAAA,KAAA;MAAA,OAgXE,wBAAe,cAAc;AAC3B,aAAK,QAAQ,uBAAuB;;OAjXxC;MAAA,KAAA;MAAA,OAuXE,6BAAoB;AAClB,aAAK,QAAQ;;OAxXjB;MAAA,KAAA;MAAA,OAmYE,iCAAwB;AACtB,eAAO;;OApYX;MAAA,KAAA;MAAA,OA6YE,qCAA4B;AAC1B,eAAO;;OA9YX;MAAA,KAAA;MAAA,OA0ZE,iCAAwB;AAEtB,eAAO,QAAQ,KAAK,KAAK,WAAW,YAAY;;OA5ZpD;MAAA,KAAA;MAAA,OAsaE,qCAA4B;AAC1B,eAAO;;OAvaX;MAAA,KAAA;MAAA,OA+aE,wBAAe;;OA/ajB;MAAA,KAAA;MAAA,OA0bE,uBAAc,OAAO,aAAa;AAChC,aAAK,QAAQ,sBAAsB,OAAO;;OA3b9C;MAAA,KAAA;MAAA,OA0cE,uBAAc,iBAAiB;;OA1cjC;MAAA,KAAA;MAAA,OA+cE,2BAAkB;;OA/cpB;MAAA,KAAA;MAAA,OAudE,4BAAmB;AACjB,eAAO;;OAxdX;MAAA,KAAA;MAAA,OAweE,0BAAiB;AACf,eAAO;;OAzeX;MAAA,KAAA;MAAA,OAqfE,gCAAuB;AACrB,aAAK,kBAAkB;;OAtf3B;MAAA,KAAA;MAAA,OA+fE,yBAAgB;;OA/flB;MAAA,KAAA;MAAA,OAugBE,0BAAiB;;OAvgBnB;MAAA,KAAA;MAAA,OAkhBE,4BAAmB;AACjB,eAAO;;OAnhBX;MAAA,KAAA;MAAA,OA4hBE,2BAAkB;AAChB,eAAO;;OA7hBX;MAAA,KAAA;MAAA,OA8iBE,qCAA4B;AAC1B,eAAO;;OA/iBX;MAAA,KAAA;MAAA,OA0jBE,sBAAY,SAAS;AACnB,eAAO,YAAY;;OA3jBvB;MAAA,KAAA;MAAA,OAykBE,wBAAe,OAAO,SAAS,UAAgC;AAAA,YAAhC,aAAgC,QAAA;AAAhC,qBAAW,YAAY;;AACpD,sBAAc;AACd,aAAK,cAAc,SAAS;UAAC;UAAS;;;OA3kB1C;MAAA,KAAA;MAAA,OAqlBE,+BACE,SACA,OACA,UACA;AAAA,YAFA,UAEA,QAAA;AAFA,kBAAQ;;AAER,YADA,aACA,QAAA;AADA,qBAAW,YAAY;;AAEvB,kBACE,CAAC,KAAK,wBACN,2CACA,KAAK;AAEP,aAAK,eAAe,OAAO,SAAS;AACpC,aAAK,yBAAyB;;OAhmBlC;MAAA,KAAA;MAAA,OA8mBE,uBAAc,YAAY,gBAAgB;AACxC,YAAK,SAAU,WAAV;AAEL,YAAI,WAAW,gBAAgB;AAC7B,mBAAS,KAAK,0BAA0B;;AAE1C,sBAAc;AACd,YAAM,SAAS,KAAK,cAAc;AAClC,YAAO,UAAW,KAAK,QAAhB;AACP,mBAAW,QAAD,uBAA8B,SAA9B,SAA2C;AACrD,YAAO,UAAqB,OAArB,SAAS,WAAY,OAAZ;AAChB,YAAI,WAAW,eAAe,WAAW;AACvC,iBAAO,QAAQ;;;OA1nBrB;MAAA,KAAA;MAAA,OAwoBE,6BAAoB,YAAY,SAAS,wBAAwB;AAC/D,qBAAa,QAAQ,cAAc,aAAa,CAAC;AACjD,iBAAS,IAAI,GAAG,IAAI,WAAW,QAAQ,KAAK;AAC1C,cAAM,OAAO,WAAW;AACxB,cAAM,MAAM,KAAK,QAAQ,aAAa;AACtC,cAAI,AAAS,QAAT,MAAc;AAChB,oBAAQ,aAAa,MAAM;qBAClB,wBAAwB;AACjC,oBAAQ,gBAAgB;;;;OAhpBhC;MAAA,KAAA;MAAA,OA6pBE,uBAAc,QAAQ,SAAS;AAAA,YAAA,QAAA;AAC7B,YAAM,cAAe,SAAQ,UAAU,SAAS,CAAC,SAAS,IAAI,SAAC,WAAD;AAAA,iBAC5D,OAAO,SAAS,WAAW,SAAC,OAAU;AACpC,gCAAoB,MAAK,SAAS,WAAW,QAAQ,UAAU;;;AAInE,eAAO,WAAA;AAAA,iBAAM,YAAY,QAAQ,SAAC,UAAD;AAAA,mBAAc;;;;OApqBnD;MAAA,KAAA;MAAA,OA4qBE,0BAAiB;AACf,eAAO,KAAK,QAAQ;;OA7qBxB;MAAA,KAAA;MAAA,OAqrBE,2BAAkB,OAAO;AACvB,aAAK,QAAQ,kBAAkB;;OAtrBnC;MAAA,KAAA;MAAA,OA8rBE,uBAAc;AACZ,eAAO,KAAK,QAAQ;;OA/rBxB;MAAA,KAAA;MAAA,OAwsBE,wBAAe,OAAO;AACpB,aAAK,QAAQ,eAAe;;OAzsBhC;MAAA,KAAA;MAAA,OAktBE,uBAAc,OAAO,OAAe;AAAA,YAAf,UAAe,QAAA;AAAf,kBAAQ;;AAC3B,aAAK,QAAQ,cAAc,OAAO;;OAntBtC;MAAA,KAAA;MAAA,OA2tBE,8BAAqB;AACnB,eAAO,KAAK,QAAQ;;OA5tBxB;MAAA,KAAA;MAAA,OAmuBE,yBAAgB;AACd,aAAK,QAAQ;;OApuBjB;MAAA,KAAA;MAAA,OA8uBE,6BAAoB;AAClB,eAAO,KAAK,QAAQ;;OA/uBxB;MAAA,KAAA;MAAA,OAwvBE,2BAAkB;AAChB,eAAO,KAAK,QAAQ;;OAzvBxB;MAAA,KAAA;MAAA,OAwwBE,0BAAiB,SAAS,qBAAqB;AAC7C,gBAAQ,UAAU,IAAI;AACtB,YAAI,qBAAqB;AACvB,kBAAQ,UAAU,IAAI;;;OA3wB5B;MAAA,KAAA;MAAA,OAmxBE,wBAAc;AACZ,eAAO,SAAS,eAAe,KAAK;;OApxBxC;MAAA,KAAA;MAAA,OA4xBE,2CAAkC;AAChC,eAAO,KAAK;;OA7xBhB;MAAA,KAAA;MAAA,OAqyBE,oBAAW;AACT,iBAAS,cAAc,KAAK,aAAa,gBAAgB,KAAK;;OAtyBlE;MAAA,KAAA;MAAA,OA6yBE,2BAAkB;AAChB,eAAO,SAAS,cAAc,KAAK,aAAa,gBAC9C,KAAK;;OA/yBX;MAAA,KAAA;MAAA,OA0zBE,2BAAkB,WAAW;AAC3B,iBAAS,cAAc,KAAK,aAAa,gBACvC,KAAK,SACL,WACe;;OA9zBrB;MAAA,KAAA;MAAA,OAg1BE,6BAAoB,WAAW;AAC7B,eAAO,SAAS,cAAc,KAAK,aAAa,kBAC9C,KAAK,SACL,WACe;;OAp1BrB;MAAA,KAAA;MAAA,OAw2BE,2BAAkB,WAAW,UAAU,WAAW;AAChD,eAAO,SAAS,cAAc,KAAK,aAAa,kBAC9C,KAAK,SACL,WACA,UACgB,QAChB;;OA92BN;MAAA,KAAA;MAAA,OAy3BE,wBAAe,UAAU;AACvB,eAAO,SAAS,cAAc,KAAK,aAAa,eAAe;;OA13BnE;MAAA,KAAA;MAAA,OA24BE,uBAAc,SAAS,aAAa;AAClC,eAAO,KAAK,qBAAqB,MAAM,SAAS;;OA54BpD;MAAA,KAAA;MAAA,OA+5BE,8BAAqB,UAAU,SAAS,aAAa;AACnD,eAAO,SAAS,cAAc,KAAK,aAAa,qBAC9C,eAAe,KAAK,SACpB,UACA;;OAn6BN;MAAA,KAAA;MAAA,OA86BE,oCAA2B,SAAS;AAClC,eAAO,SAAS,cAAc,KAAK,aAAa,cAC9C,KAAK,SACL,SACoB;;OAl7B1B;MAAA,KAAA;MAAA,OA27BE,2BAAkB,eAAe;;OA37BnC;MAAA,KAAA;MAAA,OAo8BE,kBAAS;AACP,iBAAS,cAAc,KAAK,aAAa,cAAc,KAAK;;OAr8BhE;MAAA,KAAA;MAAA,OAk9BE,mCAA0B,iBAAiB;;OAl9B7C;MAAA,KAAA;MAAA,OA89BE,2BAAkB;;OA99BpB;MAAA,KAAA;MAAA,OAm+BE,iBAAO;AACL,eAAO,KAAK,KAAK;;OAp+BrB;MAAA,KAAA;MAAA,OA8+BE,kBAAS;AACP,eAAO;;QA/+BX,CAAA;MAAA,KAAA;MAAA,OAeE,cAAY;AACV,eAAO;;OAhBX;MAAA,KAAA;MAAA,OA8BE,uBAAqB,eAAe;AAClC,eAAO;;OA/BX;MAAA,KAAA;MAAA,OA8CE,0BAAwB,eAAe;AACrC,eAAO;;OA/CX;MAAA,KAAA;MAAA,OA4DE,qBAAmB,eAAe;AAChC,eAAO;;OA7DX;MAAA,KAAA;MAAA,OA2EE,kCAAgC,eAAe;AAC7C,eAAO;;OA5EX;MAAA,KAAA;MAAA,OA0FE,0BAAwB,eAAe;AACrC,eAAO,eAAe;;OA3F1B;MAAA,KAAA;MAAA,OAyGE,wBAAsB,eAAe;AACnC,eAAO;;OA1GX;MAAA,KAAA;MAAA,OAqHE,6BAA2B;AACzB,eAAO;;;AAtHX,WAAA;;AAy/BA,yBAAuB,aAAa;AAClC,QAAI,CAAC,YAAY,eAAe;AAC9B,kBAAY,gBAAgB,YAAY,IAAI,OAAO,OAAO;;;;;ACjlCvD,MAAM,gBAAgB;IAI3B,kBAAkB;IAKlB,UAAU;IAKV,OAAO;IAKP,SAAS;IAMT,YAAY;IAaZ,cAAc;IAOd,UAAU;IAaV,UAAU;IAKV,QAAQ;;;;AC/DH,MAAM,kBAAkB;IAI7B,WAAW;IAKX,SAAS;IAKT,QAAQ;IAMR,QAAQ;IAMR,UAAU;;;;AC9CZ,AA2HO,MAAM,YAAY;IACvB,eAAe;IAGf,YAAY,oBAAS,UAAU,gBAAe,iBAAiB;AAC7D,UAAI,WAAU;AACd,UAAI,UAAU;AACZ,cAAM,UAAU,QAAQ,KAAK,UAAU,SAAS,MAAM;AACpD,cAAI,KAAK,gBAAiB,KAAK,SAAS,KAAK,MAAM,YAAY,QAAY;AACzE,wBAAW,KAAK,cAAc,KAAK,cAAc,gBAC/C,KAAK,eAAe,mBAAmB;AACzC,wBAAW,KAAK,mBAAmB,QAAQ;qBAClC,KAAK,SAAS,QAAQ,YAAY;AAC3C,wBAAW,YAAY,KAAK,MAAM,YAAY;AAC9C,wBAAW,KAAK,WAAW,KAAK,UAAU;AAC1C,wBAAW;iBACN;AAML,gBAAI;AACF,kBAAI,KAAK,SAAS;AAChB,4BAAW,KAAK,UAAU;;qBAEtB,GAAN;AACA,kBAAI,KAAK,SAAS,QAAQ,kBAAkB,KAAK,UAAU;AACzD,4BAAW,KAAK,8BAA8B;;;;WAInD;;AAEL,aAAO;;IAGT,+BAA+B,uCAAS,MAAM;AAC5C,UAAI,WAAU,gBAAgB,KAAK,OAAO;AAC1C,YAAM,UAAU,QAAQ,KAAK,KAAK,UAAU,SAAS,OAAM;AACzD,oBAAW,MAAM,MAAK,UAAU,OAAO,MAAK,MAAM,UAAU;;AAE9D,kBAAW;AACX,aAAO;;IAGT,eAAe,uBAAS,UAAU,gBAAe,QAAQ,iBAAiB;AACxE,UAAI,IAAI,IAAI,QAAQ,SAAS,MAAM;AACnC,YAAM,QAAQ,SAAS,GAAG;AACxB,YAAI,EAAE;AACN,YAAI,iBAAiB;AACnB,cAAI,gBAAgB;;AAEtB,YAAI,KAAK,qBAAqB,GAAG,iBAAgB;AAC/C,cAAK,UAAU,CAAC,EAAE,MAAM,4BACpB,KAAK,yBAAyB,GAAG,kBACjC,KAAK,mBAAmB,GAAG;;AAEjC,UAAE,KAAK;SACN;AACH,aAAO,EAAE,KAAK;;IAGhB,sBAAsB,8BAAS,UAAU,gBAAe;AACtD,UAAI,MAAM,QAAQ,iBAAgB;AAChC,eAAO;;AAET,UAAI,KAAK,KAAK,iBAAiB;AAC/B,aAAO,CAAC,SAAS,MAAM;;IAGzB,kBAAkB,0BAAS,gBAAe;AACxC,uBAAgB,eAAc,QAAQ,OAAO,OAAO,QAAQ,OAAO;AACnE,aAAO,IAAI,OAAO,OAAO,iBAAgB,MAAM,kBAAkB;;IAGnE,oBAAoB,4BAAS,UAAU,eAAe;AACpD,aAAO,MAAM,QAAQ,iBACjB,KAAK,uBAAuB,UAAU,iBACtC,KAAK,yBAAyB,UAAU;;IAI9C,wBAAwB,gCAAS,UAAU,mBAAmB;AAC5D,UAAI,IAAI;AACR,eAAS,IAAE,GAAG,GAAI,IAAE,kBAAkB,IAAK,KAAK;AAC9C,UAAE,KAAK,KAAK,yBAAyB,UAAU;;AAEjD,aAAO,EAAE,KAAK;;IAIhB,0BAA0B,kCAAS,UAAU,gBAAe;AAC1D,UAAI,SAAS,MAAM,iBAAiB;AAClC,mBAAW,SAAS,QAAQ,0BAA0B;AACtD,eAAO,SAAS,QAAQ,gBAAgB,iBAAgB;aACnD;AACL,eAAO,iBAAgB,MAAM;;;IAMjC,0BAA0B,kCAAS,UAAU,gBAAe;AAC1D,uBAAgB,eAAc,QAAQ,oBAAoB;AAC1D,UAAI,SAAS,CAAC,KAAK,KAAK,KAAK,MAC3B,SAAS,UACT,WAAW,MAAM,iBAAgB;AACnC,aAAO,QAAQ,SAAS,KAAK;AAC3B,YAAI,QAAQ,OAAO,MAAM;AACzB,iBAAS,MAAM,IAAI,SAAS,GAAG;AAE7B,cAAI,IAAI,EAAE,OAAO,QAAQ,gBAAgB;AACzC,cAAI,KAAM,OAAO,QAAQ,KAAK,KAAO,EAAE,QAAQ,YAAY,GAAI;AAC7D,gBAAI,EAAE,QAAQ,mBAAmB,OAAO,WAAW;;AAErD,iBAAO;WACN,KAAK;;AAEV,aAAO;;IAGT,oBAAoB,4BAAS,MAAM;AACjC,UAAI,WAAU,KAAK,MAAM;AAIzB,UAAI,KAAK,MAAM,WAAW,CAAC,KAAK,MAAM,QAAQ,MAAM,eAAe;AACjE,mBAAU,SAAQ,QAAQ,mBAAmB,eACzC,KAAK,MAAM,UAAU;;AAQ3B,UAAI,QAAQ,KAAK;AACjB,eAAS,KAAK,OAAO;AACnB,YAAI,MAAM,OAAO,WAAW;AAC1B,sBAAW,IAAI;;;AAGnB,aAAO;;;AAIX,MAcI,eAAe;AAdnB,MAgBI,sBAAsB;AAhB1B,MAiBI,cAAc;AAGd,MAAI,iBAAiB,IAAI,OAAO,MAAM,eAAe,aAAa;AAAlE,MACA,wBAAwB,IAAI,OAAO,MAAM,sBAAsB,aAAa;AAD5E,MAEA,mBAAmB;AAFnB,MAMA,2BAA2B,eAAe;AAN1C,MAOA,iBAAiB,IAAI,OAAO,cAAc;AAP1C,MAQA,wBAAwB,IAAI,OAAO,qBAAqB;;;ACtRrD,MAAM,mBAAmB;IAC9B,MAAM;IACN,IAAI;IACJ,IAAI;;AAON,MAAI;AAMJ,MAAI;AAsBG,kCAAgC;AACrC,WAAO,kCAAkC,iBAAiB;;AAOrD,kCAAgC;AACrC,QAAI,uBAAuB,QAAW;AACpC,2BACE,0BACC,UAAS,QAAQ,UAAU,iBAC1B,SAAS,QAAQ,UAAU;;AAEjC,WAAO;;AAUT,oBAAkB,MAAM;AACtB,WAAO,CAAC,CAAC,QAAQ,KAAK,WAAW,QAAQ,oBAAoB;;AAQxD,wCAAsC,kBAAkB;AAC7D,QAAI,8BAA8B,QAAW;AAC3C,kCAA4B,oBAC1B,oBAAoB;;AAGxB,WAAO;;AAST,+BAA6B,SAAS;AACpC,QAAI,CAAC,CAAC,QAAQ,UAAU,cAAc;AACpC,aAAO,iBAAiB;eACf,CAAC,CAAC,QAAQ,UAAU,kBAAkB;AAC/C,aAAO,iBAAiB;;AAE1B,WAAO,iBAAiB;;;;AC3E1B,MAAM,WAAW;IACf,2BAA2B;IAC3B,WAAW;IACX,oBAAoB;;AA0BtB,MAAM,eAAe;AASd,2BAAyB,KAAK;AACnC,QAAM,WAAW,iBAAiB,KAAK,IAAI,SAAC,WAAc;AACxD,UAAM,sBAAsB,kBAAkB,KAAK,WAAW,KAC5D,SAAC,SAAY;AACX,YAAI,WAAW,wBAAwB,UAAU;AAC/C,iBAAO,QAAQ,YAAY,KAAK,WAAM;AACpC,mBAAO;;;AAGX,eAAO;;AAIX,aAAO,SAAS,SAAS,KAAK,eAC5B,cACA,qBAFK,wCAGiC,YAHjC;;AAMT,WAAO,QAAQ,IAAI;;AAQd,qCAAmC,KAAK;AAC7C,WAAO,iBAAiB,KAAK,SAAS;;AASjC,mCAAiC,SAAS;AAC/C,QAAM,6BACJ;AAEF,WAAO,OAAO,2BAA2B,aAAa;;AAQjD,4BAA0B,KAAK;AAEpC,QAAM,MAAM,IAAI;AAChB,cAAU,IAAI;AAEd,WAAO,OAAO,KAAK,UAAU,OAAO,SAAC,SAAY;AAC/C,aAAO,IAAI,cAAc,SAAS;;;;;ACxGtC,MAAM,mBAAmB;AACzB,MAAM,iBAAiB;AAoBhB,+BACL,QACA,UACA,IACA,kBACA,SACA;AACA,QAAM,UAAU,OAAO;AACvB,QAAM,QAAQ,mBACZ,SACA,eAAe,SAAS,WACxB,oBAAoB,OACpB,WAAW;AAGb,QAAI,IAAI;AACN,UAAM,WAAW,OAAO;AAMxB,UAAI,YAAY,UAAU,QAAQ;AAChC,WAAG;AACH,eAAO;;AAGT,UAAM,WAAW,YAAY,WAAM;AACjC,YAAI,YAAY,UAAU,QAAQ;AAChC,wBAAc;AACd,aAAG;;SAEJ;;AAEL,WAAO;;AAWT,8BAA4B,SAAS,UAAS,cAAc,KAAK;AAC/D,QAAI,WAAW,QAAQ;AACvB,QAAI,CAAC,UAAU;AACb,iBAAW,QAAQ,kBAAkB;;AAGvC,QAAM,WACJ,CAAC,gBAAgB,OAAO,OAAO,gBAAgB,OAAO;AACxD,QAAM,MAAM,eACR,gBACA,WAAQ,mBACS,MACjB;AAGJ,QAAI,KAAK;AACP,UAAM,WAAW,wBAAwB,SAAS,UAAU;AAC5D,UAAI,UAAU;AACZ,YAAI,SAAS,gBAAgB,UAAS;AACpC,mBAAS,cAAc;;AAEzB,eAAO;;;AAKX,QAAM,MAAM,QAAQ,iBAAiB;AACrC,QAAM,QAAQ,IAAI,cAAc;AAChC,UAAa,cAAc;AAC3B,QAAI,eAAe;AAGnB,QAAI,cAAc;AAChB,YAAM,aAAa,eAAe;eACzB,UAAU;AACnB,YAAM,aAAa,iBAAiB,OAAO;AAC3C,qBAAe,MAAM,cACnB,wBAAwB,SAAS,UAAU;WAExC;AACL,UAAI,KAAK;AACP,cAAM,aAAa,KAAK;;AAE1B,qBAAe,QAAQ;;AAEzB,yBAAqB,SAAS,OAAO;AACrC,QAAI,KAAK;AACP,eAAS,OAAO;;AAElB,WAAO;;AAST,mCAAiC,SAAS,UAAU,KAAK;AAEvD,QAAI,SAAS,MAAM;AACjB,aAAO,SAAS;;AAGlB,QAAM,WAAW,QAAe,cAAf,WAAsC,MAAtC;AACjB,QAAI,UAAU;AACZ,eAAS,OAAO;AAChB,aAAO;;AAGT,WAAO;;AAQF,iCAA+B,SAAS,aAAa;AAC1D,YAAQ,oBAAoB;;AAS9B,0BAAwB,SAAS,UAAS;AACxC,QAAM,cAAc,QAAQ;AAC5B,WAAO,cAAc,YAAY,YAAW;;AAI9C,MAAI,kBAAkB;AAgBf,2BAAyB,KAAK;AACnC,cAAU,IAAI,aAAa;AAC3B,QAAM,MAA8B,IAAI;AACxC,2BAAuB,KACpB,KAAK,WAAM;AACV,aAAO,gBAAgB;OAExB,MAAM,SAAC,QAAW;AACjB,mBAAa;AACb,aAAO;OAER,KAAK,SAAC,UAAa;AAClB,wBAAkB;AAClB,UAAA,MAAmB;AAIjB,YAAI,KAAY;;AAElB,2BAAqB;AACrB,UAAM,SAAS,UAAU;AACzB,aAAO,UAAU,OAAO,cAAc;AACtC,UAAI,SAAS,SAAS,GAAG;AACvB,YAAM,YAAY,SAAS,gBAAgB,IAAI;AAC/C,kBAAiB,aAAa,GAAqB;;AAErD,UAAI;AACF,YAAM,OAAO,SAAS,eAAe;AACrC,aAAK,KAAK,UAAU;AACpB,aAAK;eACE,GAAP;;;;AAQD,mCAAiC,KAAK;AAC3C,cAAU,IAAI,aAAa;AAC3B,QAAI,iBAAiB;AACnB;;AAEF,sBAAkB;AAClB,yBAAqB;;AAOvB,gCAA8B,KAAK;AACjC,cAAU,MAAM,cAAc,IAAI,OAAO;MACvC,SAAS;MACT,YAAY;MACZ,aAAa;;;AAoBjB,uBAAqB,KAAK,OAAO;AAC/B,QAAM,SAAS,IAAI;AACnB,aAAS,IAAI,GAAG,IAAI,OAAO,QAAQ,KAAK;AACtC,UAAM,QAAQ,OAAO;AACrB,UAAI,MAAM,aAAa,OAAO;AAC5B,eAAO;;;AAGX,WAAO;;;;AC7PT,MAAM,yBAAyB;AAG/B,MAAM,yBAAyB;AAexB,4BAA0B,aAAa;AAC5C,QAAM,MAAM,MAAM,YAAY,cAAc;AAE5C,QAAM,eAAe,YAAY,cAAc,YAAY;AAC3D,QAAI,cAAc;AAChB,mBAAoB,YAAY;AAChC,aAAO;;AAGT,QAAI;AACJ,QAAM,qBAAqB;AAC3B,QAAI,sBAAsB,iBAAiB,IAAI;AAC7C,mBAAa,YAAY,aAAa;QAAC,MAAM;;AAC7C,UAAI,CAAC,WAAW,aAAa;AAC3B,eAAO,eAAe,YAAY,eAAe;UAC/C,KAAK,eAAY;AACf,gBAAM,QAAQ;AACd,0BAAc,WAAW,YAAY,SAAC,OAAU;AAC9C,kBAAI,MAAM,YAAY,SAAS;AAC7B,sBAAM,KAAK,MAAM;;;AAGrB,mBAAO;;;;eAIJ,sBAAsB,iBAAiB,IAAI;AACpD,mBAAa,YAAY;WACpB;AACL,mBAAa,yBAAyB;;AAGxC,QAAI,CAAC,wBAAwB;AAC3B,UAAM,SAAM,kBAAmB,IAAI,KAAK,MAAM,IAAI,KAAK,WAAW;AAClE,iBAAW,QAAQ;AACnB,iBAAW,KAAK,UAAU,IAAI;AAG9B,4BAAsB,YAAY,SAAC,KAAQ;AACzC,eAAO,mBAAmB,YAAY;;;AAI1C,WAAO;;AAQT,oCAAkC,aAAa;AAC7C,QAAM,MAAM,YAAY;AAGxB,gBAAY,UAAU,IAAI;AAC1B,QAAM,YAAY,IAAI,cAAc;AACpC,cAAU,cACR;AAEF,gBAAY,YAAY;AAGxB,QAAM,aAGe,IAAI,cAAc;AACvC,gBAAY,YAAY;AACxB,gBAAY,oBAAoB;AAChC,WAAO,eAAe,aAAa,cAAc;MAC/C,YAAY;MACZ,cAAc;MACd,OAAO;;AAKT,eAAW,OAAO;AAGlB,eAAW,iBAAiB,SAAU,IAAI;AACxC,UAAM,YAAY,uBAAuB;AACzC,aACE,WAAkB,cAAlB,MAAoC;;AAKxC,WAAO,eAAe,YAAY,eAAe;MAC/C,KAAK,eAAM;AACT,YAAI,CAAC,IAAI,aAAa;AACpB,iBAAO;;AAET,eAAO,QAAQ,IAAI,aAAa,OAAO,SAAC,YAAD;AAAA,iBACrC,WAAW,SAAS,WAAW;;;;AAKrC,WAAO;;AAkDF,8BAA4B,YAAY,KAAK;AAClD,WAAO,eAAe,YAAY;;AAc7B,0BAAwB,YAAY,KAAK;AAC9C,QAAM,KAAK,UAAU,WAAW;AAChC,QAAM,MAAM,WAAW;AACvB,QAAI,QAAQ;AAEZ,QAAI;AACF,cAAQ,mBAAmB,IAAI,eAAe,mBAAmB,KAAK;aAC/D,GAAP;;AAIF,QAAI,CAAC,OAAO;AACV,UAAI;AACF,gBAAQ,mBAAmB,KAAK;eACzB,GAAP;;;AAMJ,QAAI,CAAC,OAAO;AACV,aAAO;;AAMT,QAAO,cAAc,UAAd;AACP,WAAO,YAAW,KAAK,WAAW,OAA3B,MAAsC,IAAM;;AASrD,kCAAgC,UAAU;AACxC,WAAO,SAAS,QAAQ,gBAAgB;;AAY1C,gCAA8B,OAAO,MAAM,KAAK,UAAU;AACxD,QAAM,OAAO,SAAS,OAAO,MAAM;AACnC,QAAM,OAAO,SAAS,OAAO,MAAM,MAAM;AACzC,QACG,EAAC,QAAQ,uBAAuB,KAAK,UACrC,EAAC,QAAQ,uBAAuB,KAAK,QACtC;AACA,aAAO,SAAS;;AAElB,WAAO;;AAQT,8BAA4B,KAAK,KAAK;AACpC,QAAM,QAA0C,IAAI,cAAc;AAClE,UAAa,cAAc;AAC3B,QAAI;AACF,MAAC,KAAI,QAAQ,IAAI,iBAAiB,YAAY;AAC9C,UAAI,MAAM,OAAO;AACf,eAAsC,MAAM,MAAO;;AAErD,aAAO;cALT;AAOE,UAAI,MAAM,YAAY;AACpB,cAAM,WAAW,YAAY;;;;;;ACrS5B,MAAM,UAAU;;;ACgChB,MAAM,OAAO;IAClB,OAAO;IACP,QAAQ;IACR,OAAO;IACP,YAAY;IACZ,UAAU;IACV,aAAa;IACb,YAAY;IACZ,KAAK;IACL,WAAW;IACX,MAAM;IACN,KAAK;;;;ACrBP,2BAAyB,SAAS,KAAK;AACrC,QAAM,QAAO,IAAI;AACjB,QAAM,eAAe,QAAQ,KAAK,SAAC,QAAD;AAAA,aAAY,MAAK,aAAa;;AAChE,WAAO;;AAOF,uBAAqB,KAAK;AAC/B,WAAO,gBAAgB,CAAC,gBAAW,cAAc;;;;ACb5C,MAAM,YAAY;IACvB,YAAY;IACZ,uBAAuB;IACvB,mBAAmB;IACnB,mBAAmB;IAGnB,UAAU;IACV,SAAS;IACT,YAAY;IACZ,UAAU;IACV,OAAO;IACP,cAAc;IACd,QAAQ;;;;ACVH,8BAA4B,UAAU;AAC3C,QAAM,aAAa,wBAAwB;AAC3C,WAAO,SAAC,MAAS;AACf,aAAO,WAAW,MAAM;;;AASrB,mCAAiC,UAAU;AAChD,QAAM,OAAO,YAAY;AACzB,QAAI,QAAQ;AACZ,WAAO,WAAM;AACX,UAAI,OAAO,KAAK,IAAI,MAAM;AAC1B,cAAQ,UAAU;AAClB,aAAO,OAAO;;;AAaX,qBAAmB,MAAM,UAAU;AACxC,eAAW,YAAY;AACvB,QAAI,SAAS,OAAO,WAAW,KAAK;AACpC,QAAI,KAAK,WAAW,KAAK;AACvB,gBAAU;;AAEZ,WAAO;;;;AChCF,iCACL,QACA,WACA,MACA,gBACA;AAAA,QAFA,SAEA,QAAA;AAFA,aAAO;;AAEP,QADA,mBACA,QAAA;AADA,uBAAiB;;AAEjB,aAAS,sBAAsB,QAAQ,KAAK,SAAC,WAAc;AACzD,UAAI,CAAC,WAAW;AACd;;AAEF,gBAAU,sBAAsB,QAAQ,WAAW,MAAM;;;;;ACC7D,MAAM,YAAY;AAKlB,MAAM,mBAAmB;AAKzB,MAAM,UAAU;AAOhB,MAAM,0CAA0C;AAOhD,MAAM,gCAAgC;AAMtC,MAAM,6BAA6B;AAMnC,MAAI,2BAA2B,KAAK,gBAAgB;AAEpD,OAAK,eAAe;AAUpB,qBAAmB,OAAO,SAAS,OAAO;AACxC,QAAI,MAAM,UAAU,OAAO;AACzB,YAAM,OAAO,GAAG,MAAM,SAAS,QAAQ;;AAEzC,UAAM,KAAK;;AASb,MAAI,oBAAmB,0BAAU,MAAM;AAErC,wBAAmB,mBAAmB;AACtC,WAAO,kBAAiB;;AAQ1B,4BAA0B,OAAO;AAC/B,QAAI;AAEF,aAAO,KAAK,UAAsC;aAC3C,GAAP;AACA,aAAO,OAAO;;;AASX,6BAA2B,KAAK,OAAO,uBAAuB;AACnE,gBAAY,OAAO;AACnB,QACE,SACA,CAAC,CAAC,OACF,mBAAmB,MAAM,YACzB,CAAC,iBAAiB,MAAM,UACxB;AACA,6BAA8C,OAAQ;;;AAenD,uBAAqB,OAAO,uBAAuB;AACxD,QAAI;AAEF,UAAI;AACJ,UAAI,OAAO;AACT,YAAI,MAAM,YAAY,QAAW;AAC/B,kBAAQ,0BAAiD;AACzD,yBAAe;eACV;AACL,cAAM,YAAY;AAClB,kBAAQ,IAAI,MAAM,iBAAiB;AACnC,gBAAM,YAAY;;aAEf;AACL,gBAAQ,IAAI,MAAM;;AAGpB,UAAI,CAAC,gBAAgB,UAAU,YAAY,CAAC,UAAU,MAAM;AAC1D,mBAAW,WAAY;AACrB,cAAM,UAAU,IAAI,MAClB,4CAA4C;AAE9C,gBAAM;;;AAIV,UAAI,MAAM,UAAU;AAClB,eAA8B;;AAEhC,YAAM,WAAW;AAKjB,UAAI,MAAM,cAAc;AACtB,YAAM,UAAU,UAAU,MAAM,cAAc,SAAC,MAAD;AAAA,iBAAU,QAAV,OAAA,SAAU,KAAM;;AAC9D,YAAI,UAAU,IAAI;AAChB,gBAAM,oBAAoB,MAAM,aAAa;;;AAIjD,UAAM,UAAU,yBAAyB,MAAM;AAC/C,UAAI,WAAW,QAAQ,WAAW;AAChC,gBAAQ,UAAU,IAAI;AACtB,YAAI,UAAU,aAAa;AACzB,kBAAQ,UAAU,IAAI;AACtB,kBAAQ,aAAa,iBAAiB,MAAM;;;AAKhD,UACE,KAAK,WACJ,oBAAmB,MAAM,YACxB,CAAC,MAAM,YACP,UAAU,WACZ;AACA,YAAM,SAAS,QAAQ,SAAS,QAAQ;AACxC,YAAI,MAAM,cAAc;AACtB,iBAAO,MAAM,SAAS,MAAM;eACvB;AACL,cAAI,SAAS;AACX,mBAAO,KAAK,SAAS,MAAM,SAAS;qBAC3B,CAAC,UAAU,UAAU;AAC9B,mBAAO,KAAK,SAAS,MAAM;iBACtB;AACL,mBAAO,KAAK,SAAS,MAAM;;;;AAIjC,UAAI,WAAW,QAAQ,+BAA+B;AACpD,gBAAQ,8BAA8B,UAAU,OAAO,MAAM;;AAK/D,cAAQ,QAAQ,MAAM,QAAW,QAAW,QAAW,QAAW;aAC3D,qBAAP;AACA,iBAAW,WAAY;AACrB,cAAM;;;AAGV,WAA8B;;AAOzB,0BAAwB;AAC7B,WAAO,IAAI,MAAM;;AAOZ,0BAAwB,gBAAgB;AAC7C,QAAI,CAAC,gBAAgB;AACnB,aAAO;;AAET,QAAI,OAAO,kBAAkB,UAAU;AACrC,aAAO,eAAe,WAAW;;AAEnC,QAAI,OAAO,eAAe,WAAW,UAAU;AAC7C,aAAO,eAAe,QAAQ,WAAW;;AAE3C,WAAO;;AAOF,mCAAiC;AACtC,WAAO,IAAI,MAAM;;AAOZ,8BAA4B,gBAAgB;AACjD,QAAI,CAAC,gBAAgB;AACnB,aAAO;;AAET,QAAI,OAAO,kBAAkB,UAAU;AACrC,aAAO,eAAe,WAAW;;AAEnC,QAAI,OAAO,eAAe,WAAW,UAAU;AAC7C,aAAO,eAAe,QAAQ,WAAW;;AAE3C,WAAO;;AAOF,iCAA+B,KAAK;AACzC,QAAI,UAAoC;AACxC,QAAI,iBAAiB,sBAAsB,SAAC,OAAU;AACpD,UACE,MAAM,UACL,OAAM,OAAO,YAAY,aACxB,MAAM,OAAO,YAAY,oBACzB,MAAM,OAAO,YAAY,UAC3B;AACA,cAAM;AACN;;AAEF,kBAAY,MAAM,UAAU,IAAI,MAAM,sBAAsB;;;AAahE,mBAAiB,SAAS,UAAU,MAAM,KAAK,OAAO;AAAA,QAAA,QAAA;AAGpD,QAAI,QAAQ,KAAK,YAAa,EAAC,SAAS,CAAC,MAAM,WAAW;AAExD,8BAAwB,KAAK;;AAE/B,QAAI,UAAU,YAAY,UAAU,eAAe,UAAU,MAAM;AACjE;;AAEF,QAAI,cAAc;AAClB,QAAI;AACF,oBAAc,eAAe;aACtB,QAAP;;AAGF,QAAI,eAAe,KAAK,WAAW,MAAM;AAIvC;;AAEF,QAAM,OAAO,mBACX,SACA,UACA,MACA,KACA,OACA;AAEF,QAAI,MAAM;AACR,wBAAiB,WAAM;AACrB,YAAI;AACF,iBAAO,4BAEL,OAEC,MACD,MAAM,WAAM;;iBAGP,GAAP;;;;;AAYR,iCAA+B;AAC7B,WAAO,KAAK,WAAW,6BACnB,KAAK,qBACL,KAAK;;AASJ,uCAAqC,KAAK,MAAM;AAMrD,QAAI,KAAK,SAAS,KAAK,WAAW,KAAK;AACrC,aAAO;;AAGT,WAAO,yBAAyB,KAAK,MAAM,KAAK,SAAC,uBAA0B;AACzE,UAAI,CAAC,uBAAuB;AAC1B,YAAM,MAAM,IAAI;AAChB,YAAI,KAAK,QAAQ,uBAAuB;AACxC,YAAI,KAAK,KAAK,UAAU;;;;AAmBvB,oCAAkC,KAAK,MAAM;AAClD,QAAM,iBAAgB,SAAS,iBAAiB;AAChD,QAAI,CAAC,eAAc,eAAe;AAChC,aAAO,QAAQ,QAAQ;;AAEzB,QAAM,eAAe,eAAc;AACnC,QAAM,cAAc,aAAa,cAAc;AAC/C,QAAM,aAAa,YAAY,aAAa;AAC5C,QAAI,CAAC,YAAY;AACf,aAAO,QAAQ,QAAQ;;AAEzB,QAAM,SAAS,SAAS,aAAa;AACrC,QAAI,CAAC,OAAO,cAAc,kBAAkB;AAC1C,aAAO,QAAQ,QAAQ;;AAEzB,WAAO,OAAO,kBAAkB,KAAK,SAAC,eAAkB;AACtD,UAAI,CAAC,eAAe;AAClB,eAAO;;AAET,aAAO,YAAY,SAAS,4BAA4B;AACxD,aAAO;;;AAWJ,uCAAqC,iBAAiB;AAC3D,WAAO,KAAK;MACV,KAAK,gBAAgB;MACrB,KAAK,gBAAgB;MACrB,KAAK,gBAAgB;MACrB,MAAM,gBAAgB;MACtB,MAAM,gBAAgB;MACtB,KAAK,gBAAgB;MACrB,MAAM,gBAAgB;;;AAS1B,8BAA4B,SAAS,OAAO;AAC1C,QAAI,OAAO;AACT,UAAI,MAAM,SAAS;AACjB,kBAAU,MAAM;aACX;AAEL,kBAAU,OAAO;;;AAGrB,QAAI,CAAC,SAAS;AACZ,gBAAU;;AAGZ,WAAO;;AAcF,8BACL,SACA,UACA,MACA,KACA,OACA,aACA;AACA,cAAU,mBAAmB,SAAS;AAOtC,QAAI,WAAW,CAAC,CAAE,UAAS,MAAM;AACjC,QAAI,aAAa,KAAK,UAAU;AAC9B;;AAEF,QAAI,WAAW,WAAW;AACxB;;AAGF,QAAM,iBAAiB,CAAE,SAAQ,KAAK;AACtC,QAAM,eAAe,KAAK;AAI1B,QACE,mBAAmB,YAGnB,WAAW,mBAGX,gBACA;AACA,iBAAW;AAEX,UAAI,eAAe,yCAAyC;AAC1D;;;AAIJ,QAAM,cAAc,mBAAmB;AAGvC,QAAI,eAAe,eAAe,+BAA+B;AAC/D;;AAOF,QAAM,OAAmC,OAAO,OAAO;AACvD,SAAK,OAAO,UAAU;AACtB,SAAK,WAAW,cAAc,MAAM;AACpC,SAAK,OAAO,QAAQ,QAAQ,qBAAqB;AACjD,SAAK,OAAO,cAAc,MAAM;AAIhC,SAAK,QAAQ,WAAW,MAAM;AAC9B,SAAK,QAAQ,iBAAiB,MAAM;AAEpC,QAAI,UAAU;AACd,QAAA,OAAY;AACV,gBAAU;AACV,WAAK,SAAS;eACT,OAAY;AACjB,gBAAU;AACV,WAAK,SAAS;eACL,KAAK,WAAW,KAAK,QAAQ,UAAU;AAChD,WAAK,QAAQ;AACb,gBAAU;eACD,UAAU,SAAS;AAC5B,gBAAU,UAAU;;AAGtB,SAAK,QAAQ;AAGb,QAAI,YAAY,UAAU;AACxB,WAAK,UAAU,UAAU;;AAK3B,SAAK,QAAQ,SAAS,QAAQ,MAAM;AAGpC,SAAK,QAAQ,cAAc;AAE3B,QAAI,KAAK,SAAS,mBAAmB,KAAK,SAAS,gBAAgB,IAAI;AACrE,WAAK,QAAQ,KAAK,SAAS,gBAAgB;;AAE7C,QAAI,KAAK,aAAa;AACpB,WAAK,QAAQ,KAAK;;AAGpB,QAAI,KAAK,UAAU,KAAK,UAAU,MAAM;AACtC,WAAK,SAAS;;AAGhB,QAAI,KAAK,OAAO,KAAK,IAAI,QAAQ;AAC/B,UAAM,oBAAoB,KAAK,IAAI,OAAO;AAC1C,UAAM,kBAAkB,KAAK,IAAI,OAAO;AACxC,UAAI,mBAAmB;AACrB,aAAK,SAAS;;AAEhB,UAAI,iBAAiB;AACnB,aAAK,SAAS;;;AAIlB,QAAM,OAAO;AACb,QAAM,cAAc,wBAAwB;AAC5C,aAAW,OAAO,aAAa;AAC7B,UAAM,KAAK,YAAY;AACvB,WAAK,KAAQ,MAAb,MAAoB,MAAK,MAAM;;AAEjC,SAAK,UAAU,KAAK,KAAK;AAEzB,QAAI,OAAO;AAAA,UAAA;AACT,WAAK,QAAQ,0BAAA,MAAM,sBAAN,OAAA,SAAA,sBAAyB,YAAW;AAEjD,UAAI,MAAM,MAAM;AACd,aAAK,UAAU,KAAK,UAAU,MAAM;;AAGtC,UAAI,CAAC,eAAe,CAAC,MAAM,eAAe,MAAM,OAAO;AACrD,aAAK,OAAO,MAAM;;AAIpB,UAAI,MAAM,SAAS;AACjB,cAAM,WAAW;;WAEd;AACL,WAAK,OAAO,YAAY;AACxB,WAAK,OAAO,QAAQ;AACpB,WAAK,OAAO,OAAO;;AAErB,SAAK,OAAO,KAAK,WAAW,KAAK,SAAS,WAAW;AACrD,SAAK,QAAQ,yBAAyB,KAAK;AAC3C,SAAK,QAAQ,KAAK,SAAS,mBAAmB,KAAK,SAAS;AAI5D,QAAI,KAAK,UAAU,cAAc;AAI/B,WAAK,QAAQ;;AAGf,cAAU,0BAA0B,SAAS;AAE7C,WAAO;;AAUF,0BAAwB,KAAK;AAClC,QAAI,CAAC,IAAI,UAAU;AACjB,aAAO;;AAET,QAAM,UAAU,IAAI,SAAS,iBAAiB;AAC9C,aAAS,IAAI,GAAG,IAAI,QAAQ,QAAQ,KAAK;AACvC,UAAI,CAAC,cAAc,QAAQ,GAAG,IAAI,gBAAgB;AAChD,eAAO;;;AAGX,WAAO;;AAcF,kCAAgC,OAAO,KAAK;AAGjD,QAAI,SAAS,iBAAiB,KAAK,eAAe;AAChD,UAAM,OAAO,KAAK;QAChB,aAAa,MAAM;QACnB,gBAAgB,MAAM;;AAExB,4BACE,gBAAgB,MAChB,cACA,MACsB;;;AAU5B,2BAAyB,KAAK;AAC5B,QAAM,OAAO,SAAS,iBAAiB,KAAK,eAAe;AAC3D,WAAO,MAAM,cAAc,KAAK,mBAAmB,KAAK,QAAQ;;;;;;;;;;;;;;;;;;;;;;;;;;ACxpBlE,MAAM,OAAO;AAGb,MAAM,cAAc,uBAAuB,KAAK;AAGhD,MAAM,gBAAgB;AAGtB,MAAM,kBAAkB;AAGxB,MAAM,wBAAwB;AAG9B,MAAM,4BAA4B;AAGlC,MAAM,4BAA4B;IAChC,QAAQ,CAAC,UAAU;;AAGrB,MAAM,0BAA0B,CAC9B;IAAC,aAAa;IAAO,QAAQ;KAC7B;IAAC,aAAa;IAAK,QAAQ;KAC3B;IAAC,aAAa;IAAK,QAAQ;KAC3B;IAAC,aAAa;IAAK,QAAQ;KAC3B;IAAC,aAAa;IAAK,QAAQ;KAC3B;IAAC,aAAa;IAAK,QAAQ;;AAWtB,MAAM,sBAAsB;IACjC,UAAU;IACV,YAAY;IACZ,QAAQ;IACR,WAAW;IACX,YAAY;IACZ,oBAAoB;IACpB,iBAAiB;IACjB,UAAU;IACV,SAAS;IACT,aAAa;IACb,UAAU;IACV,cAAc;IACd,UAAU;IACV,OAAO;IACP,YAAY;;AAsDd,MAAa,mBAAb,2BAAA;AA+BE,+BACE,MACA,QACA,MACA,QACA,QACA,OACA,OACA,iBACA,aACA,YACA;AAAA,UAHA,oBAGA,QAAA;AAHA,0BAAkB;;AAGlB,UAFA,gBAEA,QAAA;AAFA,sBAAc;;AAEd,UADA,eACA,QAAA;AADA,qBAAa,KAAK;;AAClB,wBAAA,MAAA;AAEA,WAAK,OAAO;AAEZ,WAAK,SAAS;AAEd,WAAK,OAAO;AAEZ,WAAK,SAAS;AAEd,WAAK,SAAS;AAEd,WAAK,QAAQ;AAEb,WAAK,QAAQ;AAEb,WAAK,kBAAkB;AAEvB,WAAK,cAAc,eAAe,KAAK;AAEvC,WAAK,aAAa;;AA9DtB,mBAAA,mBAAA,CAAA;MAAA,KAAA;MAAA,OAuEE,wBAAe,cAAc;AAE3B,YAAI,CAAC,eAAe,KAAK,QAAQ;AAC/B,gBAAM,MAAM,MAAZ,wBAAwC,KAAK,SAA7C,QAAyD,KAAK;AAC9D,iBAAO;;AAET,YAAI,KAAK,QAAQ,cAAc;AAC7B,cAAM,IAAI,oBAAoB,KAAK;AACnC,iBAAO,MACL,MACA,MAAI,KAAK,kBAAT,mBAAyC,IAAzC,+BAAA,cACa,KAAK,YAAY,gBAD9B,MAC+C,KAAK,SADpD;AAGF,iBAAO;;AAET,eAAO;;;AAtFX,WAAA;;AAiGA,MAAa,gBAAb,2BAAA;AAKE,4BAAY,QAAQ,UAAU;AAAA,wBAAA,MAAA;AAE5B,WAAK,SAAS;AAGd,WAAK,QAAQ,YAAY,OAAO;AAGhC,WAAK,WACH,KAAK,OAAO,iBACZ,YAAsC,KAAK;AAkB7C,WAAK,aAAa,KAAK,WAAW,0BAA0B;AAG5D,WAAK,iBAAiB;AAKtB,WAAK,wBAAwB;AAG7B,WAAK,SAAS;AACd,WAAK,SAAS;AACd,WAAK,SAAS;AACd,WAAK,SAAS;AACd,WAAK,SAAS;AACd,WAAK,SAAS;AACd,WAAK,SAAS;;AAlDlB,mBAAA,gBAAA,CAAA;MAAA,KAAA;MAAA,OA0DE,kBAAS,MAAM;AAAA,YAAA,QAAA;AACb,YAAI,QAAQ,OAAO;AAGjB,eAAK,MAAM,iBAAiB,SAAS,SAAC,OAAU;AAC9C,gBAAI,CAAC,MAAM,kBAAkB;AAC3B,kBAAM,UAAU,MAAM,cAAc,MAAM;AAC1C,oBAAK,QAAQ,SAAS,MAAM,OAAO,YAAY;;;AAGnD,eAAK,MAAM,iBAAiB,WAAW,SAAC,OAAU;AAChD,gBAAO,MAAe,MAAf,KAAK,SAAU,MAAV;AACZ,gBAAM,UAAU,MAAM,cAAc;AACpC,gBAAI,OAAO,KAAK,SAAS,OAAO,KAAK,OAAO;AAC1C,kBAAM,OAAO,QAAQ,aAAa;AAClC,kBAAM,iBACJ,QAAQ,OAAO,qBAAqB,KAAK;AAC3C,kBAAI,CAAC,MAAM,oBAAoB,gBAAgB;AAC7C,oBAAM,YAAY,MAAK,QACrB,SACA,MACA,OACA,YAAY;AAKd,oBAAI,WAAW;AACb,wBAAM;;;;;mBAKL,QAAQ,UAAU;AAC3B,eAAK,MAAM,iBAAiB,MAAM,SAAC,OAAU;AAC3C,gBAAM,UAAU,MAAM,cAAc,MAAM;AAG1C,kBAAK,QAAQ,SAAS,MAAM,OAAO,YAAY;;mBAExC,QAAQ,UAAU;AAC3B,eAAK,MAAM,iBAAiB,MAAM,SAAC,OAAU;AAC3C,gBAAM,UAAU,MAAM,cAAc,MAAM;AAC1C,kBAAK,6BAA6B;AAClC,kBAAK,QAAQ,SAAS,MAAM,OAAO,YAAY;;mBAExC,QAAQ,mBAAmB;AACpC,cAAM,iBAAiB,SACrB,KAAK,OAAO,KACZ,SAAC,OAAU;AACT,gBAAM,SAAS,MAAM,cAAc,MAAM;AACzC,kBAAK,QACH,QACA,MACgC,OAChC,YAAY;aAGhB;AAGF,eAAK,MAAM,iBAAiB,SAAS,SAAC,OAAU;AAG9C,gBAAM,gBAAgB,IAAI,cAAc;AACxC,kBAAK,6BAA6B;AAClC,2BAAe;;mBAER,QAAQ,mBAAmB;AACpC,cAAM,iBAAiB,SACrB,KAAK,OAAO,KACZ,SAAC,OAAU;AACT,gBAAM,SAAS,MAAM,cAAc,MAAM;AACzC,kBAAK,QACH,QACA,MACgC,OAChC,YAAY;aAGhB;AAGF,eAAK,MAAM,iBAAiB,SAAS,SAAC,OAAU;AAC9C,gBAAM,gBAAgB,IAAI,cAAc;AACxC,kBAAK,6BAA6B;AAClC,2BAAe;;mBAER,QAAQ,WAAW,QAAQ,WAAW;AAC/C,eAAK,MAAM,iBAAiB,MAAM,SAAC,OAAU;AAC3C,gBAAM,UAAU,MAAM,cAAc,MAAM;AAC1C,kBAAK,QAAQ,SAAS,MAAM,OAAO,YAAY;;;;OArJvD;MAAA,KAAA;MAAA,OA+JE,yBAAgB,MAAM,SAAS;AAC7B,aAAK,eAAe,QAAQ;;OAhKhC;MAAA,KAAA;MAAA,OAyKE,gCAAuB,MAAM,SAAS,UAAgC;AAAA,YAAhC,aAAgC,QAAA;AAAhC,qBAAW,YAAY;;AAC3D,aAAK,sBAAsB,QAAQ;UAAC;UAAS;;;OA1KjD;MAAA,KAAA;MAAA,OAsLE,iBAAQ,QAAQ,WAAW,OAAO,OAAO,UAAU;AACjD,eAAO,KAAK,QAAQ,QAAQ,WAAW,OAAO,OAAO;;OAvLzD;MAAA,KAAA;MAAA,OAoME,iBAAQ,QAAQ,QAAQ,MAAM,QAAQ,QAAQ,OAAO,OAAO;AAC1D,YAAM,aAAa,IAAI,iBACrB,QACA,QACA,MACA,QACA,QACA,OACA;AAEF,aAAK,QAAQ;;OA9MjB;MAAA,KAAA;MAAA,OA0NE,8BAAqB,QAAQ,SAAS;AAEpC,YAAM,WAAW,OAAO,aAAa,SAAS;AAE9C,kBACE,aAAa,aACX,OAAO,QAAQ,iBAAiB,2BAClC,uCACA,OAAO,UAAU,MAAM;AAGzB,YAAI,OAAO,kBAAkB;AAC3B,gBAAM,MAAM,MAAZ,0CAA0D;AAC1D;;AAEF,eAAO,mBAAmB;AAG1B,YAAM,oBAAoB,OAAO;AACjC,YAAI,QAAQ,oBAAoB;AAE9B,mBAAS,SAAS,MAAM,OAAO,cAAc,cAAc,MAAM,WAAM;AAErE,8BAAkB,QAAQ,SAAC,YAAe;AACxC,kBAAI;AACF,wBAAQ;uBACD,GAAP;AACA,sBAAM,MAAM,MAAM,4BAA4B,YAAY;;;AAG9D,mBAAO,eAAe,SAAS;aAC9B;;;OAzPT;MAAA,KAAA;MAAA,OAoQE,mBAAU,SAAS,iBAAiB,YAAY;AAC9C,eAAO,CAAC,CAAC,KAAK,YAAY,SAAS,iBAAiB;;OArQxD;MAAA,KAAA;MAAA,OAgRE,6BAAoB,SAAS,iBAAiB,YAAY;AAAA,YAAA,SAAA;AACxD,YAAM,SAAS,KAAK,YAAY,SAAS,iBAAiB;AAC1D,YAAI,CAAC,QAAQ;AACX,iBAAO;;AAET,eAAO,OAAO,YAAY,KAAK,SAAC,SAAW;AACzC,cAAO,SAAU,QAAV;AACP,iBAAO,CAAC,CAAC,OAAK,eAAe;;;OAvRnC;MAAA,KAAA;MAAA,OAoSE,sCACE,SACA,iBACA,eACA,YACA;AAAA,YAAA,SAAA;AACA,YAAM,SAAS,KAAK,YAAY,SAAS,iBAAiB;AAC1D,YAAI,CAAC,QAAQ;AACX,iBAAO;;AAET,eAAO,OAAO,YAAY,KAAK,SAAC,YAAe;AAC7C,cAAO,SAAU,WAAV;AACP,iBAAO,OAAK,eAAe,WAAW;;;OAhT5C;MAAA,KAAA;MAAA,OA2TE,wBAAe,QAAQ;AACrB,eAAO,KAAK,eAAe,UACvB,KAAK,QACL,KAAK,MAAM,eAAe;;OA9TlC;MAAA,KAAA;MAAA,OAqUE,sBAAa,WAAW;AACtB,kBACE,UAAU,MAAM,SAAC,GAAD;AAAA,iBAAO,EAAE,eAAe,EAAE;YAC1C;AAEF,aAAK,aAAa;;OA1UtB;MAAA,KAAA;MAAA,OAoVE,wBAAe,aAAa,SAAS,eAAe;AAAA,YAAA,SAAA;AAIlD,YAAI,iBAAiB,cAAc,SAAS,aAAa,KAAK,UAAU;AACtE;;AAEF,YAAI,CAAC,KAAK,YAAY;AACpB,eAAK,aAAa;;AAEpB,YAAI,CAAC,QAAQ,UAAU;AACrB,oBAAU,CAAC;;AAEb,gBAAQ,QAAQ,SAAC,QAAW;AAC1B,cACE,OAAK,WAAW,KACd,SAAC,GAAD;AAAA,mBAAO,EAAE,eAAe,eAAe,EAAE,UAAU;cAErD;AACA;;AAEF,iBAAK,WAAW,KAAK;YAAC;YAAa;;;;OAzWzC;MAAA,KAAA;MAAA,OAsXE,iBAAQ,QAAQ,iBAAiB,OAAO,OAAO,UAAU;AAAA,YAAA,SAAA;AACvD,YAAM,SAAS,KAAK,YAAY,QAAQ;AACxC,YAAI,CAAC,QAAQ;AACX,iBAAO;;AAIT,YAAM,aAAa,KAAK;AAIxB,YAAI,iBAAiB;AACrB,eAAO,YAAY,QAAQ,SAAC,YAAe;AACzC,cAAO,OAA6B,WAA7B,MAAM,SAAuB,WAAvB,QAAQ,MAAe,WAAf,KAAK,SAAU,WAAV;AAC1B,cAAM,mBAAmB,yBAAyB,MAAM,OAAO;AAC/D,cAAM,eAAe,yBAAM;AACzB,gBAAM,OAAO,OAAK,eAAe;AACjC,gBAAI,CAAC,MAAM;AACT,qBAAK,OAAL,aAAuB,SAAvB,6BAAwD,MAAxD;AACA;;AAEF,gBAAM,aAAa,IAAI,iBACrB,MACA,QACA,kBACA,QACA,OAAO,MACP,OACA,OACA,iBACA,KAAK,WAAW,QAChB;AAEF,mBAAO,OAAK,QAAQ;;AAGtB,2BAAiB,iBACb,eAAe,KAAK,gBACpB;;AAGN,eAAO,OAAO,YAAY,UAAU;;OA/ZxC;MAAA,KAAA;MAAA,OAuaE,gBAAO,SAAS,aAAa;AAC3B,YAAI,aAAa;AAEf,cAAM,IAAI,OAAO,YAAP,MAAuB,OAAvB,OAAgC;AAC1C,sBAAY,GAAG;AACf,gBAAM;eACD;AACL,iBAAO,MAAM,MAAM;;;OA9azB;MAAA,KAAA;MAAA,OAubE,iBAAQ,YAAY;AAClB,YAAO,SAAuB,WAAvB,QAAQ,cAAe,WAAf;AAGf,YAAI,KAAK,YAAY;AACnB,cAAI,CAAC,oBAAoB,YAAY,KAAK,aAAa;AACrD,iBAAK,OAAL,MACM,cADN,MACqB,SADrB,0BACmD,KAAK,UACpD,KAAK,cAFT;AAKA,mBAAO;;;AAKX,YAAM,eAAe,KAAK,eAAe;AACzC,YAAI,cAAc;AAChB,iBAAO,aAAa;;AAItB,YAAM,OAAO,MAAM,cAAc,WAAW;AAG5C,YAAM,eAAe,KAAK,sBAAsB;AAChD,YAAI,gBAAgB,WAAW,eAAe,aAAa,WAAW;AACpE,iBAAO,aAAa,QAAQ;;AAI9B,YAAM,eAAe,KAAK,QAAQ;AAClC,YAAI,aAAa,eAAe;AAC9B,cAAI,KAAK,aAAa;AACpB,iBAAK,YAAY;iBACZ;AACL,iBAAK,OAAL,+BAAyC,eAAzC,MAA2D;;AAE7D,iBAAO;;AAIT,YAAM,gBAAgB,0BAA0B;AAEhD,YAAM,WAAW,KAAK,aAAa,SAAS;AAC5C,YACE,aAAa,aACZ,iBAAiB,cAAc,QAAQ,UAAU,IAClD;AACA,cAAM,UAAU,KAAK;AACrB,cAAI,SAAS;AACX,oBAAQ;iBACH;AACL,iBAAK,iBAAiB,KAAK,kBAAkB;AAC7C,iBAAK,eAAe,KAAK;;AAE3B,iBAAO;;AAIT,aAAK,OAAL,aACa,cADb,wBAC8C,SAD9C,aAEE,WAAW;AAGb,eAAO;;OAxfX;MAAA,KAAA;MAAA,OAigBE,qBAAY,QAAQ,iBAAiB,YAAY;AAE/C,YAAI,IAAI;AACR,eAAO,GAAG;AACR,cAAI,cAAc,KAAK,YAAY;AACjC,mBAAO;;AAET,cAAM,cAAc,KAAK,kBAAkB,GAAG;AAC9C,cAAI,eAAe,UAAU,IAAI;AAC/B,mBAAO;cAAC,MAAM;cAAG,aAAa,UAAU;;;AAE1C,cAAI,EAAE;;AAER,eAAO;;OA9gBX;MAAA,KAAA;MAAA,OAshBE,2BAAkB,MAAM,iBAAiB;AACvC,YAAM,YAAY,KAAK,cAAc,MAAM;AAC3C,YAAI,CAAC,WAAW;AACd,iBAAO;;AAET,eAAO,UAAU,oBAAoB;;OA3hBzC;MAAA,KAAA;MAAA,OAmiBE,uBAAc,MAAM,iBAAiB;AACnC,YAAI,YAAY,KAAK;AACrB,YAAI,cAAc,QAAW;AAC3B,sBAAY;AACZ,cAAI,KAAK,aAAa,OAAO;AAC3B,gBAAM,SAAS,KAAK,aAAa;AACjC,wBAAY,eAAe,QAAQ;AACnC,iBAAK,eAAe;qBACX,KAAK,aAAa,YAAY;AACvC,gBAAM,UAAS,KAAK,aAAa;AACjC,wBAAY,eAAkB,kBAAJ,MAAuB,SAAU;AAC3D,iBAAK,eAAe;;;AAGxB,eAAO;;OAjjBX;MAAA,KAAA;MAAA,OAyjBE,oBAAW,MAAM,YAAY;AAC3B,aAAK,aAAa,MAAM;AAGxB,eAAO,KAAK;;OA7jBhB;MAAA,KAAA;MAAA,OAukBE,sCAA6B,OAAO;AAClC,YAAM,SAAqC;AAC3C,YAAO,SAAU,MAAV;AAEP,YAAI,OAAO,UAAU,QAAW;AAC9B,iBAAO,WAAW,OAAO;;AAI3B,YAAI,OAAO,WAAW,SAAS;AAE7B,iBAAO,mBAAmB,OAAO,OAAO;;AAG1C,YAAI,OAAO,YAAY,QAAW;AAChC,iBAAO,aAAa,OAAO;;AAG7B,YAAI,OAAO,QAAQ,UAAa,OAAO,QAAQ,QAAW;AACxD,iBAAO,SAAS,OAAO;AACvB,iBAAO,SAAS,OAAO;;AAGzB,YAAI,OAAO,OAAO;AAChB,iBAAO,WAAW,QAAQ,OAAO,OAAO,IAAI,SAAC,MAAD;AAAA,mBAAW;cACrD,QAAQ,KAAK;cACb,QAAQ,KAAK;cACb,QAAQ,KAAK;;;;AAIjB,YAAI,OAAO,KAAK,QAAQ,SAAS,GAAG;AAClC,cAAI;AACF,kBAAM,SAAS;mBACf,SAAA;;;;;AAzmBR,WAAA;;AAmnBA,wBAAsB,kBAAkB;AACtC,WAAO,iBAAiB,UAAU,GAAG,OAAO;;AAY9C,+BAA6B,YAAY,WAAW;AAClD,QAAK,SAAU,WAAV;AACL,QAAO,OAAqB,WAArB,MAAM,cAAe,WAAf;AAEb,QACE,WAAW,kBACX,OAAO,KAAK,yBAAyB,YACrC;AACA,eAAS,KAAK;;AAEhB,QAAM,WAAW,OAAO;AACxB,QAAM,gBAAgB,YAAY;AAClC,WAAO,UAAU,KAAK,SAAC,GAAM;AAC3B,UACE,EAAE,YAAY,kBAAkB,iBAChC,EAAE,gBAAgB,KAClB;AACA,YAAI,EAAE,OAAO,kBAAkB,UAAU;AACvC,iBAAO;;;AAGX,aAAO;;;AAYX,MAAa,gBAIX,wBAAY,OAAO;AAAA,sBAAA,MAAA;AAEjB,SAAK,SAAS;AAEd,0BAAsB,OAAO;;AAYjC,iCAA+B,UAAU,UAAU;AACjD,QAAM,QAAQ,YAAY;AAC1B,aAAW,QAAQ,UAAU;AAC3B,UAAM,QAAQ,SAAS;AACvB,UAAI,OAAO,UAAU,YAAY;AAC/B,cAAM,QAAQ;aACT;AACL,cAAM,QAAQ,SAAS;;;AAG3B,WAAO;;AAIT,4BAA0B;AACxB,cAAU,MAAM;;AASX,0BAAwB,QAAQ,SAAS;AAC9C,QAAM,eAAe,sBAAsB,KAAK,MAAM,QAAQ;AAC9D,QAAM,cAAc,qBAAqB,KAAK,MAAM,QAAQ;AAE5D,QAAI,YAAY;AAEhB,QAAM,OAAO,IAAI,gBAAgB;AACjC,QAAI;AACJ,QAAI;AACJ,OAAG;AACD,YAAM,KAAK;AACX,UACE,IAAI,QAAQ,UAAU,OACrB,IAAI,QAAQ,UAAU,aAAa,IAAI,SAAS,KACjD;iBAES,IAAI,QAAQ,UAAU,WAAW,IAAI,QAAQ,UAAU,IAAI;AAIpE,YAAM,QAAQ,IAAI;AAGlB,oBAAY,KAAK,QAAQ,CAAC,UAAU,YAAY;AAEhD,YAAM,UAAU;AAGhB,WAAG;AACD,cAAM,SAAS,YAAY,KAAK,QAAQ,CACtC,UAAU,SACV,UAAU,KACT;AAGH,cAAI,SAAS;AACb,cAAI,OAAO;AAEX,iBAAO,KAAK;AACZ,cAAI,KAAK,QAAQ,UAAU,aAAa,KAAK,SAAS,KAAK;AACzD,iBAAK;AACL,qBACE,YAAY,KAAK,QAAQ,CAAC,UAAU,SAAS,UAAU,KAAK,SAC5D;AAGF,mBAAO,KAAK;AACZ,gBAAI,KAAK,QAAQ,UAAU,aAAa,KAAK,SAAS,KAAK;AACzD,mBAAK;AACL,qBAAO,wBAAwB,MAAM,aAAa;;;AAItD,kBAAQ,KAAK;YACX;YACA;YACA;YACA,MACE,QAAQ,UAAU,QAAQ,OAAO,SAC7B,OAAO,OAAO,QACd;YACN,KAAK;;AAGP,iBAAO,KAAK;iBAEZ,KAAK,QAAQ,UAAU,aACvB,KAAK,SAAS,OACd,KAAK;AAGP,YAAI,CAAC,WAAW;AACd,sBAAY;;AAGd,kBAAU,SAAS;aACd;AAEL,qBAAa,OAAD,yBAA+B,KAAI,SAAS,MAA5C;;aAEP,IAAI,QAAQ,UAAU;AAE/B,WAAO;;AAWT,mCAAiC,MAAM,aAAa,cAAc;AAChE,QAAI,OAAO,KAAK;AAChB,QAAI;AACJ,QAAI,OAAO;AAEX,QAAI,KAAK,QAAQ,UAAU,QAAQ;AAGjC,aAAO;AACP,UAAA,aAAgB,KAAK,QAAd,QAAP,WAAO;AACP,WAAK,uBAAuB;AAC5B,kBAAY,KAAK,QAAQ,CAAC,UAAU,YAAY;WAC3C;AAEL,SAAG;AACD,cAAM,KAAK;AACX,YAAA,OAAsB,KAAf,OAAP,KAAO,MAAM,SAAb,KAAa;AACb,YAAI,QAAQ,UAAU,aAAc,WAAS,OAAO,UAAS,MAAM;mBAExD,QAAQ,UAAU,WAAW,QAAQ,UAAU,IAAI;AAE5D,sBAAY,KAAK,QAAQ,CAAC,UAAU,YAAY;AAEhD,gBAAM,YAAY,KAAK,KAAwB,OAAO,CACpD,UAAU,SACV,UAAU;AAEZ,cAAM,iBAAiB,CAAC;AAExB,cAAI,IAAI,QAAQ,UAAU,IAAI;AAC5B,iBACE,OAAO,KAAK,QACZ,KAAK,QAAQ,UAAU,aAAa,KAAK,SAAS,KAClD,OAAO,KAAK,QACZ;AACA,mBAAK;AACL,oBAAM,YAAY,KAAK,KAAK,QAAQ,CAAC,UAAU;AAC/C,6BAAe,KAAK;;;AAGxB,cAAM,WAAW,kBAAkB;AACnC,cAAI,CAAC,MAAM;AACT,mBAAO;;AAET,eAAK,UAAS;AACd,iBAAO,KAAK;AACZ,uBACE,KAAK,QAAQ,UAAU,aACpB,MAAK,SAAS,OAAO,KAAK,SAAS,MACtC;eAEG;AAEL,uBAAa,OAAD,yBAA+B,KAAI,SAAS,MAA5C;;eAEP,CAAE,KAAI,QAAQ,UAAU,aAAa,IAAI,SAAS;;AAE7D,WAAO;;AAQT,6BAA2B,QAAQ;AACjC,QAAI,OAAO,UAAU,GAAG;AACtB,aAAO;eACE,OAAO,UAAU,GAAG;AAC7B,aAA+C,OAAO,GAAG;WACpD;AACL,UAAM,UAAS,OAAO,IAAI,SAAC,OAAD;AAAA,eAAW,MAAM;;AAC3C,UAAM,aAAa,QAAO,KAAK;AAC/B,aAAkD;QAAC;;;;AAYhD,oCAAkC,MAAM,OAAO,UAAU;AAC9D,QAAI,CAAC,MAAM;AACT,aAAO;;AAET,QAAM,OAAO,YAAY,KAAK;AAC9B,QAAI,OAAO;AACT,UAAM,SAAS,UAAiC;AAChD,UAAI,QAAQ;AACV,aAAK,WAAW;;;AAGpB,QAAM,UAAU;AAChB,WAAO,KAAK,MAAM,QAAQ,SAAC,KAAQ;AACjC,UAAI,QAAQ,KAAK;AAKjB,UAAI,OAAO,SAAS,YAAY,MAAM,YAAY;AAChD,YAAM,OAAkD,MAAO;AAC/D,YAAM,YAAY,gBAAgB,MAAM;AAExC,gBAAQ,cAAc,SAAY,OAAO;;AAE3C,UAAI,KAAK,QAAQ;AACf,gBAAQ,OAAO,KAAK;aACf;AACL,gBAAQ,OAAO;;;AAGnB,WAAO;;AAYT,iCAA+B,GAAG,SAAS,WAAW,aAAa;AACjE,WAAO,WACL,WACA,4CACA,SACA,GACA,eAAe;;AAanB,gCAA8B,GAAG,SAAS,KAAK,OAAO,WAAW;AAC/D,QAAI,cAAc,QAAW;AAC3B,4BACE,GACA,SACA,MAAM,SAAS,IAAI,SAAS,IAAI,SAAS,WAHtB,iBAIJ,YAJI;WAMhB;AACL,4BAAsB,GAAG,SAAS,MAAM,SAAS,IAAI;;AAEvD,WAAO;;AAMT,MAAM,YAAY;IAChB,SAAS;IACT,KAAK;IACL,WAAW;IACX,SAAS;IACT,IAAI;IACJ,QAAQ;;AASV,MAAM,iBAAiB;AAGvB,MAAM,gBAAgB;AAGtB,MAAM,aAAa;AAGnB,MAAM,aAAa;AAGnB,MAAM,cAAc,iBAAiB,gBAAgB,aAAa;MAG5D,kBAAA,2BAAA;AAIJ,8BAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,OAAO;AAGZ,WAAK,SAAS;;;;aAQhB,cAAK,mBAAmB;AACtB,YAAM,MAAM,KAAK,MAAM,qBAAqB;AAC5C,aAAK,SAAS,IAAI;AAClB,eAAO;;;;aAQT,cAAK,mBAAmB;AACtB,eAAO,KAAK,MAAM,qBAAqB;;;;aAOzC,eAAM,eAAe;AACnB,YAAI,WAAW,KAAK,SAAS;AAC7B,YAAI,YAAY,KAAK,KAAK,QAAQ;AAChC,iBAAO;YAAC,MAAM,UAAU;YAAK,OAAO,KAAK;;;AAG3C,YAAI,IAAI,KAAK,KAAK,OAAO;AAGzB,YAAI,eAAe,QAAQ,MAAM,IAAI;AACnC;AACA,iBAAO,WAAW,KAAK,KAAK,QAAQ,YAAY;AAC9C,gBAAI,eAAe,QAAQ,KAAK,KAAK,OAAO,cAAc,IAAI;AAC5D;;;AAGJ,cAAI,YAAY,KAAK,KAAK,QAAQ;AAChC,mBAAO;cAAC,MAAM,UAAU;cAAK,OAAO;;;AAEtC,cAAI,KAAK,KAAK,OAAO;;AAIvB,YACE,iBACC,OAAM,MACJ,KAAK,OACJ,WAAW,IAAI,KAAK,KAAK,UACzB,MAAM,KAAK,KAAK,WAAW,MAC/B;AACA,cAAI,cAAc,KAAK;AACvB,cAAI,OAAM,WAAW;AACrB,iBAAO,OAAM,KAAK,KAAK,QAAQ,QAAO;AACpC,gBAAM,KAAK,KAAK,KAAK,OAAO;AAC5B,gBAAI,MAAM,KAAK;AACb,4BAAc;AACd;;AAEF,gBAAI,CAAC,MAAM,KAAK;AACd;;;AAGJ,cAAM,KAAI,KAAK,KAAK,UAAU,UAAU;AACxC,cAAM,QAAQ,cAAc,WAAW,MAAK,SAAS,IAAG;AACxD,qBAAW,OAAM;AACjB,iBAAO;YAAC,MAAM,UAAU;YAAS;YAAO,OAAO;;;AAIjD,YAAI,cAAc,QAAQ,MAAM,IAAI;AAClC,iBAAO;YAAC,MAAM,UAAU;YAAW,OAAO;YAAG,OAAO;;;AAItD,YAAI,WAAW,QAAQ,MAAM,IAAI;AAC/B,cAAI,QAAM;AACV,mBAAS,IAAI,WAAW,GAAG,IAAI,KAAK,KAAK,QAAQ,KAAK;AACpD,gBAAI,KAAK,KAAK,OAAO,MAAM,GAAG;AAC5B,sBAAM;AACN;;;AAGJ,cAAI,SAAO,IAAI;AACb,mBAAO;cAAC,MAAM,UAAU;cAAS,OAAO;;;AAE1C,cAAM,UAAQ,KAAK,KAAK,UAAU,WAAW,GAAG;AAChD,qBAAW;AACX,iBAAO;YAAC,MAAM,UAAU;YAAS,OAAA;YAAO,OAAO;;;AAIjD,YAAI,KAAK,KAAK;AACZ,cAAI,iBAAiB;AACrB,cAAI,QAAM;AACV,mBAAS,KAAI,WAAW,GAAG,KAAI,KAAK,KAAK,QAAQ,MAAK;AACpD,gBAAM,OAAO,KAAK,KAAK;AACvB,gBAAI,QAAQ,KAAK;AACf;uBACS,QAAQ,KAAK;AACtB;;AAEF,gBAAI,kBAAkB,GAAG;AACvB,sBAAM;AACN;;;AAGJ,cAAI,SAAO,IAAI;AACb,mBAAO;cAAC,MAAM,UAAU;cAAS,OAAO;;;AAE1C,cAAM,UAAQ,KAAK,KAAK,UAAU,UAAU,QAAM;AAClD,qBAAW;AACX,iBAAO;YAAC,MAAM,UAAU;YAAQ,OAAA;YAAO,OAAO;;;AAIhD,YAAI,MAAM,WAAW;AACrB,eAAO,MAAM,KAAK,KAAK,QAAQ,OAAO;AACpC,cAAI,YAAY,QAAQ,KAAK,KAAK,OAAO,SAAS,IAAI;AACpD;;;AAGJ,YAAM,IAAI,KAAK,KAAK,UAAU,UAAU;AACxC,mBAAW,MAAM;AAGjB,YAAI,iBAAkB,MAAK,UAAU,KAAK,UAAU;AAClD,cAAM,UAAQ,KAAK;AACnB,iBAAO;YAAC,MAAM,UAAU;YAAS,OAAA;YAAO,OAAO;;;AAIjD,YAAI,CAAC,MAAM,EAAE,OAAO,KAAK;AACvB,iBAAO;YAAC,MAAM,UAAU;YAAI,OAAO;YAAG,OAAO;;;AAI/C,eAAO;UAAC,MAAM,UAAU;UAAS,OAAO;UAAG,OAAO;;;;;;AAStD,iBAAe,GAAG;AAChB,WAAO,KAAK,OAAO,KAAK;;AAMnB,sCAAoC,QAAQ;AACjD,iCACE,QACA,UACA,eACsB;;;;AC51CnB,6BAA2B,GAAG;AAEnC,WAAO,CAAC,CAAC,KAAK,OAAO,EAAE,eAAe;;;;;;;;;;;;;;;;;;ACfxC,MAAM,kBAAkB,CAAC,OAAO;AAGhC,MAAM,wBAAwB,CAAC,SAAS;AA4CjC,iCAA+B,OAAO,MAAM;AACjD,QAAM,UAAO,UAAA,IAAqC;AAClD,QAAI,kBAAkB,KAAK,OAAO;AAChC,UAAM,UAAoD,KAAK;AAC/D,cAAQ,QAAQ,kBAAkB;AAClC,cAAQ,OAAO,aAAa,QAAQ;;AAEtC,WAAO;MAAC;MAAO,MAAM;;;AAyChB,mCAAiC,UAAU,cAAc;AAC9D,gBAAW,SAAS,WAAW,uBAAuB;AAEtD,QAAM,iBAAiB,gBAAgB;AACvC,QAAI,CAAC,gBAAgB;AAKnB,aAAO,IAAI,SAAS,SAAS,SAAS,SAAS;;AAGjD,QAAM,oBAAoB;AAC1B,QAAM,OAAO;MACX,QAAQ;MACR,YAAY;MAKZ,mBAPW,2BAOO,MAAM;AACtB,eAAO,kBAAkB,OAAO,MAAM,kBAAkB;;;AAI5D,QAAI,SAAS,SAAS;AACpB,UAAM,OAAO,SAAS;AACtB,UAAI,QAAQ,KAAK,UAAU;AACF,aAAK,QAAS,QAAQ,SAAC,OAAU;AACtD,cAAM,aAAa,MAAM;AACzB,cAAM,cAAc,MAAM;AAC1B,4BAAkB,OAAO,YAAY,iBACnC,OAAO;;;AAGb,UAAI,KAAK,QAAQ;AACf,aAAK,SAAS,SAAS,KAAK,QAAQ;;AAEtC,UAAI,KAAK,YAAY;AACnB,aAAK,aAAa,OAAO,KAAK;;;AAIlC,WAAO,IAAI,SAAS,SAAS,UAAU,OAAO,SAAS,WAAW,IAAI;;AAuBjE,sCAAoC,KAAK,cAAc,OAAO,MAAM;AACzE,QAAI,CAAC,cAAc;AACjB,aAAO;;AAGT,QAAM,gBAAgB,KAAK,gBACvB,oBACA,aAAa;AACjB,QAAM,SAAS,SAAS,aAAa;AACrC,QAAM,aAAa,cAAc;AACjC,QAAM,qBAAqB,OAAO,cAAc;AAChD,QAAM,iCACJ,KAAK,2BAA2B,QAAQ,KAAK;AAC/C,QAAI,cAAc,CAAC,sBAAsB,gCAAgC;AACvE,aAAO;;AAGT,QAAM,cAAc,aAAa,cAAc;AAC/C,QAAM,aAAa,YAAY,aAAa;AAC5C,QAAI,CAAC,YAAY;AACf,aAAO;;AAGT,WAAO,cACJ,KAAK,WAAA;AAAA,aAAM,OAAO;OAClB,KAAK,SAAC,eAAkB;AACvB,UACE,CACE,kBACA,QAAQ,KAAK,YACb,eAAe,KAAK,gCAEtB;AACA;;AAEF,UAAM,iBAAiB,KAAK;QAC1B,mBAAmB,sBAAsB,OAAO;;AAElD,aAAO,OACJ,yBAAyB,OAAO,gBAChC,KAAK,SAAC,UAAD;AAAA,eACJ,wBAAwB,UAAU,KAAK;;;;AAa1C,sBAAoB,KAAK,OAAO,MAAM;AAC3C,eAAU,OAAO,SAAS,UAAU,0BAA0B;AAC9D,QAAI,KAAK,YAAY,OAAO;AAC1B,cAAQ,WAAW,KAAK;;AAE1B,WAAO;;AAUF,qBAAmB,UAAU,YAAY;AAC9C,QAAM,OAAO,YAAY;AAIzB,QAAM,QAAQ,KAAK;AACnB,eACE,UAAU,UAAa,SAAS,aAAa,SAAS,QACtD,6CACA;AAGF,SAAK,SAAS,iBAAiB,KAAK;AACpC,SAAK,UAAU,KAAK,WAAW,KAAK;AACpC,QAAI,YAAY;AACd,WAAK,QAAQ,YAAY;;AAI3B,eAAU,KAAK,SAAS,MAAM;AAE9B,WAAO;;AAWF,wBAAsB,KAAK,OAAO,MAAM;AAC7C,WAAO,QAAQ;AAGf,QAAM,gBAAgB,aAAa;AACnC,QAAM,eAAe,mBAAmB,OAAO;AAC/C,QAAI,iBAAiB,cAAc;AACjC,WAAK,aAAa,KAAK,cAAc;AACrC,WAAK,WAAW,qBAAqB;;AAEvC,WAAO;;AAOF,8BAA4B,MAAM;AACvC,QAAM,YAAY,UAAU,MAAM;AAClC,QAAI,UAAU,UAAU,UAAU,CAAC,kBAAkB,UAAU,OAAO;AAGpE,iBACE,sBAAsB,KAAK,SAAC,MAAD;AAAA,eAAU,KAAK,UAAU;UACpD,4CACA,UAAU;AAIZ,gBAAU,QAAQ,kBAChB,UAAU,QAAQ,mBAAmB;AACvC,UAAM,oBAAoB,UAAU,QAAQ;AAE5C,UAAI,sBAAsB,qCAAqC;AAC7D,kBAAU,OAAO,qBACa,UAAU;aAEnC;AACL,kBAAU,OAAO,KAAK,UACQ,UAAU;;;AAI5C,WAAO;;AAST,4BAA0B,QAAQ;AAChC,QAAI,WAAW,QAAW;AACxB,aAAO;;AAET,aAAS,OAAO;AAChB,eACE,gBAAgB,SAAS,SACzB,+CACA,gBAAgB,KAAK,OACrB;AAEF,WAAO;;AAQT,uBAAqB,QAAQ;AAC3B,WAAO,UAAU,OAAQ,UAAU,OAAO,SAAS;;AAQ9C,yBAAuB,UAAU;AACtC,WAAO,IAAI,QAAQ,SAAC,SAAY;AAC9B,UAAI,SAAS,IAAI;AACf,eAAO,QAAQ;;AAGjB,UAAO,SAAU,SAAV;AACP,UAAM,MAAM,OAAO,YAAP,gBAAiC;AAC7C,UAAI,eAAe,YAAY;AAG/B,UAAI,cAAc;AAClB,YAAM;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/VV,MAAa,MAAb,2BAAA;AAIE,kBAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,MAAM;AAEX,UAAM,iBAAgB,SAAS,iBAAiB;AAShD,WAAK,gBAAgB,eAAc,gBAC/B,eAAc,iBACd;;AAnBR,mBAAA,MAAA,CAAA;MAAA,KAAA;MAAA,OA+BE,gBAAO,OAAO,MAAM;AAAA,YAAA,aAAA,WAAA,QAAA;AAClB,eAAO,2BACL,KAAK,KACL,KAAK,eACL,OACA,MACA,KAAK,SAAC,qBAAwB;AAC9B,cAAI,qBAAqB;AACvB,mBAAO;;AAKT,cAAI,kBAAkB,KAAK,OAAO;AAChC,gBAAM,kBACJ,KAAK;AAEP,iBAAK,OAAO,gBAAgB;;AAE9B,iBAAO,MAAK,IAAI,MAAM,MAAM,MAAM;;;OAlDxC;MAAA,KAAA;MAAA,OAkEE,uBAAc,OAAO,MAAW;AAAA,YAAX,SAAW,QAAA;AAAX,iBAAO;;AAC1B,gBAAQ,WAAW,KAAK,KAAK,OAAO;AACpC,eAAO,aAAa,KAAK,KAAK,OAAO;AACrC,eAAO,KAAK,OAAO,OAAO,MAAM,KAC9B,SAAC,UAAD;AAAA,iBAAc;WACd,SAAC,QAAW;AACV,cAAM,eAAe,mBAAmB,OAAO;AAC/C,gBAAM,OAAO,oBACX,OADI,sBAEgB,eAFhB,UAGJ,UAAiC,OAAQ;;;OA5EnD;MAAA,KAAA;MAAA,OA8FE,mBAAU,OAAO,UAAU;AACzB,eAAO,KAAK,MAAM,OAAO,mBAAmB;;OA/FhD;MAAA,KAAA;MAAA,OA8GE,mBAAU,OAAO,UAAU;AACzB,eAAO,KAAK,MAAM,OAAO,UAAU,UAAU;;OA/GjD;MAAA,KAAA;MAAA,OAyHE,kBAAS,KAAK,QAAQ;AACpB,YAAI,CAAC,QAAQ;AACX,iBAAO,IAAI;;AAGb,eAAO,IAAI,OAAO,KAAK,SAAC,KAAQ;AAC9B,cAAI,CAAC,IAAI,WAAW,MAAM,aAAa,UAAU;AAC/C,mBAAO,KACL,OADF,qCAEqC,SAFrC;AAIA,mBAAO,UAAU;;AAEnB,iBAAO,UAAU,IAAI,MAAM,OAAO;;;OAtIxC;MAAA,KAAA;MAAA,OA+IE,eAAM,OAAO,UAAU;AACrB,YAAM,OAAO,UAAU;AACvB,eAAO,KAAK,cAAc,OAAO,MAAM,KAAK,SAAC,UAAD;AAAA,iBAC1C,cAAc;;;OAlJpB;MAAA,KAAA;MAAA,OAiKE,oBAAW,OAAO,UAAU;AAC1B,eAAO,KAAK,cAAc,OAAO,UAAU,KAAK,SAAC,UAAD;AAAA,iBAC9C,cAAc;;;OAnKpB;MAAA,KAAA;MAAA,OA+KE,qBAAW,KAAK,KAAK;AACnB,eAAO,WAAW,KAAK;;;AAhL3B,WAAA;;AAgMO,6BAA2B,SAAQ;AACxC,2BAAuB,SAAQ,OAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3MxC,MAAa,aAAb,yBAAA,MAAA;AAAA,eAAA,aAAA;AAAA,QAAA,SAAA,cAAA;AAIE,yBAAY,KAAK;AAAA,UAAA;AAAA,wBAAA,MAAA;AACf,cAAA,OAAA,KAAA,MAAM;AAGN,YAAK,iBAAiB;AAJP,aAAA;;AAJnB,mBAAA,aAAA,CAAA;MAAA,KAAA;MAAA,OAmBE,eAAM,OAAO,UAAU;AAAA,YAAA,SAAA;AACrB,YAAM,SACH,YAAY,SAAS,WAAW,SAAS,QAAQ,aAAc;AAClE,YAAM,cACJ,CAAC,YAAY,CAAC,SAAS,UAAU,SAAS,WAAW;AACvD,YAAM,MAAM,KAAK,WAAW,OAAO;AACnC,YAAM,YAAY,CAAC,CAAC,KAAK,eAAe;AAExC,YAAI,eAAe,WAAW;AAC5B,iBAAO,KAAK,eAAe,KAAK,KAAK,SAAC,UAAD;AAAA,mBAAc,SAAS;;;AAG9D,YAAM,eAAY,KAAA,iBAAA,YAAA,YAAA,SAAA,MAAA,KAAA,MAAe,OAAO;AAExC,YAAI,aAAa;AACf,eAAK,eAAe,OAAO,aAAa,KACtC,SAAC,UAAa;AACZ,mBAAO,OAAK,eAAe;AAC3B,mBAAO,SAAS;aAElB,SAAC,KAAQ;AACP,mBAAO,OAAK,eAAe;AAC3B,kBAAM;;;AAKZ,eAAO;;OA9CX;MAAA,KAAA;MAAA,OAyDE,oBAAW,OAAO,cAAc;AAC9B,YAAM,cAAc,mBAClB,OACA,gBAAgB,KAAK,IAAI;AAE3B,eAAO,eAAe,eAAe;;;AA9DzC,WAAA;IAAgC;AA8EzB,oCAAkC,SAAQ;AAC/C,2BAAuB,SAAQ,eAAe;;;;ACpEhD,MAAM,OAAO,KAAK,KAAK;AACvB,MAAM,MAAM,KAAK;AACjB,MAAM,OAAO,MAAM;;;ACZnB,MAAM,sBAAsB;IAAC,KAAK;IAAK,KAAK;IAAK,KAAK;;AA6B/C,oCAAkC,OAAO;AAC9C,QAAM,MAAM,cAAc;AAC1B,WAAO,KAAK,KAAK,QAAQ,UAAU,SAAC,IAAD;AAAA,aAAQ,oBAAoB;;;;;AClBjE,MAAM,iBAAiB,KAAK,OAAO;AAK5B,MAAM,0BAA0B,MAAM;AAkpB7C,sBAAoB,KAAK;AAEvB,QAAM,aAAa,0BAA0B,KAAK;AAClD,QAAI,YAAY;AACd,aAAO;;AAIT,WAAO,OACL,IAAI,SAAS,OACX,KAAK,QACL,IAAI,KAAK,WACT,IAAI,OAAO,QACX,IAAI,OAAO;;AASV,6BAA2B,KAAK;AACrC,QAAM,UAAU,WAAW;AAC3B,QAAI,OAAO,WAAW,UAAU;AAC9B,aAAO,SAAS,UAAU,KAAK,aAAa;WACvC;AAGL,UAAM,OAAmC;AACzC,aAAO,WAAW,WAAA;AAAA,eAChB,yBAAyB,MAEtB,QAAQ,QAAQ;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC1sBzB,MAAM,OAAM;AAOZ,MAAa,SAAb,2BAAA;AAKE,qBAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,OAAO;AAEZ,UAAI,SAAS;AACb,UAAI,iBAAiB;AACrB,UAAI,IAAI,QAAQ;AACd,YAAI,IAAI,OAAO,QAAQ;AACrB,mBAAS,IAAI,OAAO;mBACX,IAAI,OAAO,cAAc;AAClC,mBAAS,IAAI,OAAO;AACpB,2BAAiB;;;AAKrB,WAAK,WAAW;QACd,MAAM;QACN,MAAM;UAAC,MAAM;;;AAIf,WAAK,SAAS;AAGd,WAAK,kBAAkB;AAGvB,WAAK,mBAAmB;;AAjC5B,mBAAA,SAAA,CAAA;MAAA,KAAA;MAAA,OA2CE,gBAAO,OAAO;AAAA,YAAA,QAAA;AACZ,YAAI,OAAO,UAAU,UAAU;AAC7B,kBAAQ,cAAc;;AAGxB,YAAI,CAAC,KAAK,UAAU,KAAK,kBAAkB;AAEzC,iBAAQ,MAAK,oBAAoB,KAAK,iBAAiB,KACrD,SAAC,gBAAD;AAAA,mBAAoB,eAAe;;;AAIvC,YAAI;AACF,iBACE,KAAK,OACF,OAAO;YAAC,MAAM;aAAY,OAE1B,KACC,SAAC,QAAD;AAAA,mBAAY,IAAI,WAAW;aAC3B,SAAC,GAAM;AAGL,gBAAI,EAAE,WAAW,EAAE,QAAQ,QAAQ,mBAAmB,GAAG;AAEvD,qBAAO,MACL,MACA,iDACA;;AAGJ,mBAAO,MAAK,gBAAgB,KAAK,WAAA;AAAA,qBAAM,MAAK,OAAO;;;iBAIpD,GAAP;AACA,gBAAM,MAAM,MAAK,iDAAiD;AAClE,iBAAO,KAAK,gBAAgB,KAAK,WAAA;AAAA,mBAAM,MAAK,OAAO;;;;OA/EzD;MAAA,KAAA;MAAA,OA2FE,sBAAa,OAAO;AAClB,eAAO,KAAK,OAAO,OAAO,KAAK,SAAC,QAAD;AAAA,iBAC7B,yBAAyB;;;OA7F/B;MAAA,KAAA;MAAA,OAwGE,iBAAQ,OAAO;AACb,eAAO,KAAK,OAAO,OAAO,KAAK,SAAC,QAAW;AAGzC,cAAI,SAAS;AACb,mBAAS,IAAI,GAAG,KAAK,GAAG,KAAK;AAE3B,qBAAU,UAAS,OAAO,MAAM;;AAElC,iBAAO;;;OAjHb;MAAA,KAAA;MAAA,OA0HE,yBAAgB;AAAA,YAAA,SAAA;AACd,YAAI,KAAK,kBAAkB;AACzB,iBAAO,KAAK;;AAEd,eAAQ,KAAK,mBAAmB,SAAS,cAAc,KAAK,MACzD,iBAAiB,uBACjB,KAAK,WAAA;AAAA,iBAAM,WAAW,OAAK,MAAM;;;OAhIxC;MAAA,KAAA;MAAA,OA4IE,2BAAkB;AAChB,eAAO,QAAQ,KAAK,WAAW,KAAK,KAAK,uBAAuB;;OA7IpE;MAAA,KAAA;MAAA,OAyJE,uBAAc,KAAK;AACjB,kBAAU,KAAK;AAEf,YAAM,UAAU,KAAK,kBACjB,WAAW,KAAK,UAAsC,QAChB;AAC1C,eACE,KAAK,OAAO,UAAU,OAAO,SAAS,KAAK,UAAU,MAAM,CAAC;;OAhKlE;MAAA,KAAA;MAAA,OA8KE,oBAAW,KAAK,WAAW,MAAM;AAC/B,kBAAU,KAAK;AACf,eACE,KAAK,OAAO,OAAO,KAAK,UAAU,KAAK,WAAW;;;AAjLxD,WAAA;;AA0LO,gCAA8B,KAAK;AACxC,WAAO,uBAAuB,KAAK,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;ACjM/C,MAAM,mBAAmB,CAAC,YAAY,WAAW,cAAc;AAgCxD,4CAA0C,WAAW;AAC1D,WAAO,6BAA6B,WAAW,gBAAgB;;AAGjE,MAAa,UAAb,2BAAA;AAIE,sBAAY,QAAQ;AAAA,wBAAA,MAAA;AAElB,WAAK,UAAU;AAEf,WAAK,QAAQ;AAEb,WAAK,gBAAgB;;AAVzB,mBAAA,UAAA,CAAA;MAAA,KAAA;MAAA,OAcE,eAAM;AACJ,YAAI,KAAK,OAAO;AACd,iBAAO,KAAK;;AAEd,YAAM,SAAS,KAAK;AACpB,YAAM,MAAM,OAAO;AACnB,YAAM,YAAY,aAAa;AAC/B,YAAM,WAAW,OAAO;AACxB,YAAI,eAAe,YAAY,SAAS,OAAO,SAAS,IAAI;AAC5D,YAAI,CAAC,cAAc;AACjB,cAAM,eAAe,SAAS,cAAc;AAC5C,yBAAe,eACX,mBAAmB,aAAa,MAAM,OACtC;;AAEN,YAAM,aAAa,cAAc,OAAO;AACxC,YAAM,WAAW,YAAY,OAAO,IAAI;AACxC,YAAM,WAAW,YAAY,OAAO,IAAI;AACxC,YAAM,gBAAgB,iBAAiB;AAEvC,eAAQ,KAAK,QAAQ;cAEf,YAAY;AACd,mBAAO,aAAa,OAAO;;UAE7B;UACA;cACI,eAAe;AAIjB,gBAAI,CAAC,KAAK,eAAe;AACvB,mBAAK,gBAAgB,kBAAkB,OAAO;;AAEhD,mBAAO,KAAK;;UAEd;UACA;UACA;;;;AApDN,WAAA;;AAgEA,yBAAuB,KAAK;AAC1B,WAAO,OAAO,KAAK,MAAM,IAAI,KAAK,WAAW;;AAS/C,uBAAqB,KAAK;AACxB,QAAM,WAAW;AACjB,QAAI,IAAI,MAAM;AACZ,UAAM,QAAQ,IAAI,KAAK,iBAAiB;AAD5B,UAAA,QAAA,gBAEH,IAFG;AAGV,YAAM,OAAO,MAAM;AACnB,YAAO,OAAQ,KAAR;AACP,YAAM,OAAO,KAAK,aAAa;AAC/B,YAAI,CAAC,QAAQ,CAAC,MAAM;AAClB,iBAAA;;AAGF,aAAK,MAAM,OAAO,QAAQ,SAAC,KAAQ;AACjC,cAAI,iBAAiB,QAAQ,QAAQ,IAAI;AACvC;;AAGF,cAAI,QAAQ,SAAS;AACrB,cAAI,OAAO;AAET,gBAAI,CAAC,QAAQ,QAAQ;AACnB,sBAAQ,SAAS,OAAO,CAAC;;AAE3B,kBAAM,KAAK;iBACN;AACL,qBAAS,OAAO;;;;AArBtB,eAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AAAA,YAAA,OAAA,MAA9B;AAA8B,YAAA,SAAA;AAKnC;;;AAqBN,WAAO;;AAST,uBAAqB,KAAK;AACxB,QAAM,aAAa,IAAI,KAAK,cAAc;AAC1C,WAAO,aAAa,WAAW,aAAa,aAAa;;AAS3D,4BAA0B,QAAQ;AAEhC,QACE,CAAC,OAAO,iBACR,oBAAoB,OAAO,IAAI,SAAS,SAAS,KACjD;AACA,aAAO;;AAET,QAAM,MAAM,mBAAmB,OAAO,IAAI,SAAS;AACnD,QAAM,aAAa,iBAAiB,IAAI,QAAQ;AAChD,QAAI,eAAe,QAAW;AAE5B,aAAO;;AAET,WAAO,iBAAiB;;;;ACxKnB,6CAA2C,QAAQ;AAGxD,WAAO,OAAO,sBAAsB,KAAK,WAAM;AAC7C,UAAI,OAAO,kBAAkB,aAAa;AACxC,eACG,cACA,iBAAiB,UAAU,uBAAuB;;;;AAWpD,iCAA+B,GAAG;AACvC,QAAI,EAAE,kBAAkB;AACtB;;AAGF,QAAM,OAAO,MAAM,cAAc,EAAE;AACnC,QAAI,CAAC,QAAQ,KAAK,WAAW,QAAQ;AACnC;;AAKF,QAAM,kBAAkB,KAAK,UAAU,SAAS;AAChD,QAAI;AACJ,QAAI,iBAAiB;AACnB,uBAAiB,CAAC,KAAK,aAAa;WAC/B;AACL,uBAAiB,CAAC,KAAK,aAAa;;AAMtC,QAAI,kBAAkB,KAAK,iBAAiB,CAAC,KAAK,iBAAiB;AACjE,QAAE;;AAGJ,QAAM,SAAS,KAAK;AACpB,aAAS,IAAI,GAAG,IAAI,OAAO,QAAQ,KAAK;AACtC,iBACE,CAAC,OAAO,GAAG,QAAQ,OAAO,GAAG,QAAQ,qBACrC,oCACA,qBACA,OAAO;;AAIX,QAAM,SAAS,KAAK,aAAa;AACjC,QAAM,YAAY,KAAK,aAAa;AACpC,QAAM,SAAU,MAAK,aAAa,aAAa,OAAO;AAEtD,QAAI,WAAW;AACb,qBAAe,WAAW,MAAM;AAChC,iBACE,CAAC,cAAc,YACf,gDACA;AAEF,mBAAa;;AAEf,QAAI,QAAQ;AACV,qBAAe,QAAQ,MAAM;AAC7B,iBACE,CAAC,cAAc,SACf,4CACA;AAEF,mBAAa;;AAGf,QAAI,UAAU,OAAO;AACnB,iBACE,aAAa,QACb,sEACA;eAEO,UAAU,QAAQ;AAC3B,UAAI,QAAQ;AACV,YAAM,QAAM;AACZ,eAAO,MACL,OACA,mDACA;;AAIJ,UAAI,CAAC,WAAW;AACd,UAAE;AACF,mBACE,OACA,2FAEA;;;AAKN,QAAM,SAAS,KAAK,aAAa;AACjC,QAAI,QAAQ;AACV,iBACE,UAAU,YAAY,UAAU,QAChC,4DACA,QACA;WAEG;AACL,WAAK,aAAa,UAAU;;AAO9B,QAAI,WAAW;AACb,QAAE;AAKF,QAAE;AAEF,UAAM,UAAU,SAAS,oBAAoB;AAC7C,cAAQ,QACN,MACA,UACS,MACE,MACA,MACX,GACA,YAAY;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChJlB,MAAa,aAAb,2BAAA;AAIE,2BAAc;AAAA,wBAAA,MAAA;AAEZ,WAAK,YAAY;;AANrB,mBAAA,aAAA,CAAA;MAAA,KAAA;MAAA,OAcE,aAAI,SAAS;AAAA,YAAA,QAAA;AACX,YAAI,CAAC,KAAK,WAAW;AACnB,eAAK,YAAY;;AAEnB,aAAK,UAAU,KAAK;AACpB,eAAO,WAAM;AACX,gBAAK,OAAO;;;OApBlB;MAAA,KAAA;MAAA,OA4BE,iBAAO,SAAS;AACd,YAAI,CAAC,KAAK,WAAW;AACnB;;AAEF,mBAAW,KAAK,WAAW;;OAhC/B;MAAA,KAAA;MAAA,OAsCE,qBAAY;AACV,YAAI,CAAC,KAAK,WAAW;AACnB;;AAEF,aAAK,UAAU,SAAS;;OA1C5B;MAAA,KAAA;MAAA,OAiDE,cAAK,WAAW;AACd,YAAI,CAAC,KAAK,WAAW;AACnB;;AAEF,iBAAA,YAAA,iCAAsB,KAAK,YAA3B,OAAA,CAAA,SAAA,aAAA,QAAsC;AAAA,cAA3B,UAA2B,MAAA;AACpC,kBAAQ;;;OAtDd;MAAA,KAAA;MAAA,OA8DE,2BAAkB;AAAA,YAAA,uBAAA;AAChB,eAAA,yBAAA,mBAAO,KAAK,cAAZ,OAAA,SAAO,gBAAgB,WAAvB,OAAA,wBAAiC;;;AA/DrC,WAAA;;;;;;;;;;;;;;;;;;;;;;;;;;ACCA,MAAM,mBAAmB;IACvB,YAAY;IACZ,iBAAiB,CAAC;IAClB,SAAS;;AASX,MAAa,iBAAb,2BAAA;AAIE,6BAAY,QAAQ;AAAA,wBAAA,MAAA;AAElB,WAAK,QAAQ,OAAO;AACpB,UAAM,MAAM,KAAK,MAAM,iBAAiB,KAAK;AAG7C,WAAK,OAA+B,UAAU,IAAI;AAGlD,WAAK,oBAAoB;AAGzB,WAAK,cAAc;;AAhBvB,mBAAA,iBAAA,CAAA;MAAA,KAAA;MAAA,OAwBE,aAAI,SAAS;AAAA,YAAA,QAAA;AACX,aAAK;AAEL,YAAM,UAAS,KAAK,YAAY,IAAI;AACpC,eAAO,WAAM;AACX;AACA,cAAI,MAAK,YAAY,sBAAsB,GAAG;AAC5C,kBAAK;;;;OA/Bb;MAAA,KAAA;MAAA,OAuCE,iBAAQ;AAAA,YAAA,SAAA;AACN,YAAI,KAAK,mBAAmB;AAC1B;;AAEF,aAAK,cAAc,IAAI;AAEvB,YAAM,KAAK,IAAI,KAAK,KAAK,iBAAiB,SAAC,WAAc;AACvD,cAAI,WAAW;AACb,mBAAK,YAAY,KAAK;;;AAG1B,aAAK,oBAAoB;AACzB,WAAG,QAAQ,KAAK,OAAO;;OAnD3B;MAAA,KAAA;MAAA,OA0DE,mBAAU;AACR,YAAI,CAAC,KAAK,mBAAmB;AAC3B;;AAEF,aAAK,kBAAkB;AACvB,aAAK,YAAY;AACjB,aAAK,oBAAoB;AACzB,aAAK,cAAc;;;AAjEvB,WAAA;;AAwEO,uCAAqC,QAAQ;AAClD,iCAA6B,QAAQ,mBAAmB;;;;ACtFnD,oBAAkB,SAAS;AAChC,QAAI;AACF,aAAO,QAAQ;aACR,GAAP;AACA,aAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACEX,MAAM,QAAO;AAGb,MAAM,gBAAgB;AAkBtB,MAAa,UAAb,2BAAA;AAKE,sBAAY,QAAQ,SAAS;AAAA,wBAAA,MAAA;AAE3B,WAAK,UAAU;AAGf,WAAK,SAAS,SAAS,SAAS,OAAO;AAGvC,WAAK,WAAW;AAGhB,WAAK,cAAc;AAGnB,WAAK,cAAc;AASnB,WAAK,SAAS;AAEd,WAAK,SAAS,kBAAkB,KAAK,gBAAgB,KAAK;;AA9B9D,mBAAA,UAAA,CAAA;MAAA,KAAA;MAAA,OAkCE,mBAAU;AACR,aAAK,SAAS;;OAnClB;MAAA,KAAA;MAAA,OA8CE,cAAK,WAAW,iBAAiB;AAAA,YAAA,QAAA;AAC/B,eAAO,KAAK,OAAO,WAAM;AACvB,iBAAO,MAAK,SAAS,KAAK,iBAAiB,KAAK,SAAC,cAAiB;AAChE,kBAAK,gBAAgB;AACrB,gBAAI,WAAW;AACb,oBAAK,YAAY,aAAa,cAAc;;AAE9C,mBAAO,aAAa;;WAErB;;OAvDP;MAAA,KAAA;MAAA,OAmEE,aAAI,SAAS;AAAA,YAAA,SAAA;AACX,eAAO,KAAK,OAAO,WAAM;AACvB,iBAAO,OAAK,SAAS,IAAI,SAAS,KAAK,SAAC,cAAiB;AACvD,mBAAK,gBAAgB;;WAEtB;;OAxEP;MAAA,KAAA;MAAA,OAiFE,iBAAQ,iBAAiB;AAAA,YAAA,SAAA;AACvB,eAAO,KAAK,OAAO,WAAA;AAAA,iBAAM,OAAK,SAAS,QAAQ;WAAkB;;OAlFrE;MAAA,KAAA;MAAA,OA0FE,eAAM;AAAA,YAAA,SAAA;AACJ,eAAO,KAAK,OAAO,WAAA;AAAA,iBAAM,OAAK,SAAS;WAAO;;OA3FlD;MAAA,KAAA;MAAA,OAqGE,gBAAO,UAAU;AAAA,YAAA,SAAA;AACf,eAAO,KAAK,OAAO,WAAM;AACvB,cAAI,OAAK,eAAe,KAAK,CAAC,UAAU;AACtC,mBAAO;;AAKT,iBAAO,OAAK,SAAS,IAAI,OAAK,aAAa,KAAK,SAAC,cAAiB;AAChE,mBAAK,gBAAgB;;WAEtB;;OAhHP;MAAA,KAAA;MAAA,OA2HE,+BAAsB,QAAQ;AAAA,YAAA,SAAA;AAC5B,kBAAU,OAAO,MAAM,KAAK;AAC5B,YAAM,eAAe,KAAK,QAAQ,IAAI,SAAS;AAC/C,eAAO,KAAK,KAAK,WAAM;AACrB,iBAAK,QAAQ,IAAI,SAAS,QAAQ,gBAAgB;WACjD,KAAK,WAAM;AACZ,iBAAK,SAAS,sBAAsB;;;OAjI1C;MAAA,KAAA;MAAA,OA0IE,uBAAc;AACZ,eAAO,KAAK,SAAS;;OA3IzB;MAAA,KAAA;MAAA,OAmJE,wBAAe,UAAU;AACvB,YAAI,SAAS,MAAM,KAAK;AACtB,qBAAW,SAAS,OAAO;;AAE7B,eAAO,KAAK,SAAS,eAAe;;OAvJxC;MAAA,KAAA;MAAA,OA8JE,yBAAgB,cAAc;AAC5B,aAAK,cAAc,aAAa;AAChC,aAAK,OAAO;;OAhKhB;MAAA,KAAA;MAAA,OAuKE,gBAAO,cAAc;AAAA,YAAA,SAAA;AACnB,YAAI,KAAK,eAAe,KAAK,YAAY,SAAS,GAAG;AACnD;;AAGF,YAAM,QAAQ;AACd,iBAAS,IAAI,KAAK,YAAY,SAAS,GAAG,IAAI,KAAK,aAAa,KAAK;AACnE,cAAI,KAAK,YAAY,IAAI;AACvB,kBAAM,KAAK,KAAK,YAAY;AAC5B,iBAAK,YAAY,KAAK;;;AAG1B,aAAK,YAAY,OAAO,KAAK,cAAc;AAE3C,YAAI,MAAM,SAAS,GAAG;AAAA,cAAA,QAAA,gBACX,KADW;AAIlB,mBAAK,OAAO,MAAM,WAAA;AAAA,qBAAM,MAAM,KAAG;eAAe;;AAHlD,mBAAS,KAAI,GAAG,KAAI,MAAM,QAAQ,MAAK;AAAA,kBAA9B;;;;OAtLf;MAAA,KAAA;MAAA,OAqME,gBAAO,UAAU,MAAM;AACrB,YAAM,WAAW,IAAI;AACrB,YAAO,UAA4B,SAA5B,SAAS,SAAmB,SAAnB,QAAQ,UAAW,SAAX;AAGxB,YAAM,QAAQ,IAAI,MAAM,uBAAuB,OAAO;AACtD,aAAK,OAAO,KAAK;UAAC;UAAU;UAAS;UAAQ;;AAC7C,YAAI,KAAK,OAAO,UAAU,GAAG;AAC3B,eAAK;;AAEP,eAAO;;OA/MX;MAAA,KAAA;MAAA,OAqNE,kBAAS;AAAA,YAAA,SAAA;AACP,YAAI,KAAK,OAAO,UAAU,GAAG;AAC3B;;AAGF,YAAM,OAAO,KAAK,OAAO;AACzB,YAAI;AACJ,YAAI;AACF,oBAAU,KAAK;iBACR,GAAP;AACA,oBAAU,QAAQ,OAAO;;AAG3B,gBACG,KACC,SAAC,QAAW;AACV,eAAK,QAAQ;WAEf,SAAC,QAAW;AACV,gBAAM,MAAM,OAAM,6BAA6B;AAE/C,cAAI,KAAK,OAAO;AACd,iBAAK,MAAM,WAAW;AACtB,kBAAM,MAAM,OAAM,KAAK;;AAEzB,eAAK,OAAO;WAGf,KAAK,WAAM;AACV,iBAAK,OAAO,OAAO,GAAG;AACtB,iBAAK;;;;AAnPb,WAAA;;AAuUA,MAAa,yBAAb,2BAAA;AAIE,qCAAY,KAAK;AAAA,UAAA,SAAA;AAAA,wBAAA,MAAA;AAEf,WAAK,MAAM;AAGX,WAAK,SAAS,SAAS,SAAS;AAEhC,UAAO,UAAW,KAAK,IAAhB;AAGP,WAAK,cAAc,QAAQ,SAAS;AACpC,UAAM,QAAQ,SAAS;AACvB,UAAI,SAAS,MAAM,mBAAmB,QAAW;AAC/C,aAAK,cAAc,KAAK,IAAI,MAAM,gBAAgB,KAAK;;AAIzD,WAAK,cAAc,KAAK;AAMxB,WAAK;AAGL,WAAK,kBAAkB;AAKvB,WAAK,iBAAiB,WAAW;AAGjC,WAAK,oBAAoB,KAAK,cAAc,KAAK;AAGjD,UAAI,WAAW;AACf,UAAI,QAAQ,aAAa,QAAQ,cAAc;AAE7C,aAAK,iBACH,QAAQ,qBAAqB,QAAQ,UAAU,KAAK;AAEtD,aAAK,oBACH,QAAQ,wBAAwB,QAAQ,aAAa,KAAK;AAC5D,oBAAY,oBAAC,QAAO,WAAW,SAAY;AACzC,iBAAK,oBAAoB;AACzB,iBAAK,eACH,QACA,WAGA,WAAW;;AAGf,uBAAe,uBAAC,QAAO,WAAW,SAAY;AAC5C,iBAAK,oBAAoB;AAGzB,cAAI,YAAY,QAAW;AACzB,mBAAK,kBAAkB,QAAO,WAAW;iBACpC;AACL,mBAAK,kBAAkB,QAAO;;;AAGlC,YAAI,CAAC,QAAQ,mBAAmB;AAC9B,kBAAQ,oBAAoB,KAAK;;AAEnC,YAAI,CAAC,QAAQ,sBAAsB;AACjC,kBAAQ,uBAAuB,KAAK;;aAEjC;AACL,oBAAY,oBAAC,QAAO,WAAW,SAAY;AACzC,iBAAK,oBAAoB;;AAE3B,uBAAe,uBAAC,QAAO,WAAW,SAAY;AAC5C,iBAAK,oBAAoB;;;AAK7B,WAAK,aAAa;AAGlB,WAAK,gBAAgB;AAErB,UAAI;AACF,aAAK,cACH,KAAK,cAAc,KAAK,aAA2B;eAE9C,GAAP;AACA,cAAM,MAAM,OAAM,kCAAkC,EAAE;;AAGxD,cAAQ,YAAY,KAAK,kBAAkB,KAAK;AAChD,cAAQ,eAAe,KAAK,qBAAqB,KAAK;AAEtD,WAAK,mBAAmB,SAAC,GAAM;AAC7B,YAAM,QAAuC;AAC7C,YAAM,SAAoC,MAAM;AAChD,cAAM,KACJ,OACA,qBACE,OAAK,IAAI,QAAQ,SACjB,OACA,KAAK,UAAU;AAEnB,eAAK;;AAEP,WAAK,IAAI,iBAAiB,YAAY,KAAK;;AAjH/C,mBAAA,yBAAA,CAAA;MAAA,KAAA;MAAA,OAqHE,mBAAU;AACR,YAAI,KAAK,gBAAgB;AACvB,eAAK,IAAI,QAAQ,YAAY,KAAK;;AAEpC,YAAI,KAAK,mBAAmB;AAC1B,eAAK,IAAI,QAAQ,eAAe,KAAK;;AAEvC,aAAK,IAAI,oBAAoB,YAAY,KAAK;;OA5HlD;MAAA,KAAA;MAAA,OAqIE,uBAAc,YAAY,aAAa;AACrC,YAAM,QAAQ,IAAI,cAAc,KAAK,cAAc;AACnD,cAAM,iBAAiB;AACvB,eAAO;;OAxIX;MAAA,KAAA;MAAA,OA4IE,2BAAkB,UAAU;AAC1B,aAAK,kBAAkB;;OA7I3B;MAAA,KAAA;MAAA,OAiJE,cAAK,iBAAiB;AAAA,YAAA,UAAA;AACpB,eAAO,KAAK,WAAW,WAAM;AAC3B,cAAM,WAAW,QAAK,kBACpB,QAAK,aACL,mBAAmB;AAErB,kBAAK,kBACH,UACY,QACZ,SAAS,WAAW,MAAM,SAAS,WAAW;AAEhD,iBAAO,WAAW,WAAA;AAAA,mBAChB,QAAK,kBAAkB,UAAU;cAAC,YAAY,QAAK;;;;;OA7J3D;MAAA,KAAA;MAAA,OAmKE,aAAI,YAAY;AAAA,YAAA,UAAA;AAEd,qBAAa,KAAK,IAAI,YAAY,KAAK;AACvC,eAAO,KAAK,WAAW,WAAM;AAC3B,iBAAO,QAAK,MAAM,QAAK,cAAc,aAAa;WACjD,KAAK,SAAC,eAAkB;AACzB,iBAAO,QAAK,kBAAkB,QAAK,aAAa;YAC9C,YAAY;;;;OA1KpB;MAAA,KAAA;MAAA,OAgLE,iBAAQ,iBAAsB;AAAA,YAAA,UAAA;AAAA,YAAtB,oBAAsB,QAAA;AAAtB,4BAAkB;;AACxB,eAAO,KAAK,WAAW,WAAM;AAC3B,cAAM,WAAW,QAAK,kBACpB,QAAK,aACL,mBAAmB;AAErB,cAAM,MAAO,UAAS,OAAO,IAAI,QAAQ,OAAO;AAChD,cAAM,WAAW,SAAS,WAAW,MAAM,SAAS,WAAW;AAC/D,kBAAK,qBACH,UACA,SAAS,OACT,OAAO,WAAW,MAAM,WAAW;AAErC,iBAAO,WAAW,WAAA;AAAA,mBAChB,QAAK,kBAAkB,UAAU;cAAC,YAAY,QAAK;;;;;OA9L3D;MAAA,KAAA;MAAA,OAoME,eAAM;AAAA,YAAA,UAAA;AACJ,eAAO,WAAW,WAAA;AAAA,iBAChB,QAAK,kBAAkB,QAAK,aAAa;YACvC,YAAY,QAAK;;;;OAvMzB;MAAA,KAAA;MAAA,OAgNE,gBAAO,YAAY;AAAA,YAAA,UAAA;AAEjB,qBAAa,KAAK,IAAI,YAAY,KAAK;AACvC,eAAO,KAAK,WAAW,WAAM;AAC3B,iBAAO,QAAK,MAAM,QAAK,cAAc;;;OApN3C;MAAA,KAAA;MAAA,OAyNE,2BAAkB;AAChB,YAAI,QAAQ,KAAK;AACjB,cAAM,KACJ,OACA,oBAAoB,KAAK,IAAI,QAAQ,SAAS,OAAO,KAAK,UAAU;AAEtE,YAAM,aAAa,QAAQ,MAAM,iBAAiB;AAClD,YAAI,gBAAgB,KAAK;AACzB,YAAM,eAAe,KAAK;AAC1B,aAAK,gBAAgB;AAErB,YAAI,gBAAgB,KAAK,IAAI,QAAQ,SAAS,GAAG;AAG/C,0BAAgB,KAAK,IAAI,QAAQ,SAAS;AAC1C,eAAK,oBACH,KAAK,kBAAkB,OAAO;YAAC,YAAY;;;AAI/C,YAAI,cAAc,QAAW;AAE3B,0BAAgB,gBAAgB;mBACvB,aAAa,KAAK,IAAI,QAAQ,QAAQ;AAE/C,0BAAgB;eACX;AAEL,0BAAgB,KAAK,IAAI,QAAQ,SAAS;;AAI5C,YAAI,CAAC,OAAO;AACV,kBAAQ;;AAEV,cAAM,iBAAiB;AACvB,aAAK,cAAc,OAAO,QAAW;AAGrC,YAAI,iBAAiB,KAAK,aAAa;AACrC,eAAK,oBACH,KAAK,kBAAkB,OAAO;YAAC,YAAY;;;AAM/C,YAAI,gBAAgB,KAAK,aAAa;AACpC,eAAK,cAAc;;AAGrB,YAAI,cAAc;AAChB,uBAAa;;;OA7QnB;MAAA,KAAA;MAAA,OAkRE,qBAAY;AACV,YAAI,KAAK,gBAAgB;AACvB,iBAAO,SAAS,KAAK,IAAI;;AAE3B,eAAO,KAAK;;OAtRhB;MAAA,KAAA;MAAA,OA0RE,wBAAe;AACb,kBACE,CAAC,KAAK,eACN;;OA7RN;MAAA,KAAA;MAAA,OAuSE,oBAAW,UAAU;AACnB,YAAI,CAAC,KAAK,eAAe;AACvB,iBAAO;;AAET,eAAO,KAAK,cAAc,QAAQ,KAAK,UAAU;;OA3SrD;MAAA,KAAA;MAAA,OAkTE,iBAAQ;AACN,aAAK;AACL,YAAM,WAAW,IAAI;AACrB,YAAO,SAAmB,SAAnB,QAAQ,UAAW,SAAX;AACf,YAAM,UAAU,KAAK,OAAO,eAAe,KAAK,SAAS;AACzD,aAAK,gBAAgB;UAAC;UAAS;UAAS;;AACxC,eAAO;;OAxTX;MAAA,KAAA;MAAA,OA+TE,eAAM,OAAO;AAAA,YAAA,UAAA;AACX,aAAK;AACL,YAAI,SAAS,GAAG;AACd,iBAAO,QAAQ,QAAQ,KAAK;;AAE9B,aAAK,oBAAoB,KAAK,cAAc,KAAK,cAAc;AAC/D,YAAM,UAAU,KAAK;AACrB,aAAK,IAAI,QAAQ,GAAG,CAAC;AACrB,eAAO,QAAQ,KAAK,WAAM;AACxB,iBAAO,QAAQ,QAAQ,QAAK;;;OAxUlC;MAAA,KAAA;MAAA,OAkVE,2BAAkB,OAAO,OAAO,KAAK;AACnC,aAAK;AACL,YAAI,CAAC,OAAO;AACV,kBAAQ;;AAEV,YAAI,aAAa,KAAK,cAAc;AACpC,cAAM,iBAAiB;AACvB,aAAK,WAAW,OAAO,OAAO;AAC9B,YAAI,cAAc,KAAK,IAAI,QAAQ,SAAS,GAAG;AAC7C,uBAAa,KAAK,IAAI,QAAQ,SAAS;AACvC,gBAAM,iBAAiB;AACvB,eAAK,cAAc;;AAErB,YAAM,WAAW,KAAK,kBACa,OACjC;UAAC;;AAEH,aAAK,oBAAoB;;OAnW7B;MAAA,KAAA;MAAA,OAiXE,+BAAsB,QAAQ;AAAA,YAAA,UAAA;AAC5B,kBAAU,OAAO,MAAM,KAAK;AAC5B,aAAK,WAAW,WAAM;AAMpB,kBAAK,IAAI,oBAAoB,YAAY,QAAK;AAC9C,cAAI;AAGF,oBAAK,IAAI,SAAS,QAAQ;oBAH5B;AAKE,oBAAK,IAAI,iBAAiB,YAAY,QAAK;;AAE7C,kBAAK;AACL,iBAAO;;;OAlYb;MAAA,KAAA;MAAA,OA4YE,8BAAqB,OAAO,OAAO,KAAK;AACtC,aAAK;AACL,YAAI,CAAC,OAAO;AACV,kBAAQ;;AAEV,YAAM,aAAa,KAAK,IAAI,KAAK,aAAa,KAAK,IAAI,QAAQ,SAAS;AACxE,cAAM,iBAAiB;AACvB,aAAK,cAAc,OAAO,OAAO;AACjC,YAAM,WAAW,KAAK,kBACa,OACjC;UAAC;;AAEH,aAAK,oBAAoB;;OAxZ7B;MAAA,KAAA;MAAA,OA+ZE,6BAAoB,cAAc;AAChC,aAAK;AACL,qBAAa,aAAa,KAAK,IAC7B,aAAa,YACb,KAAK,IAAI,QAAQ,SAAS;AAE5B,YAAI,KAAK,eAAe,aAAa,YAAY;AAC/C,gBAAM,KACJ,OACA,0BACE,KAAK,cACL,SACA,aAAa;AAEjB,eAAK,cAAc,aAAa;AAChC,cAAI,KAAK,iBAAiB;AACxB,iBAAK,gBAAgB;;;;OA/a7B;MAAA,KAAA;MAAA,OAqbE,uBAAc;AACZ,YAAK,OAAQ,KAAK,IAAI,SAAjB;AAEL,eAAO,KAAK,OAAO;AACnB,eAAO,QAAQ,QAAQ;;OAzb3B;MAAA,KAAA;MAAA,OA6bE,wBAAe,UAAU;AACvB,eAAO,KAAK,QAAQ;UAAC;;;OA9bzB;MAAA,KAAA;MAAA,OAscE,2BAAkB,OAAO,QAAQ;AAC/B,YAAM,aAAU,UAAA,IACT,SAAS,MAAM,QAAS,IACzB,OAAO,QAAQ;AAErB,eAAA,UAAA,IACM,SAAS,IACV,QAFL;UAGE,MAAM;;;;AA9cZ,WAAA;;AA4dA,MAAa,yBAAb,2BAAA;AAKE,qCAAY,KAAK,QAAQ;AAAA,UAAA,UAAA;AAAA,wBAAA,MAAA;AAEvB,WAAK,MAAM;AAGX,WAAK,UAAU;AAGf,WAAK,cAAc;AAGnB,WAAK,kBAAkB;AAGvB,WAAK,2BAA2B,KAAK,QAAQ,UAC3C,iBACA,SAAC,MAAD;AAAA,eAAU,QAAK,iBAAiB;;;AArBtC,mBAAA,yBAAA,CAAA;MAAA,KAAA;MAAA,OA0BE,+BAAsB,QAAQ;AAC5B,kBAAU,OAAO,MAAM,KAAK;AAC5B,aAAK,IAAI,SAAS,QAAQ;;OA5B9B;MAAA,KAAA;MAAA,OAgCE,mBAAU;AACR,aAAK;;OAjCT;MAAA,KAAA;MAAA,OAqCE,2BAAkB,UAAU;AAC1B,aAAK,kBAAkB;;OAtC3B;MAAA,KAAA;MAAA,OAmDE,yBAAgB,mBAAmB,eAAe,SAAS;AACzD,YAAI,KAAK,gBAAgB,oBAAoB;AAC3C,iBAAwC;eACnC;AACL,gBAAM,KACJ,OACA,iCACA,SACA;;AAGJ,eAAO;;OA9DX;MAAA,KAAA;MAAA,OAqEE,yBAAgB,mBAAmB;AACjC,eAAO,CAAC,CAAC,qBAAqB,kBAAkB,kBAAkB;;OAtEtE;MAAA,KAAA;MAAA,OAiFE,cAAK,iBAAiB;AAAA,YAAA,UAAA;AACpB,YAAM,UAAO,UAAA;UACX,cAAc,KAAK,cAAc;WAC7B,mBAAmB;AAEzB,YAAM,QAAO;AACb,eAAO,KAAK,QACT,yBAAyB,OAAM,SAC/B,KAAK,SAAC,UAAa;AAClB,cAAM,gBAAiD;AACvD,cAAM,WAAW,QAAK,gBAAgB,UAAU,eAAe;AAC/D,kBAAK,oBAAoB;AACzB,iBAAO;;;OA7Ff;MAAA,KAAA;MAAA,OAyGE,aAAI,YAAY;AAAA,YAAA,UAAA;AACd,YAAI,aAAa,KAAK,aAAa;AACjC,iBAAO,KAAK;;AAEd,YAAM,UAAU,KAAK;UAAC,cAAc,KAAK;;AACzC,YAAM,OAAM;AACZ,eAAO,KAAK,QACT,yBAAyB,MAAK,SAC9B,KAAK,SAAC,UAAa;AAClB,cAAM,gBACJ,KAAK;YACH,cAAc,QAAK,cAAc;;AAGrC,cAAM,WAAW,QAAK,gBAAgB,UAAU,eAAe;AAC/D,kBAAK,oBAAoB;AACzB,iBAAO;;;OAzHf;MAAA,KAAA;MAAA,OAqIE,iBAAQ,iBAAiB;AAAA,YAAA,UAAA;AACvB,YAAI,mBAAmB,gBAAgB,KAAK;AAC1C,cAAI,CAAC,KAAK,QAAQ,cAAc,uBAAuB;AAGrD,gBAAM,WACJ,KAAK;cACH,cAAc,KAAK;;AAGvB,mBAAO,QAAQ,QAAQ;;AAIzB,cAAM,MAAM,gBAAgB,IAAI,QAAQ,OAAO;AAC/C,0BAAgB,MAAM;;AAGxB,YAAM,UAAO,UAAA;UACX,cAAc,KAAK;WACf,mBAAmB;AAEzB,YAAM,WAAU;AAChB,eAAO,KAAK,QACT,yBAAyB,UAAS,SAA4B,MAC9D,KAAK,SAAC,UAAa;AAClB,cAAM,gBAAiD;AACvD,cAAM,WAAW,QAAK,gBAAgB,UAAU,eAAe;AAC/D,kBAAK,oBAAoB;AACzB,iBAAO;;;OAlKf;MAAA,KAAA;MAAA,OA0KE,eAAM;AAEJ,eAAO,QAAQ,QACoB;UAC/B,MAAM;UACN,UAAU;UACV,YAAY,KAAK;UACjB,OAAO;;;OAjLf;MAAA,KAAA;MAAA,OA+LE,0BAAiB,MAAM;AACrB,YAAI,KAAK,qBAAqB,QAAW;AACvC,eAAK,gBAAgB,KAAK;;AAE5B,YAAI,KAAK,gBAAgB,OAAO;AAC9B,eAAK,oBAAqD;eACrD;AACL,gBAAM,KAAK,OAAM,4CAA4C;;;OAtMnE;MAAA,KAAA;MAAA,OA8ME,6BAAoB,OAAO;AACzB,YAAO,aAAc,MAAd;AACP,YAAI,KAAK,eAAe,YAAY;AAClC,gBAAM,KAAK,OAAX,iBAAgC,KAAK,cAArC,SAAuD;AACvD,eAAK,cAAc;AACnB,cAAI,KAAK,iBAAiB;AACxB,iBAAK,gBAAgB;;;;OApN7B;MAAA,KAAA;MAAA,OAiOE,uBAAc;AACZ,YAAI,CAAC,KAAK,QAAQ,cAAc,aAAa;AAC3C,iBAAO,QAAQ,QAAQ;;AAEzB,eAAO,KAAK,QACT,yBACC,eACA,QACmB,MAEpB,KAAK,SAAC,MAAS;AACd,cAAI,CAAC,MAAM;AACT,mBAAO;;AAET,cAAI,OAAO,MAAM,aAAa;AAE9B,cAAI,KAAK,MAAM,KAAK;AAClB,mBAAO,KAAK,OAAO;;AAErB,iBAAO;;;OApPf;MAAA,KAAA;MAAA,OAgQE,wBAAe,UAAU;AACvB,YAAI,CAAC,KAAK,QAAQ,cAAc,aAAa;AAC3C,iBAAO;;AAET,eACE,KAAK,QAAQ,yBACX,kBACA,KAAK;UAAC,YAAY;YACC;;;AAxQ3B,WAAA;;AAmRA,yBAAuB,QAAQ;AAC7B,QAAM,SAAS,SAAS,aAAa;AACrC,QAAI;AACJ,QACE,OAAO,uBACP,QAAQ,OAAO,KAAK,QACpB,OAAO,IAAI,mBACX;AACA,gBAAU,IAAI,uBAAuB,OAAO,KAAK;WAC5C;AAGL,6BACE,OAAO,KACP,0BACA;AAEF,gBAAU,WAAW,OAAO,KAAK;;AAEnC,WAAO,IAAI,QAAQ,QAAQ;;AAMtB,uCAAqC,QAAQ;AAClD,iCAA6B,QAAQ,WAAW;;;;AC7mC3C,MAAM,aAAa;IAIxB,WAAW;IAKX,UAAU;IAKV,UAAU;IAKV,SAAS;IAKT,UAAU;IAKV,OAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/BT,MAAa,cAAb,yBAAA,cAAA;AAAA,eAAA,cAAA;AAAA,QAAA,SAAA,cAAA;AAAA,4BAAA;AAAA,wBAAA,MAAA;AAAA,aAAA,OAAA,MAAA,MAAA;;AAAA,WAAA;IAAiC;;;;;;;;;;;;;;;;;;;;;;;;;ACAjC,MAAM,aAAa;AAEnB,MAAa,kBAAb,2BAAA;AAKE,8BAAY,KAAK,UAAU;AAAA,wBAAA,MAAA;AAEzB,WAAK,OAAO;AAGZ,WAAK,YAAY;AAGjB,WAAK,WAAW;AAGhB,WAAK,eAAe;;AAhBxB,mBAAA,kBAAA,CAAA;MAAA,KAAA;MAAA,OAuBE,iBAAQ;AACN,aAAK,eAAe,KAAK;AACzB,aAAK,WAAW;;OAzBpB;MAAA,KAAA;MAAA,OAgCE,2BAAkB,aAAa;AAG7B,eACE,KAAK,SAAS,aAAa,0BAA0B,gBACrD;;OArCN;MAAA,KAAA;MAAA,OA6CE,0BAAiB,YAAY;AAC3B,eAAO,KAAK,SAAS,YAAY,yBAAyB;;OA9C9D;MAAA,KAAA;MAAA,OAqDE,oBAAW;AACT,iBAAW,KAAK,KAAK,cAAc;AACjC,cAAI,CAAE,MAAK,KAAK,WAAW;AACzB,2BAAe,KAAK,aAAa,IAAI,KAAK,WAAW;;;AAGzD,aAAK,eAAe;;OA3DxB;MAAA,KAAA;MAAA,OAiEE,mBAAU;AACR,iBAAW,KAAK,KAAK,UAAU;AAC7B,yBAAe,KAAK,SAAS,IAAI,KAAK,WAAW;;AAEnD,aAAK,WAAW;;OArEpB;MAAA,KAAA;MAAA,OA8EE,kBAAS,YAAY,QAAQ,gBAAgB;AAC3C,YAAI,CAAC,WAAW,QAAQ;AACtB,iBAAO;;AAET,YAAI,OAAO,KAAK,SAAS,eAAe,KAAK,aAAa;AAC1D,YAAI,CAAC,MAAM;AACT,iBAAO,OAAO,KAAK,MAAM;AACzB,yBAAe,MAAM,KAAK,WAAW;;AAEvC,aAAK,SAAS,cAAc;AAC5B,eAAO,0BAA0B;;;AAxFrC,WAAA;;AAiGA,oCAAkC,KAAK,aAAa;AAClD,QAAM,SAAQ,IAAI,WAAW;AAC7B,WAAO,CACL;MAAC,OAAA;MAAO,OAAO;OACf;MAAC,OAAO;MAAM,OAAO;;;AASzB,mCAAiC,KAAK,YAAY;AAChD,WACE,WACG,MAAM,KACN,IAAI,SAAC,MAAS;AACb,aAAO,KAAK,QAAQ,QAAQ,KAAK;AACjC,UAAI,KAAK,UAAU,GAAG;AACpB;;AAGF,UAAI;AACJ,UAAI;AAGJ,UAAM,WAAW,KAAK,OAAO,KAAK,SAAS;AAC3C,UAAI;AACJ,UAAI,YAAY,KAAK;AAInB,YAAI,SAAS;AACb,cAAM,KAAK,SAAS;AACpB,eAAO,OAAO,GAAG,OAAO;AACtB,cAAM,IAAI,KAAK,OAAO;AACtB,cAAI,KAAK,KAAK;AACZ;qBACS,KAAK,KAAK;AACnB;;AAEF,cAAI,UAAU,GAAG;AACf;;;AAKJ,YAAM,UAAU,MAAM;AACtB,YAAI,MAAM,GAAG;AACX;AACA,iBAAO,OAAO,GAAG,OAAO;AACtB,gBAAM,KAAI,KAAK,OAAO;AACtB,gBACE,CACE,OAAK,OACL,MAAK,OACL,MAAK,OACJ,MAAK,OAAO,MAAK,OACjB,MAAK,OAAO,MAAK,OACjB,MAAK,OAAO,MAAK,MAEpB;AACA;;;;AAIN,YAAI,OAAO,SAAS;AAElB,iBAAO;;aAEJ;AAIL,cAAM,KAAK,SAAS;AACpB,eAAO,OAAO,GAAG,OAAO;AACtB,cAAM,MAAI,KAAK,OAAO;AACtB,cACE,CACE,QAAK,OACL,OAAK,OACJ,OAAK,OAAO,OAAK,OACjB,OAAK,OAAO,OAAK,OACjB,OAAK,OAAO,OAAK,MAEpB;AACA;;;;AAIN,UAAI,OAAO,GAAG;AACZ,sBAAc,KAAK,UAAU,GAAG,MAAM,GAAG;AACzC,gBAAQ,KAAK,UAAU,MAAM,GAAG;aAC3B;AACL,gBAAQ;AACR,sBAAc;;AAGhB,UAAI,CAAC,OAAO;AACV,eAAO;;AAGT,UAAM,SAAQ,cAAc,IAAI,WAAW,eAAe;AAC1D,aAAO;QAAC,OAAA;QAAO;;OAIhB,OAAO;;AAQd,qCAAmC,MAAM;AACvC,aAAS,IAAI,GAAG,IAAI,KAAK,QAAQ,KAAK;AACpC,UAAA,UAAuB,KAAK,IAArB,SAAP,QAAO,OAAO,QAAd,QAAc;AACd,UAAI,CAAC,UAAS,OAAM,SAAS;AAC3B,eAAO;;;AAGX,WAAO;;AAQT,0BAAwB,MAAM,UAAU,IAAI;AAC1C,aAAS,IAAI,GAAG,IAAI,KAAK,QAAQ,KAAK;AACpC,UAAO,SAAS,KAAK,GAAd;AACP,UAAI,QAAO;AAGT,YAAI,OAAM,aAAa,QAAW;AAChC,iBAAM,WAAW,KAAK,WAAW;eAC5B;AACL,cAAI,IAAI;AACN,mBAAM,YAAY;iBACb;AACL,mBAAM,eAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClO/B,MAAM,OAAM;AACZ,MAAM,iBAAiB;AACvB,MAAM,cAAc;AAOb,MAAM,gBAAgB;IAK3B,WAAW;IAMX,cAAc;IAKd,kBAAkB;IAKlB,kBAAkB;IAKlB,iBAAiB;IAKjB,eAAe;;AAajB,MAAa,WAAb,2BAAA;AAmDE,uBAAY,IAAI,SAAS,WAAW;AAAA,wBAAA,MAAA;AAClC,cAAQ,kBAAkB;AAG1B,WAAK,MAAM;AAGX,WAAK,UAAU;AAGf,WAAK,UAAU,QAAQ,QAAQ,gBAAgB,MAAM;AAGrD,WAAK,UAAU,MAAM,QAAQ,cAAc;AAG3C,WAAK,aAAa;AAGlB,WAAK,iBAAiB,QAAQ,aAAa;AAG3C,WAAK,cAAc;AAGnB,WAAK,SAAS;AAGd,WAAK,SAAS,QAAQ,YAClB,cAAc,eACd,cAAc;AAKlB,UAAI,KAAK,UAAU,cAAc,aAAa,QAAQ,cAAc;AAClE,aAAK;;AAIP,WAAK,oBAAoB;AAGzB,WAAK,eAAe;AAOpB,WAAK,mBAAmB;AAGxB,WAAK,mBAAmB;AAGxB,WAAK,WAAW;AAGhB,WAAK,aAAa,eAAe,MAAQ,MAAQ,GAAG;AAGpD,WAAK,oBAAoB;AAGzB,WAAK,sBAAsB;AAO3B,WAAK,yBAAyB;AAG9B,WAAK,iBAAiB;AAMtB,WAAK,qBAAqB;AAE1B,UAAM,WAAW,IAAI;AAGrB,WAAK,eAAe,SAAS;AAG7B,WAAK,sBAAsB,SAAS;AAIpC,WAAK,gBAAgB;;AAhJzB,mBAAA,WAAA,CAAA;MAAA,KAAA;MAAA,OAuJE,iBAAQ;AACN,eAAO,KAAK;;OAxJhB;MAAA,KAAA;MAAA,OA+JE,qBAAY,OAAO;AACjB,aAAK,SAAS;;OAhKlB;MAAA,KAAA;MAAA,OAuKE,oBAAW;AACT,YAAI,KAAK,WAAW,QAAW;AAC7B,mBAAS,IAAI,KAAK,SAAS,GAAG,IAAI,EAAE,eAAe;AACjD,gBAAI,EAAE,cAAc;AAClB,mBAAK,SAAS,EAAE;AAChB;;;AAGJ,cAAI,KAAK,WAAW,QAAW;AAC7B,iBAAK,SAAS;;;AAGlB,eAAO,KAAK;;OAnLhB;MAAA,KAAA;MAAA,OA0LE,oBAAW;AACT,eAAO,CAAC,CAAC,KAAK;;OA3LlB;MAAA,KAAA;MAAA,OAkME,6BAAoB;AAClB,YAAI,KAAK,qBAAqB,IAAI;AAChC,iBAAO,KAAK;;AAEd,eAAO,KAAK,QAAQ;;OAtMxB;MAAA,KAAA;MAAA,OA6ME,8BAAqB,aAAa;AAChC,aAAK,oBAAoB;;OA9M7B;MAAA,KAAA;MAAA,OAqNE,qBAAW;AACT,eAAO,KAAK;;OAtNhB;MAAA,KAAA;MAAA,OA6NE,mBAAU;AACR,eAAO,KAAK,QAAQ;;OA9NxB;MAAA,KAAA;MAAA,OAqOE,sBAAa;AACX,eAAO,KAAK;;OAtOhB;MAAA,KAAA;MAAA,OA6OE,qBAAY;AAEV,eAAO,KAAK,QAAQ,UAAU,WAAW;;OA/O7C;MAAA,KAAA;MAAA,OAuPE,iBAAQ;AAAA,YAAA,QAAA;AACN,YAAI,KAAK,eAAe,CAAC,KAAK,QAAQ,cAAc;AAClD,iBAAO;;AAET,aAAK,cAAc;AACnB,eAAO,KAAK,QAAQ,gBAAgB,KAClC,WAAM;AACJ,gBAAK,cAAc;AACnB,gBAAK,SAAS,cAAc;AAE5B,gBAAK,QAAQ,UAAU,OAAO;WAEhC,SAAC,QAAW;AACV,gBAAK,+BAA+B;AACpC,gBAAK,cAAc;AACnB,gBAAK,QAAQ,UAAU,aAAa,aAAa;AACjD,gBAAM;;;OAvQd;MAAA,KAAA;MAAA,OAgRE,wCAA+B,QAAQ;AACrC,YAAI,CAAC,mBAAmB,SAAS;AAC/B,gBAAM,MAAM,MAAK,oBAAoB,KAAK,SAAS;;;OAlRzD;MAAA,KAAA;MAAA,OA6RE,oBAAW,WAAW,UAAU,gBAAgB;AAC9C,aAAK,QAAe,UAAU,WAAW,UAAU;AAGnD,aAAK;;OAjST;MAAA,KAAA;MAAA,OA2SE,0BACE,WACA,iBACA,gBACA,kBACA;AACA,YAAI,WAAW;AACb,eAAK,qBAAqB;YACxB,QAAQ;YACR,OAAO;YACP,SAAS;;;AAGb,aAAK,QAAQ,iBACX,WACA,iBACA,gBACA;;OA5TN;MAAA,KAAA;MAAA,OAiUE,kCAAyB;AACvB,aAAK,qBAAqB;;OAlU9B;MAAA,KAAA;MAAA,OAwUE,gCAAuB;AACrB,eAAO,KAAK;;OAzUhB;MAAA,KAAA;MAAA,OAiVE,6BAAoB;AAClB,eAAO,KAAK,QAAQ;;OAlVxB;MAAA,KAAA;MAAA,OAyVE,mBAAU;AAOR,YACE,KAAK,kBACL,KAAK,QAAQ,iBAGb,KAAK,QAAQ,cAAc,QAAQ,WAAW,WAC9C,CAAE,mBAAkB,KAAK,QAAQ,gBACjC;AACA;;AAEF,YACE,CAAC,KAAK,QAAQ,iBACd,CAAC,KAAK,QAAQ,cAAc,aAC5B;AAIA,eAAK,SAAS,cAAc;AAC5B;;AAGF,aAAK,sBAAsB;AAE3B,YAAM,SAAS,KAAK;AACpB,aAAK;AACL,YAAM,SAAS,KAAK;AAGpB,YAAM,cAAc,CAAC,qBAAqB,QAAQ;AAClD,YACE,KAAK,UAAU,cAAc,gBAC7B,OAAO,OAAO,OAAO,OACrB,aACA;AACA,cAAI,KAAK,QAAQ,cAAc;AAC7B,gBAAI,KAAK,UAAU,cAAc,cAAc;AAE7C,mBAAK,SAAS,cAAc;uBAE3B,MAAK,UAAU,cAAc,mBAC5B,KAAK,UAAU,cAAc,kBAC/B,KAAK,QAAQ,oBACb;AAGA,mBAAK,SAAS,cAAc;;;;AAKlC,YAAI,CAAC,KAAK,mBAAmB;AAC3B,eAAK,oBAAoB;;AAG3B,aAAK,QAAQ,gBAAgB,QAAQ;;OAtZzC;MAAA,KAAA;MAAA,OA6ZE,0BAAiB;AAAA,YAAA,SAAA;AACf,YAAI,KAAK,mBAAmB;AAC1B,iBAAO;;AAET,eAAO,SAAS,SAAS,KAAK,SAAS,QAAQ,WAAA;AAAA,iBAAM,OAAK;;;OAja9D;MAAA,KAAA;MAAA,OAwaE,gCAAuB;AACrB,YAAM,WAAW,SAAS,eAAe,KAAK;AAC9C,aAAK,aAAa,SAAS,cAAc,KAAK;AAG9C,YAAI,UAAU;AACd,YAAI,SAAS,2BAA2B,KAAK,eAAe;AAC1D,cAAA,wBAAc,KAAK,WAAW,aAAvB,MAAP,sBAAO;AACP,cAAO,OAAQ,IAAI,SAAZ;AACP,mBAAS,IAAI,KAAK,SAAS,KAAK,KAAK,MAAM,IAAI,EAAS,cAAc;AACpE,gBAAI,EAAE,iBAAiB,EAAE,iBAAiB;AACxC,wBAAU;AACV;;AAEF,gBACE,SAAS,gBAAgB,MACzB,cAAc,KAAK,GAAG,YAAY,SAClC;AACA,wBAAU;AACV;;;;AAIN,aAAK,WAAW;AAEhB,YAAI,SAAS;AAIX,eAAK,aAAa,eAChB,KAAK,YACL,CAAC,SAAS,iBACV,CAAC,SAAS;;;OAxclB;MAAA,KAAA;MAAA,OAidE,4BAAmB;AACjB,eAAO,KAAK,SAAS;AACrB,aAAK,aAAa,eAChB,KAAK,WAAW,MAChB,KAAK,WAAW,KAChB,GACA;AAEF,aAAK,WAAW;AAChB,aAAK,QAAQ,gBAAgB,KAAK;AAClC,YAAM,QAAQ,KAAK;AACnB,YAAI,OAAO;AACT,gBAAM,kBAAkB,KAAK;;;OA7dnC;MAAA,KAAA;MAAA,OAqeE,0BAAiB;AACf,eAAO,KAAK,SAAS;AACrB,aAAK;;OAveT;MAAA,KAAA;MAAA,OA6eE,8BAAqB;AACnB,eAAO,KAAK;;OA9ehB;MAAA,KAAA;MAAA,OAqfE,2BAAkB;AAChB,eAAO,CAAC,CAAC,KAAK;;OAtflB;MAAA,KAAA;MAAA,OA4fE,0BAAiB;AACf,aAAK,sBAAsB;;OA7f/B;MAAA,KAAA;MAAA,OAogBE,yBAAgB;AACd,eAAO,mBAAmB,KAAK;;OArgBnC;MAAA,KAAA;MAAA,OAkhBE,wBAAe;AACb,YAAI,CAAC,KAAK,UAAU;AAClB,iBAAO,KAAK;;AAEd,YAAM,WAAW,SAAS,eAAe,KAAK;AAC9C,eAAO,eACL,KAAK,YACL,SAAS,iBACT,SAAS;;OA1hBf;MAAA,KAAA;MAAA,OAkiBE,+BAAsB;AAGpB,eAAO,KAAK,qBAAqB,KAAK;;OAriB1C;MAAA,KAAA;MAAA,OA6iBE,uBAAc;AACZ,YAAM,cACJ,KAAK,QAAQ,iBAAiB,KAAK,QAAQ,cAAc;AAC3D,YAAI,CAAC,aAAa;AAChB,iBAAO;;AAET,YAAM,UAAU,KAAK,QAAQ,eAAe,OAAO;AACnD,YAAM,MAAM,KAAK;AACjB,YAAM,iBAAiB,IAAI,SAAS,KAAK,IAAI,QAAQ;AACrD,eAAO,WAAW;;OAtjBtB;MAAA,KAAA;MAAA,OA6jBE,mBAAU;AACR,eAAO,KAAK;;OA9jBhB;MAAA,KAAA;MAAA,OAskBE,kBAAS,MAAM;AACb,eAAO,aAAa,KAAK,gBAAgB;;OAvkB7C;MAAA,KAAA;MAAA,OA8kBE,4BAAmB;AACjB,eAAO,KAAK,QAAQ;;OA/kBxB;MAAA,KAAA;MAAA,OAslBE,iCAAwB;AACtB,eAAO,KAAK,QAAQ;;OAvlBxB;MAAA,KAAA;MAAA,OA+lBE,4BAAmB,UAAU;AAG3B,kBAAU,aAAa;AAEvB,YAAI,CAAC,KAAK,qBAAqB,aAAa,MAAM;AAChD,iBAAO;;AAGT,YAAM,cAAc,MAAM,aAAa;AACvC,YAAM,MAAM,OAAO;AACnB,YAAI,KAAK,0BAA0B,KAAK,uBAAuB,MAAM;AACnE,iBAAO,KAAK,uBAAuB,KAAK;;AAG1C,YAAI,KAAK,sBAAsB,cAAc;AAC3C,iBAAO;;AAGT,aAAK,yBAAyB,KAAK,0BAA0B;AAC7D,aAAK,uBAAuB,OAAO,IAAI;AACvC,eAAO,KAAK,uBAAuB,KAAK;;OApnB5C;MAAA,KAAA;MAAA,OAwnBE,gDAAuC;AACrC,YAAI,CAAC,KAAK,wBAAwB;AAChC;;AAEF,YAAM,gBAAgB,KAAK;AAC3B,iBAAW,OAAO,KAAK,wBAAwB;AAC7C,cAAI,KAAK,sBAAsB,WAAW,MAAM,gBAAgB;AAC9D,iBAAK,uBAAuB,KAAK;AACjC,mBAAO,KAAK,uBAAuB;;;;OAhoB3C;MAAA,KAAA;MAAA,OAsoBE,oCAA2B;AAGzB,YAAM,WAAW,SAAS,eAAe,KAAK;AAC9C,YAAM,cAAc,SAAS;AAC7B,YAAM,YAAY,KAAK;AACvB,YAAM,kBAAkB,KAAK,WAAW;AACxC,YAAI,gBAAgB;AACpB,YAAI,WAAW;AAEf,YACE,YAAY,QAAQ,UAAU,QAC9B,YAAY,OAAO,UAAU,OAC7B;AAGA,iBAAO;YAAC,UAAU;;;AAGpB,YAAI,YAAY,SAAS,UAAU,KAAK;AAEtC,qBAAW,UAAU,MAAM,YAAY;AAGvC,cAAI,mBAAmB,IAAI;AACzB,4BAAgB;;mBAET,YAAY,MAAM,UAAU,QAAQ;AAE7C,qBAAW,YAAY,MAAM,UAAU;AAGvC,cAAI,mBAAmB,GAAG;AACxB,4BAAgB;;eAEb;AAEL,iBAAO;YAAC,UAAU;;;AAEpB,eAAO;UAAC;UAAU;UAAe,gBAAgB,YAAY;;;OA7qBjE;MAAA,KAAA;MAAA,OAsrBE,+BAAsB,YAAY,mBAAmB;AACnD,YAAI,OAAO,eAAe,WAAW;AACnC,iBAAO;;AAET,YAAA,OACE,qBAAqB,KAAK,4BADrB,WAAP,KAAO,UAAU,gBAAjB,KAAiB,eAAe,iBAAhC,KAAgC;AAEhC,YAAI,OAAO,YAAY,WAAW;AAChC,iBAAO;;AAET,eAAO,WAAY,iBAAiB,aAAc;;OA/rBtD;MAAA,KAAA;MAAA,OAssBE,iCAAwB;AAOtB,aAAK;AACL,eACE,KAAK,cACL,KAAK,sBAAsB,KAAK,QAAQ;;OAhtB9C;MAAA,KAAA;MAAA,OAytBE,qCAA4B;AAC1B,eAAO,KAAK,sBAAsB,KAAK,QAAQ;;OA1tBnD;MAAA,KAAA;MAAA,OAiuBE,yBAAgB,cAAc;AAC5B,aAAK,SAAS,cAAc;AAC5B,aAAK,QAAQ,qBAAqB;;OAnuBtC;MAAA,KAAA;MAAA,OAyuBE,0BAAiB;AACf,aAAK,SAAS,KAAK,oBACf,cAAc,mBACd,cAAc;;OA5uBtB;MAAA,KAAA;MAAA,OAqvBE,uBAAc;AAAA,YAAA,SAAA;AACZ,YAAI,KAAK,gBAAgB;AACvB,iBAAO,KAAK;;AAEd,YAAI,KAAK,UAAU,cAAc,iBAAiB;AAChD,iBAAO;;AAET,YAAI,KAAK,UAAU,cAAc,eAAe;AAC9C,iBAAO,QAAQ,OAAO,KAAK;;AAG7B,kBACE,KAAK,UAAU,cAAc,WAC7B,sCACA,KAAK,SACL,KAAK;AAEP,kBAAU,KAAK,eAAe,gCAAgC,KAAK;AAEnE,YAAI,KAAK,UAAU,cAAc,kBAAkB;AACjD,cAAM,MAAM,MAAM,YAChB,+CACA,eACA,KAAK;AAEP,sBAAY,KAAK,KAAK;AACtB,iBAAO,QAAQ,OAAO;;AAIxB,YAAI,KAAK,eAAe,KAAK,CAAC,KAAK,QAAQ,oBAAoB;AAC7D,gBAAM,KACJ,MACA,8CACA,KAAK,SACL,KAAK;AAEP,eAAK,SAAS,cAAc;AAC5B,iBAAO;;AAGT,cAAM,KAAK,MAAK,iBAAiB,KAAK,SAAS,UAAU,KAAK;AAC9D,aAAK;AACL,aAAK,SAAS,cAAc;AAC5B,aAAK,mBAAmB,IAAI;AAC5B,YAAO,SAAU,KAAK,iBAAf;AAEP,YAAM,UAAU,IAAI,QAAQ,SAAC,SAAS,QAAW;AAC/C,mBAAS,SAAS,OAAK,SAAS,OAAO,WAAM;AAC3C,gBAAI;AACJ,gBAAI;AACF,+BAAiB,OAAK,QAAQ,eAAe;qBACtC,GAAP;AACA,qBAAO;;AAET,oBAAQ,QAAQ,gBAAgB,KAAK,SAAS;;AAEhD,iBAAO,UAAU,WAAA;AAAA,mBAAM,OAAO;;WAC7B,KACD,WAAA;AAAA,iBAAM,OAAK,gBAAgB,MAAM;WACjC,SAAC,QAAD;AAAA,iBAAY,OAAK,gBAAgB,OAAO,QAAQ;;AAGlD,eAAQ,KAAK,iBAAiB;;OApzBlC;MAAA,KAAA;MAAA,OA6zBE,yBAAgB,SAAS,QAAQ,YAAY;AAC3C,aAAK,mBAAmB;AACxB,YAAI,OAAO,SAAS;AAIlB,cAAM,MAAM,MAAM,YAAY;AAC9B,cAAI,oBAAoB,KAAK;AAC7B,gBAAM,cAAc,MAAK;AACzB,gBAAM;;AAER,YAAI,KAAK,qBAAqB;AAC5B,eAAK;AACL,eAAK,sBAAsB;;AAE7B,aAAK,iBAAiB;AACtB,aAAK,SAAS,UACV,cAAc,kBACd,cAAc;AAClB,aAAK,mBAAmB;AACxB,YAAI,SAAS;AACX,gBAAM,KAAK,MAAK,oBAAoB,KAAK;eACpC;AACL,gBAAM,KAAK,MAAK,mBAAmB,KAAK,SAAS;AACjD,iBAAO,QAAQ,OAAO;;;OAr1B5B;MAAA,KAAA;MAAA,OA61BE,2BAAkB;AAChB,eACE,KAAK,UAAU,cAAc,mBAC7B,KAAK,UAAU,cAAc;;OAh2BnC;MAAA,KAAA;MAAA,OA22BE,sBAAa;AACX,YAAI,KAAK,QAAQ,MAAM;AACrB,iBAAO,KAAK,QAAQ;;AAEtB,eAAO,KAAK;;OA/2BhB;MAAA,KAAA;MAAA,OAs3BE,wBAAe;AACb,YAAI,KAAK,eAAe;AACtB,eAAK;;AAEP,eAAO,KAAK;;OA13BhB;MAAA,KAAA;MAAA,OAi4BE,uBAAc,YAAY;AACxB,aAAK,gBAAgB;;OAl4BzB;MAAA,KAAA;MAAA,OAy4BE,oBAAW;AACT,YACE,KAAK,UAAU,cAAc,aAC7B,KAAK,UAAU,cAAc,gBAC7B,KAAK,UAAU,cAAc,kBAC7B;AACA;;AAEF,YAAI,KAAK,kBAAkB;AACzB,eAAK,iBAAiB;AACtB,eAAK,mBAAmB;;AAE1B,aAAK,cAAc;AACnB,YAAI,KAAK,QAAQ,oBAAoB;AACnC,eAAK,QAAQ,kBAAkB;AAC/B,eAAK,SAAS,cAAc;AAC5B,eAAK,eAAe;AACpB,eAAK,iBAAiB;;;OA15B5B;MAAA,KAAA;MAAA,OAm6BE,mBAAU,SAAS;AACjB,eAAO,KAAK,UAAU,MAAM;;OAp6BhC;MAAA,KAAA;MAAA,OA06BE,iBAAQ;AACN,aAAK,QAAQ;;OA36BjB;MAAA,KAAA;MAAA,OAi7BE,yBAAgB;AACd,aAAK,QAAQ;;OAl7BjB;MAAA,KAAA;MAAA,OAw7BE,kBAAS;AACP,aAAK,QAAQ;;OAz7BjB;MAAA,KAAA;MAAA,OA+7BE,kBAAS;AACP,aAAK,QAAQ;;OAh8BjB;MAAA,KAAA;MAAA,OAu8BE,sBAAa;AACX,eAAO,KAAK,QAAQ;AACpB,aAAK,QAAQ,WAAyC;;QAz8B1D,CAAA;MAAA,KAAA;MAAA,OAKE,oBAAkB,SAAS;AACzB,eACE,UACE,UAAS,mBAAmB,UAC5B,+BACA;;OAVR;MAAA,KAAA;MAAA,OAmBE,4BAA0B,SAAS;AACjC,eAAgC,QAAQ;;OApB5C;MAAA,KAAA;MAAA,OA6BE,kBAAgB,SAAS,OAAO;AAC9B,kBAAU,MAAM,SAAS,UAAU;AACnC,YAAI,UAAS,mBAAmB,UAAU;AACxC,oBAAS,mBAAmB,SAAS,YAAY;;AAEnD,gBAAQ,eAAe;AAGvB,YAAM,iBAAiB,QAAQ,uBAAuB;AACtD,iBAAS,IAAI,GAAG,IAAI,eAAe,QAAQ,KAAK;AAC9C,cAAM,MAAM,eAAe;AAC3B,cAAI,UAAS,mBAAmB,MAAM;AACpC,sBAAS,mBAAmB,KAAK,YAAY;;;;;AAzCrD,WAAA;;;;;;;;;;;;;;;;;;;;;;;;;;AC9DA,MAAa,UAAb,2BAAA;AAIE,wBAAc;AAAA,wBAAA,MAAA;AAMZ,WAAK,OAAO;AAWZ,WAAK,cAAc;;AArBvB,mBAAA,UAAA,CAAA;MAAA,KAAA;MAAA,OA8BE,aAAI,MAAM;AACR,YAAM,IAAI,KAAK,KAAK;AACpB,eAAO,KAAK,OAAO,OAAO;;OAhC9B;MAAA,KAAA;MAAA,OAyCE,oBAAW,MAAM;AAAA,YAAA;AACf,YAAI,gBAAa,qBAAG,KAAK,gBAAR,OAAA,SAAG,kBAAmB;AACvC,YAAI,CAAC,eAAe;AAClB,cAAM,SAAS,KAAK,KAAK;AACzB,cAAI,UAAU,MAAM;AAElB,gBAAM,UACJ,OAAO,UAAU,WACb,QAAQ,QAAQ,UAChB,QAAQ,OAAO;AACrB,4BAAgB;cAAC;;iBACZ;AAGL,4BAAgB,IAAI;;AAEtB,cAAI,CAAC,KAAK,aAAa;AACrB,iBAAK,cAAc;;AAErB,eAAK,YAAY,QAAQ;;AAE3B,eAAO,cAAc;;OA9DzB;MAAA,KAAA;MAAA,OAwEE,gBAAO,MAAM,UAAU;AAAA,YAAA;AACrB,YAAI,KAAK,KAAK,SAAS,MAAM;AAE3B;;AAEF,YAAM,OAAO,YAAH,OAAG,WAAY,KAAK;AAC9B,aAAK,KAAK,QAAQ;AAClB,YAAM,gBAAa,sBAAG,KAAK,gBAAR,OAAA,SAAG,mBAAmB;AACzC,YAAI,iBAAJ,QAAI,cAAe,SAAS;AAC1B,wBAAc,QAAQ;AACtB,wBAAc,UAAU;AACxB,wBAAc,SAAS;;;OAnF7B;MAAA,KAAA;MAAA,OA6FE,sBAAa,MAAM,OAAO;AAAA,YAAA;AACxB,YAAI,KAAK,KAAK,SAAS,MAAM;AAE3B;;AAEF,aAAK,KAAK,QAAQ;AAClB,YAAM,gBAAa,sBAAG,KAAK,gBAAR,OAAA,SAAG,mBAAmB;AACzC,YAAI,iBAAJ,QAAI,cAAe,QAAQ;AACzB,wBAAc,OAAO;AACrB,wBAAc,QAAQ,MAAM,WAAM;;AAClC,wBAAc,UAAU;AACxB,wBAAc,SAAS;;;OAxG7B;MAAA,KAAA;MAAA,OAgHE,eAAM,MAAM;AAAA,YAAA;AACV,YAAI,KAAK,KAAK,OAAO;AACnB,iBAAO,KAAK,KAAK;;AAGnB,YAAM,gBAAa,sBAAG,KAAK,gBAAR,OAAA,SAAG,mBAAmB;AACzC,YAAI,iBAAiB,CAAC,cAAc,SAAS;AAC3C,iBAAO,KAAK,YAAY;;;;AAvH9B,WAAA;;;;ACJA,MAAM,qBAAqB;AACpB,MAAM,YAAY;IACvB,oBAAoB;IACpB,oBAAoB;IACpB,kBAAkB;IAClB,kBAAkB;;AAIb,MAAM,cAAc;IAEzB,kBAAkB;IAClB,aAAa;IACb,oBAAoB;IACpB,eAAe;IACf,oBAAoB;IACpB,cAAc;IACd,YAAY;IACZ,oBAAoB;IACpB,mBAAmB;IACnB,YAAY;IACZ,UAAU;IACV,mBAAmB;IACnB,oBAAoB;IAGpB,oBAAoB;IACpB,6BAA6B;IAC7B,2BAA2B;IAC3B,oCAAoC;IAGpC,gBAAgB;IAChB,UAAU;IAGV,8BAA8B;IAC9B,yBAAyB;IACzB,2BAA2B;IAG3B,sBAAsB;IAGtB,mBAAmB;IACnB,cAAc;;AAWT,mBAAgB,SAAS,WAAW,UAAU,qBAAqB;AACxE,WAAO,6BACL,SACA,WACA,UACA;;AAaG,4BACL,MACA,UACA,MACA,aACA;AAAA,QAFA,SAEA,QAAA;AAFA,aAAO;;AAEP,QADA,gBACA,QAAA;AADA,oBAAa;;AAGb,QAAM,UAAU;AAChB,YAAQ,UAAU;AAClB,YAAQ,cAAc;AACtB,WAAO,qBAAsB,gBAAc,MAAM,KAAK,UAAU;;AAU3D,8BAA4B,SAAS;AAC1C,QAAI,CAAC,aAAa,UAAU;AAC1B,aAAO;;AAET,QAAM,WAAW,QAAQ,QAAQ;AACjC,cAAU,YAAY,IAAI,sBAAsB;AAChD,WAAO,aAAa,QAAQ,OAAO,WAAW,SAAC,GAAD;AAAA,aAC5C,MAAM,MAAM,aAAa,8BAA8B,SAAS;;;AAS7D,wBAAsB,SAAS;AACpC,WACE,OAAO,WAAW,YAClB,QAAQ,QAAQ,uBAAuB,KACvC,QAAQ,QAAQ,QAAQ;;;;AC0brB,4BAA0B,KAAK;AAKpC,QAAI;AAGF,aAAO,CAAC,CAAC,IAAI,SAAS,QAAS,KAAI,WAAW;aACvC,WAAP;AACA,aAAO;;;;;ACthBX,MAAM,YAAY,KAAK;AAWhB,sCAAoC,SAAS,OAAO,cAAc;AACvE,QAAM,eACJ,iBAAiB,SAAS,OAAO,iBACjC,eAAe,GAAG,GAAG,GAAG;AAC1B,QAAM,QAAQ,kBAAkB,cAAc;AAC9C,WAAO,qBAAqB,SAAS,cAAc,cAAc;;AAkE5D,6BAA2B,SAAS,QAAQ;AACjD,QAAM,iBAAiB,QAAQ,QAAQ,QAAQ;AAC/C,QAAM,gBAAgB,OAAO,QAAQ,OAAO;AAG5C,WAAO,kBAAkB,IAAI,IAAI,iBAAiB;;AAWpD,gCAA8B,SAAS,cAAc,cAAc,OAAO;AAGxE,QAAI,qBAAqB;AACzB,QAAI,aAAa;AAOjB,QAAI,cAAc;AAGhB,mBAA2D;AAC3D,qBAAe,eACb,cACA,CAAC,aAAa,MACd,CAAC,aAAa;AAIhB,2BAAqB,eACnB,oBACA,CAAC,aAAa,MACd,CAAC,aAAa;AAGhB,mBAAa,eACX,YACA,CAAC,aAAa,MACd,CAAC,aAAa;;AAIlB,WAAkD;MAChD,MACE,OAAO,gBAAgB,eAAe,YAAY,MAC9C,YAAY,QACZ,KAAK,QAAQ;MACnB;MACA;MACA,kBAAkB;MAClB,mBAAmB;;;;;AClLhB,MAAM,oBAAoB;;;;;;;;;;;;;;;;;;;;;;;;;ACMjC,MAAM,KAAK;AAEX,MAAM,cAAc;AAGpB,MAAa,YAAb,2BAAA;AAEE,wBAAY,QAAQ;AAAA,UAAA,QAAA;AAAA,wBAAA,MAAA;AAElB,WAAK,UAAU;AAEf,UAAO,MAAO,OAAP;AAGP,WAAK,YAAY,IAAI,IAAI,qBAAqB,SAAC,GAAD;AAAA,eAAO,MAAK,UAAU;SAAI;QAGtE,MAAM,UAAU,OAAyB,IAAI,WAAY;QACzD,YAAY;;AAId,WAAK,gBAAgB,IAAI;AAGzB,WAAK,WAAW,IAAI;AAGpB,WAAK,kBAAkB;AAGvB,WAAK,kBAAkB;AAEvB,aAAO,YAAY,KAAK,WAAA;AAAA,eAAM,MAAK;;AAGnC,WAAK,sBAAsB,OAAO,oBAAoB,WAAA;AAAA,eACpD,MAAK;;;AAhCX,mBAAA,YAAA,CAAA;MAAA,KAAA;MAAA,OAqCE,mBAAU;AACR,aAAK,UAAU;AACf,aAAK,SAAS;AACd,YAAI,KAAK,qBAAqB;AAC5B,eAAK;AACL,eAAK,sBAAsB;;;OA1CjC;MAAA,KAAA;MAAA,OAiDE,sBAAa,QAAQ;AACnB,aAAK,SAAS,IAAI,QAAQ;UAAC,MAAM;UAAM,gBAAgB;;AACvD,aAAK,aAAa;;OAnDtB;MAAA,KAAA;MAAA,OAyDE,kBAAS,QAAQ;AACf,YAAI,KAAK,SAAS,IAAI,SAAS;AAC7B;;AAGF,YAAI,OAAO,iBAAiB;AAC1B,eAAK,SAAS,IAAI,QAAQ;YAAC,MAAM;YAAO,gBAAgB;;AACxD,eAAK,UAAU,QAAQ;AACvB,cAAI,KAAK,cAAc,OAAO,GAAG;AAC/B,iBAAK,cAAc,QAAQ,SAAC,UAAU,WAAc;AAClD,kBAAI,gBAAgB,WAAW,SAAS;AACtC,yBAAS,QAAQ;;;;eAIlB;AACL,eAAK,SAAS,IAAI,QAAQ;YAAC,MAAM;YAAO,gBAAgB;;;AAG1D,aAAK,aAAa;;OA5EtB;MAAA,KAAA;MAAA,OAkFE,oBAAW,QAAQ;AACjB,YAAI,CAAC,KAAK,SAAS,IAAI,SAAS;AAC9B;;AAGF,aAAK,SAAS,OAAO;AAErB,aAAK,UAAU,UAAU;AACzB,YAAI,KAAK,cAAc,OAAO,GAAG;AAC/B,eAAK,cAAc,QAAQ,SAAC,UAAa;AACvC,qBAAS,UAAU;;;AAIvB,YAAI,KAAK,iBAAiB;AACxB,qBAAW,KAAK,iBAAiB;AACjC,eAAK;;;OAlGX;MAAA,KAAA;MAAA,OA6GE,sBAAa,WAAW,cAAc;AAAA,YAAA,SAAA;AACpC,YAAI,KAAK,cAAc,IAAI,YAAY;AACrC;;AAIF,YAAO,MAAO,KAAK,QAAZ;AACP,YAAM,WAAW,IAAI,IAAI,qBAAqB,SAAC,GAAD;AAAA,iBAAO,OAAK,UAAU;WAAI;UACtE,MAAM,gBAAgB;UACtB,YAAY;;AAEd,aAAK,cAAc,IAAI,WAAW;AAKlC,aAAK,SAAS,QAAQ,SAAA,MAAS,QAAW;AAAA,cAAlB,OAAkB,KAAlB;AACtB,cAAI,CAAC,QAAQ,gBAAgB,WAAW,SAAS;AAC/C,qBAAS,QAAQ;;;;OA/HzB;MAAA,KAAA;MAAA,OAyIE,yBAAgB,WAAW;AACzB,YAAM,WAAW,KAAK,cAAc,IAAI;AACxC,YAAI,CAAC,UAAU;AACb;;AAIF,iBAAS;AACT,aAAK,cAAc,OAAO;;OAjJ9B;MAAA,KAAA;MAAA,OAqJE,4BAAmB;AAAA,YAAA,SAAA;AACjB,YAAI,KAAK,QAAQ,aAAa,CAAC,KAAK,iBAAiB;AACnD,eAAK,kBAAkB;AACvB,cAAO,MAAO,KAAK,QAAZ;AACP,cAAI,WAAW,WAAM;AAGnB,mBAAK,QAAQ,UAAU,OAAO;aAC7B;;;OA7JT;MAAA,KAAA;MAAA,OAkKE,iCAAwB;AAAA,YAAA,SAAA;AACtB,YAAM,KAAK,KAAK,QAAQ;AACxB,YACE,MAAM,gBAAgB,WACtB,MAAM,gBAAgB,UACtB,MAAM,gBAAgB,WACtB;AACA,eAAK,SAAS,QAAQ,SAAC,GAAG,QAAJ;AAAA,mBAAe,OAAK,YAAY;;;;OAzK5D;MAAA,KAAA;MAAA,OAiLE,sBAAa,QAAQ;AACnB,YAAM,iBAAiB,KAAK;AAC5B,YAAI,gBAAgB;AAClB,cAAI,CAAC,eAAe,SAAS,SAAS;AACpC,2BAAe,KAAK;;AAEtB,eAAK;eACA;AACL,eAAK,YAAY;;;OAzLvB;MAAA,KAAA;MAAA,OA8LE,yBAAgB;AACd,YAAM,gBAAgB,KAAK,QAAQ;AACnC,YAAM,iBAAiB,KAAK;AAC5B,YAAI,gBAAgB;AAClB,mBAAS,IAAI,GAAG,IAAI,eAAe,QAAQ,KAAK;AAC9C,gBAAM,SAAS,eAAe;AAC9B,gBACE,iBACA,2BAA2B,QAAQ,KAAK,QAAQ,gBAChD;AACA,6BAAe,OAAO,KAAK;AAE3B,mBAAK,YAAY;;;;AAIvB,YAAI,eAAe;AACjB,eAAK,kBAAkB;AACvB,eAAK;;;OAhNX;MAAA,KAAA;MAAA,OAwNE,mBAAU,SAAS;AACjB,iBAAS,IAAI,GAAG,IAAI,QAAQ,QAAQ,KAAK;AACvC,cAAA,aAAqD,QAAQ,IAAtC,qBAAvB,WAAO,gBAAoC,SAA3C,WAA2C;AAC3C,cAAM,YAAwC;AAE9C,cAAM,UAAU,KAAK,SAAS,IAAI;AAClC,cAAI,CAAC,SAAS;AACZ;;AAGF,cAAM,iBAAiB,sBAAsB,QAAQ;AACrD,cAAI,mBAAmB,QAAQ,gBAAgB;AAC7C,iBAAK,SAAS,IAAI,WAAW;cAAC,MAAM,QAAQ;cAAM;;;AAEpD,cAAI,gBAAgB;AAClB,iBAAK,YAAY;;;;OAvOzB;MAAA,KAAA;MAAA,OAgPE,qBAAY,QAAQ;AAClB,YAAM,iBAAiB,KAAK;AAC5B,YAAM,SAAS,CAAE,mBAAkB,eAAe,SAAS;AAC3D,YAAA,QAA+B,KAAK,SAAS,IAAI,WAAW;UAC1D,MAAM;UACN,gBAAgB;WAFX,OAAP,MAAO,MAAM,iBAAb,MAAa;AAIb,YAAM,KAAK,KAAK,QAAQ;AACxB,YAAM,UACJ,UACC,SAAQ,mBACR,OAAM,gBAAgB,WAErB,MAAM,gBAAgB,UAErB,MAAM,gBAAgB,aAAa,OAAO;AAC/C,YAAI,CAAC,SAAS;AACZ;;AAGF,aAAK,WAAW;AAIhB,YAAO,MAAO,KAAK,QAAZ;AACP,YAAM,YACJ,QAAQ,OAAO,sBAAsB,eAAe,UAChD,IAAI,aACJ,IAAI,uBAAuB,IAAI;AACrC,kBAAU,WAAA;AAAA,iBAAM,OAAO;;;;AA7Q3B,WAAA;;AAqRO,8BAA4B,QAAQ;AACzC,iCAA6B,QAAQ,IAAI;AACzC,WAAkC,iBAAiB,QAAQ;;;;AC1KtD,sCAAoC,SAAS;AAClD,QAAM,SAAS,QAAQ;AACvB,QAAI,UAAU,OAAO,cAAc;AACnC,QAAI,CAAC,SAAS;AACZ,aAAO;;AAIT,cAAU,QAAQ,cAAc,QAAQ,QAAQ;AAEhD,QAAM,WAAyC,QAAQ,MAAM;AAC7D,WAAO,SAAS,SAAS,QAAQ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC1HnC,MAAM,OAAM;AAKZ,MAAI,cAAc,eAAe,KAAK,KAAK,SAAS;AACpD,MAAI,iBAAiB;AAKrB,MAAM,YAAW;AAOjB,8BAA4B,iBAAiB;AAC3C,iCAA6B,iBAAiB,SAAS;AACvD,WAAO,iBAAiB,iBAAiB;;AAgBpC,wBAAsB,KAAK,IAAI,sBAAsB;AAC1D,QAAI,aAAa;AACf,gBAAS,KAAK;AACd;;AAEF,QAAM,UAAU,mBAAmB,IAAI,mBAAmB;AAC1D,YAAQ,cAAc;AACtB,QAAI,sBAAsB;AACxB,cAAQ,cAAc,WAAM;AAC1B,gBAAQ,iBAAiB;;;;AAkDxB,sCAAoC;AACzC,qBAAiB;;AA4CnB,MAAM,YAAY;IAChB,SAAS;IACT,KAAK;;MAOD,OAAA,2BAAA;AAIJ,mBAAY,IAAI;AAAA,wBAAA,MAAA;AAEd,WAAK,QAAQ,UAAU;AAGvB,WAAK,MAAM;;;;aASb,kBAAS,cAAc;AACrB,YAAI,KAAK,SAAS,UAAU,KAAK;AAC/B;;AAEF,aAAK,QAAQ,UAAU;AACvB,YAAI;AACF,eAAK,IAAI;iBACF,GAAP;AACA,eAAK,aAAa;AAClB,gBAAM;;;;;aAQV,oBAAW;AACT,eAAO,KAAK,IAAI,eAAe,KAAK,IAAI;;;;aAQ1C,sBAAa,aAAa;;;;aAS1B,sCAA6B;AAE3B,eAAO;;;;aAST,mCAA0B;AAExB,eAAO;;;;;MAQL,cAAA,yBAAA,OAAA;;;AAMJ,0BAAY,IAAI,KAAK,QAAQ;AAAA,UAAA;AAAA,wBAAA,MAAA;AAC3B,cAAA,OAAA,KAAA,MAAM;AAGN,YAAK,UAAU;AAJY,aAAA;;;;aAQ7B,sBAAa,aAAa;AAExB,gCAAwB,KAAK;;;;aAI/B,sCAA6B;AAG3B,eAAO,KAAK;;;;aAId,mCAA0B;AAIxB,eAAO,KAAK,QAAQ;;;;aAOtB,sBAAa;AACX,eAAO,KAAK,QAAQ,OAAO;;;;IAvCL;MA8CpB,SAAA,2BAAA;AAIJ,qBAAY,QAAQ;AAAA,UAAA,SAAA;AAAA,wBAAA,MAAA;AAElB,WAAK,SAAS;AAEd,WAAK,OAAO,OAAO;AAEnB,WAAK,SAAS,IAAI;AAElB,WAAK,gBAAgB,KAAK,SAAS,KAAK;AAExC,WAAK,2BAA2B;AAEhC,WAAK,wBAAwB,CAAC,CAC5B,MAAK,KAAK,UAAU,cACpB,KAAK,KAAK,UAAU,WAAW;AAUjC,WAAK,gCAAgC;AAErC,WAAK,iBAAiB,KAAK,KAAK,SAAS,gBAAgB,aACvD;AAGF,WAAK,KAAK,iBAAiB,WAAW,SAAC,GAAM;AAC3C,YAAI,QAAQ,MAAM,kBAAkB;AAClC,iBAAK,SAA4B;;;AAKrC,WAAK,aAAa;AAClB,eAAS,oBAAoB,QAAQ,KAAK,WAAM;AAG9C,eAAK,aAAa;;AAGpB,aAAO,oBAAoB,WAAM;AAC/B,YAAI,OAAO,aAAa;AACtB,iBAAK;;;;;;aAUX,aAAI,IAAI,UAAU;AAChB,YAAM,IAAI,IAAI,KAAK;AACnB,aAAK,aAAa,GAAG;;;;aAOvB,uBAAc,IAAI;AAChB,YAAM,IAAI,IAAI,YAAY,IAAI,KAAK,MAAM;AACzC,aAAK,aAAa,GAAG,OAAO;;;;aAS9B,sBAAa,MAAM,UAAU;AAC3B,aAAK,OAAO,QAAQ,MAAM;AAC1B,aAAK;;;;aAUP,mBAAU,aAAa;AACrB,YAAI,IAAI,KAAK,OAAO;AAEpB,eAAO,KAAK,EAAE,UAAU,UAAU,SAAS;AACzC,eAAK,OAAO;AACZ,cAAI,KAAK,OAAO;;AAGlB,YAAI,KAAK,aAAa;AACpB,eAAK,OAAO;;AAEd,eAAO;;;;aAUT,kBAAS,cAAc;AAAA,YAAA,SAAA;AACrB,YAAM,IAAI,KAAK,UAA4B;AAC3C,YAAI,CAAC,GAAG;AACN,eAAK,gCAAgC;AACrC,eAAK,2BAA2B;AAChC,iBAAO;;AAET,YAAI;AACJ,YAAI;AACF,mBAAS,KAAK;AACd,YAAE,SAAS;kBAFb;AAQE,oBACG,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,KAAK,WAAM;AACV,mBAAK,gCAAgC;AACrC,mBAAK,4BAA4B,KAAK,QAAQ;AAC9C,kBAAM,KACJ,MACA,EAAE,YACF,kBACA,KAAK,QAAQ,QACb,OAAK;AAGP,mBAAK;;;AAGX,eAAO;;;;aAQT,sBAAa,cAAc;AAAA,YAAA,SAAA;AAKzB,YACE,CAAC,kBACD,KAAK,kBACJ,MAAK,wBAEA,KAAK,KAAK,UACV,WAAW,mBACb,KAAK,2BAA2B,IACpC;AACA,eAAK,2BAA2B;AAChC,eAAK;AACL;;AAEF,kBAAS,KAAK,WAAM;AAClB,iBAAK,cAAc;;;;;aAQvB,qBAAY;AACV,YAAI,KAAK,+BAA+B;AACtC;;AAEF,YAAM,WAAW,KAAK;AACtB,YAAI,CAAC,UAAU;AACb;;AAEF,YAAI,SAAS,8BAA8B;AACzC,eAAK,gCAAgC;AACrC,eAAK,aAAgC;AACrC;;AAIF,YAAI,SAAS,6BAA6B,KAAK,KAAK,qBAAqB;AACvE,iBACE,KAAK,MAOL,IACA,KACA,KAAK;AAEP;;AAEF,aAAK;;;;aASP,6BAAoB;AAElB,aAAK,KAAY,YAAY,kBAAkB;;;;;AAc5C,kBAAgB,KAAK,sBAAsB,SAAS,IAAI;AAC7D,QAAM,YAAY,KAAK;AAIvB,iBAAa,MAAM;AACjB,UAAI,KAAK,kBAAkB,sBAAsB;AAC/C,YAAM,mBAAmB,UAAW,MAAK,QAAQ;AACjD,YAAI,oBAAoB,KAAK,KAAK,YAAY;AAC5C,gBAAM,KAAK,MAAK,aAAa,SAAS,KAAK;AAC3C,aAAG;eACE;AACL,gBAAM,KACJ,MACA,qBACA,kBACA,KAAK;AAEP,cAAI,oBAAoB,KAAK;YAAC,SAAS;;;aAEpC;AACL,cAAM,KAAK,MAAK,+BAA+B;AAC/C,WAAG;;;AAGP,QAAI,oBAAoB,KAAK;MAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9fhC,MAAM,OAAM;AAKZ,MAAM,eAAe;IACnB,cAAc;IACd,UAAU;IACV,gBAAgB;IAChB,qBAAqB;;AAGvB,MAAM,aAAa;IAAC,SAAS;;AAC7B,MAAM,cAAc,wBAAA;AAAA,WAAM;;AAM1B,MAAI;AAGG,MAAM,kBAAkB;AAM/B,oCAAkC;AAChC,QAAI,yBAAyB,QAAW;AACtC,UAAM,WAAW,KAAK,SAAS,cAAc;AAC7C,6BAAuB,aAAa;;AAEtC,WAAO;;AAUF,oCAAkC,KAAK,2BAA0B;AACtE,QAAM,oBACJ,6BAA6B,KAAK;AAFkC,QAMhE,mBANgE,yBAAA,oBAAA;AAAA,iBAAA,mBAAA;AAAA,UAAA,SAAA,cAAA;AAAA,mCAAA;AAAA,0BAAA,MAAA;AAAA,eAAA,OAAA,MAAA,MAAA;;AAAA,qBAAA,mBAAA,CAAA;QAAA,KAAA;QAAA,OAWpE,2BAAkB;AAGhB,cAAI,OAAO,eAAe,UAAU,uBAAuB;AACzD,mBAAO,eAAe,MAAM;;;;AAfoC,aAAA;MAMvC;AAa/B,QAAM,wBAAwB,iBAAiB;AAC/C,WAAyC;;AAU3C,wCAAsC,KAAK,2BAA0B;AACnE,QAAI,IAAI,qBAAqB;AAC3B,aAAO,IAAI;;AAEb,QAAM,cAAiD,IAAI;AAJQ,QAS7D,oBAT6D,yBAAA,cAAA;AAAA,iBAAA,oBAAA;AAAA,UAAA,UAAA,cAAA;AAWjE,oCAAc;AAAA,YAAA;AAAA,0BAAA,MAAA;AACZ,gBAAA,QAAA,KAAA;AACA,cAAK;AAFO,eAAA;;AAXmD,qBAAA,oBAAA,CAAA;QAAA,KAAA;QAAA,OAqBjE,2BAAkB;AAIhB,eAAK,SAAS;AASd,eAAK,eAAe;AAGpB,eAAK,mBAAmB;AAOxB,eAAK,WAAW;AAGhB,eAAK,gBAAgB;AAGrB,eAAK,wBAAwB;AAG7B,eAAK,cAAc,WAAW;AAG9B,eAAK,eAAe;AAMpB,eAAK,UAAU;AAMf,eAAK,aAAa;AAGlB,eAAK,UAAU,OAAO;AAGtB,eAAK,eAAe;AAGpB,eAAK,0BAA0B;AAG/B,eAAK,wBAAwB;AAO7B,eAAK,eAAe;AAGpB,eAAK,mBAAmB;AAUxB,eAAK,qBAAqB;AAI1B,cAAM,gBAAwC;AAI9C,cAAI,OACF,IAAI,2BACJ,IAAI,wBAAwB,KAAK;AACnC,cAAI,UAAU,QAAQ,cAAc,kCAAkC;AACpE,mBAAO,cAAc;;AAIvB,eAAK,aAAa,SAAS,cAAc,OAAO,QAAQ;AAExD,cAAI,CAAC,KAAK,YAAY;AACpB,4BAAgB,KAAK;;AAIvB,eAAK,QAAQ;AAQb,eAAK,gBAAgB,aAAa;AAOlC,eAAK,kBAAkB;AAUvB,eAAK,eAAe;AAMpB,eAAK,gBAAgB;AAGrB,eAAK,WAAW,IAAI;AAEpB,cAAI,KAAK,YAAY;AACnB,iBAAK,SAAS,OAAO,cAAc;;AAGrC,cAAM,OAAO,SAAS,qBAAqB;AAE3C,eAAK,UAAU,QAAQ,KAAK;AAG5B,eAAK,mBAAmB;AAExB,cAAI,cAAkB,oCAAoC;AACxD,0BAAkB,mCAAmC;AACrD,mBAAO,cAAkB;AACzB,mBAAO,cAAkB;;;SA7KoC;QAAA,KAAA;QAAA,KAkLjE,eAAiB;AACf,iBAAO,KAAK;;SAnLmD;QAAA,KAAA;QAAA,OAuLjE,mBAAU;AACR,iBAAO,KAAK;;SAxLmD;QAAA,KAAA;QAAA,OAkMjE,qBAAY;AACV,oBAAU,KAAK,SAAS;AACxB,iBAAqD,KAAK;;SApMK;QAAA,KAAA;QAAA,OA8MjE,wBAAe;AACb,oBACE,KAAK,YACL;AAEF,iBACE,KAAK;;SApNwD;QAAA,KAAA;QAAA,OAgOjE,sBAAa;AACX,iBAAO,KAAK,iBAAiB,aAAa;;SAjOqB;QAAA,KAAA;QAAA,OAqOjE,wBAAe;AACb,iBAAO,KAAK,SAAS,WAAW,cAAc;;SAtOiB;QAAA,KAAA;QAAA,OAgPjE,iBAAQ,cAAc;AACpB,cAAI,KAAK,eAAe;AACtB;;AAEF,cAAI,KAAK,iBAAiB,aAAa,cAAc;AAEnD;;AAGF,eAAK,aAAa;AAClB,eAAK,SAAS,OAAO,cAAc;AACnC,cAAI,KAAK,cAAc;AAKrB,iBAAK;;;SAhQwD;QAAA,KAAA;QAAA,OAyQjE,6BAAoB;AAClB,iBAAO,KAAK;;SA1QmD;QAAA,KAAA;QAAA,OAmRjE,0BAAiB,SAAS,kBAAkB;AAC1C,eAAK,QAAQ;AACb,eAAK,kBAAkB,IAAI,KAAK,QAAQ;AACxC,eAAK,gBAAgB,aAAa;AAClC,eAAK,sBAAsB,WAAW;AACtC,eAAK,UAAU,OAAO;AACtB,eAAK,UAAU,OAAO;AACtB,eAAK;AACL,eAAK,8BAA8B,UAAU;AAC7C,cAAI,CAAC,KAAK,MAAM;AACd,iBAAK,eAAe,SAAS;;AAE/B,eAAK,SAAS,OAAO,cAAc;;SA/R4B;QAAA,KAAA;QAAA,OAmSjE,yBAAgB;AACd,cACE,KAAK,WAAW,OAAO,aACvB,KAAK,SACL,CAAC,KAAK,MAAM,kBAAkB,KAAK,UACnC;AACA,uBACE,KAAK,aAAa,WAClB;AAKF,uBAAW,OAAD,2BAAiC,KAAK;;;SAhTa;QAAA,KAAA;QAAA,OAwTjE,4BAAmB;AACjB,iBAAO,KAAK,aACR,KAAK,WAAW,iBAAiB,QACjC,eAAe;;SA3T4C;QAAA,KAAA;QAAA,OAmUjE,6BAAoB;AAClB,iBAAO,KAAK,QACR,KAAK,MAAM,sBACX,eAAe;;SAtU4C;QAAA,KAAA;QAAA,OA6UjE,iCAAwB;AACtB,oBACE,KAAK,cACL;AAEF,iBAAO,KAAK,MAAM;;SAlV6C;QAAA,KAAA;QAAA,OAsVjE,sBAAa;AACX,iBAAO,CAAC,CAAC,KAAK;;SAvViD;QAAA,KAAA;QAAA,OAgWjE,mBAAU;AACR,iBAAO,KAAK;;SAjWmD;QAAA,KAAA;QAAA,OAyWjE,qBAAY;AACV,iBAAO,KAAK,SAAS,WAAW,cAAc;;SA1WiB;QAAA,KAAA;QAAA,OAwXjE,yBAAgB;AAAA,cAAA,SAAA;AACd,4BAAkB;AAClB,oBAAU,KAAK,YAAY;AAC3B,cAAI,KAAK,kBAAkB;AACzB,mBAAO,KAAK;;AAGd,eAAK,sBAAsB,WAAW;AAGtC,cAAM,cAAc,KAAK;AAGzB,cAAM,iBAAiB,YAAY,KAAK,WAAM;AAC5C,gBAAM,WAAW,OAAK;AACtB,gBAAM,gCAAgC,eACpC,KACA;AAEF,gBAAM,kBACJ,iCAAiC,CAAC,WAC9B,OAAK,wBACL;AAEN,gBAAI,CAAC,YAAY,CAAE,kCAAiC,kBAAkB;AACpE;;AAGF,mBAAO,SAAS,iCAAiC,QAC9C,KAAK,SAAC,QAAW;AAChB,kBAAI,CAAC,QAAQ;AACX,uBAAO;;AAET,qBAAO,WACH,OAAO,kBAAkB,YACzB,OAAO,oBAAoB;eAEhC,KAAK,SAAC,eAAkB;AACvB,kBAAI,CAAC,eAAe;AAClB,sBAAM;;;;AAMd,cAAM,eAAe,eAAe,KAAK,WAAA;AAAA,mBACvC,UAAU,OAAK,OAAO;;AAIxB,iBAAQ,KAAK,mBAAmB,aAAa,KAC3C,WAAM;AACJ,mBAAK,SAAS;AACd,mBAAK,UAAU,IAAI;AACnB,mBAAK,UAAU,OAAO;AACtB,mBAAK,UAAU,OAAO;AACtB,mBAAK,SAAS,OAAO,cAAc;AAEnC,gBAAI,OAAK,MAAM;AACb,qBAAK,sBACH,OAAK,eAAe,WAAW,WAC3B,OAAK,cACL,WAAW;mBAEZ;AACL,qBAAK,sBAAsB,WAAW;AACtC,qBAAK,WAA0B;;AAGjC,gBAAI,OAAK,cAAc;AACrB,qBAAK;;AAGP,gBAAI,OAAK,cAAc;AAGrB,uBAAS,SAAS,MAAM,OAAK,cAAc,cAAc,MACvD,OAAK,gBAAgB,KAAK,SAC1B;;AAGJ,gBAAI,CAAC,OAAK,kBAAkB;AAC1B,kBAAM,cAAc,OAAK;AACzB,kBAAI,aAAa;AACf,uBAAK,YAAY;;;aAIvB,SAAC,QAAW;AACV,mBAAK,SAAS,aACZ,cAAc,OACS;AAGzB,gBAAI,OAAK,MAAM;AACb,qBAAK,sBAAsB,WAAW,OAAO;;AAG/C,gBAAI,CAAC,mBAAmB,SAAS;AAC/B,0BAAY,QAAQ;;AAEtB,kBAAM;;;SA7dqD;QAAA,KAAA;QAAA,OAqejE,iBAAQ;AAAA,cAAA,SAAA;AACN,cAAI,KAAK,kBAAkB;AACzB,mBAAO,KAAK;;AAGd,cAAM,eAAe,KAAK,SAAS,WACjC,cAAc;AAEhB,iBAAO,aAAa,KAAK,WAAM;AAC7B,gBAAI,OAAK,MAAM;AACb,kBAAM,YAAY,mBAAmB,OAAK;AAC1C,wBAAU,aAAa;;AAEzB,mBAAO,OAAK;;;SAlfiD;QAAA,KAAA;QAAA,OAggBjE,yBAAgB;AAAA,cAAA,SAAA;AACd,cAAI,KAAK,eAAe;AACtB,mBAAO,KAAK;;AAEd,eAAK,wBACH,KAAK,yBAAyB,IAAI;AACpC,cAAO,SAAU,KAAK,sBAAf;AACP,iBAAQ,KAAK,gBAAgB,KAAK,gBAC/B,KAAK,WAAM;AACV,sBAAU,OAAK;AACf,gBAAI,OAAO,SAAS;AAElB;;AAEF,mBAAK,sBACH,OAAK,eAAe,WAAW,WAC3B,OAAK,cACL,OAAK,WAAW,YAAY,UAC5B,WAAW,UACX,WAAW;AAEjB,mBAAK,WAAW;AAChB,gBAAM,SAAS,OAAK,MAAM,cAAc;AAIxC,mBAAO,SAAS,OAAO,KAAK,eAAe;aAE5C,KAAK,SAAC,WAAc;AACnB,mBAAK,wBAAwB;AAC7B,gBAAI,OAAO,SAAS;AAClB,oBAAM;;AAER,mBAAK,SAAS,OAAO,cAAc;AACnC,gBAAI,CAAC,OAAK,WAAW,YAAY,WAAS,WAAW;AACnD,qBAAK,sBAAsB,WAAW;;aAGzC,MAAM,SAAC,QAAW;AACjB,mBAAK,wBAAwB;AAC7B,gBAAI,eAAe,SAAS;AAC1B,qBAAK,gBAAgB;mBAChB;AACL,qBAAK,SAAS,aACZ,cAAc,SACS;AAEzB,qBAAK,sBAAsB,WAAW,OAAO;;AAE/C,kBAAM;;;SAjjBqD;QAAA,KAAA;QAAA,OA0jBjE,iBAAQ;AAAA,cAAA,SAAA;AACN,cAAI,KAAK,eAAe;AACtB,mBAAO,KAAK;;AAKd,eAAK,wBACH,KAAK,yBAAyB,IAAI;AACpC,cAAO,SAAU,KAAK,sBAAf;AAEP,cAAM,eAAe,KAAK,SAAS,WACjC,cAAc;AAEhB,iBAAO,aAAa,KAAK,WAAM;AAC7B,gBAAI,CAAC,OAAK,MAAM;AACd,qBAAO,OAAK;;AAEd,gBAAI,OAAO,SAAS;AAClB,oBAAM;;AAER,gBAAM,YAAY,mBAAmB,OAAK;AAC1C,sBAAU,aAAa;AACvB,mBAAO,OAAK;;;SAjlBiD;QAAA,KAAA;QAAA,OA0lBjE,mBAAU;AAER,cAAI,KAAK,cAAc;AACrB,iBAAK;;AAIP,cAAI,CAAC,KAAK,MAAM;AACd,iBAAK;AACL;;AAIF,cAAI,KAAK,uBAAuB;AAC9B,iBAAK,sBAAsB;AAC3B,iBAAK,wBAAwB;;AAI/B,cAAM,YAAY,mBAAmB,KAAK;AAC1C,oBAAU,WAAW;AAGrB,cAAI,KAAK,UAAU;AACjB,iBAAK,MAAM;;AAIb,eAAK,WAAW;AAChB,eAAK,gBAAgB;AACrB,eAAK;AAGL,cAAI,KAAK,cAAc;AACrB,iBAAK,mBAA4C;;;SA5nBY;QAAA,KAAA;QAAA,OAqoBjE,uBAAc;AACZ,iBAAO,KAAK,SAAS,WAAW,cAAc;;SAtoBiB;QAAA,KAAA;QAAA,OA6oBjE,sBAAa;AACX,iBAAO,KAAK,SAAS,WAAW,cAAc;;SA9oBiB;QAAA,KAAA;QAAA,OAwpBjE,sBAAa,oBAAoB;AAAA,cAAA,SAAA;AAC/B,iBAAO,KAAK,QAAQ,KAAK,WAAM;AAC7B,gBAAI,OAAK,MAAM;AACb,kBAAI,OAAK,WAAW,YAAY,SAAO;AACrC,uBAAK,MAAM;;AAEb,qBAAO,OAAK;;AAMd,gBAAM,WAAW,OAAK;AACtB,mBAAO,SAAS,YAAY,KAAK,WAAM;AACrC,kBAAI,SAAS,cAAc,cAAc,iBAAiB;AACxD;;AAEF,kBACE,SAAS,cAAc,cAAc,oBACrC,SAAS,sBACT;AACA,yBAAS;;AAEX,kBAAI,CAAC,SAAS,eAAe;AAC3B;;AAEF,qBAAK,eAAe,wBAClB,UACa,MACb,oBAC2B;AAE7B,qBAAO,OAAK;;;;SAxrB+C;QAAA,KAAA;QAAA,OAqsBjE,gCAAuB,cAAc;AACnC,cAAM,UAAU,mBAAmB,KAAK;AACxC,kBAAQ,aAAa,MAAM;;SAvsBoC;QAAA,KAAA;QAAA,OA+sBjE,qCAA4B;AAC1B,cAAM,UAAU,mBAAmB,KAAK;AACxC,kBAAQ,gBAAgB;;SAjtBuC;QAAA,KAAA;QAAA,OA4tBjE,+BAAsB,OAAO,aAAa;AACxC,cAAI,UAAU,KAAK,aAAa;AAC9B;;AAGF,eAAK,cAAc;AAEnB,cAAI,CAAC,KAAK,MAAM;AACd;;AAGF,kBAAQ;iBACD,WAAW;AACd,mBAAK,SAAS,OAAO,cAAc;AACnC,mBAAK,SAAS,MAAM,cAAc;AAClC,mBAAK,SAAS,MAAM,cAAc;AAClC,mBAAK,UAAU,IAAI;AAEnB,mBAAK,cAAc;AACnB,mBAAK,8BAA8B,UAAU;AAC7C;iBACG,WAAW;AAGd,mBAAK,SAAS,OAAO,cAAc;AACnC,mBAAK,SAAS,OAAO,cAAc;AACnC,mBAAK,SAAS,MAAM,cAAc;AAClC,mBAAK,UAAU,IAAI;AACnB,mBAAK,cAAc;AACnB,cAAI,oBAAoB,MAAM,QAAQ,MAAM;AAC5C,mBAAK,8BAA8B,UAAU;AAC7C;iBACG,WAAW;AACd,mBAAK,SAAS,aACZ,cAAc,UACS;AAEzB,mBAAK,cAAc;AACnB,cAAI,oBAAoB,MAAM,SAAS,aAAa;AACpD;;;SAnwB2D;QAAA,KAAA;QAAA,OA6wBjE,oBAAW,UAAU;AAAA,cAAA,SAAA;AACnB,oBAAU,KAAK;AACf,cAAI,UAAU;AACZ,iBAAK,MAAM,mBAAmB;iBACzB;AAIL,yBAAa,KAAK,aAAa,WAAM;AACnC,kBAAI,CAAC,OAAK,iBAAiB,CAAC,OAAK,cAAc,aAAa;AAC1D;;AAEF,qBAAK,MAAM,mBAAmB;;;;SAzxB6B;QAAA,KAAA;QAAA,OAoyBjE,cAAK;AACH,iBAAO,KAAK,aAAa,KAAK,WAAW,OAAO;;SAryBe;QAAA,KAAA;QAAA,OA8yBjE,yBAAgB;AACd,iBAAO,KAAK,aAAa,KAAK,WAAW,cAAc,QAAQ;;SA/yBA;QAAA,KAAA;QAAA,OAszBjE,yBAAgB;AACd,iBAAO,KAAK,QAAQ,KAAK,MAAM,kBAAkB;;SAvzBc;QAAA,KAAA;QAAA,OAg0BjE,yBAAgB,WAAW,aAAqB;AAAA,cAArB,gBAAqB,QAAA;AAArB,0BAAc;;AACvC,cAAI,KAAK,WAAW;AAClB,iBAAK,UAAU;;;SAl0B8C;QAAA,KAAA;QAAA,OA00BjE,qBAAY;AACV,oBAAU,KAAK;AACf,cAAI;AACF,iBAAK,MAAM;mBACJ,GAAP;AACA,wBAAY,GAAG;;;SA/0B8C;QAAA,KAAA;QAAA,OAu1BjE,qBAAY;AACV,cACE,KAAK,iBAAiB,UACrB,MAAK,YAAY,OAAO,cACvB,KAAK,YAAY,OAAO,YAC1B;AAEA,iBAAK,eAAe,KAAK,cAAc;;AAEzC,iBAAO,KAAK,gBAAgB;;SAh2BmC;QAAA,KAAA;QAAA,OAu2BjE,qBAAY,OAAO;AACjB,cAAI,KAAK,YAAY,OAAO,YAAY;AACtC,qBAAS,OAAO,cAAc;AAC9B;;AAEF,cAAI,KAAK,YAAY,OAAO,WAAW;AACrC,gBAAM,oBAAoB,MAAM,cAC9B;AAEF,gBAAI,CAAC,mBAAmB;AACtB;;AAEF,8BAAkB,aAAa,OAAO;AACtC;;;SAp3B6D;QAAA,KAAA;QAAA,OAy3BjE,2BAAkB;AAAA,cAAA,SAAA;AAChB,cAAM,gBACJ,KAAK,aAAa,YACjB,KAAK,aAAa,YACjB,CAAC,KAAK,aAAa,2BACrB,KAAK,aAAa;AACpB,cAAM,gBAAgB,CAAC,CAAC,KAAK;AAC7B,cAAM,OAAM,KAAK,cAAc;AAC/B,cAAI,iBAAiB,iBAAiB,MAAK;AACzC,gBAAI,eAAe;AACjB,mBAAK,mBAAmB,IAAI,gBAAgB,MAAK,WAAA;AAAA,uBAC/C,OAAK;;AAEP,mBAAK;mBACA;AACL,mBAAK;;;;SAx4BsD;QAAA,KAAA;QAAA,OA84BjE,8BAAqB;AACnB,cAAI,KAAK,kBAAkB;AACzB,iBAAK,iBAAiB;AACtB,iBAAK,mBAAmB;;;SAj5BqC;QAAA,KAAA;QAAA,OAs5BjE,4BAAmB;AACjB,cAAM,QAAQ,KAAK;AACnB,cAAI,CAAC,OAAO;AACV;;AAGF,gBAAM;AAGN,cAAM,YAAY,KAAK,aAAa,YAAY;AAChD,cAAM,eAAe,YACjB,MAAM,kBAAkB,aACxB;AACJ,eAAK,UAAU,OAAO,mCAAmC,CAAC;AAG1D,cAAM,YAAY,KAAK,aAAa,0BAChC,OACA,KAAK,aAAa;AACtB,cAAI,WAAW;AACb,qBAAS,MAAM,SAAS,MAAM,iBAAiB;;AAIjD,cAAM,cACJ,KAAK,YAAY,OAAO,aACpB,KAAK,aAAa,aAClB;AACN,cAAI,aAAa;AACf,gBAAM,QAAQ,KAAK;AACnB,gBAAI,OAAO;AACT,uBAAS,OAAO,cAAc,MAAM,iBAAiB;;;AAIzD,gBAAM;AACN,eAAK,eAAe;;SA17B2C;QAAA,KAAA;QAAA,OAy8BjE,mBAAU,WAAW,UAAU,gBAAgB;AAC7C,cAAM,QAAQ,KAAK;AACnB,cAAI,OAAO;AAIT,iBAAK,eAAe;AACpB,iBAAK,YAAY;AACjB,iBAAK,gBAAgB,WAAM;AACzB,kBAAI,OAAO;AACT,gBAAI,cAAc;;;;AAIxB,cAAI,cAAc,QAAW;AAC3B,qBAAS,MAAM,UAAU,WAAW;;AAEtC,cAAI,aAAa,QAAW;AAC1B,qBAAS,MAAM,SAAS,UAAU;;AAEpC,cAAI,gBAAgB;AAClB,gBAAI,eAAe,OAAO,MAAM;AAC9B,uBAAS,MAAM,aAAa,eAAe,KAAK;;AAElD,gBAAI,eAAe,SAAS,MAAM;AAChC,uBAAS,MAAM,eAAe,eAAe,OAAO;;AAEtD,gBAAI,eAAe,UAAU,MAAM;AACjC,uBAAS,MAAM,gBAAgB,eAAe,QAAQ;;AAExD,gBAAI,eAAe,QAAQ,MAAM;AAC/B,uBAAS,MAAM,cAAc,eAAe,MAAM;;;AAGtD,cAAI,KAAK,mBAAmB;AAC1B,iBAAK;;AAEP,UAAI,oBAAoB,MAAM,UAAU;;SA9+BuB;QAAA,KAAA;QAAA,OA6/BjE,6BAAoB;AAClB,cAAI,CAAC,4BAA4B,KAAK,kBAAkB,QAAW;AACjE,iBAAK,gBAAgB,CAAC,CAAC,AAAM,iCAC3B,MACA;;AAGJ,cAAI,KAAK,eAAe;AACtB;;AAGF,cAAI,KAAK,gBAAgB,CAAC,AAAI,gBAAgB,OAAO;AACnD;;AAEF,eAAK,eAAe;AAEpB,cAAI,CAAC,KAAK,cAAc;AACtB,iBAAK,UAAU,IAAI;AACnB,iBAAK,UAAU,IAAI;AACnB,iBAAK,UAAU,IAAI;;AAGrB,cAAI,CAAC,KAAK,SAAS;AAEjB,gBAAM,OAAM,MAAM,KAAK,cAAc;AACrC,gBAAM,iBAAgB,SAAS,iBAAiB;AAChD,gBAAM,SAAS,eAAc,UAAU;AACvC,iBAAK,UAAU;AACf,sCAAyB,QAAQ,MAAM,KAAK;;AAE9C,cAAI,CAAC,KAAK,YAAY;AAEpB,iBAAK,aAAa,SAAS,gBAAgB,KAAK;;AAElD,eAAK,eAAe,IAAI;AAExB,cAAI,KAAK,cAAc;AACrB,gBAAM,cAAc,KAAK;AACzB,gBAAI,aAAa;AACf,mBAAK;;AAEP,gBAAI,KAAK,cAAc;AACrB,kBAAI,eAAe,CAAC,KAAK,MAAM;AAC7B,qBAAK,eAAe,SAAS;;AAE/B,mBAAK;AACL,mBAAK,8BAA8B,UAAU;;AAE/C,gBAAI,KAAK,cAAc,KAAK,MAAM;AAChC,mBAAK;;iBAEF;AACL,iBAAK,eAAe;AAEpB,gBAAI;AACF,mBAAK,UAAU,kBACb,MACA,SAAS,YAAY,MAAM,KAAK,cAAc,cAAc;AAE9D,mBAAK;qBACE,GAAP;AACA,0BAAY,GAAG;;AAEjB,gBAAI,KAAK,YAAY;AACnB,mBAAK;;AAEP,gBAAI,CAAC,KAAK,cAAc;AACtB,mBAAK,UAAU,IAAI;AACnB,mBAAK,UAAU,IAAI;AACnB,mBAAK,8BAA8B,UAAU;;;AAIjD,eAAK,cAAc;;SAtkC4C;QAAA,KAAA;QAAA,OA6kCjE,2BAAkB;AAChB,iBAAO,KAAK,UAAU,SAAS;;SA9kCgC;QAAA,KAAA;QAAA,OAolCjE,yBAAgB;AACd,eAAK,UAAU,OAAO;;SArlCyC;QAAA,KAAA;QAAA,OA6lCjE,4BAAmB,oBAAoB;AACrC,cAAI,CAAC,KAAK,MAAM;AACd,iBAAK;AACL;;AAGF,cAAI,KAAK,eAAe;AAEtB;;AAIF,cAAM,YAAY,mBAAmB,KAAK;AAC1C,oBAAU,SAAS;AAEnB,cAAI,KAAK,kBAAkB;AAEzB,iBAAK,sBACH,KAAK,cAAc,KAAK,WAAW,YAAY,QAC3C,WAAW,UACX,WAAW;iBAEZ;AAEL,iBAAK,sBAAsB,WAAW;AAGtC,gBAAI,CAAC,oBAAoB;AACvB,kBAAM,QAAO,KAAK,WAAW,eAAe;AAC5C,kBAAI,SAAQ,MAAK,SAAS,GAAG;AAI3B,oBAAM,SAAS,KAAK;AACpB,6BAAa,QAAQ,WAAM;AACzB,sBAAO,OAAO,OAAP;AACP,sBAAI,CAAC,MAAK;AACR;;AAEF,sBAAM,aAAa,SAAS,cAAc;AAC1C,wBAAK,QAAQ,SAAC,KAAD;AAAA,2BACX,WAAW,IAAI,QAAQ,KAA0B;;;;;;;SAtoCI;QAAA,KAAA;QAAA,OAmpCjE,uBAAc;AAAA,cAAA,SAAA;AACZ,cAAI,KAAK,eAAe;AACtB;;AAEF,cAAI,KAAK,iBAAiB,aAAa,cAAc;AAEnD;;AAGF,cAAM,OAAO,UACX,KAAK,YACL;AAGF,cAAM,OAAO,IAAI,KAAK;AAKtB,eAAK,gBAAgB,aAAa;AAClC,cAAM,YAAY,IAAI,KAAK;AAC3B,cAAM,MAAM,KAAK;AACjB,cAAI,CAAC,KAAK;AAER,iBAAK,iBAAiB,MAAM;qBACnB,OAAO,IAAI,QAAQ,YAAY;AAExC,mBAAO,IACJ,KAAK,SAAC,SAAY;AACjB,qBAAK,iBAAiB,WAAW,MAAM;eAExC,MAAM,SAAC,QAAW;AACjB,qBAAK,gBAAgB,aAAa;AAClC,2BAAa;;iBAEZ;AAEL,iBAAK,iBACyC,KAC5C;;;SA1rC2D;QAAA,KAAA;QAAA,OAosCjE,gCAAuB;AACrB,eAAK,WAAqC;;SArsCqB;QAAA,KAAA;QAAA,OAysCjE,sBAAa;AACX,cAAI,KAAK,QAAQ;AACf,iBAAK,MAAM;;;SA3sCkD;QAAA,KAAA;QAAA,OA4tCjE,oBAAW,qBAAqB;AAC9B,cAAI,KAAK,iBAAiB,CAAC,KAAK,cAAc;AAC5C;;AAEF,cAAI,CAAC,uBAAuB,AAAI,gBAAgB,OAAO;AACrD;;AAOF,cAAI,qBAAqB;AACvB,iBAAK,UAAU,OAAO;;AAGxB,eAAK,eAAe;AACpB,eAAK,eAAe,OAAO;AAC3B,cAAI,KAAK,OAAO;AACd,iBAAK,MAAM;;AAEb,cAAI,KAAK,MAAM;AACb,iBAAK;;AAEP,eAAK,cAAc;AACnB,eAAK;;SArvC0D;QAAA,KAAA;QAAA,OA+vCjE,uCAA8B,MAAM,UAAU;AAC5C,cAAI,CAAC,UAAU,MAAM;AACnB;;AAEF,UAAI,oBAAoB,MAAM,MAAM;;SAnwC2B;QAAA,KAAA;QAAA,OA2wCjE,4BAAmB;AACjB,cAAI,KAAK,aAAa,gBAAgB;AACpC,mBAAO;;AAET,iBAAO,KAAK,aAAa,KAAK,WAAW,iBAAiB,QAAQ;;SA/wCH;QAAA,KAAA;QAAA,OAuxCjE,iCAAwB;AACtB,iBAAO,KAAK,QAAQ,KAAK,MAAM,0BAA0B;;SAxxCM;QAAA,KAAA;QAAA,OAgyCjE,6BAAoB;AAClB,iBAAO,KAAK,QAAQ,KAAK,MAAM,8BAA8B;;SAjyCE;QAAA,KAAA;QAAA,OA4yCjE,4BAAmB;AACjB,iBAAO,KAAK,aACR,KAAK,WAAW,yBAAyB,QACzC;;SA/yC2D;QAAA,KAAA;QAAA,OAuzCjE,iCAAwB;AACtB,iBAAO,KAAK,QAAQ,KAAK,MAAM,0BAA0B;;SAxzCM;QAAA,KAAA;QAAA,OAi0CjE,qCAA4B;AAC1B,iBAAO,KAAK,QAAQ,KAAK,MAAM,8BAA8B;;SAl0CE;QAAA,KAAA;QAAA,OA40CjE,wBAAe;AACb,iBAAO,KAAK,eAAe;;SA70CoC;QAAA,KAAA;QAAA,OAq1CjE,yBAAgB;AACd,iBAAO,KAAK,eAAe;;SAt1CoC;QAAA,KAAA;QAAA,OA61CjE,oBAAW;AACT,iBAAO,KAAK,eAAe;;SA91CoC;QAAA,KAAA;QAAA,OAu2CjE,uCAA6B;AAC3B,cAAM,MAAM,KAAK,QACb,KAAK,MAAM,oCACX,KAAK;AACT,cAAM,QAAQ,KAAK;AACnB,cAAM,WAAW,SAAS,eAAe,KAAK;AAC9C,cAAM,cAAc,SAAS;AAE7B,cAAM,WAAW,SAAS,MAAM;AAChC,iBAAO,2BAA2B,KAAK,UAAU;;SAh3Cc;QAAA,KAAA;QAAA,OAw3CjE,wBAAe;AACb,iBAAO,KAAK,eAAe,sBAAsB;;SAz3Cc;QAAA,KAAA;QAAA,OAg4CjE,yBAAgB;AACd,iBAAO,KAAK,eAAe;;SAj4CoC;QAAA,KAAA;QAAA,OA24CjE,4BAAmB;AACjB,iBAAO,KAAK,QAAQ,KAAK,MAAM,qBAAqB;;SA54CW;QAAA,KAAA;QAAA,OAq5CjE,iBAAQ,cAAqB;AAAA,cAAA,UAAA;AAAA,cAArB,iBAAqB,QAAA;AAArB,2BAAe;;AACrB,cAAM,UAAU,eAAe,KAAK,UAAU,KAAK;AACnD,iBAAO,QAAQ,KAAK,WAAA;AAAA,mBAAM,QAAK;;;SAv5CgC;QAAA,KAAA;QAAA,OA85CjE,uBAAc;AAAA,cAAA,UAAA;AACZ,iBAAO,KAAK,SACT,WAAW,cAAc,kBACzB,KAAK,WAAM;AACV,oBAAK;AACL,mBAAO,QAAK;;;SAn6C+C;QAAA,KAAA;QAAA,OA86CjE,kBAAS;AACP,iBAAO,KAAK,UAAU,KAAK,SAAC,MAAD;AAAA,mBAAU,KAAK;;;SA/6CqB;QAAA,KAAA;QAAA,OAs7CjE,qBAAY;AACV,iBAAO,KAAK;;SAv7CmD;QAAA,KAAA;QAAA,OA08CjE,wBAAe,QAAQ;AAAA,cAAA,UAAA;AACrB,4BAAkB;AAClB,oBAAU,KAAK,WAAW;AAE1B,cAAK,EAAC,UAAU,QAAQ,WAAW,OAAO,SAAS;AACjD,mBAAO,QAAQ,OAAO;;AAGxB,eAAK,8BAA8B,UAAU;AAC7C,cAAM,cAAc,KAAK,gBAAgB;AACzC,eAAK,SAAS,MAAM,cAAc;AAClC,cAAI,aAAa;AACf,iBAAK,SAAS,OAAO,cAAc;;AAIrC,eAAK,cAAc;AAEnB,cAAM,UAAU,WAAW,WAAA;AAAA,mBAAM,QAAK,MAAM;;AAC5C,eAAK,WAA0B;AAC/B,eAAK,UAAU,IAAI;AAEnB,iBAAO,QAAQ,KACb,WAAM;AACJ,gBAAK,EAAC,UAAU,QAAQ,WAAW,OAAO,SAAS;AACjD,oBAAM;;AAER,gBAAI,aAAa;AACf,sBAAK,SAAS,OAAO,cAAc;;AAErC,oBAAK,sBAAsB,WAAW;AACtC,oBAAK;AACL,oBAAK,cAAc;AAGnB,gBAAI,CAAC,QAAK,yBAAyB;AACjC,sBAAK,MAAM;AACX,sBAAK,0BAA0B;AAC/B,sBAAK,8BAA8B,UAAU;;aAGjD,SAAC,QAAW;AACV,gBAAK,EAAC,UAAU,QAAQ,WAAW,OAAO,SAAS;AACjD,oBAAM;;AAGR,gBAAI,aAAa;AACf,sBAAK,SAAS,aACZ,cAAc,UACS;;AAG3B,oBAAK,sBAAsB,WAAW,OAAO;AAC7C,oBAAK;AACL,oBAAK,cAAc;AACnB,kBAAM;;;SAjgDqD;QAAA,KAAA;QAAA,OA2gDjE,iBAAQ;AACN,cAAI,CAAC,KAAK,WAAW;AAEnB;;AAGF,eAAK,MAAM;AAGX,cAAI,CAAC,KAAK,QAAQ,KAAK,MAAM,mBAAmB;AAC9C,iBAAK;;;SArhDwD;QAAA,KAAA;QAAA,OAiiDjE,kBAAS;AACP,cAAI,CAAC,KAAK,WAAW;AACnB;;AAEF,eAAK,MAAM;;SAriDoD;QAAA,KAAA;QAAA,OAkjDjE,4BAAmB;AACjB,4BAAkB;AAClB,cAAI,CAAC,KAAK,WAAW;AACnB,mBAAO;;AAET,eAAK,SAAS,OAAO,cAAc;AACnC,cAAM,mBAAmB,KAAK,MAAM;AACpC,cAAI,kBAAkB;AACpB,iBAAK;;AAEP,eAAK,8BAA8B,UAAU;AAC7C,iBAAO;;SA7jDwD;QAAA,KAAA;QAAA,OAikDjE,qBAAY;AACV,eAAK,eAAe;AACpB,cAAI,KAAK,gBAAgB,KAAK,YAAY;AACxC,iBAAK,WAAkB;;;SApkDsC;QAAA,KAAA;QAAA,OAykDjE,kBAAS;AACP,eAAK,eAAe;AACpB,eAAK,0BAA0B;AAC/B,eAAK,SAAS,MAAM,cAAc;AAClC,eAAK,SAAS,MAAM,cAAc;AAClC,eAAK,SAAS,MAAM,cAAc;AAClC,eAAK,SAAS,MAAM,cAAc;AAClC,eAAK,SAAS,MAAM,cAAc;;SAhlD6B;QAAA,KAAA;QAAA,OA2lDjE,qCAA4B;AAC1B,iBAAO,KAAK,QAAQ,KAAK,MAAM,8BAA8B;;SA5lDE;QAAA,KAAA;QAAA,OAmmDjE,oBAAW;AACT,cAAI,KAAK,OAAO;AACd,iBAAK,MAAa;;;SArmD2C;QAAA,KAAA;QAAA,OA6mDjE,2BAAkB,SAAS;AACzB,cAAI,KAAK,OAAO;AACd,iBAAK,MAAM,kBAAkB;;;SA/mDgC;QAAA,KAAA;QAAA,OAunDjE,kBAAS;AACP,cAAI,KAAK,OAAO;AACd,iBAAK,MAAa;;;SAznD2C;QAAA,KAAA;QAAA,OAooDjE,mCAA0B,WAAW;AACnC,cAAI,KAAK,OAAO;AACd,iBAAK,MAAM,0BAA0B;;;SAtoDwB;QAAA,KAAA;QAAA,OAkpDjE,qBAAY,YAAY;AACtB,4BAAkB;AAClB,cAAI,CAAC,KAAK,WAAW;AACnB,gBAAI,KAAK,iBAAiB,QAAW;AACnC,mBAAK,eAAe;;AAEtB,sBAAU,KAAK,cAAc,KAAK;AAElC,iBAAK;iBACA;AACL,iBAAK,iBAAiB,YAAY;;;SA5pD2B;QAAA,KAAA;QAAA,OAqqDjE,2BAAkB;AAAA,cAAA,UAAA;AAChB,cAAI,CAAC,KAAK,cAAc;AACtB;;AAGF,cAAM,cAAc,UAAU,KAAK;AACnC,eAAK,eAAe;AAGpB,sBAAY,QAAQ,SAAC,YAAe;AAClC,oBAAK,iBAAiB,YAAY;;;SA/qD2B;QAAA,KAAA;QAAA,OA0rDjE,0BAAiB,YAAY,UAAU;AACrC,cAAI;AACF,iBAAK,MAAM,cAAc,YAAY;mBAC9B,GAAP;AACA,yBACE,4BACA,GACA,WAAW,KAAK,SAChB,WAAW;;;SAlsDgD;QAAA,KAAA;QAAA,OA2sDjE,6BAAoB;AAClB,cAAI,WAAW,KAAK,aAAa;AACjC,cAAI,aAAa,MAAM;AACrB,gBAAI,2BAA2B,OAAO;AACpC,yBAAW;AACX,mBAAK,aAAa,yBAAyB;mBACtC;AAEL,qBAAO;;;AAGX,cAAI,YAAY,MAAM,YAAY,WAAW;AAI3C,mBAAO,UAAU,KAAK,OAAO;;AAE/B,iBAAO;;SA5tDwD;QAAA,KAAA;QAAA,OAmuDjE,+BAAsB;AAAA,cAAA;AACpB,cAAM,WACJ,KAAK,aAAa,qCAAqC;AACzD,iBAAO,YAAP,OAAA,SAAA,qBAAO,SAAU,QAAQ,QAAQ,QAAjC,OAAA,SAAO,kBAA+B,MAAM;;SAtuDmB;QAAA,KAAA;QAAA,OAgvDjE,6BAAoB;AAClB,iBAAO,AAAM,WAAW,MAAM,SAAC,MAAD;AAAA,mBAAU,CAAC,wBAAwB;;;SAjvDF;QAAA,KAAA;QAAA,OA0vDjE,2BAAkB;AAChB,iBAAO,AAAM,cACX,MACA,SAAC,SAAD;AAAA,mBAAa,CAAC,wBAAwB;;;SA7vDuB;QAAA,KAAA;QAAA,OAswDjE,0BAAiB;AACf,iBAAO,AAAM,iBAAiB,MAAM,SAAC,IAAO;AAC1C,mBACE,GAAG,aAAa,kBAIhB,CAAC,mBAAmB;;;SA7wDuC;QAAA,KAAA;QAAA,OAuxDjE,2BAAkB,MAAM;AACtB,4BAAkB;AAClB,cAAI,MAAM;AACR,gBAAM,cAAc,KAAK;AACzB,gBAAI,aAAa;AACf,oBAAM,cAAc,aAAa,UAAU,OAAO;;iBAE/C;AACL,gBAAM,eAAe,AAAM,oBAAoB,MAAM;AACrD,qBAAS,IAAI,GAAG,IAAI,aAAa,QAAQ,KAAK;AAG5C,kBAAI,mBAAmB,aAAa,KAAK;AACvC;;AAEF,2BAAa,GAAG,UAAU,IAAI;;;;SAtyD6B;QAAA,KAAA;QAAA,OAgzDjE,uBAAc;AACZ,iBAAO,AAAM,mBAAmB,MAAM;;SAjzDyB;QAAA,KAAA;QAAA,OA0zDjE,wBAAe,MAAM;AACnB,4BAAkB;AAClB,cAAM,gBAAgB,KAAK,eAAe;AAE1C,cACE,CAAC,KAAK,QACN,QACC,kBAAiB,cAAc,aAC9B,iBAAiB,cAAc,gBAC/B,iBAAiB,cAAc,mBACjC;AACA;;AAMF,eAAK,UAAU,OAAO,oBAAoB;AAC1C,cAAI,QAAQ,MAAM;AAChB,gBAAM,kBAAkB,KAAK;AAC7B,gBAAI,iBAAiB;AACnB,uBAAS,aAAa,KAAK,aAAa,eACtC,MACA;;;;SAj1DyD;QAAA,KAAA;QAAA,OA41DjE,yBAAgB;AACd,eAAK,SAAS,OAAO,cAAc;AACnC,eAAK,kBAAkB;AACvB,eAAK,cAAc;;SA/1D4C;QAAA,KAAA;QAAA,OAw2DjE,2BAAkB,OAAO;AAYvB,cAAM,UACJ,KAAK,eAAe,KAAK,KAAK,SAAS,IAAI,cAAc;AAC3D,cACE,KAAK,WAAW,OAAO,aACvB,KAAK,aAAa,gBACjB,WAAW,CAAC,SACb,CAAC,iBAAiB,SAClB,wBAAwB,OACxB;AACA,mBAAO;;AAGT,iBAAO;;SAh4DwD;QAAA,KAAA;QAAA,OAy4DjE,uBAAc,OAAO,OAAe;AAAA,cAAf,UAAe,QAAA;AAAf,oBAAQ;;AAI3B,cAAI,CAAC,KAAK,iBAAiB,CAAC,KAAK,cAAc,aAAa;AAC1D;;AAGF,cAAM,mBAAmB,SAAS,uBAChC,KAAK;AAEP,cAAI,kBAAkB;AACpB,oBAAQ,SAAS,KAAK,kBAAkB;AACxC,gBAAI,OAAO;AACT,+BAAiB,MAAM;mBAClB;AACL,+BAAiB,QAAQ;;;;SAz5DkC;QAAA,KAAA;QAAA,OAk6DjE,8BAAqB;AACnB,cAAI,KAAK,qBAAqB,QAAW;AACvC,iBAAK,mBAAmB,AAAM,mBAAmB,MAAM;AACvD,gBAAI,KAAK,kBAAkB;AACzB,kBAAI,CAAC,KAAK,iBAAiB,aAAa,aAAa;AACnD,qBAAK,iBAAiB,aAAa,YAAY;;AAEjD,kBAAI,CAAC,KAAK,iBAAiB,aAAa,SAAS;AAC/C,qBAAK,iBAAiB,aAAa,QAAQ;;;;AAIjD,iBAAO,KAAK;;SA96DmD;QAAA,KAAA;QAAA,OAy7DjE,0BAAiB,WAAW,iBAAiB,gBAAgB;AAAA,cAAA,UAAA;AAC3D,eAAK;AACL,cAAI,CAAC,KAAK,kBAAkB;AAC1B,gBAAI,aAAa,KAAK,uBAAuB;AAC3C,qBAAO,KACL,MACA,uDACA;;iBAGC;AACL,iBAAK,iBAAiB,UAAU,OAAO,eAAe;AAEtD,gBAAI,WAAW;AACb,mBAAK,iBAAiB,UAAU,WAAM;AACpC,oBAAM,UAAU,SAAS,cAAc,QAAK;AAC5C,wBAAQ,gBAAgB,SAAM,iBAAiB;AAC/C,wBAAQ,cAAc,SAAM,WAAM;AAChC,0BAAK,iBACa,OAChB,iBACA;;;mBAID;AACL,mBAAK,iBAAiB,UAAU;;;;SAn9D2B;QAAA,KAAA;QAAA,OA+9DjE,yBAAgB,SAAS,aAAa,mBAA2B;AAAA,cAA3B,sBAA2B,QAAA;AAA3B,gCAAoB;;AACxD,cAAI,KAAK,SAAS;AAChB,qBAAS,cAAc,KAAK,aAAa,cACvC,eAAe,MACf,SACA;iBAEG;AACL;;;;AAv+D6D,aAAA;MASnC;AAk+DhC,QAAI,sBAAsB;AAC1B,WAA0C,IAAI;;AAOhD,8BAA4B,SAAS;AACnC,WAAO,iBAAiB;;AAI1B,6BAA2B,SAAS;AAClC,cAAU,CAAC,QAAQ,eAAe;;AAQpC,mCAAiC,MAAM;AACrC,QAAI,kBAAkB,OAAO;AAC3B,aAAO;;AAET,QACE,KAAK,WACJ,MAAK,aAAa,kBACjB,KAAK,aAAa,eAClB,KAAK,aAAa,cACpB;AACA,aAAO;;AAET,WAAO;;;;AClnET,MAAM,oBAAoB,IAAI;AAM9B,+BAA6B,KAAK;AAChC,QAAI,CAAC,IAAI,yBAAyB;AAChC,UAAI,0BAA0B;;AAEhC,WAAO,IAAI;;AASN,oCAAkC,KAAK,MAAM,SAAS;AAC3D,QAAM,cAAc,oBAAoB,KAAK;AAC7C,QAAI,aAAa;AACf,kBAAY,KAAK,WAAA;AAAA,eAAM,8BAA8B,KAAK,MAAM;;WAC3D;AACL,oCAA8B,KAAK,MAAM;;;AAU7C,yCAAuC,KAAK,MAAM,SAAS;AACzD,QAAM,gBAAgB,oBAAoB;AAC1C,QAAI,CAAC,cAAc,OAAO;AACxB,sBAAgB,KAAK,MAAM;AAC3B;;AAEF,QAAI,cAAc,SAAS,SAAS;AAElC;;AAEF,eACE,cAAc,SAAS,aACvB,yFAEA,MACA;AAEF,kBAAc,QAAQ;AACtB,aAAS,IAAI,GAAG,IAAI,gBAAgB,QAAQ,KAAK;AAC/C,UAAM,UAAU,gBAAgB;AAShC,UACE,QAAQ,QAAQ,iBAAiB,QACjC,QAAQ,cAAc,eAAe,KACrC;AACA,0BAAkB,SAAS;AAE3B,wBAAgB,OAAO,KAAK;;;;AAWlC,6BAA2B,SAAS,SAAS;AAC3C,QAAI;AACF,cAAQ,QAAQ;aACT,GAAP;AACA,kBAAY,GAAG;;;AAanB,+BAA6B,KAAK,cAAc;AAE9C,QAAI,aAAa,uBAAuB,CAAC,IAAI,QAAQ,UAAU,cAAc;AAC3E,UAAM,aAAa,SAAS,cAAc;AAC1C,aAAO,WAAW,gBAAgB,KAAK;;;AAUpC,8BAA4B,QAAQ;AACzC,QAAM,aAAa,uBAAuB,OAAO;AACjD,eAAW,QAAQ,SAAA,MAAqC;AAAA,UAAnC,cAAmC,KAAnC,aAAa,mBAAsB,KAAtB;AAChC,aAAO,iBAAiB,aAAa;AACrC,4BAAsB,OAAO,KAAK;;AAEpC,QAAI,OAAO,mBAAmB;AAC5B,aAAO;;;AASJ,iCAA+B,KAAK,MAAM;AAC/C,QAAM,gBAAgB,oBAAoB;AAC1C,QAAI,CAAC,cAAc,OAAO;AACxB,sBAAgB,KAAK,MAAM;;;AAYxB,oCAAkC,WAAW,UAAU,MAAM;AAClE,QAAM,UAAU,oBAAoB,WAAW;AAC/C,oBAAgB,UAAU,MAAM,WAAW;;AAStC,2BAAyB,KAAK,MAAM,qBAAqB;AAC9D,QAAM,gBAAgB,oBAAoB;AAC1C,kBAAc,QAAQ;AACtB,QAAM,QAAQ,yBAAyB,KAAK;AAC5C,QAAI,kBAAkB,OAAO,MAAM;;AAS9B,oCAAkC,QAAQ,SAAS,qBAAqB;AAE7E,QAAI,CAAC,kBAAkB,IAAI,SAAS;AAClC,wBAAkB,IAAI,QAAQ;AAC9B,yBAAmB;;AAIrB,QAAM,cAAc,QAAQ;AAC5B,QAAI,CAAC,uBAAuB,CAAC,OAAO,kBAAkB,cAAc;AAClE,eAAS,cAAc,OAAO,KAAK,uBACjC,QACA,aAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9KN,MAAM,OAAM;AAMZ,MAAM,0BAA0B,CAC9B,OACA,oBACA,cACA,mBACA,eACA,kBACA,SACA,SACA,UACA;AAGF,MAAa,SAAb,yBAAA,cAAA;AAAA,eAAA,SAAA;AAAA,QAAA,SAAA,cAAA;AAwCE,qBAAY,SAAS;AAAA,UAAA;AAAA,wBAAA,MAAA;AACnB,cAAA,OAAA,KAAA,MAAM;AAGN,YAAK,wBAAwB;AAG7B,YAAK,OAAO;AAGZ,YAAK,gBAAgB;AAGrB,YAAK,iBAAiB;AAMtB,YAAK,cAAc;AAnBA,aAAA;;AAxCvB,mBAAA,SAAA,CAAA;MAAA,KAAA;MAAA,OA+DE,mCAA0B,WAAW;AACnC,YAAI,KAAK,MAAM;AACb,cAAM,QAAQ,wBAAwB,OACpC,SAAC,OAAD;AAAA,mBAAW,UAAU,WAAW;;AAGlC,cACE,UAAU,UACV,CAAC,UAAU,aACX,KAAK,QAAQ,aAAa,WAC1B;AAEA,iBAAK,QAAQ,gBAAgB;AAC7B,kBAAM,KAAK;AAEX,iBAAK,OAAO,KACV,MACA,+GAEA,KAAK;;AAGT,eAAK,oBACH,OACA,KAAK,MACwB;AAE/B,eAAK,iBAAiB,KAAK;AAE3B,cAAI,MAAS;AACX,qDAAyC,KAAK;;AAGhD,cAAI,QAAO,QAAQ,CAAC,KAAK,KAAK,UAAU;AACtC,iBAAK,cAAc,WAAW;;;;OAjGtC;MAAA,KAAA;MAAA,OAuGE,4BAAmB,UAAU;AAI3B,YAAM,MAAM,KAAK,QAAQ,aAAa;AACtC,YAAI,KAAK;AACP,mBAAS,cAAc,KAAK,KAAK,IAAI,KAAK,aAAa,KAAK;eACvD;AACL,cAAM,SAAS,KAAK,QAAQ,aAAa;AACzC,cAAI,CAAC,QAAQ;AACX;;AAGF,cAAM,YAAY,MAAM,KAAK;AAE7B,cAAI,WAAW;AACb,qBAAS,cAAc,KAAK,KAAK,IAC/B,KAAK,aACL,UAAU,IACV;;;;OA1HV;MAAA,KAAA;MAAA,OAiIE,2BAAkB,QAAQ;AACxB,eAAO,oBAAoB;;OAlI/B;MAAA,KAAA;MAAA,OA0IE,uBAAc;AACZ,YAAI,KAAK,MAAM;AACb,iBAAO,KAAK;;AAId,aAAK,wBAAwB,CAAC,KAAK,QAAQ,aAAa;AAGxD,YAAM,iBAAiB,KAAK,QAAQ,aAAa;AACjD,YAAI,gBAAgB;AAClB,eAAK,OAAO,oBAAoB,KAAK,SAAS;;AAEhD,aAAK,OAAO,KAAK,QAAQ,IAAI;AAC7B,aAAK,KAAK,aAAa,YAAY;AACnC,YAAI,KAAK,QAAQ,IAAI;AACnB,eAAK,KAAK,aAAa,cAAc,KAAK,QAAQ;;AAKpD,YAAI,KAAK,QAAQ,aAAa,WAAW,OAAO;AAC9C,eAAK,QAAQ,gBAAgB;AAC7B,eAAK,OAAO,MACV,MACA;;AAOJ,aAAK,oBAA4C;AACjD,aAAK,oBAAoB,yBAAyB,KAAK;AACvD,aAAK,iBAAiB,KAAK;AAC3B,YAAI,MAAS;AACX,mDAAyC,KAAK;;AAEhD,aAAK,iBAAiB,KAAK,MAAM;AACjC,iCAAyB,KAAK,SAAS,KAAK;AAE5C,YAAI,CAAC,gBAAgB;AACnB,eAAK,QAAQ,YAAY,KAAK;;AAEhC,eAAO,KAAK;;OAtLhB;MAAA,KAAA;MAAA,OAgME,6BAAoB,MAAM;AAAA,YAAA,SAAA;AACxB,YAAA,OAA2B;AAIzB;;AAEF,YAAI,CAAC,KAAK,MAAM;AACd;;AAGF,YAAI,KAAK,QAAQ,aAAa,kBAAkB;AAC9C;;AAGF,YAAM,QACJ,KAAK,QAAQ,aAAa,YAAY,KAAK,KAAK,aAAa;AAC/D,YAAI,OAAO;AACT;;AAIF,YAAM,SAAS,KAAK,QAAQ,aAAa;AACzC,YAAI,CAAC,UAAU,iBAAiB,KAAK,SAAS;AAC5C;;AAGF,YAAA,wBAAgB,KAAK,QAAQ,iBAAtB,QAAP,sBAAO;AACP,YAAI,CAAC,KAAK,gBAAgB,QAAQ;AAChC;;AAGF,YAAM,gBAAgB,KAAK,cAAc;AAEzC,YAAM,QAAK,iBAAkB,gBAAlB,SAAsC,QAAtC;AACX,YAAI,cAAc,QAAQ;AAE1B,YAAI,KAAK,gBAAgB,OAAO,OAAO;AACrC,cAAM,QAAQ,KAAK,MAAO,QAAQ,MAAO;AACzC,wBAAc,KAAK,IAAI,OAAO,OAAO;;AAGvC,YAAM,iBAAiB,QAAQ;AAE/B,YAAI,MAAM;AACR,eAAK,KAAK,aAAa,SAAS;eAC3B;AACL,eAAK,cAAc,WAAM;AACvB,mBAAK,KAAK,aAAa,SAAS;;;AAGpC,aAAK,cAAc;;OAnPvB;MAAA,KAAA;MAAA,OA2PE,yBAAgB,UAAU;AACxB,YAAI,CAAC,KAAK,KAAK,aAAa,UAAU;AACpC,iBAAO;;AAET,eAAO,WAAW,KAAK;;OA/P3B;MAAA,KAAA;MAAA,OAmQE,qCAA4B;AAC1B,eAAO;;OApQX;MAAA,KAAA;MAAA,OAwQE,yBAAgB;AAAA,YAAA,SAAA;AACd,YAAM,cAAc,CAAC,CAAC,KAAK;AAC3B,YAAM,MAAM,KAAK;AACjB,YAAI,CAAC,aAAa;AAChB,iBAAO,KAAK,QAAQ,WAAM;AACxB,mBAAK,cAAc,WAAW;AAC9B,mBAAK;AACL,mBAAK;;AAEP,iBAAO,KAAK,SAAS,SAAC,QAAW;AAC/B,mBAAK,cAAc,WAAW,OAAO;AACrC,mBAAK;;;AAGT,YAAI,IAAI,UAAU;AAChB,eAAK,cAAc,WAAW;AAC9B,eAAK;AACL,eAAK;eACA;AACL,eAAK,cAAc,WAAW;;;OA3RpC;MAAA,KAAA;MAAA,OAgSE,2BAAkB;AAIhB,YAAM,MAAM,KAAK;AACjB,YAAI,OAAO,CAAC,IAAI,UAAU;AACxB,cAAI,MACF;AACF,wBAAc;AACd,eAAK,OAAO;;;OAzSlB;MAAA,KAAA;MAAA,OA8SE,wBAAe;AACb,YAAM,MAAM,MAAM,cAAc,KAAK;AACrC,YAAI,UAAU;;OAhTlB;MAAA,KAAA;MAAA,OAoTE,0BAAiB;AAAA,YAAA,SAAA;AACf,aAAK;AACL,YAAM,MAAM,MAAM,cAAc,KAAK;AACrC,aAAK,gBAAgB,OAAO,KAAK,QAAQ,WAAA;AAAA,iBAAM,OAAK;;AACpD,aAAK,iBAAiB,OAAO,KAAK,SAAS,WAAA;AAAA,iBAAM,OAAK;;AACtD,YAAA,yBAAgB,KAAK,QAAQ,iBAAtB,QAAP,uBAAO;AACP,YAAI,SAAS,GAAG;AACd,iBAAO;;AAET,eAAO,KAAK,YAAY;;OA7T5B;MAAA,KAAA;MAAA,OAiUE,4BAAmB;AACjB,YAAI,QAAO,MAAM;AAGf;;AAGF,YAAI,KAAK,gBAAgB;AACvB,eAAK;AACL,eAAK,iBAAiB;;AAExB,YAAI,KAAK,eAAe;AACtB,eAAK;AACL,eAAK,gBAAgB;;AAMvB,YAAM,MAAM,KAAK;AACjB,YAAI,OAAO,CAAC,IAAI,UAAU;AACxB,cAAI,MACF;AACF,wBAAc;AACd,eAAK,OAAO;;AAGd,eAAO;;OA5VX;MAAA,KAAA;MAAA,OAgWE,gCAAuB;AACrB,YAAM,cAAc,KAAK;AACzB,YACE,eACA,YAAY,UAAU,SAAS,iCAC/B;AACA,6BAAmB,aAAa;YAAC,WAAW;;eACvC;AACL,eAAK,kBAAkB;;;OAxW7B;MAAA,KAAA;MAAA,OA+WE,4BAAmB;AACjB,YACE,CAAC,KAAK,yBACN,KAAK,KAAK,UAAU,SAAS,oBAC7B;AACA,eAAK,KAAK,UAAU,OAAO;AAC3B,eAAK,eAAe;;;OArX1B;MAAA,KAAA;MAAA,OA6XE,8BAAqB;AACnB,YAAI,KAAK,uBAAuB;AAC9B,eAAK,KAAK,UAAU,IAAI;AACxB,eAAK,eAAe;AAGpB,eAAK,kBAAkB;AACvB,eAAK,wBAAwB;;;OApYnC;MAAA,KAAA;MAAA,OAiZE,0BAAiB,eAAe;AAC9B,iBAAW,OAAO,cAAc,SAAS;AACvC,cAAI,CAAE,QAAO,KAAK,QAAQ,UAAU;AAClC,mBAAO,cAAc,QAAQ;;;AAIjC,iBAAW,QAAO,KAAK,QAAQ,SAAS;AACtC,cAAI,KAAI,WAAW,cAAc,SAAQ,WAAW;AAClD;;AAEF,cAAI,cAAc,QAAQ,UAAS,KAAK,QAAQ,QAAQ,OAAM;AAC5D,0BAAc,QAAQ,QAAO,KAAK,QAAQ,QAAQ;;;;QA7Z1D,CAAA;MAAA,KAAA;MAAA,OAEE,cAAY;AACV,eAAA;;OAHJ;MAAA,KAAA;MAAA,OAOE,4BAA0B;AACxB,eAAO;;OARX;MAAA,KAAA;MAAA,OAYE,uBAAqB;AACnB,eAAO;;OAbX;MAAA,KAAA;MAAA,OAiBE,wBAAsB,SAAS;AAC7B,YAAM,MAAM,QAAQ,aAAa;AACjC,YAAI,KAAK;AACP,iBAAO,CAAC;;AAMV,YAAM,SAAS,QAAQ,aAAa;AACpC,YAAI,QAAQ;AAEV,cAAM,YAAY,MAAM,KAAK;AAE7B,cAAI,WAAW;AACb,mBAAO,CAAC,UAAU;;;AAItB,eAAO;;;AApCX,WAAA;IAA4B;AAuarB,sBAAoB,KAAK;AAC9B,oBAAgB,KAAK,MAAK;;;;;;;;;;;;;;;;;;;;;;;;;;ACjc5B,MAAa,OAAb,2BAAA;AAQE,mBAAY,KAAK,SAAS,kBAAkB;AAAA,UAAA,QAAA;AAAA,wBAAA,MAAA;AAC1C,WAAK,SAAS,SAAS,SAAS;AAGhC,WAAK,WAAW;AAGhB,WAAK,gBAAgB,oBAAoB;AAGzC,WAAK,aAAa;AAGlB,WAAK,YAAY;AAGjB,WAAK,WAAW;AAMhB,WAAK,aAAa,WAAM;AACtB,cAAK;;;AA/BX,mBAAA,OAAA,CAAA;MAAA,KAAA;MAAA,OAuCE,qBAAY;AACV,eAAO,KAAK,cAAc;;OAxC9B;MAAA,KAAA;MAAA,OAwDE,kBAAS,WAAW;AAClB,YAAI,QAAQ,aAAa,KAAK;AAC9B,YAAI,KAAK,YAAY,QAAQ,IAAI;AAG/B,kBAAQ;;AAGV,YAAM,WAAW,KAAK,QAAQ;AAG9B,YAAI,CAAC,KAAK,eAAe,WAAW,KAAK,YAAY,KAAK;AACxD,eAAK;AACL,eAAK,YAAY;AACjB,eAAK,aAAa,KAAK,OAAO,MAAM,KAAK,YAAY;AAErD,iBAAO;;AAGT,eAAO;;OA3EX;MAAA,KAAA;MAAA,OAiFE,iBAAQ;AACN,aAAK,aAAa;AAClB,aAAK,YAAY;AACjB,aAAK,WAAW;AAChB,aAAK;AACL,aAAK,WAAW;;OAtFpB;MAAA,KAAA;MAAA,OA4FE,kBAAS;AACP,YAAI,KAAK,aAAa;AACpB,eAAK,OAAO,OAAO,KAAK;AACxB,eAAK,aAAa;;;;AA/FxB,WAAA;;;;;;;;;;;;;;;;;;;;;;;;;;ACKA,MAAM,OAAM;AACZ,MAAM,mBAAmB;AAOzB,MAAa,kBAAb,2BAAA;AAIE,8BAAY,QAAQ;AAAA,UAAA,QAAA;AAAA,wBAAA,MAAA;AAElB,WAAK,UAAU;AAGf,WAAK,MAAM,OAAO;AAGlB,WAAK,aAAa;AAGlB,WAAK,qBAAqB;AAG1B,WAAK,QAAQ,IAAI,KAAK,KAAK,KAAK,KAAK,QAAQ,KAAK,OAAO;AAGzD,WAAK,kBAAkB,IAAI;AAG3B,WAAK,iBAAiB,IAAI;AAG1B,WAAK,sBAAsB;AAE3B,UAAM,QAAQ,SAAS,SAAS,KAAK;AACrC,YAAM,sBAAsB;AAG5B,UAAI,QAAQ,KAAK,KAAK,WAAW,UAAU;AACzC,eAAO,oBAAoB,WAAM;AAC/B,kBAAQ,OAAO;iBACR,gBAAgB;AACnB,oBAAK,WAAW,QAAQ,SAAC,GAAD;AAAA,uBAAO,EAAE;;AACjC;iBACG,gBAAgB;AACnB,oBAAK,WAAW,QAAQ,SAAC,GAAD;AAAA,uBAAO,EAAE;;AACjC,oBAAY;AACZ;;;;AAMR,WAAK,yBAAyB;AAG9B,WAAK,iBAAiB;AAEtB,WAAK,QAAQ,YAAY,KAAK,WAAM;AAClC,cAAK,iBAAiB;AACtB,cAAK;AACL,cAAY,aAAa;;;AAxD/B,mBAAA,kBAAA,CAAA;MAAA,KAAA;MAAA,OA6DE,mBAAU;AACR,aAAK,WAAW,QAAQ,SAAC,GAAD;AAAA,iBAAO,EAAE;;AACjC,aAAK,WAAW,SAAS;AACzB,YAAI,KAAK,qBAAqB;AAC5B,eAAK,oBAAoB;AACzB,eAAK,sBAAsB;;;OAlEjC;MAAA,KAAA;MAAA,OAuEE,eAAM;AACJ,eAAO,KAAK,WAAW,MAAM;;OAxEjC;MAAA,KAAA;MAAA,OA4EE,sBAAY;AACV,eAAO,KAAK;;OA7EhB;MAAA,KAAA;MAAA,OAiFE,+BAAsB,SAAS;AAC7B,eAAO,SAAS,WAAW;;OAlF/B;MAAA,KAAA;MAAA,OAsFE,uCAA8B,SAAS;AACrC,eAAO,SAAS,mBAAmB;;OAvFvC;MAAA,KAAA;MAAA,OA2FE,8BAAqB;AACnB,eAAO;;OA5FX;MAAA,KAAA;MAAA,OAgGE,aAAI,SAAS;AACX,YAAM,WAAW,IAAI,SAAS,EAAE,KAAK,oBAAoB,SAAS;AAClE,aAAK,WAAW,KAAK;AACrB,cAAM,KAAK,MAAK,mBAAmB,SAAS;;OAnGhD;MAAA,KAAA;MAAA,OAuGE,kBAAS,SAAS;AAChB,YAAM,WAAW,SAAS,WAAW;AACrC,aAAK,uBAAuB,KAAK;AACjC,aAAK;;OA1GT;MAAA,KAAA;MAAA,OA8GE,iBAAO,SAAS;AACd,YAAM,WAAW,SAAS,mBAAmB;AAC7C,YAAI,CAAC,UAAU;AACb;;AAEF,YAAI,KAAK,qBAAqB;AAC5B,eAAK,oBAAoB,UAAU;;AAErC,YAAM,QAAQ,KAAK,WAAW,QAAQ;AACtC,YAAI,UAAU,IAAI;AAChB,eAAK,WAAW,OAAO,OAAO;;AAEhC,cAAM,KAAK,MAAK,oBAAoB,SAAS;;OA1HjD;MAAA,KAAA;MAAA,OA8HE,iCAAwB,gBAAgB;AACtC,aAAK,MAAM;;OA/Hf;MAAA,KAAA;MAAA,OAmIE,sBAAa,WAAW;AACtB,eAAO,KAAK,MAAM,SAAS;;OApI/B;MAAA,KAAA;MAAA,OAwIE,mCAA0B,gBAAgB,kBAAkB;;OAxI9D;MAAA,KAAA;MAAA,OA2IE,6BAAoB;;OA3ItB;MAAA,KAAA;MAAA,OA8IE,oBAAW,UAAU;AACnB,aAAK,gBAAgB,IAAI;;OA/I7B;MAAA,KAAA;MAAA,OAmJE,2BAAkB;;OAnJpB;MAAA,KAAA;MAAA,OAsJE,8BAAqB,eAAe,yBAAyB;;OAtJ/D;MAAA,KAAA;MAAA,OA2JE,wBAAe,mBAAmB;;OA3JpC;MAAA,KAAA;MAAA,OA8JE,8BAAqB;;OA9JvB;MAAA,KAAA;MAAA,OAmKE,yBAAgB;AACd,eAAO,KAAK,eAAe;;OApK/B;MAAA,KAAA;MAAA,OA0KE,mBAAU;AACR,YAAM,MAAM,KAAK;AACjB,cAAM,KAAK,MAAK;AAEhB,aAAK,WAAW,QAAQ,SAAC,UAAa;AACpC,cAAI,CAAC,SAAS,qBAAqB,SAAS,QAAQ,MAAM;AACxD;;AAEF,mBAAS;;AAGX,aAAK,WAAW,QAAQ,SAAC,UAAa;AACpC,cACE,CAAC,SAAS,QAAQ,QAClB,SAAS,eAAe,cAAc,oBACtC,SAAS,eACT;AACA,qBAAS,gBAAgB;AACzB,qBAAS;;;AAIb,aAAK,QAAQ,UAAU,OAAO;AAC9B,aAAK,gBAAgB;AACrB,aAAK,eAAe;;OAlMxB;MAAA,KAAA;MAAA,OA0ME,gCAAuB;AAAA,YAAA,SAAA;AACrB,iBAAS,IAAI,KAAK,uBAAuB,SAAS,GAAG,KAAK,GAAG,KAAK;AAChE,cAAM,WAAW,KAAK,uBAAuB;AAC7C,cACE,KAAK,kBACL,2BAA2B,SAAS,SAAS,KAAK,QAAQ,gBAC1D;AACA,iBAAK,uBAAuB,OAAO,GAAG;AACtC,qBAAS,QAAQ,KAAK,WAAA;AAAA,qBAAM,OAAY;;AACxC,kBAAM,KAAK,MAAK,sBAAsB,SAAS;;;;;AAnNvD,WAAA;;AA4NO,+CAA6C,QAAQ;AAC1D,iCAA6B,QAAQ,aAAa;;;;;;;;;;;;;;;;;;;;;;;;;;AC3OpD,MAAM,QAAO;AAEb,MAAM,6BAA6B;AACnC,MAAM,iBAAiB;AAMvB,MAAa,QAAb,2BAAA;AAIE,oBAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,MAAM;AAGX,WAAK,kBAAkB,KAAK,WAAW,KAAK;AAG5C,WAAK,oBAAoB,KAAK,aAAa,KAAK;AAGhD,WAAK,oBAAoB;AAGzB,WAAK,sBAAsB;AAG3B,WAAK,uBAAuB;AAG5B,WAAK,YACH,kBAAkB,OACjB,IAAI,UAAU,sBAAsB,UACnC,IAAI,UAAU,oBAAoB,KACpC,IAAI,qBAAqB;AAC3B,YAAM,KAAK,OAAM,mBAAmB,KAAK;AAGzC,WAAK,kBAAkB;AACvB,WAAK,IAAI,SAAS,iBAAiB,WAAW,KAAK;AACnD,WAAK,IAAI,SAAS,iBAAiB,aAAa,KAAK;AAGrD,WAAK,YAAY;AAGjB,WAAK,4BAA4B;AAGjC,WAAK,2BAA2B,IAAI;AAGpC,WAAK,2BAA2B,IAAI;AAGpC,WAAK,2BAA2B,IAAI;AAIpC,UAAI,KAAK,WAAW;AAClB,aAAK,YAAY,CAAC,KAAK;AACvB,aAAK,oBACH,KAAK,aAAa,KAAK;AAEzB,mBAAW,IAAI,UAAU,aAAa,KAAK;;;AA1DjD,mBAAA,QAAA,CAAA;MAAA,KAAA;MAAA,OAkEE,+BAAsB,QAAQ;AAAA,YAAA,QAAA;AAC5B,aAAK,gBAAgB,SAAC,UAAa;AACjC,gBAAK,kBAAkB,QAAQ,kBAAkB;WAChD;AACH,aAAK,gBAAgB,SAAC,UAAa;AACjC,gBAAK,kBAAkB,QAAQ,kBAAkB;WAChD;AACH,aAAK,uBAAuB,SAAC,QAAW;AACtC,gBAAK,kBAAkB,QAAQ,4BAA4B;WAC1D;;OA3EP;MAAA,KAAA;MAAA,OAkFE,2BAAkB;AAChB,eAAO,KAAK;;OAnFhB;MAAA,KAAA;MAAA,OA4FE,yBAAgB,SAAS,qBAAqB;AAC5C,YAAI,qBAAqB;AACvB,kBAAQ,KAAK;;AAEf,eAAO,KAAK,yBAAyB,IAAI;;OAhG7C;MAAA,KAAA;MAAA,OAuGE,2BAAkB;AAChB,eAAO,KAAK;;OAxGhB;MAAA,KAAA;MAAA,OAiHE,yBAAgB,SAAS,qBAAqB;AAC5C,YAAI,qBAAqB;AACvB,kBAAQ,KAAK;;AAEf,eAAO,KAAK,yBAAyB,IAAI;;OArH7C;MAAA,KAAA;MAAA,OA4HE,4BAAmB;AACjB,eAAO,KAAK;;OA7HhB;MAAA,KAAA;MAAA,OAsIE,gCAAuB,SAAS,qBAAqB;AACnD,YAAI,qBAAqB;AACvB,kBAAQ,KAAK;;AAEf,eAAO,KAAK,yBAAyB,IAAI;;OA1I7C;MAAA,KAAA;MAAA,OAmJE,2BAAkB,QAAQ,OAAO,IAAI;AAAA,YAAA,SAAA;AACnC,eAAO,kBAAkB,KAAK,SAAC,MAAS;AACtC,cAAM,QAAQ,SAAgB,SAAS,OAAK;AAC5C,gBAAM,OAAO,WAAM;AACjB,iBAAK,UAAU,OAAO,OAAO;;;;OAvJrC;MAAA,KAAA;MAAA,OAgKE,oBAAW,GAAG;AACZ,YAAI,KAAK,iBAAiB;AACxB;;AAGF,YAAI,EAAE,kBAAkB;AACtB;;AAIF,YAAO,SAAU,EAAV;AACP,YACE,UACC,QAAO,WAAW,WACjB,OAAO,WAAW,cAClB,OAAO,WAAW,YAClB,OAAO,WAAW,YAClB,OAAO,aAAa,qBACtB;AACA;;AAGF,aAAK,kBAAkB;AACvB,aAAK,yBAAyB,KAAK;AACnC,cAAM,KAAK,OAAM;;OAxLrB;MAAA,KAAA;MAAA,OA4LE,wBAAe;AACb,YAAI,CAAC,KAAK,iBAAiB;AACzB;;AAEF,aAAK,kBAAkB;AACvB,aAAK,yBAAyB,KAAK;AACnC,cAAM,KAAK,OAAM;;OAlMrB;MAAA,KAAA;MAAA,OA0ME,sBAAa,GAAG;AAAA,YAAA,SAAA;AAEd,YAAI,EAAE,sBAAsB,EAAE,mBAAmB,kBAAkB;AACjE,eAAK;AACL,iBAAO;;AAET,YAAI,CAAC,KAAK,sBAAsB;AAC9B,eAAK,uBAAuB,KAAK,gBAAgB,KAAK;AACtD,eAAK,sBAAsB,KAAK,eAAe,KAAK;;AAKtD,YAAI;AACJ,YAAM,gBAAgB,kBACpB,KAAK,IAAI,UACT,SACc,QACd,SAAC,YAAe;AACd,qBAAW;;AAGf,eAAO,SAAS,SAAS,KAAK,KAC3B,eAAe,gBAAgB,eAC/B,KAAK,KAAK,qBAAqB,WAAM;AACpC,cAAI,UAAU;AACZ;;AAEF,iBAAK;;;OAtOb;MAAA,KAAA;MAAA,OA2OE,2BAAkB;AAChB,aAAK,YAAY;AACjB,aAAK,yBAAyB,KAAK;AACnC,cAAM,KAAK,OAAM;;OA9OrB;MAAA,KAAA;MAAA,OAkPE,0BAAiB;AAEf,aAAK;AACL,YAAI,KAAK,6BAA6B,4BAA4B;AAChE,qBACE,KAAK,IAAI,UACT,aACiC,KAAK;eAEnC;AACL,gBAAM,KAAK,OAAM;;;;AA5PvB,WAAA;;AAoQO,+BAA6B,KAAK;AACvC,2BAAuB,KAAK,SAAS;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MChRjC,YAAA,yBAAA,cAAA;;;;;;;;;aAOJ,2BAAkB,QAAQ;AACxB,eAAO,UAAU,OAAO,aAAa,oBAAoB;;;;aAI3D,yBAAgB;AACd,YAAI,KAAK,eAAe,OAAO,WAAW;AACxC;;AAEF,YAAM,YAAY,KAAK,IAAI,SAAS,cAAc;AAClD,aAAK,iBAAiB;AACtB,aAAK,oBAAoB,QAAQ,SAAC,OAAU;AAC1C,oBAAU,YAAY;;AAExB,aAAK,QAAQ,YAAY;;;;aAnB3B,4BAA0B;AACxB,eAAO;;;;IAHa;AA4BjB,yBAAuB,KAAK;AACjC,oBAAgB,KAAK,cAAc;;;;ACHrC,MAAM,oBAAoB,IAAI;AAG9B,MAAM,oBAAoB,IAAI;;;ACrB9B,MAAM,yBAAyB,MAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACDtC,oBAAkB,WAAU;AAC1B,WACE,QAAQ,aAAY,YAAW,CAAC;;AAQpC,MAAa,aAAb,2BAAA;AAIE,yBAAY,QAAQ;AAAA,wBAAA,MAAA;AAElB,WAAK,aAAa,SAAS,gBAAgB;;AAN/C,mBAAA,aAAA,CAAA;MAAA,KAAA;MAAA,OAUE,kBAAS,SAAS,OAAO;AACvB,iBAAS,SAAS,SAAS;;OAX/B;MAAA,KAAA;MAAA,OAeE,yBAAgB,eAAe,aAAa;AAC1C,aAAK,wCACH,KAAK,WAAW,sBAAsB,gBACzB,OACb,SAAS;;OAnBf;MAAA,KAAA;MAAA,OAwBE,wBAAe,eAAe,aAAa;AACzC,aAAK,wCACH,KAAK,WAAW,sBAAsB,gBACzB,MACb,SAAS;;OA5Bf;MAAA,KAAA;MAAA,OAiCE,uBAAc,eAAe,aAAa;AACxC,YAAM,iBAAiB,KAAK,WAAW,sBAAsB;AAC7D,sBAAc,SAAS;AAEvB,aAAK,yBAAyB,gBAAgB,aAAa,SAAC,UAAa;AACvE,mBAAS;;;OAtCf;MAAA,KAAA;MAAA,OA2CE,wBAAe,eAAe,aAAa;AACzC,YAAM,iBAAiB,KAAK,WAAW,sBAAsB;AAC7D,sBAAc,SAAS;AAEvB,aAAK,yBAAyB,gBAAgB,aAAa,SAAC,UAAa;AACvE,mBAAS;;;OAhDf;MAAA,KAAA;MAAA,OAqDE,0BAAiB,eAAe,aAAa;AAC3C,YAAM,iBAAiB,KAAK,WAAW,sBAAsB;AAC7D,sBAAc,SAAS;AAEvB,aAAK,yBAAyB,gBAAgB,aAAa,SAAC,UAAa;AACvE,mBAAS;;;OA1Df;MAAA,KAAA;MAAA,OA+DE,uBAAc,SAAS,oBAAoB;AACzC,YAAM,WAAW;AACjB,aAAK,6BAA6B,SAAS,SAAC,UAAa;AACvD,mBAAS,KAAK,SAAS,QAAQ;;AAEjC,eAAO,QAAQ,IAAI;;OApEvB;MAAA,KAAA;MAAA,OA8EE,kCAAyB,gBAAgB,WAAU,UAAU;AAC3D,iBAAA,YAAA,iCAAsB,YAAtB,OAAA,CAAA,SAAA,aAAA,QAAgC;AAAA,cAArB,UAAqB,MAAA;AAC9B,oBAAU,eAAe,QAAQ,SAAS;AAC1C,eAAK,6BAA6B,SAAS;;;OAjFjD;MAAA,KAAA;MAAA,OAyFE,sCAA6B,SAAS,UAAU;AAE9C,YAAI,QAAQ,UAAU,SAAS,sBAAsB;AACnD,mBAAS,KAAK,WAAW,sBAAsB;AAE/C,cAAM,cAAc,QAAQ;AAC5B,cAAI,aAAa;AACf,iBAAK,6BAA6B,aAAa;;eAE5C;AACL,cAAM,cAAc,QAAQ,uBAAuB;AACnD,cAAM,OAAO;AACb,mBAAS,IAAI,GAAG,IAAI,YAAY,QAAQ,KAAK;AAC3C,gBAAM,aAAa,YAAY;AAC/B,gBAAI,UAAU;AACd,qBAAS,IAAI,GAAG,IAAI,KAAK,QAAQ,KAAK;AACpC,kBAAI,KAAK,GAAG,SAAS,aAAa;AAChC,0BAAU;AACV;;;AAGJ,gBAAI,CAAC,SAAS;AACZ,mBAAK,KAAK;AACV,uBAAS,KAAK,WAAW,sBAAsB;;;;;OAhHzD;MAAA,KAAA;MAAA,OA8HE,iDAAwC,gBAAgB,QAAQ,aAAa;AAC3E,aAAK,yBAAyB,gBAAgB,aAAa,SAAC,UAAa;AACvE,mBAAS,QAAQ,aAAa,eAAe;;;;AAhInD,WAAA;;AAwIO,sCAAoC,QAAQ;AACjD,iCAA6B,QAAQ,UAAU;;;;ACxJjD,MAAM,OAAM;AAQL,uBAAqB,KAAK,KAAK,gBAAgB;AAEpD,QAAI,kBAAkB,mBAAmB,eAAe;AACtD,aAAO,MAAM,MAAK,kCAAkC;;AAGtD,WAAO,mBAAmB,gBACtB,sBAAsB,KAAK,OAC3B,iBAAiB,KAAK;;AAQ5B,iCAA+B,KAAK,KAAK;AACvC,QAAI,6BAA6B;AAC/B,aAAO,iBAAiB,KAAK,KAAK;WAC7B;AAGL,UAAM,SAAS,4BACa,IAAI,UAC9B,UACA,KAAK;QACH,OAAO;QACP,SAAS;;AAGb,aAAO,SAAS,WAAM;AACpB,yBAAiB,OAAO,eAAe;;AAEzC,UAAI,SAAS,KAAK,YAAY;AAC9B,aAAO;;;AAUX,4BAA0B,KAAK,KAAK,YAAoB;AAAA,QAApB,eAAoB,QAAA;AAApB,mBAAa;;AAC/C,QAAM,SAAQ,gBAAgB,SAAS;AACvC,QAAM,QAAQ,IAAI;AAClB,QAAI,YAAY;AACd,YAAM,iBAAiB;;AAEzB,UAAM,MAAM;AACZ,WAAO;;AAST,uCAAqC;AACnC,WAAO,oBAAoB,MAAM;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrEnC,MAAM,QAAM;AAKZ,MAAa,WAAb,yBAAA,cAAA;AAAA,eAAA,WAAA;AAAA,QAAA,SAAA,cAAA;AAEE,uBAAY,SAAS;AAAA,UAAA;AAAA,wBAAA,MAAA;AACnB,cAAA,OAAA,KAAA,MAAM;AAGN,YAAK,kBAAkB;AAJJ,aAAA;;AAFvB,mBAAA,WAAA,CAAA;MAAA,KAAA;MAAA,OAUE,2BAAkB,cAAc;AAE9B,eAAO;;OAZX;MAAA,KAAA;MAAA,OAgBE,yBAAgB;AAEd,aAAK,QAAQ,aAAa,eAAe;AAGzC,aAAK,kBAAkB,KAAK,QAAQ,aAAa;AACjD,YAAI,KAAK,iBAAiB;AAIxB,qBACE,KAAK,mBAAmB,eACrB,QAAH,uCAA2C,KAAK,kBAAhD;;AAIJ,YACE,KAAK,QAAQ,aAAa,oBAC1B,KAAK,QAAQ,cAAc,QAC3B;AACA,gBAAM,KAAK,OAAK;AAChB;;AAGF,aAAK,YAAY,mBAAmB,KAAK,KAAK,SAAS,KAAK;;OAxChE;MAAA,KAAA;MAAA,OAgDE,oBAAW;AAAA,YAAA,SAAA;AACT,YAAI,KAAK,iBAAiB;AAExB,gBAAM,MAAM,OAAK;AACjB,iBAAO,KAAK;;AAId,aAAK,kBAAkB,SAAS,SAAS,KAAK,KAC3C,QAAQ,GACR,KAAK,WAAM;AACV,cAAM,MAAM,OAAK,QAAQ,aAAa;AACtC,cAAI,CAAC,KAAK;AACR;;AAEF,iBAAO,SAAS,sBAAsB,OAAK,SACxC,eAAe,OAAK,cAAc,MAClC,KAAK,SAAC,MAAQ;AACb,gBAAI,CAAC,OAAK,KAAK;AACb;;AAEF,gBAAM,QAAQ,YAAY,OAAK,KAAK,MAAK,OAAK;AAC9C,kBAAM,KAAK,OAAK,qBAAqB;AACrC,mBAAO;;;;OAvEnB;MAAA,KAAA;MAAA,OAiFE,uBAAc,KAAK;AACjB,mBACE,uBAAuB,KAAK,MAC5B,sFAEE;AAEJ,eAA8B;;;AAxFlC,WAAA;IAA8B;AA+FvB,wBAAsB,KAAK;AAChC,oBAAgB,KAAK,OAAK;;;;;;;;;;;;;;;;;;;;;;;;;;ACrG5B,MAAa,WAAb,2BAAA;AAIE,uBAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,aAAwC,IAAI;AAGjD,WAAK,OAAO;;AAThB,mBAAA,WAAA,CAAA;MAAA,KAAA;MAAA,OAgBE,qBAAY;AACV,eAAO,WAAW,KAAK,KAAK,WAAW;;OAjB3C;MAAA,KAAA;MAAA,OAwBE,iBAAQ;AACN,eAAO,oBAAoB,KAAK,KAAK,WAAW;;OAzBpD;MAAA,KAAA;MAAA,OAgCE,oBAAW;AACT,eACE,UAAU,KAAK,KAAK,WAAW,cAC/B,CAAC,KAAK,cACN,CAAC,KAAK,UACN,CAAC,KAAK,YACN,CAAC,KAAK,eACN,CAAC,KAAK;;OAvCZ;MAAA,KAAA;MAAA,OA+CE,oBAAW;AAET,eACE,gBAAgB,KAAK,KAAK,WAAW,cACrC,CAAC,KAAK,YACN,CAAC,KAAK;;OApDZ;MAAA,KAAA;MAAA,OA4DE,qBAAY;AACV,eAAO,iBAAiB,KAAK,KAAK,WAAW,cAAc,CAAC,KAAK;;OA7DrE;MAAA,KAAA;MAAA,OAoEE,mBAAU;AAIR,eAAO,qBAAqB,KAAK,KAAK,WAAW;;OAxErD;MAAA,KAAA;MAAA,OA+EE,iBAAO;AACL,YAAA,OAAY;AACV,iBAAO;;AAET,eAAO,yBAAyB,KAAK,KAAK,WAAW;;OAnFzD;MAAA,KAAA;MAAA,OA0FE,kBAAS;AACP,eAAO,QAAQ,KAAK,KAAK,WAAW;;OA3FxC;MAAA,KAAA;MAAA,OAkGE,qBAAW;AACT,eAAO,UAAU,KAAK,KAAK,WAAW,cAAc,CAAC,KAAK;;OAnG9D;MAAA,KAAA;MAAA,OA0GE,qBAAY;AACV,eAAO,WAAW,KAAK,KAAK,WAAW;;OA3G3C;MAAA,KAAA;MAAA,OAkHE,wBAAe;AACb,eACG,KAAK,WAAW,KAAK,WAAW,cAChC,KAAK,cACJ,KAAK,KAAK,WAAW,8BAA8B;;OAtH3D;MAAA,KAAA;MAAA,OA8HE,iBAAQ;AACN,eAAO,OAAO,KAAK,KAAK,WAAW;;OA/HvC;MAAA,KAAA;MAAA,OAsIE,2BAAkB;AAChB,YAAI,KAAK,YAAY;AACnB,iBAAO,KAAK,UACR,KAAK,wBAAwB,IAC7B,KAAK,kBAAkB,oBAAoB;;AAEjD,YAAI,KAAK,YAAY;AACnB,iBAAO,KAAK,kBAAkB,yBAAyB;;AAEzD,YAAI,KAAK,aAAa;AACpB,iBAAO,KAAK,kBAAkB,0BAA0B;;AAE1D,YAAI,KAAK,WAAW;AAClB,iBAAO,KAAK,kBAAkB,4BAA4B;;AAE5D,YAAI,KAAK,QAAQ;AACf,iBAAO,KAAK,kBAAkB,eAAe;;AAE/C,YAAI,KAAK,UAAU;AACjB,iBAAO,KAAK,kBAAkB,eAAe;;AAE/C,eAAO;;OA3JX;MAAA,KAAA;MAAA,OAoKE,2BAAkB,MAAM,OAAO;AAC7B,YAAI,CAAC,KAAK,WAAW,WAAW;AAC9B,iBAAO;;AAET,YAAM,MAAM,KAAK,WAAW,UAAU,MAAM;AAC5C,YAAI,CAAC,OAAO,SAAS,IAAI,QAAQ;AAC/B,iBAAO;;AAET,eAAO,SAAS,IAAI,QAAQ;;OA5KhC;MAAA,KAAA;MAAA,OAqLE,+BAAsB;AACpB,YAAI,CAAC,KAAK,WAAW,WAAW;AAC9B,iBAAO;;AAET,YAAI,CAAC,KAAK,SAAS;AACjB,iBAAO;;AAET,YAAI,UAAU,KAAK,WAAW,UAAU,MACtC;AAEF,YAAI,CAAC,SAAS;AACZ,iBAAO;;AAET,kBAAU,QAAQ,GAAG,QAAQ,MAAM;AACnC,eAAO;;OAnMX;MAAA,KAAA;MAAA,OA0ME,8BAAqB;AACnB,YAAM,oBAAoB,KAAK;AAC/B,YAAI,qBAAqB,IAAI;AAC3B,iBAAO;;AAET,eAAO,OAAO,kBAAkB,MAAM,KAAK;;;AA/M/C,WAAA;;AAsNO,kCAAgC,SAAQ;AAC7C,2BAAuB,SAAQ,YAAY;;;;ACxNtC,2BAAyB,KAAK;AACnC,WAAO,IAAI,cAAc,aAAa,IAAI,cAAc;;AAQ1D,8BAA4B,KAAK;AAC/B,WAAO,IAAI,cAAc;;AAQpB,2BAAyB,KAAK,UAAU;AAC7C,oBAAgB,KAAK,iBAAiB;;AASxC,2BAAyB,KAAK,SAAS,UAAU;AAC/C,QAAI,QAAQ,QAAQ;AACpB,QAAI,OAAO;AACT,eAAS;WACJ;AACL,UAAM,gBAAgB,0BAAM;AAC1B,YAAI,QAAQ,MAAM;AAChB,cAAI,CAAC,OAAO;AACV,oBAAQ;AACR,qBAAS;;AAEX,cAAI,oBAAoB,oBAAoB;;;AAGhD,UAAI,iBAAiB,oBAAoB;;;AAStC,6BAA2B,KAAK;AACrC,WAAO,IAAI,QAAQ,SAAC,SAAY;AAC9B,sBAAgB,KAAK;;;AASlB,gCAA8B,KAAK;AACxC,WAAO,IAAI,QAAQ,SAAC,SAAY;AAC9B,sBAAgB,KAAK,oBAAoB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzD7C,MAAM,+BAA+B,MAAM;AAC3C,MAAM,wBAAwB,KAAK;AAWnC,MAAI,qBAAqB;AAQzB,iCAA+B,KAAK;AAClC,QAAI,CAAC,oBAAoB;AACvB,UAAM,UAAU,IAAI,SAAS,cAAc;AAC3C,UAAM,YAAY,QAAQ;AAC1B,cAAQ,KAAK;AACb,UAAI,CAAC,aAAa,CAAC,UAAU,UAAU;AACrC,eAAO;;AAET,2BAAqB;QACnB,YAAY,UAAU,SAAS;QAC/B,SAAS,UAAU,SAAS;QAC5B,aAAa,QAAQ,MAAM;;;AAG/B,WAAO;;AAUT,MAAa,oBAAb,2BAAA;AAIE,gCAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,YAAY,IAAI;AAGrB,WAAK,QAAQ,MAAM,cAAc,IAAI,SAAS;AAM9C,WAAK,WAAW;AAKhB,WAAK,QAAQ;AAEb,WAAK,YAAY,SAAS,YAAY;AAEtC,WAAK,SAAS,mBAAmB,IAAI,SAAS,MAAM,UAAU;AAQ9D,WAAK,YAAY,sBAAsB;AAGvC,WAAK,SAAS,SAAS,SAAS;;AAnCpC,mBAAA,oBAAA,CAAA;MAAA,KAAA;MAAA,OA0DE,aAAI,QAAQ,MAAK,oBAAoB;AAAA,YAAA,QAAA;AACnC,eAAO,mBAAmB,KAAK,WAAM;AACnC,gBAAK,KAAK,QAAQ,MAAK;;;OA5D7B;MAAA,KAAA;MAAA,OA8EE,cAAK,QAAQ,KAAK,oBAAoB;AACpC,YAAI,CAAC,KAAK,kBAAkB,MAAM;AAChC;;AAEF,YAAA,sBAAiB,mBAAmB,MAA7B,SAAP,oBAAO;AACP,YAAM,MAAM,KAAK;AACjB,YAAM,wBAAwB,KAAK,SAAS;AAC5C,YAAI,yBAAyB,MAAM,uBAAuB;AACxD,cAAI,oBAAoB;AACtB,iBAAK,SAAS,UAAU,MAAM;;AAEhC;;AAIF,YAAM,UAAU,qBACZ,+BACA;AACJ,aAAK,SAAS,UAAU,MAAM;AAG9B,YAAI;AACJ,YAAI,CAAC,KAAK,UAAU,YAAY;AAC9B,gBAAM,KAAK,UAAU,cAAc;AACnC,cAAI,aAAa,OAAO;AACxB,cAAI,aAAa,QAAQ;AACzB,eAAK,MAAM,YAAY;;AAEzB,YAAM,aAAa,KAAK,UAAU,cAAc;AAChD,mBAAW,aAAa,OAAO;AAC/B,mBAAW,aAAa,QAAQ;AAChC,mBAAW,aAAa,kBAAkB;AAC1C,aAAK,MAAM,YAAY;AAGvB,aAAK,OAAO,MAAM,WAAM;AACtB,cAAI,OAAO,IAAI,YAAY;AACzB,gBAAI,WAAW,YAAY;;AAE7B,cAAI,WAAW,YAAY;AACzB,uBAAW,WAAW,YAAY;;WAEnC;AAEH,aAAK,oBAAoB,QAAQ;;OA1HrC;MAAA,KAAA;MAAA,OA2IE,iBAAQ,QAAQ,KAAK,eAAe;AAAA,YAAA,SAAA;AAClC,YAAI,CAAC,KAAK,kBAAkB,MAAM;AAChC;;AAEF,YAAI,KAAK,MAAM,MAAM;AACnB;;AAEF,aAAK,MAAM,OAAO;AAClB,aAAK,IAAI,QAAQ,KAA8B;AAC/C,YAAI,CAAC,KAAK,UAAU,SAAS;AAC3B;;AAEF,YAAI,iBAAiB,cAAc,KAAK,UAAU,YAAY;AAM5D;;AAEF,eAAO,mBAAmB,KAAK,WAAM;AACnC,iBAAK,gBAAgB;;;OAhK3B;MAAA,KAAA;MAAA,OAyKE,yBAAgB,KAAK;AACnB,YAAM,UAAU,QAAQ,KAAK,WAAhB,oBAAA,oBAAA,6BAAA,CAAA;AAEb,gBAAQ,aAAa,QAAQ;AAQ7B,YAAI,KAAK,UAAU,aAAa;AAC9B,kBAAQ,KAAK;eACR;AACL,kBAAQ,KAAK;;AAEf,aAAK,MAAM,YAAY;;OAzL3B;MAAA,KAAA;MAAA,OAmME,2BAAkB,KAAK;AACrB,YAAI,IAAI,WAAW,aAAa,IAAI,WAAW,UAAU;AACvD,iBAAO;;AAET,eAAO;;OAvMX;MAAA,KAAA;MAAA,OA8NE,6BAAoB,QAAQ,QAAQ;AAIlC,YACE,KAAK,UAAU,cACf,CAAE,MAAK,UAAU,cAAc,KAAK,UAAU,UAC9C;AACA;;AAMF,YAAM,MAAM,KAAK;AACjB,aAAK,SAAS,UAAU,MAAM;AAS9B,YAAM,YAAY,MAAO,MAAM;AAC/B,YAAM,MACJ,SACA,2DACA;AACF,YAAM,MAAM,IAAI;AAChB,YAAI,KAAK,QAAQ,KAAK;AAEtB,YAAI,kBAAkB;AAEtB,YAAI;;;AAhQR,WAAA;;AAuQO,oCAAkC,SAAQ;AAC/C,2BAAuB,SAAQ,cAAc;;;;AC/R/C,MAAM,0BAAyB,MAAO;;;;;;;;;;;;;;;;;;;;;;;;;ACnBtC,sBAAoB,SAAS;AAC3B,WAAO,QAAQ,aAAa;;AAQvB,4CAA0C,SAAS;AACxD,QAAI,QAAQ,aAAa,cAAc;AACrC,aAAO;;AAET,WAAO,QAAQ,cAAc;;AAI/B,MAAM,QAAM;AAMZ,MAAM,aAAa;AAOnB,MAAa,kBAAb,2BAAA;AAIE,8BAAY,QAAQ;AAAA,wBAAA,MAAA;AAElB,WAAK,SAAS;AAEd,UAAM,UAAU,OAAO;AAGvB,WAAK,WAAW,SAAS,cAAc;AAGvC,WAAK,YAAY,SAAS,eAAe;AAIzC,WAAK,gBAAgB,SAAS,oBAAoB;;AAlBtD,mBAAA,kBAAA,CAAA;MAAA,KAAA;MAAA,OAyBE,yBAAgB,eAAe;AAC7B,sBAAc,gBAAgB,OAAO,KAAK,iBAAiB,KAAK;AAKhE,sBAAc,uBAAuB,QAAQ,KAAK,YAAY,KAAK;AAEnE,sBAAc,uBAAuB,QAAQ,KAAK,YAAY,KAAK;AAEnE,sBAAc,uBACZ,oBACA,KAAK,cAAc,KAAK;AAG1B,sBAAc,uBACZ,YACA,KAAK,gBAAgB,KAAK;AAG5B,sBAAc,uBAAuB,SAAS,KAAK,aAAa,KAAK;AAErE,sBAAc,uBACZ,eACA,KAAK,mBAAmB,KAAK;;OAjDnC;MAAA,KAAA;MAAA,OA6DE,0BAAiB,YAAY;AAE3B,YAAI,CAAC,WAAW,eAAe,YAAY,UAAU;AACnD,iBAAO;;AAET,YAAO,OAAsB,WAAtB,MAAM,SAAgB,WAAhB,QAAQ,OAAQ,WAAR;AACrB,YAAM,MAAM,OAAO;AACnB,gBAAQ;eACD;eACA;AACH,gBAAM,UACJ,KAAK,aAAa,KAAK,gBACO,KAAM,kBAChC,MAAM,cAAc;AAC1B,mBAAO,SAAS,iBAAiB,SAAS,KAAK,SAAC,MAAS;AACvD,yBAAW,MAAM;AACjB,qBAAO,KAAK,OAAO;;eAGlB;AACH,mBAAO,KAAK,kBAAkB;eAE3B;AACH,mBAAO,KAAK,yBAAyB;eAElC;AACH,uBAAW,KAAK,OAAO;AACvB,uBAAW,OAAO,MAAM,cACtB,UAAU,MAAM,eAAe,KAAK,QACpC;AAEF,mBAAO,KAAK,gBAAgB;eAEzB;AACH,qBAAS,cAAc,KAAK,QAAQ,OACnB,CAAC,CAAE,SAAQ,KAAK,gBAAgB;AAEjD,mBAAO;eAEJ;AACH,gBAAI;AACJ,mBAAO;eAEJ;AACH,mBAAO,SAAS,UAAU,KAAK,QAC5B,KAAK,SAAC,KAAD;AAAA,qBAAS,IAAI;eAClB,MAAM,SAAC,QAAW;AACjB,oBAAM,MAAM,OAAK,4BAA4B;;;AAGrD,cAAM,OAAO,YAAY,uBAAuB;;OA/GpD;MAAA,KAAA;MAAA,OAwHE,2BAAkB,YAAY;AAAA,YAAA,QAAA;AAC5B,YAAO,OAA8B,WAA9B,MAAM,SAAwB,WAAxB,QAAQ,SAAgB,WAAhB,QAAQ,OAAQ,WAAR;AAC7B,YAAM,MAAM,OAAO;AAEnB,YAAI,aAAa;AACjB,YAAI,OAAO,QAAQ,WAAW,SAAS;AACrC,cAAM,aAAyC;AAC/C,uBAAa,WAAW,UAAU,KAAK,SAAC,MAAS;AAC/C,gBAAI,OAAO,KAAK,yBAAyB,YAAY;AACnD,mBAAK;;;;AAIX,eAAO,WAAW,KAChB,WAAM;AACJ,mBAAS,iBAAiB,MAAK,QAAQ,WACrC,KACA,KAAK,QAFP,SAGS,QACP;YAAC,QAAQ,KAAK;YAAW,QAAQ,KAAK;;WAGzB,SAAC,GAAM;AACtB,iBAAO,MAAM,OAAK;;;OA/I1B;MAAA,KAAA;MAAA,OA+JE,kCAAyB,YAAY;AACnC,YAAO,OAAQ,WAAR;AACP,YAAM,MAAM,OAAO;AAMnB,YAAM,YAAY,IAAI,UAAU;AAChC,YAAM,cAAc,IAAI,UAAU,KAAK,OAAO,iBAAiB,CAAC;AAEhE,YAAI,YAAY;AAChB,YAAI,aAAa;AAGf,cAAI;AACJ,sBAAY,IAAI;;AAGlB,YAAI,CAAC,WAAW;AACd,iBAAO,KAAK,kBAAkB;;AAGhC,eAAO;;OAtLX;MAAA,KAAA;MAAA,OA+LE,yBAAgB,YAAY;AAC1B,YAAM,OAAO,MAAM,cAAc,WAAW;AAC5C,YAAO,OAAQ,WAAR;AAKP,YAAI,aAAa,QAAQ,KAAK;AAC9B,YAAI,kBAAkB,QAAQ,KAAK;AAEnC,YAAI,cAAc,CAAC,CAAC,OAAO,UAAU,UAAU,SAAS,aAAa;AACnE,uBAAa;;AAGf,YAAI,CAAC,eAAe,kBAAkB;AACpC,4BAAkB;;AAKpB,eAAO,KAAK,UAAU,sBACpB,MACA,YACA;;OAtNN;MAAA,KAAA;MAAA,OAgOE,sBAAa,YAAY;AACvB,YAAM,OAAO,MAAM,cAAc,WAAW;AAG5C,iBAAS;AAET,eAAO;;OAtOX;MAAA,KAAA;MAAA,OAgPE,qBAAY,YAAY;AACtB,YAAM,SAAS,MAAM,cAAc,WAAW;AAE9C,YAAI,OAAO,UAAU,SAAS,sBAAsB;AAClD,cAAM,aAAyC;AAC/C,eAAK,SAAS,cACZ,YACA,WAAA;AAAA,mBAAM,WAAkB;aAIJ;eAEjB;AACL,eAAK,SAAS,cAAc,QAAQ,WAAA;AAAA,mBAAM,OAAO,QAAQ;;;AAG3D,eAAO;;OAjQX;MAAA,KAAA;MAAA,OA2QE,qBAAY,YAAY;AAAA,YAAA,SAAA;AACtB,YAAO,OAAQ,WAAR;AACP,YAAM,SAAS,MAAM,cAAc;AACnC,YAAM,cAAc,MAAM,OAAO,cAAc;AAE/C,YAAI,OAAO,UAAU,SAAS,eAAe,OAAO,aAAa;AAC/D,iBAAO,KACL,OACA,+DACA;AAEF,iBAAO;;AAGT,aAAK,SAAS,eAAe,WAAM;AACjC,cACE,cAAc,aAAa,QAAQ,WAAW,UAC9C,CAAC,WAAW,SACZ;AACA,mBAAO,KACL,OACA,0HAEA;;;AAKN,YAAM,oBAAoB,iCAAiC;AAG3D,YAAI,qBAAqB,SAAS,YAAY,aAAa,SAAS;AAClE,eAAK,gBAAgB,QAAQ;AAC7B,eAAK,SAAS,cAAc,QAAQ,WAAM;;eACrC;AACL,eAAK,SAAS,cAAc,QAAQ,WAAM;AACxC,mBAAK,gBAAgB,QAAQ;;;AAIjC,eAAO;;OAnTX;MAAA,KAAA;MAAA,OA2TE,yBAAgB,QAAQ,mBAAmB;AACzC,YAAI,OAAO,UAAU,SAAS,sBAAsB;AAClD,cAAM,aAAyC;AAC/C,qBAAkB;eACb;AACL,iBAAO,QAAQ;;AAEjB,YAAI,mBAAmB;AACrB,mBAAS;;;OAnUf;MAAA,KAAA;MAAA,OA6UE,uBAAc,YAAY;AACxB,YAAI,WAAW,MAAM,cAAc,WAAW,QAAQ;AACpD,iBAAO,KAAK,YAAY;;AAE1B,eAAO,KAAK,YAAY;;OAjV5B;MAAA,KAAA;MAAA,OA0VE,4BAAmB,YAAY;AAC7B,YAAM,SAAS,MAAM,cAAc,WAAW;AAC9C,YAAO,OAAQ,WAAR;AACP,YAAM,YAAY,OAAO,aACvB,KAAK,UACL;AAGF,YAAI,WAAW,KAAK,YAAY;AAC9B,iBAAO;;AAGT,aAAK,SAAS,cAAc,QAAQ,WAAM;AACxC,cAAI,KAAK,aAAa,QAAW;AAE/B,gBAAM,cAAc,OAAO,cACzB,KAAK,UACL;AAEF,mBAAO,UAAU,OAAO,WAAW;iBAC9B;AACL,mBAAO,UAAU,OAAO;;;AAI5B,eAAO;;;AAnXX,WAAA;;AA2XA,kBAAgB,MAAM;AACpB,WAAO,MACJ,MAAK,iBAA2C,MAAO;;AAOrD,wCAAsC,QAAQ;AACnD,iCACE,QACA,oBACA,iBACsB;;;;;;;;;;;;;;;;;;;;;;;;;;ACxa1B,MAAM,QAAQ;AAGd,MAAM,gBAAgB;AAGtB,MAAM,aAAa,uBAAM;;AAIzB,MAAa,YAAb,2BAAA;AAEE,wBAAY,QAAQ;AAAA,wBAAA,MAAA;AAElB,WAAK,UAAU;AAMf,WAAK,oBAAoB;AAOzB,WAAK,0BAA0B;;AAjBnC,mBAAA,YAAA,CAAA;MAAA,KAAA;MAAA,OAyBE,mBAAU,iBAAiB;AACzB,eAAO,KAAK,mBAAmB,iBAAiB,KAAK;;OA1BzD;MAAA,KAAA;MAAA,OAmCE,4BAAmB,iBAAiB,OAAM;AAAA,YAAA,QAAA;AACxC,eAAO,KAAK,mBAAmB,iBAAiB,KAAK,SAAC,MAAS;AAC7D,iBAAO,MAAK,SAAS,MAAM;;;OArCjC;MAAA,KAAA;MAAA,OA+CE,wBAAe,iBAAiB,MAAM;AAAA,YAAA,SAAA;AACpC,eAAO,KAAK,mBAAmB,iBAAiB,KAAK,SAAC,MAAS;AAC7D,iBAAO,OAAK,QAAQ,MAAM;;;OAjDhC;MAAA,KAAA;MAAA,OA2DE,gCAAuB,iBAAiB,MAAM;AAC5C,eAAO,KAAK,mBAAmB,iBAAiB,KAAK,SAAC,MAAS;AAC7D,iBAAO,KAAK,eAAe;;;OA7DjC;MAAA,KAAA;MAAA,OAwEE,6BAAoB,iBAAiB,OAAO;AAAA,YAAA,SAAA;AAC1C,YAAI,MAAM,UAAU,GAAG;AACrB,iBAAO,QAAQ,QAAQ;;AAEzB,eAAO,KAAK,mBAAmB,iBAAiB,KAAK,SAAC,MAAS;AAC7D,iBAAO,MAAM,IAAI,SAAC,MAAS;AACzB,mBAAO,OAAK,QAAQ,MAAM;;;;OA9ElC;MAAA,KAAA;MAAA,OA6FE,+BAAsB,QAAQ,MAAM,mBAAmB;AACrD,eAAO,KAAK,eACV,KAAK,aAAa,QAAQ,oBAC1B;;OAhGN;MAAA,KAAA;MAAA,OA8GE,mCAA0B,QAAQ,OAAM,mBAAmB;AACzD,eAAO,KAAK,mBACV,KAAK,aAAa,QAAQ,oBAC1B;;OAjHN;MAAA,KAAA;MAAA,OAgIE,oCAA2B,QAAQ,OAAO,mBAAmB;AAC3D,eAAO,KAAK,oBACV,KAAK,aAAa,QAAQ,oBAC1B;;OAnIN;MAAA,KAAA;MAAA,OA6IE,qBAAY,QAAQ,mBAAmB;AACrC,eAAO,CAAC,CAAC,KAAK,kBAAkB,QAAQ;;OA9I5C;MAAA,KAAA;MAAA,OAwJE,sBAAa,QAAQ,mBAAmB;AACtC,YAAM,kBAAkB,KAAK,kBAAkB,QAAQ;AACvD,mBAAW,iBAAiB,6BAA6B;AACzD,YAAM,kBAAkB,gBAAgB;AACxC,mBACE,mBAAmB,cAChB,mBAAmB,YAClB,gBAAgB,aAAa,YAAY,cAC7C;AAGF,eAAO;;OAnKX;MAAA,KAAA;MAAA,OAgLE,2BAAkB,QAAQ,mBAAmB;AAC3C,YAAM,aAAa,OAAO,aAAa;AACvC,YAAI,YAAY;AACd,cAAM,WACJ,YAAY;AAEd,iBAAO,SAAS,eAAe;mBACtB,mBAAmB;AAC5B,iBAAO,oBAAoB,QAAQ;eAC9B;AACL,iBAAO,OAAO,cAAc;;;OA1LlC;MAAA,KAAA;MAAA,OAqME,4BAAmB,SAAS;AAAA,YAAA,SAAA;AAE1B,YAAM,OAAO,QAAQ;AACrB,YAAI,MAAM;AACR,iBAAO,QAAQ,QAAQ;;AAGzB,YAAI,OAAO;AACX,YAAO,UAAW,QAAX;AACP,YAAI,WAAW,YAAY;AACzB,iBAAO,QAAQ,aAAa;mBACnB,WAAW,UAAU;AAC9B,iBAAO,QAAQ,aAAa;;AAE9B,mBAAW,MAAM,8BAA8B;AAE/C,YAAI,UAAU,QAAQ;AACtB,YAAI,SAAS;AACX,iBAAO;;AAGT,kBAAU,KAAK,sBAAsB,SAAS,MAAM,KAClD,SAAC,eAAkB;AAEjB,cAAM,SACJ;AAEF,cAAM,QAAQ,QAAQ,SAAS,IAAI,OAAO,SAAS,OAAK,QAAQ;AAChE,iBAAO,QAAQ;AACf,iBAAO;;AAGX,gBAAQ,iBAAiB;AACzB,eAAO;;OAtOX;MAAA,KAAA;MAAA,OAiPE,+BAAsB,SAAS,MAAM;AACnC,YAAI,KAAK,kBAAkB,OAAO;AAChC,iBAAO,KAAK,kBAAkB;;AAGhC,YAAM,WAAW,IAAI;AACrB,YAAO,UAAoB,SAApB,SAAS,UAAW,SAAX;AAEhB,aAAK,kBAAkB,QAAQ;AAC/B,aAAK,wBAAwB,QAAQ;AACrC,eAAO;;OA3PX;MAAA,KAAA;MAAA,OAsQE,2BAAkB,MAAM,eAAe;AACrC,YAAI,CAAC,KAAK,kBAAkB,OAAO;AACjC,eAAK,kBAAkB,QAAQ,QAAQ,QAAQ;eAC1C;AACL,cAAM,WAAW,KAAK,wBAAwB;AAC9C,qBAAW,UAAU,+BAA+B;AACpD,iBAAO,KAAK,wBAAwB;AACpC,mBAAS;;;OA7Qf;MAAA,KAAA;MAAA,OAuRE,iBAAQ,MAAM,MAAM;AAClB,eAAO,KAAK,OAAO;;OAxRvB;MAAA,KAAA;MAAA,OAiSE,kBAAS,MAAM,OAAM;AACnB,eAAO,KAAK,QAAQ;;;AAlSxB,WAAA;;AAySO,yCAAuC,QAAQ;AACpD,iCAA6B,QAAQ,aAAa;;AAW7C,0CAAwC,QAAQ,MAAM,eAAe;AAC1E,QAAM,mBAAmB,iBAAiB,QAAQ;AAClD,WAAO,iBAAiB,kBAAkB,MAAM;;;;;;;;;;;;;;;;;;;;;;;;;;ACtUlD,MAAM,QAAM;AACZ,MAAI;AAKJ,MAAa,QAAb,2BAAA;AAIE,oBAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,MAAM;AAGX,WAAK,YAAY,KAAK,IAAI,QAAQ;AAElC,WAAK,aAAa;AAElB,WAAK,YAAY;AAGjB,WAAK,aAAa,KAAK;;AAhB3B,mBAAA,QAAA,CAAA;MAAA,KAAA;MAAA,OAuBE,0BAAiB;AACf,eAAO,KAAK,QAAQ,KAAK;;OAxB7B;MAAA,KAAA;MAAA,OAqCE,eAAM,UAAU,WAAW;AAAA,YAAA,QAAA;AACzB,YAAI,CAAC,WAAW;AAGd,cAAM,KAAK,MAAM,KAAK;AACtB,eAAK,UACF,KAAK,WAAM;AACV,gBAAI,MAAK,UAAU,KAAK;AACtB,qBAAO,MAAK,UAAU;AACtB;;AAEF;aAED,MAAM;AACT,iBAAO;;AAET,YAAM,UAAU,oBAAM;AACpB,cAAI;AACF;mBACO,GAAP;AACA,wBAAY;AACZ,kBAAM;;;AAGV,YAAM,QAAQ,KAAK,IAAI,WAAW,SAAS;AAC3C,YAAI,UAAU,MAAM;AAClB,cAAI,CAAC,kBAAkB;AACrB,+BAAmB;;AAErB,2BAAiB,KAAK;;AAExB,eAAO;;OApEX;MAAA,KAAA;MAAA,OA2EE,gBAAO,WAAW;AAChB,YAAI,OAAO,aAAa,UAAU;AAChC,eAAK,UAAU,aAAa;AAC5B;;AAEF,aAAK,IAAI,aAAa;;OAhF1B;MAAA,KAAA;MAAA,OAyFE,iBAAQ,WAAW;AAAA,YAAA,SAAA;AACjB,eAAO,IAAI,KAAK,IAAI,QAAQ,SAAC,SAAY;AAEvC,cAAM,WAAW,OAAK,MAAM,SAAS;AACrC,cAAI,YAAY,IAAI;AAClB,kBAAM,IAAI,MAAM;;;;OA9FxB;MAAA,KAAA;MAAA,OA8GE,wBAAe,OAAO,iBAAiB,aAAa;AAAA,YAAA,SAAA;AAClD,YAAI;AACJ,YAAM,eAAe,IAAI,KAAK,IAAI,QAAQ,SAAC,UAAU,QAAW;AAC9D,qBAAW,OAAK,MAAM,WAAM;AAC1B,mBAAO,OAAO,YAAY,eAAe;aACxC;AAEH,cAAI,YAAY,IAAI;AAClB,kBAAM,IAAI,MAAM;;;AAGpB,YAAI,CAAC,iBAAiB;AACpB,iBAAO;;AAET,YAAM,SAAS,mBAAM;AACnB,iBAAK,OAAO;;AAEd,wBAAgB,KAAK,QAAQ;AAC7B,eAAO,KAAK,IAAI,QAAQ,KAAK,CAAC,cAAc;;OAhIhD;MAAA,KAAA;MAAA,OA0IE,cAAK,OAAO,WAAW;AAAA,YAAA,SAAA;AACrB,eAAO,IAAI,KAAK,IAAI,QAAQ,SAAC,SAAY;AACvC,cAAM,WAAW,OAAK,IAAI,YAAY,WAAM;AAC1C,gBAAI,aAAa;AACf,qBAAK,IAAI,cAAc;AACvB;;aAED;;;;AAjJT,WAAA;;AAyJO,+BAA6B,SAAQ;AAC1C,2BAAuB,SAAQ,OAAK;;;;;;;;;;;;;;;;;;;;;;;;;;ACzJtC,MAAM,UAAU;AAIhB,MAAa,MAAb,2BAAA;AAIE,kBAAY,QAAQ;AAAA,wBAAA,MAAA;AAClB,UAAM,OAAO,OAAO;AACpB,UAAM,MAAM,KAAK,iBAAiB;AAGlC,WAAK,UAA6C,IAAI,cAAc;AAGpE,WAAK,SAAS,QAAS,OAAO,IAAI,SAAS;;AAZ/C,mBAAA,MAAA,CAAA;MAAA,KAAA;MAAA,OAuBE,eAAM,KAAK,aAAa;AACtB,eAAO,cACL,KAAK,SACL,KACA,AAAU,cAAc,OAAO,KAAK;;OA3B1C;MAAA,KAAA;MAAA,OAoCE,gBAAO,KAAK;AACV,YAAI,OAAO,QAAQ,UAAU;AAC3B,iBAAO;;AAET,eAAO,KAAK,MAAM;;OAxCtB;MAAA,KAAA;MAAA,OAiDE,0BAAgB,KAAK;AACnB,eAAO,gBAAgB;;OAlD3B;MAAA,KAAA;MAAA,OA2DE,0BAAgB,KAAK;AACnB,eAAO,gBAAgB,KAAK,OAAO;;OA5DvC;MAAA,KAAA;MAAA,OAqEE,uBAAa,KAAK;AAChB,eAAO,aAAa,KAAK,OAAO;;OAtEpC;MAAA,KAAA;MAAA,OA+EE,6BAAmB,mBAAmB,SAAS;AAC7C,eAAO,mBAAmB,mBAAmB,KAAK,OAAO;;OAhF7D;MAAA,KAAA;MAAA,OA8FE,yBAAe,WAAW,gBAAgB,YAAuB;AAAA,YAAvB,eAAuB,QAAA;AAAvB,uBAAa;;AACrD,eAAO,eAAe,WAAW,gBAAgB;;OA/FrD;MAAA,KAAA;MAAA,OAuGE,uCAA6B,WAAW;AACtC,eAAO,6BAA6B;;OAxGxC;MAAA,KAAA;MAAA,OAgHE,wBAAc,KAAK;AACjB,eAAO,cAAc,KAAK,OAAO;;OAjHrC;MAAA,KAAA;MAAA,OA0HE,kBAAS,KAAK;AACZ,eAAO,sBAAsB,KAAK,OAAO;;OA3H7C;MAAA,KAAA;MAAA,OAmIE,uBAAa,KAAK;AAChB,eAAO,IAAI,UAAU,KAAK,OAAO,IAAI,SAAS,MAAM;;OApIxD;MAAA,KAAA;MAAA,OA6IE,2BAAkB,aAAa;AAC7B,YAAI,cAAc,cAAc;AAC9B,iBAAO;;AAGT,YAAA,eAAuC,KAAK,OAAO,cAA5C,OAAP,aAAO,MAAM,OAAb,aAAa,MAAM,WAAnB,aAAmB,UAAU,SAA7B,aAA6B;AAC7B,YAAM,cAAc,mBAAmB;AACvC,eAAU,KAAK,MAAf,QAAwB,cAAc,WAAW,SAAS;;;AApJ9D,WAAA;;AA2JO,4BAA0B,QAAQ;AACvC,iCACE,QACA,SACA,KACsB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5J1B,MAAM,iBAAiB;IACrB,sBAAsB;IACtB,mBAAmB;IACnB,MAAM;IACN,UAAU;;AAOZ,MAAM,4BAA4B;IAEhC,mBAAmB,eAAe;IAClC,iBAAiB,eAAe;IAChC,eAAe,eAAe;IAC9B,cAAc,eAAe;IAC7B,qBAAqB,eAAe;IACpC,mBAAmB,eAAe;IAClC,gBAAgB,eAAe;IAC/B,yBAAyB,eAAe;IACxC,cAAc,eAAe;IAC7B,gBAAgB,eAAe;IAC/B,iBAAiB,eAAe;IAChC,eAAe,eAAe;IAE9B,cAAc,eAAe;IAC7B,kBAAkB,eAAe;IACjC,oBAAoB,eAAe;IACnC,eAAe,eAAe;IAE9B,kBAAkB,eAAe;IAEjC,gBAAgB,eAAe;;AAc1B,8BAA4B,KAAK,YAAY,UAAU;AAE5D,QAAM,oBACJ,0BAA0B,eAAe,eAAe;AAC1D,QAAM,kBAAkB,WACpB,0BAA0B,aAAa,eAAe,OACtD;AAEJ,QAAM,eAAe,KAAK,IAAI,mBAAmB;AAGjD,QAAI;AACJ,QAAI,iBAAiB,eAAe,sBAAsB;AACxD,qBAAe;eACN,iBAAiB,eAAe,mBAAmB;AAC5D,qBAAe,qBAAqB,IAAI;eAC/B,iBAAiB,eAAe,MAAM;AAC/C,qBAAe,YAAY;eAClB,iBAAiB,eAAe,UAAU;AAKnD,UAAM,SAAQ,SAAS,SAAS;AAChC,qBAAe,YAAY,KAAK,KAAK,WAAA;AAAA,eAAM,OAAM,QAAQ;;;AAG3D,cAAU,cAAc,gCAAgC;AAExD,WAAO,aAAa,KAAK,WAAM;AAC7B,aAAO,kBAAkB,KAAK,YAAY;;;AAgBvC,6BAA2B,KAAK,YAAY,UAAU;AAC3D,QAAM,aAAa,IAAI,kBAAkB,IAAI,eAAe;AAC5D,QAAI,CAAC,cAAc,WAAW,sBAAsB,GAAG;AAErD;;AAGF,QAAM,SACJ,aAAa,SACT,WAAW,cACX,WAAW,YAAY,WAAW;AAExC,QAAI,CAAC,eAAe,WAAW,SAAS,GAAG;AAEzC;WACK;AACL,aAAO;;;AAUJ,6BAA2B,KAAK,WAAW;AAChD,QAAM,iBAAiB,IAAI,kBAAkB,IAAI,eAAe;AAChE,QAAI,CAAC,kBAAkB,eAAe,eAAe,QAAW;AAG9D;;AAEF,WAAO,eAAe;;AAOxB,MAAa,iBAAb,2BAAA;AAIE,6BAAY,QAAQ;AAAA,wBAAA,MAAA;AAElB,WAAK,SAAS;AAGd,WAAK,gBAAgB,OAAO,OAAO;AAGnC,WAAK,eAAe;AAEpB,WAAK;;AAdT,mBAAA,iBAAA,CAAA;MAAA,KAAA;MAAA,OAqBE,uBAAc;AACZ,aAAK;AACL,aAAK,eAAe;;OAvBxB;MAAA,KAAA;MAAA,OA6BE,sBAAa;;OA7Bf;MAAA,KAAA;MAAA,OAsCE,aAAI,MAAM;AACR,YAAI,CAAC,KAAK,cAAc;AACtB,eAAK;;AAGP,eAAO,KAAK,cAAc;;OA3C9B;MAAA,KAAA;MAAA,OAwDE,aAAI,SAAS,cAAc;AACzB,kBAAU,QAAQ,QAAQ,aAAa;AACvC,aAAK,cAAc,WAAW,KAAK,cAAc,YAAY;UAC3D,MAAM;UACN,OAAO;;AAET,aAAK,cAAc,SAAS,OAAO;AACnC,eAAO;;OA/DX;MAAA,KAAA;MAAA,OA4EE,kBAAS,SAAS,eAAe;AAC/B,kBAAU,QAAQ,QAAQ,aAAa;AACvC,aAAK,cAAc,WAAW,KAAK,cAAc,YAAY;UAC3D,MAAM;UACN,OAAO;;AAET,aAAK,cAAc,SAAS,QAAQ;AACpC,eAAO;;OAnFX;MAAA,KAAA;MAAA,OA6FE,iBAAQ,SAAS,cAAc,eAAe;AAC5C,eAAO,KAAK,IAAI,SAAS,cAAc,SAAS,SAAS;;OA9F7D;MAAA,KAAA;MAAA,OAyGE,iBAAQ,cAAc,eAAe;AACnC,YAAI,CAAC,KAAK,cAAc;AACtB,eAAK;;AAEP,YAAM,MAAG,UAAA,IAAO,KAAK,eAAkB;AACvC,eAAO,KAAK,WAAW,OAAO,KAAK,MAAM;;OA9G7C;MAAA,KAAA;MAAA,OAwHE,oBAAW,MAAM,eAAe;AAAA,YAAA,QAAA;AAI9B,YAAI,KAAK,yBAAyB;AAChC,iBAAO,KAAK,OAAO,SAAC,KAAD;AAAA,mBAAS,MAAK,wBAAwB,SAAS;;;AAIpE,YAAI,eAAe;AACjB,iBAAO,KAAK,OAAO,SAAC,KAAD;AAAA,mBAAS,cAAc;;;AAE5C,YAAI,KAAK,WAAW,GAAG;AACrB,cAAM,0BAA0B;AAChC,iBAAO;;AAIT,aAAK,KAAK,SAAC,IAAI,IAAL;AAAA,iBAAY,GAAG,SAAS,GAAG;;AAGrC,YAAM,UAAU,KAAK,IAAI,SAAC,KAAQ;AAChC,cAAI,IAAI,OAAO,KAAK;AAClB,mBAAO,OAAO;;AAEhB,iBAAO;;AAGT,YAAM,MAAM,QAAQ,KAAK;AAQzB,YAAM,WAAW,UAAU,MAAM;AACjC,eAAO,IAAI,OAAO,UAAU;;OA7JhC;MAAA,KAAA;MAAA,OAqKE,iCAAwB;AACtB,YAAI,KAAK,oBAAoB;AAC3B,iBAAO,KAAK;;AAId,YAAI,KAAK,OAAO,eAAe;AAC7B,cAAM,MAAgC,KAAK,OAAO;AAClD,cAAI,YAAY,MAAM;AAKpB,iBAAK,qBAAqB,CAAC;AAC3B,mBAAO,KAAK;;;;;AAnLpB,WAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrJA,MAAM,qBAAqB;AAG3B,MAAM,QAAM;AAwBZ,MAAa,WAAb,2BAAA;AAYE,uBACE,gBACA,cACA,iBACA,UACA,eACA,cACA;AAAA,wBAAA,MAAA;AAEA,WAAK,kBAAkB;AAGvB,WAAK,YAAY;AAIjB,WAAK,eAAe;AAGpB,WAAK,QAAQ;AAGb,WAAK,aAAa;AAGlB,WAAK,UAAU,CAAC;;AArCpB,mBAAA,WAAA,CAAA;MAAA,KAAA;MAAA,OA6CE,gBAAO,KAAK;AACV,YAAI,CAAC,IAAI,QAAQ;AACf,iBAAO,KAAK,QAAQ,MAAM,QAAQ,QAAQ;;AAE5C,YAAM,OAAO,KAAK,gBAAgB,QAAQ,KAAK,WAAW,KAAK;AAE/D,YAAM,WAAU,KAAK,aAAa,KAAK;AAEvC,YAAI,CAAC,SAAQ,QAAQ;AACnB,iBAAO,KAAK,QAAQ,MAAM,QAAQ,QAAQ;;AAE5C,eAAO,KAAK,qBAAqB,KAAK;;OAxD1C;MAAA,KAAA;MAAA,OAgEE,uBAAc,KAAK;AACjB,YAAM,OAAO,KAAK,gBAAgB,QAAQ,KAAK,WAAW,KAAK;AAC/D,YAAM,WAAU,IAAI,MAAM;AAC1B,YAAI,UAAS;AACX,iBAAO;;AAET,eAAO;;OAtEX;MAAA,KAAA;MAAA,OA+EE,sBAAa,KAAK,YAAY;AAC5B,YAAM,WAA4C;AAClD,YAAI,QAAQ,YAAY,SAAC,OAAO,MAAM,eAAkB;AACtD,cAAO,SAAU,MAAV;AACP,cAAM,eAAe,SAAS,gBAAgB;AAC9C,cAAM,OAAO;YACX,OAAO;YACP,MAAM;YACN;YACA;;AAEF,mBAAQ,KAAK;;AAEf,eAAO;;OA5FX;MAAA,KAAA;MAAA,OAoGE,8BAAqB,KAAK,UAAS;AAAA,YAAA,QAAA;AACjC,YAAM,QAAQ;AACd,YAAI,WAAW;AACf,YAAI,aAAa;AACjB,YAAI,QAAQ,SAAQ;AACpB,YAAI,oBAAoB;AACxB,YAAI,gBAAgB;AAEpB,YAAM,oBAAoB,4BAAC,QAAW;AACpC,cAAI,UAAU;AACd,cAAI,UAAU;AACd,cAAM,OAAO;AAEb,iBAAO,WAAW,IAAI,UAAU,cAAc,SAAQ,QAAQ;AAC5D,gBAAM,iBAAiB,QAAQ;AAC/B,gBAAI,SAAS,aAAa,MAAM,OAAO;AAGrC,kBAAI,gBAAgB;AAClB,wBAAQ,KAAK,oBAAoB,UAAU,WAAW;;AAKxD,kBAAI,UAAO;AAGX,kBAAI,MAAK,aAAa,OAAO,MAAK,WAAW,MAAM,OAAO;AAExD,0BAA0C;kBAGxC,MAAM,MAAM;kBACZ,aAAa,MAAK,UAAU,MAAM;kBAClC;;qBAEG;AAEL,0BAAO,UAAA,IACF,MAAK,gBAAgB,IAAI,MAAM,OAD7B;kBAEL,MAAM,MAAM;kBACZ;;;AAIJ,yBAAW,MAAM,OAAO;AACxB,sBAAQ,SAAQ,EAAE;AAElB,kBAAI,IAAI,cAAc,KAAK;AAIzB;AACA;AACA,sBAAM,KAAK;AACX,wBAAQ,KAAK,mBAA+B;qBACvC;AAGL,wBAAQ,KAAK,MAAK,iBAAiB;;AAGrC,wBAAU;uBACD,IAAI,cAAc,oBAAoB;AAC/C,kBAAI,CAAC,eAAe;AAClB,gCAAgB;AAEhB,oBAAI,gBAAgB;AAClB,0BAAQ,KAAK;;qBAEV;AACL,gCAAgB;AAEhB,oBAAI,QAAQ,QAAQ;AAClB,0BAAQ,KAAK;;;AAGjB,wBAAU;AACV;uBAEA,qBACA,IAAI,cAAc,OAClB,CAAC,eACD;AAIA,kBAAI,gBAAgB;AAClB,wBAAQ,KAAK;;AAEf,mBAAK,KAAK;AACV,wBAAU;AAGV,kBAAI,IAAI,WAAW,OAAO,KAAK;AAC7B,qBAAK,KAAK,CAAC;AACX;;AAEF,wBAAU;AACV;uBAQO,qBAAqB,IAAI,cAAc,OAAO,CAAC,eAAe;AACrE;AACA;AACA,kBAAM,WAAU,MAAM;AACtB,kBAAI,gBAAgB;AAClB,wBAAQ,KAAK;;AAEf,mBAAK,KAAK;AACV,kBAAM,QAAQ,MAAK,iBAAiB,UAAwB;AAC5D,qBAAO;mBACF;AAGL,yBAAW,IAAI;AACf;;AAIF,gBAAI,aAAa,IAAI,UAAU,QAAQ,QAAQ;AAC7C,sBAAQ,KAAK;;;AAMjB,cAAI,MAAK,OAAO;AACd,mBAAO,QAAQ,KAAK;;AAGtB,iBAAO,QAAQ,IAAI,SAChB,KAAK,SAAC,cAAD;AAAA,mBAAkB,aAAa,KAAK;aACzC,MAAM,SAAC,GAAM;AACZ,yBAAa;AACb,mBAAO;;;AAIb,eAAO,kBAAkB,KAAK;;OApPlC;MAAA,KAAA;MAAA,OAoQE,0BAAiB,aAAa,UAAU;AACtC,YAAO,SAAgB,YAAhB,QAAQ,OAAQ,YAAR;AACf,YAAI;AACJ,YAAI,YAAY,eAAe,QAAW;AAKxC,oBAAU,YAAY;mBACb,KAAK,SAAS,YAAY,QAAQ,QAAW;AAEtD,oBAAU,YAAY;mBACb,KAAK,OAAO;AAErB,iBAAO,MAAM,OAAK,oCAAoC,YAAY;AAClE,oBAAU;eACL;AAEL,oBAAU,YAAY,SAAS,YAAY;;AAG7C,YAAI,KAAK,OAAO;AACd,cAAM,SAAS,KAAK,qBAAqB,SAAS,MAAM;AACxD,iBAAO,SAAS,mBAAmB,UAAU;eACxC;AACL,iBAAO,KAAK,sBAAsB,SAAS,MAAM,UAAU,KACzD,SAAC,SAAD;AAAA,mBAAa,SAAS,mBAAmB,WAAU;;;;OA9R3D;MAAA,KAAA;MAAA,OA0SE,+BAAsB,SAAS,MAAM,UAAU;AAAA,YAAA,SAAA;AAC7C,YAAI;AACJ,YAAI;AACF,cAAI,OAAO,YAAY,YAAY;AACjC,gBAAM,cAAc;AACpB,gBAAI,UAAU;AACZ,sBAAQ,KAAK,kBAAkB,UAAU,KAAK,SAAC,MAAD;AAAA,uBAC5C,YAAY,MAAM,MAAM;;mBAErB;AACL,sBAAQ,WAAW;;iBAEhB;AACL,oBAAQ,QAAQ,QAAQ;;AAE1B,iBAAO,MACJ,KAAK,SAAC,KAAQ;AACb,mBAAK,kBAAkB,MAAM,KAAK;AAElC,gBAAI;AAEJ,gBAAI,OAAO,MAAM;AACf,uBAAS;mBACJ;AACL,uBAAS;;AAEX,mBAAO;aAER,MAAM,SAAC,GAAM;AACZ,yBAAa;AACb,mBAAK,kBAAkB,MAAM,IAAI;AACjC,mBAAO,QAAQ,QAAQ;;iBAEpB,GAAP;AAGA,uBAAa;AACb,eAAK,kBAAkB,MAAM,IAAI;AACjC,iBAAO,QAAQ,QAAQ;;;OAhV7B;MAAA,KAAA;MAAA,OA4VE,2BAAkB,WAAW;AAC3B,eAAO,QAAQ,IACb,UAAU,IAAI,SAAC,UAAa;AAC1B,iBAAO,QAAQ,IAAI,UAAU,KAAK,SAAC,WAAD;AAAA,mBAAc,UAAS,KAAK;;;;OA/VtE;MAAA,KAAA;MAAA,OA2WE,8BAAqB,SAAS,MAAM,UAAU;AAC5C,YAAI;AACF,cAAI,QAAQ;AACZ,cAAI,OAAO,YAAY,YAAY;AACjC,oBAAQ,QAAQ,MAAM,MAAM,KAAK,iBAAiB;;AAGpD,cAAI;AAEJ,cAAI,SAAS,OAAO,MAAM,QAAQ,YAAY;AAI5C,mBAAO,MAAM,OAAK;AAClB,qBAAS;qBAET,OAAO,UAAU,YACjB,OAAO,UAAU,YACjB,OAAO,UAAU,WACjB;AAEA,iBAAK,kBAAkB,MAAM,OAAO;AAEpC,qBAAS,MAAM;iBACV;AAEL,iBAAK,kBAAkB,MAAM,IAAI;AACjC,qBAAS;;AAGX,iBAAO;iBACA,GAAP;AAGA,uBAAa;AACb,eAAK,kBAAkB,MAAM,IAAI;AACjC,iBAAO;;;OA/Yb;MAAA,KAAA;MAAA,OA2ZE,0BAAiB,WAAW;AAC1B,YAAI,CAAC,WAAW;AACd,iBAAO;;AAET,eAAO,UAAU,IAAI,SAAC,UAAa;AACjC,iBAAO,SAAS,KAAK;;;OAha3B;MAAA,KAAA;MAAA,OA0aE,2BAAkB,MAAM,OAAO,UAAU;AACvC,YAAI,CAAC,KAAK,cAAc;AACtB;;AAGF,YAAI,OAAO;AACX,YAAI,UAAU;AACZ,cAAM,UAAU,SAAS,OAAO,SAAC,KAAD;AAAA,mBAAS,QAAQ;aAAI,KAAK;AAC1D,iBAAI,MAAO,UAAP;;AAEN,aAAK,aAAL,KAAqB,OAAO,QAAU,SAAS;;;AApbnD,WAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACFA,MAAM,QAAM;AACZ,MAAM,uBAAuB;AAC7B,MAAM,oBAAoB;AAC1B,MAAM,YAAY;AAClB,MAAM,yBAAyB;AAC/B,MAAM,0BAA0B;AAShC,sBAAoB,QAAQ;AAC1B,WAAO,WAAA;AAAA,aAAM,IAAI,OAAO;;;AAW1B,0BAAwB,QAAQ,UAAU;AACxC,WAAO,WAAA;AAAA,aAAM,OAAO;;;AAMtB,MAAa,uBAAb,yBAAA,iBAAA;AAAA,eAAA,uBAAA;AAAA,QAAA,SAAA,cAAA;AAAA,qCAAA;AAAA,wBAAA,MAAA;AAAA,aAAA,OAAA,MAAA,MAAA;;AAAA,mBAAA,uBAAA,CAAA;MAAA,KAAA;MAAA,OAUE,4BAAmB,SAAS,YAAY,UAAU;AAAA,YAAA,QAAA;AAChD,eAAO,KAAK,QACV,SACA,WAAM;AACJ,iBAAO,kBAAkB,MAAK,OAAO,KAAK,YAAY;WAExD,WAAM;AACJ,iBAAO,mBAAmB,MAAK,OAAO,KAAK,YAAY;;;OAjB/D;MAAA,KAAA;MAAA,OAuBE,sBAAa;AAAA,YAAA,SAAA;AACX,YAAO,MAAO,KAAK,OAAZ;AACP,YAAM,UAAU,KAAK,OAAO;AAG5B,YAAM,WAAW,SAAS,eAAe,KAAK;AAG9C,aAAK,IAAI,UAAU,WAAA;AAAA,iBAAM,KAAK;;AAG9B,YAAM,eAAe,OAAO,OAAO;AACnC,aAAK,IAAI,WAAW,SAAC,OAAU;AAC7B,iBAAQ,aAAa,SAAU,cAAa,SAAS,KAAK;;AAI5D,aAAK,IAAI,iBAAiB,WAAA;AAAA,iBAAM,OAAK,cAAc;;AAGnD,aAAK,IACH,kBACA,WAAA;AAAA,iBAAM,mBAAmB,OAAK,cAAc,cAAc;;AAI5D,aAAK,IACH,sBACA,WAAA;AAAA,iBAAM,mBAAmB,OAAK,cAAc,cAAc;;AAI5D,aAAK,IACH,kBACA,WAAA;AAAA,iBAAM,mBAAmB,OAAK,cAAc,cAAc;;AAI5D,aAAK,SACH,qBAEE,WAAM;AACJ,iBAAO,SAAS,aAAa,OAAK,QAAQ;;AAOhD,aAAK,SACH,qBAEE,WAAM;AACJ,iBAAO,SAAS,aAAa,OAAK,QAC/B,iBACA,KAAK,SAAC,UAAa;AAClB,gBAAI,CAAC,UAAU;AACb,qBAAO;;AAET,gBAAM,mBAAmB,mBACvB,aAAa,WACb;AACF,gBAAM,kBAAkB,gBAAgB,YAAY;AACpD,mBAAO,qBAAqB,kBAAkB,OAAO;;;AAO/D,aAAK,IAAI,SAAS,WAAM;AAGtB,cAAM,MAAM,IAAI;AAChB,iBAAO,IAAI,oBAAoB,IAAI;;AAIrC,aAAK,IAAI,cAAc,WAAM;AAC3B,iBAAO,eAAe,OAAK,2BAA2B,IAAI,SAAS;;AAIrE,aAAK,IAAI,eAAe,WAAM;AAC5B,cAAM,MAAM,mBAAmB,IAAI,SAAS;AAC5C,iBAAO,OAAO,IAAI;;AAIpB,aAAK,IAAI,mBAAmB,WAAM;AAChC,cAAM,MAAM,mBAAmB,IAAI,SAAS;AAC5C,iBAAO,OAAO,IAAI;;AAIpB,YAAM,kBAAkB,4BAAM;AAC5B,cAAM,UAAU,OAAK;AACrB,iBAAO,eAAe,OAAK,2BAA2B,QAAQ;;AAEhE,aAAK,QACH,cACA,WAAA;AAAA,iBAAM;WACN,WAAA;AAAA,iBAAM,4BAA4B,KAAK,WAAA;AAAA,mBAAM;;;AAI/C,aAAK,IACH,eACA,WAAA;AAAA,iBAAM,mBAAmB,OAAK,cAAc,WAAW;;AAIzD,aAAK,IACH,mBACA,WAAA;AAAA,iBAAM,mBAAmB,OAAK,cAAc,WAAW;;AAIzD,aAAK,IACH,eACA,WAAA;AAAA,iBAAM,mBAAmB,OAAK,cAAc,WAAW;;AAMzD,aAAK,IAAI,gBAAgB,WAAA;AAAA,iBAAM,OAAK,cAAc;;AAKlD,aAAK,SAAS,mBAAmB,WAAA;AAAA,iBAAM,OAAK,cAAc;;AAE1D,aAAK,QACH,eACA,SAAC,OAAO,cAAsB;AAAA,cAAtB,iBAAsB,QAAA;AAAtB,2BAAe;;AACrB,iBAAO,OAAK,mBAAmB,OAAO;WAExC,SAAC,OAAO,cAAsB;AAAA,cAAtB,iBAAsB,QAAA;AAAtB,2BAAe;;AACrB,iBAAO,4BAA4B,KAAK,WAAM;AAC5C,mBAAO,OAAK,mBAAmB,OAAO;;;AAS5C,aAAK,IAAI,kBAAkB,SAAC,OAAO,cAAsB;AAAA,cAAtB,iBAAsB,QAAA;AAAtB,2BAAe;;AAChD,iBAAO,OAAK,sBAAsB,OAAO;;AAQ3C,YAAI,YAAY;AAGhB,aAAK,QACH,aACA,SAAC,OAAU;AACT,cAAI,CAAC,WAAW;AACd,mBAAO;;AAET,iBAAO,UAAU;WAEnB,SAAC,OAAO,wBAAwB,gBAAgB,mBAAsB;AACpE,qBACE,OACA;AAIF,cAAI,UAAU;AAId,cAAI,wBAAwB;AAC1B,sBAAU,SAAS,8BAA8B,SAAS,KACxD,SAAC,SAAY;AACX,qBAAO,QAAQ,IAAI;;;AAIzB,iBAAO,SAAS,UAAU,OAAK,QAC5B,KAAK,SAAC,KAAQ;AACb,gCAAoB,qBAAqB,SAAS,OAAO;AACzD,mBAAO,IAAI,IACT;cACwB;cACtB,0BAA0B;cAC1B,YAAY,kBAAkB;cAC9B,eAAe;eAEjB;aAGH,KAAK,SAAC,KAAQ;AACb,gBAAI,CAAC,WAAW;AACd,0BAAY,OAAO,OAAO;;AAK5B,gBAAM,aAAa,kBAAkB;AACrC,gBAAI,OAAO,cAAc,OAAO;AAC9B,kBAAI,OAAO,QAAQ,UAAU;AAC3B,sBAAM,4BAA4B;qBAC7B;AAGL,sBAAM,MACJ,OACA,+BACA,OAAO,KAAK;;;AAKlB,sBAAU,SAAS;AACnB,mBAAO;;;AAMf,aAAK,SACH,WAEE,SAAC,YAAe;AACd,iBAAO,OAAK,kBAAkB,SAAC,UAAa;AAC1C,gBAAM,UAAU,SAAgC;AAChD,uBACE,YAAY,QACZ,iFACE;AAGJ,mBAAO,YAAY,OAAO,SAAgC;aACzD;;AAMT,aAAK,SACH,YAEE,WAAM;AACJ,iBAAO,OAAK,kBAAkB,SAAC,UAAa;AAC1C,gBAAM,cAAc;AACpB,qBAAW,cAAc,UAAU;AACjC,kBAAM,UAAU,SAAS;AACzB,0BAAY,KACV,aAAa,oBAAqB,YAAW;;AAGjD,mBAAO,YAAY,KAAK;aACvB;;AAMT,aAAK,SACH,WAEE,SAAC,SAAY;AACX,iBAAO,OAAK,QAAQ,SAAC,MAAS;AAC5B,gBAAI,SAAS;AACX,yBACE,YAAY,cACZ,qDAAqD;AAEvD,qBAA8B,KAAK,YAAY;;AAEjD,mBACE,KAAK,wBAAwB,KAAK;aAEnC;;AAMT,aAAK,IAAI,aAAa,WAAW;AAIjC,aAAK,IAAI,iBAAiB,WAAW;AAGrC,aAAK,IAAI,YAAY,WAAW;AAGhC,aAAK,IAAI,iBAAiB,WAAA;AAAA,iBAAM,SAAS;;AAGzC,aAAK,IAAI,gBAAgB,WAAA;AAAA,iBAAM,SAAS;;AAGxC,aAAK,IAAI,mBAAmB,WAAA;AAAA,iBAAM,SAAS;;AAG3C,aAAK,IAAI,kBAAkB,WAAA;AAAA,iBAAM,SAAS;;AAE1C,YAAO,SAAU,IAAV;AAEP,aAAK,IAAI,gBAAgB,eAAe,QAAQ;AAGhD,aAAK,IAAI,iBAAiB,eAAe,QAAQ;AAGjD,aAAK,IAAI,2BAA2B,eAAe,QAAQ;AAG3D,aAAK,IAAI,0BAA0B,eAAe,QAAQ;AAG1D,aAAK,IAAI,sBAAsB,eAAe,QAAQ;AAGtD,aAAK,IAAI,oBAAoB,WAAM;AACjC,cAAM,MAAM,IAAI;AAChB,iBAAO,IAAI,gBAAgB,IAAI;;AAIjC,aAAK,IAAI,oBAAoB,WAAM;AACjC,cAAM,MAAM,IAAI;AAChB,iBACE,KAAI,YAEJ,IAAI,mBACJ,IAAI,mBACJ,IACA;;AAIJ,aAAK,IAAI,cAAc,WAAM;AAC3B,iBAAO,IAAI,UAAU;;AAKvB,aAAK,mBACH,kBACA,mBACA;AAIF,aAAK,mBACH,sBACA,qBACA;AAIF,aAAK,mBAAmB,oBAAoB,gBAAgB;AAI5D,aAAK,mBACH,wBACA,gBACA;AAIF,aAAK,mBACH,sBACA,iBACA;AAIF,aAAK,mBAAmB,iBAAiB,mBAAmB;AAG5D,aAAK,mBACH,wBACA,mBACA;AAIF,aAAK,mBACH,qBACA,mBACA;AAIF,aAAK,SACH,oBAEE,WAAM;AACJ,iBAAO,OAAK,gBAAgB,SAAC,eAAkB;AAC7C,mBAAO,cAAc;aACpB;;AAMT,aAAK,SACH,YAEE,SAAC,OAAU;AACT,qBACE,OACA;AAEF,iBAAO,OAAK,gBAAgB,SAAC,eAAkB;AAC7C,mBAAO,cAAc,iBAAiB;aACrC;;AAMT,aAAK,SAAS,UAAU,WAAM;AAC5B,iBAAO,SAAS,aAAa,OAAK,QAC/B,kBACA,KAAK,SAAC,QAAW;AAChB,mBAAO,UAAU,SAAY,KAAK;;;AAKxC,aAAK,SAAS,sBAAsB,WAAM;AACxC,iBAAO,SAAS,eAAe,SAAS,KAAK,SAAC,UAAa;AACzD,mBAAO,SAAS;;;AAMpB,aAAK,SAAS,4BAA4B,SAAC,MAAM,OAAU;AACzD,iBAAO,SAAS,eAAe,SAAS,KAAK,SAAC,UAAa;AACzD,mBAAO,SAAS,0BACS,MACvB,UAAU;;;AAKhB,aAAK,IAAI,cAAc,SAAC,gBAAgB,cAAiB;AACvD,qBACE,gBACA;AAGF,iBAAO,kBACL,KACqB,gBACA;;AAGzB,aAAK,SAAS,cAAc,SAAC,gBAAgB,cAAiB;AAC5D,qBACE,gBACA;AAGF,iBAAO,mBACL,KACqB,gBACA;;AAIzB,aAAK,IAAI,YAAY,WAAM;AACzB,iBAAO,kBAAkB,KAAK;;AAGhC,aAAK,IAAI,sBAAsB,WAAM;AACnC,iBAAO,kBAAkB,KAAK;;AAIhC,aAAK,IAAI,eAAe,WAAA;AAAA,iBAAM;;AAE9B,aAAK,IAAI,oBAAoB,WAAM;AACjC,iBAAO,OAAK,OAAO,cAAc,MAAM;;AAGzC,aAAK,SAAS,eAAe,SAAC,IAAI,UAAa;AAC7C,iBAAO,SAAS,mBAAmB,OAAK,QAAQ,sBAC9C,IACA;;AAIJ,aAAK,SAAS,aAAa,SAAC,KAAQ;AAElC,cAAM,OAAO,OAAK,OAAO;AACzB,cAAM,WACJ,KAAK,mBAAmB;AAE1B,iBAAO,SAAS,iBAAiB,UAAS,KAAK,SAAC,MAAS;AACvD,gBAAI,CAAC,MAAM;AACT,qBAAO;;AAET,mBAAO,KAAK,cAAqC,QAAS;;;;OArhBlE;MAAA,KAAA;MAAA,OAiiBE,oCAA2B,MAAM;AAC/B,YAAA,oBAAwB,KAAK,eAAtB,gBAAP,kBAAO;AACP,YAAI,CAAC,eAAe;AAClB,iBAAO;;AAET,eAAO,sBACL,yBAAyB,OACG;;OAxiBlC;MAAA,KAAA;MAAA,OAgjBE,uBAAc;AACZ,eAAO,SAAS,mBAAmB,KAAK;;OAjjB5C;MAAA,KAAA;MAAA,OA6jBE,yBAAgB,QAAQ,MAAM;AAC5B,YAAM,UAAU,KAAK,OAAO;AAC5B,eAAO,QAAQ,IAAI,CACjB,SAAS,0BAA0B,UACnC,SAAS,iCAAiC,WACzC,KAAK,SAAC,UAAa;AACpB,cAAM,gBAEF,SAAS;AAEb,cAAM,sBAEF,SAAS;AAEb,cAAM,UAAU,iBAAiB;AACjC,cAAI,CAAC,SAAS;AAEZ,mBAAO,MACL,OACA,+DACA;AAEF,mBAAO;;AAKT,cAAI,iBAAiB,qBAAqB;AACxC,mBAAO,OAAO,wBAAwB,OAAO;;AAG/C,iBAAO,OAAO;;;OA5lBpB;MAAA,KAAA;MAAA,OAumBE,4BAAmB,OAAO,cAAc;AACtC,mBACE,OACA;AAGF,YAAM,MAAM,mBACV,yBAAyB,KAAK,OAAO,IAAI,SAAS;AAEpD,YAAM,SAAS,iBAAiB,IAAI;AACpC,YAAA,qBAAwB,KAAK,eAAtB,gBAAP,mBAAO;AACP,YAAI,OAAO,OAAO,WAAW,aAAa;AACxC,iBAAO,OAAO;;AAEhB,YAAI,iBAAiB,OAAO,cAAc,WAAW,aAAa;AAChE,iBAA8B,cAAc;;AAE9C,eAAO;;OAxnBX;MAAA,KAAA;MAAA,OAkoBE,+BAAsB,OAAO,cAAc;AACzC,mBACE,OACA;AAGF,mBAAW,OAAO,SAAS,UAAU;AACrC,YAAM,OAAO,KAAK,OAAO,IAAI,SAAS;AACtC,YAAM,SAAS,iBAAiB;AAChC,eAAO,OAAO,WAAW,SAAY,eAAe,OAAO;;OA3oB/D;MAAA,KAAA;MAAA,OAspBE,2BAAkB,QAAQ,MAAM;AAC9B,eAAO,SAAS,qBAAqB,KAAK,OAAO,eAC9C,KAAK,SAAC,UAAa;AAClB,qBACE,UACA,2DACA;AAEF,iBAAO,SAAS;WAEjB,KAAK,SAAC,aAAD;AAAA,iBAAiB,OAAO;;;OAhqBpC;MAAA,KAAA;MAAA,OA2qBE,iBAAQ,QAAQ,MAAM;AACpB,YAAM,UAAU,KAAK,OAAO;AAC5B,eAAO,SAAS,gBAAgB,SAAS,KAAK,SAAC,KAAQ;AACrD,qBAAW,KAAK,oDAAoD;AACpE,iBAAO,OAAO;;;;AA/qBpB,WAAA;IAA0C;AAyrB1C,MAAa,kBAAb,2BAAA;AAKE,8BAAY,QAAQ,gBAAgB;AAAA,wBAAA,MAAA;AAElC,WAAK,SAAS;AAGd,WAAK,kBAAkB;;AAV3B,mBAAA,kBAAA,CAAA;MAAA,KAAA;MAAA,OAuBE,0BAAiB,QAAQ,cAAc,eAAe;AACpD,eACE,IAAI,SACF,KAAK,iBACL,cACsB,QACP,MACf,eACmB,MACZ,OAAO;;OAhCtB;MAAA,KAAA;MAAA,OA6CE,2BAAkB,QAAQ,cAAc,eAAe;AACrD,eACE,IAAI,SACF,KAAK,iBACL,cACsB,QACP,QACf,eACmB,MACZ,OAAO;;OAtDtB;MAAA,KAAA;MAAA,OAoEE,uBAAc,KAAK,cAAc,eAAe;AAC9C,eAAO,KAAK,uBACV,KAEE,IAAI,SACF,KAAK,iBACL,cACsB,QACP,MACf,eACO,OAAO;;OA9ExB;MAAA,KAAA;MAAA,OA8FE,wBAAe,KAAK,cAAc,eAAe,cAAc;AAAA,YAAA,SAAA;AAC7D,eACE,IAAI,SACF,KAAK,iBACL,cACsB,QACP,QACf,eACA,cAEQ,OAAO,KACd,KAAK,SAAC,aAAD;AAAA,iBAAiB,OAAK,uBAAuB,KAAK;;;OAzGhE;MAAA,KAAA;MAAA,OAkHE,+BAAsB,SAAS;AAC7B,eACE,KAAK,kBAAkB,SAAsB;;OApHnD;MAAA,KAAA;MAAA,OA6HE,8BAAqB,SAAS;AAC5B,eACE,KAAK,kBAAkB,SAAsB;;OA/HnD;MAAA,KAAA;MAAA,OAyIE,2BAAkB,SAAS,UAAU;AACnC,kBACE,QAAQ,WAAW,WAChB,SAAQ,aAAa,WAAW,IAAI,iBAAiB,UACxD,+DACA;AAGF,YAAM,YAAY,KAAK,wBAAwB;AAC/C,YAAI,CAAC,WAAW;AACd,iBAAO,WAAW,QAAQ,QAAQ,QAAQ,QAAQ,QAAQ;;AAE5D,YAAI,QAAQ,6BAA6B,QAAW;AAClD,kBAAQ,2BAA2B,QAAQ;;AAE7C,YAAM,SAAS,IAAI,SACjB,KAAK,iBACc,QACG,QACP,UACK,WACb,OAAO,QAAQ,4BAA4B,QAAQ;AAE5D,YAAI,UAAU;AACZ,iBAAQ,QAAQ,QAAQ;;AAE1B,eAAO,OAAO,KAAK,SAAC,UAAa;AAC/B,kBAAQ,QAAQ;AAChB,iBAAO;;;OArKb;MAAA,KAAA;MAAA,OAgLE,iCAAwB,SAAS,0BAA0B;AACzD,YAAM,YAAY,QAAQ,aAAa;AACvC,YAAI,CAAC,WAAW;AACd;;AAEF,YAAM,wBAAwB;AAC9B,kBACG,OACA,MAAM,OACN,QAAQ,SAAC,aAAgB;AACxB,cACE,CAAC,4BACD,OAAO,0BAA0B,cACjC;AACA,kCAAsB,eAAe;iBAChC;AACL,mBAAO,KAAK,OAAO,oCAAoC;;;AAG7D,eAAO;;OAnMX;MAAA,KAAA;MAAA,OA2ME,0BAAiB,KAAK;AACpB,YAAM,UAAU,SAAS,mBAAmB,KAAK;AACjD,YACE,IAAI,UAAU,mBAAmB,QAAQ,cAAc,UACvD,IAAI,UAAU,mBAAmB,QAAQ,WAAW,QACpD;AACA,iBAAO;;AAGT,YAAM,OAAO,KAAK,OAAO,cAAc;AACvC,YAAI,MAAM;AACR,cAAM,YAAY,KAAK,OAAO,MAAM;AACpC,mBAAS,IAAI,GAAG,IAAI,UAAU,QAAQ,KAAK;AACzC,gBAAI,IAAI,UAAU,mBAAmB,UAAU,IAAI,QAAQ;AACzD,qBAAO;;;;AAKb,eAAO;;OA9NX;MAAA,KAAA;MAAA,OAyOE,yBAAgB,SAAS,kBAAkB;AACzC,kBAAU,QAAQ,WAAW;AAC7B,YAAM,WAA8C;AACpD,YAAM,wBAAwB;UAC5B,aAAa;UACb,eAAe;UACf,gBAAgB;UAChB,mBAAmB;UACnB,cAAc;;AAEhB,YAAI,0BACF,SAAS,aAAa,yBAAyB;AACjD,YAAM,YAAY,KAAK,wBACrB,UACA;AAGF,YAAI,CAAC,aAAa,CAAC,2BAA2B,CAAC,kBAAkB;AAC/D;;AAKF,YAAI,OAAO,MAAM,aACf,SAAS,2BAA2B,SAAS,aAAa;AAE5D,YAAM,MAAM,mBAAmB;AAC/B,YAAI,SAAS,2BAA2B,MAAM;AAC5C,mBAAS,0BAA0B;;AAGrC,YAAM,kBAAkB,KAAK,iBAAiB;AAC9C,YAAI,yBAAyB;AAC3B,oCAA0B,kBACtB,KAAK,yBAAyB,yBAAyB,aACvD;AACJ,iBAAO,eAAe,MAAM,iBAAiB;;AAG/C,YAAI,CAAC,iBAAiB;AACpB,cAAI,WAAW;AACb,mBAAO,KACL,OACA,yHAGA;;AAGJ,iBAAQ,SAAS,OAAO;;AAU1B,YAAI,kBAAkB;AACpB,cAAI,CAAC,aAAa,CAAC,UAAU,gBAAgB;AAE3C,gBAAM,oBAAoB;cAAC,eAAe;;AAC1C,+BAAmB,KAAK,cACtB,kBACmB,QACC;;AAGxB,iBAAO,eAAe,MAAM,iBAAiB;;AAG/C,eAAO,KAAK,yBAAyB,MAAM;AAE3C,eAAQ,SAAS,OAAO;;OAnT5B;MAAA,KAAA;MAAA,OA2TE,kCAAyB,MAAM,WAAW;AACxC,eAAO,YACH,KAAK,cACH,MACmB,QACC,aAEtB;;OAlUR;MAAA,KAAA;MAAA,OA6UE,qBAAY,KAAK,cAAc;AAC7B,YAAM,OAAO,OAAO,OAAO;AAC3B,eAAO,IAAI,SAAS,KAAK,iBAAiB,cAAc,MAC9C,OAAO,KACd,KAAK,WAAA;AAAA,iBAAM;;;OAjVlB;MAAA,KAAA;MAAA,OA0VE,mCAA0B,SAAS;AACjC,YAAM,MAAM,QAAQ,aAAa;AACjC,YAAM,aAAa,IAAI,SAAS,KAAK,iBAAiB,cAAc;AACpE,YAAM,YAAY,KAAK,wBAAwB;AAC/C,YAAI,WAAW;AACb,iBAAO,WAAW,OAAO,SAAC,GAAD;AAAA,mBAAO,CAAC,UAAU;;eACtC;AAEL,iBAAO;;;OAlWb;MAAA,KAAA;MAAA,OA8WE,gCAAuB,KAAK,aAAa;AACvC,YAAM,cAAc,mBAClB,aACkB,MAClB;AACF,YAAM,cAAc,mBAClB,KACkB,MAClB;AACF,YAAI,eAAe,aAAa;AAC9B,iBAAO,MAAM,OAAK,yCAAyC;AAC3D,iBAAO;;AAET,mBACE,gBAAgB,cAChB,gDACA;AAGF,eAAO;;OAjYX;MAAA,KAAA;MAAA,OAuYE,6BAAoB;AAClB,eAAO,KAAK;;;AAxYhB,WAAA;;AAkZO,uCAAqC,UAAU;AACpD,WAAO,SAAS,QAAQ,sBAAsB;;AAMzC,+CAA6C,QAAQ;AAC1D,iCAA6B,QAAQ,eAAe,SAAU,KAAK;AACjE,aAAO,IAAI,gBAAgB,KAAK,IAAI,qBAAqB;;;;;;;;;;;;;;;;;;;;;;;;;;;MCpnCvD,SAAA,2BAAA;;;;;;aAcJ,+BAA6B,MAAM,IAAI,IAAI,IAAI,IAAI,IAAI,IAAI,IAAI,IAAI;AACjE,eAAO,QAAO,WACZ,QAAO,yBAAyB,MAAM,IAAI,IAAI,IAAI,KAClD,IACA,IACA,IACA;;;;aAiBJ,kCAAgC,MAAM,IAAI,IAAI,IAAI,IAAI;AAEpD,YAAM,UAAU;AAGhB,YAAI,IAAK,QAAO,MAAO,MAAK;AAC5B,YAAI,KAAK,GAAG;AACV,iBAAO;mBACE,KAAK,GAAG;AACjB,iBAAO;;AAIT,YAAI,OAAO;AACX,YAAI,OAAO;AACX,YAAI,QAAQ;AACZ,iBAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,kBAAQ,QAAO,WAAW,GAAG,IAAI,IAAI,IAAI;AACzC,cAAM,aACH,SAAO,WAAW,IAAI,SAAS,IAAI,IAAI,IAAI,MAAM,SAAS;AAC7D,cAAI,KAAK,IAAI,QAAQ,QAAQ,SAAS;AACpC,mBAAO;qBACE,KAAK,IAAI,cAAc,SAAS;AACzC;iBACK;AACL,gBAAI,QAAQ,MAAM;AAChB,qBAAO;mBACF;AACL,qBAAO;;AAET,iBAAM,SAAQ,QAAQ;;;AAO1B,iBAAS,KAAI,GAAG,KAAK,IAAI,QAAQ,QAAQ,WAAW,KAAI,GAAG,MAAK;AAC9D,cAAI,QAAQ,MAAM;AAChB,mBAAO;AACP,gBAAK,KAAI,QAAQ;iBACZ;AACL,mBAAO;AACP,gBAAK,KAAI,QAAQ;;AAEnB,kBAAQ,QAAO,WAAW,GAAG,IAAI,IAAI,IAAI;;AAE3C,eAAO;;;;aAaT,oBAAkB,GAAG,IAAI,IAAI,IAAI,IAAI;AAEnC,YAAI,KAAK,GAAG;AACV,iBAAO;mBACE,KAAK,GAAG;AACjB,iBAAO;;AAIT,YAAI,MAAM,QAAO,MAAM,IAAI,IAAI;AAC/B,YAAI,MAAM,QAAO,MAAM,IAAI,IAAI;AAC/B,YAAM,MAAM,QAAO,MAAM,IAAI,IAAI;AAGjC,cAAM,QAAO,MAAM,KAAK,KAAK;AAC7B,cAAM,QAAO,MAAM,KAAK,KAAK;AAG7B,eAAO,QAAO,MAAM,KAAK,KAAK;;;;aAahC,oBAAkB,GAAG,IAAI,IAAI,IAAI,IAAI;AAEnC,YAAI,KAAK,GAAG;AACV,iBAAO;mBACE,KAAK,GAAG;AACjB,iBAAO;;AAIT,YAAI,MAAM,QAAO,MAAM,IAAI,IAAI;AAC/B,YAAI,MAAM,QAAO,MAAM,IAAI,IAAI;AAC/B,YAAM,MAAM,QAAO,MAAM,IAAI,IAAI;AAGjC,cAAM,QAAO,MAAM,KAAK,KAAK;AAC7B,cAAM,QAAO,MAAM,KAAK,KAAK;AAG7B,eAAO,QAAO,MAAM,KAAK,KAAK;;;;aAahC,eAAa,IAAG,GAAG,GAAG;AACpB,eAAO,KAAI,IAAK,KAAI;;;;;AASjB,MAAM,SAAS;IAMpB,QANoB,gBAMb,MAAM;AACX,aAAO;;IAQT,MAfoB,cAef,MAAM;AACT,aAAO,OAAO,sBAAsB,MAAM,GAAG,GAAG,MAAM,KAAK,MAAM,GAAK,GAAG;;IAQ3E,SAxBoB,iBAwBZ,MAAM;AACZ,aAAO,OAAO,sBAAsB,MAAM,GAAG,GAAG,MAAM,GAAK,GAAK,GAAK,GAAG;;IAQ1E,UAjCoB,kBAiCX,MAAM;AACb,aAAO,OAAO,sBAAsB,MAAM,GAAG,GAAG,GAAK,GAAK,MAAM,GAAK,GAAG;;IAQ1E,aA1CoB,qBA0CR,MAAM;AAChB,aAAO,OAAO,sBAAsB,MAAM,GAAG,GAAG,MAAM,GAAK,MAAM,GAAK,GAAG;;;AAO7E,MAAM,WAAW;IACf,UAAU,OAAO;IACjB,QAAQ,OAAO;IACf,WAAW,OAAO;IAClB,YAAY,OAAO;IACnB,eAAe,OAAO;;;;AC1PjB,sCAAoC,KAAK;AAE9C,QAAM,sBAAsB,wBAC1B,KACA,mBACA;AAEF,QAAI,IAAI,sBAAsB;AAC5B,aAAO,IAAI;;AAIb,QAAM,aAAa,wBAAwB,KAAK,UAAU;AAC1D,QAAI,IAAI,aAAa;AACnB,aAAO,IAAI,cAAc,gBAAgB,SAAS,gBAAgB;;AAGpE,WAAO,gBAAgB;;AAUlB,4BAA0B,KAAK;AACpC,WAAO,2BAA2B,QAAQ,gBAAgB;;AAOrD,+CAA6C,KAAK,SAAS;AAChE,QAAI,CAAC,IAAI,kBAAkB;AACzB;;AAEF,QAAM,wBAAwB,yBAAyB;AACvD,QAAI,uBAAuB;AACzB,UAAI,iBAAiB,uBAAuB;;;AAQzC,kDAAgD,KAAK,SAAS;AACnE,QAAI,CAAC,IAAI,qBAAqB;AAC5B;;AAEF,QAAM,wBAAwB,yBAAyB;AACvD,QAAI,uBAAuB;AACzB,UAAI,oBAAoB,uBAAuB;;;AAQnD,oCAAkC,KAAK;AACrC,QAAM,aAAa,wBAAwB,KAAK,UAAU;AAC1D,QAAM,aAAa,WAAW,QAAQ;AACtC,WAAO,cAAc,KACjB,WAAW,UAAU,GAAG,cAAc,qBACtC;;;;;;;;;;;;;;;;;;;;;;;;;;AC5DN,MAAM,aAAa;AAyBnB,MAAa,QAAb,2BAAA;AAIE,oBAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,MAAM;AAGX,WAAK,iBAAiB,SAAS,iBAAiB,KAAK;AAGrD,WAAK,OAAO,KAAK;AAMjB,WAAK,SAAS;AAMd,WAAK,aAAa;AAMlB,WAAK,UAAU;AAMf,WAAK,cAAc;AAMnB,WAAK,aAAa;AAGlB,WAAK,oBAAoB;AAGzB,WAAK,qBAAqB;AAG1B,WAAK,0BAA0B,KAAK,mBAAmB,KAAK;AAS5D,WAAK,iBAAiB,IAAI,KACxB,KAAK,KACL,KAAK,yBACL;AAUF,WAAK,cAAc,IAAI,KACrB,KAAK,KACL,KAAK,yBAGL,aAAa;AAMf,WAAK,4BAA4B,KAAK,qBAAqB,KAAK;AAChE,UAAI,KAAK,eAAe,eAAe;AAGrC,aAAK,eACF,eACA,oBAAoB,KAAK;aACvB;AAGL,4CACE,KAAK,IAAI,UACT,KAAK;;;AAhGb,mBAAA,QAAA,CAAA;MAAA,KAAA;MAAA,OAsGE,mBAAU;AACR,+CACE,KAAK,IAAI,UACT,KAAK;;OAzGX;MAAA,KAAA;MAAA,OA8GE,gCAAuB;AACrB,YAAI,KAAK,YAAY;AACnB,eAAK;;;OAhHX;MAAA,KAAA;MAAA,OA6HE,aAAI,MAAM,WAAW;AACnB,aAAK,OAAO,KAAK;AACjB,aAAK,QAAQ,KAAK,aAAa;AAC/B,aAAK;;OAhIT;MAAA,KAAA;MAAA,OA8IE,oBAAW,MAAM,WAAW;AAC1B,aAAK,IAAI,MAAM;AACf,YAAI,KAAK,mBAAmB;AAC1B,iBAAO,KAAK;;AAEd,YAAM,WAAW,IAAI;AACrB,aAAK,qBAAqB,SAAS;AACnC,eAAQ,KAAK,oBAAoB,SAAS;;OArJ9C;MAAA,KAAA;MAAA,OA6JE,oBAAW,MAAM;AAAA,YAAA,QAAA;AACf,eACE,SAAC,WAAc;AACb,gBAAK,IAAI,MAAM;;;OAhKvB;MAAA,KAAA;MAAA,OAyKE,gBAAO,SAAS;AACd,aAAK,IAAI;UACP,SAAS;UACT,QAAQ;;;OA5Kd;MAAA,KAAA;MAAA,OAqLE,uBAAc,SAAS;AACrB,eAAO,KAAK,WAAW;UACrB,SAAS;UACT,QAAQ;;;OAxLd;MAAA,KAAA;MAAA,OAgME,iBAAQ,UAAU;AAChB,aAAK,IAAI;UACP,SAAS;UACT,QAAQ;;;OAnMd;MAAA,KAAA;MAAA,OA6ME,wBAAe,UAAU;AAAA,YAAA,SAAA;AACvB,eAAO,IAAI,QAAQ,SAAC,SAAY;AAC9B,iBAAK,QAAQ,WAAM;AACjB,oBAAQ;;;;OAhNhB;MAAA,KAAA;MAAA,OA0NE,oBAAW,aAAa;AACtB,eAAO,KAAK,YAAY,UAAU;;OA3NtC;MAAA,KAAA;MAAA,OAmOE,qBAAY,iBAAiB;AAE3B,YAAI,iBAAiB,KAAK,IAAI,WAAW;AACvC,iBAAO;;AAIT,YAAI,KAAK,eAAe,eAAe;AACrC,iBAAO,KAAK,eAAe,eAAe;;AAI5C,YAAI,iBAAiB;AACnB,cAAM,SAAS,KAAK,eAAe,qBAAqB;AACxD,iBAAO,CAAC,UAAU,OAAO;;AAG3B,eAAO;;OApPX;MAAA,KAAA;MAAA,OA+PE,iBAAQ,aAAa,MAAM,WAAW;AAEpC,YAAI,CAAC,KAAK,YAAY,cAAc;AAClC,gBAAM,KACJ,SACA;AAEF,iBAAO;;AAET,aAAK,IAAI,MAAM;AACf,eAAO;;OAzQX;MAAA,KAAA;MAAA,OAmRE,wBAAe,aAAa,MAAM;AAAA,YAAA,SAAA;AAChC,eACE,SAAC,WAAc;AACb,iBAAO,OAAK,QAAQ,aAAa,MAAM;;;OAtR/C;MAAA,KAAA;MAAA,OAySE,6BAAoB,aAAa,SAAS,aAAa;AAAA,YAAA,SAAA;AACrD,YAAI,CAAC,KAAK,YAAY,cAAc;AAClC,iBAAO,QAAQ,OAAO;;AAExB,eAAO,IAAI,QAAQ,SAAC,SAAS,QAAW;AACtC,cAAM,YAAY,KAAK;AACvB,cAAI,WAAW;AACf,cAAM,OAAO,OAAK,eAAe,aAAa;YAC5C,QAAQ,gBAAC,OAAU;AACjB,kBAAM,iBAAiB,KAAK,QAAQ;AACpC,kBAAM,MAAM,QAAQ,gBAAgB,iBAAiB,UAAU;AAC/D,kBAAI,CAAC,KAAK;AACR;yBACS,eAAe,iBAAiB,aAAa;AACtD,uBAAO,IAAI,MAAM;qBACZ;AACL,2BAAW;AACX,qBAAK;;;;AAIX,eAAK;;;OA9TX;MAAA,KAAA;MAAA,OAmUE,qBAAY;AACV,YAAI,KAAK,YAAY;AACnB;;AAGF,aAAK,aAAa;AAClB,aAAK;;OAzUT;MAAA,KAAA;MAAA,OA6UE,0BAAiB;AACf,YAAI,KAAK,eAAe;AACtB,eAAK,KAAK,KAAK;AACf,eAAK,YAAY;eACZ;AACL,eAAK,eAAe;;;OAlV1B;MAAA,KAAA;MAAA,OA4VE,8BAAqB;AACnB,aAAK,YAAY;AACjB,aAAK,aAAa;AAElB,YAA2B,WAA4C,KAAhE,oBAAuC,SAAyB,KAAlC,SAAyB,QAAS,KAAjB;AACtD,aAAK,qBAAqB;AAC1B,aAAK,oBAAoB;AAEzB,aAAK,SAAS,KAAK;AACnB,aAAK,UAAU,KAAK;AACpB,iBAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,cAAI,MAAM,GAAG,SAAS;AACpB,gBAAI,CAAC,UAAU,MAAM,GAAG,SAAS,OAAO,KAAK;AAE3C,oBAAM,GAAG,SAAS;;;;AAIxB,iBAAS,KAAI,GAAG,KAAI,MAAM,QAAQ,MAAK;AACrC,cAAI,MAAM,IAAG,QAAQ;AACnB,sBAAU,MAAM,IAAG,QAAQ,OAAO;;;AAItC,aAAK,aAAa;AAClB,aAAK,cAAc;AACnB,aAAK,WAAW,SAAS;AACzB,aAAK,YAAY,SAAS;AAC1B,YAAI,UAAU;AACZ;;;OAzXN;MAAA,KAAA;MAAA,OAgYE,mBAAU;AAAA,YAAA,SAAA;AACR,YAAM,MACJ,KAAK,IAAI,yBAAyB,KAAK,IAAI;AAC7C,YAAI,KAAK;AACP,iBAAO,IAAI,KAAK,KAAK;;AAEvB,YAAI,WAAW;AACf,eAAO,SAAC,IAAO;AACb,cAAM,MAAM,KAAK;AAGjB,cAAM,aAAa,KAAK,IAAI,GAAG,aAAc,OAAM;AACnD,qBAAW,MAAM;AACjB,iBAAK,IAAI,WAAW,IAAI;;;;AA7Y9B,WAAA;;AAwZA,qBAAmB,UAAU,OAAO;AAClC,cAAU;AACV,QAAI;AACF,UAAM,MAAM,SAAS;AACrB,UAAI,QAAQ,QAAW;AACrB,cAAM,MACJ,SACA,+DACA,SAAS;;aAGN,GAAP;AACA,mBAAa;AACb,aAAO;;AAET,WAAO;;AAeF,+BAA6B,SAAQ;AAC1C,wBAAoB;AACpB,2BAAuB,SAAQ,SAAS;;;;ACvbnC,kCAAgC,KAAK;AAC1C,eAAW;AACX,iBAAa;AACb,kBAAc;;AAQT,kCAAgC,QAAQ;AAC7C,yBAAqB;AACrB,6BAAyB;AACzB,2BAAuB;AACvB,wBAAoB;AACpB,wBAAoB;AACpB,sBAAkB;AAClB,wBAAoB;AACpB,6BAAyB;;;;;;;;;;;;;;;;;;;;;;;;;;AC5CpB,MAAM,kBAAkB,CAAC,UAAU,aAAa;AACvD,MAAM,QAAM;AACZ,MAAM,kBAAkB;AACxB,MAAM,kBAAiB;AACvB,MAAM,oBAAoB;AAC1B,MAAM,cAAc;AACpB,MAAM,qBAAqB;AAuDpB,oCAAkC,SAAQ;AAC/C,2BAAuB,SAAQ,cAAc;;AAO/C,MAAa,aAAb,2BAAA;AAIE,yBAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,MAAM;AAGX,WAAK,iBAAiB,SAAS,iBAAiB;AAGhD,WAAK,cAAc;AAGnB,WAAK,sBAAsB;AAG3B,WAAK,2BAA2B;AAGhC,WAAK,0BAA0B;;AArBnC,mBAAA,aAAA,CAAA;MAAA,KAAA;MAAA,OAoCE,2BAAkB,aAAa,SAAS,QAAQ,SAAS,KAAK;AAAA,YAAA;AAC5D,YAAM,eAAe,SACjB,KAAK,YAAY,aAAa,aAAa,oBAC3C;AACJ,YAAM,SAAS,KAAK,oBAClB,aACA,SAFa,sBAQb,gBARa,OAAA,SAQb,aAAc,SARD,OAAA,qBAQS;AAExB,eAAO,SAAS;AAEhB,YAAI,OAAO,QAAQ;AAIjB;;AAKF,YAAI,QAAQ;AACV,eAAK,YAAY,aAAa,aAAa,oBAAmB;;AAGhE,YAAI;AACF,eAAK,sBAAsB;AAC3B,eAAK,2BAA2B;AAChC,eAAK,0BAA0B;AAC/B,kBAAQ,KAAK,IAAI;AACjB,cAAI,QAAQ,KAAK,KAAK,YAAY,QAAQ,KAAK,KAAK,MAAM;AACxD,gBAAI,OAAO,QAAQ;AACjB,kBAAM,IAAI,OAAO;AACjB,gBAAE,WAAW,OAAO,OAAO,EAAE;AAC7B,qBAAO,YAAY,OAAO,OAAO;;;AAGrC,iBAAO,SAAS;AAChB,iBAAO,WAAP,OAAA,SAAA,OAAO,QAAU,OAAO;AACxB,0BAAY,OAAZ,SAAA,aAAc,WAAd,OAAA,SAAA,aAAc,QAAU,OAAO;iBACxB,GAAP;AACA,iBAAO,QAAQ;AACf,iBAAO,UAAP,OAAA,SAAA,OAAO,OAAS;AAChB,0BAAY,OAAZ,SAAA,aAAc,UAAd,OAAA,SAAA,aAAc,OAAS;AACvB,gBAAM;kBAnBR;AAqBE,eAAK,sBAAsB;AAC3B,eAAK,2BAA2B;AAChC,eAAK,0BAA0B;;;OAxFrC;MAAA,KAAA;MAAA,OAmGE,0BAAiB,aAAa,SAAS;AACrC,YAAM,OAAO,KAAK,SAAS,KAAK,oBAAoB,aAAa;AAEjE,eAAO,SAAS,SAAS,KAAK,KAC3B,eAAe,MAAO,MACtB,MAAM,SAAC,KAAQ;AACd,cAAI,CAAC,IAAI,QAAQ,SAAS,YAAY;AACpC,kBAAM;;AAGR,iBAAO,MAAM,OAAb,uCAAuD,cAAvD;AACA,iBAAO;;;OA9Gf;MAAA,KAAA;MAAA,OAyHE,0BAAiB,aAAa,SAA2B;AAAA,YAA3B,YAA2B,QAAA;AAA3B,oBAAU;;AACtC,YAAI,eAAe,aAAa;AAC9B,wBAAc;;AAEhB,YAAM,SAAS,KAAK,oBAAoB,aAAa;AACrD,aAAK,+BAA+B,aAAa,SAAS;AAC1D,eAAO,KAAK,SAAS;;OA/HzB;MAAA,KAAA;MAAA,OA0IE,gCAAuB,QAAQ,aAAa,SAA2B;AAAA,YAAA,QAAA;AAAA,YAA3B,YAA2B,QAAA;AAA3B,oBAAU;;AACpD,YAAM,WAAW,OAAO;AACxB,YAAI,aAAa,SAAS;AAC1B,YAAI,CAAC,YAAY;AACf,uBAAa,SAAS,eAAe;;AAEvC,YAAI,WAAW,cAAc;AAC3B,iBAAO,WAAW;;AAEpB,eAAO,iBAAiB,aAAa;AACrC,8BAAsB,OAAO,KAAK;AAClC,eAAQ,WAAW,eAAe,KAAK,iBACrC,aACA,SACA,KAAK,WAAA;AAAA,iBAAM,MAAK,sBAAsB,QAAQ,aAAa;;;OAxJjE;MAAA,KAAA;MAAA,OAkKE,yBAAgB,aAAa,SAAS,QAAQ;AAE5C,YAAM,MAAM,oBACV,KAAK,KACL,aACA,SACA,QACsB;AAIxB,YAAM,SAAS,KAAK,YAAY,aAAa,aAAa;AAC1D,YAAI,QAAQ;AACV,oBAAU,CAAC,OAAO,UAAU,CAAC,OAAO;AACpC,iBAAO,gBAAgB;;AAEzB,YAAI,QAAQ,SAAC,IAAD;AAAA,iBACV,GAAG,aAAa,gCAAgC;;AAElD,eAAO,KAAK,iBAAiB,aAAa;;OArL9C;MAAA,KAAA;MAAA,OA+LE,yBAAgB,KAAK,aAAa,SAA2B,QAAe;AAAA,YAA1C,YAA0C,QAAA;AAA1C,oBAAU;;AAAgC,YAAf,WAAe,QAAA;AAAf,mBAAS;;AACpE,YAAM,gBAAgB,oBACpB,KACA,aACA,SACA;AAEF,YAAI,gBAAgB,cAAc,SAAS,IAAI,cAAc,KAAK;AAClE,YAAI;AACJ,YAAI,eAAe;AACjB,oBAAU,cAAc;eACnB;AACL,0BAAgB,sBAAsB,KAAK,KAAK,aAAa;AAC7D,oBAAU,cAAc,sBAAsB,IAAI,QAChD,SAAC,SAAS,QAAW;AACnB,0BAAc,SAAS;AACvB,0BAAc,UAAU;;AAG5B,cAAI,SAAS,KAAK,YAAY;;AAEhC,eAAO;;OApNX;MAAA,KAAA;MAAA,OA+NE,0BAAiB,aAAa,SAA2B;AAAA,YAA3B,YAA2B,QAAA;AAA3B,oBAAU;;AACtC,eAAO,KAAK,iBAAiB,aAAa,SAAS,KAAK,SAAC,WAAc;AACrE,cAAM,UAAU,UACd,UAAU,SAAS,cACnB,yBACA;AAEF,iBAAO,QAAQ;;;OAtOrB;MAAA,KAAA;MAAA,OAmPE,oBAAW,MAAM,qBAAqB,KAAK;AAAA,YAAA,SAAA;AACzC,YAAM,SAAS,KAAK,2BAA2B;AAC/C,eAAO,UAAU,SAAS,QAAQ;UAAC;UAAqB;;AACxD,aAAK,cAAc,SAAC,QAAW;AAC7B,iBAAK,gBAAgB,QAAQ,MAAM,qBAAqB;;;OAvP9D;MAAA,KAAA;MAAA,OAmQE,qBAAY,MAAM,qBAAqB;AACrC,aAAK,cAAc,SAAC,QAAW;AAC7B,yCAA+B,QAAQ,MAAM;;;OArQnD;MAAA,KAAA;MAAA,OAiRE,yBAAgB,QAAQ,MAAM,qBAAqB,KAAK;AAAA,YAAA,SAAA;AACtD,YAAI,KAAK;AACP,8BACE,QACA,KACA,WAAM;AACJ,mBAAK,yBAAyB,OAAO,KAAK,MAAM;aAE/B,OACnB;eAEG;AACL,eAAK,yBAAyB,OAAO,KAAK,MAAM;;;OA7RtD;MAAA,KAAA;MAAA,OAuSE,kCAAyB,KAAK,MAAM,qBAAqB;AAEvD,iCAAyB,KAAK,MAAM;AAEpC,+BAAuB,KAAK,MAAM;;OA3StC;MAAA,KAAA;MAAA,OAqTE,oBAAW,MAAM,qBAAqB;AACpC,YAAM,SAAS,KAAK,2BAA2B;AAC/C,eAAO,UAAU,SAAS,KACa;UACnC,aAAa;UACb,cAAc;;AAGlB,aAAK,cAAc,SAAC,QAAW;AAC7B,uCACE,QACA,MACA,qBACkB;;;OAlU1B;MAAA,KAAA;MAAA,OA+UE,uBAAc,SAAS,aAAa;AAClC,YAAM,SAAS,KAAK,2BAA2B;AAC/C,eAAO,aAAa,KAAK;AAGzB,YAAI,KAAK,uBAAuB,KAAK,eAAe,eAAe;AACjE,cAAM,SAAS,KAAK,eAAe,UAAU,KAAK,IAAI;AACtD,cAAM,cAAc,MAAM,aAAa,KAAK;AAC5C,cAAM,UAAU,MAAM,aAAa,KAAK;AACxC,cAAM,SAAS,KAAK,2BAA2B;AAG/C,cACE,OAAO,kBAAkB,aAAa,YACrC,UAAU,OAAO,kBAAkB,aAAa,oBACjD,OAAO,MACP;AACA,oBAAQ;;;;OAhWhB;MAAA,KAAA;MAAA,OA2WE,yBAAgB,QAAQ,YAAY;AAClC,YAAM,SAAS,KAAK;AACpB,YAAM,WAAW,OAAO;AAGxB,yCAAiC,QAAQ;AACzC,2BAAmB;AAGnB,mBAAW,QAAQ,SAAA,MAAqC;AAAA,cAAnC,cAAmC,KAAnC,aAAa,mBAAsB,KAAtB;AAGhC,iBAAO,iBAAiB,aAAa;AAIrC,cAAI,CAAC,gBAAgB,SAAS,cAAc;AAC1C,kCAAsB,UAAU;;;;OA5XxC;MAAA,KAAA;MAAA,OAyYE,gCAAuB,QAAQ,YAAY;AAAA,YAAA,SAAA;AACzC,eAAO,QAAQ,IACb,WAAW,IAAI,SAAA,OAAA;AAAA,cAAE,cAAF,MAAE,aAAa,mBAAf,MAAe;AAAf,iBACb,OAAK,sBAAsB,QAAQ,aAAa;;;OA5YxD;MAAA,KAAA;MAAA,OAwZE,+BAAsB,QAAQ,aAAa,SAA2B;AAAA,YAAA,SAAA;AAAA,YAA3B,YAA2B,QAAA;AAA3B,oBAAU;;AACnD,eAAO,iBAAiB,aAAa;AACrC,eAAO,KAAK,SAAS,KAAK,oBAAoB,aAAa,UAAU,KACnE,WAAM;AACJ,cAAM,SAAS,OAAK,oBAAoB,aAAa;AACrD,iBAAO,aAAa,QAAQ,SAAC,SAAY;AACvC,gBAAI;AACF,sBAAQ;qBACD,GAAP;AACA,2BAAa,wBAAwB,GAAG;;;;;OAjapD;MAAA,KAAA;MAAA,OAgbE,6BAAoB,aAAa,SAAS,UAAU;AAClD,YAAM,MAAM,aAAa,aAAa;AACtC,YAAI,SAAS,KAAK,YAAY;AAC9B,YAAI,CAAC,QAAQ;AACX,cAAM,YAAyC;YAC7C,UAAU;YACV,UAAU;;AAEZ,mBAA4C;YAC1C;YAGA,QAAQ,WAAW;YACnB;YACA,MAAM,YAAY;YAClB,cAAc;YACd,SAAS;YACT,SAAS;YACT,QAAQ;YACR,QAAQ;YACR,OAAO;YACP,eAAe;;AAEjB,eAAK,YAAY,OAAO;;AAE1B,eAAO;;OAzcX;MAAA,KAAA;MAAA,OAkdE,oCAA2B,aAAa;AACtC,YAAI,CAAC,KAAK,uBAAuB,CAAC,QAAQ,KAAK,KAAK,MAAM;AACxD,gBAAM,MAAM,OAAK,0BAA0B;;AAE7C,eAAO,KAAK,oBACV,KAAK,uBAAuB,mBAC5B,KAAK,4BAA4B;;OAxdvC;MAAA,KAAA;MAAA,OAmeE,kBAAS,QAAQ;AACf,YAAI,CAAC,OAAO,SAAS;AACnB,cAAI,OAAO,QAAQ;AACjB,mBAAO,UAAU,QAAQ,QAAQ,OAAO;qBAC/B,OAAO,OAAO;AACvB,mBAAO,UAAU,QAAQ,OAAO,OAAO;iBAClC;AACL,gBAAM,WAAW,IAAI;AACrB,mBAAO,UAAU,SAAS;AAC1B,mBAAO,UAAU,SAAS;AAC1B,mBAAO,SAAS,SAAS;;;AAG7B,eAAO,OAAO;;OAhflB;MAAA,KAAA;MAAA,OA0fE,wCAA+B,aAAa,SAAS,QAAQ;AAC3D,YAAI,KAAK,2BAA2B,aAAa,SAAS,SAAS;AACjE,cAAM,gBAAgB,sBACpB,KAAK,KACL,aACA;AAEF,eAAK,IAAI,SAAS,KAAK,YAAY;AACnC,iBAAO,gBAAgB;;;OAlgB7B;MAAA,KAAA;MAAA,OA8gBE,oCAA2B,aAAa,SAAS,QAAQ;AACvD,YAAI,OAAO,UAAU,OAAO,OAAO;AACjC,iBAAO;;AAET,YAAI,OAAO,kBAAkB,QAAW;AACtC,cAAM,gBAAgB,oBACpB,KAAK,KACL,aACA,SACA,OAAO;AAET,iBAAO,gBAAgB,cAAc,SAAS;;AAEhD,eAAO,CAAC,OAAO;;;AA3hBnB,WAAA;;AAkiBO,8BAA4B,KAAK;AACtC,oBAAgB,QAAQ,SAAC,MAAS;AAChC,4BAAsB,KAAK;;;AAS/B,4CAA0C,WAAW,UAAU;AAC7D,6BAAyB,WAAW,UAAU;AAC9C,6BAAyB,WAAW,UAAU;;AAMhD,0BAAwB;AAEtB,WAAO;;AAQT,wBAAsB,aAAa,SAAS;AAC1C,WAAU,cAAV,MAAyB;;;;ACpnB3B;AACA,iBAAe,kBAAkB,KAAK,MAAM;AAG5C,MAAM,QAAM;AA4BZ,uBAAqB,QAAQ,UAAU;AAErC,QAAI,OAAO,WAAW;AACpB,aAAO;;AAET,WAAO,YAAY;AAInB,QAAM,0BAA0B,OAAO,OAAO;AAE9C,6BAAyB;AAEzB,QAAM,aAAa,SAAS,cAAc;AAC1C,2BAAuB;AACvB,uBAAmB;AAEnB,WAAO,MAAM;MACX,KAAK;MAEL,KAAK,OAAO,MAAM,OAAO,IAAI,OAAO;;AAMtC,QAAI,CAAC,UAAU,UAAU;AAOvB,aAAO,IAAI,YAAY,SAAU,YAAY,eAAe,WAAW;AACrE,kBAAU,OAAO;;;AAKrB,WAAO,IAAI,SAAS;AAEpB,WAAO,IAAI,cAAc;AAQzB,WAAO,IAAI,kBAAkB,WAAW,WAAW,KAAK;AAOxD,WAAO,IAAI,mBAAmB,WAAW,YAAY,KAAK;AAO1D,WAAO,IAAI,wBAAwB,WAAW,WAAW,KAAK;AAO9D,WAAO,IAAI,iBAAiB,eAAe,KAAK,MAAM;AAOtD,WAAO,IAAI,mBAAmB,iBAAiB,KAAK,MAAM;AAK1D,WAAO,IAAI,cAAc,iBAAiB,KAAK;AAQ/C,WAAO,IAAI,kBAAkB,SAAC,UAAU,WAAc;;AAGtD,QAAM,aAAa,SAAS,QAAQ;AAKpC,8BAA0B,aAAY;AACpC,UAAM,WAAW,qBAAM;AACrB,mBAAW,KAAK,WAAM;AACpB,cAAI,OAAO,eAAc,YAAY;AACnC,wBAAW,OAAO,KAAK,OAAO,IAAI;iBAC7B;AACL,uBAAW,kBACT,YAAW,GACX,YAAW,IACX,YAAW,GACX,YAAW,GACX,OAAO;;;;AAMf,2BAAqB,QAAQ,aAAY;;AAM3C,aAAS,IAAI,GAAG,IAAI,wBAAwB,QAAQ,KAAK;AACvD,UAAM,aAAa,wBAAwB;AAC3C,UAAI,wBAAwB,QAAQ,aAAa;AAC/C,gCAAwB,OAAO,KAAK;iBAC3B,OAAO,cAAc,cAAc,WAAW,KAAK,QAAQ;AACpE,YAAI;AACF,2BAAiB;iBACV,GAAP;AAGA,gBAAM,MAAM,OAAK,sBAAsB,GAAG,WAAW;;AAGvD,gCAAwB,OAAO,KAAK;;;AAIxC,wBAAoB,QAAQ,WAAM;AAKhC,aAAO,IAAI,OAAO,SAAU,aAAY;AACtC,YAAI,wBAAwB,QAAQ,cAAa;AAC/C;;AAEF,yBAAiB;;AAGnB,eAAS,KAAI,GAAG,KAAI,wBAAwB,QAAQ,MAAK;AACvD,YAAM,cAAa,wBAAwB;AAC3C,YAAI,wBAAwB,QAAQ,cAAa;AAC/C;;AAEF,YAAI;AACF,2BAAiB;iBACV,GAAP;AAGA,gBAAM,MAAM,OAAK,sBAAsB,GAAG,YAAW;;;AAMzD,8BAAwB,SAAS;;AAInC,QAAI,CAAC,OAAO,IAAI,MAAM;AACpB,aAAO,IAAI,OAEP,wBAAwB,KAAK,KAAK;;AAMxC,QAAI,SAAS,YAAY,QAAQ,SAAS;AACxC,eAAS,OAAO,SAAS,iBAAiB,UAAU;;AAItD,QAAM,gBAAgB,SAAS,cAAc;AAC7C,QAAI,oBAAwB,SAAS;AACnC,oBAAc,iBAAiB;;AAEjC,QAAI,mBAAuB,SAAS;AAClC,oBAAc,iBAAiB;;AAGjC,WAAO;;AAQT,gCAA8B,QAAQ,YAAY,UAAU;AAC1D,QAAI,OAAO,cAAc,cAAc,WAAW,KAAK,QAAQ;AAU7D,wBAAkB,KAAK;WAClB;AACL,eAAS,cAAc,WAAW;AAClC,mBAAa,OAAO,UAAU;;;AAU3B,kBAAe,QAAQ;AAC5B,WAAO,YAAY,QAAQ,SAAC,SAAW;AAErC,gCAA0B;AAE1B,aAAO,uBAAuB,QAAO,UAAU,KAAK,WAAM;AAExD,2BAAmB,QAAO,IAAI;;;;AA8BpC,qCAAmC,QAAQ;AACzC,QAAO,kBAAmB,OAAO,SAA1B;AAEP,QAAM,iBAAgB,SAAS,iBAAiB;AAChD,QAAM,SAAS,eAAc;AAC7B,WAAO,IAAI,SAAS;AAEpB,QAAM,SAAS,SAAS,aAAa;AACrC,WAAO,IAAI,SAAS;AAEpB,QAAI,UAAU,aAAa;AACzB,aAAO,IAAI,gBAAgB,OAAO,cAAc,KAAK;AACrD,aAAO,IAAI,YAAY,SAAS,gBAAgB;;AAGlD,QAAM,WAAW,SAAS,eAAe;AACzC,WAAO,IAAI,WAAW;AACtB,WAAO,IAAI,SAAS,gBAAgB,SAAS,cAAc,KAAK;AAChE,WAAO,IAAI,SAAS,iBAAiB,SAAS,eAAe,KAAK;AAClE,WAAO,IAAI,SAAS,WAAW,SAAS,SAAS,KAAK;;AA0ExD,mCAAiC,KAAK,YAAY;AAChD,QAAI,UAAU,YAAY,eAAe,KAAK,4BAA4B;AACxE,aAAO;;AAET,QAAI,OAAO,cAAc,YAAY;AACnC,aAAO;;AAGT,QAAA,OAAY;AAGV,UAAI,CAAC,WAAW,GAAG;AACjB,eAAO;;WAEJ;AAGL,UAAI,WAAW,GAAG;AAChB,eAAO;;;AAIX,QAAO,IAAK,WAAL;AAIP,QAAI,4BAA4B,GAAG;AACjC,aAAO;;AAET,aAAS,cAAc,KAAK,gBAC1B,WAAW,GACX,WAAW,IACX,WAAW;AAEb,WAAO;;AAUT,+BAA6B,KAAK,IAAI;AAGpC,QAAI,CAAC,IAAI,SAAS,MAAM;AACtB;AACA;;AAEF,QAAI,0BAA0B,MAAM;AAClC;AACA;;AAEF,aAAS,SAAS,KAAK,MAAM,IAAI;;;;ACvc5B,iCAA+B,KAAK;AACzC,oBAAgB,IAAI,UAAU,WAAA;AAAA,aAAM,kBAAkB;;;AAMxD,6BAA2B,KAAK;AAG9B,QAAI,2BAA2B;AAI/B,QAAM,OAAO,IAAI;AACjB,QAAI,QAAQ,KAAK,UAAU,KAAK,OAAO,iBAAiB;AACtD,iCAA2B,KAAK,QAAQ,KAAK,OAAO;;AAItD,QAAM,UAAU,KAAK,IACnB,GACA,OAAO,MAAwC;AAIjD,QAAI,WAAW,WAAM;AAEnB,uBAAiB;AACjB,UAAO,cAAe,IAAI,SAAnB;AACP,UAAI,CAAC,aAAa;AAChB;;AAIF,UAAM,oBAAoB,IAAI,SAAS,iBAAb,yCACe,uBACrC,KAAK,OAFiB;AAO1B,UAAM,sBAAsB;AAC5B,eAAS,IAAI,GAAG,IAAI,kBAAkB,QAAQ,KAAK;AACjD,YAAM,OAAO,kBAAkB;AAC/B,YAAI,QAAQ;AACZ,iBAAS,IAAI,GAAG,IAAI,YAAY,QAAQ,KAAK;AAC3C,cAAI,YAAY,GAAG,aAAa,MAAM;AACpC,oBAAQ;AACR;;;AAGJ,YAAI,CAAC,OAAO;AACV,8BAAoB,KAAK;;;AA3BV,UAAA,QAAA,gBA+BV,KA/BU;AAgCjB,YAAM,QAAO,oBAAoB;AAGjC,YAAM,QAAQ,MAAK,SAAS;AAC5B,cAAK,QAAQ;AAGb,cAAK,SAAS,WAAM;AAClB,gBAAK,QAAQ;AACb,2BAAiB;;AAEnB,cAAK,aAAa,qBAAqB;AAGvC,cAAK,WAAW,aAAa,OAAM,MAAK;;AAf1C,eAAS,KAAI,GAAG,KAAI,oBAAoB,QAAQ,MAAK;AAAA,cAA5C;;OAiBR;;AAiBL,4BAA0B,KAAK;AAC7B,QAAM,MAAM,IAAI;AAEhB,QAAI,CAAC,IAAI,SAAS,CAAC,IAAI,MAAM,WAAW;AACtC;;AAEF,QAAM,KAAK,IAAI,MAAM;AACrB,QAAI;AACJ,WAAQ,QAAQ,GAAG,QAAS;AAC1B,UAAM,WAAW,MAAM;AACvB,UAAI,CAAC,UAAU;AACb;;AAEF,UAAI,SAAS,UAAU,WAAW;AAChC;;AAIF,UAAI,CAAE,cAAa,aAAa,SAAS,WAAW,QAAQ;AAC1D;;AAEF,eAAS,UAAU;;;;;AC9HvB,MAAM,mBAAmB,CACvB,UACA,iBACA,aACA;AAYK,8BACL,iBACA,SACA,MACA,uBACA;AACA,QAAA,MAAmB;AACjB,aAAO,uBAAuB,iBAAiB;;AAEjD,WAAO,0BACL,iBACA,SACA,MACA;;AAeG,qCACL,iBACA,SACA,MACA,uBACA;AACA,QAAM,SAAS,SAAS,OAAO;AAC/B,WAAO,qBAAqB,QAAQ,SAAS,SAAC,GAAM;AAGlD,UACE,CAAC,EAAE,iBACF,CAAC,EAAE,SAAS,SAAS,CAAC,EAAE,aACxB,yBAAyB,CAAC,EAAE,oBAC7B;AACA,eAAO;;AAET,aAAO;OACN,KAAK,SAAC,WAAc;AACrB,UAAM,WAAW;AACjB,gBAAU,QAAQ,SAAC,GAAM;AACvB,YAAI,CAAC,iBAAiB,SAAS,EAAE,QAAQ,UAAU;AACjD,mBAAS,KAAK,EAAE;;;AAGpB,aAAO,QAAQ,IAAI;;;AAahB,kCAAgC,iBAAiB,uBAAuB;AAC7E,QAAM,SAAS,SAAS,OAAO;AAI/B,QAAM,YAAY,OAAO,UAAU,WAAW;AAC9C,WAAO,UAAU,KAAK,WAAM;AAE1B,UAAM,YAAY,SAAS,gBAAgB;AAC3C,UAAM,YAAW,UACd,MACA,OAAO,SAAC,GAAM;AACb,YAAI,yBAAyB,CAAC,EAAE,oBAAoB;AAClD,iBAAO;;AAET,eAAO,CAAC,iBAAiB,SAAS,EAAE,QAAQ;SAE7C,IAAI,SAAC,GAAD;AAAA,eAAO,EAAE;;AAEhB,UAAI,UAAS,WAAW,GAAG;AACzB,eAAO,QAAQ,QAAQ;;AAIzB,aAAO,IAAI,QAAQ,SAAC,SAAY;AAC9B,YAAO,MAAO,OAAP;AACP,YAAM,KAAK,IAAI,IAAI,qBACjB,SAAC,SAAY;AACX,aAAG;AACH,cAAM,eAAe;AACrB,mBAAS,KAAI,GAAG,KAAI,QAAQ,QAAQ,MAAK;AACvC,gBAAA,aAAiC,QAAQ,KAAlC,iBAAP,WAAO,gBAAgB,SAAvB,WAAuB;AACvB,gBAAI,gBAAgB;AAClB,2BAAa,KAAK;;;AAGtB,kBAAQ;WAEV;UAIE,MAAM,UAAU,OAAyB,IAAI,WAAY;UACzD,WAAW;;AAIf,iBAAS,IAAI,GAAG,IAAI,KAAK,IAAI,UAAS,QAAQ,MAAM,KAAK;AACvD,aAAG,QAAQ,UAAS;;SAErB,KAAK,SAAC,WAAa;AACpB,eAAO,QAAQ,IAAI,UAAS,IAAI,SAAC,SAAD;AAAA,iBAAa,QAAQ;;;;;AAcpD,gCAA8B,QAAQ,SAAS,UAAU;AAI9D,WAAO,OACJ,UACA,WAAW,mBACX,KAAK,WAAM;AAEV,UAAM,sBAAsB;AAC5B,UAAM,YAAY,SAAS,gBAAgB;AAC3C,gBAAU,MAAM,QAAQ,SAAC,GAAM;AAC7B,YAAI,CAAC,EAAE,qBAAqB,EAAE,WAAW,WAAW,CAAC,EAAE,YAAY;AACjE,8BAAoB,KAAK,EAAE;;;AAG/B,aAAO,QAAQ,IAAI;OAEpB,KAAK,WAAM;AACV,UAAM,YAAY,SAAS,gBAAgB;AAC3C,aAAO,UAAU,MAAM,OAAO,SAAC,GAAM;AACnC,eACE,EAAE,WAAW,WACb,CAAC,EAAE,cACH,EAAE,qBACF,SAAS;;;;;;ACvKZ,mCAAiC,QAAQ;AAC9C,QAAO,MAAO,OAAP;AACP,QAAM,OAAO,OAAO;AACpB,uBACE,QACA,KACA,SAAS,eAAe,QAAQ,cAC9B,KAAK,mBAAmB,KAAK,QAAQ,OAEvC,KAAK,WAAM;AACX,UAAI,cACF,kBAAkB,KAAK,gBAA6B,MAAM;QAAC,SAAS;;AAEtE,UAAI,IAAI,QAAQ;AACd,YAAI,OAAc,YAAY,gBAAgB;;;;AAU7C,oBAAkB,KAAK;AAC5B,QAAM,eAAe,IAAI,SAAS,KAAK,cACrC;AAGF,QAAI,cAAc;AAChB,aAAO,aAAa,aAAa;;AAGnC,WAAO;;;;;;;;;;;;;;;;;;;;;;;;;;AChCT,MAAa,wBAAb,2BAAA;AAOE,oCAAY,KAAK,YAAY;AAAA,wBAAA,MAAA;AAE3B,WAAK,OAAO;AAEZ,WAAK,cAAc,UAAU,cAAc;AAE3C,WAAK,cAAc,cAAc;AAEjC,WAAK,YAAY;AAEjB,WAAK,iBAAiB;AAMtB,WAAK,iBAAiB;AACtB,WAAK;;AAxBT,mBAAA,wBAAA,CAAA;MAAA,KAAA;MAAA,OAkCE,kBAAQ,aAAa,SAAS,UAAU;AACtC,YAAM,eAAe,cAAc,UAAU;AAC7C,YAAM,YAAY,KAAK;AACvB,YAAM,WAAW,KAAK,iBAAiB,cAAc,SAAC,QAAW;AAC/D,cAAI,OAAO,UAAU,wBAAwB,WAAW;AACtD;AACA,qBAAS,OAAO,UAAU;;;AAG9B,YAAM,OAAO;AACb,aAAK,UAAU,oBAAoB;AACnC,aAAK,UAAU,sBAAsB;AACrC,aAAK,YAAY,aAAa;;OA9ClC;MAAA,KAAA;MAAA,OA0DE,qBAAY,aAAa,cAAc,UAAU;AAC/C,YAAM,WAAW,KAAK,iBAAiB,cAAc;AACrD,aAAK,YAAY;AACjB,eAAO;;OA7DX;MAAA,KAAA;MAAA,OA0EE,qBAAY,aAAa,cAAc,UAAU;AAC/C,YAAM,WAAW,KAAK,iBAAiB,cAAc,SAAC,OAAU;AAC9D;AACA,mBAAS;;AAEX,aAAK,YAAY;AACjB,eAAO;;OAhFX;MAAA,KAAA;MAAA,OA0FE,0BAAiB,aAAa,UAAU;AAItC,eAAO,KAAK,0BAA0B,aAAa,IAAI;;OA9F3D;MAAA,KAAA;MAAA,OAuGE,qBAAY,MAAM,aAAa;AAC7B,YAAM,MAAM,iBACV,MACA,MAAM,aAAa,KAAK,YACxB,aACA,KAAK;AAGP,YAAI,CAAC,KAAK,aAAa;AACrB,mBACM,IAAI,GAAG,UAAU,KAAK,MAC1B,IAAI,MAAM,WAAW,KAAK,KAAK,KAC/B,KACA;AACA,sBAAU,QAAQ;AAClB,iBAAK,qBAAqB,SAAS;AACnC;;eAEG;AACL,eAAK,qBAAqB,KAAK,aAAa;;;OA1HlD;MAAA,KAAA;MAAA,OAmIE,8BAAqB,KAAK,KAAK;AAG7B,YAAI,KAAK,2BAA2B,MAAM;AACxC,eAAK,+BAA+B,KAAK;eACpC;AACL,cAAW,YAAY,KAAK;;;OAzIlC;MAAA,KAAA;MAAA,OAkJE,wCAA+B,KAAK,KAAK;AACvC,YAAW,YACT,KACA,KAAK;UACH,gBAAgB;UAChB,yBAAyB;;;OAvJjC;MAAA,KAAA;MAAA,OAqKE,+BAAsB;AAAA,YAAA,QAAA;AACpB,gBAAO,KAAK,MAAM,WAAW,SAAC,OAAU;AAEtC,cAAI,MAAK,eAAe,MAAM,UAAU,MAAK,aAAa;AACxD;;AAIF,cAAM,UAAU,mBAAmB,QAAQ;AAC3C,cAAI,CAAC,WAAW,QAAQ,eAAe,MAAK,WAAW;AACrD;;AAMF,kBAAQ,YAAY,MAAM;AAE1B,cAAI,CAAC,MAAK,aAAa;AACrB,kBAAK,cAAc,MAAM;;AAG3B,gBAAK,gBAAgB,QAAQ,SAAS;;;OA3L5C;MAAA,KAAA;MAAA,OAkME,qBAAY,UAAU;AACpB,aAAK,YAAY;;OAnMrB;MAAA,KAAA;MAAA,OA0ME,mCAA0B,aAAa;AACrC,YAAI,CAAE,gBAAe,KAAK,iBAAiB;AACzC,eAAK,eAAe,eAAe,IAAI;;AAEzC,eAAO,KAAK,eAAe;;OA9M/B;MAAA,KAAA;MAAA,OAqNE,yBAAgB,aAAa,SAAS;AACpC,YAAI,eAAe,KAAK,gBAAgB;AACtC,eAAK,eAAe,aAAa,KAAK;;;OAvN5C;MAAA,KAAA;MAAA,OA+NE,oCAA2B,KAAK;AAE9B,eAAO,IAAI,YAAY,UAAU;;;AAjOrC,WAAA;;;;ACFO,oCAAkC,KAAK;AAC5C,WACE,yBAAyB,KAAK;;AAO3B,wCAAsC,KAAK;AAChD,QAAI,CAAC,iBAAiB,IAAI,MAAM;AAC9B,6BACE,KACA,yBACA,4BAA4B,KAAK,MAAM,MACjB;;;AAS5B,uCAAqC,KAAK;AACxC,QAAM,eAAe,IAAI,sBAAsB;AAE/C,QAAM,aAAa,aAAa,IAAI;AACpC,QAAI,WAAW;AACf,QAAI,cAAc,WAAW,aAAa;AACxC,iBAAW,WAAW,YAAY;;AAEpC,iBAAa,YAAY,YAAY,UAAU;AAC/C,WAAO;;AAOT,qBAAmB,KAAK;AACtB,WAAO,OAAO,IAAI,KAAK,UAAU,OAAO;;;;;;;;;;;;;;;;;;;;;;;;;;MCzCpC,YAAA,2BAAA;;;;;;aAEJ,eAAM;AACJ,eAAO,QAAQ,QAAQ;;;;aAIzB,kBAAS;;;;;AAOJ,mCAAiC,QAAQ;AAC9C,WAAO,6BAA6B,QAAQ,OAAO;;;;;;;;;;;;;;;;;;;;;;;;;;AClBrD,MAAa,gBAAb,2BAAA;AAIE,4BAAY,QAAQ;AAAA,wBAAA,MAAA;AAElB,WAAK,aAAa,SAAS,gBAAgB;AAG3C,WAAK,SAAS,SAAgB,SAAS,OAAO;;AATlD,mBAAA,gBAAA,CAAA;MAAA,KAAA;MAAA,OAaE,yBAAgB,SAAS,WAAW,UAAU,cAAc,gBAAgB;AAC1E,aAAK,kBAAkB,SAAS,WAAW,UAAU,gBAAgB,KACnE,WAAM;AACJ,cAAI,cAAc;AAChB;;;;OAjBV;MAAA,KAAA;MAAA,OAwBE,2BAAkB,SAAS,WAAW,UAAU,gBAAgB;AAAA,YAAA,QAAA;AAC9D,eAAO,KAAK,cAAc,SAAS,WAAM;AACvC,gBAAK,WACF,sBAAsB,SACtB,WAAW,WAAW,UAAU;;;OA5BzC;MAAA,KAAA;MAAA,OAiCE,uBAAc,SAAS;AACrB,YAAM,WAAW,KAAK,WAAW,sBAAsB;AACvD,iBAAS;AACT,aAAK,WAAkB;;OApC3B;MAAA,KAAA;MAAA,OAwCE,yBAAgB,SAAS;AAAA,YAAA,SAAA;AACvB,eAAO,KAAK,cAAc,SAAS,WAAM;AACvC,iBAAK,WAAW,sBAAsB,SAAS;;;OA1CrD;MAAA,KAAA;MAAA,OA+CE,yBAAgB,SAAS;AACvB,aAAK,WAAW,sBAAsB,SAAS;AAC/C,aAAK,WAAkB;;OAjD3B;MAAA,KAAA;MAAA,OAqDE,wBAAe,UAAU;AACvB,eAAO,KAAK,OAAO,eAAe;;OAtDtC;MAAA,KAAA;MAAA,OA0DE,uBAAc,SAAS,SAAS;AAC9B,eAAO,KAAK,qBAAqB,SAAS,MAAM;;OA3DpD;MAAA,KAAA;MAAA,OA+DE,8BAAqB,SAAS,UAAU,SAAS;AAAA,YAAA,SAAA;AAC/C,eAAO,KAAK,OAAO,WAAW;UAC5B,SAAS,mBAAM;AACb,gBAAI,UAAU;AACZ;;;UAGJ,QAAQ,kBAAM;AACZ;AACA,mBAAK,WAAkB;;;;;AAxE/B,WAAA;;AAiFO,6CAA2C,QAAQ;AACxD,iCAA6B,QAAQ,WAAW;;;;;;;;;;;;;;;;;;;;;;;;;;MChF5C,eAAA,2BAAA;AAIJ,2BAAY,QAAQ;AAAA,wBAAA,MAAA;AAElB,WAAK,UAAU;;;;aAIjB,qBAAY;AACV,eAAO,KAAK;;;;aAId,kBAAS,MAAM;AACb,eAAO,KAAK,QAAQ,SAAS;;;;aAI/B,yBAAgB;AACd,eAAO;;;;aAIT,sBAAa;AACX,eAAO;;;;aAIT,6BAAoB;AAClB,eAAO;;;;aAIT,yBAAgB;AACd,eAAO;;;;aAIT,0BAAgB;AACd,eAAO;;;;aAIT,qCAA4B;;;;aAK5B,uBAAc;AACZ,eAAO;;;;aAIT,yBAAgB;;;;aAGhB,0BAAiB;AACf,eAAO,WAAM;;;;;aAIf,6BAAoB;AAClB,eAAO;;;;aAIT,gCAAuB;AACrB,eAAO,KAAK,QAAQ,IAAI,SAAS;;;;aAInC,mCAA0B;AACxB,eAAO;;;;aAIT,qCAA4B;AAC1B,eAAO,KAAK,QAAQ,IAAI,SAAS;;;;aAInC,0BAAiB;AACf,eAAO,QAAQ,QAAQ,KAAK;;;;aAI9B,2BAAkB;AAChB,eAAO,QAAQ,QAAQ;;;;aAIzB,2BAAkB;AAChB,eAAO,QAAQ,QAAQ;;;;aAIzB,qBAAY;AACV,eAAO,WAAM;;;;;aAIf,4BAAmB;AACjB,eAAO,WAAM;;;;;aAIf,0BAAiB;;;;aAGjB,+BAAsB;;;;aAGtB,uBAAc;;;;aAGd,oCAA2B;AACzB,eAAO;;;;aAIT,qBAAY;AACV,eAAO,QAAQ,QAAQ;;;;aAIzB,uBAAc;AACZ,eAAO,WAAM;;;;;aAIf,8BAAqB;AACnB,eAAO;;;;aAIT,sBAAa;;;;;AAMR,4CAA0C,QAAQ;AACvD,iCACE,QACA,UACA,cACsB;;;;AClJnB,uCACL,QACA,YACA,cACA,kBACA;AAIA,QAAM,aAAa,GACjB,aAAa,QAAQ,IAAI,WAAW,QAAQ,IAAI,WAAW;AAG7D,QAAM,aAAa,GACjB,aAAa,SAAS,IAAI,WAAW,SAAS,IAAI,WAAW;AAG/D,cAAU,QAAQ;MAChB,YAAY;MACZ,OAAO,GAAG,WAAW;MACrB,SAAS,GAAG,aAAa,QAAS,YAAW,OAAO,WAAW;MAC/D,QAAQ,GAAG,WAAW;MACtB,UAAU,GAAG,aAAa,SAAU,YAAW,MAAM,WAAW;MAChE,UAAU,GAAG,WAAW;MACxB,SAAS,GAAG,WAAW;MACvB,cAAA,eAA2B,mBAA3B;MACA,aAAa,UAAU,YAAY;MACnC,UAAU;;;AAUP,uCAAqC,QAAQ;AAClD,cAAU,QAAQ;MAChB,YAAY;MACZ,WAAW;MACX,QAAQ;MACR,SAAS;MACT,OAAO;MACP,UAAU;MACV,SAAS;MACT,UAAU;MACV,cAAc;MACd,aAAa;MACb,UAAU;MACV,UAAU;;;AAUP,yCAAuC,QAAQ;AACpD,gBAAY,QAAQ,CAClB,YACA,WACA,QACA,SACA,OACA,UACA,SACA,UACA,UACA;;;;ACjEG,2BAAyB,KAAK,MAAM,WAAW;AACpD,QAAI,sBAAsB,WAAM;AAC9B,UAAI,KAAK,SAAS;AAChB,aAAK,QAAQ;;AAEf,UAAI,KAAK,QAAQ;AACf,aAAK,OAAO;;;;AAeX,iBAAe,UAAU,QAAQ;AACtC,eAAW,UAAU;;;;AC1BvB,MAAM,4BAA4B;AAClC,MAAM,qCAAqC;AAS3C,MAAM,kBAAkB,0BAAU,KAAK,QAAQ,UAAU;AACvD,oBACE,KACA;MACE,SADF,iBACU,OAAO;AACb,cAAM,eAAe;UACnB,OAAO,IAAW;UAClB,QAAQ,IAAW;;AAErB,cAAM,OAAO,sBACX,OAAc;;MAGlB,QAVF,gBAUS,OAAO;AACZ,YAAA,sBAAwB,MAAM,cAAvB,SAAP,oBAAO,QAAQ,QAAf,oBAAe;AACf,YAAM,eAAe,eAAe,GAAG,GAAG,OAAO;AAEjD,oCACE,QACA,MAAM,MACN,MAAM,cACN;AAIF,2BAAmB,QAAQ;UAAC,kBAAkB;;AAE9C,cAAM,WAAM;AACV,0BAAgB,KAAK;YACnB,QADmB,mBACV;AACP,0BAAY,QAAQ,CAAC;AACrB,0CAA4B;AAC5B,uBAAS,MAAM,MAAM;;;WAGxB,4BAA4B;;OAGnC;;AAYJ,MAAM,oBAAoB,4BAAU,KAAK,QAAQ,UAAU,WAAW;AACpE,oBAAgB,KAAK;MACnB,QADmB,kBACV;AACP,sCAA8B;AAE9B;AAGA,wBAAgB,KAAK;UACnB,SADmB,mBACT;AACR,sBACE,sBAAsB,OAAc;;;;;;AAczC,MAAI,cAAc;AAwBlB,MAAI,gBAAgB;;;;;;;;;;;;;;;;;;;;;;;;;ACtH3B,MAAM,mCAAmC;AAKzC,MAAa,sBAAb,2BAAA;AAIE,kCAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,OAAO;AAGZ,WAAK,cAAc;AAGnB,WAAK,8BAA8B;AAInC,WAAK,iBAAiB;AAEtB,WAAK;;AAlBT,mBAAA,sBAAA,CAAA;MAAA,KAAA;MAAA,OAsBE,oCAA2B;AAAA,YAAA,QAAA;AACzB,aAAK,KAAK,iBAAiB,UAAU,WAAA;AAAA,iBAAM,MAAK;;;OAvBpD;MAAA,KAAA;MAAA,OA2BE,0BAAiB;AACf,YAAI,KAAK,aAAa;AACpB,eAAK,8BAA8B;;;OA7BzC;MAAA,KAAA;MAAA,OAuCE,sBAAY,QAAQ,UAAU;AAAA,YAAA,SAAA;AAC5B,oBAAY,KAAK,MAAM,QAAQ,SAAC,eAAe,cAAiB;AAC9D,iBAAK,cAAc;AACnB,iBAAK,8BAA8B;AACnC,iBAAK,iBAAiB;AACtB,mBAAS;;;OA5Cf;MAAA,KAAA;MAAA,OAsDE,wBAAc,QAAQ,UAAU;AAAA,YAAA,SAAA;AAO9B,sBACE,KAAK,MACL,QACA,WAAM;AACJ,iBAAK,cAAc;AAEnB,cAAI,CAAC,OAAK,6BAA6B;AACrC,qBAAS,OAAK;;WAGlB,SAAC,eAAkB;AACjB,iBAAK,iBAAiB;AAEtB,cAAI,OAAK,6BAA6B;AACpC,qBAAS,OAAK;;;;;AA3ExB,WAAA;;AAuFO,kCAAgC,KAAK;AAC1C,QAAI,oCACF,IAAI,qCAAqC,IAAI,oBAAoB;AACnE,WAAO,IAAI;;;;;;;;;;;;;;;;;;;;;;;;;;AChFb,MAAM,2BAA2B;AAGjC,MAAM,+BAA+B;AAErC,MAAa,mBAAb,2BAAA;AAIE,+BAAY,KAAK;AAAA,wBAAA,MAAA;AAEf,WAAK,OAAO;AAEZ,WAAK,sBAAsB;AAE3B,WAAK,oBAAoB,oBAAoB,KAAK;AAElD,WAAK,gBAAgB;;AAZzB,mBAAA,mBAAA,CAAA;MAAA,KAAA;MAAA,OAsBE,iBAAQ,SAAS,UAAU;AAAA,YAAA,QAAA;AACzB,YAAI,CAAC,KAAK,qBAAqB;AAC7B,eAAK,sBAAsB,IAAI;AAC/B,cAAM,WAAW,SACf,KAAK,MACL,WAAM;AACJ,kBAAK;AACL,kBAAK,oBAAoB;aAE3B;AAEF,eAAK;AACL,eAAK,KAAK,iBAAiB,UAAU,UAAU;AAC/C,eAAK,KAAK,iBAAiB,UAAU,UAAU;;AAGjD,iBAAS,KAAK,kBAAkB;AAChC,eAAO,KAAK,oBAAoB,IAAI,WAAM;AACxC,mBAAS,MAAK,kBAAkB;;;OAxCtC;MAAA,KAAA;MAAA,OA+CE,mBAAU;AACR,aAAK,gBAAgB,KAAK;;OAhD9B;MAAA,KAAA;MAAA,OAwDE,2BAAkB,SAAS;AACzB,eAAO;UACL,gBAA+C,KAAK;UAEpD,cAAc,KAAK,cAAc;;;OA5DvC;MAAA,KAAA;MAAA,OAoEE,2BAAkB;AAChB,YAA0B,mBAA+B,KAAlD,mBAA2C,MAAO,KAAb;AAE5C,YAAM,aACJ,iBAAwB,cAAc,IAAW;AACnD,YAAM,YACJ,iBAAwB,aAAa,IAAW;AAClD,eAAO,eACL,KAAK,MAAM,aACX,KAAK,MAAM,YACX,IAAW,YACX,IAAW;;OA/EjB;MAAA,KAAA;MAAA,OA4FE,uBAAc,SAAS;AACrB,YAAI,aAAa,sBACf,QAAe;AAEjB,YAAM,YAAY,QAAQ,cAAc;AACxC,iBACM,IAAI,GAAG,UAAU,WACrB,IAAI,MAEJ,WACA,WAAW,KAAK,QAChB,WAAW,KAAK,KAAK,KACrB,KAAK,UAAU,QAAQ,QACvB;AACA,cAAM,kBAAkB,sBACtB,QAAQ,aAAoB;AAE9B,uBAAa,eACX,YACA,gBAAgB,MAChB,gBAAgB;;AAGpB,eAAO;;;AAnHX,WAAA;;AA2HA,+BAA6B,KAAK;AAChC,QAAM,MAAM,IAAI;AAChB,QAAI,IAAW,kBAAkB;AAC/B,aAAO,IAAW;;AAEpB,QACE,IAAI,QAMJ,SAAS,IAAI,UAAU,YACvB;AACA,aAAO,IAAI;;AAEb,WAAO,IAAI;;AAQb,oBAAkB,IAAI;AACpB,WAAO,UAAU,KAAK,OAAO,CAAC,QAAQ,KAAK;;AAQtC,+BAA6B,KAAK;AACvC,QAAI,gCACF,IAAI,iCAAiC,IAAI,iBAAiB;AAC5D,WAAO,IAAI;;;;;;;;;;;;;;;;;;;;;;;;;;AChKb,MAAM,QAAM;AAGZ,MAAM,qBAAqB;AAQpB,iCAA+B,KAAK,aAAa;AACtD,WAAO,SAAS,SAAS,KAAK,WAC5B;MACE,SAAS,iBAAC,OAAU;AAClB,cAAM,QAAQ,IAAW;AACzB,cAAM,SAAS,IAAW;;MAE5B,QAAQ,gBAAC,OAAU;AAEjB,2BAAmB,aAAa;UAC9B,cAAc;UACd,QAAQ;UACR,OAAO;UACP,SAAS;UACT,UAAU;UACV,YAAY;UACZ,UAAU,GAAG,MAAM;UACnB,SAAS,GAAG,MAAM;UAClB,cAAc,GAAG,CAAC,MAAM,SAAS;UACjC,eAAe,GAAG,CAAC,MAAM,QAAQ;;;OAIvC;;AAUG,+BAA6B,KAAK,aAAa;AACpD,WAAO,SAAS,SAAS,KAAK,cAAc,WAAM;AAGhD,kBAAY,aAAa,CACvB,YACA,QACA,OACA,SACA,UACA,SACA,UACA,eACA;;;MAWA,qBAAA,2BAAA;AAKJ,iCAAY,QAAQ,SAAS;AAAA,wBAAA,MAAA;AAC3B,UAAO,MAAO,OAAP;AAGP,WAAK,SAAS;AAGd,WAAK,WAAW;AAMhB,WAAK,QAAQ;AAGb,WAAK,oBAAoB,IAAI;AAG7B,WAAK,oBAAoB,IAAI;AAG7B,WAAK,oBAAoB,IAAI;AAE7B,WAAK,SAAS,SAAS,KAAK,QAAQ,KAAK;AACzC,WAAK,SAAS,SAAS,KAAK,QAAQ,KAAK;AAGzC,WAAK,WAAW;AAChB,WAAK,OAAO,oBAAoB,KAAK,kBAAkB,KAAK;AAC5D,WAAK;AAML,WAAK,gBAAgB,KAAK,QAAQ,KAAK;AACvC,UAAI,iBAAiB,YAAY,KAAK;AAGtC,UAAM,aAAa,IAAI,SAAS;AAChC,iBAAW,UAAU,IAAI;AACzB,iBAAW,UAAU,IAAI;AACzB,UAAI,UAAU,MAAM;AAClB,mBAAW,UAAU,IAAI;;;;;aAK7B,mBAAU;AACR,aAAK,SAAS;AACd,aAAK,OAAO,IAAI,oBAAoB,YAAY,KAAK;;;;aAIvD,kCAAyB;;;;aAGzB,yBAAgB;AACd,eAAO;;;;aAIT,wBAAe;AACb,eAAO,KAAK,SAAS;;;;aAIvB,yBAAgB;AACd,eAAO,KAAK,SAAS;;;;aAIvB,sBAAa,iBAAiB;;;;aAG9B,6BAAoB,qBAAqB;;;;aAGzC,mBAAU;AACR,eAAO,KAAK,SAAS;;;;aAIvB,qBAAY;AACV,eAAO,KAAK,UAAU;;;;aAIxB,oBAAW;AACT,eAAO,KAAK,UAAU;;;;aAIxB,0BAAiB;AACf,eAAO,KAAK,SAAS;;;;aAIvB,2BAAkB;AAChB,eAAO,KAAK,SAAS;;;;aAIvB,4BAAmB;AACjB,eAAO,KAAK,SAAS;;;;aAIvB,gCAAuB;;;;aAGvB,mBAAU;AACR,YAAI,KAAK,SAAS,MAAM;AACtB,cAAM,OAAO,KAAK;AAClB,eAAK,QAAQ,eACX,KAAK,iBACL,KAAK,gBACL,KAAK,OACL,KAAK;;AAGT,eAAO,KAAK;;;;aAId,uBAAc,IAAI;AAChB,eAAO,KAAK,SAAS,cAAc;;;;aAQrC,4BAAmB,IAAI;AACrB,YAAM,QAAQ,GAAU;AACxB,eAAO,KAAK,SAAS,yBAAyB,KAAK,SAAC,MAAS;AAC3D,cAAI,CAAC,MAAM;AACT,mBAAO,sBAAsB;;AAE/B,iBAAO,eAAe,OAAO,KAAK,MAAM,KAAK;;;;;aAKjD,iCAAwB;AACtB,eAAO;;;;aAIT,yBAAgB,eAAe;AAC7B,eAAO;;;;aAIT,wBAAe,eAAe;AAC5B,eAAO;;;;aAIT,+BAAsB,eAAe,WAAW,cAAc,WAAW;AACvE,eAAO;;;;aAIT,mCACE,eACA,cACA,WACA,cACA,WACA;AACA,eAAO;;;;aAIT,gCAAsB;AACpB,eAAO,KAAK,SAAS;;;;aAIvB,mBAAU,SAAS;AACjB,eAAO,KAAK,kBAAkB,IAAI;;;;aAIpC,kBAAS,SAAS;AAChB,eAAO,KAAK,kBAAkB,IAAI;;;;aAIpC,kBAAS,SAAS;AAChB,eAAO,KAAK,kBAAkB,IAAI;;;;aAIpC,2BAAkB,uBAAuB,gBAAgB;AACvD,aAAK;AACL,eAAO,KAAK,SAAS,mBAAmB;;;;aAI1C,2BAAkB,uBAAuB;AACvC,aAAK;AACL,eAAO,KAAK,SAAS,mBAAmB;;;;aAI1C,4BAAmB;AACjB,aAAK;AACL,aAAK;;;;aAIP,4BAAmB;AACjB,aAAK;AACL,aAAK;;;;aAIP,yBAAgB;;;;aAGhB,uBAAc;;;;aAGd,0BAAiB;;;;aAGjB,4BAAmB;AACjB,eAAO;;;;aAIT,oCAA2B;AACzB,eAAO;;;;aAIT,4BAAmB;AACjB,eAAO;;;;aAIT,yBAAgB,eAAe,mBAAmB;AAChD,eAAO;;;;aAIT,8BAAqB,eAAe;;;;aAGpC,0BAAiB,mBAAmB;;;;aAKpC,oBAAW;AACT,YAAM,OAAO,KAAK;AAClB,YAAM,YAAY,KAAK;AACvB,YAAM,aAAa,KAAK;AACxB,aAAK,kBAAkB,KAAK;UAC1B,aAAa;UACb,KAAK;UACL,MAAM;UACN,OAAO,KAAK;UACZ,QAAQ,KAAK;UACb,UAAU;;;;;aAKd,mBAAU;AACR,aAAK,QAAQ;AACb,YAAI,KAAK,SAAS,iBAAiB,GAAG;AAIpC;;AAEF,aAAK;AACL,aAAK,kBAAkB;;;;aAIzB,mBAAU;AACR,aAAK,QAAQ;AACb,YAAM,UAAU,KAAK;AACrB,aAAK;AACL,aAAK,kBAAkB,KAAK;UAC1B,aAAa;UACb,OAAO,QAAQ;UACf,QAAQ,QAAQ;;;;;aAKpB,6BAAoB;AAClB,YAAM,UAAU,KAAK,OAAO;AAC5B,YAAI,WAAW,KAAK,UAAU;AAC5B,eAAK,WAAW;AAChB,cAAI,SAAS;AACX,iBAAK,SAAS;AAGd,iBAAK;iBACA;AACL,iBAAK,SAAS;;;;;;;AAatB,MAAa,wBAAb,2BAAA;AAIE,oCAAY,KAAK;AAAA,UAAA,QAAA;AAAA,wBAAA,MAAA;AAEf,WAAK,MAAM;AAGX,WAAK,oBAAoB,IAAI;AAG7B,WAAK,oBAAoB,IAAI;AAE7B,UAAM,WAAW,IAAW;AAC5B,UAAM,YAAY,IAAW;AAU7B,WAAK,gBAAgB,eAAe,GAAG,GAAG,UAAU;AAUpD,WAAK,WAAW,eAAe,GAAG,YAAY,GAAG,UAAU;AAG3D,WAAK,gBAAgB,yBAAyB;AAG9C,WAAK,0BAA0B;AAG/B,WAAK,sBAAsB,SACzB,KAAK,KACL,WAAM;AACJ,cAAK,kBAAkB;SAEzB;AAIF,WAAK,qBAAqB,iBAAiB,KAAK,IAAI;AAGpD,WAAK,6BAA6B,KAAK,qBACnC,oBAAoB,KAAK,IAAI,OAC7B;AAGJ,WAAK,gCAAgC,KAAK,qBACtC,uBAAuB,KAAK,IAAI,OAChC;AAGJ,WAAK,qBAAqB;AAE1B,YAAM,KAAK,OAAK;;AApEpB,mBAAA,wBAAA,CAAA;MAAA,KAAA;MAAA,OAwEE,mBAAU;AACR,YAAI,KAAK,oBAAoB;AAC3B,iBAAO,KAAK;eACP;AACL,iBAAO,KAAK;;;OA5ElB;MAAA,KAAA;MAAA,OAiFE,8BAAqB;AAAA,YAAA,SAAA;AACnB,aAAK,cAAc,YACjB,YAAY,gBACZ,YAAY,UACZ,SAAC,MAAS;AACR,gBAAM,KAAK,OAAK,sBAAsB;AACtC,iBAAK,mBAAmB,KAAK,iBAAiB,KAAK;;AAGvD,eAAO;;OA1FX;MAAA,KAAA;MAAA,OA8FE,wCAA+B;AAAA,YAAA,SAAA;AAK7B,eAAO,SAAS,uBACd,KAAK,IAAI,SAAS,iBAClB,KAAK,WAAM;AACX,iBAAK,qBACH,OAAK,sBACL,OAAK,2BAA2B,QAK7B,OAAK,IAAI,gBAAgB,OAAK,uBAC/B,SAAC,MAAS;AACR,mBAAK,mBAAmB,KAAK,iBAAiB,KAAK;;;;OA/G/D;MAAA,KAAA;MAAA,OA0HE,4BAAmB,cAAc,YAAY;AAC3C,YAAM,kBAAkB,KAAK;AAC7B,aAAK,gBAAgB;AACrB,aAAK,eAAe;AACpB,YAAI,UAAU,KAAK,eAAe,kBAAkB;AAClD,eAAK,kBAAkB;;AAEzB,YAAI,QAAQ,KAAK,eAAe,kBAAkB;AAChD,eAAK;;;OAlIX;MAAA,KAAA;MAAA,OAuIE,uBAAc,IAAI;AAChB,YAAM,IAAI,GAAU;AACpB,YAAO,OAAa,EAAb,MAAM,MAAO,EAAP;AACb,eAAO,eACL,KAAK,MAAM,OAAO,KAAK,SAAS,OAChC,KAAK,MAAM,MAAM,KAAK,SAAS,MAC/B,KAAK,MAAM,EAAE,QACb,KAAK,MAAM,EAAE;;OA9InB;MAAA,KAAA;MAAA,OAmJE,kBAAS,UAAU;AACjB,aAAK,kBAAkB,IAAI;;OApJ/B;MAAA,KAAA;MAAA,OAwJE,kBAAS,UAAU;AACjB,aAAK,kBAAkB,IAAI;;OAzJ/B;MAAA,KAAA;MAAA,OA6JE,mBAAU;AACR,eAAO;UACL,OAAO,KAAK,cAAc;UAC1B,QAAQ,KAAK,cAAc;;;OAhKjC;MAAA,KAAA;MAAA,OAqKE,wBAAe;AACb,eAAO,KAAK,cAAc;;OAtK9B;MAAA,KAAA;MAAA,OA0KE,yBAAgB;AACd,eAAO,KAAK,cAAc;;OA3K9B;MAAA,KAAA;MAAA,OA+KE,gCAAsB;AACpB,eAAO,KAAK;;OAhLhB;MAAA,KAAA;MAAA,OAoLE,kDAAyC;AACvC,eAAO;;OArLX;MAAA,KAAA;MAAA,OAyLE,iCAAwB;AACtB,eAAO;;OA1LX;MAAA,KAAA;MAAA,OAiME,wBAAe,cAAc;AAC3B,YAAI,CAAC,cAAc;AACjB;;AAGF,YAAM,UAAU,eACd,cACA,KAAK,cAAc,MACnB,KAAK,cAAc;AAGrB,YAAI,UAAU,SAAS,KAAK,WAAW;AACrC,gBAAM,KAAK,OAAK,gCAAgC;AAEhD,eAAK,WAAW;AAIhB,eAAK;;;OAnNX;MAAA,KAAA;MAAA,OA4NE,6BAAoB;AAClB,eAAO,SAAS,gBAAgB,KAAK,IAAI,SAAS,iBAAiB;;OA7NvE;MAAA,KAAA;MAAA,OAiOE,iCAAwB;AACtB,aAAK,oBAAoB,QAAQ,SAAC,UAAD;AAAA,iBAAc,SAAS;;;OAlO5D;MAAA,KAAA;MAAA,OAsOE,4BAAmB,cAAc;AAC/B,YAAI,cAAc;AAChB,iBAAO,KAAK;;AAEd,eAAO,KAAK;;OA1OhB;MAAA,KAAA;MAAA,OA8OE,kCAAyB;AAAA,YAAA,SAAA;AACvB,YAAI,KAAK,oBAAoB;AAE3B,iBAAO,KAAK,+BAA+B,KAAK,WAAA;AAAA,mBAC9C,OAAK,2BAA2B,cAE7B,OAAK,IAAI,gBAAgB,OAAK;;;AAIrC,YAAI,CAAC,KAAK,yBAAyB;AACjC,eAAK,0BAA0B,IAAI,QAAQ,SAAC,SAAY;AACtD,mBAAK,cAAc,YACjB,YAAY,gBACZ,YAAY,UACZ,SAAC,MAAS;AACR,qBAAK,0BAA0B;AAC/B,yBAAU,KAAK,eAAe;AAC9B,sBAAQ,KAAK;;;;AAKrB,eAAO,KAAK;;OArQhB;MAAA,KAAA;MAAA,OA4QE,kCAAyB;AAAA,YAAA,SAAA;AACvB,eAAO,KAAK,yBAAyB,KAAK,WAAA;AAAA,iBACxC,OAAK;;;OA9QX;MAAA,KAAA;MAAA,OAsRE,6BAAoB;AAAA,YAAA,SAAA;AAClB,eAAO,KAAK,iCAAiC,KAAK,WAAA;AAAA,iBAChD,OAAK;;;OAxRX;MAAA,KAAA;MAAA,OAiSE,kCAAyB;AACvB,eAAO,sBAAsB,KAAK,KAAK,KAAK;;OAlShD;MAAA,KAAA;MAAA,OA0SE,gCAAuB;AACrB,eAAO,oBAAoB,KAAK,KAAK,KAAK;;OA3S9C;MAAA,KAAA;MAAA,OAkTE,oCAA2B;AAAA,YAAA,SAAA;AACzB,eAAO,IAAI,QAAQ,SAAC,SAAS,QAAW;AACtC,cAAI,OAAK,oBAAoB;AAC3B,gBAAM,SAA2C,OAAK,IAAI;AAC1D,gBAAI,QAAQ;AACV,qBAAK,8BAA8B,YAAY,QAAQ,SAAC,SAAY;AAClE,uBAAK,eAAe;AACpB;;mBAEG;AACL,qBAAO;;iBAEJ;AACL,mBAAK,cAAc,YACjB,YAAY,oBACZ,YAAY,6BACZ,SAAC,UAAa;AACZ,kBAAI,SAAS,YAAY;AACvB,uBAAK,eAAe,SAAS;AAC7B;qBACK;AACL,uBAAO;;;;;;OAvUrB;MAAA,KAAA;MAAA,OAmVE,0CAAiC;AAAA,YAAA,SAAA;AAC/B,eAAO,IAAI,QAAQ,SAAC,SAAS,QAAW;AACtC,cAAI,OAAK,oBAAoB;AAC3B,gBAAM,SAA2C,OAAK,IAAI;AAC1D,gBAAI,QAAQ;AACV,qBAAK,8BAA8B,cACjC,QACA,SAAC,SAAY;AACX,uBAAK,eAAe;AACpB;;mBAGC;AACL,qBAAO;;iBAEJ;AACL,mBAAK,cAAc,YACjB,YAAY,2BACZ,YAAY,oCACZ,SAAC,UAAa;AACZ,qBAAK,eAAe,SAAS;AAC7B;;;;;OAxWZ;MAAA,KAAA;MAAA,OAgXE,0BAAiB;AACf,eAAO,iBAAiB,KAAK,IAAI,SAAS;;OAjX9C;MAAA,KAAA;MAAA,OAqXE,sBAAa;AACX,YAAI,KAAK,oBAAoB;AAC3B,eAAK;AACL,eAAK,qBAAqB;;;OAxXhC;MAAA,KAAA;MAAA,OA6XE,0BAAiB;AAEf,eAAO,KAAK,sBAA6B;;OA/X7C;MAAA,KAAA;MAAA,OAmYE,2BAAkB;AAEhB,eAAO,KAAK,sBAA6B;;OArY7C;MAAA,KAAA;MAAA,OAyYE,4BAAmB;AACjB,eAAO,KAAK;;OA1YhB;MAAA,KAAA;MAAA,OA6YmB,4BAAmB;;OA7YtC;MAAA,KAAA;MAAA,OAgZmB,4BAAmB;;OAhZtC;MAAA,KAAA;MAAA,OAmZmB,4BAAmB;;OAnZtC;MAAA,KAAA;MAAA,OAsZmB,yBAAgB;;OAtZnC;MAAA,KAAA;MAAA,OAyZmB,uBAAc;;OAzZjC;MAAA,KAAA;MAAA,OA4ZmB,kCAAyB;;OA5Z5C;MAAA,KAAA;MAAA,OA+ZmB,wBAAe;;OA/ZlC;MAAA,KAAA;MAAA,OAkamB,gCAAuB;;OAla1C;MAAA,KAAA;MAAA,OAmamB,wBAAe;AAC9B,eAAO;;OApaX;MAAA,KAAA;MAAA,OAsamB,sCAA6B;AAC5C,eAAO;;OAvaX;MAAA,KAAA;MAAA,OAyamB,kCAAyB;AACxC,eAAO;;;AA1aX,WAAA;;AAibO,wCAAsC,QAAQ;AACnD,QAAM,UAAU,IAAI,sBAAsB,OAAO;AACjD,iCACE,QACA,YACA,WAAY;AACV,aAAO,IAAI,mBAAmB,QAAQ;OAElB;;AAS1B,qBAAmB,SAAS,SAAS;AACnC,WAAO,QAAQ,SAAS,YAAY,UAAU,SAAS;;AAQzD,mBAAiB,SAAS,SAAS;AACjC,WAAO,QAAQ,QAAQ,QAAQ,QAAQ,QAAQ,OAAO,QAAQ;;AAQhE,qBAAmB,SAAS,SAAS;AACnC,WAAO,QAAQ,SAAS,QAAQ,SAAS,QAAQ,UAAU,QAAQ;;;;AC91B9D,0CAAwC,QAAQ;AAErD,iCAA6B,OAAO;AACpC,qBAAiB;AACjB,kCAA8B;AAC9B,qCAAiC;AACjC,4BAAwB;AACxB,qCAAiC;AACjC,iCAA6B;AAC7B,gCAA4B;AAC5B,gCAA4B;AAC5B,wCAAoC;AACpC,+BAA2B;AAC3B,sCAAkC;AAClC,wCAAoC;AACpC,+BAA2B;AAC3B,iCAA6B;AAE7B,uBAAmB,QAAQ;AAC3B,yCAAqC;AACrC,sCAAkC;;AAOpC,8BAA4B,QAAQ,MAAM;AACxC,+BACE,QACA,MACA,IAAI,MAAM,2BAA2B;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/BzC,MAAM,cAAc;AAGpB,MAAM,kBAAkB;AAexB,MAAM,gBAAgB;IAEpB,kBAAkB;IAElB,eAAe;IAEf,cAAc;;AAahB,MAAa,gBAAb,2BAAA;AAME,4BAAY,KAAK,aAAa,gBAAgB;AAAA,wBAAA,MAAA;AAE5C,WAAK,MAAM;AAGX,WAAK,aAAa;AAClB,UAAI,aAAa;AACf,aAAK,aAAa,IAAI,aAAa,KAAK;UACtC,QAAQ,uBAAuB,KAAK;;AAEtC,YAAI,SAAS,eAAe,KAAK;;;AAhBvC,mBAAA,gBAAA,CAAA;MAAA,KAAA;MAAA,OAyBE,uBAAc;AAEZ,eAAO,CAAC,CAAC,KAAK;;OA3BlB;MAAA,KAAA;MAAA,OAmCE,wBAAe;AAGb,eAAO,UAAU,KAAK;;OAtC1B;MAAA,KAAA;MAAA,OA8CE,0CAAiC,MAAM;AAIrC,YAAI,CAAC,KAAK,gBAAgB,OAAO,KAAK,cAAc,YAAY;AAC9D,iBAAO;;AAGT,eAAO,KAAK;;OAtDhB;MAAA,KAAA;MAAA,OAgEE,8BAAqB,MAAM;AACzB,YAAI,IAAI;AACR,eAAO,GAAG;AAMR,cAAM,eAAe,KAAK,iCAAiC;AAC3D,cAAI,cAAc;AAChB,mBAAO;;AAIT,cAAM,WAAW,YAAY;AAC7B,cAAI,CAAC,UAAU;AACb;;AAEF,cAAM,SAAS,SAAS;AACxB,cAAI,QAAQ;AACV,mBAAO;;AAKT,cAAI,SAAS,MAAM;AACjB,gBAAI,SAAS;iBACR;AAEL,gBAAI,4BAA4B,UAAU,KAAK;;;AAInD,eAAO;;OAjGX;MAAA,KAAA;MAAA,OA+GE,mBAAU,MAAM;AACd,YAAM,SAAS,KAAK,qBAAqB;AACzC,YAAI,CAAC,QAAQ;AACX,gBAAM,MAAM,YAAY,uBAAuB;;AAEjD,eAAO;;OApHX;MAAA,KAAA;MAAA,OA+HE,0BAAiB,KAAK,YAAY,aAAa;AAC7C,kBACE,CAAC,WAAW,cACZ;AAEF,YAAM,SAAS,IAAI,aAAa,KAAK,KAAK,KAAK,YAAY;AAC3D,mBAAW,eAAe;AAC1B,eAAO;;OAtIX;MAAA,KAAA;MAAA,OAiJE,uBAAc,KAAK,UAAU,aAAa;AACxC,YAAM,MAAM,SAAS;AACrB,kBAAU,CAAC,IAAI,cAAc;AAC7B,YAAM,eAAe,UAAU,SAAS;AACxC,YAAM,SAAS,IAAI,UACjB,UACA,KACA,KAAK,UAAU,eACf;AAEF,YAAI,eAAe;AACnB,eAAO;;;AA5JX,WAAA;;AAuKA,MAAa,SAAb,2BAAA;AAME,qBAAY,KAAK,QAAQ,aAAa;AAAA,UAAA,QAAA;AAAA,wBAAA,MAAA;AAEpC,WAAK,MAAM;AAGX,WAAK,uBAAuB;AAG5B,WAAK,UAAU;AAGf,WAAK,WAAY,eAAe,YAAY,WAAY,IAAI;AAG5D,WAAK,UAAW,eAAe,YAAY,UAAW;AAGtD,WAAK,QAAQ;AAGb,WAAK,sBAAsB;AAE3B,UAAM,wBAAwB,KAAK,QAAQ;AAC3C,gBACE,CAAC,yBACC,YAAY,iBAAiB;AAIjC,WAAK,2BACF,eAAe,YAAY,mBAC5B,yBACA;AAMF,WAAK,mBAAmB;AAGxB,WAAK,2BAA2B,IAAI;AAGpC,WAAK,mBAAmB;AAGxB,WAAK,eAAe;AAEpB,UAAM,6BAA6B,KAAK,uBAAuB,KAAK;AACpE,UAAI,KAAK,SAAS;AAChB,aAAK,aAAa,KAChB,KAAK,QAAQ,oBAAoB;;AAGrC,0CACE,KAAK,IAAI,UACT;AAEF,WAAK,aAAa,KAAK,WAAA;AAAA,eACrB,uCACE,MAAK,IAAI,UACT;;AAGJ,WAAK;;AAvET,mBAAA,SAAA,CAAA;MAAA,KAAA;MAAA,OA6EE,mBAAU;AACR,8BAAsB;AACtB,aAAK,aAAa,QAAQ,SAAC,YAAD;AAAA,iBAAgB;;;OA/E9C;MAAA,KAAA;MAAA,OAuFE,uBAAc;AAEZ,eAAyB,UAAU,MAAM;;OAzF7C;MAAA,KAAA;MAAA,OA+FE,qBAAY;AACV,eAAO,KAAK;;OAhGhB;MAAA,KAAA;MAAA,OAwGE,mBAAS;AACP,eAAO,KAAK;;OAzGhB;MAAA,KAAA;MAAA,OA6GE,mBAAU;AACR,eAAO,KAAK;;OA9GhB;MAAA,KAAA;MAAA,OAuHE,kBAAS,MAAM;AACb,YAAM,IAAI,KAAK,QAAQ;AACvB,eAAO,KAAK,OAAO,OAAO;;OAzH9B;MAAA,KAAA;MAAA,OAiIE,mBAAU;AAAA,YAAA,SAAA;AACR,YAAI,KAAK,OAAO;AACd,iBAAO,IAAI,KAAK;;AAGlB,aAAK,QAAQ;AACb,YAAM,UAAU,MACb,cAAc,KAAK,IAAI,SAAS,MAChC,iBAAiB;AACpB,sBAAc,SAAS,SAAC,QAAW;AACjC,cAAM,OAAO,OAAO,aAAa;AACjC,cAAM,UAAU,OAAO,aAAa;AACpC,cAAI,CAAC,QAAQ,YAAY,MAAM;AAC7B;;AAIF,cAAI,OAAK,MAAM,UAAU,QAAW;AAClC,mBAAK,MAAM,QAAQ;;;AAGvB,eAAO,IAAI,KAAK;;OAtJpB;MAAA,KAAA;MAAA,OA+JE,uBAAc,MAAM;AAClB,YAAI,CAAC,MAAM;AACT,iBAAO;;AAGT,YAAM,UAAU,KAAK,UAAU;AAC/B,eAAO,YAAY,SAAY,UAAU;;OArK7C;MAAA,KAAA;MAAA,OAkLE,uBAAc,YAAY,eAAe;AACvC,kBAAU,MAAM;;OAnLpB;MAAA,KAAA;MAAA,OA4LE,2BAAkB,aAAa,aAAa;AAC1C,YAAM,WAAW,KAAK,oBAAoB;AAC1C,YAAI,CAAC,UAAU;AACb,iBAAO;;AAET,eAAO,CAAC,eAAe,aAAa;;OAjMxC;MAAA,KAAA;MAAA,OA0ME,0BAAiB,aAAa,SAAS;AACrC,kBACE,CAAC,KAAK,oBAAoB,gBACxB,KAAK,oBAAoB,iBAAiB,SAC5C,iCACA;AAEF,aAAK,oBAAoB,eAAe;;OAjN5C;MAAA,KAAA;MAAA,OAwNE,6BAAoB,aAAa;AAC/B,eAAO,KAAK,oBAAoB,gBAAgB;;OAzNpD;MAAA,KAAA;MAAA,OAgOE,8BAAqB;AACnB,aAAK,SAAS,OAAO,cAAc;;OAjOvC;MAAA,KAAA;MAAA,OAwOE,+BAAsB;AACpB,eAAO,KAAK,SAAS,WAAW,cAAc;;OAzOlD;MAAA,KAAA;MAAA,OAmPE,uBAAc;AACZ,eAAyB,UAAU,MAAM;;OApP7C;MAAA,KAAA;MAAA,OA4PE,uBAAc;;OA5PhB;MAAA,KAAA;MAAA,OAmQE,2BAAkB;AAChB,eAAyB,UAAU,OAAO;;OApQ9C;MAAA,KAAA;MAAA,OA8QE,mBAAU;AACR,eAAyB,UAAU,MAAM;;OA/Q7C;MAAA,KAAA;MAAA,OAuRE,4BAAkB;AAChB,eAAyB,UAAU,MAAM;;OAxR7C;MAAA,KAAA;MAAA,OAkSE,mBAAU;AACR,eAAyB,UAAU,MAAM;;OAnS7C;MAAA,KAAA;MAAA,OA2SE,qBAAY;AACV,eAAyB,UAAU,MAAM;;OA5S7C;MAAA,KAAA;MAAA,OAmTE,kBAAS;AACP,eAAyB,UAAU,MAAM;;OApT7C;MAAA,KAAA;MAAA,OA+TE,wBAAe,IAAI;AACjB,eAAO,KAAK,cAAc,eAAe;;OAhU7C;MAAA,KAAA;MAAA,OAwUE,kBAAS,MAAM;AACb,eAAO,KAAK,cAAc,SAAS;;OAzUvC;MAAA,KAAA;MAAA,OAgVE,iCAAwB,iBAAiB;AACvC,YAAI,KAAK,4BAA4B,iBAAiB;AACpD,eAAK,2BAA2B;AAChC,eAAK;;;OAnVX;MAAA,KAAA;MAAA,OAwVE,kCAAyB;AAEvB,YAAM,yBAAyB,2BAC7B,KAAK,IAAI;AAIX,YAAI,wBAAwB,gBAAgB;AAC5C,iBAAS,IAAI,KAAK,SAAS,GAAG,IAAI,EAAE,aAAa;AAC/C,cAAI,EAAE,wBAAwB,gBAAgB,SAAS;AACrD,oCAAwB,EAAE;AAC1B;;;AAKJ,YAAI;AACJ,YAAM,0BACJ,KAAK,4BAA4B,gBAAgB;AACnD,YACE,2BAA2B,gBAAgB,WAC3C,yBAAyB,gBAAgB,WACzC,0BAA0B,gBAAgB,SAC1C;AACA,4BAAkB,gBAAgB;mBAElC,0BAA0B,gBAAgB,UAC1C,2BAA2B,gBAAgB,QAC3C;AAEA,4BAAkB;mBAElB,2BAA2B,gBAAgB,UAC3C,2BAA2B,gBAAgB,UAC3C;AACA,4BAAkB;mBAElB,yBAAyB,gBAAgB,UACzC,yBAAyB,gBAAgB,UACzC;AACA,4BAAkB;mBAElB,2BAA2B,gBAAgB,aAC3C,0BAA0B,gBAAgB,aAC1C,yBAAyB,gBAAgB,WACzC;AACA,4BAAkB,gBAAgB;eAC7B;AACL,4BAAkB,gBAAgB;;AAGpC,YAAI,KAAK,oBAAoB,iBAAiB;AAC5C,eAAK,mBAAmB;AACxB,cAAI,mBAAmB,gBAAgB,SAAS;AAC9C,iBAAK,mBAAmB,KAAK;AAC7B,iBAAK,SAAS,OAAO,cAAc;AACnC,iBAAK,SAAS,OAAO,cAAc;iBAC9B;AACL,iBAAK,SAAS,MAAM,cAAc;;AAEpC,eAAK,yBAAyB;;;OApZpC;MAAA,KAAA;MAAA,OA6ZE,4BAAmB;AACjB,eAAO,KAAK,SACT,WAAW,cAAc,eACzB,KAAK,WAAA;AAAA,iBAAM;;;OAhalB;MAAA,KAAA;MAAA,OAwaE,2BAAkB;AAChB,eAAO,KAAK,SACT,WAAW,cAAc,cACzB,KAAK,WAAA;AAAA,iBAAM;;;OA3alB;MAAA,KAAA;MAAA,OAmbE,+BAAsB;AACpB,eACE,KAAK,SAAS,IAAI,cAAc;;OArbtC;MAAA,KAAA;MAAA,OA8bE,8BAAqB;AACnB,eAAO,KAAK;;OA/bhB;MAAA,KAAA;MAAA,OAucE,8BAAqB;AACnB,eAAO,UAAU,KAAK;;OAxc1B;MAAA,KAAA;MAAA,OAkdE,qBAAY;AACV,eAAO,KAAK,oBAAoB,gBAAgB;;OAndpD;MAAA,KAAA;MAAA,OA4dE,0BAAiB;AACf,eAAO,KAAK,wBAAwB;;OA7dxC;MAAA,KAAA;MAAA,OAueE,6BAAoB,SAAS;AAC3B,eAAO,KAAK,yBAAyB,IAAI;;OAxe7C;MAAA,KAAA;MAAA,OAifE,2BAAkB,MAAM;AACtB,YAAI,CAAC,KAAK,qBAAqB,OAAO;AACpC,eAAK,qBAAqB,QAAQ;AAClC,iBAAO;;AAET,eAAO;;;AAtfX,WAAA;;AA+fA,MAAa,eAAb,yBAAA,SAAA;AAAA,gBAAA,eAAA;AAAA,QAAA,SAAA,eAAA;AAKE,2BAAY,KAAK,aAAa;AAAA,UAAA;AAAA,wBAAA,MAAA;AAC5B,eAAA,OAAA,KAAA,MAAM,KAAkB,MAAM;AAG9B,aAAK,eAAe,OAAK,IAAI,SAAS,OAClC,QAAQ,QAAQ,OAAK,IAAI,SAAS,QAClC,uBAAuB,OAAK,IAAI,UAAU,KAAK,WAAA;AAAA,eAAM,OAAK;;AAG9D,aAAK,gBAAgB,kBAAkB,OAAK,IAAI;AATpB,aAAA;;AALhC,mBAAA,eAAA,CAAA;MAAA,KAAA;MAAA,OAkBE,uBAAc;AACZ,eAAO;;OAnBX;MAAA,KAAA;MAAA,OAuBE,uBAAc;AACZ,eAAO,KAAK,IAAI;;OAxBpB;MAAA,KAAA;MAAA,OA4BE,kBAAS;AACP,eAAO,gBAAgB,YAAY,KAAK,KAAK;;OA7BjD;MAAA,KAAA;MAAA,OAiCE,uBAAc;AACZ,eAAO,MAAM,cAAc,KAAK,IAAI,SAAS;;OAlCjD;MAAA,KAAA;MAAA,OAsCE,2BAAkB;AAChB,eAAO,CAAC,CAAC,KAAK,IAAI,SAAS;;OAvC/B;MAAA,KAAA;MAAA,OA2CE,mBAAU;AACR,eAAO,MAAM,cAAc,KAAK,IAAI,SAAS,MAAM;;OA5CvD;MAAA,KAAA;MAAA,OAgDE,4BAAkB;AAChB,eAAO,KAAK;;OAjDhB;MAAA,KAAA;MAAA,OAqDE,mBAAU;AACR,eAAO,gBAAgB,KAAK,IAAI;;OAtDpC;MAAA,KAAA;MAAA,OA0DE,qBAAY;AACV,eAAO,KAAK;;;AA3DhB,WAAA;IAAkC;AAoElC,MAAa,eAAb,yBAAA,UAAA;AAAA,gBAAA,eAAA;AAAA,QAAA,UAAA,eAAA;AAOE,2BAAY,KAAK,KAAK,YAAY,aAAa;AAAA,UAAA;AAAA,wBAAA,MAAA;AAC7C,eAAA,QAAA,KAAA,MAAM,KAAkB,MAAM;AAE9B,aAAK,OAAO;AAEZ,aAAK,cAAc;AAGnB,aAAK,QAAQ;AAEb,UAAM,eAAe,IAAI;AAGzB,aAAK,eAAe,aAAa;AAGjC,aAAK,gBAAgB,aAAa;AAGlC,aAAK,SAAS;AAEd,UAAM,gBAAgB,IAAI;AAG1B,aAAK,gBAAgB,cAAc;AAGnC,aAAK,iBAAiB,cAAc;AA3BS,aAAA;;AAPjD,mBAAA,eAAA,CAAA;MAAA,KAAA;MAAA,OAsCE,uBAAc;AACZ,eAAO;;OAvCX;MAAA,KAAA;MAAA,OA2CE,uBAAc;AACZ,eAAO,KAAK;;OA5ChB;MAAA,KAAA;MAAA,OAgDE,kBAAS;AACP,eAAO,KAAK;;OAjDhB;MAAA,KAAA;MAAA,OAqDE,uBAAc;AACZ,eAAO,KAAK;;OAtDhB;MAAA,KAAA;MAAA,OA0DE,2BAAkB;AAChB,eAAO,CAAC,CAAC,KAAK;;OA3DlB;MAAA,KAAA;MAAA,OA+DE,mBAAU;AACR,eAAO,MAAM,cAAc,KAAK,OAAO;;OAhE3C;MAAA,KAAA;MAAA,OAwEE,iBAAQ,MAAM;AACZ,kBAAU,CAAC,KAAK,OAAO;AACvB,aAAK,QAAQ;AACb,aAAK,cAAc;AACnB,aAAK,gBAAgB;;OA5EzB;MAAA,KAAA;MAAA,OAgFE,4BAAkB;AAChB,eAAO,KAAK;;OAjFhB;MAAA,KAAA;MAAA,OAqFE,mBAAU;AACR,eAAO,KAAK;;OAtFhB;MAAA,KAAA;MAAA,OA6FE,oBAAW;AACT,kBAAU,CAAC,KAAK,QAAQ;AACxB,aAAK,SAAS;AACd,aAAK;AACL,aAAK,iBAAiB;;OAjG1B;MAAA,KAAA;MAAA,OAqGE,qBAAY;AACV,eAAO,KAAK;;OAtGhB;MAAA,KAAA;MAAA,OA0GE,mBAAU;AACR,eAA8C,IAAI,KAAK;;OA3G3D;MAAA,KAAA;MAAA,OA+GE,uBAAc,MAAM,SAAS;AAC3B,kBAAU,MAAM;AAChB,YAAI,CAAC,KAAK,OAAO;AACf,eAAK,QAAQ;;AAEf,aAAK,MAAM,QAAQ;;;AApHvB,WAAA;IAAkC;AA4HlC,MAAa,YAAb,yBAAA,UAAA;AAAA,gBAAA,YAAA;AAAA,QAAA,UAAA,eAAA;AAOE,wBAAY,KAAK,KAAK,QAAQ,aAAa;AAAA,UAAA;AAAA,wBAAA,MAAA;AACzC,eAAA,QAAA,KAAA,MAAM,KAAK,QAAQ;AAGnB,aAAK,OAAO;AAGZ,aAAK,eAAe,OAAK,IAAI,SAAS,OAClC,QAAQ,QAAQ,OAAK,IAAI,SAAS,QAClC,uBAAuB,OAAK,IAAI,UAAU,KAAK,WAAA;AAAA,eAAM,OAAK;;AAG9D,aAAK,SAAS;AAEd,UAAM,gBAAgB,IAAI;AAE1B,aAAK,gBAAgB,cAAc;AAEnC,aAAK,iBAAiB,cAAc;AAlBK,aAAA;;AAP7C,mBAAA,YAAA,CAAA;MAAA,KAAA;MAAA,OA6BE,uBAAc;AACZ,eAAO;;OA9BX;MAAA,KAAA;MAAA,OAkCE,uBAAc;AACZ,eAAO,KAAK,IAAI;;OAnCpB;MAAA,KAAA;MAAA,OAuCE,kBAAS;AACP,eAAO,KAAK;;OAxChB;MAAA,KAAA;MAAA,OA4CE,uBAAc;AACZ,eAAO,MAAM,cAAc,KAAK,IAAI,SAAS;;OA7CjD;MAAA,KAAA;MAAA,OAiDE,2BAAkB;AAChB,eAAO,CAAC,CAAC,KAAK,IAAI,SAAS;;OAlD/B;MAAA,KAAA;MAAA,OAsDE,mBAAU;AACR,eAAO,MAAM,cAAc,KAAK,IAAI,SAAS,MAAM;;OAvDvD;MAAA,KAAA;MAAA,OA2DE,4BAAkB;AAChB,eAAO,KAAK;;OA5DhB;MAAA,KAAA;MAAA,OAgEE,mBAAU;AACR,eAAO,KAAK;;OAjEhB;MAAA,KAAA;MAAA,OAqEE,qBAAY;AACV,eAAO,KAAK;;OAtEhB;MAAA,KAAA;MAAA,OA6EE,oBAAW;AACT,kBAAU,CAAC,KAAK,QAAQ;AACxB,aAAK,SAAS;AACd,aAAK;AACL,aAAK,iBAAiB;;;AAjF1B,WAAA;IAA+B;AA0F/B,kCAAgC,KAAK,YAAY;AAC/C,QAAM,SAAS;AACf,QAAI,YAAY;AAEd,aAAO,OAAO,QAAQ;WACjB;AAEL,UAAI,IAAI,QAAQ,IAAI,KAAK,QAAQ,oBAAoB,GAAG;AACtD,eAAO,OACL,QACA,iBAAiB,IAAI,KAAK,UAAU,gBAAgB;;AAGxD,UAAI,IAAI,YAAY,IAAI,SAAS,MAAM;AACrC,eAAO,OAAO,QAAQ,iBAAiB,IAAI,SAAS;;;AAGxD,WAAO;;AAWF,6BAA2B,KAAK,aAAa,gBAAgB;AAClE,2BAAuB,KAAK,UAAU,WAAY;AAChD,aAAO,IAAI,cAAc,KAAK,aAAa;;;;;ACngCxC,2BAAyB,QAAQ;AACtC,WAAO,OAAO,kBAAkB,KAAK,WAAM;AACzC,UAAM,OAAO,OAAO;AACpB,UAAM,eAAe,oBACnB,MACA,WAAA;AAAA,eAAM,CAAC,CAAC,KAAK;;AAGf,aAAO,SAAS,SAAS,OAAO,KAC7B,eAAe,KAAM,cACrB,KACC,WAAA;AAAA,eAAM,KAAK,kBAAkB,YAAY;SACzC,WAAA;AAAA,eAAM;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACfd,MAAM,cAAc;AAEpB,MAAM,QAAM;AAkBZ,MAAa,cAAb,2BAAA;AAIE,0BAAY,KAAK;AAAA,UAAA,QAAA;AAAA,wBAAA,MAAA;AAEf,WAAK,MAAM;AAGX,WAAK,UAAU;AAGf,WAAK,cACH,IAAI,YAAY,cAAc,IAAI,YAAY,OAAO;AAGvD,WAAK,UAAU;AAGf,WAAK,UAAU;AAGf,WAAK,aAAa;AAGlB,WAAK,gBAAgB;AAGrB,WAAK,oBAAoB;AAGzB,WAAK,2BAA2B;AAGhC,WAAK,sBAAsB;AAG3B,WAAK,UAAU;AAGf,WAAK,WAAW,IAAI;AAOpB,WAAK,qBAAqB;AAM1B,WAAK,gBAAgB;AAErB,UAAM,sBACH,KAAK,IAAI,uBACR,KAAK,IAAI,oBAAoB,uBAC/B;AAGF,UAAI,CAAC,oBAAoB,SAAS,UAAU;AAC1C,aAAK,SAAS,aACZ,UAAU,wBACV,MAAM,oBAAoB;;AAU9B,WAAK,uBAAuB,oBAAoB,SAAS;AAEzD,UAAI,CAAC,KAAK,sBAAsB;AAC9B,aAAK,SAAS,aACZ,UAAU,yBACV,MAAM,oBAAoB;;AAU9B,WAAK,uBAAuB,oBAAoB,SAAS;AAEzD,UAAI,CAAC,KAAK,sBAAsB;AAC9B,aAAK,SAAS,aACZ,UAAU,mBACV,MAAM,oBAAoB;;AAS9B,WAAK,kCAAkC,oBAAoB,SACzD;AAGF,UAAI,CAAC,KAAK,iCAAiC;AACzC,aAAK,SAAS,aACZ,UAAU,kCACV,MAAM,oBAAoB;;AAS9B,WAAK,sBAAsB,oBAAoB,SAAS;AAQxD,WAAK,kCAAkC;AAQvC,WAAK,oCAAoC;AAEzC,WAAK,4BAA4B,KAAK,0BAA0B,KAAK;AAGrE,WAAK,qBAAqB,SAAS,QAAQ,KAAK,KAAK;AAGrD,wBAAkB,IAAI,UAAU,KAAK,WAAM;AACzC,cAAK,KAAK,UAAU;AACpB,cAAK;;AAIP,2BAAqB,IAAI,UAAU,KAAK,WAAA;AAAA,eAAM,MAAK;;AACnD,WAAK;AACL,WAAK;;AAvJT,mBAAA,cAAA,CAAA;MAAA,KAAA;MAAA,OA8JE,iCAAwB;AAAA,YAAA,SAAA;AACtB,YAAO,kBAAmB,KAAK,IAAI,SAA5B;AACP,aAAK,UAAU,SAAS,OAAO;AAC/B,aAAK,UAAU,SAAS,aAAa;AACrC,aAAK,aAAa,SAAS,gBAAgB;AAC3C,aAAK,gBAAgB,SAAS,mBAAmB,KAAK;AAEtD,aAAK,2BACH,KAAK,QAAQ,gBAAgB,KAAK,QAAQ,SAAS,WAAW;AAGhE,aAAK,QAAQ,oBAAoB,KAAK,MAAM,KAAK;AAIjD,aAAK;AAIL,YAAM,iBAAiB,KAAK,QAAQ;AAEpC,aAAK,QAAQ,mBAAmB,KAAK,WAAM;AACzC,iBAAK,KAAK,UAAU;AACpB,iBAAK;;AAGP,YAAM,mCACJ,KAAK,mCAAmC,KAAK;AAG/C,YAAI,kCAAkC;AACpC,eAAK,QAAQ,oBAAoB,KAAK;;AAOxC,YAAI,CAAC,gBAAgB;AACnB,iBAAO;;AAGT,eAAO,eACJ,KAAK,WAAM;AAEV,iBAAK,UAAU,UAAU,iBAAiB,OAAK,IAAI,YAAY;AAG/D,iBAAK,KAAK,UAAU,aAAa,QAAW,OAAK;AAEjD,cAAM,OAAO,OAAK,QAAQ,cAAc;AACxC,cAAI,MAAM;AACR,iBAAK,MAAM,KAAK,QAAQ,SAAC,KAAQ;AAC/B,qBAAK,qBAAqB,SAAS;;;AAIvC,iBAAO,OAAK;WAEb,KAAK,WAAM;AACV,iBAAK,oBAAoB;AAIzB,iBAAK;AAGL,iBAAK;;;OAjOb;MAAA,KAAA;MAAA,OA0OE,sCAA6B;AAAA,YAAA,SAAA;AAC3B,YAAM,SAAS,SAAS,iBAAiB,KAAK,KAAK;AACnD,eAAO,gBAAgB,QAAQ,KAAK,SAAC,SAAY;AAC/C,cAAI,SAAS;AACX,mBAAK,qBAAqB;;;;OA9OlC;MAAA,KAAA;MAAA,OAsPE,mBAAU;AACR,aAAK,KAAK,UAAU;AACpB,aAAK;AACL,aAAK;;OAzPT;MAAA,KAAA;MAAA,OAiQE,wCAA+B;AAAA,YAAA,SAAA;AAK7B,YAAI,QAAQ,KAAK,KAAK,YAAY,UAAU;AAC1C;;AAKF,YAAI,qBAAqB;AACzB,YAAI,+BAA+B;AACnC,YAAI,0BAA0B;AAC9B,YAAI,qBAAqB;AACzB,YAAM,eAAe,uBAAC,OAAU;AAC9B,cAAI,MAAM,QAAQ,iBAAiB,CAAC,oBAAoB;AACtD,mBAAK,UAAU,UAAU,aAAa,MAAM,YAAY,MAAM;AAC9D,iCAAqB;qBAErB,MAAM,QAAQ,4BACd,CAAC,8BACD;AACA,gBAAM,QAAQ,MAAM,YAAY,MAAM;AACtC,mBAAK,UAAU,UAAU,wBAAwB;AACjD,mBAAK,iBAAiB,UAAU,gCAAgC;AAChE,2CAA+B;qBAE/B,MAAM,cAAc,iBACpB,CAAC,yBACD;AACA,gBAAM,SAAQ,MAAM,kBAAkB,MAAM;AAC5C,mBAAK,UAAU,UAAU,mBAAmB;AAC5C,sCAA0B;qBACjB,MAAM,cAAc,gBAAgB;AAI7C,gBAAI,CAAC,MAAM,kBAAkB,OAAK,cAAc,SAAS,KAAM;AAC7D,qBAAK,cAAc,KAAK;;qBAEjB,MAAM,cAAc,4BAA4B;AACzD,gBAAI,MAAM,UAAU;AAClB,qBAAK,kCAAkC,MAAM;;AAE/C,gBAAI,MAAM,YAAY;AACpB,qBAAK,oCAAoC,MAAM;;qBAExC,MAAM,aAAa,gBAAgB,CAAC,oBAAoB;AACjE,aACE,eACA,4BACA,8BACA,kBACA,gBACA,kBACA,gBACA,iBACA,QAAQ,SAAC,OAAD;AAAA,qBAAW,OAAK,KAAK,OAAO,MAAM;;AAC5C,iCAAqB;;;AAIzB,YAAM,sBAAsB;AAC5B,YAAI,KAAK,IAAI,wBAAwB;AAInC,eAAK,IAAI,YAAY,iBAAiB,SAAS,QAAQ;AACvD,8BAAoB,KAAK;;AAG3B,YAAI,KAAK,sBAAsB;AAC7B,eAAK,2BAA2B,cAAc;YAC5C,MAAM;YACN,UAAU;;;AAId,YAAI,KAAK,sBAAsB;AAC7B,eAAK,2BAA2B,cAAc;YAC5C,MAAM;YACN,UAAU;;;AAId,YAAI,KAAK,iCAAiC;AAExC,eAAK,2BAA2B,cAAc;YAC5C,MAAM;YACN,UAAU;;;AAId,YAAI,KAAK,qBAAqB;AAG5B,eAAK,2BAA2B,cAAc;YAC5C,MAAM;YACN,UAAU;;;AAId,YAAI,oBAAoB,SAAS,GAAG;AAClC,eAAK,2BAA2B,cAAc;YAC5C,YAAY;;;;OA1WpB;MAAA,KAAA;MAAA,OAqXE,oCAA2B,cAAc,MAAM;AAAA,YAAA,SAAA;AAC7C,YAAI;AACF,cAAM,MAAM,IAAI,KAAK,IAAI,oBAAoB,SAAC,MAAS;AACrD,iBAAK,aAAa,QAAQ;AAC1B,mBAAK;;AAEP,cAAI,QAAQ;iBACL,KAAP;AACA,gBAAM,KAAK,OAAK;;;OA7XtB;MAAA,KAAA;MAAA,OAqYE,oDAA2C;AAAA,YAAA,SAAA;AACzC,YAAI,CAAC,KAAK,IAAI,eAAe,CAAC,KAAK,IAAI,YAAY,mBAAmB;AACpE;;AAEF,aAAK,IAAI,YAAY,kBAAkB,SAAC,OAAU;AAChD,iBAAK,UAAU,UAAU,4BAA4B;AACrD,iBAAK;;;OA3YX;MAAA,KAAA;MAAA,OAoZE,qCAA4B;AAC1B,YAAM,QAAQ,KAAK,QAAQ;AAC3B,YACE,UAAU,gBAAgB,YAC1B,UAAU,gBAAgB,QAC1B;AACA,eAAK;;;OA1ZX;MAAA,KAAA;MAAA,OAkaE,kCAAyB;AACvB,YAAI,KAAK,sBAAsB;AAC7B,eAAK;;AAEP,YAAI,KAAK,iCAAiC;AACxC,eAAK;;;OAvaX;MAAA,KAAA;MAAA,OAubE,iCAAwB;AAAA,YAAA,oBAAA;AACtB,YAAM,MAAM,KAAK,cAAc,OAAO,SAAC,KAAK,OAAN;AAAA,iBAAgB,MAAM,MAAM;WAAO;AACzE,YAAM,MAAG,sBAAG,KAAK,SAAS,IAAI,UAAU,4BAA/B,OAAA,qBAA0D;AACnE,YAAM,MAAG,uBAAG,KAAK,SAAS,IAAI,UAAU,sBAA/B,OAAA,sBAAoD;AAG7D,YAAM,eAAe,KAAK,cAAc,OAAO,SAAC,KAAK,OAAU;AAC7D,cAAI,MAAM,YAAY,KAAK;AACzB,mBAAO,MAAM,MAAM;;AAErB,iBAAO;WACN;AACH,YAAM,eAAe,KAAK,cAAc,OAAO,SAAC,KAAK,OAAU;AAC7D,cAAI,MAAM,YAAY,KAAK;AACzB,mBAAO,MAAM,MAAM;;AAErB,iBAAO;WACN;AAEH,YAAI,KAAK,uBAAuB,GAAG;AACjC,eAAK,KAAK,UAAU,wCAAwC;AAC5D,eAAK,UACH,UAAU,oCACV;AAEF,eAAK,UAAU,UAAU,yBAAyB;AAClD,eAAK;AACL,eAAK,qBAAqB;mBACjB,KAAK,uBAAuB,GAAG;AACxC,eAAK,UAAU,UAAU,2BAA2B;AACpD,eAAK;AACL,eAAK,qBAAqB;;;OAtdhC;MAAA,KAAA;MAAA,OAgeE,qCAA4B;AAI1B,YACE,CAAC,KAAK,IAAI,0BACV,KAAK,IAAI,UACT,OAAO,KAAK,IAAI,OAAO,aAAa,YACpC;AACA,cAAM,SACJ,KAAK,IAAI,OAAO,YAAY,oBAAoB,MAChD,KAAK,IAAI,YAAY,OAAO;AAC9B,cAAI,UAAU,GAAG;AAGf;;AAEF,eAAK,UAAU,UAAU,aAAa;;;OAjf5C;MAAA,KAAA;MAAA,OAwfE,uCAA8B;AACL,YAAI;AAC3B,YAAI,KAAK,oCAAoC,MAAM;AACjD,eAAK,UACH,UAAU,+BACV,KAAK;AAEP,gBAAM,KAAK;;AAEb,YAAI,KAAK,sCAAsC,MAAM;AACnD,eAAK,UACH,UAAU,iCACV,KAAK;AAEP,gBAAM,OAAO,KAAK;;AAEpB,YAAI,QAAQ,MAAM;AAChB,eAAK,iBAAiB,UAAU,kCAAkC;;AAEpE,aAAK;;OA3gBT;MAAA,KAAA;MAAA,OAmhBE,uDAA8C;AAAA,YAAA,SAAA;AAC5C,YAAM,sBAAsB,CAAC,KAAK,QAAQ;AAE1C,YAAI,iBAAiB;AACrB,aAAK,QAAQ,mBAAmB,KAAK,WAAM;AACzC,2BAAiB,OAAK,IAAI,YAAY;AAEtC,iBAAK,KAAK;;AAGZ,aAAK,8BAA8B,KAAK,WAAM;AAC5C,cAAI,qBAAqB;AACvB,gBAAM,uCACJ,iBAAiB,KACb,OAAK,IAAI,YAAY,QAAQ,iBAE7B;AACN,mBAAK,QAAQ,mBAAmB,KAAK,WAAM;AAKzC,qBAAK,UACH,UAAU,sBACV;;AAGJ,mBAAK,mBAAmB;AAExB,mBAAK,KAAK,UAAU;iBACf;AAIL,mBAAK,KAAK,UAAU;AACpB,mBAAK,mBAAmB,OAAK,IAAI,YAAY,QAAQ;;AAEvD,iBAAK;;;OAxjBX;MAAA,KAAA;MAAA,OAkkBE,uCAA8B;AAAA,YAAA,SAAA;AAC5B,eAAO,KAAK,WAAW,gBAAgB,KAAK,WAAM;AAChD,cAAO,kBAAmB,OAAK,IAAI,SAA5B;AACP,cAAM,OAAO,SAAS,eAAe,iBAAiB;AACtD,cAAM,OAAO,eAAe,GAAG,GAAG,KAAK,OAAO,KAAK;AACnD,iBAAO,mBACL,iBACA,OAAK,KACL,MACoB;;;OA3kB5B;MAAA,KAAA;MAAA,OA0lBE,cAAK,OAAO,WAAW,WAAW;AAChC,kBACE,aAAa,UAAa,aAAa,QACvC;AAGF,YAAM,OAAO,KAAK;UAAC,SAAS;;AAC5B,YAAI;AAEJ,YAAI,aAAa,QAAW;AAC1B,eAAK,WAAW,QAAQ,KAAK,IAAI,WAAW;mBACnC,aAAa,QAAW;AACjC,eAAK,WAAW;eACX;AAEL,eAAK,KAAK;AACV,kBAAQ,KAAK,IAAI,YAAY;AAC7B,eAAK,WAAW,KAAK,cAAc;;AAIrC,aAAK,IAAI,cACP,kBACE,KAAK,KACL,QAC2B;UAAC;UAAO;;AAIvC,YAAI,KAAK,qBAAqB,KAAK,0BAA0B;AAC3D,eAAK,QAAQ,YAAY,QAAQ;eAC5B;AACL,eAAK,WAAW;;AAGlB,aAAK,SAAS,OAAO,OAAO;;OA7nBhC;MAAA,KAAA;MAAA,OAsoBE,cAAK,OAAO;AACV,YACE,KAAK,IAAI,eACT,KAAK,IAAI,YAAY,QACrB,UAAU,UAAU,GACpB;AACA,eAAK,IAAI,YAAY,KAAK;;;OA5oBhC;MAAA,KAAA;MAAA,OAspBE,mBAAU,OAAO,OAAO;AACtB,aAAK,KAAK,OAAO;;OAvpBrB;MAAA,KAAA;MAAA,OA+pBE,0BAAiB,OAAO,WAAW;AACjC,YAAM,QACJ,aAAa,SAAY,KAAK,IAAI,YAAY,QAAQ;AACxD,YAAM,MAAM,KAAK,cAAc;AAG/B,YAAM,cAAc,KAAK,WAAW,KAAK,QAAQ;AACjD,YAAM,IAAI,cAAc,KAAK,IAAI,MAAM,aAAa,KAAK;AACzD,aAAK,UAAU,OAAO;;OAvqB1B;MAAA,KAAA;MAAA,OA6qBE,iBAAQ;AACN,YAAI,KAAK,qBAAqB,KAAK,0BAA0B;AAC3D,cAAI,KAAK,WAAW,MAAM;AACxB,iBAAK,UAAU,OAAO,KAAK,KAAK,qBAAqB,KAAK;;AAE5D,eAAK,QAAQ,YACX,WACA,KAAK;YACH,UAAU,KAAK;YACf,gBAAgB,KAAK,cAAc;cAElB;;;OAxrB3B;MAAA,KAAA;MAAA,OAgsBE,0BAAiB;AACf,YAAI,CAAC,KAAK,iBAAiB;AAEzB,eAAK,kBAAkB,SAAS,KAAK,KAAK,KAAK,MAAM,KAAK,OAAO;;AAEnE,aAAK;;OArsBT;MAAA,KAAA;MAAA,OA2sBE,8BAAqB,cAAc;AACjC,aAAK,oBAAoB,gBAAgB;AACzC,aAAK,UAAU;;OA7sBnB;MAAA,KAAA;MAAA,OAstBE,oBAAW,MAAM;AAGf,YAAI,KAAK,QAAQ,UAAU,aAAa;AACtC,eAAK,QAAQ;;AAGf,aAAK,QAAQ,KAAK;;OA7tBtB;MAAA,KAAA;MAAA,OAouBE,6BAAoB;AAAA,YAAA,SAAA;AAClB,YAAI,CAAC,KAAK,SAAS;AACjB;;AAGF,YAAI,CAAC,KAAK,0BAA0B;AAElC,eAAK,QAAQ,SAAS;AACtB;;AAGF,aAAK,QAAQ,QAAQ,SAAC,WAAc;AAClC,iBAAK,QAAQ,YAAY,QAAQ;;AAEnC,aAAK,QAAQ,SAAS;;OAlvB1B;MAAA,KAAA;MAAA,OAyvBE,4BAAmB,OAAO;AACxB,YAAI,KAAK,SAAS;AAChB,eAAK,QAAQ,YACX,qBACA,KAAK;YAAC,SAAS;cACI;;;OA9vB3B;MAAA,KAAA;MAAA,OAywBE,mCAA0B;AACxB,eAAO,KAAK;;OA1wBhB;MAAA,KAAA;MAAA,OAmxBE,mBAAU,OAAO;AACf,eAAO,KAAK,SAAS,WAAW;;;AApxBpC,WAAA;;AA2xBO,qCAAmC,SAAQ;AAChD,2BAAuB,SAAQ,eAAe;;;;;;;;;;;;;;;;;;;;;;;;;;ACh0BhD,MAAM,aAAa;AAGnB,MAAM,YAAY;IAChB,KAAK;IACL,KAAK;;AAGP,MAAa,mBAAb,2BAAA;AAIE,+BAAY,QAAQ;AAAA,UAAA,QAAA;AAAA,wBAAA,MAAA;AAElB,WAAK,WAAW,SAAS,cAAc;AAGvC,WAAK,OAAO,OAAO,IAAI;AAGvB,WAAK,YAAY,KAAK,KAAK,cAAc;AAEzC,WAAK,SAAS,cAAc,KAAK,WAAW,WAAM;AAChD,cAAK,KAAK,KAAK,YAAY,MAAK;AAChC,kBAAU,MAAK,WAAW;UACxB,UAAU;UACV,KAAK;UACL,MAAM;UACN,QAAQ;UACR,YAAY;UACZ,eAAe;UACf,kBAAkB;;;;AAvB1B,mBAAA,mBAAA,CAAA;MAAA,KAAA;MAAA,OAkCE,aAAI,aAAa,WAAW,SAAS;AAAA,YAAA,SAAA;AACnC,YAAI,UAAU;AACd,eAAO,KAAK,SACT,cAAc,WAAW,WAAM;AAC9B,iBAAK,UAAU,cAAc;AAC7B,cAAM,WAAW,kBACf,OAAK,WACL,YACA,OAAK,aAAa,cAClB,UAAU,KACV,UAAU;AAEZ,cAAI,YAAY,UAAU,KAAK;AAC7B,mBAAK,gBAAgB,WAAW;AAChC,sBAAU;;WAGb,KAAK,WAAM;AACV,iBAAO;;;OApDf;MAAA,KAAA;MAAA,OA+DE,sBAAa,aAAa;AACxB,eAAO,YAAmB,cAAc;;OAhE5C;MAAA,KAAA;MAAA,OAuEE,yBAAgB,WAAW,UAAU;AACnC,iBAAS,WAAW,YAAY,GAAG;;;AAxEvC,WAAA;;AAsFA,6BACE,UACA,gBACA,eACA,aACA,aACA;AACA,aAAS,WAAW,aAAa,YAAY,aAAa,YAAY;AACpE,eAAS,UAAU,YAAY,GAAG;AAClC,UAAM,SAAS,SAAgB;AAC/B,UAAM,QAAQ,SAAgB;AAC9B,UAAI,SAAS,kBAAkB,QAAQ,eAAe;AACpD,eAAO;;;AAIX,WAAO,cAAc;;;;AClIhB,MAAM,OAAM;;;ACsGZ,qCAAmC,WAAW,SAAS,KAAK;AACjE,QAAM,QAAQ,KAAK,SAAS,cAAc;AAC1C,UAAa,cAAc;AAE3B,QAAM,iBAAiB,UAAU,OAC7B,YACA,iBAAiB;AAErB,mBAAe,YAAY;AAC3B,mBAAe,YAAY;;AAgL7B,MAAM,uCAAuC;AAM7C,MAAM,iCAA8B,MAAO,uCAAP;;;ACrS7B,MAAM,OAAM;;;ACwCnB,MAAM,QAAM;AAGZ,MAAM,kBAAkB;AAGxB,MAAM,uBAAuB;AAEtB,MAAM,2BAA2B;AAGjC,MAAM,cAAc;IACzB,kBAAkB;IAClB,iBAAiB;IACjB,UAAU;IACV,SAAS;;AAcJ,8BAA4B,KAAK;AACtC,QAAM,WAAW;AACjB,WAAO,IAAI,iBAAiB;;AASvB,qCAAmC,KAAK;AAC7C,QAAM,gBAAgB,mBAAmB;AACzC,QAAM,OAAO;AACb,kBAAc,eAAe,SAAC,KAAQ;AACpC,UAAO,UAAiB,IAAjB,SAAS,OAAQ,IAAR;AAChB,UAAI,KAAK,WAAW,kBAAkB;AACpC,YAAM,MAAM,KAAK,MAAM,QAAQ;AAC/B,aAAK,OAAO;iBACH,KAAK,WAAW,uBAAuB;AAChD,YAAM,OAAM,KAAK,MAAM,sBAAsB;AAC7C,aAAK,QAAO;;;AAGhB,WAAO;;AAuBF,+BAA6B,UAAU,YAAY;AAExD,QAAI,CAAC,SAAS,YAAY,aAAa,CAAC,SAAS,YAAY,UAAU;AAGrE,OAAC,cACC,OAAO,MAAM,OAAK;AACpB,aAAO;;AAET,WAAO;;AAWF,kCAAgC,KAAK,UAAU,WAAW;AAC/D,QAAM,MAAM,IAAI;AAEhB,QAAI;AACF,UAAM,OAAO,SAAS,YAAY;AAClC,UAAM,MAAM,SAAS,YAAY;AAGjC,UAAI,CAAC,QAAQ,CAAC,KAAK;AACjB,eAAO;;AAGT,qBACE,MACA,MAAM,cAAc,YACpB;AAGF,qBACE,KACA,MAAM,cAAc,YACpB;AAGF,UAAM,OAAO,4BACX,KACA,OACA,KAAK;QACH,QAAQ;QACR,SAAS;;AAIb,UAAM,gBAAgB,4BACpB,KACA,OACA,KAAK;QACH,SAAS;QACT,OAAO;;AAIX,oBAAc,iBAAiB,SAAS,SAAC,aAAD;AAAA,eACtC,uBAAuB,KAAK;;AAG9B,gCAA0B,MAAM,eAAe;AAC/C,gBAAU,YAAY;AAEtB,aAAO;aACA,GAAP;AAGA,aAAO;;;AASJ,kCAAgC,KAAK,MAAM;AAChD,qBAAiB,KAAK,MAAM;;AAUvB,qBAAmB,KAAK,cAAc,WAAW,YAAY;AAClE,QAAM,SAAS,WAAW,YAAY;AACtC,QAAM,UAAU,WAAW,YAAY;AAEvC,QAAM,KAAI,4BACR,KACA,KACA,KAAK;MACH,SAAS;MACT,UAAU;MACV,QAAQ;;AAIZ,QAAM,aAAa,aAAa,IAC9B,MAAM,cAAc,YACpB,IACA;AAGF,WAAO,WAAW,KAAK,SAAC,SAAY;AAClC,UAAI,CAAC,SAAS;AACZ,eAAO,KAAK,OAAK;AACjB,eAAO;;AAGT,SAAE,OAAO;AACT,SAAE,cAAc;AAEhB,UAAI,GAAE,aAAa,YAAY,GAAE,aAAa,SAAS;AACrD,eAAO,KAAK,OAAK;AACjB,eAAO;;AAGT,UAAM,WAAW,IAAI,cAAc;AACnC,eAAS,YAAY;AAErB,UAAM,WAAW,4BACf,KACA,OACA,KAAK;QACH,SAAS;QACT,QAAQ;;AAIZ,gCAA0B,UAAU,IAAG;AAEvC,eAAS,YAAY;AACrB,gBAAU,YAAY;AACtB,aAAO;;;;;ACnQJ,MAAM,OAAM;;;ACAZ,MAAM,OAAM;;;ACgCZ,sCAAoC,QAAQ;AACjD,QAAO,MAAO,OAAP;AACP,QAAM,MAAM,IAAI;AAChB,QAAM,kBAAkB,0BAA0B;AAClD,QAAI,CAAC,oBAAoB,iBAAiB,OAAwB;AAChE;;AAEF,wBAAoB,QAAQ,OAAY,MAAW,WAAM;;AACzD,2BAAuB,KAAK,iBAAiB,IAAI;AAEjD,QAAM,eAAe,IAAI,iBAAiB;AAC1C,QAAM,eAAe,IAAI,cAAc;AAIvC,cAAU,KAAK,cAAc,cAAc,iBAAiB,KAC1D,SAAC,WAAD;AAAA,aACE,aAAa,UAAU,aAAa,0BAA0B;;AAGlE,QAAI,KAAK,YAAY;AAErB,QAAI,IAAI,QAAQ;AACd,UAAI,OAAc,YAAY,qBAAqB;;;;;AC3BhD,yBAAuB,KAAK;AACjC,QAAM,WAAW,IAAI,SAAS;AAC9B,QAAI,SAAS,WAAW,WAAW;AAEjC;;AAEF,QAAI,YAAY;AAChB,QAAI,kBAAkB,MAAM;AAC1B,UAAM,OAAO,iBACX,IAAI,SAAS,mBAAmB,IAAI,SAAS;AAE/C,kBAAY,KAAK,gBAAgB;;AAGnC,QAAI,WAAW;AACb,iBAAW,IAAI,UAAa,KAAK,MAAvB,yBAAmD,KAAK,WAAM;AAEtE,YAAI,UAAU,kBAAkB,UAAU,IAAI;;eAEvC,UAAU,UAAU;AAC7B,iBAAW,IAAI,UAAa,KAAK,MAAvB;;;AAWP,sBAAoB,KAAK,KAAK;AACnC,QAAM,SACJ,IAAI,cAAc;AAEpB,WAAO,MAAM;AAGb,QAAM,gBAAgB,IAAI,KAAK,cAAc;AAC7C,QAAI,eAAe;AACjB,aAAO,aAAa,SAAS,cAAc,aAAa;;AAG1D,QAAM,UAAU,YAAY,QAAQ,KAClC,WAAM;AACJ,UAAI,KAAK,YAAY;OAEvB,WAAM;;AAER,QAAI,KAAK,YAAY;AACrB,WAAO;;;;AC5BT,UAAQ,MAAM,UAAU;AACxB,UAAQ,MAAM,QAAQ,SAAS;AAK/B,MAAI;AAIJ,MAAI;AAEF,0BAAsB;AAItB,sBAAkB,MAAwB;AAC1C,oBAAgB,SAAS,iBAAiB;WACnC,GAAP;AAEA,4BAAwB,KAAK;AAC7B,UAAM;;AAER;AACA,eAAa,KAAK,UAAU,mBAAmB;AAE7C,QAAM,SAAS,cAAc,UAAU,KAAK;AAC5C,2BAAuB;AACvB,8BAA0B;AAE1B,QAAM,OAAO,SAAS,eAAe;AACrC,SAAK,KAAK,UAAU;AAEpB,SAAK,SAAS,gBAAgB,UAAU,IAAI;AAC5C,wBACE,QAEA,UACE,qEACF,WAAM;AACJ,mBAAa,KAAK,UAAU,oBAAoB;AAE9C,+BAAuB;AACvB,8BAAsB;AACtB,uCAA+B;AAE/B,aAAK;AACL;AACA,gCAAwB;;AAE1B,mBAAa,KAAK,UAAU,oBAAoB;AAE9C,+BAAuB;;AAEzB,mBAAa,KAAK,UAAU,uBAAuB;AACjD,eAAM;;AAER,mBAAa,KAAK,UAAU,gBAAgB;AAE1C,2BAAmB;;AAErB,mBACE,KAAK,UACL,iBAAiB;AACf,mBAAW,8BAA8B,QAAQ;AACjD,mCAA2B;AAC3B,sBAAc;AACd,wBAAgB,KAAK;SAEM;AAE/B,mBAAa,KAAK,UAAU,qBAAqB;AAC/C,aAAK,KAAK,UAAU;AACpB,iBAAS,gBAAgB,QAAQ;AAGjC,aAAK;;OAGc,MACT;;AAOlB,MAAI,KAAK,SAAS;AAChB,IAAC,SAAQ,QAAQ,QAAQ,KAAK,KAC5B,SADF,+CAEqC,0BACnC,KAAK,SAAS;;AAGlB,OAAK,SAAS,gBAAgB,aAC5B,eACA;",
  "names": []
}
