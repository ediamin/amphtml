{
  "version": 3,
  "sources": ["../node_modules/@ampproject/toolbox-cache-url/dist/amp-toolbox-cache-url.umd.js", "../build/amp-story-entry-point.css.js", "../src/amp-story-player/amp-story-entry-point/amp-story-entry-point-impl.js", "../src/core/data-structures/promise.js", "../src/amp-story-player/amp-story-player-impl.js", "../src/core/types/function/index.js", "../src/amp-story-player/amp-story-player-viewport-observer.js", "../node_modules/@ampproject/viewer-messaging/messaging.js", "../src/amp-story-player/page-scroller.js", "../src/core/constants/visibility-state.js", "../src/core/types/object/index.js", "../src/core/data-structures/lru-cache.js", "../src/core/types/string/index.js", "../src/internal-version.js", "../src/core/types/string/url.js", "../src/mode.js", "../src/core/types/array.js", "../src/core/types/index.js", "../src/config.js", "../src/core/error/message-helpers.js", "../src/core/assert/base.js", "../src/core/error/index.js", "../src/log.js", "../src/url.js", "../src/core/minified-mode.js", "../src/core/assert/dev.js", "../third_party/css-escape/css-escape.js", "../src/dom.js", "../src/style.js", "../src/core/3p-frame.js", "../src/core/types/object/json.js", "../src/3p-frame.js", "../src/core/dom/event-helper-listen.js", "../src/event-helper.js", "../build/amp-story-player-iframe.css.js", "../src/amp-story-player/amp-story-component-manager.js", "../src/core/document-ready.js", "../src/amp-story-player/amp-story-player.js"],
  "sourcesContent": ["'use strict';(function(m,q){\"object\"===typeof exports&&\"undefined\"!==typeof module?q(exports):\"function\"===typeof define&&define.amd?define([\"exports\"],q):(m=\"undefined\"!==typeof globalThis?globalThis:m||self,q(m.AmpToolboxCacheUrl={}))})(this,function(m){function q(a){try{return decodeURIComponent(a.replace(/\\+/g,\" \"))}catch(b){return null}}function t(a){return(a?a:\"\").toString().replace(N,\"\")}function z(a){var b=(\"undefined\"!==typeof window?window:\"undefined\"!==typeof A?A:\"undefined\"!==typeof self?\nself:{}).location||{};a=a||b;b={};var d=typeof a,c;if(\"blob:\"===a.protocol)b=new k(unescape(a.pathname),{});else if(\"string\"===d)for(c in b=new k(a,{}),B)delete b[c];else if(\"object\"===d){for(c in a)c in B||(b[c]=a[c]);void 0===b.slashes&&(b.slashes=O.test(a.href))}return b}function C(a){a=t(a);a=P.exec(a);return{protocol:a[1]?a[1].toLowerCase():\"\",slashes:!!(a[2]&&2<=a[2].length),rest:a[2]&&1===a[2].length?\"/\"+a[3]:a[3]}}function k(a,b,d){a=t(a);if(!(this instanceof k))return new k(a,b,d);var c=\nu.slice();var e=typeof b;var l=0;\"object\"!==e&&\"string\"!==e&&(d=b,b=null);d&&\"function\"!==typeof d&&(d=r.parse);b=z(b);var f=C(a||\"\");e=!f.protocol&&!f.slashes;this.slashes=f.slashes||e&&b.slashes;this.protocol=f.protocol||b.protocol||\"\";a=f.rest;for(f.slashes||(c[3]=[/(.*)/,\"pathname\"]);l<c.length;l++)if(f=c[l],\"function\"===typeof f)a=f(a);else{var h=f[0];var g=f[1];if(h!==h)this[g]=a;else if(\"string\"===typeof h)~(h=a.indexOf(h))&&(\"number\"===typeof f[2]?(this[g]=a.slice(0,h),a=a.slice(h+f[2])):\n(this[g]=a.slice(h),a=a.slice(0,h)));else if(h=h.exec(a))this[g]=h[1],a=a.slice(0,h.index);this[g]=this[g]||(e&&f[3]?b[g]||\"\":\"\");f[4]&&(this[g]=this[g].toLowerCase())}d&&(this.query=d(this.query));if(e&&b.slashes&&\"/\"!==this.pathname.charAt(0)&&(\"\"!==this.pathname||\"\"!==b.pathname)){a=this.pathname;b=b.pathname;if(\"\"!==a){b=(b||\"/\").split(\"/\").slice(0,-1).concat(a.split(\"/\"));a=b.length;d=b[a-1];c=!1;for(l=0;a--;)\".\"===b[a]?b.splice(a,1):\"..\"===b[a]?(b.splice(a,1),l++):l&&(0===a&&(c=!0),b.splice(a,\n1),l--);c&&b.unshift(\"\");\".\"!==d&&\"..\"!==d||b.push(\"\");b=b.join(\"/\")}this.pathname=b}\"/\"!==this.pathname.charAt(0)&&this.hostname&&(this.pathname=\"/\"+this.pathname);D(this.port,this.protocol)||(this.host=this.hostname,this.port=\"\");this.username=this.password=\"\";this.auth&&(f=this.auth.split(\":\"),this.username=f[0]||\"\",this.password=f[1]||\"\");this.origin=this.protocol&&this.host&&\"file:\"!==this.protocol?this.protocol+\"//\"+this.host:\"null\";this.href=this.toString()}function p(a){throw new RangeError(Q[a]);\n}function E(a,b){var d=a.split(\"@\");let c=\"\";1<d.length&&(c=d[0]+\"@\",a=d[1]);a=a.replace(R,\".\");{a=a.split(\".\");d=[];let c=a.length;for(;c--;)d[c]=b(a[c]);b=d}b=b.join(\".\");return c+b}function F(a){let b=[],d=0,c=a.length;for(;d<c;){let e=a.charCodeAt(d++);if(55296<=e&&56319>=e&&d<c){let c=a.charCodeAt(d++);56320==(c&64512)?b.push(((e&1023)<<10)+(c&1023)+65536):(b.push(e),d--)}else b.push(e)}return b}function S(a){a=(new TextEncoder(\"utf-8\")).encode(a);return window.crypto.subtle.digest(\"SHA-256\",\na).then(a=>{var b=[];a=new DataView(a);for(let c=0;c<a.byteLength;c+=4){let d=(\"00000000\"+a.getUint32(c).toString(16)).slice(-8);b.push(d)}return b=b.join(\"\")})}function v(a){a=(new w(a)).hostname;if(G(a))var b=!1;else b=x.toUnicode(a),b=63>=a.length&&!(T.test(b)&&U.test(b))&&-1!=a.indexOf(\".\");if(b){b=x.toUnicode(a);b=b.split(\"-\").join(\"--\");b=b.split(\".\").join(\"-\");b=x.toASCII(b).toLowerCase();if(63<b.length)return H(a);G(b)&&(b=\"0-\".concat(b,\"-0\"));return Promise.resolve(b)}return H(a)}function H(a){a=\n\"undefined\"!==typeof window?S(a):void 0;return a.then(a=>V(\"ffffffffff\"+a+\"000000\").substr(8,Math.ceil(4*a.length/5)))}function V(a){let b=[];a.match(/.{1,2}/g).forEach((a,c)=>{b[c]=parseInt(a,16)});var d=b.length%5,c=Math.floor(b.length/5);a=[];if(0!=d){for(var e=0;e<5-d;e++)b+=\"\\x00\";c+=1}for(e=0;e<c;e++)a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt(b[5*e]>>3)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e]&7)<<2|b[5*e+1]>>6)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e+\n1]&63)>>1)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e+1]&1)<<4|b[5*e+2]>>4)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e+2]&15)<<1|b[5*e+3]>>7)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e+3]&127)>>2)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e+3]&3)<<3|b[5*e+4]>>5)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt(b[5*e+4]&31));c=0;1==d?c=6:2==d?c=4:3==d?c=3:4==d&&(c=1);for(d=0;d<c;d++)a.pop();for(d=0;d<c;d++)a.push(\"=\");return a.join(\"\")}function G(a){return\"--\"==\na.slice(2,4)&&\"xn\"!=a.slice(0,2)}function I(a,b,d=null){let c=new w(b),e=W(c.pathname,d);e+=\"https:\"===c.protocol?\"/s/\":\"/\";b.endsWith(\"/\")||(c.pathname=c.pathname.replace(/\\/$/,\"\"));return v(c.toString()).then(d=>{let f=new w(b);f.protocol=\"https\";d=d+\".\"+a;f.host=d;f.hostname=d;f.pathname=e+c.hostname+c.pathname;return f.toString()})}function W(a,b=null){return X.isPathNameAnImage(a)?\"/i\":Y.isPathNameAFont(a)?\"/r\":b===Z.VIEWER?\"/v\":\"/c\"}let aa=\"ase art bmp blp cd5 cit cpt cr2 cut dds dib djvu egt exif gif gpl grf icns ico iff jng jpeg jpg jfif jp2 jps lbm max miff mng msp nitf ota pbm pc1 pc2 pc3 pcf pcx pdn pgm PI1 PI2 PI3 pict pct pnm pns ppm psb psd pdd psp px pxm pxr qfx raw rle sct sgi rgb int bw tga tiff tif vtf xbm xcf xpm 3dv amf ai awg cgm cdr cmx dxf e2d egt eps fs gbr odg svg stl vrml x3d sxd v2d vnd wmf emf art xar png webp jxr hdp wdp cur ecw iff lbm liff nrrd pam pcx pgf sgi rgb rgba bw int inta sid ras sun tga\".split(\" \"),\nX={isPathNameAnImage:a=>aa.some(b=>a.endsWith(`.${b}`)?!0:!1)},ba=\"### #gf $on $tf 0b 8m 8u 12u 15u 64c 075 75 085 85 91 091 096 96 abf acfm acs afm afn afs all amfm apf asf aspf atm auf b30 bco bdf bepf bez bfn bmap bmf bx bzr cbtf cct cef cff cfn cga ch4 cha chm chr chx claf collection compositefont dfont dus dzk eft eot etx euf f00 f06 f08 f09 f3f f10 f11 f12 f13 f16 fd fdb ff ffil flf fli fn3 fnb fnn fnt fnta fo1 fo2 fog fon font fonts fot frf frs ftm fxr fyi gdr gf gft glf glif glyphs gsf gxf hbf ice intellifont lepf lft lwfn mcf mcf mfd mfm mft mgf mmm mrf mtf mvec nlq ntf odttf ofm okf otf pcf pcf pfa pfb pfm pft phf pk pkt prs pss qbf qfn r8? scr sfd sff sfi sfl sfn sfo sfp sfs sif snf spd spritefont sui suit svg sxs t1c t2 tb1 tb2 tdf tfm tmf tpf ttc tte ttf type ufm ufo usl usp us? vf vf1 vf3 vfb vfm vfont vlw vmf vnf w30 wfn wnf woff woff2 xfc xfn xfr xft zfi zsu _v\".split(\" \"),\nY={isPathNameAFont:a=>ba.some(b=>a.endsWith(`.${b}`)?!0:!1)};var A=\"undefined\"!==typeof globalThis?globalThis:\"undefined\"!==typeof window?window:\"undefined\"!==typeof global?global:\"undefined\"!==typeof self?self:{},D=function(a,b){b=b.split(\":\")[0];a=+a;if(!a)return!1;switch(b){case \"http\":case \"ws\":return 80!==a;case \"https\":case \"wss\":return 443!==a;case \"ftp\":return 21!==a;case \"gopher\":return 70!==a;case \"file\":return!1}return 0!==a},ca=Object.prototype.hasOwnProperty,r={stringify:function(a,b){b=\nb||\"\";var d=[],c;\"string\"!==typeof b&&(b=\"?\");for(e in a)if(ca.call(a,e)){(c=a[e])||null!==c&&void 0!==c&&!isNaN(c)||(c=\"\");var e=encodeURIComponent(e);c=encodeURIComponent(c);null!==e&&null!==c&&d.push(e+\"=\"+c)}return d.length?b+d.join(\"&\"):\"\"},parse:function(a){for(var b=/([^=?&]+)=?([^&]*)/g,d={},c;c=b.exec(a);){var e=q(c[1]);c=q(c[2]);null===e||null===c||e in d||(d[e]=c)}return d}},O=/^[A-Za-z][A-Za-z0-9+-.]*:[\\\\/]+/,P=/^([a-z][a-z0-9.+-]*:)?([\\\\/]{1,})?([\\S\\s]*)/i,N=/^[\\x09\\x0A\\x0B\\x0C\\x0D\\x20\\xA0\\u1680\\u180E\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200A\\u202F\\u205F\\u3000\\u2028\\u2029\\uFEFF]+/,\nu=[[\"#\",\"hash\"],[\"?\",\"query\"],function(a){return a.replace(\"\\\\\",\"/\")},[\"/\",\"pathname\"],[\"@\",\"auth\",1],[NaN,\"host\",void 0,1,1],[/:(\\d+)$/,\"port\",void 0,1],[NaN,\"hostname\",void 0,1,1]],B={hash:1,query:1};k.prototype={set:function(a,b,d){switch(a){case \"query\":\"string\"===typeof b&&b.length&&(b=(d||r.parse)(b));this[a]=b;break;case \"port\":this[a]=b;D(b,this.protocol)?b&&(this.host=this.hostname+\":\"+b):(this.host=this.hostname,this[a]=\"\");break;case \"hostname\":this[a]=b;this.port&&(b+=\":\"+this.port);this.host=\nb;break;case \"host\":this[a]=b;/:\\d+$/.test(b)?(b=b.split(\":\"),this.port=b.pop(),this.hostname=b.join(\":\")):(this.hostname=b,this.port=\"\");break;case \"protocol\":this.protocol=b.toLowerCase();this.slashes=!d;break;case \"pathname\":case \"hash\":b?(d=\"pathname\"===a?\"/\":\"#\",this[a]=b.charAt(0)!==d?d+b:b):this[a]=b;break;default:this[a]=b}for(a=0;a<u.length;a++)b=u[a],b[4]&&(this[b[1]]=this[b[1]].toLowerCase());this.origin=this.protocol&&this.host&&\"file:\"!==this.protocol?this.protocol+\"//\"+this.host:\"null\";\nthis.href=this.toString();return this},toString:function(a){a&&\"function\"===typeof a||(a=r.stringify);var b=this.protocol;b&&\":\"!==b.charAt(b.length-1)&&(b+=\":\");b+=this.slashes?\"//\":\"\";this.username&&(b+=this.username,this.password&&(b+=\":\"+this.password),b+=\"@\");b+=this.host+this.pathname;(a=\"object\"===typeof this.query?a(this.query):this.query)&&(b+=\"?\"!==a.charAt(0)?\"?\"+a:a);this.hash&&(b+=this.hash);return b}};k.extractProtocol=C;k.location=z;k.trimLeft=t;k.qs=r;var w=k;let da=/^xn--/,ea=/[^\\0-\\x7E]/,\nR=/[\\x2E\\u3002\\uFF0E\\uFF61]/g,Q={overflow:\"Overflow: input needs wider integers to process\",\"not-basic\":\"Illegal input >= 0x80 (not a basic code point)\",\"invalid-input\":\"Invalid input\"},n=Math.floor,y=String.fromCharCode,J=function(a,b){return a+22+75*(26>a)-((0!=b)<<5)},K=function(a,b,d){let c=0;a=d?n(a/700):a>>1;for(a+=n(a/b);455<a;c+=36)a=n(a/35);return n(c+36*a/(a+38))},L=function(a){const b=[],d=a.length;let c=0,e=128,l=72;var f=a.lastIndexOf(\"-\");0>f&&(f=0);for(var h=0;h<f;++h)128<=a.charCodeAt(h)&&\np(\"not-basic\"),b.push(a.charCodeAt(h));for(f=0<f?f+1:0;f<d;){h=c;for(let b=1,e=36;;e+=36){f>=d&&p(\"invalid-input\");var g=a.charCodeAt(f++);g=10>g-48?g-22:26>g-65?g-65:26>g-97?g-97:36;(36<=g||g>n((2147483647-c)/b))&&p(\"overflow\");c+=g*b;const h=e<=l?1:e>=l+26?26:e-l;if(g<h)break;g=36-h;b>n(2147483647/g)&&p(\"overflow\");b*=g}g=b.length+1;l=K(c-h,g,0==h);n(c/g)>2147483647-e&&p(\"overflow\");e+=n(c/g);c%=g;b.splice(c++,0,e)}return String.fromCodePoint(...b)},M=function(a){const b=[];a=F(a);let d=a.length,\nc=128,e=0,l=72;for(var f of a)128>f&&b.push(y(f));let h=f=b.length;for(f&&b.push(\"-\");h<d;){var g=2147483647;for(const b of a)b>=c&&b<g&&(g=b);const d=h+1;g-c>n((2147483647-e)/d)&&p(\"overflow\");e+=(g-c)*d;c=g;for(const m of a)if(m<c&&2147483647<++e&&p(\"overflow\"),m==c){var k=e;for(g=36;;g+=36){const a=g<=l?1:g>=l+26?26:g-l;if(k<a)break;k-=a;const c=36-a;b.push(y(J(a+k%c,0)));k=n(k/c)}b.push(y(J(k,0)));l=K(e,d,h==f);e=0;++h}++e;++c}return b.join(\"\")},x={version:\"2.1.0\",ucs2:{decode:F,encode:a=>String.fromCodePoint(...a)},\ndecode:L,encode:M,toASCII:function(a){return E(a,function(a){return ea.test(a)?\"xn--\"+M(a):a})},toUnicode:function(a){return E(a,function(a){return da.test(a)?L(a.slice(4).toLowerCase()):a})}},T=/[A-Za-z\\u00c0-\\u00d6\\u00d8-\\u00f6\\u00f8-\\u02b8\\u0300-\\u0590\\u0800-\\u1fff\\u200e\\u2c00-\\ufb1c\\ufe00-\\ufe6f\\ufefd-\\uffff]/,U=/[\\u0591-\\u06ef\\u06fa-\\u07ff\\u200f\\ufb1d-\\ufdff\\ufe70-\\ufefc]/,Z={CONTENT:\"content\",VIEWER:\"viewer\",WEB_PACKAGE:\"web_package\",CERTIFICATE:\"certificate\",IMAGE:\"image\"},fa={createCacheUrl:I,\ncreateCurlsSubdomain:v};m.createCacheUrl=I;m.createCurlsSubdomain=v;m.default=fa;Object.defineProperty(m,\"__esModule\",{value:!0})})\n", "export const cssText = \"amp-story-entry-point{position:relative;display:block}\\n/*# sourceURL=/css/amp-story-entry-point.css*/\"", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Source for this constant is css/amp-story-entry-point.css\nimport {cssText} from '../../../build/amp-story-entry-point.css';\n\n/**\n * <amp-story-entry-point> component for embedding stories and launching them in\n * the <amp-story-player>.\n *\n * Note that this is a vanilla JavaScript class and should not depend on AMP\n * services, as v0.js is not expected to be loaded in this context.\n */\nexport class AmpStoryEntryPoint {\n  /**\n   * @param {!Window} win\n   * @param {!Element} element\n   * @constructor\n   */\n  constructor(win, element) {\n    /** @private {!Window} */\n    this.win_ = win;\n\n    /** @private {!Element} */\n    this.element_ = element;\n\n    /** @private {!Document} */\n    this.doc_ = this.win_.document;\n\n    /** @private {boolean} */\n    this.isBuilt_ = false;\n\n    /** @private {boolean} */\n    this.isLaidOut_ = false;\n\n    /** @private {?Element} */\n    this.rootEl_ = null;\n  }\n\n  /** @public */\n  buildCallback() {\n    if (this.isBuilt_) {\n      return;\n    }\n\n    this.initializeShadowRoot_();\n\n    this.isBuilt_ = true;\n  }\n\n  /** @public */\n  layoutCallback() {\n    if (this.isLaidOut_) {\n      return;\n    }\n\n    this.isLaidOut_ = true;\n  }\n\n  /** @private */\n  initializeShadowRoot_() {\n    this.rootEl_ = this.doc_.createElement('main');\n\n    // Create shadow root\n    const shadowRoot = this.element_.attachShadow({mode: 'open'});\n\n    // Inject default styles\n    const styleEl = this.doc_.createElement('style');\n    styleEl.textContent = cssText;\n    shadowRoot.appendChild(styleEl);\n    shadowRoot.appendChild(this.rootEl_);\n  }\n\n  /**\n   * @public\n   * @return {!Element}\n   */\n  getElement() {\n    return this.element_;\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nlet resolved;\n\n/**\n * Returns a cached resolved promise.\n * Babel converts direct calls to Promise.resolve() (with no arguments) into\n * calls to this.\n *\n * @return {!Promise<undefined>}\n */\nexport function resolvedPromise() {\n  if (resolved) {\n    return resolved;\n  }\n\n  // It's important that we call with `undefined` here, to prevent a transform\n  // recursion. If we didn't pass an arg, then the transformer would replace\n  // this callsite with a call to `resolvedPromise()`.\n  resolved = Promise.resolve(undefined);\n  return resolved;\n}\n\n/**\n * Returns a Deferred struct, which holds a pending promise and its associated\n * resolve and reject functions.\n *\n * This is preferred instead of creating a Promise instance to extract the\n * resolve/reject functions yourself:\n *\n * ```\n * // Avoid doing\n * let resolve;\n * const promise = new Promise(res => {\n *   resolve = res;\n * });\n *\n * // Good\n * const deferred = new Deferred();\n * const { promise, resolve } = deferred;\n * ```\n *\n * @template T\n */\nexport class Deferred {\n  /** Constructor. */\n  constructor() {\n    /** @const {!Promise<T>} */\n    this.promise = new /*OK*/ Promise((res, rej) => {\n      /** @const {function(T=)} */\n      this.resolve = res;\n      /** @const {function(*=)} */\n      this.reject = rej;\n    });\n  }\n}\n\n/**\n * Creates a promise resolved to the return value of fn.\n * If fn sync throws, it will cause the promise to reject.\n *\n * @param {function():T} fn\n * @return {!Promise<T>}\n * @template T\n */\nexport function tryResolve(fn) {\n  return new Promise((resolve) => {\n    resolve(fn());\n  });\n}\n\n/**\n * Resolves with the result of the last promise added.\n * @implements {IThenable}\n */\nexport class LastAddedResolver {\n  /**\n   * @param {!Array<!IThenable>=} opt_promises\n   */\n  constructor(opt_promises) {\n    /** @private @const {!Deferred} */\n    this.deferred_ = new Deferred();\n\n    /** @private */\n    this.count_ = 0;\n\n    if (opt_promises) {\n      for (const promise of opt_promises) {\n        this.add(promise);\n      }\n    }\n  }\n\n  /**\n   * Add a promise to possibly be resolved.\n   * @param {!IThenable} promise\n   * @return {!Promise}\n   */\n  add(promise) {\n    const countAtAdd = ++this.count_;\n    promise.then(\n      (result) => {\n        if (this.count_ === countAtAdd) {\n          this.deferred_.resolve(result);\n        }\n      },\n      (error) => {\n        // Don't follow behavior of Promise.all and Promise.race error so that\n        // this will only reject when most recently added promise fails.\n        if (this.count_ === countAtAdd) {\n          this.deferred_.reject(error);\n        }\n      }\n    );\n    return this.deferred_.promise;\n  }\n\n  /** @override */\n  then(opt_resolve, opt_reject) {\n    return this.deferred_.promise.then(opt_resolve, opt_reject);\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as ampToolboxCacheUrl from '@ampproject/toolbox-cache-url';\nimport {AmpStoryPlayerViewportObserver} from './amp-story-player-viewport-observer';\nimport {Deferred} from '../core/data-structures/promise';\nimport {Messaging} from '@ampproject/viewer-messaging';\nimport {PageScroller} from './page-scroller';\nimport {VisibilityState} from '../core/constants/visibility-state';\nimport {\n  addParamsToUrl,\n  getFragment,\n  isProxyOrigin,\n  parseUrlWithA,\n  removeFragment,\n  removeSearch,\n  serializeQueryString,\n} from '../url';\nimport {applySandbox} from '../3p-frame';\nimport {createCustomEvent, listenOnce} from '../event-helper';\nimport {dict} from '../core/types/object';\nimport {isJsonScriptTag, tryFocus} from '../dom';\nimport {parseQueryString} from '../core/types/string/url';\n// Source for this constant is css/amp-story-player-iframe.css\nimport {cssText} from '../../build/amp-story-player-iframe.css';\nimport {devAssertElement} from '../core/assert';\nimport {findIndex, toArray} from '../core/types/array';\nimport {getMode} from '../../src/mode';\nimport {parseJson} from '../core/types/object/json';\nimport {resetStyles, setStyle, setStyles} from '../style';\nimport {urls} from '../config';\n\n/** @enum {string} */\nconst LoadStateClass = {\n  LOADING: 'i-amphtml-story-player-loading',\n  LOADED: 'i-amphtml-story-player-loaded',\n  ERROR: 'i-amphtml-story-player-error',\n};\n\n/** @enum {number} */\nconst StoryPosition = {\n  PREVIOUS: -1,\n  CURRENT: 0,\n  NEXT: 1,\n};\n\n/** @const @type {!Array<string>} */\nconst SUPPORTED_CACHES = ['cdn.ampproject.org', 'www.bing-amp.com'];\n\n/** @const @type {!Array<string>} */\nconst SANDBOX_MIN_LIST = ['allow-top-navigation'];\n\n/** @enum {number} */\nconst SwipingState = {\n  NOT_SWIPING: 0,\n  SWIPING_TO_LEFT: 1,\n  SWIPING_TO_RIGHT: 2,\n};\n\n/** @const {number} */\nconst TOGGLE_THRESHOLD_PX = 50;\n\n/**\n * Fetches more stories when reaching the threshold.\n * @const {number}\n */\nconst FETCH_STORIES_THRESHOLD = 2;\n\n/** @enum {string} */\nconst DEPRECATED_BUTTON_TYPES = {\n  BACK: 'back-button',\n  CLOSE: 'close-button',\n};\n\n/** @enum {string} */\nconst DEPRECATED_BUTTON_CLASSES = {\n  BASE: 'amp-story-player-exit-control-button',\n  HIDDEN: 'amp-story-player-hide-button',\n  [DEPRECATED_BUTTON_TYPES.BACK]: 'amp-story-player-back-button',\n  [DEPRECATED_BUTTON_TYPES.CLOSE]: 'amp-story-player-close-button',\n};\n\n/** @enum {string} */\nconst DEPRECATED_EVENT_NAMES = {\n  [DEPRECATED_BUTTON_TYPES.BACK]: 'amp-story-player-back',\n  [DEPRECATED_BUTTON_TYPES.CLOSE]: 'amp-story-player-close',\n};\n\n/** @enum {string} */\nconst STORY_STATE_TYPE = {\n  PAGE_ATTACHMENT_STATE: 'page-attachment',\n};\n\n/** @enum {string} */\nconst STORY_MESSAGE_STATE_TYPE = {\n  PAGE_ATTACHMENT_STATE: 'PAGE_ATTACHMENT_STATE',\n  MUTED_STATE: 'MUTED_STATE',\n  CURRENT_PAGE_ID: 'CURRENT_PAGE_ID',\n  STORY_PROGRESS: 'STORY_PROGRESS',\n};\n\n/** @const {string} */\nexport const AMP_STORY_PLAYER_EVENT = 'AMP_STORY_PLAYER_EVENT';\n\n/** @const {string} */\nconst CLASS_NO_NAVIGATION_TRANSITION =\n  'i-amphtml-story-player-no-navigation-transition';\n\n/** @typedef {{ state:string, value:(boolean|string) }} */\nlet DocumentStateTypeDef;\n\n/**\n * @typedef {{\n *   href: string,\n *   idx: number,\n *   distance: number,\n *   iframe: ?Element,\n *   messagingPromise: ?Promise,\n *   title: (?string),\n *   posterImage: (?string),\n *   storyContentLoaded: ?boolean,\n *   connectedDeferred: !Deferred\n * }}\n */\nlet StoryDef;\n\n/**\n * @typedef {{\n *   on: ?string,\n *   action: ?string,\n *   endpoint: ?string,\n *   pageScroll: ?boolean,\n *   autoplay: ?boolean,\n * }}\n */\nlet BehaviorDef;\n\n/**\n * @typedef {{\n *   attribution: ?string,\n * }}\n */\nlet DisplayDef;\n\n/**\n * @typedef {{\n *   controls: ?Array<!ViewerControlDef>,\n *   behavior: ?BehaviorDef,\n *   display: ?DisplayDef,\n * }}\n */\nlet ConfigDef;\n\n/**\n * @typedef {{\n *   name: string,\n *   state: (?string),\n *   event: (?string),\n *   visibility: (?string),\n *   position: (?string),\n *   backgroundImageUrl: (?string)\n * }}\n */\nexport let ViewerControlDef;\n\n/** @type {string} */\nconst TAG = 'amp-story-player';\n\n/** @enum {string} */\nconst LOG_TYPE = {\n  DEV: 'amp-story-player-dev',\n};\n\n/**\n * Note that this is a vanilla JavaScript class and should not depend on AMP\n * services, as v0.js is not expected to be loaded in this context.\n */\nexport class AmpStoryPlayer {\n  /**\n   * @param {!Window} win\n   * @param {!Element} element\n   */\n  constructor(win, element) {\n    /** @private {!Window} */\n    this.win_ = win;\n\n    /** @private {!Element} */\n    this.element_ = element;\n\n    /** @private {!Document} */\n    this.doc_ = win.document;\n\n    /** @private {!Element} */\n    this.cachedA_ = this.doc_.createElement('a');\n\n    /** @private {!Array<!StoryDef>} */\n    this.stories_ = [];\n\n    /** @private {?Element} */\n    this.rootEl_ = null;\n\n    /** @private {number} */\n    this.currentIdx_ = 0;\n\n    /** @private {!SwipingState} */\n    this.swipingState_ = SwipingState.NOT_SWIPING;\n\n    /** @private {?ConfigDef} */\n    this.playerConfig_ = null;\n\n    /** @private {?boolean} */\n    this.isFetchingStoriesEnabled_ = null;\n\n    /** @private {?boolean} */\n    this.isCircularWrappingEnabled_ = null;\n\n    /** @private {!Object} */\n    this.touchEventState_ = {\n      startX: 0,\n      startY: 0,\n      lastX: 0,\n      isSwipeX: null,\n    };\n\n    /** @private {?Deferred} */\n    this.currentStoryLoadDeferred_ = null;\n\n    /** @private {!Deferred} */\n    this.visibleDeferred_ = new Deferred();\n\n    this.attachCallbacksToElement_();\n\n    /** @private {?PageScroller} */\n    this.pageScroller_ = new PageScroller(win);\n\n    /** @private {boolean} */\n    this.playing_ = true;\n\n    /** @private {?string} */\n    this.attribution_ = null;\n\n    return this.element_;\n  }\n\n  /**\n   * Attaches callbacks to the DOM element for them to be used by publishers.\n   * @private\n   */\n  attachCallbacksToElement_() {\n    this.element_.buildPlayer = this.buildPlayer.bind(this);\n    this.element_.layoutPlayer = this.layoutPlayer.bind(this);\n    this.element_.getElement = this.getElement.bind(this);\n    this.element_.getStories = this.getStories.bind(this);\n    this.element_.load = this.load.bind(this);\n    this.element_.show = this.show.bind(this);\n    this.element_.add = this.add.bind(this);\n    this.element_.play = this.play.bind(this);\n    this.element_.pause = this.pause.bind(this);\n    this.element_.go = this.go.bind(this);\n    this.element_.mute = this.mute.bind(this);\n    this.element_.unmute = this.unmute.bind(this);\n    this.element_.getStoryState = this.getStoryState.bind(this);\n    this.element_.rewind = this.rewind.bind(this);\n  }\n\n  /**\n   * External callback for manually loading the player.\n   * @public\n   */\n  load() {\n    if (!this.element_.isConnected) {\n      throw new Error(\n        `[${TAG}] element must be connected to the DOM before calling load().`\n      );\n    }\n    if (!!this.element_.isBuilt_) {\n      throw new Error(`[${TAG}] calling load() on an already loaded element.`);\n    }\n    this.buildPlayer();\n    this.layoutPlayer();\n  }\n\n  /**\n   * Initializes story with properties used in this class and adds it to the\n   * stories array.\n   * @param {!StoryDef} story\n   * @private\n   */\n  initializeAndAddStory_(story) {\n    story.idx = this.stories_.length;\n    story.distance = story.idx - this.currentIdx_;\n    story.connectedDeferred = new Deferred();\n    this.stories_.push(story);\n  }\n\n  /**\n   * Adds stories to the player. Additionally, creates or assigns\n   * iframes to those that are close to the current playing story.\n   * @param {!Array<!{href: string, title: ?string, posterImage: ?string}>} newStories\n   * @public\n   */\n  add(newStories) {\n    if (newStories.length <= 0) {\n      return;\n    }\n\n    const isStoryDef = (story) => story && story.href;\n    if (!Array.isArray(newStories) || !newStories.every(isStoryDef)) {\n      throw new Error('\"stories\" parameter has the wrong structure');\n    }\n\n    const renderStartingIdx = this.stories_.length;\n\n    for (let i = 0; i < newStories.length; i++) {\n      const story = newStories[i];\n      this.initializeAndAddStory_(story);\n      this.buildIframeFor_(story);\n    }\n\n    this.render_(renderStartingIdx);\n  }\n\n  /**\n   * Makes the current story play its content/auto-advance\n   * @public\n   */\n  play() {\n    if (!this.element_.isLaidOut_) {\n      this.layoutPlayer();\n    }\n    this.togglePaused_(false);\n  }\n\n  /**\n   * Makes the current story pause its content/auto-advance\n   * @public\n   */\n  pause() {\n    this.togglePaused_(true);\n  }\n\n  /**\n   * Makes the current story play or pause its content/auto-advance\n   * @param {boolean} paused If true, the story will be paused, and it will be played otherwise\n   * @private\n   */\n  togglePaused_(paused) {\n    this.playing_ = !paused;\n    const currentStory = this.stories_[this.currentIdx_];\n\n    this.updateVisibilityState_(\n      currentStory,\n      paused ? VisibilityState.PAUSED : VisibilityState.VISIBLE\n    );\n  }\n\n  /**\n   *\n   * @public\n   * @return {!Element}\n   */\n  getElement() {\n    return this.element_;\n  }\n\n  /**\n   * @return {!Array<!StoryDef>}\n   * @public\n   */\n  getStories() {\n    return this.stories_;\n  }\n\n  /** @public */\n  buildPlayer() {\n    if (!!this.element_.isBuilt_) {\n      return;\n    }\n\n    this.initializeAnchorElStories_();\n    this.initializeShadowRoot_();\n    this.buildStories_();\n    this.initializeButton_();\n    this.readPlayerConfig_();\n    this.maybeFetchMoreStories_(this.stories_.length - this.currentIdx_ - 1);\n    this.initializeAutoplay_();\n    this.initializeAttribution_();\n    this.initializePageScroll_();\n    this.initializeCircularWrapping_();\n    this.signalReady_();\n    this.element_.isBuilt_ = true;\n  }\n\n  /**\n   * Initializes stories declared inline as <a> elements.\n   * @private\n   */\n  initializeAnchorElStories_() {\n    const anchorEls = toArray(this.element_.querySelectorAll('a'));\n    anchorEls.forEach((element) => {\n      const posterImgEl = element.querySelector(\n        'img[data-amp-story-player-poster-img]'\n      );\n      const posterImgSrc = posterImgEl && posterImgEl.getAttribute('src');\n\n      const story = /** @type {!StoryDef} */ ({\n        href: element.href,\n        title: (element.textContent && element.textContent.trim()) || null,\n        posterImage:\n          element.getAttribute('data-poster-portrait-src') || posterImgSrc,\n      });\n\n      this.initializeAndAddStory_(story);\n    });\n  }\n\n  /** @private */\n  signalReady_() {\n    this.element_.dispatchEvent(\n      createCustomEvent(this.win_, 'ready', dict({}))\n    );\n    this.element_.isReady = true;\n  }\n\n  /** @private */\n  buildStories_() {\n    this.stories_.forEach((story) => {\n      this.buildIframeFor_(story);\n    });\n  }\n\n  /** @private */\n  initializeShadowRoot_() {\n    this.rootEl_ = this.doc_.createElement('div');\n    this.rootEl_.classList.add('i-amphtml-story-player-main-container');\n\n    const shadowContainer = this.doc_.createElement('div');\n\n    // For AMP version.\n    shadowContainer.classList.add(\n      'i-amphtml-fill-content',\n      'i-amphtml-story-player-shadow-root-intermediary'\n    );\n\n    this.element_.appendChild(shadowContainer);\n\n    const containerToUse =\n      getMode().test || !this.element_.attachShadow\n        ? shadowContainer\n        : shadowContainer.attachShadow({mode: 'open'});\n\n    // Inject default styles\n    const styleEl = this.doc_.createElement('style');\n    styleEl.textContent = cssText;\n    containerToUse.appendChild(styleEl);\n    containerToUse.insertBefore(this.rootEl_, containerToUse.firstElementChild);\n  }\n\n  /**\n   * Helper to create a button.\n   * TODO(#30031): delete this once new custom UI API is ready.\n   * @private\n   */\n  initializeButton_() {\n    const option = this.element_.getAttribute('exit-control');\n    if (!Object.values(DEPRECATED_BUTTON_TYPES).includes(option)) {\n      return;\n    }\n\n    const button = this.doc_.createElement('button');\n    this.rootEl_.appendChild(button);\n\n    button.classList.add(DEPRECATED_BUTTON_CLASSES[option]);\n    button.classList.add(DEPRECATED_BUTTON_CLASSES.BASE);\n\n    button.addEventListener('click', () => {\n      this.element_.dispatchEvent(\n        createCustomEvent(this.win_, DEPRECATED_EVENT_NAMES[option], dict({}))\n      );\n    });\n  }\n\n  /**\n   * Gets publisher configuration for the player\n   * @private\n   * @return {?ConfigDef}\n   */\n  readPlayerConfig_() {\n    if (this.playerConfig_) {\n      return this.playerConfig_;\n    }\n\n    const ampCache = this.element_.getAttribute('amp-cache');\n    if (ampCache && !SUPPORTED_CACHES.includes(ampCache)) {\n      console /*OK*/\n        .error(\n          `[${TAG}]`,\n          `Unsupported cache specified, use one of following: ${SUPPORTED_CACHES}`\n        );\n    }\n\n    const scriptTag = this.element_.querySelector('script');\n    if (!scriptTag) {\n      return null;\n    }\n\n    if (!isJsonScriptTag(scriptTag)) {\n      throw new Error('<script> child must have type=\"application/json\"');\n    }\n\n    try {\n      this.playerConfig_ = /** @type {!ConfigDef} */ (\n        parseJson(scriptTag.textContent)\n      );\n    } catch (reason) {\n      console /*OK*/\n        .error(`[${TAG}] `, reason);\n    }\n\n    return this.playerConfig_;\n  }\n\n  /**\n   * @param {!StoryDef} story\n   * @private\n   */\n  buildIframeFor_(story) {\n    const iframeEl = this.doc_.createElement('iframe');\n    if (story.posterImage) {\n      setStyle(iframeEl, 'backgroundImage', story.posterImage);\n    }\n    iframeEl.classList.add('story-player-iframe');\n    iframeEl.setAttribute('allow', 'autoplay');\n\n    applySandbox(iframeEl);\n    this.addSandboxFlags_(iframeEl);\n    this.initializeLoadingListeners_(iframeEl);\n\n    story.iframe = iframeEl;\n  }\n\n  /**\n   * @param {!Element} iframe\n   * @private\n   */\n  addSandboxFlags_(iframe) {\n    if (\n      !iframe.sandbox ||\n      !iframe.sandbox.supports ||\n      iframe.sandbox.length <= 0\n    ) {\n      return; // Can't feature detect support.\n    }\n\n    for (let i = 0; i < SANDBOX_MIN_LIST.length; i++) {\n      const flag = SANDBOX_MIN_LIST[i];\n\n      if (!iframe.sandbox.supports(flag)) {\n        throw new Error(`Iframe doesn't support: ${flag}`);\n      }\n\n      iframe.sandbox.add(flag);\n    }\n  }\n\n  /**\n   * Sets up messaging for a story inside an iframe.\n   * @param {!StoryDef} story\n   * @private\n   */\n  setUpMessagingForStory_(story) {\n    const {iframe} = story;\n\n    story.messagingPromise = new Promise((resolve) => {\n      this.initializeHandshake_(story, iframe).then(\n        (messaging) => {\n          messaging.setDefaultHandler(() => Promise.resolve());\n          messaging.registerHandler('touchstart', (event, data) => {\n            this.onTouchStart_(/** @type {!Event} */ (data));\n          });\n\n          messaging.registerHandler('touchmove', (event, data) => {\n            this.onTouchMove_(/** @type {!Event} */ (data));\n          });\n\n          messaging.registerHandler('touchend', (event, data) => {\n            this.onTouchEnd_(/** @type {!Event} */ (data));\n          });\n\n          messaging.registerHandler('selectDocument', (event, data) => {\n            this.onSelectDocument_(/** @type {!Object} */ (data));\n          });\n\n          messaging.sendRequest(\n            'onDocumentState',\n            dict({'state': STORY_MESSAGE_STATE_TYPE.PAGE_ATTACHMENT_STATE}),\n            false\n          );\n\n          messaging.sendRequest(\n            'onDocumentState',\n            dict({'state': STORY_MESSAGE_STATE_TYPE.CURRENT_PAGE_ID}),\n            false\n          );\n\n          messaging.sendRequest(\n            'onDocumentState',\n            dict({'state': STORY_MESSAGE_STATE_TYPE.MUTED_STATE})\n          );\n\n          messaging.registerHandler('documentStateUpdate', (event, data) => {\n            this.onDocumentStateUpdate_(\n              /** @type {!DocumentStateTypeDef} */ (data),\n              messaging\n            );\n          });\n\n          if (this.playerConfig_ && this.playerConfig_.controls) {\n            this.updateControlsStateForAllStories_(story.idx);\n\n            messaging.sendRequest(\n              'customDocumentUI',\n              dict({'controls': this.playerConfig_.controls}),\n              false\n            );\n          }\n\n          resolve(messaging);\n        },\n        (err) => {\n          console /*OK*/\n            .error(`[${TAG}]`, err);\n        }\n      );\n    });\n  }\n\n  /**\n   * Updates the controls config for a given story.\n   * @param {number} storyIdx\n   * @private\n   */\n  updateControlsStateForAllStories_(storyIdx) {\n    // Disables skip-to-next button when story is the last one in the player.\n    if (storyIdx === this.stories_.length - 1) {\n      const skipButtonIdx = findIndex(\n        this.playerConfig_.controls,\n        (control) =>\n          control.name === 'skip-next' || control.name === 'skip-to-next'\n      );\n\n      if (skipButtonIdx >= 0) {\n        this.playerConfig_.controls[skipButtonIdx].state = 'disabled';\n      }\n    }\n  }\n\n  /**\n   * @param {!StoryDef} story\n   * @param {!Element} iframeEl\n   * @return {!Promise<!Messaging>}\n   * @private\n   */\n  initializeHandshake_(story, iframeEl) {\n    return this.maybeGetCacheUrl_(story.href).then((url) =>\n      Messaging.waitForHandshakeFromDocument(\n        this.win_,\n        iframeEl.contentWindow,\n        this.getEncodedLocation_(url).origin,\n        /*opt_token*/ null,\n        urls.cdnProxyRegex\n      )\n    );\n  }\n\n  /**\n   * @param {!Element} iframeEl\n   * @private\n   */\n  initializeLoadingListeners_(iframeEl) {\n    this.rootEl_.classList.add(LoadStateClass.LOADING);\n\n    iframeEl.onload = () => {\n      this.rootEl_.classList.remove(LoadStateClass.LOADING);\n      this.rootEl_.classList.add(LoadStateClass.LOADED);\n      this.element_.classList.add(LoadStateClass.LOADED);\n    };\n    iframeEl.onerror = () => {\n      this.rootEl_.classList.remove(LoadStateClass.LOADING);\n      this.rootEl_.classList.add(LoadStateClass.ERROR);\n      this.element_.classList.add(LoadStateClass.ERROR);\n    };\n  }\n\n  /**\n   * @public\n   */\n  layoutPlayer() {\n    if (!!this.element_.isLaidOut_) {\n      return;\n    }\n\n    new AmpStoryPlayerViewportObserver(this.win_, this.element_, () =>\n      this.visibleDeferred_.resolve()\n    );\n\n    this.render_();\n\n    this.element_.isLaidOut_ = true;\n  }\n\n  /**\n   * Fetches more stories from the publisher's endpoint.\n   * @return {!Promise}\n   * @private\n   */\n  fetchStories_() {\n    let {endpoint} = this.playerConfig_.behavior;\n    if (!endpoint) {\n      this.isFetchingStoriesEnabled_ = false;\n      return Promise.resolve();\n    }\n\n    const init = {\n      method: 'GET',\n      headers: {\n        Accept: 'application/json',\n      },\n    };\n\n    endpoint = endpoint.replace(/\\${offset}/, this.stories_.length.toString());\n\n    return fetch(endpoint, init)\n      .then((response) => response.json())\n      .catch((reason) => {\n        console /*OK*/\n          .error(`[${TAG}]`, reason);\n      });\n  }\n\n  /**\n   * Resolves currentStoryLoadDeferred_ when given story's content is finished\n   * loading.\n   * @param {!StoryDef} story\n   * @private\n   */\n  initStoryContentLoadedPromise_(story) {\n    this.currentStoryLoadDeferred_ = new Deferred();\n\n    story.messagingPromise.then((messaging) =>\n      messaging.registerHandler('storyContentLoaded', () => {\n        // Stories that already loaded won't dispatch a `storyContentLoaded`\n        // event anymore, which is why we need this sync property.\n        story.storyContentLoaded = true;\n        this.currentStoryLoadDeferred_.resolve();\n      })\n    );\n  }\n\n  /**\n   * Shows the story provided by the URL in the player and go to the page if provided.\n   * @param {?string} storyUrl\n   * @param {string=} pageId\n   * @param {{animate: boolean?}} options\n   * @return {!Promise}\n   */\n  show(storyUrl, pageId = null, options = {}) {\n    const story = this.getStoryFromUrl_(storyUrl);\n\n    let renderPromise = Promise.resolve();\n    if (story.idx !== this.currentIdx_) {\n      this.currentIdx_ = story.idx;\n\n      renderPromise = this.render_();\n\n      if (options.animate === false) {\n        this.rootEl_.classList.toggle(CLASS_NO_NAVIGATION_TRANSITION, true);\n        listenOnce(story.iframe, 'transitionend', () => {\n          this.rootEl_.classList.remove(CLASS_NO_NAVIGATION_TRANSITION);\n        });\n      }\n      this.onNavigation_();\n    }\n\n    if (pageId != null) {\n      return renderPromise.then(() => this.goToPageId_(pageId));\n    }\n\n    return renderPromise;\n  }\n\n  /** Sends a message muting the current story. */\n  mute() {\n    const story = this.stories_[this.currentIdx_];\n    this.updateMutedState_(story, true);\n  }\n\n  /** Sends a message unmuting the current story. */\n  unmute() {\n    const story = this.stories_[this.currentIdx_];\n    this.updateMutedState_(story, false);\n  }\n\n  /**\n   * Sends a message asking for the current story's state and dispatches the appropriate event.\n   * @param {string} storyStateType\n   * @public\n   */\n  getStoryState(storyStateType) {\n    switch (storyStateType) {\n      case STORY_STATE_TYPE.PAGE_ATTACHMENT_STATE:\n        this.getPageAttachmentState_();\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * Indicates the player changed story.\n   * @param {!Object} data\n   * @private\n   */\n  signalNavigation_(data) {\n    const event = createCustomEvent(\n      this.win_,\n      'navigation',\n      /** @type {!JsonObject} */ (data)\n    );\n    this.element_.dispatchEvent(event);\n  }\n\n  /**\n   * Triggers when swithing from one story to another.\n   * @private\n   */\n  onNavigation_() {\n    const index = this.currentIdx_;\n    const remaining = this.stories_.length - this.currentIdx_ - 1;\n    const navigation = {\n      'index': index,\n      'remaining': remaining,\n    };\n\n    this.signalNavigation_(navigation);\n    this.maybeFetchMoreStories_(remaining);\n  }\n\n  /**\n   * Fetches more stories if appropiate.\n   * @param {number} remaining Number of stories remaining in the player.\n   * @private\n   */\n  maybeFetchMoreStories_(remaining) {\n    if (\n      this.playerConfig_ &&\n      this.playerConfig_.behavior &&\n      this.shouldFetchMoreStories_() &&\n      remaining <= FETCH_STORIES_THRESHOLD\n    ) {\n      this.fetchStories_()\n        .then((stories) => {\n          if (!stories) {\n            return;\n          }\n          this.add(stories);\n        })\n        .catch((reason) => {\n          console /*OK*/\n            .error(`[${TAG}]`, reason);\n        });\n    }\n  }\n\n  /**\n   * @param {!Object} behavior\n   * @return {boolean}\n   * @private\n   */\n  validateBehaviorDef_(behavior) {\n    return behavior && behavior.on && behavior.action;\n  }\n\n  /**\n   * Checks if fetching more stories is enabled and validates the configuration.\n   * @return {boolean}\n   * @private\n   */\n  shouldFetchMoreStories_() {\n    if (this.isFetchingStoriesEnabled_ !== null) {\n      return this.isFetchingStoriesEnabled_;\n    }\n\n    const {behavior} = this.playerConfig_;\n\n    const hasEndFetchBehavior = (behavior) =>\n      behavior.on === 'end' && behavior.action === 'fetch' && behavior.endpoint;\n\n    this.isFetchingStoriesEnabled_ =\n      this.validateBehaviorDef_(behavior) && hasEndFetchBehavior(behavior);\n\n    return this.isFetchingStoriesEnabled_;\n  }\n\n  /**\n   * Navigates to the next story in the player.\n   * @private\n   */\n  next_() {\n    if (\n      !this.isCircularWrappingEnabled_ &&\n      this.isIndexOutofBounds_(this.currentIdx_ + 1)\n    ) {\n      return;\n    }\n\n    if (\n      this.isCircularWrappingEnabled_ &&\n      this.isIndexOutofBounds_(this.currentIdx_ + 1)\n    ) {\n      this.go(1);\n      return;\n    }\n\n    this.currentIdx_++;\n    this.render_();\n\n    this.onNavigation_();\n  }\n\n  /**\n   * Navigates to the previous story in the player.\n   * @private\n   */\n  previous_() {\n    if (\n      !this.isCircularWrappingEnabled_ &&\n      this.isIndexOutofBounds_(this.currentIdx_ - 1)\n    ) {\n      return;\n    }\n\n    if (\n      this.isCircularWrappingEnabled_ &&\n      this.isIndexOutofBounds_(this.currentIdx_ - 1)\n    ) {\n      this.go(-1);\n      return;\n    }\n\n    this.currentIdx_--;\n    this.render_();\n\n    this.onNavigation_();\n  }\n\n  /**\n   * Navigates stories given a number.\n   * @param {number} storyDelta\n   * @param {number=} pageDelta\n   * @param {{animate: boolean?}} options\n   */\n  go(storyDelta, pageDelta = 0, options = {}) {\n    if (storyDelta === 0 && pageDelta === 0) {\n      return;\n    }\n\n    if (\n      !this.isCircularWrappingEnabled_ &&\n      this.isIndexOutofBounds_(this.currentIdx_ + storyDelta)\n    ) {\n      throw new Error('Out of Story range.');\n    }\n\n    const newStoryIdx = this.currentIdx_ + storyDelta;\n    const newStory =\n      storyDelta > 0\n        ? this.stories_[newStoryIdx % this.stories_.length]\n        : this.stories_[\n            ((newStoryIdx % this.stories_.length) + this.stories_.length) %\n              this.stories_.length\n          ];\n\n    let showPromise = Promise.resolve();\n    if (this.currentIdx_ !== newStory.idx) {\n      showPromise = this.show(newStory.href, /* pageId */ null, options);\n    }\n\n    showPromise.then(() => {\n      this.selectPage_(pageDelta);\n    });\n  }\n\n  /**\n   * Updates story position.\n   * @param {!StoryDef} story\n   * @return {!Promise}\n   * @private\n   */\n  updatePosition_(story) {\n    const position =\n      story.distance === 0\n        ? StoryPosition.CURRENT\n        : story.idx > this.currentIdx_\n        ? StoryPosition.NEXT\n        : StoryPosition.PREVIOUS;\n\n    requestAnimationFrame(() => {\n      const {iframe} = story;\n      resetStyles(iframe, ['transform', 'transition']);\n      iframe.setAttribute('i-amphtml-iframe-position', position);\n    });\n  }\n\n  /**\n   * Returns a promise that makes sure current story gets loaded first before\n   * others.\n   * @param {!StoryDef} story\n   * @return {!Promise}\n   * @private\n   */\n  currentStoryPromise_(story) {\n    if (this.stories_[this.currentIdx_].storyContentLoaded) {\n      return Promise.resolve();\n    }\n\n    if (story.distance !== 0) {\n      return this.currentStoryLoadDeferred_.promise;\n    }\n\n    if (this.currentStoryLoadDeferred_) {\n      // Cancel previous story load promise.\n      this.currentStoryLoadDeferred_.reject(\n        `[${LOG_TYPE.DEV}] Cancelling previous story load promise.`\n      );\n    }\n\n    this.initStoryContentLoadedPromise_(story);\n    return Promise.resolve();\n  }\n\n  /**\n   * - Updates distances of the stories.\n   * - Appends / removes from the DOM depending on distances.\n   * - Sets visibility state.\n   * - Loads story N+1 when N is ready.\n   * - Positions iframes depending on distance.\n   * @param {number=} startingIdx\n   * @return {!Promise}\n   * @private\n   */\n  render_(startingIdx = this.currentIdx_) {\n    const renderPromises = [];\n\n    for (let i = 0; i < this.stories_.length; i++) {\n      const story = this.stories_[(i + startingIdx) % this.stories_.length];\n\n      const oldDistance = story.distance;\n      story.distance = Math.abs(this.currentIdx_ - story.idx);\n\n      // 1. Determine whether iframe should be in DOM tree or not.\n      if (oldDistance <= 1 && story.distance > 1) {\n        this.removeFromDom_(story);\n      }\n\n      if (story.distance <= 1 && !story.iframe.isConnected) {\n        this.appendToDom_(story);\n      }\n\n      // Only create renderPromises for neighbor stories.\n      if (story.distance > 1) {\n        continue;\n      }\n\n      renderPromises.push(\n        // 1. Wait for current story to load before evaluating neighbor stories.\n        this.currentStoryPromise_(story)\n          .then(() => this.maybeGetCacheUrl_(story.href))\n          // 2. Set iframe src when appropiate\n          .then((storyUrl) => {\n            if (!this.sanitizedUrlsAreEquals_(storyUrl, story.iframe.src)) {\n              this.setSrc_(story, storyUrl);\n            }\n          })\n          // 3. Waits for player to be visible before updating visibility\n          // state.\n          .then(() => this.visibleDeferred_.promise)\n          // 4. Update the visibility state of the story.\n          .then(() => {\n            if (story.distance === 0 && this.playing_) {\n              this.updateVisibilityState_(story, VisibilityState.VISIBLE);\n            }\n\n            if (oldDistance === 0 && story.distance === 1) {\n              this.updateVisibilityState_(story, VisibilityState.INACTIVE);\n            }\n          })\n          // 5. Finally update the story position.\n          .then(() => {\n            this.updatePosition_(story);\n\n            if (story.distance === 0) {\n              tryFocus(story.iframe);\n            }\n          })\n          .catch((err) => {\n            if (err.includes(LOG_TYPE.DEV)) {\n              return;\n            }\n            console /*OK*/\n              .error(`[${TAG}]`, err);\n          })\n      );\n    }\n\n    return Promise.all(renderPromises);\n  }\n\n  /**\n   * @param {!StoryDef} story\n   * @private\n   */\n  appendToDom_(story) {\n    this.rootEl_.appendChild(story.iframe);\n    this.setUpMessagingForStory_(story);\n    story.connectedDeferred.resolve();\n  }\n\n  /**\n   * @param {!StoryDef} story\n   * @private\n   */\n  removeFromDom_(story) {\n    story.storyContentLoaded = false;\n    story.connectedDeferred = new Deferred();\n    story.iframe.setAttribute('src', '');\n    story.iframe.remove();\n  }\n\n  /**\n   * Sets the story src to the iframe.\n   * @param {!StoryDef} story\n   * @param {string} url\n   * @return {!Promise}\n   * @private\n   */\n  setSrc_(story, url) {\n    const {iframe} = story;\n    const {href} = this.getEncodedLocation_(url, VisibilityState.PRERENDER);\n\n    iframe.setAttribute('src', href);\n    if (story.title) {\n      iframe.setAttribute('title', story.title);\n    }\n  }\n\n  /**\n   * Compares href from the story with the href in the iframe.\n   * @param {string} storyHref\n   * @param {string} iframeHref\n   * @return {boolean}\n   * @private\n   */\n  sanitizedUrlsAreEquals_(storyHref, iframeHref) {\n    if (iframeHref.length <= 0) {\n      return false;\n    }\n\n    const sanitizedIframeHref = removeFragment(removeSearch(iframeHref));\n    const sanitizedStoryHref = removeFragment(removeSearch(storyHref));\n\n    return sanitizedIframeHref === sanitizedStoryHref;\n  }\n\n  /**\n   * Gets cache url, unless amp-cache is not defined.\n   * @param {string} url\n   * @return {!Promise<string>}\n   * @private\n   */\n  maybeGetCacheUrl_(url) {\n    const ampCache = this.element_.getAttribute('amp-cache');\n\n    if (\n      !ampCache ||\n      isProxyOrigin(url) ||\n      !SUPPORTED_CACHES.includes(ampCache)\n    ) {\n      return Promise.resolve(url);\n    }\n\n    return ampToolboxCacheUrl\n      .createCacheUrl(ampCache, url, 'viewer' /** servingType */)\n      .then((cacheUrl) => {\n        return cacheUrl;\n      });\n  }\n\n  /**\n   * Gets encoded url for player usage.\n   * @param {string} href\n   * @param {VisibilityState=} visibilityState\n   * @return {!Location}\n   * @private\n   */\n  getEncodedLocation_(href, visibilityState = VisibilityState.INACTIVE) {\n    const playerFragmentParams = {\n      'visibilityState': visibilityState,\n      'origin': this.win_.origin,\n      'showStoryUrlInfo': '0',\n      'storyPlayer': 'v0',\n      'cap': 'swipe',\n    };\n\n    if (this.attribution_ === 'auto') {\n      playerFragmentParams['attribution'] = 'auto';\n    }\n\n    const originalFragmentString = getFragment(href);\n    const originalFragments = parseQueryString(originalFragmentString);\n\n    const fragmentParams = /** @type {!JsonObject} */ ({\n      ...originalFragments,\n      ...playerFragmentParams,\n    });\n\n    let noFragmentUrl = removeFragment(href);\n    if (isProxyOrigin(href)) {\n      const ampJsQueryParam = dict({\n        'amp_js_v': '0.1',\n      });\n      noFragmentUrl = addParamsToUrl(noFragmentUrl, ampJsQueryParam);\n    }\n    const inputUrl = noFragmentUrl + '#' + serializeQueryString(fragmentParams);\n\n    return parseUrlWithA(\n      /** @type {!HTMLAnchorElement} */ (this.cachedA_),\n      inputUrl\n    );\n  }\n\n  /**\n   * Updates the visibility state of the story inside the iframe.\n   * @param {!StoryDef} story\n   * @param {!VisibilityState} visibilityState\n   * @private\n   */\n  updateVisibilityState_(story, visibilityState) {\n    story.messagingPromise.then((messaging) =>\n      messaging.sendRequest('visibilitychange', {state: visibilityState}, true)\n    );\n  }\n\n  /**\n   * Updates the specified iframe's story state with given value.\n   * @param {!StoryDef} story\n   * @param {string} state\n   * @param {boolean} value\n   * @private\n   */\n  updateStoryState_(story, state, value) {\n    story.messagingPromise.then((messaging) => {\n      messaging.sendRequest('setDocumentState', {state, value});\n    });\n  }\n\n  /**\n   * Update the muted state of the story inside the iframe.\n   * @param {!StoryDef} story\n   * @param {boolean} mutedValue\n   * @private\n   */\n  updateMutedState_(story, mutedValue) {\n    this.updateStoryState_(\n      story,\n      STORY_MESSAGE_STATE_TYPE.MUTED_STATE,\n      mutedValue\n    );\n  }\n\n  /**\n   * Send message to story asking for page attachment state.\n   * @private\n   */\n  getPageAttachmentState_() {\n    const story = this.stories_[this.currentIdx_];\n\n    story.messagingPromise.then((messaging) => {\n      messaging\n        .sendRequest(\n          'getDocumentState',\n          {state: STORY_MESSAGE_STATE_TYPE.PAGE_ATTACHMENT_STATE},\n          true\n        )\n        .then((event) => this.dispatchPageAttachmentEvent_(event.value));\n    });\n  }\n\n  /**\n   * @param {string} pageId\n   * @private\n   */\n  goToPageId_(pageId) {\n    const story = this.stories_[this.currentIdx_];\n\n    story.messagingPromise.then((messaging) =>\n      messaging.sendRequest('selectPage', {'id': pageId})\n    );\n  }\n\n  /**\n   * Returns the story given a URL.\n   * @param {string} storyUrl\n   * @return {!StoryDef}\n   * @private\n   */\n  getStoryFromUrl_(storyUrl) {\n    // TODO(enriqe): sanitize URLs for matching.\n    const storyIdx = storyUrl\n      ? findIndex(this.stories_, ({href}) => href === storyUrl)\n      : this.currentIdx_;\n\n    if (!this.stories_[storyIdx]) {\n      throw new Error(`Story URL not found in the player: ${storyUrl}`);\n    }\n\n    return this.stories_[storyIdx];\n  }\n\n  /**\n   * Rewinds the given story.\n   * @param {string} storyUrl\n   */\n  rewind(storyUrl) {\n    const story = this.getStoryFromUrl_(storyUrl);\n\n    this.whenConnected_(story)\n      .then(() => story.messagingPromise)\n      .then((messaging) => messaging.sendRequest('rewind', {}));\n  }\n\n  /**\n   * Returns a promise that resolves when the story is connected to the DOM.\n   * @param {!StoryDef} story\n   * @return {!Promise}\n   * @private\n   */\n  whenConnected_(story) {\n    if (story.iframe.isConnected) {\n      return Promise.resolve();\n    }\n    return story.connectedDeferred.promise;\n  }\n\n  /**\n   * Sends a message to the current story to navigate delta pages.\n   * @param {number} delta\n   * @private\n   */\n  selectPage_(delta) {\n    if (delta === 0) {\n      return;\n    }\n\n    this.sendSelectPageDelta_(delta);\n  }\n\n  /**\n   * @param {number} delta\n   * @private\n   */\n  sendSelectPageDelta_(delta) {\n    const story = this.stories_[this.currentIdx_];\n\n    story.messagingPromise.then((messaging) =>\n      messaging.sendRequest('selectPage', {delta})\n    );\n  }\n\n  /**\n   * React to documentStateUpdate events.\n   * @param {!DocumentStateTypeDef} data\n   * @param {Messaging} messaging\n   * @private\n   */\n  onDocumentStateUpdate_(data, messaging) {\n    switch (data.state) {\n      case STORY_MESSAGE_STATE_TYPE.PAGE_ATTACHMENT_STATE:\n        this.onPageAttachmentStateUpdate_(/** @type {boolean} */ (data.value));\n        break;\n      case STORY_MESSAGE_STATE_TYPE.CURRENT_PAGE_ID:\n        this.onCurrentPageIdUpdate_(\n          /** @type {string} */ (data.value),\n          messaging\n        );\n        break;\n      case STORY_MESSAGE_STATE_TYPE.MUTED_STATE:\n        this.onMutedStateUpdate_(/** @type {string} */ (data.value));\n        break;\n      case AMP_STORY_PLAYER_EVENT:\n        this.onPlayerEvent_(/** @type {string} */ (data.value));\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * Reacts to events coming from the story.\n   * @private\n   * @param {string} value\n   */\n  onPlayerEvent_(value) {\n    switch (value) {\n      case 'amp-story-player-skip-next':\n      case 'amp-story-player-skip-to-next':\n        this.next_();\n        break;\n      default:\n        this.element_.dispatchEvent(\n          createCustomEvent(this.win_, value, dict({}))\n        );\n        break;\n    }\n  }\n\n  /**\n   * Reacts to mute/unmute events coming from the story.\n   * @param {string} muted\n   * @private\n   */\n  onMutedStateUpdate_(muted) {\n    this.element_.dispatchEvent(\n      createCustomEvent(this.win_, 'amp-story-muted-state', {muted})\n    );\n  }\n\n  /**\n   * Reacts to page id update events inside the story.\n   * @param {string} pageId\n   * @param {Messaging} messaging\n   * @private\n   */\n  onCurrentPageIdUpdate_(pageId, messaging) {\n    messaging\n      .sendRequest(\n        'getDocumentState',\n        dict({'state': STORY_MESSAGE_STATE_TYPE.STORY_PROGRESS}),\n        true\n      )\n      .then((progress) => {\n        this.element_.dispatchEvent(\n          createCustomEvent(\n            this.win_,\n            'storyNavigation',\n            dict({\n              'pageId': pageId,\n              'progress': progress.value,\n            })\n          )\n        );\n      });\n  }\n\n  /**\n   * React to page attachment update events.\n   * @param {boolean} pageAttachmentOpen\n   * @private\n   */\n  onPageAttachmentStateUpdate_(pageAttachmentOpen) {\n    this.updateButtonVisibility_(!pageAttachmentOpen);\n    this.dispatchPageAttachmentEvent_(pageAttachmentOpen);\n  }\n\n  /**\n   * Updates the visbility state of the exit control button.\n   * TODO(#30031): delete this once new custom UI API is ready.\n   * @param {boolean} isVisible\n   * @private\n   */\n  updateButtonVisibility_(isVisible) {\n    const button = this.rootEl_.querySelector(\n      'button.amp-story-player-exit-control-button'\n    );\n    if (!button) {\n      return;\n    }\n\n    isVisible\n      ? button.classList.remove(DEPRECATED_BUTTON_CLASSES.HIDDEN)\n      : button.classList.add(DEPRECATED_BUTTON_CLASSES.HIDDEN);\n  }\n\n  /**\n   * Dispatch a page attachment event.\n   * @param {boolean} isPageAttachmentOpen\n   * @private\n   */\n  dispatchPageAttachmentEvent_(isPageAttachmentOpen) {\n    this.element_.dispatchEvent(\n      createCustomEvent(\n        this.win_,\n        isPageAttachmentOpen ? 'page-attachment-open' : 'page-attachment-close',\n        dict({})\n      )\n    );\n  }\n\n  /**\n   * React to selectDocument events.\n   * @param {!Object} data\n   * @private\n   */\n  onSelectDocument_(data) {\n    this.dispatchEndOfStoriesEvent_(data);\n    if (data.next) {\n      this.next_();\n    } else if (data.previous) {\n      this.previous_();\n    }\n  }\n\n  /**\n   * Dispatches end of stories event when appropiate.\n   * @param {!Object} data\n   * @private\n   */\n  dispatchEndOfStoriesEvent_(data) {\n    if (this.isCircularWrappingEnabled_ || (!data.next && !data.previous)) {\n      return;\n    }\n\n    let endOfStories, name;\n    if (data.next) {\n      endOfStories = this.currentIdx_ + 1 === this.stories_.length;\n      name = 'noNextStory';\n    } else {\n      endOfStories = this.currentIdx_ === 0;\n      name = 'noPreviousStory';\n    }\n\n    if (endOfStories) {\n      this.element_.dispatchEvent(createCustomEvent(this.win_, name, dict({})));\n    }\n  }\n\n  /**\n   * Reacts to touchstart events and caches its coordinates.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchStart_(event) {\n    const coordinates = this.getClientTouchCoordinates_(event);\n    if (!coordinates) {\n      return;\n    }\n\n    this.touchEventState_.startX = coordinates.screenX;\n    this.touchEventState_.startY = coordinates.screenY;\n\n    this.pageScroller_ &&\n      this.pageScroller_.onTouchStart(event.timeStamp, coordinates.clientY);\n\n    this.element_.dispatchEvent(\n      createCustomEvent(\n        this.win_,\n        'amp-story-player-touchstart',\n        dict({\n          'touches': event.touches,\n        })\n      )\n    );\n  }\n\n  /**\n   * Reacts to touchmove events.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchMove_(event) {\n    const coordinates = this.getClientTouchCoordinates_(event);\n    if (!coordinates) {\n      return;\n    }\n\n    this.element_.dispatchEvent(\n      createCustomEvent(\n        this.win_,\n        'amp-story-player-touchmove',\n        dict({\n          'touches': event.touches,\n          'isNavigationalSwipe': this.touchEventState_.isSwipeX,\n        })\n      )\n    );\n\n    if (this.touchEventState_.isSwipeX === false) {\n      this.pageScroller_ &&\n        this.pageScroller_.onTouchMove(event.timeStamp, coordinates.clientY);\n      return;\n    }\n\n    const {screenX, screenY} = coordinates;\n    this.touchEventState_.lastX = screenX;\n\n    if (this.touchEventState_.isSwipeX === null) {\n      this.touchEventState_.isSwipeX =\n        Math.abs(this.touchEventState_.startX - screenX) >\n        Math.abs(this.touchEventState_.startY - screenY);\n      if (!this.touchEventState_.isSwipeX) {\n        return;\n      }\n    }\n\n    this.onSwipeX_({\n      deltaX: screenX - this.touchEventState_.startX,\n      last: false,\n    });\n  }\n\n  /**\n   * Reacts to touchend events. Resets cached touch event states.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchEnd_(event) {\n    this.element_.dispatchEvent(\n      createCustomEvent(\n        this.win_,\n        'amp-story-player-touchend',\n        dict({\n          'touches': event.touches,\n          'isNavigationalSwipe': this.touchEventState_.isSwipeX,\n        })\n      )\n    );\n\n    if (this.touchEventState_.isSwipeX === true) {\n      this.onSwipeX_({\n        deltaX: this.touchEventState_.lastX - this.touchEventState_.startX,\n        last: true,\n      });\n    } else {\n      this.pageScroller_ && this.pageScroller_.onTouchEnd(event.timeStamp);\n    }\n\n    this.touchEventState_.startX = 0;\n    this.touchEventState_.startY = 0;\n    this.touchEventState_.lastX = 0;\n    this.touchEventState_.isSwipeX = null;\n    this.swipingState_ = SwipingState.NOT_SWIPING;\n  }\n\n  /**\n   * Reacts to horizontal swipe events.\n   * @param {!Object} gesture\n   */\n  onSwipeX_(gesture) {\n    if (this.stories_.length <= 1) {\n      return;\n    }\n\n    const {deltaX} = gesture;\n\n    if (gesture.last === true) {\n      const delta = Math.abs(deltaX);\n\n      if (this.swipingState_ === SwipingState.SWIPING_TO_LEFT) {\n        delta > TOGGLE_THRESHOLD_PX &&\n        (this.getSecondaryStory_() || this.isCircularWrappingEnabled_)\n          ? this.next_()\n          : this.resetStoryStyles_();\n      }\n\n      if (this.swipingState_ === SwipingState.SWIPING_TO_RIGHT) {\n        delta > TOGGLE_THRESHOLD_PX &&\n        (this.getSecondaryStory_() || this.isCircularWrappingEnabled_)\n          ? this.previous_()\n          : this.resetStoryStyles_();\n      }\n\n      return;\n    }\n\n    this.drag_(deltaX);\n  }\n\n  /**\n   * Resets styles for the currently swiped story.\n   * @private\n   */\n  resetStoryStyles_() {\n    const currentIframe = this.stories_[this.currentIdx_].iframe;\n\n    requestAnimationFrame(() => {\n      resetStyles(devAssertElement(currentIframe), ['transform', 'transition']);\n    });\n\n    const secondaryStory = this.getSecondaryStory_();\n    if (secondaryStory) {\n      requestAnimationFrame(() => {\n        resetStyles(devAssertElement(secondaryStory.iframe), [\n          'transform',\n          'transition',\n        ]);\n      });\n    }\n  }\n\n  /**\n   * Gets accompanying story for the currently swiped story if any.\n   * @private\n   * @return {?StoryDef}\n   */\n  getSecondaryStory_() {\n    const nextStoryIdx =\n      this.swipingState_ === SwipingState.SWIPING_TO_LEFT\n        ? this.currentIdx_ + 1\n        : this.currentIdx_ - 1;\n\n    if (this.isIndexOutofBounds_(nextStoryIdx)) {\n      return null;\n    }\n\n    return this.stories_[nextStoryIdx];\n  }\n\n  /**\n   * Checks if index is out of bounds.\n   * @private\n   * @param {number} index\n   * @return {boolean}\n   */\n  isIndexOutofBounds_(index) {\n    return index >= this.stories_.length || index < 0;\n  }\n\n  /** @private */\n  initializeAutoplay_() {\n    if (!this.playerConfig_) {\n      return;\n    }\n\n    const {behavior} = this.playerConfig_;\n\n    if (behavior && typeof behavior.autoplay === 'boolean') {\n      this.playing_ = behavior.autoplay;\n    }\n  }\n\n  /** @private */\n  initializeAttribution_() {\n    if (!this.playerConfig_) {\n      return;\n    }\n\n    const {display} = this.playerConfig_;\n\n    if (display && display.attribution === 'auto') {\n      this.attribution_ = 'auto';\n    }\n  }\n\n  /** @private */\n  initializePageScroll_() {\n    if (!this.playerConfig_) {\n      return;\n    }\n\n    const {behavior} = this.playerConfig_;\n\n    if (behavior && behavior.pageScroll === false) {\n      this.pageScroller_ = null;\n    }\n  }\n\n  /**\n   * @private\n   * @return {boolean}\n   */\n  initializeCircularWrapping_() {\n    if (this.isCircularWrappingEnabled_ !== null) {\n      return this.isCircularWrappingEnabled_;\n    }\n\n    if (!this.playerConfig_) {\n      this.isCircularWrappingEnabled_ = false;\n      return false;\n    }\n\n    const {behavior} = this.playerConfig_;\n\n    const hasCircularWrappingEnabled = (behavior) =>\n      behavior.on === 'end' && behavior.action === 'circular-wrapping';\n\n    this.isCircularWrappingEnabled_ =\n      this.validateBehaviorDef_(behavior) &&\n      hasCircularWrappingEnabled(behavior);\n\n    return this.isCircularWrappingEnabled_;\n  }\n\n  /**\n   * Drags stories following the swiping gesture.\n   * @param {number} deltaX\n   * @private\n   */\n  drag_(deltaX) {\n    let secondaryTranslate;\n\n    if (deltaX < 0) {\n      this.swipingState_ = SwipingState.SWIPING_TO_LEFT;\n      secondaryTranslate = `translate3d(calc(100% + ${deltaX}px), 0, 0)`;\n    } else {\n      this.swipingState_ = SwipingState.SWIPING_TO_RIGHT;\n      secondaryTranslate = `translate3d(calc(${deltaX}px - 100%), 0, 0)`;\n    }\n\n    const story = this.stories_[this.currentIdx_];\n    const {iframe} = story;\n    const translate = `translate3d(${deltaX}px, 0, 0)`;\n\n    requestAnimationFrame(() => {\n      setStyles(devAssertElement(iframe), {\n        transform: translate,\n        transition: 'none',\n      });\n    });\n\n    const secondaryStory = this.getSecondaryStory_();\n    if (!secondaryStory) {\n      return;\n    }\n\n    requestAnimationFrame(() => {\n      setStyles(devAssertElement(secondaryStory.iframe), {\n        transform: secondaryTranslate,\n        transition: 'none',\n      });\n    });\n  }\n\n  /**\n   * Helper to retrieve the touch coordinates from a TouchEvent.\n   * @param {!Event} event\n   * @return {?{x: number, y: number}}\n   * @private\n   */\n  getClientTouchCoordinates_(event) {\n    const {touches} = event;\n    if (!touches || touches.length < 1) {\n      return null;\n    }\n\n    const {clientX, clientY, screenX, screenY} = touches[0];\n    return {screenX, screenY, clientX, clientY};\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @fileoverview Helpers to wrap functions. */\n\n/**\n * Creates a function that is evaluated only once and returns the cached result\n * subsequently.\n *\n * Please note that `once` only takes the function definition into account,\n * so it will return the same cached value even when the arguments are\n * different.\n *\n * @param {function(...):T} fn\n * @return {function(...):T}\n * @template T\n */\nexport function once(fn) {\n  let evaluated = false;\n  let retValue = null;\n  let callback = fn;\n  return (...args) => {\n    if (!evaluated) {\n      retValue = callback.apply(self, args);\n      evaluated = true;\n      callback = null; // GC\n    }\n    return retValue;\n  };\n}\n\n/**\n * Wraps a given callback and applies a rate limit.\n * It throttles the calls so that no consequent calls have time interval\n * smaller than the given minimal interval.\n *\n * @param {!Window} win\n * @param {function(...T):R} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...T)}\n * @template T\n * @template R\n */\nexport function throttle(win, callback, minInterval) {\n  let locker = 0;\n  let nextCallArgs = null;\n\n  /**\n   * @param {!Object} args\n   */\n  function fire(args) {\n    nextCallArgs = null;\n    // Lock the fire for minInterval milliseconds\n    locker = win.setTimeout(waiter, minInterval);\n\n    callback.apply(null, args);\n  }\n\n  /**\n   * Waiter function\n   */\n  function waiter() {\n    locker = 0;\n    // If during the period there're invocations queued up, fire once.\n    if (nextCallArgs) {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function (...args) {\n    if (locker) {\n      nextCallArgs = args;\n    } else {\n      fire(args);\n    }\n  };\n}\n\n/**\n * Wraps a given callback and applies a wait timer, so that minInterval\n * milliseconds must pass since the last call before the callback is actually\n * invoked.\n *\n * @param {!Window} win\n * @param {function(...T):R} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...T)}\n * @template T\n * @template R\n */\nexport function debounce(win, callback, minInterval) {\n  let locker = 0;\n  let timestamp = 0;\n  let nextCallArgs = null;\n\n  /**\n   * @param {?Array} args\n   */\n  function fire(args) {\n    nextCallArgs = null;\n    callback.apply(null, args);\n  }\n\n  /**\n   * Wait function for debounce\n   */\n  function waiter() {\n    locker = 0;\n    const remaining = minInterval - (win.Date.now() - timestamp);\n    if (remaining > 0) {\n      locker = win.setTimeout(waiter, remaining);\n    } else {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function (...args) {\n    timestamp = win.Date.now();\n    nextCallArgs = args;\n    if (!locker) {\n      locker = win.setTimeout(waiter, minInterval);\n    }\n  };\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {throttle} from '../core/types/function';\n\n/** @const {number} */\nconst SCROLL_THROTTLE_MS = 500;\n\n/**\n * Creates an IntersectionObserver or fallback using scroll events.\n * Fires viewportCb when criteria is met and unobserves immediately after.\n */\nexport class AmpStoryPlayerViewportObserver {\n  /**\n   * @param {!Window} win\n   * @param {!Element} element\n   * @param {function():void} viewportCb\n   */\n  constructor(win, element, viewportCb) {\n    /** @private {!Window} */\n    this.win_ = win;\n\n    /** @private {!Element} */\n    this.element_ = element;\n\n    /** @private {function():void} */\n    this.cb_ = viewportCb;\n\n    /** @private {?function():void} */\n    this.scrollHandler_ = null;\n\n    this.initializeInObOrFallback_();\n  }\n\n  /** @private */\n  initializeInObOrFallback_() {\n    if (!this.win_.IntersectionObserver || this.win_ !== this.win_.parent) {\n      this.createInObFallback_();\n      return;\n    }\n\n    this.createInOb_();\n  }\n\n  /**\n   * Creates an IntersectionObserver.\n   * @private\n   */\n  createInOb_() {\n    const inObCallback = (entries) => {\n      entries.forEach((entry) => {\n        if (!entry.isIntersecting) {\n          return;\n        }\n        this.cb_();\n        observer.unobserve(this.element_);\n      });\n    };\n\n    const observer = new this.win_.IntersectionObserver(inObCallback);\n\n    observer.observe(this.element_);\n  }\n\n  /**\n   * Fallback for when IntersectionObserver is not supported. Calls\n   * layoutPlayer on the element when it is close to the viewport.\n   * @private\n   */\n  createInObFallback_() {\n    this.scrollHandler_ = throttle(\n      this.win_,\n      this.checkIfVisibleFallback_.bind(this),\n      SCROLL_THROTTLE_MS\n    );\n\n    this.win_.addEventListener('scroll', this.scrollHandler_);\n\n    this.checkIfVisibleFallback_(this.element_);\n  }\n\n  /**\n   * Checks if element is close to the viewport and calls the callback when it\n   * is.\n   * @private\n   */\n  checkIfVisibleFallback_() {\n    const elTop = this.element_./*OK*/ getBoundingClientRect().top;\n    const winInnerHeight = this.win_./*OK*/ innerHeight;\n\n    if (winInnerHeight > elTop) {\n      this.cb_();\n      this.win_.removeEventListener('scroll', this.scrollHandler_);\n    }\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst TAG = 'amp-viewer-messaging';\nconst CHANNEL_OPEN_MSG = 'channelOpen';\nconst HANDSHAKE_POLL_MSG = 'handshake-poll';\nconst APP = '__AMPHTML__';\n\n/**\n * @enum {string}\n */\nconst MessageType = {\n  REQUEST: 'q',\n  RESPONSE: 's',\n};\n\n/**\n * @typedef {function(string, *, boolean):(!Promise<*>|undefined)}\n */\nlet RequestHandler; // eslint-disable-line no-unused-vars\n\n/**\n * @param {*} message\n * @return {?AmpViewerMessage}\n */\nexport function parseMessage(message) {\n  if (typeof message != 'string') {\n    return /** @type {AmpViewerMessage} */ (message);\n  }\n  if (message.charAt(0) != '{') {\n    return null;\n  }\n\n  try {\n    return /** @type {?AmpViewerMessage} */ (JSON.parse(\n      /** @type {string} */ (message)\n    ));\n  } catch (e) {\n    return null;\n  }\n}\n\n/**\n * @fileoverview This class is a de-facto implementation of MessagePort\n * from Channel Messaging API:\n * https://developer.mozilla.org/en-US/docs/Web/API/Channel_Messaging_API\n */\nexport class WindowPortEmulator {\n  /**\n   * @param {!Window} win\n   * @param {string} origin\n   * @param {!Window} target\n   */\n  constructor(win, origin, target) {\n    /** @const @private {!Window} */\n    this.win_ = win;\n    /** @const @private {string} */\n    this.origin_ = origin;\n    /** @const @private {!Window} */\n    this.target_ = target;\n  }\n\n  /**\n   * @param {string} eventType\n   * @param {function(!Event):*} handler\n   */\n  addEventListener(eventType, handler) {\n    this.win_.addEventListener('message', (event) => {\n      if (event.origin == this.origin_ && event.source == this.target_) {\n        handler(event);\n      }\n    });\n  }\n\n  /**\n   * @param {JsonObject} data\n   */\n  postMessage(data) {\n    // Opaque (null) origin can only receive messages sent to \"*\"\n    const targetOrigin = this.origin_ === 'null' ? '*' : this.origin_;\n\n    this.target_./*OK*/ postMessage(data, targetOrigin);\n  }\n\n  /**\n   * Starts the sending of messages queued on the port.\n   */\n  start() {}\n}\n\n/**\n * @fileoverview This is used in amp-viewer-integration.js for the\n * communication protocol between AMP and the viewer. In the comments, I will\n * refer to the communication as a conversation between me and Bob. The\n * messaging protocol should support both sides, but at this point I'm the\n * ampdoc and Bob is the viewer.\n */\nexport class Messaging {\n  /**\n   * Performs a handshake and initializes messaging.\n   *\n   * Requires the `handshakepoll` viewer capability and the `origin` viewer parameter to be specified.\n   * @param {!Window} target - window containing AMP document to perform handshake with\n   * @param {?string=} opt_token - message token to verify on incoming messages (must be provided as viewer parameter)\n   * @return {!Promise<!Messaging>}\n   */\n  static initiateHandshakeWithDocument(target, opt_token) {\n    return new Promise((resolve) => {\n      const intervalRef = setInterval(() => {\n        const channel = new MessageChannel();\n        const pollMessage = /** @type {JsonObject} */ ({\n          app: APP,\n          name: HANDSHAKE_POLL_MSG,\n        });\n        target./*OK*/ postMessage(pollMessage, '*', [channel.port2]);\n\n        const port = channel.port1;\n        const listener = (event) => {\n          const message = parseMessage(event.data);\n          if (!message) {\n            return;\n          }\n          if (message.app === APP && message.name === CHANNEL_OPEN_MSG) {\n            clearInterval(intervalRef);\n            port.removeEventListener('message', listener);\n            const messaging = new Messaging(\n              null,\n              port,\n              /* opt_isWebview */ false,\n              opt_token,\n              /* opt_verifyToken */ true\n            );\n            messaging.sendResponse_(message.requestid, CHANNEL_OPEN_MSG, null);\n            resolve(messaging);\n          }\n        };\n        port.addEventListener('message', listener);\n        port.start();\n      }, 1000);\n    });\n  }\n\n  /**\n   * Waits for handshake from iframe and initializes messaging.\n   *\n   * Requires the `origin` viewer parameter to be specified.\n   * @param {!Window} source - the source window containing the viewer\n   * @param {!Window} target - window containing AMP document to perform handshake with (usually contentWindow of iframe)\n   * @param {string} origin - origin of target window (use \"null\" if opaque)\n   * @param {?string=} opt_token - message token to verify on incoming messages (must be provided as viewer parameter)\n   * @param {?RegExp=} opt_cdnProxyRegex\n   * @return {!Promise<!Messaging>}\n   */\n  static waitForHandshakeFromDocument(\n    source,\n    target,\n    origin,\n    opt_token,\n    opt_cdnProxyRegex\n  ) {\n    return new Promise((resolve) => {\n      const listener = (event) => {\n        const message = parseMessage(event.data);\n        if (!message) {\n          return;\n        }\n        if (\n          (event.origin == origin ||\n            (opt_cdnProxyRegex && opt_cdnProxyRegex.test(event.origin))) &&\n          (!event.source || event.source == target) &&\n          message.app === APP &&\n          message.name === CHANNEL_OPEN_MSG\n        ) {\n          source.removeEventListener('message', listener);\n          const port = new WindowPortEmulator(source, event.origin, target);\n          const messaging = new Messaging(\n            null,\n            port,\n            /* opt_isWebview */ false,\n            opt_token,\n            /* opt_verifyToken */ true\n          );\n          messaging.sendResponse_(message.requestid, CHANNEL_OPEN_MSG, null);\n          resolve(messaging);\n        }\n      };\n      source.addEventListener('message', listener);\n    });\n  }\n\n  /**\n   * Conversation (messaging protocol) between me and Bob.\n   * @param {?Window} win\n   * @param {!MessagePort|!WindowPortEmulator} port\n   * @param {boolean=} opt_isWebview\n   * @param {?string=} opt_token\n   * @param {boolean=} opt_verifyToken\n   */\n  constructor(win, port, opt_isWebview, opt_token, opt_verifyToken) {\n    /** @const @private {?Window} */\n    this.win_ = win;\n    /** @const @private {!MessagePort|!WindowPortEmulator} */\n    this.port_ = port;\n    /** @const @private {boolean} */\n    this.isWebview_ = !!opt_isWebview;\n\n    /**\n     * A token that the viewer may include as an init parameter to enhance\n     * security for communication to opaque origin (a.k.a. null origin) AMP\n     * documents.\n     *\n     * For an AMP document embedded inside a sandbox iframe, the origin of the\n     * document would be \"null\", which defeats the purpose of an origin check.\n     * An attacker could simply create a sandboxed, malicious iframe (therefore\n     * having null origin), walk on the DOM frame tree to find a reference to\n     * the viewer iframe (this is not constrained by the same origin policy),\n     * and then send postMessage() calls to the viewer frame and pass the\n     * viewer's origin checks, if any.\n     *\n     * The viewer could also check the source of the message to be a legitimate\n     * AMP iframe window, but the attacker could bypass that by navigating the\n     * legitimate AMP iframe window away to a malicious document. Recent\n     * browsers have banned this kind of attack, but it's tricky to rely on it.\n     *\n     * To prevent the above attack in a null origin AMP document, the viewer\n     * should include this token in an init parameter, either in the `src` or\n     * `name` attribute of the iframe, and then verify that this token is\n     * included in all the messages sent from AMP to the viewer. The attacker\n     * would not be able to steal this token under the same origin policy,\n     * because the token is inside the viewer document at a different origin\n     * and the attacker can't access it.\n     * @const @private {?string}\n     */\n    this.token_ = opt_token || null;\n\n    /**\n     * If true, the token above is verified on incoming messages instead of\n     * being attached to outgoing messages.\n     * @const @private {boolean}\n     */\n    this.verifyToken_ = !!opt_verifyToken;\n\n    /** @private {number} */\n    this.requestIdCounter_ = 0;\n    /** @private {!Object<number, {resolve: function(*), reject: function(!Error)}>} */\n    this.waitingForResponse_ = {};\n    /**\n     * A map from message names to request handlers.\n     * @private {!Object<string, !RequestHandler>}\n     */\n    this.messageHandlers_ = {};\n\n    /** @private {?RequestHandler} */\n    this.defaultHandler_ = null;\n\n    this.port_.addEventListener('message', this.handleMessage_.bind(this));\n    this.port_.start();\n  }\n\n  /**\n   * Registers a method that will handle requests sent to the specified\n   * message name.\n   * @param {string} messageName The name of the message to handle.\n   * @param {!RequestHandler} requestHandler\n   */\n  registerHandler(messageName, requestHandler) {\n    this.messageHandlers_[messageName] = requestHandler;\n  }\n\n  /**\n   * Unregisters the handler for the specified message name.\n   * @param {string} messageName The name of the message to unregister.\n   */\n  unregisterHandler(messageName) {\n    delete this.messageHandlers_[messageName];\n  }\n\n  /**\n   * @param {?RequestHandler} requestHandler\n   */\n  setDefaultHandler(requestHandler) {\n    this.defaultHandler_ = requestHandler;\n  }\n\n  /**\n   * Bob sent me a message. I need to decide if it's a new request or\n   * a response to a previous 'conversation' we were having.\n   * @param {!Event} event\n   * @private\n   */\n  handleMessage_(event) {\n    const message = parseMessage(event.data);\n    if (!message || message.app !== APP) {\n      return;\n    }\n    if (\n      this.token_ &&\n      this.verifyToken_ &&\n      message.messagingToken !== this.token_\n    ) {\n      // We received a message with an invalid token - dismiss it.\n      this.logError_(TAG + ': handleMessage_ error: ', 'invalid token');\n      return;\n    }\n    if (message.type === MessageType.REQUEST) {\n      this.handleRequest_(message);\n    } else if (message.type === MessageType.RESPONSE) {\n      this.handleResponse_(message);\n    }\n  }\n\n  /**\n   * I'm sending Bob a new outgoing request.\n   * @param {string} messageName\n   * @param {?JsonObject|string|undefined} messageData\n   * @param {boolean} awaitResponse\n   * @return {!Promise<*>|undefined}\n   */\n  sendRequest(messageName, messageData, awaitResponse) {\n    const requestId = ++this.requestIdCounter_;\n    let promise = undefined;\n    if (awaitResponse) {\n      promise = new Promise((resolve, reject) => {\n        this.waitingForResponse_[requestId] = {resolve, reject};\n      });\n    }\n    this.sendMessage_(\n      /** @type {!AmpViewerMessage} */ ({\n        app: APP,\n        requestid: requestId,\n        type: MessageType.REQUEST,\n        name: messageName,\n        data: messageData,\n        rsvp: awaitResponse,\n      })\n    );\n    return promise;\n  }\n\n  /**\n   * I'm responding to a request that Bob made earlier.\n   * @param {number} requestId\n   * @param {string} messageName\n   * @param {*} messageData\n   * @private\n   */\n  sendResponse_(requestId, messageName, messageData) {\n    this.sendMessage_(\n      /** @type {!AmpViewerMessage} */ ({\n        app: APP,\n        requestid: requestId,\n        type: MessageType.RESPONSE,\n        name: messageName,\n        data: messageData,\n      })\n    );\n  }\n\n  /**\n   * @param {number} requestId\n   * @param {string} messageName\n   * @param {*} reason !Error most of time, string sometimes, * rarely.\n   * @private\n   */\n  sendResponseError_(requestId, messageName, reason) {\n    const errString = this.errorToString_(reason);\n    this.logError_(\n      TAG + ': sendResponseError_, message name: ' + messageName,\n      errString\n    );\n    this.sendMessage_(\n      /** @type {!AmpViewerMessage} */ ({\n        app: APP,\n        requestid: requestId,\n        type: MessageType.RESPONSE,\n        name: messageName,\n        data: null,\n        error: errString,\n      })\n    );\n  }\n\n  /**\n   * @param {!AmpViewerMessage} message\n   * @private\n   */\n  sendMessage_(message) {\n    const /** Object<string, *> */ finalMessage = Object.assign(message, {});\n    if (this.token_ && !this.verifyToken_) {\n      finalMessage.messagingToken = this.token_;\n    }\n    this.port_./*OK*/ postMessage(\n      this.isWebview_\n        ? JSON.stringify(/** @type {!JsonObject} */ (finalMessage))\n        : finalMessage\n    );\n  }\n\n  /**\n   * I'm handling an incoming request from Bob. I'll either respond normally\n   * (ex: \"got it Bob!\") or with an error (ex: \"I didn't get a word of what\n   * you said!\").\n   * @param {!AmpViewerMessage} message\n   * @private\n   */\n  handleRequest_(message) {\n    let handler = this.messageHandlers_[message.name];\n    if (!handler) {\n      handler = this.defaultHandler_;\n    }\n    if (!handler) {\n      const error = new Error(\n        'Cannot handle request because no default handler is set!'\n      );\n      error.args = message.name;\n      throw error;\n    }\n\n    const promise = handler(message.name, message.data, !!message.rsvp);\n    if (message.rsvp) {\n      const requestId = message.requestid;\n      if (!promise) {\n        this.sendResponseError_(\n          requestId,\n          message.name,\n          new Error('no response')\n        );\n        throw new Error('expected response but none given: ' + message.name);\n      }\n      promise.then(\n        (data) => {\n          this.sendResponse_(requestId, message.name, data);\n        },\n        (reason) => {\n          this.sendResponseError_(requestId, message.name, reason);\n        }\n      );\n    }\n  }\n\n  /**\n   * I sent out a request to Bob. He responded. And now I'm handling that\n   * response.\n   * @param {!AmpViewerMessage} message\n   * @private\n   */\n  handleResponse_(message) {\n    const requestId = message.requestid;\n    const pending = this.waitingForResponse_[requestId];\n    if (pending) {\n      delete this.waitingForResponse_[requestId];\n      if (message.error) {\n        this.logError_(TAG + ': handleResponse_ error: ', message.error);\n        pending.reject(\n          new Error(`Request ${message.name} failed: ${message.error}`)\n        );\n      } else {\n        pending.resolve(message.data);\n      }\n    }\n  }\n\n  /**\n   * @param {string} state\n   * @param {!Error|string=} opt_data\n   * @private\n   */\n  logError_(state, opt_data) {\n    if (!this.win_) {\n      return;\n    }\n    let stateStr = 'amp-messaging-error-logger: ' + state;\n    const dataStr = ' data: ' + this.errorToString_(opt_data);\n    stateStr += dataStr;\n    this.win_['viewerState'] = stateStr;\n  }\n\n  /**\n   * @param {*} err !Error most of time, string sometimes, * rarely.\n   * @return {string}\n   * @private\n   */\n  errorToString_(err) {\n    return err ? (err.message ? err.message : String(err)) : 'unknown error';\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {throttle} from '../core/types/function';\n\n/**\n * Applies scroll and momentum to window by using touch events.\n *\n * It works using the following principles:\n *\n * On touchstart: (Re)set coordinates and timer. If user swiped while still\n *                scrolling, increase multiplier for scrolling offset.\n * On touchmove: Scroll 1:1 and calculate distance (deltaY) and acceleration of\n *               the touch movement.\n * On touchend: If meeting the momentum threshold, scroll by extra pixels\n *              (scrolling offset) by a pre-set duration using an easing fn.\n */\nexport class PageScroller {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private {!Window} */\n    this.win_ = win;\n\n    /** @private {!Object} */\n    this.touchEventState_ = {\n      startY: 0,\n      lastDelta: 0,\n      touchStartTimeMs: null,\n      touchEndTimeMs: null,\n      touchMoveTimeMs: null,\n    };\n\n    /** @private {!Object} */\n    this.scrollState_ = {\n      startY: 0,\n      isRunning: false,\n      acceleration: 1,\n      speedLimit: 0.3,\n      startTimeMs: null,\n      maxTimeBetweenSwipesMs: 250,\n      moveTimeThresholdMs: 100,\n      durationMs: null,\n      meetsDeltaYThreshold: false,\n      deltaYThresholdPx: 5,\n      deltaY: null,\n      offsetThresholdPx: 30,\n      offsetPx: null,\n      multiplier: 1,\n    };\n  }\n\n  /**\n   * Reacts to onTouchStart events. (Re)sets coordinates and timer.\n   * Applies multiplier if criteria is met or resets it.\n   * @param {number} timeStamp\n   * @param {number} startY\n   */\n  onTouchStart(timeStamp, startY) {\n    this.touchEventState_.startY = startY;\n    this.touchEventState_.touchStartTimeMs = timeStamp;\n    this.scrollState_.startY = this.win_./*OK*/ scrollY;\n\n    if (\n      this.scrollState_.isRunning &&\n      this.touchEventState_.touchEndTimeMs -\n        this.touchEventState_.touchStartTimeMs <\n        this.scrollState_.maxTimeBetweenSwipesMs\n    ) {\n      // User swiped while still scrolling, increase the multiplier for the\n      // offset.\n      this.scrollState_.multiplier += this.scrollState_.acceleration;\n    } else {\n      this.scrollState_.multiplier = 1;\n    }\n\n    this.scrollState_.isRunning = false;\n  }\n\n  /**\n   * Reacts to onTouchMove events. Scrolls 1:1 if criteria is met. Calculates\n   * distance (deltaY) and acceleration.\n   * @param {number} timeStamp\n   * @param {number} currentY\n   */\n  onTouchMove(timeStamp, currentY) {\n    this.scrollState_.acceleration = Math.abs(\n      this.scrollState_.deltaY /\n        (timeStamp - this.touchEventState_.touchMoveTimeMs)\n    );\n    this.touchEventState_.touchMoveTimeMs = timeStamp;\n\n    throttle(this.win_, this.thottledScroll_.bind(this, currentY), 50)();\n  }\n\n  /**\n   * @param {number} currentY\n   * @private\n   */\n  thottledScroll_(currentY) {\n    this.scrollState_.deltaY = currentY - this.touchEventState_.startY;\n\n    this.scrollState_.meetsDeltaYThreshold =\n      Math.abs(this.scrollState_.deltaY) > this.scrollState_.deltaYThresholdPx;\n\n    if (!this.scrollState_.meetsDeltaYThreshold) {\n      return;\n    }\n\n    this.win_./*OK*/ scrollBy(0, -this.scrollState_.deltaY);\n  }\n\n  /**\n   * Reacts to touchEnd events. Applies momentum scrolling if criteria is met.\n   * @param {number} timeStamp\n   */\n  onTouchEnd(timeStamp) {\n    this.touchEventState_.touchEndTimeMs = timeStamp;\n\n    if (!this.scrollState_.meetsDeltaYThreshold) {\n      return;\n    }\n\n    const timeFromLastTouchMove =\n      this.touchEventState_.touchEndTimeMs -\n      this.touchEventState_.touchMoveTimeMs;\n\n    this.scrollState_.offsetPx = this.calculateOffset_();\n\n    if (\n      timeFromLastTouchMove < this.scrollState_.moveTimeThresholdMs &&\n      Math.abs(this.scrollState_.offsetPx) > this.scrollState_.offsetThresholdPx\n    ) {\n      // If timefromLastTouchMove is low enough and the offset is above the\n      // threshold, (re)set the scroll parameters to include momentum.\n      this.scrollState_.durationMs = this.win_./*OK*/ innerHeight * 1.2;\n      this.scrollState_.isRunning = true;\n\n      requestAnimationFrame((timestamp) => {\n        this.scrollState_.startTimeMs = timestamp;\n        this.scrollState_.startY = this.win_./*OK*/ scrollY;\n        this.scrollOnNextTick_(timestamp);\n      });\n    }\n\n    this.scrollState_.multiplier = 1;\n    this.touchEventState_.startY = 0;\n    this.scrollState_.deltaY = 0;\n  }\n\n  /**\n   * Calculates pixel offset and direction to be scrolled by getting current\n   * acceleration and preset limits.\n   * @private\n   * @return {number}\n   */\n  calculateOffset_() {\n    const maxOffset =\n      this.win_./*OK*/ innerHeight * this.scrollState_.speedLimit;\n\n    let offset =\n      Math.pow(this.scrollState_.acceleration, 2) *\n      this.win_./*OK*/ innerHeight;\n\n    offset = Math.min(maxOffset, offset);\n\n    offset *=\n      this.scrollState_.deltaY > 0\n        ? -this.scrollState_.multiplier\n        : this.scrollState_.multiplier;\n\n    return offset;\n  }\n\n  /**\n   * Calculates scrolling position at each frame. Stops once durationMs is met\n   * or scrollState stops running.\n   * @param {number} timeStamp\n   * @private\n   */\n  scrollOnNextTick_(timeStamp) {\n    const runTime = timeStamp - this.scrollState_.startTimeMs;\n\n    if (runTime > this.scrollState_.durationMs) {\n      return;\n    }\n\n    const progress = this.easeOutQuartFn_(\n      runTime / this.scrollState_.durationMs\n    );\n\n    const scrollDelta = progress * this.scrollState_.offsetPx;\n\n    const scrollForThisTick = this.scrollState_.startY + scrollDelta;\n\n    if (!this.scrollState_.isRunning) {\n      cancelAnimationFrame(\n        requestAnimationFrame(this.scrollOnNextTick_.bind(this))\n      );\n    } else {\n      this.win_.scroll(0, scrollForThisTick);\n      requestAnimationFrame(this.scrollOnNextTick_.bind(this));\n    }\n  }\n\n  /**\n   * Ease out quart function.\n   * @param {number} pTimeElapsed Percentage of time elapsed.\n   * @return {number} Percentage progress, value between 0 and 1.\n   * @private\n   */\n  easeOutQuartFn_(pTimeElapsed) {\n    return 1 - --pTimeElapsed * pTimeElapsed * pTimeElapsed * pTimeElapsed;\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Visibility state of the AMP document.\n * @enum {string}\n */\nexport const VisibilityState = {\n  /**\n   * The AMP document is being pre-rendered before being shown.\n   */\n  PRERENDER: 'prerender',\n\n  /**\n   * The AMP document is currently active and visible.\n   */\n  VISIBLE: 'visible',\n\n  /**\n   * The AMP document is active but the browser tab or AMP app is not.\n   */\n  HIDDEN: 'hidden',\n\n  /**\n   * The AMP document is visible, but the user has started swiping away from\n   * it. The runtime may stop active playback.\n   */\n  PAUSED: 'paused',\n\n  /**\n   * The AMP document is no longer active because the user swiped away or\n   * closed the viewer. The document may become visible again later.\n   */\n  INACTIVE: 'inactive',\n};\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* @const */\nconst {hasOwnProperty: hasOwn_, toString: toString_} = Object.prototype;\n\n/**\n * Determines if value is actually an Object.\n * @param {*} value\n * @return {boolean}\n */\nexport function isObject(value) {\n  return toString_.call(value) === '[object Object]';\n}\n\n/**\n * Returns a map-like object.\n * If opt_initial is provided, copies its own properties into the\n * newly created object.\n * @param {T=} opt_initial This should typically be an object literal.\n * @return {T}\n * @template T\n */\nexport function map(opt_initial) {\n  const obj = Object.create(null);\n  if (opt_initial) {\n    Object.assign(obj, opt_initial);\n  }\n  return obj;\n}\n\n/**\n * Return an empty JsonObject or makes the passed in object literal\n * an JsonObject.\n * The JsonObject type is just a simple object that is at-dict.\n * See\n * https://github.com/google/closure-compiler/wiki/@struct-and-@dict-Annotations\n * for what a dict is type-wise.\n * The linter enforces that the argument is, in fact, at-dict like.\n * @param {!Object=} opt_initial\n * @return {!JsonObject}\n */\nexport function dict(opt_initial) {\n  // We do not copy. The linter enforces that the passed in object is a literal\n  // and thus the caller cannot have a reference to it.\n  return /** @type {!JsonObject} */ (opt_initial || {});\n}\n\n/**\n * Checks if the given key is a property in the map.\n *\n * @param {T}  obj a map like property.\n * @param {string}  key\n * @return {boolean}\n * @template T\n */\nexport function hasOwn(obj, key) {\n  return hasOwn_.call(obj, key);\n}\n\n/**\n * Returns obj[key] iff key is obj's own property (is not inherited).\n * Otherwise, returns undefined.\n *\n * @param {Object} obj\n * @param {string} key\n * @return {*}\n */\nexport function ownProperty(obj, key) {\n  if (hasOwn(obj, key)) {\n    return obj[key];\n  } else {\n    return undefined;\n  }\n}\n\n/**\n * Deep merges source into target.\n *\n * @param {!Object} target\n * @param {!Object} source\n * @param {number} depth The maximum merge depth. If exceeded, Object.assign\n *                       will be used instead.\n * @return {!Object}\n * @throws {Error} If source contains a circular reference.\n * Note: Only nested objects are deep-merged, primitives and arrays are not.\n */\nexport function deepMerge(target, source, depth = 10) {\n  // Keep track of seen objects to detect recursive references.\n  const seen = [];\n\n  /** @type {!Array<{t: !Object, s: !Object, d: number}>} */\n  const queue = [];\n  queue.push({t: target, s: source, d: 0});\n\n  // BFS to ensure objects don't have recursive references at shallower depths.\n  while (queue.length > 0) {\n    const {d, s, t} = queue.shift();\n    if (seen.includes(s)) {\n      throw new Error('Source object has a circular reference.');\n    }\n    seen.push(s);\n    if (t === s) {\n      continue;\n    }\n    if (d > depth) {\n      Object.assign(t, s);\n      continue;\n    }\n    for (const key of Object.keys(s)) {\n      const newValue = s[key];\n      // Perform a deep merge IFF both target and source have the same key\n      // whose corresponding values are objects.\n      if (hasOwn(t, key)) {\n        const oldValue = t[key];\n        if (isObject(newValue) && isObject(oldValue)) {\n          queue.push({t: oldValue, s: newValue, d: d + 1});\n          continue;\n        }\n      }\n      t[key] = newValue;\n    }\n  }\n  return target;\n}\n\n/**\n * @param {!Object} o An object to remove properties from\n * @param {!Array<string>} props A list of properties to remove from the Object\n * @return {!Object} An object with the given properties removed\n */\nexport function omit(o, props) {\n  return Object.keys(o).reduce((acc, key) => {\n    if (!props.includes(key)) {\n      acc[key] = o[key];\n    }\n    return acc;\n  }, {});\n}\n\n/**\n * @param {!Object|null|undefined} o1\n * @param {!Object|null|undefined} o2\n * @return {boolean}\n */\nexport function objectsEqualShallow(o1, o2) {\n  if (o1 == null || o2 == null) {\n    // Null is only equal to null, and undefined to undefined.\n    return o1 === o2;\n  }\n\n  for (const k in o1) {\n    if (o1[k] !== o2[k]) {\n      return false;\n    }\n  }\n  for (const k in o2) {\n    if (o2[k] !== o1[k]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\n/**\n * @param {T} obj\n * @param {string} prop\n * @param {function(T, string):R} factory\n * @return {R}\n * @template T,R\n */\nexport function memo(obj, prop, factory) {\n  let result = /** @type {?R} */ (obj[prop]);\n  if (result === undefined) {\n    result = factory(obj, prop);\n    obj[prop] = result;\n  }\n  return result;\n}\n\n/**\n * Recreates objects with prototype-less copies.\n * @param {!JsonObject} obj\n * @return {!JsonObject}\n */\nexport function recreateNonProtoObject(obj) {\n  const copy = map();\n  for (const k in obj) {\n    if (!hasOwn(obj, k)) {\n      continue;\n    }\n    const v = obj[k];\n    copy[k] = isObject(v) ? recreateNonProtoObject(v) : v;\n  }\n  return /** @type {!JsonObject} */ (copy);\n}\n\n/**\n * Returns a value from an object for a field-based expression. The expression\n * is a simple nested dot-notation of fields, such as `field1.field2`. If any\n * field in a chain does not exist or is not an object or array, the returned\n * value will be `undefined`.\n *\n * @param {!JsonObject} obj\n * @param {string} expr\n * @return {*}\n */\nexport function getValueForExpr(obj, expr) {\n  // The `.` indicates \"the object itself\".\n  if (expr == '.') {\n    return obj;\n  }\n  // Otherwise, navigate via properties.\n  const parts = expr.split('.');\n  let value = obj;\n  for (const part of parts) {\n    if (\n      part &&\n      value &&\n      value[part] !== undefined &&\n      typeof value == 'object' &&\n      hasOwn(value, part)\n    ) {\n      value = value[part];\n      continue;\n    }\n    value = undefined;\n    break;\n  }\n  return value;\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {map} from '../types/object';\n\n/**\n * @template T\n */\nexport class LruCache {\n  /**\n   * @param {number} capacity\n   */\n  constructor(capacity) {\n    /** @private @const {number} */\n    this.capacity_ = capacity;\n\n    /** @private {number} */\n    this.size_ = 0;\n\n    /**\n     * An incrementing counter to define the last access.\n     * @private {number}\n     */\n    this.access_ = 0;\n\n    /** @private {!Object<(number|string), {payload: T, access: number}>} */\n    this.cache_ = map();\n  }\n\n  /**\n   * Returns whether key is cached.\n   *\n   * @param {number|string} key\n   * @return {boolean}\n   */\n  has(key) {\n    return !!this.cache_[key];\n  }\n\n  /**\n   * @param {number|string} key\n   * @return {T} The cached payload.\n   */\n  get(key) {\n    const cacheable = this.cache_[key];\n    if (cacheable) {\n      cacheable.access = ++this.access_;\n      return cacheable.payload;\n    }\n    return undefined;\n  }\n\n  /**\n   * @param {number|string} key\n   * @param {T} payload The payload to cache.\n   */\n  put(key, payload) {\n    if (!this.has(key)) {\n      this.size_++;\n    }\n    this.cache_[key] = {payload, access: this.access_};\n    this.evict_();\n  }\n\n  /**\n   * Evicts the oldest cache entry, if we've exceeded capacity.\n   */\n  evict_() {\n    if (this.size_ <= this.capacity_) {\n      return;\n    }\n\n    const cache = this.cache_;\n    let oldest = this.access_ + 1;\n    let oldestKey;\n    for (const key in cache) {\n      const {access} = cache[key];\n      if (access < oldest) {\n        oldest = access;\n        oldestKey = key;\n      }\n    }\n\n    if (oldestKey !== undefined) {\n      delete cache[oldestKey];\n      this.size_--;\n    }\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {string} _match\n * @param {string} character\n * @return {string}\n */\nfunction toUpperCase(_match, character) {\n  return character.toUpperCase();\n}\n\n/**\n * @param {string} match\n * @return {string}\n */\nfunction prependDashAndToLowerCase(match) {\n  return '-' + match.toLowerCase();\n}\n\n/**\n * @param {string} name Attribute name containing dashes.\n * @return {string} Dashes removed and successive character sent to upper case.\n * visibleForTesting\n */\nexport function dashToCamelCase(name) {\n  return name.replace(/-([a-z])/g, toUpperCase);\n}\n\n/**\n * Converts a string that is in camelCase to one that is in dash-case.\n *\n * @param {string} string The string to convert.\n * @return {string} The string in dash-case.\n */\nexport function camelCaseToDash(string) {\n  return string.replace(/(?!^)[A-Z]/g, prependDashAndToLowerCase);\n}\n\n/**\n * @param {string} name Attribute name with dashes\n * @return {string} Dashes replaced by underlines.\n */\nexport function dashToUnderline(name) {\n  return name.replace('-', '_');\n}\n\n/**\n * Polyfill for String.prototype.endsWith.\n * @param {string} string\n * @param {string} suffix\n * @return {boolean}\n */\nexport function endsWith(string, suffix) {\n  const index = string.length - suffix.length;\n  return index >= 0 && string.indexOf(suffix, index) == index;\n}\n\n/**\n * Polyfill for String.prototype.includes.\n * @param {string} string\n * @param {string} substring\n * @param {number=} start\n * @return {boolean}\n */\nexport function includes(string, substring, start) {\n  if (typeof start !== 'number') {\n    start = 0;\n  }\n  if (start + substring.length > string.length) {\n    return false;\n  }\n  return string.indexOf(substring, start) !== -1;\n}\n\n/**\n * Expands placeholders in a given template string with values.\n *\n * Placeholders use ${key-name} syntax and are replaced with the value\n * returned from the given getter function.\n *\n * @param {string} template The template string to expand.\n * @param {function(string):*} getter Function used to retrieve a value for a\n *   placeholder. Returns values will be coerced into strings.\n * @param {number=} opt_maxIterations Number of times to expand the template.\n *   Defaults to 1, but should be set to a larger value your placeholder tokens\n *   can be expanded to other placeholder tokens. Take caution with large values\n *   as recursively expanding a string can be exponentially expensive.\n * @return {string}\n */\nexport function expandTemplate(template, getter, opt_maxIterations) {\n  const maxIterations = opt_maxIterations || 1;\n  for (let i = 0; i < maxIterations; i++) {\n    let matches = 0;\n    template = template.replace(/\\${([^}]*)}/g, (_a, b) => {\n      matches++;\n      return getter(b);\n    });\n    if (!matches) {\n      break;\n    }\n  }\n  return template;\n}\n\n/**\n * Hash function djb2a\n * This is intended to be a simple, fast hashing function using minimal code.\n * It does *not* have good cryptographic properties.\n * @param {string} str\n * @return {string} 32-bit unsigned hash of the string\n */\nexport function stringHash32(str) {\n  const {length} = str;\n  let hash = 5381;\n  for (let i = 0; i < length; i++) {\n    hash = (hash * 33) ^ str.charCodeAt(i);\n  }\n  // Convert from 32-bit signed to unsigned.\n  return String(hash >>> 0);\n}\n\n/**\n * Trims a string on the end, removing whitespace characters.\n * @param {string} str  A string to trim.\n * @return {string} The string, with trailing whitespace removed.\n */\nexport function trimEnd(str) {\n  // TODO(sparhami) Does this get inlined for an ES2019 build?\n  if (str.trimEnd) {\n    return str.trimEnd();\n  }\n\n  return ('_' + str).trim().slice(1);\n}\n\n/**\n * Trims any leading whitespace from a string.\n * @param {string} str  A string to trim.\n * @return {string} The string, with leading whitespace removed.\n */\nexport function trimStart(str) {\n  if (str.trimStart) {\n    return str.trimStart();\n  }\n\n  return (str + '_').trim().slice(0, -1);\n}\n\n/**\n * Wrapper around String.replace that handles asynchronous resolution.\n * @param {string} str\n * @param {RegExp} regex\n * @param {Function|string} replacer\n * @return {!Promise<string>}\n */\nexport function asyncStringReplace(str, regex, replacer) {\n  if (isString(replacer)) {\n    return Promise.resolve(str.replace(regex, replacer));\n  }\n  const stringBuilder = [];\n  let lastIndex = 0;\n\n  str.replace(regex, function (match) {\n    // String.prototype.replace will pass 3 to n number of arguments to the\n    // callback function based on how many capture groups the regex may or may\n    // not contain. We know that the match will always be first, and the\n    // index will always be second to last.\n    const matchIndex = arguments[arguments.length - 2];\n    stringBuilder.push(str.slice(lastIndex, matchIndex));\n    lastIndex = matchIndex + match.length;\n\n    // Store the promise in it's eventual string position.\n    const replacementPromise = replacer.apply(null, arguments);\n    stringBuilder.push(replacementPromise);\n  });\n  stringBuilder.push(str.slice(lastIndex));\n\n  return Promise.all(stringBuilder).then((resolved) => resolved.join(''));\n}\n\n/**\n * Pads the beginning of a string with a substring to a target length.\n * @param {string} s\n * @param {number} targetLength\n * @param {string} padString\n * @return {string}\n */\nexport function padStart(s, targetLength, padString) {\n  if (s.length >= targetLength) {\n    return s;\n  }\n  targetLength = targetLength - s.length;\n  let padding = padString;\n  while (targetLength > padding.length) {\n    padding += padString;\n  }\n  return padding.slice(0, targetLength) + s;\n}\n\n/**\n * Tests if a value is a string.\n * @param {?} s\n * @return {boolean}\n */\nexport function isString(s) {\n  return typeof s == 'string';\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns the internal AMP runtime version. Note that this is not the RTV,\n * which is a prefix and the runtime version.\n *\n * The call sites for this function are replaced with a compile time constant\n * string.\n *\n * @return {string}\n */\nexport function internalRuntimeVersion() {\n  return '$internalRuntimeVersion$';\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {map} from '../object';\n\nconst QUERY_STRING_REGEX = /(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;\n\n/**\n * Tries to decode a URI component, falling back to opt_fallback (or an empty\n * string)\n *\n * @param {string} component\n * @param {string=} fallback\n * @return {string}\n */\nexport function tryDecodeUriComponent(component, fallback = '') {\n  try {\n    return decodeURIComponent(component);\n  } catch (e) {\n    return fallback;\n  }\n}\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\nexport function parseQueryString(queryString) {\n  const params = map();\n  if (!queryString) {\n    return params;\n  }\n\n  let match;\n  while ((match = QUERY_STRING_REGEX.exec(queryString))) {\n    const name = tryDecodeUriComponent(match[1], match[1]);\n    const value = match[2]\n      ? tryDecodeUriComponent(match[2].replace(/\\+/g, ' '), match[2])\n      : '';\n    params[name] = value;\n  }\n  return params;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalRuntimeVersion} from './internal-version';\nimport {parseQueryString} from './core/types/string/url';\n\n/**\n * @typedef {{\n *   localDev: boolean,\n *   development: boolean,\n *   minified: boolean,\n *   test: boolean,\n *   examiner: boolean,\n *   log: (string|undefined),\n *   version: string,\n *   rtvVersion: string,\n *   runtime: (null|string|undefined),\n *   a4aId: (null|string|undefined),\n *   esm: (boolean|undefined),\n * }}\n */\nexport let ModeDef;\n\n/**\n * `rtvVersion` is the prefixed version we serve off of the cdn.\n * The prefix denotes canary(00) or prod(01) or an experiment version ( > 01).\n * @type {string}\n */\nlet rtvVersion = '';\n\n/**\n * Provides info about the current app.\n * @param {?Window=} opt_win\n * @return {!ModeDef}\n */\nexport function getMode(opt_win) {\n  const win = opt_win || self;\n  if (win.__AMP_MODE) {\n    return win.__AMP_MODE;\n  }\n  return (win.__AMP_MODE = getMode_(win));\n}\n\n/**\n * Provides info about the current app.\n * @param {!Window} win\n * @return {!ModeDef}\n */\nfunction getMode_(win) {\n  // TODO(erwinmombay): simplify the logic here\n  const AMP_CONFIG = self.AMP_CONFIG || {};\n\n  // Magic constants that are replaced by closure compiler.\n  // IS_MINIFIED is always replaced with true when closure compiler is used\n  // while IS_FORTESTING is only replaced when `amp dist` is called without the\n  // --fortesting flag.\n  const IS_FORTESTING = true;\n  const IS_MINIFIED = false;\n\n  const runningTests =\n    IS_FORTESTING && !!(AMP_CONFIG.test || win.__AMP_TEST || win['__karma__']);\n  const isLocalDev = IS_FORTESTING && (!!AMP_CONFIG.localDev || runningTests);\n  const hashQuery = parseQueryString(\n    // location.originalHash is set by the viewer when it removes the fragment\n    // from the URL.\n    win.location['originalHash'] || win.location.hash\n  );\n\n  if (!rtvVersion) {\n    rtvVersion = getRtvVersion(win);\n  }\n\n  // The `minified`, `test` and `localDev` properties are replaced\n  // as boolean literals when we run `amp dist` without the `--fortesting`\n  // flags. This improved DCE on the production file we deploy as the code\n  // paths for localhost/testing/development are eliminated.\n  return {\n    localDev: isLocalDev,\n    development: isModeDevelopment(win),\n    examiner: hashQuery['development'] == '2',\n    esm: IS_ESM,\n    // amp-geo override\n    geoOverride: hashQuery['amp-geo'],\n    minified: IS_MINIFIED,\n    test: runningTests,\n    log: hashQuery['log'],\n    version: internalRuntimeVersion(),\n    rtvVersion,\n  };\n}\n\n/**\n * Retrieve the `rtvVersion` which will have a numeric prefix\n * denoting canary/prod/experiment (unless `isLocalDev` is true).\n *\n * @param {!Window} win\n * @return {string}\n */\nfunction getRtvVersion(win) {\n  if (win.AMP_CONFIG && win.AMP_CONFIG.v) {\n    return win.AMP_CONFIG.v;\n  }\n\n  // Currently `internalRuntimeVersion` and thus `mode.version` contain only\n  // major version. The full version however must also carry the minor version.\n  // We will default to production default `01` minor version for now.\n  // TODO(erwinmombay): decide whether internalRuntimeVersion should contain\n  // minor version.\n  return `01${internalRuntimeVersion()}`;\n}\n\n/**\n * Triggers validation or enable pub level logging. Validation can be\n * bypassed via #validate=0.\n * Note that AMP_DEV_MODE flag is used for testing purposes.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isModeDevelopment(win) {\n  const hashQuery = parseQueryString(\n    win.location['originalHash'] || win.location.hash\n  );\n  return !!(\n    ['1', 'actions', 'amp', 'amp4ads', 'amp4email'].includes(\n      hashQuery['development']\n    ) || win.AMP_DEV_MODE\n  );\n}\n\n/**\n * @param {!Window} win\n * @return {string}\n * @visibleForTesting\n */\nexport function getRtvVersionForTesting(win) {\n  return getRtvVersion(win);\n}\n\n/** @visibleForTesting */\nexport function resetRtvVersionForTesting() {\n  rtvVersion = '';\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Converts an array-like object to an array.\n * @param {?IArrayLike<T>|string} arrayLike\n * @return {!Array<T>}\n * @template T\n */\nexport function toArray(arrayLike) {\n  return arrayLike ? Array.prototype.slice.call(arrayLike) : [];\n}\n\n/**\n * Determines if value is actually an Array.\n * @param {*} value\n * @return {boolean}\n */\nexport const {isArray} = Array;\n\n/**\n * If the specified argument is an array, it's returned as is. If it's a\n * single item, the array containing this item is created and returned.\n *\n * The double-template pattern here solves a bug where CC can be passed a value\n * with declared type {string|!Array<string>} and return a value with a type of\n * {!Array<string|Array<string>>}.\n *\n * @param {!Array<T>|S} arrayOrSingleItem\n * @return {!Array<T>|!Array<S>}\n * @template S\n * @template T\n */\nexport function arrayOrSingleItemToArray(arrayOrSingleItem) {\n  return isArray(arrayOrSingleItem)\n    ? /** @type {!Array<T>} */ (arrayOrSingleItem)\n    : [/** @type {!S} */ (arrayOrSingleItem)];\n}\n\n/**\n * Compares if two arrays contains exactly same elements of same number\n * of same order. Note that it does NOT handle NaN case as expected.\n *\n * @param {!Array<T>} arr1\n * @param {!Array<T>} arr2\n * @return {boolean}\n * @template T\n */\nexport function areEqualOrdered(arr1, arr2) {\n  if (arr1.length !== arr2.length) {\n    return false;\n  }\n  for (let i = 0; i < arr1.length; i++) {\n    if (arr1[i] !== arr2[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Removes elements that shouldRemove returns true for from the array.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} shouldRemove\n * @return {!Array<T>}\n * @template T\n */\nexport function remove(array, shouldRemove) {\n  const removed = [];\n  let index = 0;\n  for (let i = 0; i < array.length; i++) {\n    const item = array[i];\n    if (shouldRemove(item, i, array)) {\n      removed.push(item);\n    } else {\n      if (index < i) {\n        array[index] = item;\n      }\n      index++;\n    }\n  }\n  if (index < array.length) {\n    array.length = index;\n  }\n  return removed;\n}\n\n/**\n * Returns the index of the first element matching the predicate.\n * Like Array#findIndex.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} predicate\n * @return {number}\n * @template T\n */\nexport function findIndex(array, predicate) {\n  for (let i = 0; i < array.length; i++) {\n    if (predicate(array[i], i, array)) {\n      return i;\n    }\n  }\n  return -1;\n}\n\n/**\n * Converts the given iterator to an array.\n *\n * @param {!Iterator<T>} iterator\n * @return {Array<T>}\n * @template T\n */\nexport function fromIterator(iterator) {\n  const array = [];\n  for (let e = iterator.next(); !e.done; e = iterator.next()) {\n    array.push(e.value);\n  }\n  return array;\n}\n\n/**\n * Adds item to array if it is not already present.\n *\n * @param {Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function pushIfNotExist(array, item) {\n  if (array.indexOf(item) < 0) {\n    array.push(item);\n    return true;\n  }\n  return false;\n}\n\n/**\n * Removes the first matching item in the array. Returns `true` if the array\n * has changed.\n *\n * @param {!Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function removeItem(array, item) {\n  const index = array.indexOf(item);\n  if (index == -1) {\n    return false;\n  }\n  array.splice(index, 1);\n  return true;\n}\n\n/**\n * Returns the last item in an array.\n *\n * @param {Array<T>} array\n * @template T\n * @return {?T}\n */\nexport function lastItem(array) {\n  return array[array.length - 1];\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Export all type-checking helpers for convenience\nexport {isArray} from './array';\nexport {isEnumValue} from './enum';\nexport {isString} from './string';\nexport {isObject} from './object';\n\n/**\n * Determines if value is an ELement\n * @param {*} value\n * @return {boolean}\n */\nexport function isElement(value) {\n  return value?.nodeType == /* Node.ELEMENT_NODE */ 1;\n}\n\n/**\n * Determines if value is of number type and finite.\n * NaN and Infinity are not considered a finite number.\n * String numbers are not considered numbers.\n * @param {*} value\n * @return {boolean}\n */\nexport function isFiniteNumber(value) {\n  return typeof value === 'number' && isFinite(value);\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Allows for runtime configuration. Internally, the runtime should\n * use the src/config.js module for various constants. We can use the\n * AMP_CONFIG global to translate user-defined configurations to this\n * module.\n * @type {!Object<string, string>}\n */\nconst env = self.AMP_CONFIG || {};\n\nconst thirdPartyFrameRegex =\n  (typeof env['thirdPartyFrameRegex'] == 'string'\n    ? new RegExp(env['thirdPartyFrameRegex'])\n    : env['thirdPartyFrameRegex']) || /^d-\\d+\\.ampproject\\.net$/;\n\nconst cdnProxyRegex =\n  (typeof env['cdnProxyRegex'] == 'string'\n    ? new RegExp(env['cdnProxyRegex'])\n    : env['cdnProxyRegex']) ||\n  /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org$/;\n\n/**\n * Check for a custom URL definition in special <meta> tags. Note that this does\n * not allow for distinct custom URLs in AmpDocShadow instances. The shell is\n * allowed to define one set of custom URLs via AMP_CONFIG (recommended) or by\n * including <meta> tags in the shell <head>. Those custom URLs then apply to\n * all AMP documents loaded in the shell.\n * @param {string} name\n * @return {?string}\n * @private\n */\nfunction getMetaUrl(name) {\n  // Avoid exceptions in unit tests\n  if (!self.document || !self.document.head) {\n    return null;\n  }\n\n  // Disallow on proxy origins\n  if (self.location && cdnProxyRegex.test(self.location.origin)) {\n    return null;\n  }\n\n  const metaEl = self.document.head./*OK*/ querySelector(\n    `meta[name=\"${name}\"]`\n  );\n  return (metaEl && metaEl.getAttribute('content')) || null;\n}\n\n/**\n * @typedef {{\n *   thirdParty: string,\n *   thirdPartyFrameHost: string,\n *   thirdPartyFrameRegex: !RegExp,\n *   cdn: string,\n *   cdnProxyRegex: !RegExp,\n *   localhostRegex: !RegExp,\n *   errorReporting: string,\n *   betaErrorReporting: string,\n *   localDev: boolean,\n *   trustedViewerHosts: !Array<!RegExp>,\n *   geoApi: ?string,\n * }}\n */\nexport const urls = {\n  thirdParty: env['thirdPartyUrl'] || 'https://3p.ampproject.net',\n  thirdPartyFrameHost: env['thirdPartyFrameHost'] || 'ampproject.net',\n  thirdPartyFrameRegex,\n  cdn:\n    env['cdnUrl'] || getMetaUrl('runtime-host') || 'https://cdn.ampproject.org',\n  /* Note that cdnProxyRegex is only ever checked against origins\n   * (proto://host[:port]) so does not need to consider path\n   */\n  cdnProxyRegex,\n  localhostRegex: /^https?:\\/\\/localhost(:\\d+)?$/,\n  errorReporting:\n    env['errorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r',\n  betaErrorReporting:\n    env['betaErrorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r-beta',\n  localDev: env['localDev'] || false,\n  /**\n   * These domains are trusted with more sensitive viewer operations such as\n   * propagating the referrer. If you believe your domain should be here,\n   * file the issue on GitHub to discuss. The process will be similar\n   * (but somewhat more stringent) to the one described in the [3p/README.md](\n   * https://github.com/ampproject/amphtml/blob/main/3p/README.md)\n   *\n   * {!Array<!RegExp>}\n   */\n  trustedViewerHosts: [\n    /(^|\\.)google\\.(com?|[a-z]{2}|com?\\.[a-z]{2}|cat)$/,\n    /(^|\\.)gmail\\.(com|dev)$/,\n  ],\n  // Optional fallback API if amp-geo is left unpatched\n  geoApi: env['geoApiUrl'] || getMetaUrl('amp-geo-api'),\n};\n\nexport const config = {\n  urls,\n};\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isElement} from '../types';\n\n/**\n * Triple zero width space.\n *\n * This is added to user error messages, so that we can later identify\n * them, when the only thing that we have is the message. This is the\n * case in many browsers when the global exception handler is invoked.\n *\n * @const {string}\n */\nexport const USER_ERROR_SENTINEL = '\\u200B\\u200B\\u200B';\n\n/**\n * Converts an element to a readable string; all other types are unchanged.\n * TODO(rcebulko): Unify with log.js\n * @param {*} val\n * @return {*}\n */\nexport function elementStringOrPassThru(val) {\n  // Do check equivalent to `val instanceof Element` without cross-window bug\n  if (isElement(val)) {\n    val = /** @type {Element} */ (val);\n    return val.tagName.toLowerCase() + (val.id ? `#${val.id}` : '');\n  }\n  return val;\n}\n\n/**\n * Tests if an error message contains the user sentinel.\n * @param {string} message\n * @return {boolean} Whether this message was a user error.\n */\nexport function isUserErrorMessage(message) {\n  return message.indexOf(USER_ERROR_SENTINEL) >= 0;\n}\n\n/**\n * Strips the user error sentinel from an error message.\n * @param {string} message\n * @return {string} The new message without USER_ERROR_SENTINEL\n */\nexport function stripUserError(message) {\n  return message.replace(USER_ERROR_SENTINEL, '');\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {elementStringOrPassThru} from '../error/message-helpers';\nimport {includes} from '../types/string';\nimport {isArray, isElement, isString} from '../types';\nimport {remove} from '../types/array';\n\n/**\n * @fileoverview This file provides the base implementation for assertion\n * functions. Most files should never import from this; instead, import from\n * `dev` or `user`. It is also used by the Log class for its assertions.\n */\n\n/**\n * A base assertion function, provided to various assertion helpers.\n * @typedef {function(?, string=, ...*):?|function(?, !Array<*>)}\n */\nexport let AssertionFunctionDef;\n\n/**\n * Throws an error if the second argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n * @param {?string} sentinel\n * @param {T} shouldBeTruthy\n * @param {string} opt_message\n * @param {...*} var_args Arguments substituted into %s in the message\n * @return {T}\n * @template T\n * @throws {Error} when shouldBeTruthy is not truthy.\n */\nexport function assert(\n  sentinel,\n  shouldBeTruthy,\n  opt_message = 'Assertion failed',\n  var_args\n) {\n  if (shouldBeTruthy) {\n    return shouldBeTruthy;\n  }\n\n  // Include the sentinel string if provided and not already present\n  if (sentinel && !includes(opt_message, sentinel)) {\n    opt_message += sentinel;\n  }\n\n  // Skip the first 3 arguments to isolate format params\n  // const messageArgs = Array.prototype.slice.call(arguments, 3);\n  // Index at which message args start\n  let i = 3;\n\n  // Substitute provided values into format string in message\n  const splitMessage = opt_message.split('%s');\n  let message = splitMessage.shift();\n  const messageArray = [message];\n\n  while (splitMessage.length) {\n    const subValue = arguments[i++];\n    const nextConstant = splitMessage.shift();\n\n    message += elementStringOrPassThru(subValue) + nextConstant;\n    messageArray.push(subValue, nextConstant.trim());\n  }\n\n  const error = new Error(message);\n  error.messageArray = remove(messageArray, (x) => x !== '');\n  // __AMP_REPORT_ERROR is installed globally per window in the entry point in\n  // AMP documents. It may not be present for Bento/Preact elements on non-AMP\n  // pages.\n  self.__AMP_REPORT_ERROR?.(error);\n  throw error;\n}\n\n/**\n * Asserts types, backbone of `assertNumber`, `assertString`, etc.\n *\n * It understands array-based \"id\"-contracted messages.\n *\n * Otherwise creates a sprintf syntax string containing the optional message or the\n * default. The `subject` of the assertion is added at the end.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {T} subject\n * @param {*} shouldBeTruthy\n * @param {string} defaultMessage\n * @param {!Array<*>|string=} opt_message\n * @return {T}\n * @template T\n * @private\n */\nfunction assertType_(\n  assertFn,\n  subject,\n  shouldBeTruthy,\n  defaultMessage,\n  opt_message\n) {\n  if (isArray(opt_message)) {\n    assertFn(\n      shouldBeTruthy,\n      /** @type {!Array} */ (opt_message).concat([subject])\n    );\n  } else {\n    assertFn(shouldBeTruthy, `${opt_message || defaultMessage}: %s`, subject);\n  }\n\n  return subject;\n}\n\n/**\n * Throws an error if the first argument isn't an Element.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeElement\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Element} The value of shouldBeTrueish.\n * @throws {Error} when shouldBeElement is not an Element\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertElement(assertFn, shouldBeElement, opt_message) {\n  return /** @type {!Element} */ (\n    assertType_(\n      assertFn,\n      shouldBeElement,\n      isElement(shouldBeElement),\n      'Element expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a string. The string can\n * be empty.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeString\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {string} The string value. Can be an empty string.\n * @throws {Error} when shouldBeString is not an String\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertString(assertFn, shouldBeString, opt_message) {\n  return /** @type {string} */ (\n    assertType_(\n      assertFn,\n      shouldBeString,\n      isString(shouldBeString),\n      'String expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a number. The allowed values\n * include `0` and `NaN`.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeNumber\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {number} The number value. The allowed values include `0`\n *   and `NaN`.\n * @throws {Error} when shouldBeNumber is not an Number\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertNumber(assertFn, shouldBeNumber, opt_message) {\n  return /** @type {number} */ (\n    assertType_(\n      assertFn,\n      shouldBeNumber,\n      typeof shouldBeNumber == 'number',\n      'Number expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument is not an array.\n * The array can be empty.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeArray\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Array} The array value\n * @throws {Error} when shouldBeArray is not an Array\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertArray(assertFn, shouldBeArray, opt_message) {\n  return /** @type {!Array} */ (\n    assertType_(\n      assertFn,\n      shouldBeArray,\n      isArray(shouldBeArray),\n      'Array expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a boolean.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeBoolean\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {boolean} The boolean value.\n * @throws {Error} when shouldBeBoolean is not an Boolean\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertBoolean(assertFn, shouldBeBoolean, opt_message) {\n  return /** @type {boolean} */ (\n    assertType_(\n      assertFn,\n      shouldBeBoolean,\n      !!shouldBeBoolean === shouldBeBoolean,\n      'Boolean expected',\n      opt_message\n    )\n  );\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Some exceptions (DOMException, namely) have read-only message.\n * @param {!Error} error\n * @return {!Error};\n */\nexport function duplicateErrorIfNecessary(error) {\n  const messageProperty = Object.getOwnPropertyDescriptor(error, 'message');\n  if (messageProperty?.writable) {\n    return error;\n  }\n\n  const {message, stack} = error;\n  const e = new Error(message);\n  // Copy all the extraneous things we attach.\n  for (const prop in error) {\n    e[prop] = error[prop];\n  }\n  // Ensure these are copied.\n  e.stack = stack;\n  return e;\n}\n\n/**\n * @param {...*} var_args\n * @return {!Error}\n * @visibleForTesting\n */\nexport function createErrorVargs(var_args) {\n  let error = null;\n  let message = '';\n  for (const arg of arguments) {\n    if (arg instanceof Error && !error) {\n      error = duplicateErrorIfNecessary(arg);\n    } else {\n      if (message) {\n        message += ' ';\n      }\n      message += arg;\n    }\n  }\n\n  if (!error) {\n    error = new Error(message);\n  } else if (message) {\n    error.message = message + ': ' + error.message;\n  }\n  return error;\n}\n\n/**\n * Rethrows the error without terminating the current context. This preserves\n * whether the original error designation is a user error or a dev error.\n * @param {...*} var_args\n */\nexport function rethrowAsync(var_args) {\n  const error = createErrorVargs.apply(null, arguments);\n  setTimeout(() => {\n    // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n    // It may not exist for Bento components without the runtime.\n    self.__AMP_REPORT_ERROR?.(error);\n    throw error;\n  });\n}\n\n/**\n * Executes the provided callback in a try/catch and rethrows any errors\n * asynchronously.\n *\n * @param {function(...*):T} callback\n * @param {...*} args\n * @return {T}\n * @template T\n */\nexport function tryCallback(callback, ...args) {\n  try {\n    return callback.apply(null, args);\n  } catch (e) {\n    rethrowAsync(e);\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assertions from './core/assert/base';\nimport {\n  USER_ERROR_SENTINEL,\n  elementStringOrPassThru,\n  isUserErrorMessage,\n  stripUserError,\n} from './core/error/message-helpers';\nimport {createErrorVargs, duplicateErrorIfNecessary} from './core/error';\nimport {getMode} from './mode';\nimport {internalRuntimeVersion} from './internal-version';\nimport {isArray} from './core/types';\nimport {once} from './core/types/function';\nimport {urls} from './config';\n\nconst noop = () => {};\n\n// These are exported here despite being defined in core to avoid updating\n// imports for now.\nexport {USER_ERROR_SENTINEL, isUserErrorMessage, stripUserError};\n\n/**\n * Four zero width space.\n *\n * @const {string}\n */\nexport const USER_ERROR_EMBED_SENTINEL = '\\u200B\\u200B\\u200B\\u200B';\n\n/**\n * @param {string} message\n * @return {boolean} Whether this message was a a user error from an iframe embed.\n */\nexport function isUserErrorEmbed(message) {\n  return message.indexOf(USER_ERROR_EMBED_SENTINEL) >= 0;\n}\n\n/**\n * @enum {number}\n */\nexport const LogLevel = {\n  OFF: 0,\n  ERROR: 1,\n  WARN: 2,\n  INFO: 3,\n  FINE: 4,\n};\n\n/**\n * Sets reportError function. Called from error-reporting.js to break cyclic\n * dependency.\n * @param {function(this:Window, Error, (?Element)=): ?|undefined} fn\n */\nexport function setReportError(fn) {\n  self.__AMP_REPORT_ERROR = fn;\n}\n\n/**\n * @type {!LogLevel|undefined}\n * @private\n */\nlet levelOverride_ = undefined;\n\n/**\n * @param {!LogLevel} level\n */\nexport function overrideLogLevel(level) {\n  levelOverride_ = level;\n}\n\n/**\n * Prefixes `internalRuntimeVersion` with the `01` channel signifier (for prod.) for\n * extracted message URLs.\n * (Specific channel is irrelevant: message tables are invariant on internal version.)\n * @return {string}\n */\nconst messageUrlRtv = () => `01${internalRuntimeVersion()}`;\n\n/**\n * Gets a URL to display a message on amp.dev.\n * @param {string} id\n * @param {!Array} interpolatedParts\n * @return {string}\n */\nconst externalMessageUrl = (id, interpolatedParts) =>\n  interpolatedParts.reduce(\n    (prefix, arg) => `${prefix}&s[]=${messageArgToEncodedComponent(arg)}`,\n    `https://log.amp.dev/?v=${messageUrlRtv()}&id=${encodeURIComponent(id)}`\n  );\n\n/**\n * URL to simple log messages table JSON file, which contains an Object<string, string>\n * which maps message id to full message template.\n * @return {string}\n */\nconst externalMessagesSimpleTableUrl = () =>\n  `${urls.cdn}/rtv/${messageUrlRtv()}/log-messages.simple.json`;\n\n/**\n * @param {*} arg\n * @return {string}\n */\nconst messageArgToEncodedComponent = (arg) =>\n  encodeURIComponent(String(elementStringOrPassThru(arg)));\n\n/**\n * Logging class. Use of sentinel string instead of a boolean to check user/dev\n * errors because errors could be rethrown by some native code as a new error,\n * and only a message would survive. Also, some browser don\u2019t support a 5th\n * error object argument in window.onerror. List of supporting browser can be\n * found here:\n * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n * @final\n * @private Visible for testing only.\n */\nexport class Log {\n  /**\n   * opt_suffix will be appended to error message to identify the type of the\n   * error message. We can't rely on the error object to pass along the type\n   * because some browsers do not have this param in its window.onerror API.\n   * See:\n   * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n   *\n   * @param {!Window} win\n   * @param {function(number, boolean):!LogLevel} levelFunc\n   * @param {string=} opt_suffix\n   */\n  constructor(win, levelFunc, opt_suffix = '') {\n    /**\n     * In tests we use the main test window instead of the iframe where\n     * the tests runs because only the former is relayed to the console.\n     * @const {!Window}\n     */\n    this.win = getMode().test && win.__AMP_TEST_IFRAME ? win.parent : win;\n\n    /** @private @const {function(number, boolean):!LogLevel} */\n    this.levelFunc_ = levelFunc;\n\n    /** @private @const {!LogLevel} */\n    this.level_ = this.defaultLevel_();\n\n    /** @private @const {string} */\n    this.suffix_ = opt_suffix;\n\n    /** @private {?JsonObject} */\n    this.messages_ = null;\n\n    this.fetchExternalMessagesOnce_ = once(() => {\n      win\n        .fetch(externalMessagesSimpleTableUrl())\n        .then((response) => response.json(), noop)\n        .then((opt_messages) => {\n          if (opt_messages) {\n            this.messages_ = /** @type {!JsonObject} */ (opt_messages);\n          }\n        });\n    });\n\n    // This bound assertion function is capable of handling the format used when\n    // error/assertion messages are extracted. This logic hasn't yet been\n    // migrated to an AMP-independent form for use in core. This binding allows\n    // Log assertion helpers to maintain message-extraction capabilities until\n    // that logic can be moved to core.\n    this.boundAssertFn_ = /** @type {!assertions.AssertionFunctionDef} */ (\n      this.assert.bind(this)\n    );\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  getLevel_() {\n    return levelOverride_ !== undefined ? levelOverride_ : this.level_;\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevel_() {\n    // No console - can't enable logging.\n    if (!this.win.console || !this.win.console.log) {\n      return LogLevel.OFF;\n    }\n\n    // Logging has been explicitly disabled.\n    if (getMode().log == '0') {\n      return LogLevel.OFF;\n    }\n\n    // Logging is enabled for tests directly.\n    if (getMode().test && this.win.ENABLE_LOG) {\n      return LogLevel.FINE;\n    }\n\n    // LocalDev by default allows INFO level, unless overriden by `#log`.\n    if (getMode().localDev && !getMode().log) {\n      return LogLevel.INFO;\n    }\n\n    return this.defaultLevelWithFunc_();\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevelWithFunc_() {\n    // Delegate to the specific resolver.\n    return this.levelFunc_(parseInt(getMode().log, 10), getMode().development);\n  }\n\n  /**\n   * @param {string} tag\n   * @param {!LogLevel} level\n   * @param {!Array} messages\n   * @return {boolean} true if a message was logged\n   */\n  msg_(tag, level, messages) {\n    if (this.getLevel_() < level) {\n      return false;\n    }\n    let fn = this.win.console.log;\n    if (level == LogLevel.ERROR) {\n      fn = this.win.console.error || fn;\n    } else if (level == LogLevel.INFO) {\n      fn = this.win.console.info || fn;\n    } else if (level == LogLevel.WARN) {\n      fn = this.win.console.warn || fn;\n    }\n    const args = this.maybeExpandMessageArgs_(messages);\n    // Prefix console message with \"[tag]\".\n    const prefix = `[${tag}]`;\n    if (typeof args[0] === 'string') {\n      // Prepend string to avoid breaking string substitutions e.g. %s.\n      args[0] = prefix + ' ' + args[0];\n    } else {\n      args.unshift(prefix);\n    }\n    fn.apply(this.win.console, args);\n    return true;\n  }\n\n  /**\n   * Whether the logging is enabled.\n   * @return {boolean}\n   */\n  isEnabled() {\n    return this.getLevel_() != LogLevel.OFF;\n  }\n\n  /**\n   * Reports a fine-grained message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  fine(tag, ...args) {\n    this.msg_(tag, LogLevel.FINE, args);\n  }\n\n  /**\n   * Reports a informational message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  info(tag, ...args) {\n    this.msg_(tag, LogLevel.INFO, args);\n  }\n\n  /**\n   * Reports a warning message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  warn(tag, ...args) {\n    this.msg_(tag, LogLevel.WARN, args);\n  }\n\n  /**\n   * Reports an error message. If the logging is disabled, the error is rethrown\n   * asynchronously.\n   * @param {string} tag\n   * @param {...*} args\n   * @return {!Error|undefined}\n   * @private\n   */\n  error_(tag, ...args) {\n    if (!this.msg_(tag, LogLevel.ERROR, args)) {\n      return this.createError.apply(this, args);\n    }\n  }\n\n  /**\n   * Reports an error message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  error(tag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      // TODO(rcebulko): Determine if/how this Error#name property is used.\n      error.name = tag || error.name;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Reports an error message and marks with an expected property. If the\n   * logging is disabled, the error is rethrown asynchronously.\n   * @param {string} unusedTag\n   * @param {...*} var_args\n   */\n  expectedError(unusedTag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      error.expected = true;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Creates an error object.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    return error;\n  }\n\n  /**\n   * Creates an error object with its expected property set to true.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createExpectedError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    error.expected = true;\n    return error;\n  }\n\n  /**\n   * Throws an error if the first argument isn't trueish.\n   *\n   * Supports argument substitution into the message via %s placeholders.\n   *\n   * Throws an error object that has two extra properties:\n   * - associatedElement: This is the first element provided in the var args.\n   *   It can be used for improved display of error messages.\n   * - messageArray: The elements of the substituted message as non-stringified\n   *   elements in an array. When e.g. passed to console.error this yields\n   *   native displays of things like HTML elements.\n   *\n   * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n   *     not evaluate to true.\n   * @param {!Array|string=} opt_message The assertion message\n   * @param {...*} var_args Arguments substituted into %s in the message.\n   * @return {T} The value of shouldBeTrueish.\n   * @throws {!Error} When `value` is falsey.\n   * @template T\n   * @closurePrimitive {asserts.truthy}\n   */\n  assert(shouldBeTrueish, opt_message, var_args) {\n    if (isArray(opt_message)) {\n      return this.assert.apply(\n        this,\n        [shouldBeTrueish].concat(\n          this.expandMessageArgs_(/** @type {!Array} */ (opt_message))\n        )\n      );\n    }\n\n    return assertions.assert.apply(\n      null,\n      [this.suffix_].concat(Array.prototype.slice.call(arguments))\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't an Element\n   *\n   * Otherwise see `assert` for usage\n   *\n   * @param {*} shouldBeElement\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Element} The value of shouldBeTrueish.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertElement(shouldBeElement, opt_message) {\n    return assertions.assertElement(\n      this.boundAssertFn_,\n      shouldBeElement,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a string. The string can\n   * be empty.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeString\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {string} The string value. Can be an empty string.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertString(shouldBeString, opt_message) {\n    return assertions.assertString(\n      this.boundAssertFn_,\n      shouldBeString,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a number. The allowed values\n   * include `0` and `NaN`.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeNumber\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {number} The number value. The allowed values include `0`\n   *   and `NaN`.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertNumber(shouldBeNumber, opt_message) {\n    return assertions.assertNumber(\n      this.boundAssertFn_,\n      shouldBeNumber,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument is not an array.\n   * The array can be empty.\n   *\n   * @param {*} shouldBeArray\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Array} The array value\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertArray(shouldBeArray, opt_message) {\n    return assertions.assertArray(\n      this.boundAssertFn_,\n      shouldBeArray,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a boolean.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeBoolean\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {boolean} The boolean value.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertBoolean(shouldBeBoolean, opt_message) {\n    return assertions.assertBoolean(\n      this.boundAssertFn_,\n      shouldBeBoolean,\n      opt_message\n    );\n  }\n\n  /**\n   * @param {!Error} error\n   * @private\n   */\n  prepareError_(error) {\n    error = duplicateErrorIfNecessary(error);\n\n    if (this.suffix_) {\n      if (!error.message) {\n        error.message = this.suffix_;\n      } else if (error.message.indexOf(this.suffix_) == -1) {\n        error.message += this.suffix_;\n      }\n    } else if (isUserErrorMessage(error.message)) {\n      error.message = error.message.replace(USER_ERROR_SENTINEL, '');\n    }\n  }\n\n  /**\n   * @param {!Array} args\n   * @return {!Array}\n   * @private\n   */\n  maybeExpandMessageArgs_(args) {\n    if (isArray(args[0])) {\n      return this.expandMessageArgs_(/** @type {!Array} */ (args[0]));\n    }\n    return args;\n  }\n\n  /**\n   * Either redirects a pair of (errorId, ...args) to a URL where the full\n   * message is displayed, or displays it from a fetched table.\n   *\n   * This method is used by the output of the `transform-log-methods` babel\n   * plugin. It should not be used directly. Use the (*error|assert*|info|warn)\n   * methods instead.\n   *\n   * @param {!Array} parts\n   * @return {!Array}\n   * @private\n   */\n  expandMessageArgs_(parts) {\n    // First value should exist.\n    const id = parts.shift();\n    // Best effort fetch of message template table.\n    // Since this is async, the first few logs might be indirected to a URL even\n    // if in development mode. Message table is ~small so this should be a short\n    // gap.\n    if (getMode(this.win).development) {\n      this.fetchExternalMessagesOnce_();\n    }\n    if (this.messages_ && id in this.messages_) {\n      return [this.messages_[id]].concat(parts);\n    }\n    return [`More info at ${externalMessageUrl(id, parts)}`];\n  }\n}\n\n/**\n * Cache for logs. We do not use a Service since the service module depends\n * on Log and closure literally can't even.\n * @type {{user: ?Log, dev: ?Log, userForEmbed: ?Log}}\n */\nself.__AMP_LOG = self.__AMP_LOG || {\n  user: null,\n  dev: null,\n  userForEmbed: null,\n};\n\nconst logs = self.__AMP_LOG;\n\n/**\n * Eventually holds a constructor for Log objects. Lazily initialized, so we\n * can avoid ever referencing the real constructor except in JS binaries\n * that actually want to include the implementation.\n * @type {?typeof Log}\n */\nlet logConstructor = null;\n\n/**\n * Initializes log constructor.\n */\nexport function initLogConstructor() {\n  logConstructor = Log;\n  // Initialize instances for use. If a binary (an extension for example) that\n  // does not call `initLogConstructor` invokes `dev()` or `user()` earlier than\n  // the binary that does call `initLogConstructor` (amp.js), the extension will\n  // throw an error as that extension will never be able to initialize the log\n  // instances and we also don't want it to call `initLogConstructor` either\n  // (since that will cause the Log implementation to be bundled into that\n  // binary). So we must initialize the instances eagerly so that they are ready\n  // for use (stored globally) after the main binary calls `initLogConstructor`.\n  dev();\n  user();\n}\n\n/**\n * Resets log constructor for testing.\n */\nexport function resetLogConstructorForTesting() {\n  logConstructor = null;\n}\n\n/**\n * Publisher level log.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Development mode is enabled via `#development=1` or logging is explicitly\n *     enabled via `#log=D` where D >= 1.\n *  3. AMP.setLogLevel(D) is called, where D >= 1.\n *\n * @param {!Element=} opt_element\n * @return {!Log}\n */\nexport function user(opt_element) {\n  if (!logs.user) {\n    logs.user = getUserLogger(USER_ERROR_SENTINEL);\n  }\n  if (!isFromEmbed(logs.user.win, opt_element)) {\n    return logs.user;\n  } else {\n    if (logs.userForEmbed) {\n      return logs.userForEmbed;\n    }\n    return (logs.userForEmbed = getUserLogger(USER_ERROR_EMBED_SENTINEL));\n  }\n}\n\n/**\n * Getter for user logger\n * @param {string=} suffix\n * @return {!Log}\n */\nfunction getUserLogger(suffix) {\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return new logConstructor(\n    self,\n    (logNum, development) => {\n      if (development || logNum >= 1) {\n        return LogLevel.FINE;\n      }\n      return LogLevel.WARN;\n    },\n    suffix\n  );\n}\n\n/**\n * AMP development log. Calls to `devLog().assert` and `dev.fine` are stripped\n * in the PROD binary. However, `devLog().assert` result is preserved in either\n * case.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Logging is explicitly enabled via `#log=D`, where D >= 2.\n *  3. AMP.setLogLevel(D) is called, where D >= 2.\n *\n * @return {!Log}\n */\nexport function dev() {\n  if (logs.dev) {\n    return logs.dev;\n  }\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return (logs.dev = new logConstructor(self, (logNum) => {\n    if (logNum >= 3) {\n      return LogLevel.FINE;\n    }\n    if (logNum >= 2) {\n      return LogLevel.INFO;\n    }\n    return LogLevel.OFF;\n  }));\n}\n\n/**\n * @param {!Window} win\n * @param {!Element=} opt_element\n * @return {boolean} isEmbed\n */\nexport function isFromEmbed(win, opt_element) {\n  if (!opt_element) {\n    return false;\n  }\n  return opt_element.ownerDocument.defaultView != win;\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function devAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (getMode().minified) {\n    return shouldBeTrueish;\n  }\n  if (self.__AMP_ASSERTION_CHECK) {\n    // This will never execute regardless, but will be included on unminified\n    // builds. It will be DCE'd away from minified builds, and so can be used to\n    // validate that Babel is properly removing dev assertions in minified\n    // builds.\n    console /*OK*/\n      .log('__devAssert_sentinel__');\n  }\n\n  return dev()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function userAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  return user()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {LruCache} from './core/data-structures/lru-cache';\nimport {dict, hasOwn} from './core/types/object';\nimport {endsWith} from './core/types/string';\nimport {getMode} from './mode';\nimport {isArray} from './core/types';\nimport {parseQueryString} from './core/types/string/url';\nimport {urls} from './config';\nimport {userAssert} from './log';\n\n/**\n * @type {!JsonObject}\n */\nconst SERVING_TYPE_PREFIX = dict({\n  // No viewer\n  'c': true,\n  // In viewer\n  'v': true,\n  // Ad landing page\n  'a': true,\n  // Ad\n  'ad': true,\n});\n\n/**\n * Cached a-tag to avoid memory allocation during URL parsing.\n * @type {HTMLAnchorElement}\n */\nlet a;\n\n/**\n * We cached all parsed URLs. As of now there are no use cases\n * of AMP docs that would ever parse an actual large number of URLs,\n * but we often parse the same one over and over again.\n * @type {LruCache}\n */\nlet cache;\n\n/** @private @const Matches amp_js_* parameters in query string. */\nconst AMP_JS_PARAMS_REGEX = /[?&]amp_js[^&]*/;\n\n/** @private @const Matches amp_gsa parameters in query string. */\nconst AMP_GSA_PARAMS_REGEX = /[?&]amp_gsa[^&]*/;\n\n/** @private @const Matches amp_r parameters in query string. */\nconst AMP_R_PARAMS_REGEX = /[?&]amp_r[^&]*/;\n\n/** @private @const Matches amp_kit parameters in query string. */\nconst AMP_KIT_PARAMS_REGEX = /[?&]amp_kit[^&]*/;\n\n/** @private @const Matches usqp parameters from goog experiment in query string. */\nconst GOOGLE_EXPERIMENT_PARAMS_REGEX = /[?&]usqp[^&]*/;\n\nconst INVALID_PROTOCOLS = [\n  /*eslint no-script-url: 0*/ 'javascript:',\n  /*eslint no-script-url: 0*/ 'data:',\n  /*eslint no-script-url: 0*/ 'vbscript:',\n];\n\n/** @const {string} */\nexport const SOURCE_ORIGIN_PARAM = '__amp_source_origin';\n\n/**\n * Returns the correct origin for a given window.\n * @param {!Window} win\n * @return {string} origin\n */\nexport function getWinOrigin(win) {\n  return win.origin || parseUrlDeprecated(win.location.href).origin;\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {string} url\n * @param {boolean=} opt_nocache\n *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n * @return {!Location}\n */\nexport function parseUrlDeprecated(url, opt_nocache) {\n  if (!a) {\n    a = /** @type {!HTMLAnchorElement} */ (self.document.createElement('a'));\n    cache = IS_ESM\n      ? null\n      : self.__AMP_URL_CACHE || (self.__AMP_URL_CACHE = new LruCache(100));\n  }\n\n  return parseUrlWithA(a, url, IS_ESM || opt_nocache ? null : cache);\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {!HTMLAnchorElement} a\n * @param {string} url\n * @param {LruCache=} opt_cache\n *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n * @return {!Location}\n * @restricted\n */\nexport function parseUrlWithA(a, url, opt_cache) {\n  if (IS_ESM) {\n    a.href = '';\n    return /** @type {?} */ (new URL(url, a.href));\n  }\n\n  if (opt_cache && opt_cache.has(url)) {\n    return opt_cache.get(url);\n  }\n\n  a.href = url;\n\n  // IE11 doesn't provide full URL components when parsing relative URLs.\n  // Assigning to itself again does the trick #3449.\n  if (!a.protocol) {\n    a.href = a.href;\n  }\n\n  const info = /** @type {!Location} */ ({\n    href: a.href,\n    protocol: a.protocol,\n    host: a.host,\n    hostname: a.hostname,\n    port: a.port == '0' ? '' : a.port,\n    pathname: a.pathname,\n    search: a.search,\n    hash: a.hash,\n    origin: null, // Set below.\n  });\n\n  // Some IE11 specific polyfills.\n  // 1) IE11 strips out the leading '/' in the pathname.\n  if (info.pathname[0] !== '/') {\n    info.pathname = '/' + info.pathname;\n  }\n\n  // 2) For URLs with implicit ports, IE11 parses to default ports while\n  // other browsers leave the port field empty.\n  if (\n    (info.protocol == 'http:' && info.port == 80) ||\n    (info.protocol == 'https:' && info.port == 443)\n  ) {\n    info.port = '';\n    info.host = info.hostname;\n  }\n\n  // For data URI a.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n  let origin;\n  if (a.origin && a.origin != 'null') {\n    origin = a.origin;\n  } else if (info.protocol == 'data:' || !info.host) {\n    origin = info.href;\n  } else {\n    origin = info.protocol + '//' + info.host;\n  }\n  info.origin = origin;\n\n  // Freeze during testing to avoid accidental mutation.\n  const frozen = getMode().test && Object.freeze ? Object.freeze(info) : info;\n\n  if (opt_cache) {\n    opt_cache.put(url, frozen);\n  }\n\n  return frozen;\n}\n\n/**\n * Appends the string just before the fragment part (or optionally\n * to the front of the query string) of the URL.\n * @param {string} url\n * @param {string} paramString\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function appendEncodedParamStringToUrl(\n  url,\n  paramString,\n  opt_addToFront\n) {\n  if (!paramString) {\n    return url;\n  }\n  const mainAndFragment = url.split('#', 2);\n  const mainAndQuery = mainAndFragment[0].split('?', 2);\n\n  let newUrl =\n    mainAndQuery[0] +\n    (mainAndQuery[1]\n      ? opt_addToFront\n        ? `?${paramString}&${mainAndQuery[1]}`\n        : `?${mainAndQuery[1]}&${paramString}`\n      : `?${paramString}`);\n  newUrl += mainAndFragment[1] ? `#${mainAndFragment[1]}` : '';\n  return newUrl;\n}\n/**\n * Appends a query string field and value to a url. `key` and `value`\n * will be ran through `encodeURIComponent` before appending.\n * @param {string} url\n * @param {string} key\n * @param {string} value\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function addParamToUrl(url, key, value, opt_addToFront) {\n  const field = `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;\n  return appendEncodedParamStringToUrl(url, field, opt_addToFront);\n}\n\n/**\n * Appends query string fields and values to a url. The `params` objects'\n * `key`s and `value`s will be transformed into query string keys/values.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addParamsToUrl(url, params) {\n  return appendEncodedParamStringToUrl(url, serializeQueryString(params));\n}\n\n/**\n * Append query string fields and values to a url, only if the key does not\n * exist in current query string.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addMissingParamsToUrl(url, params) {\n  const location = parseUrlDeprecated(url);\n  const existingParams = parseQueryString(location.search);\n  const paramsToAdd = dict({});\n  const keys = Object.keys(params);\n  for (let i = 0; i < keys.length; i++) {\n    if (!hasOwn(existingParams, keys[i])) {\n      paramsToAdd[keys[i]] = params[keys[i]];\n    }\n  }\n  return addParamsToUrl(url, paramsToAdd);\n}\n\n/**\n * Serializes the passed parameter map into a query string with both keys\n * and values encoded.\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function serializeQueryString(params) {\n  const s = [];\n  for (const k in params) {\n    const v = params[k];\n    if (v == null) {\n      continue;\n    } else if (isArray(v)) {\n      for (let i = 0; i < v.length; i++) {\n        const sv = /** @type {string} */ (v[i]);\n        s.push(`${encodeURIComponent(k)}=${encodeURIComponent(sv)}`);\n      }\n    } else {\n      const sv = /** @type {string} */ (v);\n      s.push(`${encodeURIComponent(k)}=${encodeURIComponent(sv)}`);\n    }\n  }\n  return s.join('&');\n}\n\n/**\n * Returns `true` if the URL is secure: either HTTPS or localhost (for testing).\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isSecureUrlDeprecated(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return (\n    url.protocol == 'https:' ||\n    url.hostname == 'localhost' ||\n    url.hostname == '127.0.0.1' ||\n    endsWith(url.hostname, '.localhost')\n  );\n}\n\n/**\n * Asserts that a given url is HTTPS or protocol relative. It's a user-level\n * assert.\n *\n * Provides an exception for localhost.\n *\n * @param {?string|undefined} urlString\n * @param {!Element|string} elementContext Element where the url was found.\n * @param {string=} sourceName Used for error messages.\n * @return {string}\n */\nexport function assertHttpsUrl(\n  urlString,\n  elementContext,\n  sourceName = 'source'\n) {\n  userAssert(\n    urlString != null,\n    '%s %s must be available',\n    elementContext,\n    sourceName\n  );\n  // (erwinm, #4560): type cast necessary until #4560 is fixed.\n  const theUrlString = /** @type {string} */ (urlString);\n  userAssert(\n    isSecureUrlDeprecated(theUrlString) || /^(\\/\\/)/.test(theUrlString),\n    '%s %s must start with ' +\n      '\"https://\" or \"//\" or be relative and served from ' +\n      'either https or from localhost. Invalid value: %s',\n    elementContext,\n    sourceName,\n    theUrlString\n  );\n  return theUrlString;\n}\n\n/**\n * Asserts that a given url is an absolute HTTP or HTTPS URL.\n * @param {string} urlString\n * @return {string}\n */\nexport function assertAbsoluteHttpOrHttpsUrl(urlString) {\n  userAssert(\n    /^https?\\:/i.test(urlString),\n    'URL must start with \"http://\" or \"https://\". Invalid value: %s',\n    urlString\n  );\n  return parseUrlDeprecated(urlString).href;\n}\n\n/**\n * Returns the URL without fragment. If URL doesn't contain fragment, the same\n * string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function removeFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return url;\n  }\n  return url.substring(0, index);\n}\n\n/**\n * Returns the fragment from the URL. If the URL doesn't contain fragment,\n * the empty string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function getFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return '';\n  }\n  return url.substring(index);\n}\n\n/**\n * Returns whether the URL has the origin of a proxy.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isProxyOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return urls.cdnProxyRegex.test(url.origin);\n}\n\n/**\n * @param {string} uri\n * @return {boolean}\n */\nexport function isAmpScriptUri(uri) {\n  return uri.startsWith('amp-script:');\n}\n\n/**\n * For proxy-origin URLs, returns the serving type. Otherwise, returns null.\n * E.g., 'https://amp-com.cdn.ampproject.org/a/s/amp.com/amp_document.html'\n * returns 'a'.\n * @param {string|!Location} url URL of an AMP document.\n * @return {?string}\n */\nexport function getProxyServingType(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  if (!isProxyOrigin(url)) {\n    return null;\n  }\n  const path = url.pathname.split('/', 2);\n  return path[1];\n}\n\n/**\n * Returns whether the URL origin is localhost.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isLocalhostOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return urls.localhostRegex.test(url.origin);\n}\n\n/**\n * Returns whether the URL has valid protocol.\n * Deep link protocol is valid, but not javascript etc.\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isProtocolValid(url) {\n  if (!url) {\n    return true;\n  }\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return !INVALID_PROTOCOLS.includes(url.protocol);\n}\n\n/**\n * Returns a URL without AMP JS parameters.\n * @param {string} url\n * @return {string}\n */\nexport function removeAmpJsParamsFromUrl(url) {\n  const parsed = parseUrlDeprecated(url);\n  const search = removeAmpJsParamsFromSearch(parsed.search);\n  return parsed.origin + parsed.pathname + search + parsed.hash;\n}\n\n/**\n * Returns a URL without a query string.\n * @param {string} url\n * @return {string}\n */\nexport function removeSearch(url) {\n  const index = url.indexOf('?');\n  if (index == -1) {\n    return url;\n  }\n  const fragment = getFragment(url);\n  return url.substring(0, index) + fragment;\n}\n\n/**\n * Removes parameters that start with amp js parameter pattern and returns the\n * new search string.\n * @param {string} urlSearch\n * @return {string}\n */\nfunction removeAmpJsParamsFromSearch(urlSearch) {\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const search = urlSearch\n    .replace(AMP_JS_PARAMS_REGEX, '')\n    .replace(AMP_GSA_PARAMS_REGEX, '')\n    .replace(AMP_R_PARAMS_REGEX, '')\n    .replace(AMP_KIT_PARAMS_REGEX, '')\n    .replace(GOOGLE_EXPERIMENT_PARAMS_REGEX, '')\n    .replace(/^[?&]/, ''); // Removes first ? or &.\n  return search ? '?' + search : '';\n}\n\n/**\n * Removes parameters with param name and returns the new search string.\n * @param {string} urlSearch\n * @param {string} paramName\n * @return {string}\n */\nexport function removeParamsFromSearch(urlSearch, paramName) {\n  // TODO: reuse the function in removeAmpJsParamsFromSearch. Accept paramNames\n  // as an array.\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const paramRegex = new RegExp(`[?&]${paramName}=[^&]*`, 'g');\n  const search = urlSearch.replace(paramRegex, '').replace(/^[?&]/, '');\n  return search ? '?' + search : '';\n}\n\n/**\n * Returns the source URL of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string}\n */\nexport function getSourceUrl(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n\n  // Not a proxy URL - return the URL itself.\n  if (!isProxyOrigin(url)) {\n    return url.href;\n  }\n\n  // A proxy URL.\n  // Example path that is being matched here.\n  // https://cdn.ampproject.org/c/s/www.origin.com/foo/\n  // The /s/ is optional and signals a secure origin.\n  const path = url.pathname.split('/');\n  const prefix = path[1];\n  userAssert(\n    SERVING_TYPE_PREFIX[prefix],\n    'Unknown path prefix in url %s',\n    url.href\n  );\n  const domainOrHttpsSignal = path[2];\n  const origin =\n    domainOrHttpsSignal == 's'\n      ? 'https://' + decodeURIComponent(path[3])\n      : 'http://' + decodeURIComponent(domainOrHttpsSignal);\n  // Sanity test that what we found looks like a domain.\n  userAssert(origin.indexOf('.') > 0, 'Expected a . in origin %s', origin);\n  path.splice(1, domainOrHttpsSignal == 's' ? 3 : 2);\n  return (\n    origin +\n    path.join('/') +\n    removeAmpJsParamsFromSearch(url.search) +\n    (url.hash || '')\n  );\n}\n\n/**\n * Returns the source origin of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string} The source origin of the URL.\n */\nexport function getSourceOrigin(url) {\n  return parseUrlDeprecated(getSourceUrl(url)).origin;\n}\n\n/**\n * Returns absolute URL resolved based on the relative URL and the base.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n */\nexport function resolveRelativeUrl(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n  if (IS_ESM || typeof URL == 'function') {\n    return new URL(relativeUrlString, baseUrl.href).toString();\n  }\n  return resolveRelativeUrlFallback_(relativeUrlString, baseUrl);\n}\n\n/**\n * Fallback for URL resolver when URL class is not available.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n * @private @visibleForTesting\n */\nexport function resolveRelativeUrlFallback_(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n  relativeUrlString = relativeUrlString.replace(/\\\\/g, '/');\n  const relativeUrl = parseUrlDeprecated(relativeUrlString);\n\n  // Absolute URL.\n  if (relativeUrlString.toLowerCase().startsWith(relativeUrl.protocol)) {\n    return relativeUrl.href;\n  }\n\n  // Protocol-relative URL.\n  if (relativeUrlString.startsWith('//')) {\n    return baseUrl.protocol + relativeUrlString;\n  }\n\n  // Absolute path.\n  if (relativeUrlString.startsWith('/')) {\n    return baseUrl.origin + relativeUrlString;\n  }\n\n  // Relative path.\n  return (\n    baseUrl.origin +\n    baseUrl.pathname.replace(/\\/[^/]*$/, '/') +\n    relativeUrlString\n  );\n}\n\n/**\n * Add \"__amp_source_origin\" query parameter to the URL.\n * @param {!Window} win\n * @param {string} url\n * @return {string}\n */\nexport function getCorsUrl(win, url) {\n  checkCorsUrl(url);\n  const sourceOrigin = getSourceOrigin(win.location.href);\n  return addParamToUrl(url, SOURCE_ORIGIN_PARAM, sourceOrigin);\n}\n\n/**\n * Checks if the url has __amp_source_origin and throws if it does.\n * @param {string} url\n */\nexport function checkCorsUrl(url) {\n  const parsedUrl = parseUrlDeprecated(url);\n  const query = parseQueryString(parsedUrl.search);\n  userAssert(\n    !(SOURCE_ORIGIN_PARAM in query),\n    'Source origin is not allowed in %s',\n    url\n  );\n}\n\n/**\n * Adds the path to the given url.\n *\n * @param {!Location} url\n * @param {string} path\n * @return {string}\n */\nexport function appendPathToUrl(url, path) {\n  const pathname = url.pathname.replace(/\\/?$/, '/') + path.replace(/^\\//, '');\n  return url.origin + pathname + url.search + url.hash;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Magic constant that is replaced by babel.\n// IS_MINIFIED is always replaced with true when closure compiler is used\nconst IS_MINIFIED = false;\n\n/**\n * Returns true whenever closure compiler is used.\n * @return {boolean}\n */\nexport function isMinifiedMode() {\n  return IS_MINIFIED;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assertions from './base';\nimport {isMinifiedMode} from '../minified-mode';\n\n/**\n * @fileoverview This file provides the entrypoint for dev assertions. It's\n * designed so all functions are pure function calls to improve inlining. All\n * functions in this file get DCE'd away during compilation.\n */\n\n/**\n * This will never execute regardless, but will be included on unminified builds\n * builds. It will be DCE'd away from minified builds, and so can be used to\n * validate that Babel is properly removing dev assertions in minified builds.\n */\nfunction devAssertDceCheck() {\n  if (self.__AMP_ASSERTION_CHECK) {\n    console /*OK*/\n      .log('__devAssert_sentinel__');\n  }\n}\n\n/**\n * Throws an error if the first argument isn't trueish. Mirrors devAssert in\n * src/log.js.\n * @param {T} shouldBeTruthy\n * @param {string=} opt_message\n * @param {*=} opt_1 Optional argument (var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T}\n * @template T\n * @throws {Error} when shouldBeTruthy is not truthy.\n * @closurePrimitive {asserts.truthy}\n */\nexport function devAssert(\n  shouldBeTruthy,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (isMinifiedMode()) {\n    return shouldBeTruthy;\n  }\n  devAssertDceCheck();\n\n  return assertions.assert(\n    '',\n    shouldBeTruthy,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't an Element.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeElement\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Element} The value of shouldBeTrueish.\n * @throws {Error} when shouldBeElement is not an Element\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertElement(shouldBeElement, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {!Element} */ (shouldBeElement);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertElement(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeElement,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a string. The string can\n * be empty.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeString\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {string} The string value. Can be an empty string.\n * @throws {Error} when shouldBeString is not an String\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertString(shouldBeString, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {string} */ (shouldBeString);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertString(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeString,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a number. The allowed values\n * include `0` and `NaN`.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeNumber\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {number} The number value. The allowed values include `0`\n *   and `NaN`.\n * @throws {Error} when shouldBeNumber is not an Number\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertNumber(shouldBeNumber, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {number} */ (shouldBeNumber);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertNumber(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeNumber,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument is not an array.\n * The array can be empty.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeArray\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Array} The array value\n * @throws {Error} when shouldBeArray is not an Array\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertArray(shouldBeArray, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {!Array} */ (shouldBeArray);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertArray(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeArray,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a boolean.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeBoolean\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {boolean} The boolean value.\n * @throws {Error} when shouldBeBoolean is not an Boolean\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertBoolean(shouldBeBoolean, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {boolean} */ (shouldBeBoolean);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertBoolean(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeBoolean,\n    opt_message\n  );\n}\n", "/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */\n\n\n/**\n * This regex consists of 4 matching capture groups and one (non-matching) fallback:\n *\n * - (\\0), catch the null terminator character so it may be replaced by UTF\n *   Replacement Char\n * - ^(-)$, catch a solitary dash char, so that it may be backslash escaped.\n *   This is a separate capture group so that the legal-chars (group 4) doesn't\n *   capture it first, since that group doesn't need to escape its dash.\n * - ([\\x01-\\x1f\\x7f]|^-?[0-9]), catch a UTF control char, or any leading\n *   number (with an optional leading dash). The control or the number (but not\n *   the leading dash) must be hex-escaped,.\n * - ([\\x80-\\uffff0-9a-zA-Z_-]+), catch legal-chars, with the exception of a\n *   solitary dash, which will already have matched in group 1.\n * - [^], finally, a catch-all that allows us to backslash escape the char.\n *\n * Together, this matches everything necessary for CSS.escape.\n */\nvar regex = /(\\0)|^(-)$|([\\x01-\\x1f\\x7f]|^-?[0-9])|([\\x80-\\uffff0-9a-zA-Z_-]+)|[^]/g;\n\nfunction escaper(match, nil, dash, hexEscape, chars) {\n  // Chars is the legal-chars (group 4) capture\n  if (chars) {\n    return chars;\n  }\n  // Nil is the null terminator (group 1) capture\n  if (nil) {\n    return '\\uFFFD';\n  }\n  // Both UTF control chars, and leading numbers (with optional leading dash)\n  // (group 3) must be backslash escaped with a trailing space.  Funnily, the\n  // leading dash must not be escaped, but the number. :shrug:\n  if (hexEscape) {\n    return match.slice(0, -1) + '\\\\' + match.slice(-1).charCodeAt(0).toString(16) + ' '\n  }\n  // Finally, the solitary dash and the catch-all chars require backslash\n  // escaping.\n  return '\\\\' + match;\n}\n\n/**\n * https://drafts.csswg.org/cssom/#serialize-an-identifier\n * @param {string} value\n * @return {string}\n */\nexport function cssEscape(value) {\n  return String(value).replace(regex, escaper);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {dev, devAssert} from './log';\nimport {dict} from './core/types/object';\nimport {includes} from './core/types/string';\nimport {matches} from './core/dom/query';\nimport {toWin} from './core/window';\n\nconst HTML_ESCAPE_CHARS = {\n  '&': '&amp;',\n  '<': '&lt;',\n  '>': '&gt;',\n  '\"': '&quot;',\n  \"'\": '&#x27;',\n  '`': '&#x60;',\n};\nconst HTML_ESCAPE_REGEX = /(&|<|>|\"|'|`)/g;\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_PROMISE = '__AMP_UPG_PRM';\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_RESOLVER = '__AMP_UPG_RES';\n\n/**\n * @typedef {{\n *   bubbles: (boolean|undefined),\n *   cancelable: (boolean|undefined),\n * }}\n */\nexport let CustomEventOptionsDef;\n\n/** @const {!CustomEventOptionsDef} */\nconst DEFAULT_CUSTOM_EVENT_OPTIONS = {bubbles: true, cancelable: true};\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * callback is executed.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @param {function()} callback\n * @suppress {suspiciousCode}\n */\nexport function waitForChild(parent, checkFunc, callback) {\n  if (checkFunc(parent)) {\n    callback();\n    return;\n  }\n  /** @const {!Window} */\n  const win = toWin(parent.ownerDocument.defaultView);\n  if (IS_ESM || win.MutationObserver) {\n    /** @const {MutationObserver} */\n    const observer = new win.MutationObserver(() => {\n      if (checkFunc(parent)) {\n        observer.disconnect();\n        callback();\n      }\n    });\n    observer.observe(parent, {childList: true});\n  } else {\n    /** @const {number} */\n    const interval = win.setInterval(() => {\n      if (checkFunc(parent)) {\n        win.clearInterval(interval);\n        callback();\n      }\n    }, /* milliseconds */ 5);\n  }\n}\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * promise is resolved.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @return {!Promise}\n */\nexport function waitForChildPromise(parent, checkFunc) {\n  return new Promise((resolve) => {\n    waitForChild(parent, checkFunc, resolve);\n  });\n}\n\n/**\n * Waits for document's body to be available and ready.\n * @param {!Document} doc\n * @param {function()} callback\n */\nexport function waitForBodyOpen(doc, callback) {\n  waitForChild(doc.documentElement, () => !!doc.body, callback);\n}\n\n/**\n * Waits for document's body to be available.\n * @param {!Document} doc\n * @return {!Promise}\n */\nexport function waitForBodyOpenPromise(doc) {\n  return new Promise((resolve) => waitForBodyOpen(doc, resolve));\n}\n\n/**\n * Removes the element.\n * @param {!Element} element\n */\nexport function removeElement(element) {\n  if (element.parentElement) {\n    element.parentElement.removeChild(element);\n  }\n}\n\n/**\n * Removes all child nodes of the specified element.\n * @param {!Element|!DocumentFragment} parent\n */\nexport function removeChildren(parent) {\n  while (parent.firstChild) {\n    parent.removeChild(parent.firstChild);\n  }\n}\n\n/**\n * Copies all children nodes of element \"from\" to element \"to\". Child nodes\n * are deeply cloned. Notice, that this method should be used with care and\n * preferably on smaller subtrees.\n * @param {!Element} from\n * @param {!Element|!DocumentFragment} to\n */\nexport function copyChildren(from, to) {\n  const frag = to.ownerDocument.createDocumentFragment();\n  for (let n = from.firstChild; n; n = n.nextSibling) {\n    frag.appendChild(n.cloneNode(true));\n  }\n  to.appendChild(frag);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n * @param {?Node=} after\n */\nexport function insertAfterOrAtStart(root, element, after = null) {\n  if (!after) {\n    insertAtStart(root, element);\n    return;\n  }\n  const before = after.nextSibling;\n  root.insertBefore(element, before);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n */\nexport function insertAtStart(root, element) {\n  root.insertBefore(element, root.firstChild);\n}\n\n/**\n * Add attributes to an element.\n * @param {!Element} element\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function addAttributesToElement(element, attributes) {\n  for (const attr in attributes) {\n    element.setAttribute(attr, attributes[attr]);\n  }\n  return element;\n}\n\n/**\n * Create a new element on document with specified tagName and attributes.\n * @param {!Document} doc\n * @param {string} tagName\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function createElementWithAttributes(doc, tagName, attributes) {\n  const element = doc.createElement(tagName);\n  return addAttributesToElement(element, attributes);\n}\n\n/**\n * Returns true if node is connected (attached).\n * @param {!Node} node\n * @return {boolean}\n * @see https://dom.spec.whatwg.org/#connected\n */\nexport function isConnectedNode(node) {\n  const connected = node.isConnected;\n  if (connected !== undefined) {\n    return connected;\n  }\n\n  // \"An element is connected if its shadow-including root is a document.\"\n  let n = node;\n  do {\n    n = rootNodeFor(n);\n    if (n.host) {\n      n = n.host;\n    } else {\n      break;\n    }\n  } while (true);\n  return n.nodeType === Node.DOCUMENT_NODE;\n}\n\n/**\n * Returns the root for a given node. Does not cross shadow DOM boundary.\n * @param {!Node} node\n * @return {!Node}\n */\nexport function rootNodeFor(node) {\n  if (Node.prototype.getRootNode) {\n    // Type checker says `getRootNode` may return null.\n    return node.getRootNode() || node;\n  }\n  let n;\n  // Check isShadowRoot() is only needed for the polyfill case.\n  for (\n    n = node;\n    !!n.parentNode && !isShadowRoot(/** @type {HTMLElement} */ (n));\n    n = n.parentNode\n  ) {}\n  return n;\n}\n\n/**\n * Determines if value is actually a `ShadowRoot` node.\n * @param {HTMLElement} value\n * @return {boolean}\n */\nexport function isShadowRoot(value) {\n  if (!value) {\n    return false;\n  }\n  // Node.nodeType == DOCUMENT_FRAGMENT to speed up the tests. Unfortunately,\n  // nodeType of DOCUMENT_FRAGMENT is used currently for ShadowRoot nodes.\n  if (value.tagName == 'I-AMPHTML-SHADOW-ROOT') {\n    return true;\n  }\n  return (\n    value.nodeType == /* DOCUMENT_FRAGMENT */ 11 &&\n    Object.prototype.toString.call(value) === '[object ShadowRoot]'\n  );\n}\n\n/**\n * Returns element data-param- attributes as url parameters key-value pairs.\n * e.g. data-param-some-attr=value -> {someAttr: value}.\n * @param {!HTMLElement} element\n * @param {function(string):string=} opt_computeParamNameFunc to compute the\n *    parameter name, get passed the camel-case parameter name.\n * @param {!RegExp=} opt_paramPattern Regex pattern to match data attributes.\n * @return {!JsonObject}\n */\nexport function getDataParamsFromAttributes(\n  element,\n  opt_computeParamNameFunc,\n  opt_paramPattern\n) {\n  const computeParamNameFunc = opt_computeParamNameFunc || ((key) => key);\n  const {dataset} = element;\n  const params = dict();\n  const paramPattern = opt_paramPattern ? opt_paramPattern : /^param(.+)/;\n  for (const key in dataset) {\n    const matches = key.match(paramPattern);\n    if (matches) {\n      const param = matches[1][0].toLowerCase() + matches[1].substr(1);\n      params[computeParamNameFunc(param)] = dataset[key];\n    }\n  }\n  return params;\n}\n\n/**\n * Whether the element have a next node in the document order.\n * This means either:\n *  a. The element itself has a nextSibling.\n *  b. Any of the element ancestors has a nextSibling.\n * @param {!Element} element\n * @param {?Node} opt_stopNode\n * @return {boolean}\n */\nexport function hasNextNodeInDocumentOrder(element, opt_stopNode) {\n  let currentElement = element;\n  do {\n    if (currentElement.nextSibling) {\n      return true;\n    }\n  } while (\n    (currentElement = currentElement.parentNode) &&\n    currentElement != opt_stopNode\n  );\n  return false;\n}\n\n/**\n * Returns a clone of the content of a template element.\n *\n * Polyfill to replace .content access for browsers that do not support\n * HTMLTemplateElements natively.\n *\n * @param {!HTMLTemplateElement|!Element} template\n * @return {!DocumentFragment}\n */\nexport function templateContentClone(template) {\n  if ('content' in template) {\n    return template.content.cloneNode(true);\n  } else {\n    const content = template.ownerDocument.createDocumentFragment();\n    copyChildren(template, content);\n    return content;\n  }\n}\n\n/**\n * Iterate over an array-like.\n * Test cases: https://jsbench.github.io/#f638cacc866a1b2d6e517e6cfa900d6b\n * @param {!IArrayLike<T>} iterable\n * @param {function(T, number)} cb\n * @template T\n */\nexport function iterateCursor(iterable, cb) {\n  const {length} = iterable;\n  for (let i = 0; i < length; i++) {\n    cb(iterable[i], i);\n  }\n}\n\n/**\n * This method wraps around window's open method. It first tries to execute\n * `open` call with the provided target and if it fails, it retries the call\n * with the `_top` target. This is necessary given that in some embedding\n * scenarios, such as iOS' WKWebView, navigation to `_blank` and other targets\n * is blocked by default.\n *\n * @param {!Window} win\n * @param {string} url\n * @param {string} target\n * @param {string=} opt_features\n * @return {?Window}\n */\nexport function openWindowDialog(win, url, target, opt_features) {\n  // Try first with the specified target. If we're inside the WKWebView or\n  // a similar environments, this method is expected to fail by default for\n  // all targets except `_top`.\n  let res;\n  try {\n    res = win.open(url, target, opt_features);\n  } catch (e) {\n    dev().error('DOM', 'Failed to open url on target: ', target, e);\n  }\n\n  // Then try with `_top` target.\n  if (!res && target != '_top' && !includes(opt_features || '', 'noopener')) {\n    res = win.open(url, '_top');\n  }\n  return res;\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.hasAttribute('type') &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/JSON'\n  );\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonLdScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/LD+JSON'\n  );\n}\n\n/**\n * Whether the page's direction is right to left or not.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isRTL(doc) {\n  const dir =\n    doc.body.getAttribute('dir') ||\n    doc.documentElement.getAttribute('dir') ||\n    'ltr';\n  return dir == 'rtl';\n}\n\n/**\n * Escapes `<`, `>` and other HTML charcaters with their escaped forms.\n * @param {string} text\n * @return {string}\n */\nexport function escapeHtml(text) {\n  if (!text) {\n    return text;\n  }\n  return text.replace(HTML_ESCAPE_REGEX, escapeHtmlChar);\n}\n\n/**\n * @param {string} c\n * @return {string}\n */\nfunction escapeHtmlChar(c) {\n  return HTML_ESCAPE_CHARS[c];\n}\n\n/**\n * Tries to focus on the given element; fails silently if browser throws an\n * exception.\n * @param {!Element} element\n */\nexport function tryFocus(element) {\n  try {\n    element./*OK*/ focus();\n  } catch (e) {\n    // IE <= 7 may throw exceptions when focusing on hidden items.\n  }\n}\n\n/**\n * Whether the given window is in an iframe or not.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isIframed(win) {\n  return win.parent && win.parent != win;\n}\n\n/**\n * Determines if this element is an AMP element\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isAmpElement(element) {\n  const tag = element.tagName;\n  // Use prefix to recognize AMP element. This is necessary because stub\n  // may not be attached yet.\n  return (\n    tag.startsWith('AMP-') &&\n    // Some \"amp-*\" elements are not really AMP elements. :smh:\n    !(tag == 'AMP-STICKY-AD-TOP-PADDING' || tag == 'AMP-BODY')\n  );\n}\n\n/**\n * Return a promise that resolve when an AMP element upgrade from HTMLElement\n * to CustomElement\n * @param {!HTMLElement} element\n * @return {!Promise<!AmpElement>}\n */\nexport function whenUpgradedToCustomElement(element) {\n  devAssert(isAmpElement(element), 'element is not AmpElement');\n  if (element.createdCallback) {\n    // Element already is CustomElement;\n    return Promise.resolve(/**@type {!AmpElement} */ (element));\n  }\n  // If Element is still HTMLElement, wait for it to upgrade to customElement\n  // Note: use pure string to avoid obfuscation between versions.\n  if (!element[UPGRADE_TO_CUSTOMELEMENT_PROMISE]) {\n    const deferred = new Deferred();\n    element[UPGRADE_TO_CUSTOMELEMENT_PROMISE] = deferred.promise;\n    element[UPGRADE_TO_CUSTOMELEMENT_RESOLVER] = deferred.resolve;\n  }\n\n  return element[UPGRADE_TO_CUSTOMELEMENT_PROMISE];\n}\n\n/**\n * Returns true if node is not disabled.\n *\n * IE8 can return false positives, see {@link matches}.\n * @param {!HTMLInputElement} element\n * @return {boolean}\n * @see https://www.w3.org/TR/html5/forms.html#concept-fe-disabled\n */\nexport function isEnabled(element) {\n  return !(element.disabled || matches(element, ':disabled'));\n}\n\n/**\n * A sorting comparator that sorts elements in DOM tree order.\n * A first sibling is sorted to be before its nextSibling.\n * A parent node is sorted to be before a child.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/compareDocumentPosition\n *\n * @param {!Element} element1\n * @param {!Element} element2\n * @return {number}\n */\nexport function domOrderComparator(element1, element2) {\n  if (element1 === element2) {\n    return 0;\n  }\n\n  const pos = element1.compareDocumentPosition(element2);\n  const precedingOrContains =\n    Node.DOCUMENT_POSITION_PRECEDING | Node.DOCUMENT_POSITION_CONTAINS;\n\n  // if fe2 is preceding or contains fe1 then, fe1 is after fe2\n  if (pos & precedingOrContains) {\n    return 1;\n  }\n\n  // if fe2 is following or contained by fe1, then fe1 is before fe2\n  return -1;\n}\n\n/**\n * Like `Element.prototype.toggleAttribute`. This either toggles an attribute\n * on by adding an attribute with an empty value, or toggles it off by removing\n * the attribute. This does not mutate the element if the new state matches\n * the existing state.\n * @param {!Element} element An element to toggle the attribute for.\n * @param {string} name The name of the attribute.\n * @param {boolean=} forced Whether the attribute should be forced on/off. If\n *    not specified, it will be toggled from the current state.\n * @return {boolean} Whether or not the element now has the attribute.\n */\nexport function toggleAttribute(element, name, forced) {\n  const hasAttribute = element.hasAttribute(name);\n  const enabled = forced !== undefined ? forced : !hasAttribute;\n\n  if (enabled !== hasAttribute) {\n    if (enabled) {\n      element.setAttribute(name, '');\n    } else {\n      element.removeAttribute(name);\n    }\n  }\n\n  return enabled;\n}\n\n/**\n * Parses a string as a boolean value using the expanded rules for DOM boolean\n * attributes:\n * - a `null` or `undefined` returns `null`;\n * - an empty string returns `true`;\n * - a \"false\" string returns `false`;\n * - otherwise, `true` is returned.\n *\n * @param {?string|undefined} s\n * @return {boolean|undefined}\n */\nexport function parseBooleanAttribute(s) {\n  return s == null ? undefined : s !== 'false';\n}\n\n/**\n * @param {!Window} win\n * @return {number} The width of the vertical scrollbar, in pixels.\n */\nexport function getVerticalScrollbarWidth(win) {\n  const {documentElement} = win.document;\n  const windowWidth = win./*OK*/ innerWidth;\n  const documentWidth = documentElement./*OK*/ clientWidth;\n  return windowWidth - documentWidth;\n}\n\n/**\n * Dispatches a custom event.\n *\n * @param {!Node} node\n * @param {string} name\n * @param {!Object=} opt_data Event data.\n * @param {!CustomEventOptionsDef=} opt_options\n */\nexport function dispatchCustomEvent(node, name, opt_data, opt_options) {\n  const data = opt_data || {};\n  // Constructors of events need to come from the correct window. Sigh.\n  const event = node.ownerDocument.createEvent('Event');\n\n  // Technically .data is not a property of Event.\n  /**@type {?}*/ (event).data = data;\n\n  const {bubbles, cancelable} = opt_options || DEFAULT_CUSTOM_EVENT_OPTIONS;\n  event.initEvent(name, bubbles, cancelable);\n  node.dispatchEvent(event);\n}\n\n/**\n * Ensures the child is contained by the parent, but not the parent itself.\n *\n * @param {!Node} parent\n * @param {!Node} child\n * @return {boolean}\n */\nexport function containsNotSelf(parent, child) {\n  return child !== parent && parent.contains(child);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Note: loaded by 3p system. Cannot rely on babel polyfills.\nimport {dev, devAssert} from './log';\nimport {map} from './core/types/object';\n\n/** @type {Object<string, string>} */\nlet propertyNameCache;\n\n/** @const {!Array<string>} */\nconst vendorPrefixes = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n\nconst EMPTY_CSS_DECLARATION = /** @type {!CSSStyleDeclaration} */ ({\n  'getPropertyPriority': () => '',\n  'getPropertyValue': () => '',\n});\n\n/**\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\nexport function camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n\n/**\n  Checks the style if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} style\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\nfunction getVendorJsPropertyName_(style, titleCase) {\n  for (let i = 0; i < vendorPrefixes.length; i++) {\n    const propertyName = vendorPrefixes[i] + titleCase;\n    if (style[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n  return '';\n}\n\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @param {!Object} style\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} opt_bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\nexport function getVendorJsPropertyName(style, camelCase, opt_bypassCache) {\n  if (isVar(camelCase)) {\n    // CSS vars are returned as is.\n    return camelCase;\n  }\n  if (!propertyNameCache) {\n    propertyNameCache = map();\n  }\n  let propertyName = propertyNameCache[camelCase];\n  if (!propertyName || opt_bypassCache) {\n    propertyName = camelCase;\n    if (style[camelCase] === undefined) {\n      const titleCase = camelCaseToTitleCase(camelCase);\n      const prefixedPropertyName = getVendorJsPropertyName_(style, titleCase);\n\n      if (style[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n    if (!opt_bypassCache) {\n      propertyNameCache[camelCase] = propertyName;\n    }\n  }\n  return propertyName;\n}\n\n/**\n * Sets the CSS styles of the specified element with !important. The styles\n * are specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setImportantStyles(element, styles) {\n  const {style} = element;\n  for (const k in styles) {\n    style.setProperty(\n      getVendorJsPropertyName(style, k),\n      String(styles[k]),\n      'important'\n    );\n  }\n}\n\n/**\n * Sets the CSS style of the specified element with optional units, e.g. \"px\".\n * @param {?Element} element\n * @param {string} property\n * @param {*} value\n * @param {string=} opt_units\n * @param {boolean=} opt_bypassCache\n */\nexport function setStyle(element, property, value, opt_units, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return;\n  }\n  const styleValue = /** @type {string} */ (\n    opt_units ? value + opt_units : value\n  );\n  if (isVar(propertyName)) {\n    element.style.setProperty(propertyName, styleValue);\n  } else {\n    element.style[propertyName] = styleValue;\n  }\n}\n\n/**\n * Returns the value of the CSS style of the specified element.\n * @param {!Element} element\n * @param {string} property\n * @param {boolean=} opt_bypassCache\n * @return {*}\n */\nexport function getStyle(element, property, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return undefined;\n  }\n  if (isVar(propertyName)) {\n    return element.style.getPropertyValue(propertyName);\n  }\n  return element.style[propertyName];\n}\n\n/**\n * Sets the CSS styles of the specified element. The styles\n * a specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setStyles(element, styles) {\n  for (const k in styles) {\n    setStyle(element, k, styles[k]);\n  }\n}\n\n/**\n * Asserts that the style is not the `display` style.\n * This is the only possible way to pass a dynamic style to setStyle.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {string} style\n * @return {string}\n */\nexport function assertNotDisplay(style) {\n  if (style === 'display') {\n    dev().error(\n      'STYLE',\n      '`display` style detected. You must use toggle instead.'\n    );\n  }\n  return style;\n}\n\n/**\n * Asserts that the styles does not contain the `display` style.\n * This is the only possible way to pass a dynamic styles object to setStyles\n * and setImportantStyles.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {!Object<string, *>} styles\n * @return {!Object<string, *>}\n */\nexport function assertDoesNotContainDisplay(styles) {\n  if ('display' in styles) {\n    dev().error(\n      'STYLE',\n      '`display` style detected in styles. You must use toggle instead.'\n    );\n  }\n  return styles;\n}\n\n/**\n * Sets the initial display style of an element. This is a last resort. If you\n * can set the initial display using CSS, YOU MUST.\n * DO NOT USE THIS TO ARBITRARILY SET THE DISPLAY STYLE AFTER INITIAL SETUP.\n *\n * @param {!Element} el\n * @param {string} value\n */\nexport function setInitialDisplay(el, value) {\n  const {style} = el;\n  devAssert(\n    value !== '' && value !== 'none',\n    'Initial display value must not be \"none\". Use toggle instead.'\n  );\n  devAssert(\n    !style['display'],\n    'setInitialDisplay MUST NOT be used for ' +\n      'resetting the display style. If you are looking for display:none ' +\n      'toggling, use toggle instead.'\n  );\n  style['display'] = value;\n}\n\n/**\n * Shows or hides the specified element.\n * @param {!Element} element\n * @param {boolean=} opt_display\n */\nexport function toggle(element, opt_display) {\n  if (opt_display === undefined) {\n    opt_display = element.hasAttribute('hidden');\n  }\n  if (opt_display) {\n    element.removeAttribute('hidden');\n  } else {\n    element.setAttribute('hidden', '');\n  }\n}\n\n/**\n * Returns a pixel value.\n * @param {number} value\n * @return {string}\n */\nexport function px(value) {\n  return `${value}px`;\n}\n\n/**\n * Returns a degree value.\n * @param {number} value\n * @return {string}\n */\nexport function deg(value) {\n  return `${value}deg`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function translateX(value) {\n  if (typeof value == 'string') {\n    return `translateX(${value})`;\n  }\n  return `translateX(${px(value)})`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} x\n * @param {(number|string)=} opt_y\n * @return {string}\n */\nexport function translate(x, opt_y) {\n  if (typeof x == 'number') {\n    x = px(x);\n  }\n  if (opt_y === undefined) {\n    return `translate(${x})`;\n  }\n  if (typeof opt_y == 'number') {\n    opt_y = px(opt_y);\n  }\n  return `translate(${x}, ${opt_y})`;\n}\n\n/**\n * Returns a \"scale\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function scale(value) {\n  return `scale(${value})`;\n}\n\n/**\n * Returns a \"rotate\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function rotate(value) {\n  if (typeof value == 'number') {\n    value = deg(value);\n  }\n  return `rotate(${value})`;\n}\n\n/**\n * Remove alpha value from a rgba color value.\n * Return the new color property with alpha equals if has the alpha value.\n * Caller needs to make sure the input color value is a valid rgba/rgb value\n * @param {string} rgbaColor\n * @return {string}\n */\nexport function removeAlphaFromColor(rgbaColor) {\n  return rgbaColor.replace(\n    /\\(([^,]+),([^,]+),([^,)]+),[^)]+\\)/g,\n    '($1,$2,$3, 1)'\n  );\n}\n\n/**\n * Gets the computed style of the element. The helper is necessary to enforce\n * the possible `null` value returned by a buggy Firefox.\n *\n * @param {!Window} win\n * @param {!Element} el\n * @return {!CSSStyleDeclaration}\n */\nexport function computedStyle(win, el) {\n  const style = /** @type {?CSSStyleDeclaration} */ (win.getComputedStyle(el));\n  return style || EMPTY_CSS_DECLARATION;\n}\n\n/**\n * Resets styles that were set dynamically (i.e. inline)\n * @param {!Element} element\n * @param {!Array<string>} properties\n */\nexport function resetStyles(element, properties) {\n  for (let i = 0; i < properties.length; i++) {\n    setStyle(element, properties[i], null);\n  }\n}\n\n/**\n * Propagates the object-fit/position element attributes as styles.\n * @param {!Element} fromEl ie: amp-img\n * @param {!Element} toEl ie: the img within amp-img\n */\nexport function propagateObjectFitStyles(fromEl, toEl) {\n  if (fromEl.hasAttribute('object-fit')) {\n    setStyle(toEl, 'object-fit', fromEl.getAttribute('object-fit'));\n  }\n\n  if (fromEl.hasAttribute('object-position')) {\n    setStyle(toEl, 'object-position', fromEl.getAttribute('object-position'));\n  }\n}\n\n/**\n * @param {string} property\n * @return {boolean}\n */\nfunction isVar(property) {\n  return property.startsWith('--');\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Required flags to apply to the sandbox iframe.\n * @return {Array<string>}\n */\nexport const getRequiredSandboxFlags = () => [\n  // This only allows navigation when user interacts and thus prevents\n  // ads from auto navigating the user.\n  'allow-top-navigation-by-user-activation',\n  // Crucial because otherwise even target=_blank opened links are\n  // still sandboxed which they may not expect.\n  'allow-popups-to-escape-sandbox',\n];\n\n/**\n * These flags are not feature detected. Put stuff here where either\n * they have always been supported or support is not crucial.\n * @return {Array<string>}\n */\nexport const getOptionalSandboxFlags = () => [\n  'allow-forms',\n  // We should consider turning this off! But since the top navigation\n  // issue is the big one, we'll leave this allowed for now.\n  'allow-modals',\n  // Give access to raw mouse movements.\n  'allow-pointer-lock',\n  // This remains subject to popup blocking, it just makes it supported\n  // at all.\n  'allow-popups',\n  // This applies inside the iframe and is crucial to not break the web.\n  'allow-same-origin',\n  'allow-scripts',\n  // Not allowed\n  // - allow-top-navigation\n  // - allow-orientation-lock\n  // - allow-pointer-lock\n  // - allow-presentation\n];\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isArray} from '../array';\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n\n// NOTE Type are changed to {*} because of\n// https://github.com/google/closure-compiler/issues/1999\n\n/**\n * JSON scalar. It's either string, number or boolean.\n * @typedef {string|number|boolean|null}\n */\nlet JSONScalarDef;\n\n/**\n * JSON object. It's a map with string keys and JSON values.\n * @typedef {!Object<string, ?*>} (* should be JSONValueDef)\n */\nlet JSONObjectDef;\n\n/**\n * JSON array. It's an array with JSON values.\n * @typedef {!Array<?*>} (* should be JSONValueDef)\n */\nlet JSONArrayDef;\n\n/**\n * JSON value. It's either a scalar, an object or an array.\n * @typedef {!JSONScalarDef|!JSONObjectDef|!JSONArrayDef}\n */\nlet JSONValueDef;\n\n/**\n * @typedef {{\n *   YOU_MUST_USE: string,\n *   jsonLiteral: function(),\n *   TO_MAKE_THIS_TYPE: string,\n * }}\n */\nlet InternalJsonLiteralTypeDef;\n\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {string} json JSON string to parse\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function parseJson(json) {\n  return /** @type {?JsonObject} */ (JSON.parse(json));\n}\n\n/**\n * Parses the given `json` string without throwing an exception if not valid.\n * Returns `undefined` if parsing fails.\n * Returns the `Object` corresponding to the JSON string when parsing succeeds.\n * @param {string} json JSON string to parse\n * @param {function(!Error)=} opt_onFailed Optional function that will be called\n *     with the error if parsing fails.\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function tryParseJson(json, opt_onFailed) {\n  try {\n    return parseJson(json);\n  } catch (e) {\n    opt_onFailed?.(e);\n    return null;\n  }\n}\n\n/**\n * Deeply checks strict equality of items in nested arrays and objects.\n *\n * @param {JSONValueDef} a\n * @param {JSONValueDef} b\n * @param {number} depth The maximum depth. Must be finite.\n * @return {boolean}\n * @throws {Error} If depth argument is not finite.\n */\nexport function deepEquals(a, b, depth = 5) {\n  if (!isFinite(depth) || depth < 0) {\n    throw new Error('Invalid depth: ' + depth);\n  }\n  if (a === b) {\n    return true;\n  }\n  /** @type {!Array<{a: JSONValueDef, b: JSONValueDef, depth: number}>} */\n  const queue = [{a, b, depth}];\n  while (queue.length > 0) {\n    const {a, b, depth} = queue.shift();\n    // Only check deep equality if depth > 0.\n    if (depth > 0) {\n      if (typeof a !== typeof b) {\n        return false;\n      } else if (isArray(a) && isArray(b)) {\n        if (a.length !== b.length) {\n          return false;\n        }\n        for (let i = 0; i < a.length; i++) {\n          queue.push({a: a[i], b: b[i], depth: depth - 1});\n        }\n        continue;\n      } else if (a && b && typeof a === 'object' && typeof b === 'object') {\n        const keysA = Object.keys(a);\n        const keysB = Object.keys(b);\n        if (keysA.length !== keysB.length) {\n          return false;\n        }\n        for (const k of keysA) {\n          queue.push({a: a[k], b: b[k], depth: depth - 1});\n        }\n        continue;\n      }\n    }\n    // If we get here, then depth == 0 or (a, b) are primitives.\n    if (a !== b) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * This helper function handles configurations specified in a JSON format.\n *\n * It allows the configuration is to be written in plain JS (which has better\n * dev ergonomics like comments and trailing commas), and allows the\n * configuration to be transformed into an efficient JSON-parsed representation\n * in the dist build. See https://v8.dev/blog/cost-of-javascript-2019#json\n *\n * @param {!Object} obj\n * @return {!JsonObject}\n */\nexport function jsonConfiguration(obj) {\n  return /** @type {!JsonObject} */ (obj);\n}\n\n/**\n * This converts an Object into a suitable type to be used in `includeJsonLiteral`.\n * This doesn't actually do any conversion, it only changes the closure type.\n *\n * @param {?JSONValueDef} value\n * @return {!InternalJsonLiteralTypeDef}\n */\nexport function jsonLiteral(value) {\n  return /** @type {!InternalJsonLiteralTypeDef} */ (value);\n}\n\n/**\n * Allows inclusion of a variable (that's wrapped in a jsonLiteral\n * call) to be included inside a jsonConfiguration.\n *\n * @param {!InternalJsonLiteralTypeDef} value\n * @return {*}\n */\nexport function includeJsonLiteral(value) {\n  return value;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assertHttpsUrl, parseUrlDeprecated} from './url';\nimport {dev, devAssert, user, userAssert} from './log';\nimport {dict} from './core/types/object';\nimport {getContextMetadata} from '../src/iframe-attributes';\nimport {getMode} from './mode';\nimport {\n  getOptionalSandboxFlags,\n  getRequiredSandboxFlags,\n} from './core/3p-frame';\nimport {internalRuntimeVersion} from './internal-version';\nimport {isExperimentOn} from './experiments';\nimport {setStyle} from './style';\nimport {tryParseJson} from './core/types/object/json';\nimport {urls} from './config';\n\n/** @type {!Object<string,number>} Number of 3p frames on the for that type. */\nlet count = {};\n\n/** @type {string} */\nlet overrideBootstrapBaseUrl;\n\n/** @const {string} */\nconst TAG = '3p-frame';\n\n/**\n * Produces the attributes for the ad template.\n * @param {!Window} parentWindow\n * @param {!AmpElement} element\n * @param {string=} opt_type\n * @param {Object=} opt_context\n * @return {!JsonObject} Contains\n *     - type, width, height, src attributes of <amp-ad> tag. These have\n *       precedence over the data- attributes.\n *     - data-* attributes of the <amp-ad> tag with the \"data-\" removed.\n *     - A _context object for internal use.\n */\nfunction getFrameAttributes(parentWindow, element, opt_type, opt_context) {\n  const type = opt_type || element.getAttribute('type');\n  userAssert(type, 'Attribute type required for <amp-ad>: %s', element);\n  const sentinel = generateSentinel(parentWindow);\n  let attributes = dict();\n  // Do these first, as the other attributes have precedence.\n  addDataAndJsonAttributes_(element, attributes);\n  attributes = getContextMetadata(parentWindow, element, sentinel, attributes);\n  attributes['type'] = type;\n  Object.assign(attributes['_context'], opt_context);\n  return attributes;\n}\n\n/**\n * Creates the iframe for the embed. Applies correct size and passes the embed\n * attributes to the frame via JSON inside the fragment.\n * @param {!Window} parentWindow\n * @param {!AmpElement} parentElement\n * @param {string=} opt_type\n * @param {Object=} opt_context\n * @param {{\n *   allowFullscreen: (boolean|undefined),\n *   initialIntersection: (IntersectionObserverEntry|undefined),\n * }=} options Options for the created iframe.\n * @return {!HTMLIFrameElement} The iframe.\n */\nexport function getIframe(\n  parentWindow,\n  parentElement,\n  opt_type,\n  opt_context,\n  options = {}\n) {\n  const {allowFullscreen = false, initialIntersection} = options;\n  // Check that the parentElement is already in DOM. This code uses a new and\n  // fast `isConnected` API and thus only used when it's available.\n  devAssert(\n    parentElement['isConnected'] === undefined ||\n      parentElement['isConnected'] === true,\n    'Parent element must be in DOM'\n  );\n  const attributes = getFrameAttributes(\n    parentWindow,\n    parentElement,\n    opt_type,\n    opt_context\n  );\n  if (initialIntersection) {\n    attributes['_context']['initialIntersection'] = initialIntersection;\n  }\n\n  const iframe = /** @type {!HTMLIFrameElement} */ (\n    parentWindow.document.createElement('iframe')\n  );\n\n  if (!count[attributes['type']]) {\n    count[attributes['type']] = 0;\n  }\n  count[attributes['type']] += 1;\n\n  const ampdoc = parentElement.getAmpDoc();\n  const baseUrl = getBootstrapBaseUrl(parentWindow, ampdoc);\n  const host = parseUrlDeprecated(baseUrl).hostname;\n  // This name attribute may be overwritten if this frame is chosen to\n  // be the master frame. That is ok, as we will read the name off\n  // for our uses before that would occur.\n  // @see https://github.com/ampproject/amphtml/blob/main/3p/integration.js\n  const name = JSON.stringify(\n    dict({\n      'host': host,\n      'bootstrap': getBootstrapUrl(attributes['type'], parentWindow),\n      'type': attributes['type'],\n      // https://github.com/ampproject/amphtml/pull/2955\n      'count': count[attributes['type']],\n      'attributes': attributes,\n    })\n  );\n\n  iframe.src = baseUrl;\n  iframe.ampLocation = parseUrlDeprecated(baseUrl);\n  iframe.name = name;\n  // Add the check before assigning to prevent IE throw Invalid argument error\n  if (attributes['width']) {\n    iframe.width = attributes['width'];\n  }\n  if (attributes['height']) {\n    iframe.height = attributes['height'];\n  }\n  if (attributes['title']) {\n    iframe.title = attributes['title'];\n  }\n  if (allowFullscreen) {\n    iframe.setAttribute('allowfullscreen', 'true');\n  }\n  iframe.setAttribute('scrolling', 'no');\n  setStyle(iframe, 'border', 'none');\n  /** @this {!Element} */\n  iframe.onload = function () {\n    // Chrome does not reflect the iframe readystate.\n    this.readyState = 'complete';\n  };\n  // Block synchronous XHR in ad. These are very rare, but super bad for UX\n  // as they block the UI thread for the arbitrary amount of time until the\n  // request completes.\n  iframe.setAttribute('allow', \"sync-xhr 'none';\");\n  const excludeFromSandbox = ['facebook'];\n  if (!excludeFromSandbox.includes(opt_type)) {\n    applySandbox(iframe);\n  }\n  iframe.setAttribute(\n    'data-amp-3p-sentinel',\n    attributes['_context']['sentinel']\n  );\n  return iframe;\n}\n\n/**\n * Copies data- attributes from the element into the attributes object.\n * Removes the data- from the name and capitalizes after -. If there\n * is an attribute called json, parses the JSON and adds it to the\n * attributes.\n * @param {!Element} element\n * @param {!JsonObject} attributes The destination.\n * visibleForTesting\n */\nexport function addDataAndJsonAttributes_(element, attributes) {\n  const {dataset} = element;\n  for (const name in dataset) {\n    // data-vars- is reserved for amp-analytics\n    // see https://github.com/ampproject/amphtml/blob/main/extensions/amp-analytics/analytics-vars.md#variables-as-data-attribute\n    if (!name.startsWith('vars')) {\n      attributes[name] = dataset[name];\n    }\n  }\n  const json = element.getAttribute('json');\n  if (json) {\n    const obj = tryParseJson(json);\n    if (obj === undefined) {\n      throw user().createError(\n        'Error parsing JSON in json attribute in element %s',\n        element\n      );\n    }\n    for (const key in obj) {\n      attributes[key] = obj[key];\n    }\n  }\n}\n\n/**\n * Get the bootstrap script URL for iframe.\n * @param {string} type\n * @param {!Window} win\n * @return {string}\n */\nexport function getBootstrapUrl(type, win) {\n  if (getMode().localDev || getMode().test) {\n    const filename = getMode().minified\n      ? `./vendor/${type}.`\n      : `./vendor/${type}.max.`;\n    return IS_ESM ? filename + 'mjs' : filename + 'js';\n  }\n  if (isExperimentOn(win, '3p-vendor-split')) {\n    return IS_ESM\n      ? `${urls.thirdParty}/${internalRuntimeVersion()}/vendor/${type}.mjs`\n      : `${urls.thirdParty}/${internalRuntimeVersion()}/vendor/${type}.js`;\n  }\n  return `${urls.thirdParty}/${internalRuntimeVersion()}/f.js`;\n}\n\n/**\n * Preloads URLs related to the bootstrap iframe.\n * @param {!Window} win\n * @param {string} type\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {!./preconnect.PreconnectService} preconnect\n */\nexport function preloadBootstrap(win, type, ampdoc, preconnect) {\n  const url = getBootstrapBaseUrl(win, ampdoc);\n  preconnect.preload(ampdoc, url, 'document');\n\n  // While the URL may point to a custom domain, this URL will always be\n  // fetched by it.\n  preconnect.preload(ampdoc, getBootstrapUrl(type, win), 'script');\n}\n\n/**\n * Returns the base URL for 3p bootstrap iframes.\n * @param {!Window} parentWindow\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {boolean=} opt_strictForUnitTest\n * @return {string}\n * @visibleForTesting\n */\nexport function getBootstrapBaseUrl(\n  parentWindow,\n  ampdoc,\n  opt_strictForUnitTest\n) {\n  return (\n    getCustomBootstrapBaseUrl(parentWindow, ampdoc, opt_strictForUnitTest) ||\n    getDefaultBootstrapBaseUrl(parentWindow)\n  );\n}\n\n/**\n * @param {string} url\n */\nexport function setDefaultBootstrapBaseUrlForTesting(url) {\n  overrideBootstrapBaseUrl = url;\n}\n\n/**\n * @param {*} win\n */\nexport function resetBootstrapBaseUrlForTesting(win) {\n  win.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN = undefined;\n}\n\n/**\n * Returns the default base URL for 3p bootstrap iframes.\n * @param {!Window} parentWindow\n * @param {string=} opt_srcFileBasename\n * @return {string}\n */\nexport function getDefaultBootstrapBaseUrl(parentWindow, opt_srcFileBasename) {\n  const srcFileBasename = opt_srcFileBasename || 'frame';\n  if (getMode().localDev || getMode().test) {\n    return getDevelopmentBootstrapBaseUrl(parentWindow, srcFileBasename);\n  }\n  // Ensure same sub-domain is used despite potentially different file.\n  parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN =\n    parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN ||\n    getSubDomain(parentWindow);\n  return (\n    'https://' +\n    parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN +\n    `.${urls.thirdPartyFrameHost}/${internalRuntimeVersion()}/` +\n    `${srcFileBasename}.html`\n  );\n}\n\n/**\n * Function to return the development boostrap base URL\n * @param {!Window} parentWindow\n * @param {string} srcFileBasename\n * @return {string}\n */\nexport function getDevelopmentBootstrapBaseUrl(parentWindow, srcFileBasename) {\n  return (\n    overrideBootstrapBaseUrl ||\n    getAdsLocalhost(parentWindow) +\n      '/dist.3p/' +\n      (getMode().minified\n        ? `${internalRuntimeVersion()}/${srcFileBasename}`\n        : `current/${srcFileBasename}.max`) +\n      '.html'\n  );\n}\n\n/**\n * @param {!Window} win\n * @return {string}\n */\nfunction getAdsLocalhost(win) {\n  let adsUrl = urls.thirdParty; // local dev with a non-localhost server\n  if (adsUrl == 'https://3p.ampproject.net') {\n    adsUrl = 'http://ads.localhost'; // local dev with a localhost server\n  }\n  return adsUrl + ':' + (win.location.port || win.parent.location.port);\n}\n\n/**\n * Sub domain on which the 3p iframe will be hosted.\n * Because we only calculate the URL once per page, this function is only\n * called once and hence all frames on a page use the same URL.\n * @param {!Window} win\n * @return {string}\n * @visibleForTesting\n */\nexport function getSubDomain(win) {\n  return 'd-' + getRandom(win);\n}\n\n/**\n * Generates a random non-negative integer.\n * @param {!Window} win\n * @return {string}\n */\nexport function getRandom(win) {\n  let rand;\n  if (win.crypto && win.crypto.getRandomValues) {\n    // By default use 2 32 bit integers.\n    const uint32array = new Uint32Array(2);\n    win.crypto.getRandomValues(uint32array);\n    rand = String(uint32array[0]) + uint32array[1];\n  } else {\n    // Fall back to Math.random.\n    rand = String(win.Math.random()).substr(2) + '0';\n  }\n  return rand;\n}\n\n/**\n * Returns the custom base URL for 3p bootstrap iframes if it exists.\n * Otherwise null.\n * @param {!Window} parentWindow\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {boolean=} opt_strictForUnitTest\n * @return {?string}\n */\nfunction getCustomBootstrapBaseUrl(\n  parentWindow,\n  ampdoc,\n  opt_strictForUnitTest\n) {\n  const meta = ampdoc.getMetaByName('amp-3p-iframe-src');\n  if (!meta) {\n    return null;\n  }\n  const url = assertHttpsUrl(meta, 'meta[name=\"amp-3p-iframe-src\"]');\n  userAssert(\n    url.indexOf('?') == -1,\n    '3p iframe url must not include query string %s in element %s.',\n    url,\n    meta\n  );\n  // This is not a security primitive, we just don't want this to happen in\n  // practice. People could still redirect to the same origin, but they cannot\n  // redirect to the proxy origin which is the important one.\n  const parsed = parseUrlDeprecated(url);\n  userAssert(\n    (parsed.hostname == 'localhost' && !opt_strictForUnitTest) ||\n      parsed.origin != parseUrlDeprecated(parentWindow.location.href).origin,\n    '3p iframe url must not be on the same origin as the current document ' +\n      '%s (%s) in element %s. See https://github.com/ampproject/amphtml' +\n      '/blob/main/docs/spec/amp-iframe-origin-policy.md for details.',\n    url,\n    parsed.origin,\n    meta\n  );\n  return `${url}?${internalRuntimeVersion()}`;\n}\n\n/**\n * Applies a sandbox to the iframe, if the required flags can be allowed.\n * @param {!Element} iframe\n * @visibleForTesting\n */\nexport function applySandbox(iframe) {\n  if (!iframe.sandbox || !iframe.sandbox.supports) {\n    return; // Can't feature detect support\n  }\n  // If these flags are not supported by the UA we don't apply any\n  // sandbox.\n  const requiredFlags = getRequiredSandboxFlags();\n  for (let i = 0; i < requiredFlags.length; i++) {\n    const flag = requiredFlags[i];\n    if (!iframe.sandbox.supports(flag)) {\n      dev().info(TAG, \"Iframe doesn't support %s\", flag);\n      return;\n    }\n  }\n  iframe.sandbox =\n    requiredFlags.join(' ') + ' ' + getOptionalSandboxFlags().join(' ');\n}\n\n/**\n * Returns a randomized sentinel value for 3p iframes.\n * The format is \"%d-%d\" with the first value being the depth of current\n * window in the window hierarchy and the second a random integer.\n * @param {!Window} parentWindow\n * @return {string}\n * @visibleForTesting\n */\nexport function generateSentinel(parentWindow) {\n  let windowDepth = 0;\n  for (let win = parentWindow; win && win != win.parent; win = win.parent) {\n    windowDepth++;\n  }\n  return String(windowDepth) + '-' + getRandom(parentWindow);\n}\n\n/**\n * Resets the count of each 3p frame type\n * @visibleForTesting\n */\nexport function resetCountForTesting() {\n  count = {};\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether addEventListener supports options or only takes capture as a boolean\n * @type {boolean|undefined}\n * @visibleForTesting\n */\nlet optsSupported;\n\n/**\n * Whether addEventListener supports options or only takes passive as a boolean\n * @type {boolean|undefined}\n */\nlet passiveSupported;\n\n/**\n * Options supported by addEventListener\n * @typedef AddEventListenerOptsDef\n * @property {undefined|boolean} [capture]\n * @property {undefined|boolean} [once]\n * @property {undefined|boolean} [passive]\n * @property {undefined|!AbortSignal} [signal]\n * }}\n */\nlet AddEventListenerOptsDef;\n\n/**\n * Listens for the specified event on the element.\n *\n * Do not use this directly. This method is implemented as a shared\n * dependency. Use `listen()` in either `event-helper` or `3p-frame-messaging`,\n * depending on your use case.\n *\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {!AddEventListenerOptsDef=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function internalListenImplementation(\n  element,\n  eventType,\n  listener,\n  opt_evtListenerOpts\n) {\n  let localElement = element;\n  let localListener = listener;\n  /** @type {?function(!Event)} */\n  let wrapped = (event) => {\n    try {\n      return localListener(event);\n    } catch (e) {\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR?.(e);\n      throw e;\n    }\n  };\n  const optsSupported = detectEvtListenerOptsSupport();\n  const capture = !!opt_evtListenerOpts?.capture;\n\n  localElement.addEventListener(\n    eventType,\n    wrapped,\n    optsSupported ? opt_evtListenerOpts : capture\n  );\n  return () => {\n    localElement?.removeEventListener(\n      eventType,\n      wrapped,\n      optsSupported ? opt_evtListenerOpts : capture\n    );\n    // Ensure these are GC'd\n    localListener = null;\n    localElement = null;\n    wrapped = null;\n  };\n}\n\n/**\n * Tests whether the browser supports options as an argument of addEventListener\n * or not.\n *\n * @return {boolean}\n */\nexport function detectEvtListenerOptsSupport() {\n  // Only run the test once\n  if (optsSupported !== undefined) {\n    return optsSupported;\n  }\n\n  optsSupported = false;\n  try {\n    // Test whether browser supports EventListenerOptions or not\n    const options = {\n      get capture() {\n        optsSupported = true;\n      },\n    };\n    self.addEventListener('test-options', null, options);\n    self.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return optsSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports options or not.\n */\nexport function resetEvtListenerOptsSupportForTesting() {\n  optsSupported = undefined;\n}\n\n/**\n * Return boolean. if listener option is supported, return `true`.\n * if not supported, return `false`\n * @param {!Window} win\n * @return {boolean}\n */\nexport function supportsPassiveEventListener(win) {\n  if (passiveSupported !== undefined) {\n    return passiveSupported;\n  }\n\n  passiveSupported = false;\n  try {\n    const options = {\n      get passive() {\n        // This function will be called when the browser\n        // attempts to access the passive property.\n        passiveSupported = true;\n        return false;\n      },\n    };\n\n    win.addEventListener('test-options', null, options);\n    win.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return passiveSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports passive options or not.\n */\nexport function resetPassiveSupportedForTesting() {\n  passiveSupported = undefined;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalListenImplementation} from './core/dom/event-helper-listen';\nimport {lastChildElement} from './core/dom/query';\nimport {user} from './log';\n\n/** @const {string}  */\nconst LOAD_FAILURE_PREFIX = 'Failed to load:';\n\n/** @const {string} */\nexport const MEDIA_LOAD_FAILURE_SRC_PROPERTY = '__AMP_MEDIA_LOAD_FAILURE_SRC';\n\n/**\n * Returns a CustomEvent with a given type and detail; supports fallback for IE.\n * @param {!Window} win\n * @param {string} type\n * @param {!JsonObject|string|undefined|null} detail\n * @param {EventInit=} opt_eventInit\n * @return {!Event}\n */\nexport function createCustomEvent(win, type, detail, opt_eventInit) {\n  const eventInit = /** @type {!CustomEventInit} */ ({detail});\n  Object.assign(eventInit, opt_eventInit);\n  // win.CustomEvent is a function on Edge, Chrome, FF, Safari but\n  // is an object on IE 11.\n  if (IS_ESM || typeof win.CustomEvent == 'function') {\n    return new win.CustomEvent(type, eventInit);\n  } else {\n    // Deprecated fallback for IE.\n    const e = win.document.createEvent('CustomEvent');\n    e.initCustomEvent(\n      type,\n      !!eventInit.bubbles,\n      !!eventInit.cancelable,\n      detail\n    );\n    return e;\n  }\n}\n\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listen(element, eventType, listener, opt_evtListenerOpts) {\n  return internalListenImplementation(\n    element,\n    eventType,\n    listener,\n    opt_evtListenerOpts\n  );\n}\n\n/**\n * Returns the data property of an event with the correct type.\n * @param {!Event|{data: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getData(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.data);\n}\n\n/**\n * Returns the detail property of an event with the correct type.\n * @param {!Event|{detail: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getDetail(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.detail);\n}\n\n/**\n * Listens for the specified event on the element and removes the listener\n * as soon as event has been received.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listenOnce(element, eventType, listener, opt_evtListenerOpts) {\n  let localListener = listener;\n  const unlisten = internalListenImplementation(\n    element,\n    eventType,\n    (event) => {\n      try {\n        localListener(event);\n      } finally {\n        // Ensure listener is GC'd\n        localListener = null;\n        unlisten();\n      }\n    },\n    opt_evtListenerOpts\n  );\n  return unlisten;\n}\n\n/**\n * Returns  a promise that will resolve as soon as the specified event has\n * fired on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {Object=} opt_evtListenerOpts\n * @param {function(!UnlistenDef)=} opt_cancel An optional function that, when\n *     provided, will be called with the unlistener. This gives the caller\n *     access to the unlistener, so it may be called manually when necessary.\n * @return {!Promise<!Event>}\n */\nexport function listenOncePromise(\n  element,\n  eventType,\n  opt_evtListenerOpts,\n  opt_cancel\n) {\n  let unlisten;\n  const eventPromise = new Promise((resolve) => {\n    unlisten = listenOnce(element, eventType, resolve, opt_evtListenerOpts);\n  });\n  eventPromise.then(unlisten, unlisten);\n  if (opt_cancel) {\n    opt_cancel(unlisten);\n  }\n  return eventPromise;\n}\n\n/**\n * Whether the specified element/window has been loaded already.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nexport function isLoaded(eleOrWindow) {\n  return !!(\n    eleOrWindow.complete ||\n    eleOrWindow.readyState == 'complete' ||\n    (isHTMLMediaElement(eleOrWindow) && eleOrWindow.readyState > 0) ||\n    // If the passed in thing is a Window, infer loaded state from\n    //\n    (eleOrWindow.document && eleOrWindow.document.readyState == 'complete')\n  );\n}\n\n/**\n * Returns a promise that will resolve or fail based on the eleOrWindow's 'load'\n * and 'error' events. Optionally this method takes a timeout, which will reject\n * the promise if the resource has not loaded by then.\n * @param {T} eleOrWindow Supports both Elements and as a special case Windows.\n * @return {!Promise<T>}\n * @template T\n */\nexport function loadPromise(eleOrWindow) {\n  let unlistenLoad;\n  let unlistenError;\n  if (isLoaded(eleOrWindow)) {\n    return Promise.resolve(eleOrWindow);\n  }\n  const isMediaElement = isHTMLMediaElement(eleOrWindow);\n  if (\n    isMediaElement &&\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] === eleOrWindow.currentSrc\n  ) {\n    return Promise.reject(eleOrWindow);\n  }\n  const loadingPromise = new Promise((resolve, reject) => {\n    // Listen once since IE 5/6/7 fire the onload event continuously for\n    // animated GIFs.\n    if (isMediaElement) {\n      // The following event can be triggered by the media or one of its\n      // sources. Using capture is required as the media events do not bubble.\n      unlistenLoad = listenOnce(eleOrWindow, 'loadedmetadata', resolve, {\n        capture: true,\n      });\n    } else {\n      unlistenLoad = listenOnce(eleOrWindow, 'load', resolve);\n    }\n    // Don't unlisten on error for Windows.\n    if (!eleOrWindow.tagName) {\n      return;\n    }\n    let errorTarget = eleOrWindow;\n    // If the media element has no `src`, it will try to load the sources in\n    // document order. If the last source errors, then the media element\n    // loading errored.\n    if (isMediaElement && !eleOrWindow.hasAttribute('src')) {\n      errorTarget = lastChildElement(\n        eleOrWindow,\n        (child) => child.tagName === 'SOURCE'\n      );\n      if (!errorTarget) {\n        return reject(new Error('Media has no source.'));\n      }\n    }\n    unlistenError = listenOnce(errorTarget, 'error', reject);\n  });\n\n  return loadingPromise.then(\n    () => {\n      if (unlistenError) {\n        unlistenError();\n      }\n      return eleOrWindow;\n    },\n    () => {\n      if (unlistenLoad) {\n        unlistenLoad();\n      }\n      failedToLoad(eleOrWindow);\n    }\n  );\n}\n\n/**\n * Emit error on load failure.\n * @param {!Element|!Window} eleOrWindow Supports both Elements and as a special\n *     case Windows.\n */\nfunction failedToLoad(eleOrWindow) {\n  // Mark the element as errored since some elements - like HTMLMediaElement\n  // using HTMLSourceElement - do not provide any synchronous way to verify if\n  // they already errored, even though the error event was already dispatched.\n  if (isHTMLMediaElement(eleOrWindow)) {\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] =\n      eleOrWindow.currentSrc || true;\n  }\n\n  // Report failed loads as user errors so that they automatically go\n  // into the \"document error\" bucket.\n  let target = eleOrWindow;\n  if (target && target.src) {\n    target = target.src;\n  }\n  throw user().createError(LOAD_FAILURE_PREFIX, target);\n}\n\n/**\n * Returns true if the parameter is a HTMLMediaElement.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nfunction isHTMLMediaElement(eleOrWindow) {\n  return eleOrWindow.tagName === 'AUDIO' || eleOrWindow.tagName === 'VIDEO';\n}\n\n/**\n * Returns true if this error message is was created for a load error.\n * @param {string} message An error message\n * @return {boolean}\n */\nexport function isLoadErrorMessage(message) {\n  return message.indexOf(LOAD_FAILURE_PREFIX) != -1;\n}\n", "export const cssText = \":host{all:initial;color:initial}.story-player-iframe{height:100%;width:100%;-ms-flex:0 0 100%;flex:0 0 100%;border:0;opacity:0;transition:opacity 500ms ease;position:absolute}.i-amphtml-story-player-main-container{height:100%;position:relative;overflow:hidden;transform-style:preserve-3d}.i-amphtml-story-player-loaded .story-player-iframe{opacity:1;transition:transform 200ms cubic-bezier(0.4,0,0.2,1)}.i-amphtml-story-player-no-navigation-transition .story-player-iframe{transition-duration:0.01s}.i-amphtml-story-player-main-container .story-player-iframe[i-amphtml-iframe-position=\\\"0\\\"],.i-amphtml-story-player-main-container iframe:first-of-type{transform:translateZ(1px)}.i-amphtml-story-player-main-container .story-player-iframe[i-amphtml-iframe-position=\\\"1\\\"],.i-amphtml-story-player-main-container iframe:nth-of-type(2),.i-amphtml-story-player-main-container iframe:nth-of-type(3){transform:translate3d(100%,0,0)}.i-amphtml-story-player-main-container .story-player-iframe[i-amphtml-iframe-position=\\\"-1\\\"]{transform:translate3d(-100%,0,0)}.amp-story-player-exit-control-button{position:absolute;height:48px;width:48px;background-repeat:no-repeat;background-position:50%;margin-top:7px;background-size:28px;border:0px;background-color:transparent;outline:transparent;cursor:pointer;z-index:1}.amp-story-player-close-button{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24' width='24' fill='%23FFF'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E\\\")}.amp-story-player-back-button{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24' width='24' fill='%23FFF'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z'/%3E%3C/svg%3E\\\")}.amp-story-player-hide-button{display:none}\\n/*# sourceURL=/css/amp-story-player-iframe.css*/\"", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {AmpStoryEntryPoint} from './amp-story-entry-point/amp-story-entry-point-impl';\nimport {AmpStoryPlayer} from './amp-story-player-impl';\nimport {AmpStoryPlayerViewportObserver} from './amp-story-player-viewport-observer';\nimport {initLogConstructor} from '../log';\n\nexport class AmpStoryComponentManager {\n  /**\n   * @param {!Window} win\n   * @constructor\n   */\n  constructor(win) {\n    /** @private {!Window} */\n    this.win_ = win;\n  }\n\n  /**\n   * Calls layoutPlayer on the element when it is close to the viewport.\n   * @param {!Element} element\n   * @private\n   */\n  layoutEl_(element) {\n    new AmpStoryPlayerViewportObserver(this.win_, element, () =>\n      element.layoutPlayer()\n    );\n\n    const scrollHandler = () => {\n      element.layoutPlayer();\n      this.win_.removeEventListener('scroll', scrollHandler);\n    };\n\n    this.win_.addEventListener('scroll', scrollHandler);\n  }\n\n  /**\n   * Builds and layouts the players when appropiate.\n   * @public\n   */\n  loadPlayers() {\n    const doc = this.win_.document;\n    const players = doc.getElementsByTagName('amp-story-player');\n    initLogConstructor();\n    for (let i = 0; i < players.length; i++) {\n      const playerEl = players[i];\n      const player = new AmpStoryPlayer(this.win_, playerEl);\n      player.buildPlayer();\n      this.layoutEl_(player);\n    }\n  }\n\n  /**\n   * Builds and layouts entry points.\n   * @public\n   */\n  loadEntryPoints() {\n    const doc = this.win_.document;\n    const entryPoints = doc.getElementsByTagName('amp-story-entry-point');\n    initLogConstructor();\n\n    for (let i = 0; i < entryPoints.length; i++) {\n      const entryPointEl = entryPoints[i];\n      const entryPoint = new AmpStoryEntryPoint(this.win_, entryPointEl);\n      entryPoint.buildCallback();\n      this.layoutEl_(entryPoint);\n    }\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether the document is ready.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isDocumentReady(doc) {\n  return doc.readyState != 'loading' && doc.readyState != 'uninitialized';\n}\n\n/**\n * Whether the document has loaded all the css and sub-resources.\n * @param {!Document} doc\n * @return {boolean}\n */\nfunction isDocumentComplete(doc) {\n  return doc.readyState == 'complete';\n}\n\n/**\n * Calls the callback when document is ready.\n * @param {!Document} doc\n * @param {function(!Document)} callback\n */\nexport function onDocumentReady(doc, callback) {\n  onDocumentState(doc, isDocumentReady, callback);\n}\n\n/**\n * Calls the callback when document's state satisfies the stateFn.\n * @param {!Document} doc\n * @param {function(!Document):boolean} stateFn\n * @param {function(!Document)} callback\n */\nfunction onDocumentState(doc, stateFn, callback) {\n  let ready = stateFn(doc);\n  if (ready) {\n    callback(doc);\n  } else {\n    const readyListener = () => {\n      if (stateFn(doc)) {\n        if (!ready) {\n          ready = true;\n          callback(doc);\n        }\n        doc.removeEventListener('readystatechange', readyListener);\n      }\n    };\n    doc.addEventListener('readystatechange', readyListener);\n  }\n}\n\n/**\n * Returns a promise that is resolved when document is ready.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\nexport function whenDocumentReady(doc) {\n  return new Promise((resolve) => {\n    onDocumentReady(doc, resolve);\n  });\n}\n\n/**\n * Returns a promise that is resolved when document is complete.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\nexport function whenDocumentComplete(doc) {\n  return new Promise((resolve) => {\n    onDocumentState(doc, isDocumentComplete, resolve);\n  });\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {AmpStoryComponentManager} from './amp-story-component-manager';\nimport {AmpStoryPlayer} from './amp-story-player-impl';\nimport {onDocumentReady} from '../core/document-ready';\n\nonDocumentReady(self.document, () => {\n  const manager = new AmpStoryComponentManager(self);\n  manager.loadPlayers();\n});\n\nglobalThis.AmpStoryPlayer = AmpStoryPlayer;\n"],
  "mappings": "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",
  "names": []
}
