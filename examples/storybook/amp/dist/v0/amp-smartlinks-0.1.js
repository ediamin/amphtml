(self.AMP=self.AMP||[]).push({n:"amp-smartlinks",ev:"0.1",l:true,v:"2106040012000",m:0,f:function(AMP,_){"use strict";function aa(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}function k(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):{next:aa(a)}}var ba="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b};function ca(a){for(var b=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global],c=0;c<b.length;++c){var d=b[c];if(d&&d.Math==Math)return d}return function(){throw Error("Cannot find global object")}()}var ea=ca(this);"function"===typeof Symbol&&Symbol("x");var m;if("function"==typeof Object.setPrototypeOf)m=Object.setPrototypeOf;else{var n;a:{var fa={a:!0},p={};try{p.__proto__=fa;n=p.a;break a}catch(a){}n=!1}m=n?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var q=m;function r(a,b){a.prototype=ba(b.prototype);a.prototype.constructor=a;if(q)q(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.na=b.prototype}var t;function u(){return t?t:t=Promise.resolve(void 0)}function ha(){var a=this;this.promise=new Promise((function(b,c){a.resolve=b;a.reject=c}))}var v=Array.isArray;function w(a){return a||{}}var x=self.AMP_CONFIG||{},ia=("string"==typeof x.cdnProxyRegex?new RegExp(x.cdnProxyRegex):x.cdnProxyRegex)||/^https:\/\/([a-zA-Z0-9_-]+\.)?cdn\.ampproject\.org$/;function y(a){if(self.document&&self.document.head&&(!self.location||!ia.test(self.location.origin))){var b=self.document.head.querySelector('meta[name="'+a+'"]');b&&b.getAttribute("content")}}x.cdnUrl||y("runtime-host");x.geoApiUrl||y("amp-geo-api");self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var z=self.__AMP_LOG;function A(){if(z.dev)return z.dev;throw Error("failed to call initLogConstructor")}function B(a,b){a=a.__AMP_TOP||(a.__AMP_TOP=a);return C(a,b)}function D(a,b){var c=E(a);c=F(c);return C(c,b)}function E(a){return a.nodeType?B((a.ownerDocument||a).defaultView,"ampdoc").getAmpDoc(a):a}function F(a){a=E(a);return a.isSingleDoc()?a.win:a}function C(a,b){a=G(a)[b];a.obj||(a.obj=new a.ctor(a.context),a.context=null,a.resolve&&a.resolve(a.obj));return a.obj}function H(a,b){var c=I(a,b);if(c)return c;a=G(a);a[b]=ja();return a[b].promise}function I(a,b){var c=G(a)[b];if(c){if(c.promise)return c.promise;C(a,b);return c.promise=Promise.resolve(c.obj)}return null}function G(a){var b=a.__AMP_SERVICES;b||(b=a.__AMP_SERVICES={});return b}function ja(){var a=new ha,b=a.promise,c=a.reject;a=a.resolve;b.catch((function(){}));return{obj:null,promise:b,resolve:a,reject:c,context:null,ctor:null}}
/* https://mths.be/cssescape v1.5.1 by @mathias | MIT license */
function J(a,b,c){a=a.createElement(b);for(var d in c)a.setAttribute(d,c[d]);return a}function ka(a){var b=I(F(a),"amp-analytics-instrumentation");if(b)return b;var c=E(a);return c.whenExtensionsKnown().then((function(){var d=c.getExtensionVersion("amp-analytics");return d?B(c.win,"extensions").waitForExtension("amp-analytics",d):null})).then((function(d){return d?H(F(a),"amp-analytics-instrumentation"):null}))}function la(a,b,c){var d=!1;c=void 0===c?{}:c;d=void 0===d?!0:d;var e=c,f=d;ka(a).then((function(g){g&&g.triggerEventForTarget(a,b,e,f)}))}function ma(a,b){var c=this;this.X=a.getResourceId();this.J=a;this.D=b;for(var d in b.triggers)b.triggers[d].on="sandbox-"+this.X+"-"+b.triggers[d].on;this.J.signals().whenSignal("load-start").then((function(){var e=c.J,f=e.ownerDocument;var g=J(f,"amp-analytics",w({sandbox:"true",trigger:(void 0===g?0:g)?"":"immediate"}));f=J(f,"script",w({type:"application/json"}));f.textContent=JSON.stringify(b);g.appendChild(f);g.CONFIG=b;f=B(e.ownerDocument.defaultView,"extensions");var h=E(e);f.installExtensionForDoc(h,"amp-analytics");e.appendChild(g)}))}ma.prototype.trigger=function(a,b){la(this.J,"sandbox-"+this.X+"-"+a,b)};function K(a){this.J=a;this.D={requests:{},triggers:{}}}K.prototype.setTransportConfig=function(a){this.D.transport=a};K.prototype.setExtraUrlParams=function(a){this.D.extraUrlParams=a};K.prototype.track=function(a,b){b=v(b)?b:[b];for(var c=[],d=0;d<b.length;d++){var e=a+"-request-"+d;this.D.requests[e]=b[d];c.push(e)}this.D.triggers[a]={on:a,request:c};return this};K.prototype.build=function(){var a=new ma(this.J,this.D);this.D=null;return a};var L,na="Webkit webkit Moz moz ms O o".split(" ");var oa=!1;function M(){this.F=[]}M.prototype.peek=function(){var a=this.length;return a?this.F[a-1].item:null};M.prototype.enqueue=function(a,b){if(isNaN(b))throw Error("Priority must not be NaN.");for(var c=-1,d=0,e=this.length;d<=e;){c=Math.floor((d+e)/2);if(c===this.length)break;if(this.F[c].priority<b)d=c+1;else if(0<c&&this.F[c-1].priority>=b)e=c-1;else break}this.F.splice(c,0,{item:a,priority:b})};M.prototype.forEach=function(a){for(var b=this.length;b--;)a(this.F[b].item)};M.prototype.dequeue=function(){return this.length?this.F.pop().item:null};ea.Object.defineProperties(M.prototype,{length:{configurable:!0,enumerable:!0,get:function(){return this.F.length}}});var pa=/nochunking=1/.test(self.location.hash),N=u();function qa(a,b){if(pa)N.then(b);else{var c=O,d=E(a),e=F(d),f=G(e),g=f.chunk;g||(g=f.chunk={obj:null,promise:null,resolve:null,reject:null,context:null,ctor:null,sharedInstance:!1});g.ctor||(g.ctor=c,g.context=d,g.sharedInstance=!1,g.resolve&&C(e,"chunk"));D(a,"chunk").run(b,10)}}function Q(a){this.state="not_run";this.O=a}function ra(a,b){if("run"!=a.state){a.state="run";try{a.O(b)}catch(c){throw a.aa(),c}}}Q.prototype.aa=function(){};Q.prototype.Y=function(){return!1};Q.prototype.da=function(){return!1};function R(a,b,c){Q.call(this,a);this.U=c}r(R,Q);R.prototype.aa=function(){var a=self.document;if(!oa){oa=!0;a=a.body;var c,b={opacity:1,visibility:"visible",animation:"none"};for(c in b){var d=a,e=b[c];var f=d.style;var g=c;if(g.startsWith("--"))f=g;else{L||(L=Object.create(null));var h=L[g];if(!h){h=g;if(void 0===f[g]){var l=g;l=l.charAt(0).toUpperCase()+l.slice(1);b:{for(var P=0;P<na.length;P++){var da=na[P]+l;if(void 0!==f[da]){l=da;break b}}l=""}void 0!==f[l]&&(h=l)}L[g]=h}f=h}f&&(f.startsWith("--")?d.style.setProperty(f,e):d.style[f]=e)}}};R.prototype.Y=function(){return this.U.ampdoc.isVisible()};R.prototype.da=function(){return this.U.V};function O(a){var b=this;this.ampdoc=a;this.h=a.win;this.I=new M;this.T=this.W.bind(this);this.H=0;this.ma=!(!this.h.navigator.scheduling||!this.h.navigator.scheduling.isInputPending);this.N=!1;this.ea=this.h.document.documentElement.hasAttribute("i-amphtml-no-boilerplate");this.h.addEventListener("message",(function(c){"amp-macro-task"==c.data&&b.W(null)}));this.V=!1;H(F(a),"viewer").then((function(){b.V=!0}));a.onVisibilityChanged((function(){a.isVisible()&&S(b)}))}O.prototype.run=function(a,b){a=new Q(a);this.I.enqueue(a,b);S(this)};O.prototype.runForStartup=function(a){a=new R(a,this.h,this);this.I.enqueue(a,Number.POSITIVE_INFINITY);S(this)};function sa(a,b){for(var c=a.I.peek();c&&"not_run"!==c.state;)a.I.dequeue(),c=a.I.peek();c&&b&&a.I.dequeue();return c}O.prototype.W=function(a){var b=this,c=sa(this,!0);if(!c)return this.N=!1,this.H=0,!1;try{var d=Date.now();ra(c,a)}finally{N.then().then().then().then().then().then().then().then().then((function(){b.N=!1;b.H+=Date.now()-d;A().fine("CHUNK",c.O.displayName||c.O.name,"Chunk duration",Date.now()-d,b.H);S(b)}))}return!0};function ta(a){a.ea&&(a.ma?a.h.navigator.scheduling.isInputPending():5<a.H)?(a.H=0,ua(a)):N.then((function(){a.T(null)}))}function S(a){if(!a.N){var b=sa(a);b&&(b.Y()?(a.N=!0,ta(a)):b.da()&&a.h.requestIdleCallback?va(a.h,a.T):ua(a))}}function ua(a){a.h.postMessage("amp-macro-task","*")}function va(a,b){function c(e){if(15>e.timeRemaining()){var f=2e3-(Date.now()-d);0>=f||e.didTimeout?(A().fine("CHUNK","Timed out",2e3,e.didTimeout),b(e)):(A().fine("CHUNK","Rescheduling with",f,e.timeRemaining()),a.requestIdleCallback(c,{timeout:f}))}else A().fine("CHUNK","Running idle callback with ",15),b(e)}var d=Date.now();a.requestIdleCallback(c,{timeout:2e3})}function T(){this.j=[];this.S=[]}T.prototype.updateLinkList=function(a){this.S=a.map(this.getReplacementUrlForAnchor.bind(this));this.j=a};T.prototype.updateReplacementUrls=function(a){var b=this;a.forEach((function(c){var d=c.replacementUrl,e=b.j.indexOf(c.anchor);-1!==e&&(b.S[e]=d)}))};T.prototype.getReplacementUrlForAnchor=function(a){a=this.j.indexOf(a);return-1!==a?this.S[a]:null};T.prototype.isInCache=function(a){return-1!==this.j.indexOf(a)};T.prototype.getAnchorReplacementList=function(){var a=this;return this.j.map((function(b){return{anchor:b,replacementUrl:a.getReplacementUrlForAnchor(b)}}))};function U(){this.o=null}U.prototype.add=function(a){var b=this;this.o||(this.o=[]);this.o.push(a);return function(){b.remove(a)}};U.prototype.remove=function(a){if(this.o){var b=this.o;a=b.indexOf(a);-1!=a&&b.splice(a,1)}};U.prototype.removeAll=function(){this.o&&(this.o.length=0)};U.prototype.fire=function(a){if(this.o)for(var b=k(this.o),c=b.next();!c.done;c=b.next())c=c.value,c(a)};U.prototype.getHandlerCount=function(){var a,b;return null!=(b=null==(a=this.o)?void 0:a.length)?b:0};function V(a,b){this.syncResponse=a;this.asyncResponse=b}function W(a,b,c,d){this.events=new U;this.id=b;this.G=a;this.ka=c;this.fa=d.linkSelector||"a";this.la=300;this.C=new T}W.prototype.getReplacementUrl=function(a){return this.isWatchingLink(a)?this.C.getReplacementUrlForAnchor(a):null};W.prototype.getAnchorReplacementList=function(){return this.C.getAnchorReplacementList()};W.prototype.isWatchingLink=function(a){return this.C.isInCache(a)};W.prototype.rewriteAnchorUrl=function(a){var b=this.getReplacementUrl(a);if(!b||b===a.href)return!1;a.setAttribute("data-link-rewriter-original-url",a.href);a.href=b;setTimeout((function(){a.href=a.getAttribute("data-link-rewriter-original-url");a.removeAttribute("data-link-rewriter-original-url")}),this.la);return!0};W.prototype.onDomUpdated=function(){var a=this;return new Promise((function(b){qa(a.G.nodeType==Node.DOCUMENT_NODE?a.G.documentElement:a.G,(function(){return wa(a).then((function(){a.events.fire({type:"PAGE_SCANNED"});b()}))}))}))};function wa(a){var b=xa(a),c=ya(a,b);a.C.updateLinkList(b);if(!c.length)return u();a.C.updateReplacementUrls(c.map((function(e){return{anchor:e,replacementUrl:null}})));var d=a.ka(c);if(!z.user)throw Error("failed to call initLogConstructor");z.user.assert(d instanceof V,'Invalid response from provided "resolveUnknownLinks" function."resolveUnknownLinks" should return an instance of TwoStepsResponse',void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0);d.syncResponse&&a.C.updateReplacementUrls(d.syncResponse);return d.asyncResponse?d.asyncResponse.then((function(e){a.C.updateReplacementUrls(e)})):u()}function ya(a,b){var c=[];b.forEach((function(d){a.isWatchingLink(d)||c.push(d)}));return c}function xa(a){var b=a.G.querySelectorAll(a.fa);return[].slice.call(b)}w({c:!0,v:!0,a:!0,ad:!0});function X(a){this.G=a.getRootNode();var b=a.getMetaByName("amp-link-rewriter-priorities");this.ha=b?b.trim().split(/\s+/):[];this.R=[];this.G.addEventListener("amp:dom-update",this.ga.bind(this));D(a,"navigation").registerAnchorMutator(this.maybeRewriteLink.bind(this),0)}X.prototype.registerLinkRewriter=function(a,b,c){var d=new W(this.G,a,b,c);za(this.R,d,this.ha);d.onDomUpdated();return d};X.prototype.maybeRewriteLink=function(a,b){var c=Aa(this,a);if(c.length){for(var d=null,e=0;e<c.length;e++)if(c[e].rewriteAnchorUrl(a)){d=c[e];break}var f={linkRewriterId:d?d.id:null,anchor:a,clickType:b.type};c.forEach((function(g){g.events.fire({type:"CLICK",eventData:f})}))}};X.prototype.ga=function(){this.R.forEach((function(a){a.onDomUpdated()}))};function Ba(a){var b=a.hasAttribute("data-link-rewriters")?a.getAttribute("data-link-rewriters").trim():null;return b?b.split(/\s+/):[]}function za(a,b,c){a.push(b);a.sort((function(d,e){var f=c.indexOf(d.id),g=c.indexOf(e.id);return-1===f&&-1===g?0:-1===f?1:-1===g?-1:f>g?1:-1}))}function Aa(a,b){var c=Ba(b);return a.R.reduce((function(d,e){e.isWatchingLink(b)&&za(d,e,c);return d}),[])}function Ca(a,b){if(!isFinite(5))throw Error("Invalid depth: 5");if(a===b)return!0;for(a=[{a:a,b:b,depth:5}];0<a.length;){var c=a.shift();b=c.a;var d=c.b;c=c.depth;if(0<c){if(typeof b!==typeof d)return!1;if(v(b)&&v(d)){if(b.length!==d.length)return!1;for(var e=0;e<b.length;e++)a.push({a:b[e],b:d[e],depth:c-1});continue}else if(b&&d&&"object"===typeof b&&"object"===typeof d){var f=Object.keys(b),g=Object.keys(d);if(f.length!==g.length)return!1;e=k(f);for(var h=e.next();!h.done;h=e.next())h=h.value,a.push({a:b[h],b:d[h],depth:c-1});continue}}if(b!==d)return!1}return!0}function Y(a,b,c){this.K=a;this.ja=b.exclusiveLinks;this.ia=b.publisherID;this.L=b.linkAttribute;this.M=this.j=null;this.h=c}Y.prototype.runLinkmate=function(a){var b=this,c=null,d=this.j&&!Ca(this.j,a);this.M&&d&&(c=Da(this));if(!this.M||d){var e=Ea(this,a).then((function(f){b.M=f.data[0].smart_links;b.j=a;return Da(b)}));return new V(c,e)}this.j=a;return new V(c,null)};function Ea(a,b){var c=Fa(a,b),d=Ga(a);b=w({article:d,links:c});var e="https://api.narrativ.com/api/v1/publishers/.pub_id./linkmate/smart_links/".replace(".pub_id.",a.ia.toString()),f={method:"POST",ampCors:!1,headers:w({"Content-Type":"application/json"}),body:b};return a.K.fetchJson(e,f).then((function(g){return g.json()}))}function Fa(a,b){var c=[];b.forEach((function(d){var e=d.getAttribute(a.L);if(/shop-links.co/.test(e))/\?amp=true$/.test(e)||(d[a.L]+="?amp=true");else if(!/#donotlink$/.test(e)){var f=a.ja||/#locklink$/.test(e);c.push({raw_url:e,exclusive_match_requested:f,link_source:"linkmate"})}}));return c}function Ga(a){var b=null;0<a.h.document.getElementsByTagName("title").length&&(b=a.h.document.getElementsByTagName("title")[0].text);return w({name:b,url:a.P()})}Y.prototype.P=function(){return this.h.location.href};function Da(a){var b=[];a.j.forEach((function(c){a.M.forEach((function(d){c.getAttribute(a.L)===d.url&&d.auction_id&&b.push({anchor:c,replacementUrl:"https://shop-links.co/"+d.auction_id+"/?amp=true"})}))}));return b}function Ha(a){var b=a.getAttribute("nrtv-account-name").toLowerCase(),c=!!a.hasAttribute("linkmate"),d=!!a.hasAttribute("exclusive-links");var e=(e=a.getAttribute("link-attribute"))?e.toLowerCase():"href";a=(a=a.getAttribute("link-selector"))?a.toLowerCase():"a";return{nrtvSlug:b,linkmateEnabled:c,exclusiveLinks:d,linkAttribute:e,linkSelector:a}}function Z(a){a=AMP.BaseElement.call(this,a)||this;a.K=null;a.B=null;a.Z=null;a.ca=null;a.A=null;a.$=null;a.ba=null;return a}r(Z,AMP.BaseElement);Z.prototype.buildCallback=function(){var a=this;this.B=this.getAmpDoc();this.K=B(this.B.win,"xhr");var b=D(this.B,"viewer");this.A=Ha(this.element);this.Z=new X(this.B);return this.B.whenReady().then((function(){return b.getReferrerUrl()})).then((function(c){a.ba=c;a.B.whenFirstVisible().then((function(){Ia(a)}))}))};function Ia(a){Ja(a).then((function(b){if(b){a.A.linkmateExpected=b.linkmate_enabled;a.A.publisherID=b.publisher_id;a.signals().signal("load-start");b=w({events:[{is_amp:!0}],organization_id:a.A.publisherID,organization_type:"publisher",user:{page_session_uuid:Ka(),source_url:a.P(),previous_url:a.ba,user_agent:a.B.win.navigator.userAgent}});var c=new K(a.element);c.track("page-impression","https://api.narrativ.com/api/v1/events/impressions/page_impression/");c.setTransportConfig(w({beacon:!0,image:!1,xhrpost:!0,useBody:!0}));c.setExtraUrlParams(b);c.build().trigger("page-impression");a.$=new Y(a.K,a.A,a.win);a.ca=La(a);a.A.linkmateEnabled&&a.A.linkmateExpected&&a.ca.getAnchorReplacementList()}}))}function Ja(a){var b="https://api.narrativ.com/api/v0/publishers/.nrtv_slug./amp_config/".replace(".nrtv_slug.",a.A.nrtvSlug);try{return a.K.fetchJson(b,{method:"GET",ampCors:!1}).then((function(c){return c.json()})).then((function(c){return c.data[0].amp_config}))}catch(c){return null}}function La(a){return a.Z.registerLinkRewriter("amp-smartlinks",(function(b){return a.$.runLinkmate(b)}),{linkSelector:a.A.linkSelector})}Z.prototype.P=function(){return this.win.location.href};function Ka(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(a){return(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16)}))}(function(a){a.registerElement("amp-smartlinks",Z)})(self.AMP)}});//# sourceMappingURL=amp-smartlinks-0.1.js.map