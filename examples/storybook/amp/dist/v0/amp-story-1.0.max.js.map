{
  "version": 3,
  "sources": ["../../node_modules/@ampproject/toolbox-cache-url/dist/amp-toolbox-cache-url.umd.js", "../../src/core/data-structures/promise.js", "../../src/core/types/array.js", "../../src/core/types/enum.js", "../../src/core/types/string/index.js", "../../src/core/types/object/index.js", "../../src/core/types/index.js", "../../src/core/error/message-helpers.js", "../../src/core/assert/base.js", "../../src/internal-version.js", "../../src/core/types/string/url.js", "../../src/mode.js", "../../src/core/types/function/index.js", "../../src/config.js", "../../src/log.js", "../../src/static-template.js", "../../src/core/window/index.js", "../../src/service.js", "../../src/experiments/index.js", "../../src/style.js", "../../src/layout.js", "../../extensions/amp-story/1.0/amp-story-base-layer.js", "../../src/core/minified-mode.js", "../../src/core/assert/dev.js", "../../third_party/css-escape/css-escape.js", "../../src/core/dom/css-selectors.js", "../../src/core/dom/query.js", "../../src/dom.js", "../../extensions/amp-story/1.0/amp-story-cta-layer.js", "../../extensions/amp-story/1.0/embed-mode.js", "../../src/core/data-structures/observable.js", "../../src/service/extension-script.js", "../../src/element-service.js", "../../src/services.js", "../../src/core/types/object/json.js", "../../extensions/amp-story/1.0/amp-story-store-service.js", "../../extensions/amp-story/1.0/prerender-active-page.js", "../../extensions/amp-story/1.0/amp-story-grid-layer.js", "../../extensions/amp-story/1.0/variable-service.js", "../../src/analytics.js", "../../extensions/amp-story/1.0/story-analytics.js", "../../extensions/amp-story/1.0/amp-story-affiliate-link.js", "../../src/core/constants/action-constants.js", "../../src/core/constants/key-codes.js", "../../src/core/dom/event-helper-listen.js", "../../src/event-helper.js", "../../src/core/constants/amp-events.js", "../../src/core/data-structures/lru-cache.js", "../../src/url.js", "../../src/core/constants/common-signals.js", "../../src/core/constants/enums.js", "../../src/style-installer.js", "../../src/error-reporting.js", "../../src/service/action-impl.js", "../../src/video-interface.js", "../../third_party/webcomponentsjs/ShadowCSS.js", "../../src/core/dom/web-components.js", "../../src/shadow-embed.js", "../../extensions/amp-story/1.0/utils.js", "../../build/amp-story-tooltip-1.0.css.js", "../../extensions/amp-story/1.0/events.js", "../../src/localized-strings.js", "../../src/service/localization.js", "../../extensions/amp-story/1.0/amp-story-localization-service.js", "../../extensions/amp-story/1.0/amp-story-embedded-component.js", "../../extensions/amp-story/1.0/page-advancement.js", "../../extensions/amp-animation/0.1/web-animation-types.js", "../../extensions/amp-story/1.0/animation-presets-utils.js", "../../extensions/amp-story/1.0/animation-presets.js", "../../src/json.js", "../../extensions/amp-story/1.0/animation.js", "../../extensions/amp-story/1.0/simple-template.js", "../../extensions/amp-story/1.0/loading-spinner.js", "../../extensions/amp-story/1.0/sources.js", "../../extensions/amp-story/1.0/media-tasks.js", "../../extensions/amp-story/1.0/media-pool.js", "../../src/iframe-helper.js", "../../extensions/amp-story/1.0/logging.js", "../../extensions/amp-story/1.0/media-performance-metrics-service.js", "../../src/utils/video.js", "../../extensions/amp-story/1.0/amp-story-page-attachment-ui-v2.js", "../../build/amp-story-open-page-attachment-0.1.css.js", "../../src/core/dom/media-query-props.js", "../../build/amp-story-draggable-drawer-header-1.0.css.js", "../../extensions/amp-story/1.0/amp-story-draggable-drawer.js", "../../src/core/window/history.js", "../../extensions/amp-story/1.0/history.js", "../../extensions/amp-story/1.0/amp-story-page-attachment.js", "../../extensions/amp-story/1.0/amp-story-open-page-attachment.js", "../../extensions/amp-story/1.0/semantic-render.js", "../../extensions/amp-story/1.0/audio.js", "../../extensions/amp-story/1.0/amp-story-page.js", "../../extensions/amp-story/1.0/amp-story-access.js", "../../build/amp-story-consent-1.0.css.js", "../../extensions/amp-story/1.0/amp-story-consent.js", "../../build/amp-story-hint-1.0.css.js", "../../extensions/amp-story/1.0/amp-story-hint.js", "../../extensions/amp-story/1.0/amp-story-render-service.js", "../../extensions/amp-story/1.0/amp-story-viewer-messaging-handler.js", "../../build/amp-story-1.0.css.js", "../../src/pass.js", "../../src/gesture.js", "../../build/amp-story-info-dialog-1.0.css.js", "../../extensions/amp-story/1.0/amp-story-info-dialog.js", "../../extensions/amp-story/1.0/live-story-manager.js", "../../extensions/amp-story/1.0/pagination-buttons.js", "../../build/amp-story-share-menu-1.0.css.js", "../../extensions/amp-story/1.0/toast.js", "../../src/clipboard.js", "../../extensions/amp-story/1.0/amp-story-request-service.js", "../../extensions/amp-story/1.0/amp-story-share.js", "../../extensions/amp-story/1.0/amp-story-share-menu.js", "../../src/motion.js", "../../src/gesture-recognizers.js", "../../src/amp-story-player/amp-story-player-impl.js", "../../src/core/constants/visibility-state.js", "../../build/amp-story-system-layer-1.0.css.js", "../../extensions/amp-story/1.0/development-ui.js", "../../extensions/amp-story/1.0/progress-bar.js", "../../extensions/amp-story/1.0/amp-story-system-layer.js", "../../build/amp-story-unsupported-browser-layer-1.0.css.js", "../../extensions/amp-story/1.0/amp-story-unsupported-browser-layer.js", "../../build/amp-story-viewport-warning-layer-1.0.css.js", "../../extensions/amp-story/1.0/amp-story-viewport-warning-layer.js", "../../src/consent.js", "../../extensions/amp-story/1.0/amp-story-media-query-service.js", "../../extensions/amp-story/1.0/amp-story.js"],
  "sourcesContent": ["'use strict';(function(m,q){\"object\"===typeof exports&&\"undefined\"!==typeof module?q(exports):\"function\"===typeof define&&define.amd?define([\"exports\"],q):(m=\"undefined\"!==typeof globalThis?globalThis:m||self,q(m.AmpToolboxCacheUrl={}))})(this,function(m){function q(a){try{return decodeURIComponent(a.replace(/\\+/g,\" \"))}catch(b){return null}}function t(a){return(a?a:\"\").toString().replace(N,\"\")}function z(a){var b=(\"undefined\"!==typeof window?window:\"undefined\"!==typeof A?A:\"undefined\"!==typeof self?\nself:{}).location||{};a=a||b;b={};var d=typeof a,c;if(\"blob:\"===a.protocol)b=new k(unescape(a.pathname),{});else if(\"string\"===d)for(c in b=new k(a,{}),B)delete b[c];else if(\"object\"===d){for(c in a)c in B||(b[c]=a[c]);void 0===b.slashes&&(b.slashes=O.test(a.href))}return b}function C(a){a=t(a);a=P.exec(a);return{protocol:a[1]?a[1].toLowerCase():\"\",slashes:!!(a[2]&&2<=a[2].length),rest:a[2]&&1===a[2].length?\"/\"+a[3]:a[3]}}function k(a,b,d){a=t(a);if(!(this instanceof k))return new k(a,b,d);var c=\nu.slice();var e=typeof b;var l=0;\"object\"!==e&&\"string\"!==e&&(d=b,b=null);d&&\"function\"!==typeof d&&(d=r.parse);b=z(b);var f=C(a||\"\");e=!f.protocol&&!f.slashes;this.slashes=f.slashes||e&&b.slashes;this.protocol=f.protocol||b.protocol||\"\";a=f.rest;for(f.slashes||(c[3]=[/(.*)/,\"pathname\"]);l<c.length;l++)if(f=c[l],\"function\"===typeof f)a=f(a);else{var h=f[0];var g=f[1];if(h!==h)this[g]=a;else if(\"string\"===typeof h)~(h=a.indexOf(h))&&(\"number\"===typeof f[2]?(this[g]=a.slice(0,h),a=a.slice(h+f[2])):\n(this[g]=a.slice(h),a=a.slice(0,h)));else if(h=h.exec(a))this[g]=h[1],a=a.slice(0,h.index);this[g]=this[g]||(e&&f[3]?b[g]||\"\":\"\");f[4]&&(this[g]=this[g].toLowerCase())}d&&(this.query=d(this.query));if(e&&b.slashes&&\"/\"!==this.pathname.charAt(0)&&(\"\"!==this.pathname||\"\"!==b.pathname)){a=this.pathname;b=b.pathname;if(\"\"!==a){b=(b||\"/\").split(\"/\").slice(0,-1).concat(a.split(\"/\"));a=b.length;d=b[a-1];c=!1;for(l=0;a--;)\".\"===b[a]?b.splice(a,1):\"..\"===b[a]?(b.splice(a,1),l++):l&&(0===a&&(c=!0),b.splice(a,\n1),l--);c&&b.unshift(\"\");\".\"!==d&&\"..\"!==d||b.push(\"\");b=b.join(\"/\")}this.pathname=b}\"/\"!==this.pathname.charAt(0)&&this.hostname&&(this.pathname=\"/\"+this.pathname);D(this.port,this.protocol)||(this.host=this.hostname,this.port=\"\");this.username=this.password=\"\";this.auth&&(f=this.auth.split(\":\"),this.username=f[0]||\"\",this.password=f[1]||\"\");this.origin=this.protocol&&this.host&&\"file:\"!==this.protocol?this.protocol+\"//\"+this.host:\"null\";this.href=this.toString()}function p(a){throw new RangeError(Q[a]);\n}function E(a,b){var d=a.split(\"@\");let c=\"\";1<d.length&&(c=d[0]+\"@\",a=d[1]);a=a.replace(R,\".\");{a=a.split(\".\");d=[];let c=a.length;for(;c--;)d[c]=b(a[c]);b=d}b=b.join(\".\");return c+b}function F(a){let b=[],d=0,c=a.length;for(;d<c;){let e=a.charCodeAt(d++);if(55296<=e&&56319>=e&&d<c){let c=a.charCodeAt(d++);56320==(c&64512)?b.push(((e&1023)<<10)+(c&1023)+65536):(b.push(e),d--)}else b.push(e)}return b}function S(a){a=(new TextEncoder(\"utf-8\")).encode(a);return window.crypto.subtle.digest(\"SHA-256\",\na).then(a=>{var b=[];a=new DataView(a);for(let c=0;c<a.byteLength;c+=4){let d=(\"00000000\"+a.getUint32(c).toString(16)).slice(-8);b.push(d)}return b=b.join(\"\")})}function v(a){a=(new w(a)).hostname;if(G(a))var b=!1;else b=x.toUnicode(a),b=63>=a.length&&!(T.test(b)&&U.test(b))&&-1!=a.indexOf(\".\");if(b){b=x.toUnicode(a);b=b.split(\"-\").join(\"--\");b=b.split(\".\").join(\"-\");b=x.toASCII(b).toLowerCase();if(63<b.length)return H(a);G(b)&&(b=\"0-\".concat(b,\"-0\"));return Promise.resolve(b)}return H(a)}function H(a){a=\n\"undefined\"!==typeof window?S(a):void 0;return a.then(a=>V(\"ffffffffff\"+a+\"000000\").substr(8,Math.ceil(4*a.length/5)))}function V(a){let b=[];a.match(/.{1,2}/g).forEach((a,c)=>{b[c]=parseInt(a,16)});var d=b.length%5,c=Math.floor(b.length/5);a=[];if(0!=d){for(var e=0;e<5-d;e++)b+=\"\\x00\";c+=1}for(e=0;e<c;e++)a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt(b[5*e]>>3)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e]&7)<<2|b[5*e+1]>>6)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e+\n1]&63)>>1)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e+1]&1)<<4|b[5*e+2]>>4)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e+2]&15)<<1|b[5*e+3]>>7)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e+3]&127)>>2)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt((b[5*e+3]&3)<<3|b[5*e+4]>>5)),a.push(\"abcdefghijklmnopqrstuvwxyz234567\".charAt(b[5*e+4]&31));c=0;1==d?c=6:2==d?c=4:3==d?c=3:4==d&&(c=1);for(d=0;d<c;d++)a.pop();for(d=0;d<c;d++)a.push(\"=\");return a.join(\"\")}function G(a){return\"--\"==\na.slice(2,4)&&\"xn\"!=a.slice(0,2)}function I(a,b,d=null){let c=new w(b),e=W(c.pathname,d);e+=\"https:\"===c.protocol?\"/s/\":\"/\";b.endsWith(\"/\")||(c.pathname=c.pathname.replace(/\\/$/,\"\"));return v(c.toString()).then(d=>{let f=new w(b);f.protocol=\"https\";d=d+\".\"+a;f.host=d;f.hostname=d;f.pathname=e+c.hostname+c.pathname;return f.toString()})}function W(a,b=null){return X.isPathNameAnImage(a)?\"/i\":Y.isPathNameAFont(a)?\"/r\":b===Z.VIEWER?\"/v\":\"/c\"}let aa=\"ase art bmp blp cd5 cit cpt cr2 cut dds dib djvu egt exif gif gpl grf icns ico iff jng jpeg jpg jfif jp2 jps lbm max miff mng msp nitf ota pbm pc1 pc2 pc3 pcf pcx pdn pgm PI1 PI2 PI3 pict pct pnm pns ppm psb psd pdd psp px pxm pxr qfx raw rle sct sgi rgb int bw tga tiff tif vtf xbm xcf xpm 3dv amf ai awg cgm cdr cmx dxf e2d egt eps fs gbr odg svg stl vrml x3d sxd v2d vnd wmf emf art xar png webp jxr hdp wdp cur ecw iff lbm liff nrrd pam pcx pgf sgi rgb rgba bw int inta sid ras sun tga\".split(\" \"),\nX={isPathNameAnImage:a=>aa.some(b=>a.endsWith(`.${b}`)?!0:!1)},ba=\"### #gf $on $tf 0b 8m 8u 12u 15u 64c 075 75 085 85 91 091 096 96 abf acfm acs afm afn afs all amfm apf asf aspf atm auf b30 bco bdf bepf bez bfn bmap bmf bx bzr cbtf cct cef cff cfn cga ch4 cha chm chr chx claf collection compositefont dfont dus dzk eft eot etx euf f00 f06 f08 f09 f3f f10 f11 f12 f13 f16 fd fdb ff ffil flf fli fn3 fnb fnn fnt fnta fo1 fo2 fog fon font fonts fot frf frs ftm fxr fyi gdr gf gft glf glif glyphs gsf gxf hbf ice intellifont lepf lft lwfn mcf mcf mfd mfm mft mgf mmm mrf mtf mvec nlq ntf odttf ofm okf otf pcf pcf pfa pfb pfm pft phf pk pkt prs pss qbf qfn r8? scr sfd sff sfi sfl sfn sfo sfp sfs sif snf spd spritefont sui suit svg sxs t1c t2 tb1 tb2 tdf tfm tmf tpf ttc tte ttf type ufm ufo usl usp us? vf vf1 vf3 vfb vfm vfont vlw vmf vnf w30 wfn wnf woff woff2 xfc xfn xfr xft zfi zsu _v\".split(\" \"),\nY={isPathNameAFont:a=>ba.some(b=>a.endsWith(`.${b}`)?!0:!1)};var A=\"undefined\"!==typeof globalThis?globalThis:\"undefined\"!==typeof window?window:\"undefined\"!==typeof global?global:\"undefined\"!==typeof self?self:{},D=function(a,b){b=b.split(\":\")[0];a=+a;if(!a)return!1;switch(b){case \"http\":case \"ws\":return 80!==a;case \"https\":case \"wss\":return 443!==a;case \"ftp\":return 21!==a;case \"gopher\":return 70!==a;case \"file\":return!1}return 0!==a},ca=Object.prototype.hasOwnProperty,r={stringify:function(a,b){b=\nb||\"\";var d=[],c;\"string\"!==typeof b&&(b=\"?\");for(e in a)if(ca.call(a,e)){(c=a[e])||null!==c&&void 0!==c&&!isNaN(c)||(c=\"\");var e=encodeURIComponent(e);c=encodeURIComponent(c);null!==e&&null!==c&&d.push(e+\"=\"+c)}return d.length?b+d.join(\"&\"):\"\"},parse:function(a){for(var b=/([^=?&]+)=?([^&]*)/g,d={},c;c=b.exec(a);){var e=q(c[1]);c=q(c[2]);null===e||null===c||e in d||(d[e]=c)}return d}},O=/^[A-Za-z][A-Za-z0-9+-.]*:[\\\\/]+/,P=/^([a-z][a-z0-9.+-]*:)?([\\\\/]{1,})?([\\S\\s]*)/i,N=/^[\\x09\\x0A\\x0B\\x0C\\x0D\\x20\\xA0\\u1680\\u180E\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200A\\u202F\\u205F\\u3000\\u2028\\u2029\\uFEFF]+/,\nu=[[\"#\",\"hash\"],[\"?\",\"query\"],function(a){return a.replace(\"\\\\\",\"/\")},[\"/\",\"pathname\"],[\"@\",\"auth\",1],[NaN,\"host\",void 0,1,1],[/:(\\d+)$/,\"port\",void 0,1],[NaN,\"hostname\",void 0,1,1]],B={hash:1,query:1};k.prototype={set:function(a,b,d){switch(a){case \"query\":\"string\"===typeof b&&b.length&&(b=(d||r.parse)(b));this[a]=b;break;case \"port\":this[a]=b;D(b,this.protocol)?b&&(this.host=this.hostname+\":\"+b):(this.host=this.hostname,this[a]=\"\");break;case \"hostname\":this[a]=b;this.port&&(b+=\":\"+this.port);this.host=\nb;break;case \"host\":this[a]=b;/:\\d+$/.test(b)?(b=b.split(\":\"),this.port=b.pop(),this.hostname=b.join(\":\")):(this.hostname=b,this.port=\"\");break;case \"protocol\":this.protocol=b.toLowerCase();this.slashes=!d;break;case \"pathname\":case \"hash\":b?(d=\"pathname\"===a?\"/\":\"#\",this[a]=b.charAt(0)!==d?d+b:b):this[a]=b;break;default:this[a]=b}for(a=0;a<u.length;a++)b=u[a],b[4]&&(this[b[1]]=this[b[1]].toLowerCase());this.origin=this.protocol&&this.host&&\"file:\"!==this.protocol?this.protocol+\"//\"+this.host:\"null\";\nthis.href=this.toString();return this},toString:function(a){a&&\"function\"===typeof a||(a=r.stringify);var b=this.protocol;b&&\":\"!==b.charAt(b.length-1)&&(b+=\":\");b+=this.slashes?\"//\":\"\";this.username&&(b+=this.username,this.password&&(b+=\":\"+this.password),b+=\"@\");b+=this.host+this.pathname;(a=\"object\"===typeof this.query?a(this.query):this.query)&&(b+=\"?\"!==a.charAt(0)?\"?\"+a:a);this.hash&&(b+=this.hash);return b}};k.extractProtocol=C;k.location=z;k.trimLeft=t;k.qs=r;var w=k;let da=/^xn--/,ea=/[^\\0-\\x7E]/,\nR=/[\\x2E\\u3002\\uFF0E\\uFF61]/g,Q={overflow:\"Overflow: input needs wider integers to process\",\"not-basic\":\"Illegal input >= 0x80 (not a basic code point)\",\"invalid-input\":\"Invalid input\"},n=Math.floor,y=String.fromCharCode,J=function(a,b){return a+22+75*(26>a)-((0!=b)<<5)},K=function(a,b,d){let c=0;a=d?n(a/700):a>>1;for(a+=n(a/b);455<a;c+=36)a=n(a/35);return n(c+36*a/(a+38))},L=function(a){const b=[],d=a.length;let c=0,e=128,l=72;var f=a.lastIndexOf(\"-\");0>f&&(f=0);for(var h=0;h<f;++h)128<=a.charCodeAt(h)&&\np(\"not-basic\"),b.push(a.charCodeAt(h));for(f=0<f?f+1:0;f<d;){h=c;for(let b=1,e=36;;e+=36){f>=d&&p(\"invalid-input\");var g=a.charCodeAt(f++);g=10>g-48?g-22:26>g-65?g-65:26>g-97?g-97:36;(36<=g||g>n((2147483647-c)/b))&&p(\"overflow\");c+=g*b;const h=e<=l?1:e>=l+26?26:e-l;if(g<h)break;g=36-h;b>n(2147483647/g)&&p(\"overflow\");b*=g}g=b.length+1;l=K(c-h,g,0==h);n(c/g)>2147483647-e&&p(\"overflow\");e+=n(c/g);c%=g;b.splice(c++,0,e)}return String.fromCodePoint(...b)},M=function(a){const b=[];a=F(a);let d=a.length,\nc=128,e=0,l=72;for(var f of a)128>f&&b.push(y(f));let h=f=b.length;for(f&&b.push(\"-\");h<d;){var g=2147483647;for(const b of a)b>=c&&b<g&&(g=b);const d=h+1;g-c>n((2147483647-e)/d)&&p(\"overflow\");e+=(g-c)*d;c=g;for(const m of a)if(m<c&&2147483647<++e&&p(\"overflow\"),m==c){var k=e;for(g=36;;g+=36){const a=g<=l?1:g>=l+26?26:g-l;if(k<a)break;k-=a;const c=36-a;b.push(y(J(a+k%c,0)));k=n(k/c)}b.push(y(J(k,0)));l=K(e,d,h==f);e=0;++h}++e;++c}return b.join(\"\")},x={version:\"2.1.0\",ucs2:{decode:F,encode:a=>String.fromCodePoint(...a)},\ndecode:L,encode:M,toASCII:function(a){return E(a,function(a){return ea.test(a)?\"xn--\"+M(a):a})},toUnicode:function(a){return E(a,function(a){return da.test(a)?L(a.slice(4).toLowerCase()):a})}},T=/[A-Za-z\\u00c0-\\u00d6\\u00d8-\\u00f6\\u00f8-\\u02b8\\u0300-\\u0590\\u0800-\\u1fff\\u200e\\u2c00-\\ufb1c\\ufe00-\\ufe6f\\ufefd-\\uffff]/,U=/[\\u0591-\\u06ef\\u06fa-\\u07ff\\u200f\\ufb1d-\\ufdff\\ufe70-\\ufefc]/,Z={CONTENT:\"content\",VIEWER:\"viewer\",WEB_PACKAGE:\"web_package\",CERTIFICATE:\"certificate\",IMAGE:\"image\"},fa={createCacheUrl:I,\ncreateCurlsSubdomain:v};m.createCacheUrl=I;m.createCurlsSubdomain=v;m.default=fa;Object.defineProperty(m,\"__esModule\",{value:!0})})\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nlet resolved;\n\n/**\n * Returns a cached resolved promise.\n * Babel converts direct calls to Promise.resolve() (with no arguments) into\n * calls to this.\n *\n * @return {!Promise<undefined>}\n */\nexport function resolvedPromise() {\n  if (resolved) {\n    return resolved;\n  }\n\n  // It's important that we call with `undefined` here, to prevent a transform\n  // recursion. If we didn't pass an arg, then the transformer would replace\n  // this callsite with a call to `resolvedPromise()`.\n  resolved = Promise.resolve(undefined);\n  return resolved;\n}\n\n/**\n * Returns a Deferred struct, which holds a pending promise and its associated\n * resolve and reject functions.\n *\n * This is preferred instead of creating a Promise instance to extract the\n * resolve/reject functions yourself:\n *\n * ```\n * // Avoid doing\n * let resolve;\n * const promise = new Promise(res => {\n *   resolve = res;\n * });\n *\n * // Good\n * const deferred = new Deferred();\n * const { promise, resolve } = deferred;\n * ```\n *\n * @template T\n */\nexport class Deferred {\n  /** Constructor. */\n  constructor() {\n    /** @const {!Promise<T>} */\n    this.promise = new /*OK*/ Promise((res, rej) => {\n      /** @const {function(T=)} */\n      this.resolve = res;\n      /** @const {function(*=)} */\n      this.reject = rej;\n    });\n  }\n}\n\n/**\n * Creates a promise resolved to the return value of fn.\n * If fn sync throws, it will cause the promise to reject.\n *\n * @param {function():T} fn\n * @return {!Promise<T>}\n * @template T\n */\nexport function tryResolve(fn) {\n  return new Promise((resolve) => {\n    resolve(fn());\n  });\n}\n\n/**\n * Resolves with the result of the last promise added.\n * @implements {IThenable}\n */\nexport class LastAddedResolver {\n  /**\n   * @param {!Array<!IThenable>=} opt_promises\n   */\n  constructor(opt_promises) {\n    /** @private @const {!Deferred} */\n    this.deferred_ = new Deferred();\n\n    /** @private */\n    this.count_ = 0;\n\n    if (opt_promises) {\n      for (const promise of opt_promises) {\n        this.add(promise);\n      }\n    }\n  }\n\n  /**\n   * Add a promise to possibly be resolved.\n   * @param {!IThenable} promise\n   * @return {!Promise}\n   */\n  add(promise) {\n    const countAtAdd = ++this.count_;\n    promise.then(\n      (result) => {\n        if (this.count_ === countAtAdd) {\n          this.deferred_.resolve(result);\n        }\n      },\n      (error) => {\n        // Don't follow behavior of Promise.all and Promise.race error so that\n        // this will only reject when most recently added promise fails.\n        if (this.count_ === countAtAdd) {\n          this.deferred_.reject(error);\n        }\n      }\n    );\n    return this.deferred_.promise;\n  }\n\n  /** @override */\n  then(opt_resolve, opt_reject) {\n    return this.deferred_.promise.then(opt_resolve, opt_reject);\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Converts an array-like object to an array.\n * @param {?IArrayLike<T>|string} arrayLike\n * @return {!Array<T>}\n * @template T\n */\nexport function toArray(arrayLike) {\n  return arrayLike ? Array.prototype.slice.call(arrayLike) : [];\n}\n\n/**\n * Determines if value is actually an Array.\n * @param {*} value\n * @return {boolean}\n */\nexport const {isArray} = Array;\n\n/**\n * If the specified argument is an array, it's returned as is. If it's a\n * single item, the array containing this item is created and returned.\n *\n * The double-template pattern here solves a bug where CC can be passed a value\n * with declared type {string|!Array<string>} and return a value with a type of\n * {!Array<string|Array<string>>}.\n *\n * @param {!Array<T>|S} arrayOrSingleItem\n * @return {!Array<T>|!Array<S>}\n * @template S\n * @template T\n */\nexport function arrayOrSingleItemToArray(arrayOrSingleItem) {\n  return isArray(arrayOrSingleItem)\n    ? /** @type {!Array<T>} */ (arrayOrSingleItem)\n    : [/** @type {!S} */ (arrayOrSingleItem)];\n}\n\n/**\n * Compares if two arrays contains exactly same elements of same number\n * of same order. Note that it does NOT handle NaN case as expected.\n *\n * @param {!Array<T>} arr1\n * @param {!Array<T>} arr2\n * @return {boolean}\n * @template T\n */\nexport function areEqualOrdered(arr1, arr2) {\n  if (arr1.length !== arr2.length) {\n    return false;\n  }\n  for (let i = 0; i < arr1.length; i++) {\n    if (arr1[i] !== arr2[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Removes elements that shouldRemove returns true for from the array.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} shouldRemove\n * @return {!Array<T>}\n * @template T\n */\nexport function remove(array, shouldRemove) {\n  const removed = [];\n  let index = 0;\n  for (let i = 0; i < array.length; i++) {\n    const item = array[i];\n    if (shouldRemove(item, i, array)) {\n      removed.push(item);\n    } else {\n      if (index < i) {\n        array[index] = item;\n      }\n      index++;\n    }\n  }\n  if (index < array.length) {\n    array.length = index;\n  }\n  return removed;\n}\n\n/**\n * Returns the index of the first element matching the predicate.\n * Like Array#findIndex.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} predicate\n * @return {number}\n * @template T\n */\nexport function findIndex(array, predicate) {\n  for (let i = 0; i < array.length; i++) {\n    if (predicate(array[i], i, array)) {\n      return i;\n    }\n  }\n  return -1;\n}\n\n/**\n * Converts the given iterator to an array.\n *\n * @param {!Iterator<T>} iterator\n * @return {Array<T>}\n * @template T\n */\nexport function fromIterator(iterator) {\n  const array = [];\n  for (let e = iterator.next(); !e.done; e = iterator.next()) {\n    array.push(e.value);\n  }\n  return array;\n}\n\n/**\n * Adds item to array if it is not already present.\n *\n * @param {Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function pushIfNotExist(array, item) {\n  if (array.indexOf(item) < 0) {\n    array.push(item);\n    return true;\n  }\n  return false;\n}\n\n/**\n * Removes the first matching item in the array. Returns `true` if the array\n * has changed.\n *\n * @param {!Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function removeItem(array, item) {\n  const index = array.indexOf(item);\n  if (index == -1) {\n    return false;\n  }\n  array.splice(index, 1);\n  return true;\n}\n\n/**\n * Returns the last item in an array.\n *\n * @param {Array<T>} array\n * @template T\n * @return {?T}\n */\nexport function lastItem(array) {\n  return array[array.length - 1];\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Checks whether `val` is a valid value of `enumObj`.\n *\n * @param {!Object<T>} enumObj\n * @param {T} val\n * @return {boolean}\n * @template T\n */\nexport function isEnumValue(enumObj, val) {\n  for (const k in enumObj) {\n    if (enumObj[k] === val) {\n      return true;\n    }\n  }\n  return false;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {string} _match\n * @param {string} character\n * @return {string}\n */\nfunction toUpperCase(_match, character) {\n  return character.toUpperCase();\n}\n\n/**\n * @param {string} match\n * @return {string}\n */\nfunction prependDashAndToLowerCase(match) {\n  return '-' + match.toLowerCase();\n}\n\n/**\n * @param {string} name Attribute name containing dashes.\n * @return {string} Dashes removed and successive character sent to upper case.\n * visibleForTesting\n */\nexport function dashToCamelCase(name) {\n  return name.replace(/-([a-z])/g, toUpperCase);\n}\n\n/**\n * Converts a string that is in camelCase to one that is in dash-case.\n *\n * @param {string} string The string to convert.\n * @return {string} The string in dash-case.\n */\nexport function camelCaseToDash(string) {\n  return string.replace(/(?!^)[A-Z]/g, prependDashAndToLowerCase);\n}\n\n/**\n * @param {string} name Attribute name with dashes\n * @return {string} Dashes replaced by underlines.\n */\nexport function dashToUnderline(name) {\n  return name.replace('-', '_');\n}\n\n/**\n * Polyfill for String.prototype.endsWith.\n * @param {string} string\n * @param {string} suffix\n * @return {boolean}\n */\nexport function endsWith(string, suffix) {\n  const index = string.length - suffix.length;\n  return index >= 0 && string.indexOf(suffix, index) == index;\n}\n\n/**\n * Polyfill for String.prototype.includes.\n * @param {string} string\n * @param {string} substring\n * @param {number=} start\n * @return {boolean}\n */\nexport function includes(string, substring, start) {\n  if (typeof start !== 'number') {\n    start = 0;\n  }\n  if (start + substring.length > string.length) {\n    return false;\n  }\n  return string.indexOf(substring, start) !== -1;\n}\n\n/**\n * Expands placeholders in a given template string with values.\n *\n * Placeholders use ${key-name} syntax and are replaced with the value\n * returned from the given getter function.\n *\n * @param {string} template The template string to expand.\n * @param {function(string):*} getter Function used to retrieve a value for a\n *   placeholder. Returns values will be coerced into strings.\n * @param {number=} opt_maxIterations Number of times to expand the template.\n *   Defaults to 1, but should be set to a larger value your placeholder tokens\n *   can be expanded to other placeholder tokens. Take caution with large values\n *   as recursively expanding a string can be exponentially expensive.\n * @return {string}\n */\nexport function expandTemplate(template, getter, opt_maxIterations) {\n  const maxIterations = opt_maxIterations || 1;\n  for (let i = 0; i < maxIterations; i++) {\n    let matches = 0;\n    template = template.replace(/\\${([^}]*)}/g, (_a, b) => {\n      matches++;\n      return getter(b);\n    });\n    if (!matches) {\n      break;\n    }\n  }\n  return template;\n}\n\n/**\n * Hash function djb2a\n * This is intended to be a simple, fast hashing function using minimal code.\n * It does *not* have good cryptographic properties.\n * @param {string} str\n * @return {string} 32-bit unsigned hash of the string\n */\nexport function stringHash32(str) {\n  const {length} = str;\n  let hash = 5381;\n  for (let i = 0; i < length; i++) {\n    hash = (hash * 33) ^ str.charCodeAt(i);\n  }\n  // Convert from 32-bit signed to unsigned.\n  return String(hash >>> 0);\n}\n\n/**\n * Trims a string on the end, removing whitespace characters.\n * @param {string} str  A string to trim.\n * @return {string} The string, with trailing whitespace removed.\n */\nexport function trimEnd(str) {\n  // TODO(sparhami) Does this get inlined for an ES2019 build?\n  if (str.trimEnd) {\n    return str.trimEnd();\n  }\n\n  return ('_' + str).trim().slice(1);\n}\n\n/**\n * Trims any leading whitespace from a string.\n * @param {string} str  A string to trim.\n * @return {string} The string, with leading whitespace removed.\n */\nexport function trimStart(str) {\n  if (str.trimStart) {\n    return str.trimStart();\n  }\n\n  return (str + '_').trim().slice(0, -1);\n}\n\n/**\n * Wrapper around String.replace that handles asynchronous resolution.\n * @param {string} str\n * @param {RegExp} regex\n * @param {Function|string} replacer\n * @return {!Promise<string>}\n */\nexport function asyncStringReplace(str, regex, replacer) {\n  if (isString(replacer)) {\n    return Promise.resolve(str.replace(regex, replacer));\n  }\n  const stringBuilder = [];\n  let lastIndex = 0;\n\n  str.replace(regex, function (match) {\n    // String.prototype.replace will pass 3 to n number of arguments to the\n    // callback function based on how many capture groups the regex may or may\n    // not contain. We know that the match will always be first, and the\n    // index will always be second to last.\n    const matchIndex = arguments[arguments.length - 2];\n    stringBuilder.push(str.slice(lastIndex, matchIndex));\n    lastIndex = matchIndex + match.length;\n\n    // Store the promise in it's eventual string position.\n    const replacementPromise = replacer.apply(null, arguments);\n    stringBuilder.push(replacementPromise);\n  });\n  stringBuilder.push(str.slice(lastIndex));\n\n  return Promise.all(stringBuilder).then((resolved) => resolved.join(''));\n}\n\n/**\n * Pads the beginning of a string with a substring to a target length.\n * @param {string} s\n * @param {number} targetLength\n * @param {string} padString\n * @return {string}\n */\nexport function padStart(s, targetLength, padString) {\n  if (s.length >= targetLength) {\n    return s;\n  }\n  targetLength = targetLength - s.length;\n  let padding = padString;\n  while (targetLength > padding.length) {\n    padding += padString;\n  }\n  return padding.slice(0, targetLength) + s;\n}\n\n/**\n * Tests if a value is a string.\n * @param {?} s\n * @return {boolean}\n */\nexport function isString(s) {\n  return typeof s == 'string';\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* @const */\nconst {hasOwnProperty: hasOwn_, toString: toString_} = Object.prototype;\n\n/**\n * Determines if value is actually an Object.\n * @param {*} value\n * @return {boolean}\n */\nexport function isObject(value) {\n  return toString_.call(value) === '[object Object]';\n}\n\n/**\n * Returns a map-like object.\n * If opt_initial is provided, copies its own properties into the\n * newly created object.\n * @param {T=} opt_initial This should typically be an object literal.\n * @return {T}\n * @template T\n */\nexport function map(opt_initial) {\n  const obj = Object.create(null);\n  if (opt_initial) {\n    Object.assign(obj, opt_initial);\n  }\n  return obj;\n}\n\n/**\n * Return an empty JsonObject or makes the passed in object literal\n * an JsonObject.\n * The JsonObject type is just a simple object that is at-dict.\n * See\n * https://github.com/google/closure-compiler/wiki/@struct-and-@dict-Annotations\n * for what a dict is type-wise.\n * The linter enforces that the argument is, in fact, at-dict like.\n * @param {!Object=} opt_initial\n * @return {!JsonObject}\n */\nexport function dict(opt_initial) {\n  // We do not copy. The linter enforces that the passed in object is a literal\n  // and thus the caller cannot have a reference to it.\n  return /** @type {!JsonObject} */ (opt_initial || {});\n}\n\n/**\n * Checks if the given key is a property in the map.\n *\n * @param {T}  obj a map like property.\n * @param {string}  key\n * @return {boolean}\n * @template T\n */\nexport function hasOwn(obj, key) {\n  return hasOwn_.call(obj, key);\n}\n\n/**\n * Returns obj[key] iff key is obj's own property (is not inherited).\n * Otherwise, returns undefined.\n *\n * @param {Object} obj\n * @param {string} key\n * @return {*}\n */\nexport function ownProperty(obj, key) {\n  if (hasOwn(obj, key)) {\n    return obj[key];\n  } else {\n    return undefined;\n  }\n}\n\n/**\n * Deep merges source into target.\n *\n * @param {!Object} target\n * @param {!Object} source\n * @param {number} depth The maximum merge depth. If exceeded, Object.assign\n *                       will be used instead.\n * @return {!Object}\n * @throws {Error} If source contains a circular reference.\n * Note: Only nested objects are deep-merged, primitives and arrays are not.\n */\nexport function deepMerge(target, source, depth = 10) {\n  // Keep track of seen objects to detect recursive references.\n  const seen = [];\n\n  /** @type {!Array<{t: !Object, s: !Object, d: number}>} */\n  const queue = [];\n  queue.push({t: target, s: source, d: 0});\n\n  // BFS to ensure objects don't have recursive references at shallower depths.\n  while (queue.length > 0) {\n    const {d, s, t} = queue.shift();\n    if (seen.includes(s)) {\n      throw new Error('Source object has a circular reference.');\n    }\n    seen.push(s);\n    if (t === s) {\n      continue;\n    }\n    if (d > depth) {\n      Object.assign(t, s);\n      continue;\n    }\n    for (const key of Object.keys(s)) {\n      const newValue = s[key];\n      // Perform a deep merge IFF both target and source have the same key\n      // whose corresponding values are objects.\n      if (hasOwn(t, key)) {\n        const oldValue = t[key];\n        if (isObject(newValue) && isObject(oldValue)) {\n          queue.push({t: oldValue, s: newValue, d: d + 1});\n          continue;\n        }\n      }\n      t[key] = newValue;\n    }\n  }\n  return target;\n}\n\n/**\n * @param {!Object} o An object to remove properties from\n * @param {!Array<string>} props A list of properties to remove from the Object\n * @return {!Object} An object with the given properties removed\n */\nexport function omit(o, props) {\n  return Object.keys(o).reduce((acc, key) => {\n    if (!props.includes(key)) {\n      acc[key] = o[key];\n    }\n    return acc;\n  }, {});\n}\n\n/**\n * @param {!Object|null|undefined} o1\n * @param {!Object|null|undefined} o2\n * @return {boolean}\n */\nexport function objectsEqualShallow(o1, o2) {\n  if (o1 == null || o2 == null) {\n    // Null is only equal to null, and undefined to undefined.\n    return o1 === o2;\n  }\n\n  for (const k in o1) {\n    if (o1[k] !== o2[k]) {\n      return false;\n    }\n  }\n  for (const k in o2) {\n    if (o2[k] !== o1[k]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\n/**\n * @param {T} obj\n * @param {string} prop\n * @param {function(T, string):R} factory\n * @return {R}\n * @template T,R\n */\nexport function memo(obj, prop, factory) {\n  let result = /** @type {?R} */ (obj[prop]);\n  if (result === undefined) {\n    result = factory(obj, prop);\n    obj[prop] = result;\n  }\n  return result;\n}\n\n/**\n * Recreates objects with prototype-less copies.\n * @param {!JsonObject} obj\n * @return {!JsonObject}\n */\nexport function recreateNonProtoObject(obj) {\n  const copy = map();\n  for (const k in obj) {\n    if (!hasOwn(obj, k)) {\n      continue;\n    }\n    const v = obj[k];\n    copy[k] = isObject(v) ? recreateNonProtoObject(v) : v;\n  }\n  return /** @type {!JsonObject} */ (copy);\n}\n\n/**\n * Returns a value from an object for a field-based expression. The expression\n * is a simple nested dot-notation of fields, such as `field1.field2`. If any\n * field in a chain does not exist or is not an object or array, the returned\n * value will be `undefined`.\n *\n * @param {!JsonObject} obj\n * @param {string} expr\n * @return {*}\n */\nexport function getValueForExpr(obj, expr) {\n  // The `.` indicates \"the object itself\".\n  if (expr == '.') {\n    return obj;\n  }\n  // Otherwise, navigate via properties.\n  const parts = expr.split('.');\n  let value = obj;\n  for (const part of parts) {\n    if (\n      part &&\n      value &&\n      value[part] !== undefined &&\n      typeof value == 'object' &&\n      hasOwn(value, part)\n    ) {\n      value = value[part];\n      continue;\n    }\n    value = undefined;\n    break;\n  }\n  return value;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Export all type-checking helpers for convenience\nexport {isArray} from './array';\nexport {isEnumValue} from './enum';\nexport {isString} from './string';\nexport {isObject} from './object';\n\n/**\n * Determines if value is an ELement\n * @param {*} value\n * @return {boolean}\n */\nexport function isElement(value) {\n  return value?.nodeType == /* Node.ELEMENT_NODE */ 1;\n}\n\n/**\n * Determines if value is of number type and finite.\n * NaN and Infinity are not considered a finite number.\n * String numbers are not considered numbers.\n * @param {*} value\n * @return {boolean}\n */\nexport function isFiniteNumber(value) {\n  return typeof value === 'number' && isFinite(value);\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isElement} from '../types';\n\n/**\n * Triple zero width space.\n *\n * This is added to user error messages, so that we can later identify\n * them, when the only thing that we have is the message. This is the\n * case in many browsers when the global exception handler is invoked.\n *\n * @const {string}\n */\nexport const USER_ERROR_SENTINEL = '\\u200B\\u200B\\u200B';\n\n/**\n * Converts an element to a readable string; all other types are unchanged.\n * TODO(rcebulko): Unify with log.js\n * @param {*} val\n * @return {*}\n */\nexport function elementStringOrPassThru(val) {\n  // Do check equivalent to `val instanceof Element` without cross-window bug\n  if (isElement(val)) {\n    val = /** @type {Element} */ (val);\n    return val.tagName.toLowerCase() + (val.id ? `#${val.id}` : '');\n  }\n  return val;\n}\n\n/**\n * Tests if an error message contains the user sentinel.\n * @param {string} message\n * @return {boolean} Whether this message was a user error.\n */\nexport function isUserErrorMessage(message) {\n  return message.indexOf(USER_ERROR_SENTINEL) >= 0;\n}\n\n/**\n * Strips the user error sentinel from an error message.\n * @param {string} message\n * @return {string} The new message without USER_ERROR_SENTINEL\n */\nexport function stripUserError(message) {\n  return message.replace(USER_ERROR_SENTINEL, '');\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {elementStringOrPassThru} from '../error/message-helpers';\nimport {includes} from '../types/string';\nimport {isArray, isElement, isString} from '../types';\nimport {remove} from '../types/array';\n\n/**\n * @fileoverview This file provides the base implementation for assertion\n * functions. Most files should never import from this; instead, import from\n * `dev` or `user`. It is also used by the Log class for its assertions.\n */\n\n/**\n * A base assertion function, provided to various assertion helpers.\n * @typedef {function(?, string=, ...*):?|function(?, !Array<*>)}\n */\nexport let AssertionFunctionDef;\n\n/**\n * Throws an error if the second argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n * @param {?string} sentinel\n * @param {T} shouldBeTruthy\n * @param {string} opt_message\n * @param {...*} var_args Arguments substituted into %s in the message\n * @return {T}\n * @template T\n * @throws {Error} when shouldBeTruthy is not truthy.\n */\nexport function assert(\n  sentinel,\n  shouldBeTruthy,\n  opt_message = 'Assertion failed',\n  var_args\n) {\n  if (shouldBeTruthy) {\n    return shouldBeTruthy;\n  }\n\n  // Include the sentinel string if provided and not already present\n  if (sentinel && !includes(opt_message, sentinel)) {\n    opt_message += sentinel;\n  }\n\n  // Skip the first 3 arguments to isolate format params\n  // const messageArgs = Array.prototype.slice.call(arguments, 3);\n  // Index at which message args start\n  let i = 3;\n\n  // Substitute provided values into format string in message\n  const splitMessage = opt_message.split('%s');\n  let message = splitMessage.shift();\n  const messageArray = [message];\n\n  while (splitMessage.length) {\n    const subValue = arguments[i++];\n    const nextConstant = splitMessage.shift();\n\n    message += elementStringOrPassThru(subValue) + nextConstant;\n    messageArray.push(subValue, nextConstant.trim());\n  }\n\n  const error = new Error(message);\n  error.messageArray = remove(messageArray, (x) => x !== '');\n  // __AMP_REPORT_ERROR is installed globally per window in the entry point in\n  // AMP documents. It may not be present for Bento/Preact elements on non-AMP\n  // pages.\n  self.__AMP_REPORT_ERROR?.(error);\n  throw error;\n}\n\n/**\n * Asserts types, backbone of `assertNumber`, `assertString`, etc.\n *\n * It understands array-based \"id\"-contracted messages.\n *\n * Otherwise creates a sprintf syntax string containing the optional message or the\n * default. The `subject` of the assertion is added at the end.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {T} subject\n * @param {*} shouldBeTruthy\n * @param {string} defaultMessage\n * @param {!Array<*>|string=} opt_message\n * @return {T}\n * @template T\n * @private\n */\nfunction assertType_(\n  assertFn,\n  subject,\n  shouldBeTruthy,\n  defaultMessage,\n  opt_message\n) {\n  if (isArray(opt_message)) {\n    assertFn(\n      shouldBeTruthy,\n      /** @type {!Array} */ (opt_message).concat([subject])\n    );\n  } else {\n    assertFn(shouldBeTruthy, `${opt_message || defaultMessage}: %s`, subject);\n  }\n\n  return subject;\n}\n\n/**\n * Throws an error if the first argument isn't an Element.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeElement\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Element} The value of shouldBeTrueish.\n * @throws {Error} when shouldBeElement is not an Element\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertElement(assertFn, shouldBeElement, opt_message) {\n  return /** @type {!Element} */ (\n    assertType_(\n      assertFn,\n      shouldBeElement,\n      isElement(shouldBeElement),\n      'Element expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a string. The string can\n * be empty.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeString\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {string} The string value. Can be an empty string.\n * @throws {Error} when shouldBeString is not an String\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertString(assertFn, shouldBeString, opt_message) {\n  return /** @type {string} */ (\n    assertType_(\n      assertFn,\n      shouldBeString,\n      isString(shouldBeString),\n      'String expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a number. The allowed values\n * include `0` and `NaN`.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeNumber\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {number} The number value. The allowed values include `0`\n *   and `NaN`.\n * @throws {Error} when shouldBeNumber is not an Number\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertNumber(assertFn, shouldBeNumber, opt_message) {\n  return /** @type {number} */ (\n    assertType_(\n      assertFn,\n      shouldBeNumber,\n      typeof shouldBeNumber == 'number',\n      'Number expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument is not an array.\n * The array can be empty.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeArray\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Array} The array value\n * @throws {Error} when shouldBeArray is not an Array\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertArray(assertFn, shouldBeArray, opt_message) {\n  return /** @type {!Array} */ (\n    assertType_(\n      assertFn,\n      shouldBeArray,\n      isArray(shouldBeArray),\n      'Array expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a boolean.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeBoolean\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {boolean} The boolean value.\n * @throws {Error} when shouldBeBoolean is not an Boolean\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertBoolean(assertFn, shouldBeBoolean, opt_message) {\n  return /** @type {boolean} */ (\n    assertType_(\n      assertFn,\n      shouldBeBoolean,\n      !!shouldBeBoolean === shouldBeBoolean,\n      'Boolean expected',\n      opt_message\n    )\n  );\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns the internal AMP runtime version. Note that this is not the RTV,\n * which is a prefix and the runtime version.\n *\n * The call sites for this function are replaced with a compile time constant\n * string.\n *\n * @return {string}\n */\nexport function internalRuntimeVersion() {\n  return '$internalRuntimeVersion$';\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {map} from '../object';\n\nconst QUERY_STRING_REGEX = /(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;\n\n/**\n * Tries to decode a URI component, falling back to opt_fallback (or an empty\n * string)\n *\n * @param {string} component\n * @param {string=} fallback\n * @return {string}\n */\nexport function tryDecodeUriComponent(component, fallback = '') {\n  try {\n    return decodeURIComponent(component);\n  } catch (e) {\n    return fallback;\n  }\n}\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\nexport function parseQueryString(queryString) {\n  const params = map();\n  if (!queryString) {\n    return params;\n  }\n\n  let match;\n  while ((match = QUERY_STRING_REGEX.exec(queryString))) {\n    const name = tryDecodeUriComponent(match[1], match[1]);\n    const value = match[2]\n      ? tryDecodeUriComponent(match[2].replace(/\\+/g, ' '), match[2])\n      : '';\n    params[name] = value;\n  }\n  return params;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalRuntimeVersion} from './internal-version';\nimport {parseQueryString} from './core/types/string/url';\n\n/**\n * @typedef {{\n *   localDev: boolean,\n *   development: boolean,\n *   minified: boolean,\n *   test: boolean,\n *   examiner: boolean,\n *   log: (string|undefined),\n *   version: string,\n *   rtvVersion: string,\n *   runtime: (null|string|undefined),\n *   a4aId: (null|string|undefined),\n *   esm: (boolean|undefined),\n * }}\n */\nexport let ModeDef;\n\n/**\n * `rtvVersion` is the prefixed version we serve off of the cdn.\n * The prefix denotes canary(00) or prod(01) or an experiment version ( > 01).\n * @type {string}\n */\nlet rtvVersion = '';\n\n/**\n * Provides info about the current app.\n * @param {?Window=} opt_win\n * @return {!ModeDef}\n */\nexport function getMode(opt_win) {\n  const win = opt_win || self;\n  if (win.__AMP_MODE) {\n    return win.__AMP_MODE;\n  }\n  return (win.__AMP_MODE = getMode_(win));\n}\n\n/**\n * Provides info about the current app.\n * @param {!Window} win\n * @return {!ModeDef}\n */\nfunction getMode_(win) {\n  // TODO(erwinmombay): simplify the logic here\n  const AMP_CONFIG = self.AMP_CONFIG || {};\n\n  // Magic constants that are replaced by closure compiler.\n  // IS_MINIFIED is always replaced with true when closure compiler is used\n  // while IS_FORTESTING is only replaced when `amp dist` is called without the\n  // --fortesting flag.\n  const IS_FORTESTING = true;\n  const IS_MINIFIED = false;\n\n  const runningTests =\n    IS_FORTESTING && !!(AMP_CONFIG.test || win.__AMP_TEST || win['__karma__']);\n  const isLocalDev = IS_FORTESTING && (!!AMP_CONFIG.localDev || runningTests);\n  const hashQuery = parseQueryString(\n    // location.originalHash is set by the viewer when it removes the fragment\n    // from the URL.\n    win.location['originalHash'] || win.location.hash\n  );\n\n  if (!rtvVersion) {\n    rtvVersion = getRtvVersion(win);\n  }\n\n  // The `minified`, `test` and `localDev` properties are replaced\n  // as boolean literals when we run `amp dist` without the `--fortesting`\n  // flags. This improved DCE on the production file we deploy as the code\n  // paths for localhost/testing/development are eliminated.\n  return {\n    localDev: isLocalDev,\n    development: isModeDevelopment(win),\n    examiner: hashQuery['development'] == '2',\n    esm: IS_ESM,\n    // amp-geo override\n    geoOverride: hashQuery['amp-geo'],\n    minified: IS_MINIFIED,\n    test: runningTests,\n    log: hashQuery['log'],\n    version: internalRuntimeVersion(),\n    rtvVersion,\n  };\n}\n\n/**\n * Retrieve the `rtvVersion` which will have a numeric prefix\n * denoting canary/prod/experiment (unless `isLocalDev` is true).\n *\n * @param {!Window} win\n * @return {string}\n */\nfunction getRtvVersion(win) {\n  if (win.AMP_CONFIG && win.AMP_CONFIG.v) {\n    return win.AMP_CONFIG.v;\n  }\n\n  // Currently `internalRuntimeVersion` and thus `mode.version` contain only\n  // major version. The full version however must also carry the minor version.\n  // We will default to production default `01` minor version for now.\n  // TODO(erwinmombay): decide whether internalRuntimeVersion should contain\n  // minor version.\n  return `01${internalRuntimeVersion()}`;\n}\n\n/**\n * Triggers validation or enable pub level logging. Validation can be\n * bypassed via #validate=0.\n * Note that AMP_DEV_MODE flag is used for testing purposes.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isModeDevelopment(win) {\n  const hashQuery = parseQueryString(\n    win.location['originalHash'] || win.location.hash\n  );\n  return !!(\n    ['1', 'actions', 'amp', 'amp4ads', 'amp4email'].includes(\n      hashQuery['development']\n    ) || win.AMP_DEV_MODE\n  );\n}\n\n/**\n * @param {!Window} win\n * @return {string}\n * @visibleForTesting\n */\nexport function getRtvVersionForTesting(win) {\n  return getRtvVersion(win);\n}\n\n/** @visibleForTesting */\nexport function resetRtvVersionForTesting() {\n  rtvVersion = '';\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @fileoverview Helpers to wrap functions. */\n\n/**\n * Creates a function that is evaluated only once and returns the cached result\n * subsequently.\n *\n * Please note that `once` only takes the function definition into account,\n * so it will return the same cached value even when the arguments are\n * different.\n *\n * @param {function(...):T} fn\n * @return {function(...):T}\n * @template T\n */\nexport function once(fn) {\n  let evaluated = false;\n  let retValue = null;\n  let callback = fn;\n  return (...args) => {\n    if (!evaluated) {\n      retValue = callback.apply(self, args);\n      evaluated = true;\n      callback = null; // GC\n    }\n    return retValue;\n  };\n}\n\n/**\n * Wraps a given callback and applies a rate limit.\n * It throttles the calls so that no consequent calls have time interval\n * smaller than the given minimal interval.\n *\n * @param {!Window} win\n * @param {function(...T):R} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...T)}\n * @template T\n * @template R\n */\nexport function throttle(win, callback, minInterval) {\n  let locker = 0;\n  let nextCallArgs = null;\n\n  /**\n   * @param {!Object} args\n   */\n  function fire(args) {\n    nextCallArgs = null;\n    // Lock the fire for minInterval milliseconds\n    locker = win.setTimeout(waiter, minInterval);\n\n    callback.apply(null, args);\n  }\n\n  /**\n   * Waiter function\n   */\n  function waiter() {\n    locker = 0;\n    // If during the period there're invocations queued up, fire once.\n    if (nextCallArgs) {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function (...args) {\n    if (locker) {\n      nextCallArgs = args;\n    } else {\n      fire(args);\n    }\n  };\n}\n\n/**\n * Wraps a given callback and applies a wait timer, so that minInterval\n * milliseconds must pass since the last call before the callback is actually\n * invoked.\n *\n * @param {!Window} win\n * @param {function(...T):R} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...T)}\n * @template T\n * @template R\n */\nexport function debounce(win, callback, minInterval) {\n  let locker = 0;\n  let timestamp = 0;\n  let nextCallArgs = null;\n\n  /**\n   * @param {?Array} args\n   */\n  function fire(args) {\n    nextCallArgs = null;\n    callback.apply(null, args);\n  }\n\n  /**\n   * Wait function for debounce\n   */\n  function waiter() {\n    locker = 0;\n    const remaining = minInterval - (win.Date.now() - timestamp);\n    if (remaining > 0) {\n      locker = win.setTimeout(waiter, remaining);\n    } else {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function (...args) {\n    timestamp = win.Date.now();\n    nextCallArgs = args;\n    if (!locker) {\n      locker = win.setTimeout(waiter, minInterval);\n    }\n  };\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Allows for runtime configuration. Internally, the runtime should\n * use the src/config.js module for various constants. We can use the\n * AMP_CONFIG global to translate user-defined configurations to this\n * module.\n * @type {!Object<string, string>}\n */\nconst env = self.AMP_CONFIG || {};\n\nconst thirdPartyFrameRegex =\n  (typeof env['thirdPartyFrameRegex'] == 'string'\n    ? new RegExp(env['thirdPartyFrameRegex'])\n    : env['thirdPartyFrameRegex']) || /^d-\\d+\\.ampproject\\.net$/;\n\nconst cdnProxyRegex =\n  (typeof env['cdnProxyRegex'] == 'string'\n    ? new RegExp(env['cdnProxyRegex'])\n    : env['cdnProxyRegex']) ||\n  /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org$/;\n\n/**\n * Check for a custom URL definition in special <meta> tags. Note that this does\n * not allow for distinct custom URLs in AmpDocShadow instances. The shell is\n * allowed to define one set of custom URLs via AMP_CONFIG (recommended) or by\n * including <meta> tags in the shell <head>. Those custom URLs then apply to\n * all AMP documents loaded in the shell.\n * @param {string} name\n * @return {?string}\n * @private\n */\nfunction getMetaUrl(name) {\n  // Avoid exceptions in unit tests\n  if (!self.document || !self.document.head) {\n    return null;\n  }\n\n  // Disallow on proxy origins\n  if (self.location && cdnProxyRegex.test(self.location.origin)) {\n    return null;\n  }\n\n  const metaEl = self.document.head./*OK*/ querySelector(\n    `meta[name=\"${name}\"]`\n  );\n  return (metaEl && metaEl.getAttribute('content')) || null;\n}\n\n/**\n * @typedef {{\n *   thirdParty: string,\n *   thirdPartyFrameHost: string,\n *   thirdPartyFrameRegex: !RegExp,\n *   cdn: string,\n *   cdnProxyRegex: !RegExp,\n *   localhostRegex: !RegExp,\n *   errorReporting: string,\n *   betaErrorReporting: string,\n *   localDev: boolean,\n *   trustedViewerHosts: !Array<!RegExp>,\n *   geoApi: ?string,\n * }}\n */\nexport const urls = {\n  thirdParty: env['thirdPartyUrl'] || 'https://3p.ampproject.net',\n  thirdPartyFrameHost: env['thirdPartyFrameHost'] || 'ampproject.net',\n  thirdPartyFrameRegex,\n  cdn:\n    env['cdnUrl'] || getMetaUrl('runtime-host') || 'https://cdn.ampproject.org',\n  /* Note that cdnProxyRegex is only ever checked against origins\n   * (proto://host[:port]) so does not need to consider path\n   */\n  cdnProxyRegex,\n  localhostRegex: /^https?:\\/\\/localhost(:\\d+)?$/,\n  errorReporting:\n    env['errorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r',\n  betaErrorReporting:\n    env['betaErrorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r-beta',\n  localDev: env['localDev'] || false,\n  /**\n   * These domains are trusted with more sensitive viewer operations such as\n   * propagating the referrer. If you believe your domain should be here,\n   * file the issue on GitHub to discuss. The process will be similar\n   * (but somewhat more stringent) to the one described in the [3p/README.md](\n   * https://github.com/ampproject/amphtml/blob/main/3p/README.md)\n   *\n   * {!Array<!RegExp>}\n   */\n  trustedViewerHosts: [\n    /(^|\\.)google\\.(com?|[a-z]{2}|com?\\.[a-z]{2}|cat)$/,\n    /(^|\\.)gmail\\.(com|dev)$/,\n  ],\n  // Optional fallback API if amp-geo is left unpatched\n  geoApi: env['geoApiUrl'] || getMetaUrl('amp-geo-api'),\n};\n\nexport const config = {\n  urls,\n};\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assertions from './core/assert/base';\nimport {\n  USER_ERROR_SENTINEL,\n  elementStringOrPassThru,\n  isUserErrorMessage,\n  stripUserError,\n} from './core/error/message-helpers';\nimport {createErrorVargs, duplicateErrorIfNecessary} from './core/error';\nimport {getMode} from './mode';\nimport {internalRuntimeVersion} from './internal-version';\nimport {isArray} from './core/types';\nimport {once} from './core/types/function';\nimport {urls} from './config';\n\nconst noop = () => {};\n\n// These are exported here despite being defined in core to avoid updating\n// imports for now.\nexport {USER_ERROR_SENTINEL, isUserErrorMessage, stripUserError};\n\n/**\n * Four zero width space.\n *\n * @const {string}\n */\nexport const USER_ERROR_EMBED_SENTINEL = '\\u200B\\u200B\\u200B\\u200B';\n\n/**\n * @param {string} message\n * @return {boolean} Whether this message was a a user error from an iframe embed.\n */\nexport function isUserErrorEmbed(message) {\n  return message.indexOf(USER_ERROR_EMBED_SENTINEL) >= 0;\n}\n\n/**\n * @enum {number}\n */\nexport const LogLevel = {\n  OFF: 0,\n  ERROR: 1,\n  WARN: 2,\n  INFO: 3,\n  FINE: 4,\n};\n\n/**\n * Sets reportError function. Called from error-reporting.js to break cyclic\n * dependency.\n * @param {function(this:Window, Error, (?Element)=): ?|undefined} fn\n */\nexport function setReportError(fn) {\n  self.__AMP_REPORT_ERROR = fn;\n}\n\n/**\n * @type {!LogLevel|undefined}\n * @private\n */\nlet levelOverride_ = undefined;\n\n/**\n * @param {!LogLevel} level\n */\nexport function overrideLogLevel(level) {\n  levelOverride_ = level;\n}\n\n/**\n * Prefixes `internalRuntimeVersion` with the `01` channel signifier (for prod.) for\n * extracted message URLs.\n * (Specific channel is irrelevant: message tables are invariant on internal version.)\n * @return {string}\n */\nconst messageUrlRtv = () => `01${internalRuntimeVersion()}`;\n\n/**\n * Gets a URL to display a message on amp.dev.\n * @param {string} id\n * @param {!Array} interpolatedParts\n * @return {string}\n */\nconst externalMessageUrl = (id, interpolatedParts) =>\n  interpolatedParts.reduce(\n    (prefix, arg) => `${prefix}&s[]=${messageArgToEncodedComponent(arg)}`,\n    `https://log.amp.dev/?v=${messageUrlRtv()}&id=${encodeURIComponent(id)}`\n  );\n\n/**\n * URL to simple log messages table JSON file, which contains an Object<string, string>\n * which maps message id to full message template.\n * @return {string}\n */\nconst externalMessagesSimpleTableUrl = () =>\n  `${urls.cdn}/rtv/${messageUrlRtv()}/log-messages.simple.json`;\n\n/**\n * @param {*} arg\n * @return {string}\n */\nconst messageArgToEncodedComponent = (arg) =>\n  encodeURIComponent(String(elementStringOrPassThru(arg)));\n\n/**\n * Logging class. Use of sentinel string instead of a boolean to check user/dev\n * errors because errors could be rethrown by some native code as a new error,\n * and only a message would survive. Also, some browser don\u2019t support a 5th\n * error object argument in window.onerror. List of supporting browser can be\n * found here:\n * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n * @final\n * @private Visible for testing only.\n */\nexport class Log {\n  /**\n   * opt_suffix will be appended to error message to identify the type of the\n   * error message. We can't rely on the error object to pass along the type\n   * because some browsers do not have this param in its window.onerror API.\n   * See:\n   * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n   *\n   * @param {!Window} win\n   * @param {function(number, boolean):!LogLevel} levelFunc\n   * @param {string=} opt_suffix\n   */\n  constructor(win, levelFunc, opt_suffix = '') {\n    /**\n     * In tests we use the main test window instead of the iframe where\n     * the tests runs because only the former is relayed to the console.\n     * @const {!Window}\n     */\n    this.win = getMode().test && win.__AMP_TEST_IFRAME ? win.parent : win;\n\n    /** @private @const {function(number, boolean):!LogLevel} */\n    this.levelFunc_ = levelFunc;\n\n    /** @private @const {!LogLevel} */\n    this.level_ = this.defaultLevel_();\n\n    /** @private @const {string} */\n    this.suffix_ = opt_suffix;\n\n    /** @private {?JsonObject} */\n    this.messages_ = null;\n\n    this.fetchExternalMessagesOnce_ = once(() => {\n      win\n        .fetch(externalMessagesSimpleTableUrl())\n        .then((response) => response.json(), noop)\n        .then((opt_messages) => {\n          if (opt_messages) {\n            this.messages_ = /** @type {!JsonObject} */ (opt_messages);\n          }\n        });\n    });\n\n    // This bound assertion function is capable of handling the format used when\n    // error/assertion messages are extracted. This logic hasn't yet been\n    // migrated to an AMP-independent form for use in core. This binding allows\n    // Log assertion helpers to maintain message-extraction capabilities until\n    // that logic can be moved to core.\n    this.boundAssertFn_ = /** @type {!assertions.AssertionFunctionDef} */ (\n      this.assert.bind(this)\n    );\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  getLevel_() {\n    return levelOverride_ !== undefined ? levelOverride_ : this.level_;\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevel_() {\n    // No console - can't enable logging.\n    if (!this.win.console || !this.win.console.log) {\n      return LogLevel.OFF;\n    }\n\n    // Logging has been explicitly disabled.\n    if (getMode().log == '0') {\n      return LogLevel.OFF;\n    }\n\n    // Logging is enabled for tests directly.\n    if (getMode().test && this.win.ENABLE_LOG) {\n      return LogLevel.FINE;\n    }\n\n    // LocalDev by default allows INFO level, unless overriden by `#log`.\n    if (getMode().localDev && !getMode().log) {\n      return LogLevel.INFO;\n    }\n\n    return this.defaultLevelWithFunc_();\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevelWithFunc_() {\n    // Delegate to the specific resolver.\n    return this.levelFunc_(parseInt(getMode().log, 10), getMode().development);\n  }\n\n  /**\n   * @param {string} tag\n   * @param {!LogLevel} level\n   * @param {!Array} messages\n   * @return {boolean} true if a message was logged\n   */\n  msg_(tag, level, messages) {\n    if (this.getLevel_() < level) {\n      return false;\n    }\n    let fn = this.win.console.log;\n    if (level == LogLevel.ERROR) {\n      fn = this.win.console.error || fn;\n    } else if (level == LogLevel.INFO) {\n      fn = this.win.console.info || fn;\n    } else if (level == LogLevel.WARN) {\n      fn = this.win.console.warn || fn;\n    }\n    const args = this.maybeExpandMessageArgs_(messages);\n    // Prefix console message with \"[tag]\".\n    const prefix = `[${tag}]`;\n    if (typeof args[0] === 'string') {\n      // Prepend string to avoid breaking string substitutions e.g. %s.\n      args[0] = prefix + ' ' + args[0];\n    } else {\n      args.unshift(prefix);\n    }\n    fn.apply(this.win.console, args);\n    return true;\n  }\n\n  /**\n   * Whether the logging is enabled.\n   * @return {boolean}\n   */\n  isEnabled() {\n    return this.getLevel_() != LogLevel.OFF;\n  }\n\n  /**\n   * Reports a fine-grained message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  fine(tag, ...args) {\n    this.msg_(tag, LogLevel.FINE, args);\n  }\n\n  /**\n   * Reports a informational message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  info(tag, ...args) {\n    this.msg_(tag, LogLevel.INFO, args);\n  }\n\n  /**\n   * Reports a warning message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  warn(tag, ...args) {\n    this.msg_(tag, LogLevel.WARN, args);\n  }\n\n  /**\n   * Reports an error message. If the logging is disabled, the error is rethrown\n   * asynchronously.\n   * @param {string} tag\n   * @param {...*} args\n   * @return {!Error|undefined}\n   * @private\n   */\n  error_(tag, ...args) {\n    if (!this.msg_(tag, LogLevel.ERROR, args)) {\n      return this.createError.apply(this, args);\n    }\n  }\n\n  /**\n   * Reports an error message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  error(tag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      // TODO(rcebulko): Determine if/how this Error#name property is used.\n      error.name = tag || error.name;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Reports an error message and marks with an expected property. If the\n   * logging is disabled, the error is rethrown asynchronously.\n   * @param {string} unusedTag\n   * @param {...*} var_args\n   */\n  expectedError(unusedTag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      error.expected = true;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Creates an error object.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    return error;\n  }\n\n  /**\n   * Creates an error object with its expected property set to true.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createExpectedError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    error.expected = true;\n    return error;\n  }\n\n  /**\n   * Throws an error if the first argument isn't trueish.\n   *\n   * Supports argument substitution into the message via %s placeholders.\n   *\n   * Throws an error object that has two extra properties:\n   * - associatedElement: This is the first element provided in the var args.\n   *   It can be used for improved display of error messages.\n   * - messageArray: The elements of the substituted message as non-stringified\n   *   elements in an array. When e.g. passed to console.error this yields\n   *   native displays of things like HTML elements.\n   *\n   * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n   *     not evaluate to true.\n   * @param {!Array|string=} opt_message The assertion message\n   * @param {...*} var_args Arguments substituted into %s in the message.\n   * @return {T} The value of shouldBeTrueish.\n   * @throws {!Error} When `value` is falsey.\n   * @template T\n   * @closurePrimitive {asserts.truthy}\n   */\n  assert(shouldBeTrueish, opt_message, var_args) {\n    if (isArray(opt_message)) {\n      return this.assert.apply(\n        this,\n        [shouldBeTrueish].concat(\n          this.expandMessageArgs_(/** @type {!Array} */ (opt_message))\n        )\n      );\n    }\n\n    return assertions.assert.apply(\n      null,\n      [this.suffix_].concat(Array.prototype.slice.call(arguments))\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't an Element\n   *\n   * Otherwise see `assert` for usage\n   *\n   * @param {*} shouldBeElement\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Element} The value of shouldBeTrueish.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertElement(shouldBeElement, opt_message) {\n    return assertions.assertElement(\n      this.boundAssertFn_,\n      shouldBeElement,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a string. The string can\n   * be empty.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeString\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {string} The string value. Can be an empty string.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertString(shouldBeString, opt_message) {\n    return assertions.assertString(\n      this.boundAssertFn_,\n      shouldBeString,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a number. The allowed values\n   * include `0` and `NaN`.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeNumber\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {number} The number value. The allowed values include `0`\n   *   and `NaN`.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertNumber(shouldBeNumber, opt_message) {\n    return assertions.assertNumber(\n      this.boundAssertFn_,\n      shouldBeNumber,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument is not an array.\n   * The array can be empty.\n   *\n   * @param {*} shouldBeArray\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Array} The array value\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertArray(shouldBeArray, opt_message) {\n    return assertions.assertArray(\n      this.boundAssertFn_,\n      shouldBeArray,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a boolean.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeBoolean\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {boolean} The boolean value.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertBoolean(shouldBeBoolean, opt_message) {\n    return assertions.assertBoolean(\n      this.boundAssertFn_,\n      shouldBeBoolean,\n      opt_message\n    );\n  }\n\n  /**\n   * @param {!Error} error\n   * @private\n   */\n  prepareError_(error) {\n    error = duplicateErrorIfNecessary(error);\n\n    if (this.suffix_) {\n      if (!error.message) {\n        error.message = this.suffix_;\n      } else if (error.message.indexOf(this.suffix_) == -1) {\n        error.message += this.suffix_;\n      }\n    } else if (isUserErrorMessage(error.message)) {\n      error.message = error.message.replace(USER_ERROR_SENTINEL, '');\n    }\n  }\n\n  /**\n   * @param {!Array} args\n   * @return {!Array}\n   * @private\n   */\n  maybeExpandMessageArgs_(args) {\n    if (isArray(args[0])) {\n      return this.expandMessageArgs_(/** @type {!Array} */ (args[0]));\n    }\n    return args;\n  }\n\n  /**\n   * Either redirects a pair of (errorId, ...args) to a URL where the full\n   * message is displayed, or displays it from a fetched table.\n   *\n   * This method is used by the output of the `transform-log-methods` babel\n   * plugin. It should not be used directly. Use the (*error|assert*|info|warn)\n   * methods instead.\n   *\n   * @param {!Array} parts\n   * @return {!Array}\n   * @private\n   */\n  expandMessageArgs_(parts) {\n    // First value should exist.\n    const id = parts.shift();\n    // Best effort fetch of message template table.\n    // Since this is async, the first few logs might be indirected to a URL even\n    // if in development mode. Message table is ~small so this should be a short\n    // gap.\n    if (getMode(this.win).development) {\n      this.fetchExternalMessagesOnce_();\n    }\n    if (this.messages_ && id in this.messages_) {\n      return [this.messages_[id]].concat(parts);\n    }\n    return [`More info at ${externalMessageUrl(id, parts)}`];\n  }\n}\n\n/**\n * Cache for logs. We do not use a Service since the service module depends\n * on Log and closure literally can't even.\n * @type {{user: ?Log, dev: ?Log, userForEmbed: ?Log}}\n */\nself.__AMP_LOG = self.__AMP_LOG || {\n  user: null,\n  dev: null,\n  userForEmbed: null,\n};\n\nconst logs = self.__AMP_LOG;\n\n/**\n * Eventually holds a constructor for Log objects. Lazily initialized, so we\n * can avoid ever referencing the real constructor except in JS binaries\n * that actually want to include the implementation.\n * @type {?typeof Log}\n */\nlet logConstructor = null;\n\n/**\n * Initializes log constructor.\n */\nexport function initLogConstructor() {\n  logConstructor = Log;\n  // Initialize instances for use. If a binary (an extension for example) that\n  // does not call `initLogConstructor` invokes `dev()` or `user()` earlier than\n  // the binary that does call `initLogConstructor` (amp.js), the extension will\n  // throw an error as that extension will never be able to initialize the log\n  // instances and we also don't want it to call `initLogConstructor` either\n  // (since that will cause the Log implementation to be bundled into that\n  // binary). So we must initialize the instances eagerly so that they are ready\n  // for use (stored globally) after the main binary calls `initLogConstructor`.\n  dev();\n  user();\n}\n\n/**\n * Resets log constructor for testing.\n */\nexport function resetLogConstructorForTesting() {\n  logConstructor = null;\n}\n\n/**\n * Publisher level log.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Development mode is enabled via `#development=1` or logging is explicitly\n *     enabled via `#log=D` where D >= 1.\n *  3. AMP.setLogLevel(D) is called, where D >= 1.\n *\n * @param {!Element=} opt_element\n * @return {!Log}\n */\nexport function user(opt_element) {\n  if (!logs.user) {\n    logs.user = getUserLogger(USER_ERROR_SENTINEL);\n  }\n  if (!isFromEmbed(logs.user.win, opt_element)) {\n    return logs.user;\n  } else {\n    if (logs.userForEmbed) {\n      return logs.userForEmbed;\n    }\n    return (logs.userForEmbed = getUserLogger(USER_ERROR_EMBED_SENTINEL));\n  }\n}\n\n/**\n * Getter for user logger\n * @param {string=} suffix\n * @return {!Log}\n */\nfunction getUserLogger(suffix) {\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return new logConstructor(\n    self,\n    (logNum, development) => {\n      if (development || logNum >= 1) {\n        return LogLevel.FINE;\n      }\n      return LogLevel.WARN;\n    },\n    suffix\n  );\n}\n\n/**\n * AMP development log. Calls to `devLog().assert` and `dev.fine` are stripped\n * in the PROD binary. However, `devLog().assert` result is preserved in either\n * case.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Logging is explicitly enabled via `#log=D`, where D >= 2.\n *  3. AMP.setLogLevel(D) is called, where D >= 2.\n *\n * @return {!Log}\n */\nexport function dev() {\n  if (logs.dev) {\n    return logs.dev;\n  }\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return (logs.dev = new logConstructor(self, (logNum) => {\n    if (logNum >= 3) {\n      return LogLevel.FINE;\n    }\n    if (logNum >= 2) {\n      return LogLevel.INFO;\n    }\n    return LogLevel.OFF;\n  }));\n}\n\n/**\n * @param {!Window} win\n * @param {!Element=} opt_element\n * @return {boolean} isEmbed\n */\nexport function isFromEmbed(win, opt_element) {\n  if (!opt_element) {\n    return false;\n  }\n  return opt_element.ownerDocument.defaultView != win;\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function devAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (getMode().minified) {\n    return shouldBeTrueish;\n  }\n  if (self.__AMP_ASSERTION_CHECK) {\n    // This will never execute regardless, but will be included on unminified\n    // builds. It will be DCE'd away from minified builds, and so can be used to\n    // validate that Babel is properly removing dev assertions in minified\n    // builds.\n    console /*OK*/\n      .log('__devAssert_sentinel__');\n  }\n\n  return dev()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function userAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  return user()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from './log';\nimport {map} from './core/types/object';\n\nlet htmlContainer;\nlet svgContainer;\n\n/**\n * Creates the html helper for the doc.\n *\n * @param {!Element|!Document} nodeOrDoc\n * @return {function(!Array<string>):!Element}\n */\nexport function htmlFor(nodeOrDoc) {\n  const doc = nodeOrDoc.ownerDocument || nodeOrDoc;\n  if (!htmlContainer || htmlContainer.ownerDocument !== doc) {\n    htmlContainer = doc.createElement('div');\n  }\n\n  return html;\n}\n\n/**\n * Creates the svg helper for the doc.\n *\n * @param {!Element|!Document} nodeOrDoc\n * @return {function(!Array<string>):!Element}\n */\nexport function svgFor(nodeOrDoc) {\n  const doc = nodeOrDoc.ownerDocument || nodeOrDoc;\n  if (!svgContainer || svgContainer.ownerDocument !== svgContainer) {\n    svgContainer = doc.createElementNS('http://www.w3.org/2000/svg', 'svg');\n  }\n\n  return svg;\n}\n\n/**\n * A tagged template literal helper to generate static SVG trees.\n * This must be used as a tagged template, ie\n *\n * ```\n * const circle = svg`<circle cx=\"60\" cy=\"60\" r=\"22\"></circle>`;\n * ```\n *\n * Only the root element and its subtree will be returned. DO NOT use this to\n * render subtree's with dynamic content, it WILL result in an error!\n *\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction svg(strings) {\n  return createNode(svgContainer, strings);\n}\n\n/**\n * A tagged template literal helper to generate static DOM trees.\n * This must be used as a tagged template, ie\n *\n * ```\n * const div = html`<div><span></span></div>`;\n * ```\n *\n * Only the root element and its subtree will be returned. DO NOT use this to\n * render subtree's with dynamic content, it WILL result in an error!\n *\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction html(strings) {\n  return createNode(htmlContainer, strings);\n}\n\n/**\n * Helper used by html and svg string literal functions.\n * @param {!Element} container\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction createNode(container, strings) {\n  devAssert(strings.length === 1, 'Improper html template tag usage.');\n  container./*OK*/ innerHTML = strings[0];\n\n  const el = container.firstElementChild;\n  devAssert(el, 'No elements in template');\n  devAssert(!el.nextElementSibling, 'Too many root elements in template');\n\n  // Clear to free memory.\n  container.removeChild(el);\n\n  return el;\n}\n\n/**\n * Queries an element for all elements with a \"ref\" attribute, removing\n * the attribute afterwards.\n * Returns a named map of all ref elements.\n *\n * @param {!Element} root\n * @return {!Object<string, !Element>}\n */\nexport function htmlRefs(root) {\n  const elements = root.querySelectorAll('[ref]');\n  const refs = map();\n\n  for (let i = 0; i < elements.length; i++) {\n    const element = elements[i];\n    const ref = devAssert(element.getAttribute('ref'), 'Empty ref attr');\n    element.removeAttribute('ref');\n    devAssert(refs[ref] === undefined, 'Duplicate ref');\n    refs[ref] = element;\n  }\n\n  return refs;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Externs declare that access `defaultView` from `document` or\n * `ownerDocument` is of type `(Window|null)` but most of our parameter types\n * assume that it is never null. This is OK in practice as we ever only get\n * null on disconnected documents or old IE.\n * This helper function casts it into just a simple Window return type.\n *\n * @param {?Window} winOrNull\n * @return {!Window}\n */\nexport function toWin(winOrNull) {\n  return /** @type {!Window} */ (winOrNull);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Registration and getter functions for AMP services.\n *\n * Invariant: Service getters never return null for registered services.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {dev, devAssert} from './log';\nimport {toWin} from './core/window';\n\n/**\n * Holds info about a service.\n * - obj: Actual service implementation when available.\n * - promise: Promise for the obj.\n * - resolve: Function to resolve the promise with the object.\n * - context: Argument for ctor, either a window or an ampdoc.\n * - ctor: Function that constructs and returns the service.\n * @typedef {{\n *   obj: (?Object),\n *   promise: (?Promise),\n *   resolve: (?function(!Object)),\n *   reject: (?function((*))),\n *   context: (?Window|?./service/ampdoc-impl.AmpDoc),\n *   ctor: (function(new:Object, !Window)|\n *          function(new:Object, !./service/ampdoc-impl.AmpDoc)),\n * }}\n */\nlet ServiceHolderDef;\n\n/**\n * This interface provides a `dispose` method that will be called by\n * runtime when a service needs to be disposed of.\n * @interface\n */\nexport class Disposable {\n  /**\n   * Instructs the service to release any resources it might be holding. Can\n   * be called only once in the lifecycle of a service.\n   */\n  dispose() {}\n}\n\n/**\n * Installs a service override on amp-doc level.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n * @param {!Object} service The service.\n */\nexport function installServiceInEmbedDoc(ampdoc, id, service) {\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    function () {\n      return service;\n    },\n    /* override */ true\n  );\n}\n\n/**\n * Installs a service override in the scope of an embedded window.\n * @param {!Window} embedWin\n * @param {string} id\n * @param {function(new:Object, !Window)} constructor\n */\nexport function registerServiceBuilderInEmbedWin(embedWin, id, constructor) {\n  registerServiceInternal(\n    embedWin,\n    embedWin,\n    id,\n    constructor,\n    /* override */ true\n  );\n}\n\n/**\n * Registers a service given a class to be used as implementation.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {function(new:Object, !Window)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilder(win, id, constructor, opt_instantiate) {\n  win = getTopWindow(win);\n  registerServiceInternal(win, win, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(win, id);\n  }\n}\n\n/**\n * Returns a service and registers it given a class to be used as\n * implementation.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id of the service.\n * @param {function(new:Object, !./service/ampdoc-impl.AmpDoc)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilderForDoc(\n  nodeOrDoc,\n  id,\n  constructor,\n  opt_instantiate\n) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  registerServiceInternal(holder, ampdoc, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * Reject a service promise.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id\n * @param {*} error\n */\nexport function rejectServicePromiseForDoc(nodeOrDoc, id, error) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  rejectServicePromiseInternal(holder, id, error);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). Users\n * should typically wrap this as a special purpose function (e.g.\n * `Services.vsyncFor(win)`) for type safety and because the factory should not\n * be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getService(win, id) {\n  win = getTopWindow(win);\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). But\n * it looks in the immediate window scope, not the top-level window.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getServiceInEmbedWin(win, id) {\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. `Services.vsyncFor(win)`) for type safety and because the\n * factory should not be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nexport function getServicePromise(win, id) {\n  return getServicePromiseInternal(win, id);\n}\n\n/**\n * Returns a service or null with the given id.\n * @param {!Window} win\n * @param {string} id\n * @return {?Object} The service.\n */\nexport function getExistingServiceOrNull(win, id) {\n  win = getTopWindow(win);\n  if (isServiceRegistered(win, id)) {\n    return getServiceInternal(win, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Like getServicePromise but returns null if the service was never registered.\n * @param {!Window} win\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNull(win, id) {\n  return getServicePromiseOrNullInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * Expects service `id` to be registered.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {T}\n * @template T\n */\nexport function getServiceForDoc(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  return getServiceInternal(holder, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * If service `id` is not registered, returns null.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Object}\n */\nexport function getServiceForDocOrNull(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  if (isServiceRegistered(holder, id)) {\n    return getServiceInternal(holder, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Returns a promise for a service for the given id and ampdoc. Also expects\n * a service that has the actual implementation. The promise resolves when\n * the implementation loaded.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {!Promise<!Object>}\n */\nexport function getServicePromiseForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseInternal(getAmpdocServiceHolder(elementOrAmpDoc), id);\n}\n\n/**\n * Like getServicePromiseForDoc but returns null if the service was never\n * registered for this ampdoc.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNullForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseOrNullInternal(\n    getAmpdocServiceHolder(elementOrAmpDoc),\n    id\n  );\n}\n\n/**\n * Set the parent and top windows on a child window (friendly iframe).\n * @param {!Window} win\n * @param {!Window} parentWin\n */\nexport function setParentWindow(win, parentWin) {\n  win.__AMP_PARENT = parentWin;\n  win.__AMP_TOP = getTopWindow(parentWin);\n}\n\n/**\n * Returns the parent window for a child window (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getParentWindow(win) {\n  return win.__AMP_PARENT || win;\n}\n\n/**\n * Returns the top window where AMP Runtime is installed for a child window\n * (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getTopWindow(win) {\n  return win.__AMP_TOP || (win.__AMP_TOP = win);\n}\n\n/**\n * Returns the parent \"friendly\" iframe if the node belongs to a child window.\n * @param {!Node} node\n * @param {!Window=} opt_topWin\n * @return {?HTMLIFrameElement}\n */\nexport function getParentWindowFrameElement(node, opt_topWin) {\n  const childWin = (node.ownerDocument || node).defaultView;\n  const topWin = opt_topWin || getTopWindow(childWin);\n  if (childWin && childWin != topWin && getTopWindow(childWin) == topWin) {\n    try {\n      return /** @type {?HTMLIFrameElement} */ (childWin.frameElement);\n    } catch (e) {\n      // Ignore the error.\n    }\n  }\n  return null;\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc}\n */\nexport function getAmpdoc(nodeOrDoc) {\n  if (nodeOrDoc.nodeType) {\n    const win = toWin(\n      /** @type {!Document} */ (nodeOrDoc.ownerDocument || nodeOrDoc)\n        .defaultView\n    );\n    return getAmpdocService(win).getAmpDoc(/** @type {!Node} */ (nodeOrDoc));\n  }\n  return /** @type {!./service/ampdoc-impl.AmpDoc} */ (nodeOrDoc);\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc|!Window}\n */\nfunction getAmpdocServiceHolder(nodeOrDoc) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  return ampdoc.isSingleDoc() ? ampdoc.win : ampdoc;\n}\n\n/**\n * This is essentially a duplicate of `ampdoc.js`, but necessary to avoid\n * circular dependencies.\n * @param {!Window} win\n * @return {!./service/ampdoc-impl.AmpDocService}\n */\nfunction getAmpdocService(win) {\n  return /** @type {!./service/ampdoc-impl.AmpDocService} */ (\n    getService(win, 'ampdoc')\n  );\n}\n\n/**\n * Get service `id` from `holder`. Assumes the service\n * has already been registered.\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {Object}\n */\nfunction getServiceInternal(holder, id) {\n  devAssert(\n    isServiceRegistered(holder, id),\n    `Expected service ${id} to be registered`\n  );\n  const services = getServices(holder);\n  const s = services[id];\n  if (!s.obj) {\n    devAssert(s.ctor, `Service ${id} registered without ctor nor impl.`);\n    devAssert(s.context, `Service ${id} registered without context.`);\n    s.obj = new s.ctor(s.context);\n    devAssert(s.obj, `Service ${id} constructed to null.`);\n    s.context = null;\n    // The service may have been requested already, in which case we have a\n    // pending promise we need to fulfill.\n    if (s.resolve) {\n      s.resolve(s.obj);\n    }\n  }\n  return s.obj;\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {!Window|!./service/ampdoc-impl.AmpDoc} context Win or AmpDoc.\n * @param {string} id of the service.\n * @param {?function(new:Object, !Window)|?function(new:Object, !./service/ampdoc-impl.AmpDoc)} ctor Constructor function to new the service. Called with context.\n * @param {boolean=} opt_override\n * @param {boolean=} opt_sharedInstance\n */\nfunction registerServiceInternal(\n  holder,\n  context,\n  id,\n  ctor,\n  opt_override,\n  opt_sharedInstance\n) {\n  const services = getServices(holder);\n  let s = services[id];\n\n  if (!s) {\n    s = services[id] = {\n      obj: null,\n      promise: null,\n      resolve: null,\n      reject: null,\n      context: null,\n      ctor: null,\n      sharedInstance: opt_sharedInstance || false,\n    };\n  }\n\n  if (!opt_override && s.ctor) {\n    // Service already registered.\n    return;\n  }\n\n  s.ctor = ctor;\n  s.context = context;\n  s.sharedInstance = opt_sharedInstance || false;\n\n  // The service may have been requested already, in which case there is a\n  // pending promise that needs to fulfilled.\n  if (s.resolve) {\n    // getServiceInternal will resolve the promise.\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nfunction getServicePromiseInternal(holder, id) {\n  const cached = getServicePromiseOrNullInternal(holder, id);\n  if (cached) {\n    return cached;\n  }\n  // Service is not registered.\n\n  // TODO(@cramforce): Add a check that if the element is eventually registered\n  // that the service is actually provided and this promise resolves.\n  const services = getServices(holder);\n  services[id] = emptyServiceHolderWithPromise();\n  return /** @type {!Promise<!Object>} */ (services[id].promise);\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @param {*} error\n */\nfunction rejectServicePromiseInternal(holder, id, error) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.reject) {\n      s.reject(error);\n    }\n    return;\n  }\n\n  services[id] = emptyServiceHolderWithPromise();\n  services[id].reject(error);\n}\n\n/**\n * Returns a promise for service `id` if the service has been registered\n * on `holder`.\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {?Promise<!Object>}\n */\nfunction getServicePromiseOrNullInternal(holder, id) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.promise) {\n      return s.promise;\n    } else {\n      // Instantiate service if not already instantiated.\n      getServiceInternal(holder, id);\n      return (s.promise = Promise.resolve(/** @type {!Object} */ (s.obj)));\n    }\n  }\n  return null;\n}\n\n/**\n * Returns the object that holds the services registered in a holder.\n * @param {!Object} holder\n * @return {!Object<string,!ServiceHolderDef>}\n */\nfunction getServices(holder) {\n  let services = holder.__AMP_SERVICES;\n  if (!services) {\n    services = holder.__AMP_SERVICES = {};\n  }\n  return services;\n}\n\n/**\n * Whether the specified service implements `Disposable` interface.\n * @param {!Object} service\n * @return {boolean}\n */\nexport function isDisposable(service) {\n  return typeof service.dispose == 'function';\n}\n\n/**\n * Asserts that the specified service implements `Disposable` interface and\n * typecasts the instance to `Disposable`.\n * @param {!Object} service\n * @return {!Disposable}\n */\nexport function assertDisposable(service) {\n  devAssert(isDisposable(service), 'required to implement Disposable');\n  return /** @type {!Disposable} */ (service);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * ampdoc scope.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function disposeServicesForDoc(ampdoc) {\n  disposeServicesInternal(ampdoc);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * embed scope.\n * @param {!Window} embedWin\n */\nexport function disposeServicesForEmbed(embedWin) {\n  disposeServicesInternal(embedWin);\n}\n\n/**\n * @param {!Object} holder Object holding the service instances.\n */\nfunction disposeServicesInternal(holder) {\n  const services = getServices(holder);\n  for (const id in services) {\n    if (!Object.prototype.hasOwnProperty.call(services, id)) {\n      continue;\n    }\n    const serviceHolder = services[id];\n    if (serviceHolder.sharedInstance) {\n      continue;\n    }\n    if (serviceHolder.obj) {\n      disposeServiceInternal(id, serviceHolder.obj);\n    } else if (serviceHolder.promise) {\n      serviceHolder.promise.then((instance) =>\n        disposeServiceInternal(id, instance)\n      );\n    }\n  }\n}\n\n/**\n * @param {string} id\n * @param {!Object} service\n */\nfunction disposeServiceInternal(id, service) {\n  if (!isDisposable(service)) {\n    return;\n  }\n  try {\n    assertDisposable(service).dispose();\n  } catch (e) {\n    // Ensure that a failure to dispose a service does not disrupt other\n    // services.\n    dev().error('SERVICE', 'failed to dispose service', id, e);\n  }\n}\n\n/**\n * This adopts the service **instance** from the parent.\n *\n * This function is dangerous! Sharing an instance means data can leak to and\n * from a child ampdoc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceForEmbedDoc(ampdoc, id) {\n  const service = getServiceInternal(\n    getAmpdocServiceHolder(devAssert(ampdoc.getParent())),\n    id\n  );\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    function () {\n      return service;\n    },\n    /* override */ false,\n    /* sharedInstance */ true\n  );\n}\n\n/**\n * This adopts the service **factory** from the parent.\n *\n * This function is safer than sharing the service instance, since each ampdoc\n * will create its own instance of the factory (and each instance will have its\n * own instance data). Note that static data is still shared, so it's not 100%\n * foolproof.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceFactoryForEmbedDoc(ampdoc, id) {\n  const parentHolder = getAmpdocServiceHolder(devAssert(ampdoc.getParent()));\n  devAssert(\n    isServiceRegistered(parentHolder, id),\n    `Expected service ${id} to be registered`\n  );\n  const service = getServices(parentHolder)[id];\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    devAssert(service.ctor)\n  );\n}\n\n/**\n * Resets a single service, so it gets recreated on next getService invocation.\n * @param {!Object} holder\n * @param {string} id of the service.\n */\nexport function resetServiceForTesting(holder, id) {\n  if (holder.__AMP_SERVICES) {\n    holder.__AMP_SERVICES[id] = null;\n  }\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {boolean}\n */\nfunction isServiceRegistered(holder, id) {\n  const service = holder.__AMP_SERVICES && holder.__AMP_SERVICES[id];\n  // All registered services must have a constructor.\n  return !!(service && service.ctor);\n}\n\n/** @return {!ServiceHolderDef} */\nfunction emptyServiceHolderWithPromise() {\n  const deferred = new Deferred();\n  const {promise, reject, resolve} = deferred;\n  promise.catch(() => {}); // avoid uncaught exception when service gets rejected\n  return {\n    obj: null,\n    promise,\n    resolve,\n    reject,\n    context: null,\n    ctor: null,\n  };\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Experiments system allows a developer to opt-in to test\n * features that are not yet fully tested.\n *\n * Experiments page: https://cdn.ampproject.org/experiments.html *\n */\n\nimport {dev, user} from '../log';\nimport {getMode} from '../mode';\nimport {getTopWindow} from '../service';\nimport {hasOwn, map} from '../core/types/object';\nimport {isArray} from '../core/types';\nimport {parseQueryString} from '../core/types/string/url';\n\n// typedef imports\nimport {ExperimentInfoDef} from './experiments.type';\n\n/** @const {string} */\nconst TAG = 'EXPERIMENTS';\n\n/** @const {string} */\nconst LOCAL_STORAGE_KEY = 'amp-experiment-toggles';\n\n/** @const {string} */\nconst TOGGLES_WINDOW_PROPERTY = '__AMP__EXPERIMENT_TOGGLES';\n\n/**\n * Whether we are in canary.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isCanary(win) {\n  return !!win.AMP_CONFIG?.canary;\n}\n\n/**\n * Returns binary type, e.g., canary, production, control, or rc.\n * @param {!Window} win\n * @return {string}\n */\nexport function getBinaryType(win) {\n  return win.AMP_CONFIG?.type || 'unknown';\n}\n\n/**\n * Whether the specified experiment is on or off.\n * @param {!Window} win\n * @param {string} experimentId\n * @return {boolean}\n */\nexport function isExperimentOn(win, experimentId) {\n  const toggles = experimentToggles(win);\n  return !!toggles[experimentId];\n}\n\n/**\n * Toggles the experiment on or off. Returns the actual value of the experiment\n * after toggling is done.\n * @param {!Window} win\n * @param {string} experimentId\n * @param {boolean=} opt_on\n * @param {boolean=} opt_transientExperiment  Whether to toggle the\n *     experiment state \"transiently\" (i.e., for this page load only) or\n *     durably (by saving the experiment IDs after toggling).\n *     Default: false (save durably).\n * @return {boolean} New state for experimentId.\n */\nexport function toggleExperiment(\n  win,\n  experimentId,\n  opt_on,\n  opt_transientExperiment\n) {\n  const currentlyOn = isExperimentOn(win, /*OK*/ experimentId);\n  const on = opt_on ?? !currentlyOn;\n  if (on != currentlyOn) {\n    const toggles = experimentToggles(win);\n    toggles[experimentId] = on;\n\n    if (!opt_transientExperiment) {\n      const storedToggles = getExperimentToggles(win);\n      storedToggles[experimentId] = on;\n      saveExperimentToggles(win, storedToggles);\n      // Avoid affecting tests that spy/stub warn().\n      if (!getMode().test) {\n        user().warn(\n          TAG,\n          '\"%s\" experiment %s for the domain \"%s\". See: https://amp.dev/documentation/guides-and-tutorials/learn/experimental',\n          experimentId,\n          on ? 'enabled' : 'disabled',\n          win.location.hostname\n        );\n      }\n    }\n  }\n  return on;\n}\n\n/**\n * Calculate whether the experiment is on or off based off of its default value,\n * stored overriden value, or the global config frequency given.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\nexport function experimentToggles(win) {\n  if (win[TOGGLES_WINDOW_PROPERTY]) {\n    return win[TOGGLES_WINDOW_PROPERTY];\n  }\n  win[TOGGLES_WINDOW_PROPERTY] = map();\n  const toggles = win[TOGGLES_WINDOW_PROPERTY];\n\n  // Read the default config of this build.\n  if (win.AMP_CONFIG) {\n    for (const experimentId in win.AMP_CONFIG) {\n      const frequency = win.AMP_CONFIG[experimentId];\n      if (typeof frequency === 'number' && frequency >= 0 && frequency <= 1) {\n        toggles[experimentId] = Math.random() < frequency;\n      }\n    }\n  }\n  // Read document level override from meta tag.\n  const allowedDocOptIn = win.AMP_CONFIG?.['allow-doc-opt-in'];\n  if (isArray(allowedDocOptIn) && allowedDocOptIn.length) {\n    const meta = win.document.head.querySelector(\n      'meta[name=\"amp-experiments-opt-in\"]'\n    );\n    if (meta) {\n      const optedInExperiments = meta.getAttribute('content').split(',');\n      for (const experiment of optedInExperiments) {\n        if (dev().assertArray(allowedDocOptIn).includes(experiment)) {\n          toggles[experiment] = true;\n        }\n      }\n    }\n  }\n\n  Object.assign(toggles, getExperimentToggles(win));\n\n  const allowedUrlOptIn = win.AMP_CONFIG?.['allow-url-opt-in'];\n  if (isArray(allowedUrlOptIn) && allowedUrlOptIn.length) {\n    const hash = win.location['originalHash'] || win.location.hash;\n    const params = parseQueryString(hash);\n    for (const experiment of allowedUrlOptIn) {\n      const param = params[`e-${experiment}`];\n      if (param == '1') {\n        toggles[experiment] = true;\n      }\n      if (param == '0') {\n        toggles[experiment] = false;\n      }\n    }\n  }\n  return toggles;\n}\n\n/**\n * Returns the cached experiments toggles, or null if they have not been\n * computed yet.\n * @param {!Window} win\n * @return {?Object<string, boolean>}\n */\nexport function experimentTogglesOrNull(win) {\n  return win[TOGGLES_WINDOW_PROPERTY] || null;\n}\n\n/**\n * Returns a set of experiment IDs currently on.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\nfunction getExperimentToggles(win) {\n  let experimentsString = '';\n  try {\n    if ('localStorage' in win) {\n      experimentsString = win.localStorage.getItem(LOCAL_STORAGE_KEY);\n    }\n  } catch {\n    dev().warn(TAG, 'Failed to retrieve experiments from localStorage.');\n  }\n  const tokens = experimentsString?.split(/\\s*,\\s*/g) || [];\n\n  const toggles = map();\n  for (const token of tokens) {\n    if (!token) {\n      continue;\n    }\n    if (token[0] == '-') {\n      toggles[token.substr(1)] = false;\n    } else {\n      toggles[token] = true;\n    }\n  }\n  return toggles;\n}\n\n/**\n * Saves a set of experiment IDs currently on.\n * @param {!Window} win\n * @param {!Object<string, boolean>} toggles\n */\nfunction saveExperimentToggles(win, toggles) {\n  const experimentIds = [];\n  for (const experiment in toggles) {\n    experimentIds.push((toggles[experiment] === false ? '-' : '') + experiment);\n  }\n  try {\n    win.localStorage?.setItem(LOCAL_STORAGE_KEY, experimentIds.join(','));\n  } catch (e) {\n    user().error(TAG, 'Failed to save experiments to localStorage.');\n  }\n}\n\n/**\n * See getExperimentToggles().\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n * @visibleForTesting\n */\nexport function getExperimentTogglesForTesting(win) {\n  return getExperimentToggles(win);\n}\n\n/**\n * Resets the experimentsToggle cache for testing purposes.\n * @param {!Window} win\n * @visibleForTesting\n */\nexport function resetExperimentTogglesForTesting(win) {\n  saveExperimentToggles(win, {});\n  win[TOGGLES_WINDOW_PROPERTY] = null;\n}\n\n/**\n * In some browser implementations of Math.random(), sequential calls of\n * Math.random() are correlated and can cause a bias.  In particular,\n * if the previous random() call was < 0.001 (as it will be if we select\n * into an experiment), the next value could be less than 0.5 more than\n * 50.7% of the time.  This provides an implementation that roots down into\n * the crypto API, when available, to produce less biased samples.\n *\n * @return {number} Pseudo-random floating-point value on the range [0, 1).\n */\nfunction slowButAccuratePrng() {\n  // TODO(tdrl): Implement.\n  return Math.random();\n}\n\n/**\n * Container for alternate random number generator implementations.  This\n * allows us to set an \"accurate\" PRNG for branch selection, but to mock it\n * out easily in tests.\n *\n * @visibleForTesting\n * @const {!{accuratePrng: function():number}}\n */\nexport const RANDOM_NUMBER_GENERATORS = {\n  accuratePrng: slowButAccuratePrng,\n};\n\n/**\n * Selects, uniformly at random, a single item from the array.\n * @param {!Array<string>} arr Object to select from.\n * @return {?string} Single item from arr or null if arr was empty.\n */\nfunction selectRandomItem(arr) {\n  const rn = RANDOM_NUMBER_GENERATORS.accuratePrng();\n  return dev().assertString(arr[Math.floor(rn * arr.length)]) || null;\n}\n\n/**\n * Selects which page-level experiment branches are enabled. If a given\n * experiment name is already set (including to the null / no branches selected\n * state), this won't alter its state.\n *\n * Check whether a given experiment is set using isExperimentOn(win,\n * experimentName) and, if it is on, look for which branch is selected in\n * win.__AMP_EXPERIMENT_BRANCHES[experimentName].\n *\n * @param {!Window} win Window context on which to save experiment\n *     selection state.\n * @param {!Array<!ExperimentInfoDef>} experiments  Set of experiments to\n *     configure for this page load.\n * @return {!Object<string, string>} Map of experiment names to selected\n *     branches.\n */\nexport function randomlySelectUnsetExperiments(win, experiments) {\n  win.__AMP_EXPERIMENT_BRANCHES = win.__AMP_EXPERIMENT_BRANCHES || {};\n  const selectedExperiments = {};\n  for (const experiment of experiments) {\n    const experimentName = experiment.experimentId;\n    if (hasOwn(win.__AMP_EXPERIMENT_BRANCHES, experimentName)) {\n      selectedExperiments[experimentName] =\n        win.__AMP_EXPERIMENT_BRANCHES[experimentName];\n      continue;\n    }\n\n    if (!experiment.isTrafficEligible?.(win)) {\n      win.__AMP_EXPERIMENT_BRANCHES[experimentName] = null;\n      continue;\n    }\n\n    // If we're in the experiment, but we haven't already forced a specific\n    // experiment branch (e.g., via a test setup), then randomize the branch\n    // choice.\n    if (\n      !win.__AMP_EXPERIMENT_BRANCHES[experimentName] &&\n      isExperimentOn(win, /*OK*/ experimentName)\n    ) {\n      win.__AMP_EXPERIMENT_BRANCHES[experimentName] = selectRandomItem(\n        experiment.branches\n      );\n      selectedExperiments[experimentName] =\n        win.__AMP_EXPERIMENT_BRANCHES[experimentName];\n    }\n  }\n  return selectedExperiments;\n}\n\n/**\n * Returns the experiment branch enabled for the given experiment ID.\n * For example, 'control' or 'experiment'.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @param {string} experimentName Name of the experiment to check.\n * @return {?string} Active experiment branch ID for experimentName (possibly\n *     null if experimentName has been tested but no branch was enabled).\n */\nexport function getExperimentBranch(win, experimentName) {\n  return win.__AMP_EXPERIMENT_BRANCHES\n    ? win.__AMP_EXPERIMENT_BRANCHES[experimentName]\n    : null;\n}\n\n/**\n * Returns an object containing all active experiment branches on the\n * top Window.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @return {!Object} contains all experiment branches and their ids.\n */\nexport function getActiveExperimentBranches(win) {\n  const topWin = getTopWindow(win);\n  if (!topWin.__AMP_EXPERIMENT_BRANCHES) {\n    topWin.__AMP_EXPERIMENT_BRANCHES = {};\n  }\n  return {...topWin.__AMP_EXPERIMENT_BRANCHES};\n}\n\n/**\n * Force enable (or disable) a specific branch of a given experiment name.\n * Disables the experiment name altogether if branchId is falseish.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @param {string} experimentName Name of the experiment to check.\n * @param {?string} branchId ID of branch to force or null to disable\n *     altogether.\n * @visibleForTesting\n */\nexport function forceExperimentBranch(win, experimentName, branchId) {\n  win.__AMP_EXPERIMENT_BRANCHES = win.__AMP_EXPERIMENT_BRANCHES || {};\n  toggleExperiment(win, experimentName, !!branchId, true);\n  win.__AMP_EXPERIMENT_BRANCHES[experimentName] = branchId;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Note: loaded by 3p system. Cannot rely on babel polyfills.\nimport {dev, devAssert} from './log';\nimport {map} from './core/types/object';\n\n/** @type {Object<string, string>} */\nlet propertyNameCache;\n\n/** @const {!Array<string>} */\nconst vendorPrefixes = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n\nconst EMPTY_CSS_DECLARATION = /** @type {!CSSStyleDeclaration} */ ({\n  'getPropertyPriority': () => '',\n  'getPropertyValue': () => '',\n});\n\n/**\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\nexport function camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n\n/**\n  Checks the style if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} style\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\nfunction getVendorJsPropertyName_(style, titleCase) {\n  for (let i = 0; i < vendorPrefixes.length; i++) {\n    const propertyName = vendorPrefixes[i] + titleCase;\n    if (style[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n  return '';\n}\n\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @param {!Object} style\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} opt_bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\nexport function getVendorJsPropertyName(style, camelCase, opt_bypassCache) {\n  if (isVar(camelCase)) {\n    // CSS vars are returned as is.\n    return camelCase;\n  }\n  if (!propertyNameCache) {\n    propertyNameCache = map();\n  }\n  let propertyName = propertyNameCache[camelCase];\n  if (!propertyName || opt_bypassCache) {\n    propertyName = camelCase;\n    if (style[camelCase] === undefined) {\n      const titleCase = camelCaseToTitleCase(camelCase);\n      const prefixedPropertyName = getVendorJsPropertyName_(style, titleCase);\n\n      if (style[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n    if (!opt_bypassCache) {\n      propertyNameCache[camelCase] = propertyName;\n    }\n  }\n  return propertyName;\n}\n\n/**\n * Sets the CSS styles of the specified element with !important. The styles\n * are specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setImportantStyles(element, styles) {\n  const {style} = element;\n  for (const k in styles) {\n    style.setProperty(\n      getVendorJsPropertyName(style, k),\n      String(styles[k]),\n      'important'\n    );\n  }\n}\n\n/**\n * Sets the CSS style of the specified element with optional units, e.g. \"px\".\n * @param {?Element} element\n * @param {string} property\n * @param {*} value\n * @param {string=} opt_units\n * @param {boolean=} opt_bypassCache\n */\nexport function setStyle(element, property, value, opt_units, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return;\n  }\n  const styleValue = /** @type {string} */ (\n    opt_units ? value + opt_units : value\n  );\n  if (isVar(propertyName)) {\n    element.style.setProperty(propertyName, styleValue);\n  } else {\n    element.style[propertyName] = styleValue;\n  }\n}\n\n/**\n * Returns the value of the CSS style of the specified element.\n * @param {!Element} element\n * @param {string} property\n * @param {boolean=} opt_bypassCache\n * @return {*}\n */\nexport function getStyle(element, property, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return undefined;\n  }\n  if (isVar(propertyName)) {\n    return element.style.getPropertyValue(propertyName);\n  }\n  return element.style[propertyName];\n}\n\n/**\n * Sets the CSS styles of the specified element. The styles\n * a specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setStyles(element, styles) {\n  for (const k in styles) {\n    setStyle(element, k, styles[k]);\n  }\n}\n\n/**\n * Asserts that the style is not the `display` style.\n * This is the only possible way to pass a dynamic style to setStyle.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {string} style\n * @return {string}\n */\nexport function assertNotDisplay(style) {\n  if (style === 'display') {\n    dev().error(\n      'STYLE',\n      '`display` style detected. You must use toggle instead.'\n    );\n  }\n  return style;\n}\n\n/**\n * Asserts that the styles does not contain the `display` style.\n * This is the only possible way to pass a dynamic styles object to setStyles\n * and setImportantStyles.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {!Object<string, *>} styles\n * @return {!Object<string, *>}\n */\nexport function assertDoesNotContainDisplay(styles) {\n  if ('display' in styles) {\n    dev().error(\n      'STYLE',\n      '`display` style detected in styles. You must use toggle instead.'\n    );\n  }\n  return styles;\n}\n\n/**\n * Sets the initial display style of an element. This is a last resort. If you\n * can set the initial display using CSS, YOU MUST.\n * DO NOT USE THIS TO ARBITRARILY SET THE DISPLAY STYLE AFTER INITIAL SETUP.\n *\n * @param {!Element} el\n * @param {string} value\n */\nexport function setInitialDisplay(el, value) {\n  const {style} = el;\n  devAssert(\n    value !== '' && value !== 'none',\n    'Initial display value must not be \"none\". Use toggle instead.'\n  );\n  devAssert(\n    !style['display'],\n    'setInitialDisplay MUST NOT be used for ' +\n      'resetting the display style. If you are looking for display:none ' +\n      'toggling, use toggle instead.'\n  );\n  style['display'] = value;\n}\n\n/**\n * Shows or hides the specified element.\n * @param {!Element} element\n * @param {boolean=} opt_display\n */\nexport function toggle(element, opt_display) {\n  if (opt_display === undefined) {\n    opt_display = element.hasAttribute('hidden');\n  }\n  if (opt_display) {\n    element.removeAttribute('hidden');\n  } else {\n    element.setAttribute('hidden', '');\n  }\n}\n\n/**\n * Returns a pixel value.\n * @param {number} value\n * @return {string}\n */\nexport function px(value) {\n  return `${value}px`;\n}\n\n/**\n * Returns a degree value.\n * @param {number} value\n * @return {string}\n */\nexport function deg(value) {\n  return `${value}deg`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function translateX(value) {\n  if (typeof value == 'string') {\n    return `translateX(${value})`;\n  }\n  return `translateX(${px(value)})`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} x\n * @param {(number|string)=} opt_y\n * @return {string}\n */\nexport function translate(x, opt_y) {\n  if (typeof x == 'number') {\n    x = px(x);\n  }\n  if (opt_y === undefined) {\n    return `translate(${x})`;\n  }\n  if (typeof opt_y == 'number') {\n    opt_y = px(opt_y);\n  }\n  return `translate(${x}, ${opt_y})`;\n}\n\n/**\n * Returns a \"scale\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function scale(value) {\n  return `scale(${value})`;\n}\n\n/**\n * Returns a \"rotate\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function rotate(value) {\n  if (typeof value == 'number') {\n    value = deg(value);\n  }\n  return `rotate(${value})`;\n}\n\n/**\n * Remove alpha value from a rgba color value.\n * Return the new color property with alpha equals if has the alpha value.\n * Caller needs to make sure the input color value is a valid rgba/rgb value\n * @param {string} rgbaColor\n * @return {string}\n */\nexport function removeAlphaFromColor(rgbaColor) {\n  return rgbaColor.replace(\n    /\\(([^,]+),([^,]+),([^,)]+),[^)]+\\)/g,\n    '($1,$2,$3, 1)'\n  );\n}\n\n/**\n * Gets the computed style of the element. The helper is necessary to enforce\n * the possible `null` value returned by a buggy Firefox.\n *\n * @param {!Window} win\n * @param {!Element} el\n * @return {!CSSStyleDeclaration}\n */\nexport function computedStyle(win, el) {\n  const style = /** @type {?CSSStyleDeclaration} */ (win.getComputedStyle(el));\n  return style || EMPTY_CSS_DECLARATION;\n}\n\n/**\n * Resets styles that were set dynamically (i.e. inline)\n * @param {!Element} element\n * @param {!Array<string>} properties\n */\nexport function resetStyles(element, properties) {\n  for (let i = 0; i < properties.length; i++) {\n    setStyle(element, properties[i], null);\n  }\n}\n\n/**\n * Propagates the object-fit/position element attributes as styles.\n * @param {!Element} fromEl ie: amp-img\n * @param {!Element} toEl ie: the img within amp-img\n */\nexport function propagateObjectFitStyles(fromEl, toEl) {\n  if (fromEl.hasAttribute('object-fit')) {\n    setStyle(toEl, 'object-fit', fromEl.getAttribute('object-fit'));\n  }\n\n  if (fromEl.hasAttribute('object-position')) {\n    setStyle(toEl, 'object-position', fromEl.getAttribute('object-position'));\n  }\n}\n\n/**\n * @param {string} property\n * @return {boolean}\n */\nfunction isVar(property) {\n  return property.startsWith('--');\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Implements element layout. See https://goo.gl/9avXuT for\n * details.\n */\n\nimport {dev, devAssert, userAssert} from './log';\nimport {htmlFor} from './static-template';\nimport {isExperimentOn} from './experiments';\nimport {isFiniteNumber} from './core/types';\nimport {setStyle, setStyles, toggle} from './style';\nimport {toWin} from './core/window';\nimport {transparentPng} from './core/dom/img';\n\n/**\n * @enum {string}\n */\nexport const Layout = {\n  NODISPLAY: 'nodisplay',\n  FIXED: 'fixed',\n  FIXED_HEIGHT: 'fixed-height',\n  RESPONSIVE: 'responsive',\n  CONTAINER: 'container',\n  FILL: 'fill',\n  FLEX_ITEM: 'flex-item',\n  FLUID: 'fluid',\n  INTRINSIC: 'intrinsic',\n};\n\n/**\n * Layout priorities to use with BaseElement#getLayoutPriority() and\n * BaseElement#updateLayoutPriority().\n * @enum {number}\n */\nexport const LayoutPriority = {\n  CONTENT: 0,\n  METADATA: 1,\n  ADS: 2,\n  BACKGROUND: 3,\n};\n\n/**\n * CSS Length type. E.g. \"1px\" or \"20vh\".\n * @typedef {string}\n */\nexport let LengthDef;\n\n/**\n * @typedef {{\n *   width: string,\n *   height: string\n * }}\n */\nlet DimensionsDef;\n\n/**\n * The set of elements with natural dimensions, that is, elements\n * which have a known dimension either based on their value specified here,\n * or, if the value is null, a dimension specific to the browser.\n * `hasNaturalDimensions` checks for membership in this set.\n * `getNaturalDimensions` determines the dimensions for an element in the\n *    set and caches it.\n * @type {!Object<string, ?DimensionsDef>}\n * @private  Visible for testing only!\n */\nexport const naturalDimensions_ = {\n  'AMP-PIXEL': {width: '0px', height: '0px'},\n  'AMP-ANALYTICS': {width: '1px', height: '1px'},\n  // TODO(dvoytenko): audio should have width:auto.\n  'AMP-AUDIO': null,\n  'AMP-SOCIAL-SHARE': {width: '60px', height: '44px'},\n};\n\n/**\n * Elements that the progress can be shown for. This set has to be externalized\n * since the element's implementation may not be downloaded yet.\n * This list does not include video players which are found via regex later.\n * @enum {boolean}\n * @private  Visible for testing only!\n */\nexport const LOADING_ELEMENTS_ = {\n  'AMP-AD': true,\n  'AMP-ANIM': true,\n  'AMP-EMBED': true,\n  'AMP-FACEBOOK': true,\n  'AMP-FACEBOOK-COMMENTS': true,\n  'AMP-FACEBOOK-PAGE': true,\n  'AMP-GOOGLE-DOCUMENT-EMBED': true,\n  'AMP-IFRAME': true,\n  'AMP-IMG': true,\n  'AMP-INSTAGRAM': true,\n  'AMP-LIST': true,\n  'AMP-PINTEREST': true,\n  'AMP-PLAYBUZZ': true,\n  'AMP-RENDER': true,\n  'AMP-TWITTER': true,\n};\n/**\n * All video player components must either have a) \"video\" or b) \"player\" in\n * their name. A few components don't follow this convention for historical\n * reasons, so they are listed individually.\n * @private @const {!RegExp}\n */\nconst videoPlayerTagNameRe =\n  /^amp\\-(video|.+player)|AMP-BRIGHTCOVE|AMP-DAILYMOTION|AMP-YOUTUBE|AMP-VIMEO|AMP-IMA-VIDEO/i;\n\n/**\n * Whether aspect-ratio CSS can be used to implement responsive layouts.\n * @type {?boolean}\n */\nlet aspectRatioCssCache = null;\n\n/**\n * @param {string} s\n * @return {Layout|undefined} Returns undefined in case of failure to parse\n *   the layout string.\n */\nexport function parseLayout(s) {\n  for (const k in Layout) {\n    if (Layout[k] == s) {\n      return Layout[k];\n    }\n  }\n  return undefined;\n}\n\n/**\n * @param {!Layout} layout\n * @return {string}\n */\nexport function getLayoutClass(layout) {\n  return 'i-amphtml-layout-' + layout;\n}\n\n/**\n * Whether an element with this layout inherently defines the size.\n * @param {!Layout} layout\n * @return {boolean}\n */\nexport function isLayoutSizeDefined(layout) {\n  return (\n    layout == Layout.FIXED ||\n    layout == Layout.FIXED_HEIGHT ||\n    layout == Layout.RESPONSIVE ||\n    layout == Layout.FILL ||\n    layout == Layout.FLEX_ITEM ||\n    layout == Layout.FLUID ||\n    layout == Layout.INTRINSIC\n  );\n}\n\n/**\n * Whether an element with this layout has a fixed dimension.\n * @param {!Layout} layout\n * @return {boolean}\n */\nexport function isLayoutSizeFixed(layout) {\n  return layout == Layout.FIXED || layout == Layout.FIXED_HEIGHT;\n}\n\n/**\n * Whether the tag is an internal (service) AMP tag.\n * @param {!Node|string} tag\n * @return {boolean}\n */\nexport function isInternalElement(tag) {\n  const tagName = typeof tag == 'string' ? tag : tag.tagName;\n  return tagName && tagName.toLowerCase().startsWith('i-');\n}\n\n/**\n * Parses the CSS length value. If no units specified, the assumed value is\n * \"px\". Returns undefined in case of parsing error.\n * @param {string|undefined|null} s\n * @return {!LengthDef|undefined}\n */\nexport function parseLength(s) {\n  if (typeof s == 'number') {\n    return s + 'px';\n  }\n  if (!s) {\n    return undefined;\n  }\n  if (!/^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|cm|mm|q|in|pc|pt)?$/.test(s)) {\n    return undefined;\n  }\n  if (/^\\d+(\\.\\d+)?$/.test(s)) {\n    return s + 'px';\n  }\n  return s;\n}\n\n/**\n * Asserts that the supplied value is a non-percent CSS Length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {!LengthDef}\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertLength(length) {\n  userAssert(\n    /^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|cm|mm|q|in|pc|pt)$/.test(length),\n    'Invalid length value: %s',\n    length\n  );\n  return /** @type {!LengthDef} */ (length);\n}\n\n/**\n * Asserts that the supplied value is a CSS Length value\n * (including percent unit).\n * @param {!LengthDef|string} length\n * @return {!LengthDef}\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertLengthOrPercent(length) {\n  userAssert(\n    /^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|%)$/.test(length),\n    'Invalid length or percent value: %s',\n    length\n  );\n  return length;\n}\n\n/**\n * Returns units from the CSS length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {string}\n */\nexport function getLengthUnits(length) {\n  assertLength(length);\n  const m = userAssert(\n    /[a-z]+/i.exec(length),\n    'Failed to read units from %s',\n    length\n  );\n  return m[0];\n}\n\n/**\n * Returns the numeric value of a CSS length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {number|undefined}\n */\nexport function getLengthNumeral(length) {\n  const res = parseFloat(length);\n  return isFiniteNumber(res) ? res : undefined;\n}\n\n/**\n * Determines whether the tagName is a known element that has natural dimensions\n * in our runtime or the browser.\n * @param {string} tagName The element tag name.\n * @return {boolean}\n */\nexport function hasNaturalDimensions(tagName) {\n  tagName = tagName.toUpperCase();\n  return naturalDimensions_[tagName] !== undefined;\n}\n\n/**\n * Determines the default dimensions for an element which could vary across\n * different browser implementations, like <audio> for instance.\n * This operation can only be completed for an element allowlisted by\n * `hasNaturalDimensions`.\n * @param {!Element} element\n * @return {DimensionsDef}\n */\nexport function getNaturalDimensions(element) {\n  const tagName = element.tagName.toUpperCase();\n  devAssert(naturalDimensions_[tagName] !== undefined);\n  if (!naturalDimensions_[tagName]) {\n    const doc = element.ownerDocument;\n    const naturalTagName = tagName.replace(/^AMP\\-/, '');\n    const temp = doc.createElement(naturalTagName);\n    // For audio, should no-op elsewhere.\n    temp.controls = true;\n    setStyles(temp, {\n      position: 'absolute',\n      visibility: 'hidden',\n    });\n    doc.body.appendChild(temp);\n    naturalDimensions_[tagName] = {\n      width: (temp./*OK*/ offsetWidth || 1) + 'px',\n      height: (temp./*OK*/ offsetHeight || 1) + 'px',\n    };\n    doc.body.removeChild(temp);\n  }\n  return /** @type {DimensionsDef} */ (naturalDimensions_[tagName]);\n}\n\n/**\n * Whether the loading can be shown for the specified element. This set has\n * to be externalized since the element's implementation may not be\n * downloaded yet.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isLoadingAllowed(element) {\n  const tagName = element.tagName.toUpperCase();\n  return LOADING_ELEMENTS_[tagName] || isIframeVideoPlayerComponent(tagName);\n}\n\n/**\n * All video player components must either have a) \"video\" or b) \"player\" in\n * their name. A few components don't follow this convention for historical\n * reasons, so they're present in the LOADING_ELEMENTS_ allowlist.\n * @param {string} tagName\n * @return {boolean}\n */\nexport function isIframeVideoPlayerComponent(tagName) {\n  if (tagName == 'AMP-VIDEO') {\n    return false;\n  }\n  return videoPlayerTagNameRe.test(tagName);\n}\n\n/**\n * Applies layout to the element. Visible for testing only.\n *\n * \\   \\  /  \\  /   / /   \\     |   _  \\     |  \\ |  | |  | |  \\ |  |  / _____|\n *  \\   \\/    \\/   / /  ^  \\    |  |_)  |    |   \\|  | |  | |   \\|  | |  |  __\n *   \\            / /  /_\\  \\   |      /     |  . `  | |  | |  . `  | |  | |_ |\n *    \\    /\\    / /  _____  \\  |  |\\  \\----.|  |\\   | |  | |  |\\   | |  |__| |\n *     \\__/  \\__/ /__/     \\__\\ | _| `._____||__| \\__| |__| |__| \\__|  \\______|\n *\n * The equivalent of this method is used for server-side rendering (SSR) and\n * any changes made to it must be made in coordination with caches that\n * implement SSR. For more information on SSR see bit.ly/amp-ssr.\n *\n * @param {!Element} element\n * @param {boolean} fixIeIntrinsic\n * @return {!Layout}\n */\nexport function applyStaticLayout(element, fixIeIntrinsic = false) {\n  // Check if the layout has already been done by server-side rendering or\n  // client-side rendering and the element was cloned. The document may be\n  // visible to the user if the boilerplate was removed so please take care in\n  // making changes here.\n  const completedLayoutAttr = element.getAttribute('i-amphtml-layout');\n  if (completedLayoutAttr) {\n    const layout = /** @type {!Layout} */ (\n      devAssert(parseLayout(completedLayoutAttr))\n    );\n    if (\n      (layout == Layout.RESPONSIVE || layout == Layout.INTRINSIC) &&\n      element.firstElementChild\n    ) {\n      // Find sizer, but assume that it might not have been parsed yet.\n      element.sizerElement =\n        element.querySelector('i-amphtml-sizer') || undefined;\n      if (element.sizerElement) {\n        element.sizerElement.setAttribute('slot', 'i-amphtml-svc');\n      }\n    } else if (layout == Layout.NODISPLAY) {\n      toggle(element, false);\n      // TODO(jridgewell): Temporary hack while SSR still adds an inline\n      // `display: none`\n      element['style']['display'] = '';\n    }\n    return layout;\n  }\n\n  // If the layout was already done by server-side rendering (SSR), then the\n  // code below will not run. Any changes below will necessitate a change to SSR\n  // and must be coordinated with caches that implement SSR. See bit.ly/amp-ssr.\n\n  // Parse layout from the element.\n  const layoutAttr = element.getAttribute('layout');\n  const widthAttr = element.getAttribute('width');\n  const heightAttr = element.getAttribute('height');\n  const sizesAttr = element.getAttribute('sizes');\n  const heightsAttr = element.getAttribute('heights');\n\n  // Input layout attributes.\n  const inputLayout = layoutAttr ? parseLayout(layoutAttr) : null;\n  userAssert(\n    inputLayout !== undefined,\n    'Invalid \"layout\" value: %s, %s',\n    layoutAttr,\n    element\n  );\n  /** @const {string|null|undefined} */\n  const inputWidth =\n    widthAttr && widthAttr != 'auto' ? parseLength(widthAttr) : widthAttr;\n  userAssert(\n    inputWidth !== undefined,\n    'Invalid \"width\" value: %s, %s',\n    widthAttr,\n    element\n  );\n  /** @const {string|null|undefined} */\n  const inputHeight =\n    heightAttr && heightAttr != 'fluid' ? parseLength(heightAttr) : heightAttr;\n  userAssert(\n    inputHeight !== undefined,\n    'Invalid \"height\" value: %s, %s',\n    heightAttr,\n    element\n  );\n\n  // Effective layout attributes. These are effectively constants.\n  let width;\n  let height;\n  let layout;\n\n  // Calculate effective width and height.\n  if (\n    (!inputLayout ||\n      inputLayout == Layout.FIXED ||\n      inputLayout == Layout.FIXED_HEIGHT) &&\n    (!inputWidth || !inputHeight) &&\n    hasNaturalDimensions(element.tagName)\n  ) {\n    // Default width and height: handle elements that do not specify a\n    // width/height and are defined to have natural browser dimensions.\n    const dimensions = getNaturalDimensions(element);\n    width =\n      inputWidth || inputLayout == Layout.FIXED_HEIGHT\n        ? inputWidth\n        : dimensions.width;\n    height = inputHeight || dimensions.height;\n  } else {\n    width = inputWidth;\n    height = inputHeight;\n  }\n\n  // Calculate effective layout.\n  if (inputLayout) {\n    layout = inputLayout;\n  } else if (!width && !height) {\n    layout = Layout.CONTAINER;\n  } else if (height == 'fluid') {\n    layout = Layout.FLUID;\n  } else if (height && (!width || width == 'auto')) {\n    layout = Layout.FIXED_HEIGHT;\n  } else if (height && width && (sizesAttr || heightsAttr)) {\n    layout = Layout.RESPONSIVE;\n  } else {\n    layout = Layout.FIXED;\n  }\n\n  // Verify layout attributes.\n  if (\n    layout == Layout.FIXED ||\n    layout == Layout.FIXED_HEIGHT ||\n    layout == Layout.RESPONSIVE ||\n    layout == Layout.INTRINSIC\n  ) {\n    userAssert(height, 'The \"height\" attribute is missing: %s', element);\n  }\n  if (layout == Layout.FIXED_HEIGHT) {\n    userAssert(\n      !width || width == 'auto',\n      'The \"width\" attribute must be missing or \"auto\": %s',\n      element\n    );\n  }\n  if (\n    layout == Layout.FIXED ||\n    layout == Layout.RESPONSIVE ||\n    layout == Layout.INTRINSIC\n  ) {\n    userAssert(\n      width && width != 'auto',\n      'The \"width\" attribute must be present and not \"auto\": %s',\n      element\n    );\n  }\n\n  if (layout == Layout.RESPONSIVE || layout == Layout.INTRINSIC) {\n    userAssert(\n      getLengthUnits(width) == getLengthUnits(height),\n      'Length units should be the same for \"width\" and \"height\": %s, %s, %s',\n      widthAttr,\n      heightAttr,\n      element\n    );\n  } else {\n    userAssert(\n      heightsAttr === null,\n      '\"heights\" attribute must be missing: %s',\n      element\n    );\n  }\n\n  // Apply UI.\n  element.classList.add(getLayoutClass(layout));\n  if (isLayoutSizeDefined(layout)) {\n    element.classList.add('i-amphtml-layout-size-defined');\n  }\n  if (layout == Layout.NODISPLAY) {\n    // CSS defines layout=nodisplay automatically with `display:none`. Thus\n    // no additional styling is needed.\n    toggle(element, false);\n    // TODO(jridgewell): Temporary hack while SSR still adds an inline\n    // `display: none`\n    element['style']['display'] = '';\n  } else if (layout == Layout.FIXED) {\n    setStyles(element, {\n      width: dev().assertString(width),\n      height: dev().assertString(height),\n    });\n  } else if (layout == Layout.FIXED_HEIGHT) {\n    setStyle(element, 'height', dev().assertString(height));\n  } else if (layout == Layout.RESPONSIVE) {\n    if (shouldUseAspectRatioCss(toWin(element.ownerDocument.defaultView))) {\n      setStyle(\n        element,\n        'aspect-ratio',\n        `${getLengthNumeral(width)}/${getLengthNumeral(height)}`\n      );\n    } else {\n      const sizer = element.ownerDocument.createElement('i-amphtml-sizer');\n      sizer.setAttribute('slot', 'i-amphtml-svc');\n      setStyles(sizer, {\n        paddingTop:\n          (getLengthNumeral(height) / getLengthNumeral(width)) * 100 + '%',\n      });\n      element.insertBefore(sizer, element.firstChild);\n      element.sizerElement = sizer;\n    }\n  } else if (layout == Layout.INTRINSIC) {\n    // Intrinsic uses an svg inside the sizer element rather than the padding\n    // trick Note a naked svg won't work becasue other thing expect the\n    // i-amphtml-sizer element\n    const sizer = htmlFor(element)`\n      <i-amphtml-sizer class=\"i-amphtml-sizer\" slot=\"i-amphtml-svc\">\n        <img alt=\"\" role=\"presentation\" aria-hidden=\"true\"\n             class=\"i-amphtml-intrinsic-sizer\" />\n      </i-amphtml-sizer>`;\n    const intrinsicSizer = sizer.firstElementChild;\n    intrinsicSizer.setAttribute(\n      'src',\n      !IS_ESM && fixIeIntrinsic && element.ownerDocument\n        ? transparentPng(\n            element.ownerDocument,\n            dev().assertNumber(getLengthNumeral(width)),\n            dev().assertNumber(getLengthNumeral(height))\n          )\n        : `data:image/svg+xml;charset=utf-8,<svg height=\"${height}\" width=\"${width}\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\"/>`\n    );\n    element.insertBefore(sizer, element.firstChild);\n    element.sizerElement = sizer;\n  } else if (layout == Layout.FILL) {\n    // Do nothing.\n  } else if (layout == Layout.CONTAINER) {\n    // Do nothing. Elements themselves will check whether the supplied\n    // layout value is acceptable. In particular container is only OK\n    // sometimes.\n  } else if (layout == Layout.FLEX_ITEM) {\n    // Set height and width to a flex item if they exist.\n    // The size set to a flex item could be overridden by `display: flex` later.\n    if (width) {\n      setStyle(element, 'width', width);\n    }\n    if (height) {\n      setStyle(element, 'height', height);\n    }\n  } else if (layout == Layout.FLUID) {\n    element.classList.add('i-amphtml-layout-awaiting-size');\n    if (width) {\n      setStyle(element, 'width', width);\n    }\n    setStyle(element, 'height', 0);\n  }\n  // Mark the element as having completed static layout, in case it is cloned\n  // in the future.\n  element.setAttribute('i-amphtml-layout', layout);\n  return layout;\n}\n\n/**\n * Whether aspect-ratio CSS can be used to implement responsive layouts.\n *\n * @param {!Window} win\n * @return {boolean}\n */\nfunction shouldUseAspectRatioCss(win) {\n  if (aspectRatioCssCache == null) {\n    aspectRatioCssCache =\n      (isExperimentOn(win, 'layout-aspect-ratio-css') &&\n        win.CSS &&\n        win.CSS.supports &&\n        win.CSS.supports('aspect-ratio: 1/1')) ||\n      false;\n  }\n  return aspectRatioCssCache;\n}\n\n/** @visibleForTesting */\nexport function resetShouldUseAspectRatioCssForTesting() {\n  aspectRatioCssCache = null;\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Base layer from which other layers in a story page extend from.\n */\n\nimport {Layout} from '../../../src/layout';\n\n/**\n * Base layer template.\n */\nexport class AmpStoryBaseLayer extends AMP.BaseElement {\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return layout == Layout.CONTAINER;\n  }\n\n  /** @override */\n  buildCallback() {\n    this.element.classList.add('i-amphtml-story-layer');\n  }\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Magic constant that is replaced by babel.\n// IS_MINIFIED is always replaced with true when closure compiler is used\nconst IS_MINIFIED = false;\n\n/**\n * Returns true whenever closure compiler is used.\n * @return {boolean}\n */\nexport function isMinifiedMode() {\n  return IS_MINIFIED;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assertions from './base';\nimport {isMinifiedMode} from '../minified-mode';\n\n/**\n * @fileoverview This file provides the entrypoint for dev assertions. It's\n * designed so all functions are pure function calls to improve inlining. All\n * functions in this file get DCE'd away during compilation.\n */\n\n/**\n * This will never execute regardless, but will be included on unminified builds\n * builds. It will be DCE'd away from minified builds, and so can be used to\n * validate that Babel is properly removing dev assertions in minified builds.\n */\nfunction devAssertDceCheck() {\n  if (self.__AMP_ASSERTION_CHECK) {\n    console /*OK*/\n      .log('__devAssert_sentinel__');\n  }\n}\n\n/**\n * Throws an error if the first argument isn't trueish. Mirrors devAssert in\n * src/log.js.\n * @param {T} shouldBeTruthy\n * @param {string=} opt_message\n * @param {*=} opt_1 Optional argument (var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T}\n * @template T\n * @throws {Error} when shouldBeTruthy is not truthy.\n * @closurePrimitive {asserts.truthy}\n */\nexport function devAssert(\n  shouldBeTruthy,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (isMinifiedMode()) {\n    return shouldBeTruthy;\n  }\n  devAssertDceCheck();\n\n  return assertions.assert(\n    '',\n    shouldBeTruthy,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't an Element.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeElement\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Element} The value of shouldBeTrueish.\n * @throws {Error} when shouldBeElement is not an Element\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertElement(shouldBeElement, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {!Element} */ (shouldBeElement);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertElement(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeElement,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a string. The string can\n * be empty.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeString\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {string} The string value. Can be an empty string.\n * @throws {Error} when shouldBeString is not an String\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertString(shouldBeString, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {string} */ (shouldBeString);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertString(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeString,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a number. The allowed values\n * include `0` and `NaN`.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeNumber\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {number} The number value. The allowed values include `0`\n *   and `NaN`.\n * @throws {Error} when shouldBeNumber is not an Number\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertNumber(shouldBeNumber, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {number} */ (shouldBeNumber);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertNumber(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeNumber,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument is not an array.\n * The array can be empty.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeArray\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Array} The array value\n * @throws {Error} when shouldBeArray is not an Array\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertArray(shouldBeArray, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {!Array} */ (shouldBeArray);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertArray(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeArray,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a boolean.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeBoolean\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {boolean} The boolean value.\n * @throws {Error} when shouldBeBoolean is not an Boolean\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertBoolean(shouldBeBoolean, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {boolean} */ (shouldBeBoolean);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertBoolean(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeBoolean,\n    opt_message\n  );\n}\n", "/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */\n\n\n/**\n * This regex consists of 4 matching capture groups and one (non-matching) fallback:\n *\n * - (\\0), catch the null terminator character so it may be replaced by UTF\n *   Replacement Char\n * - ^(-)$, catch a solitary dash char, so that it may be backslash escaped.\n *   This is a separate capture group so that the legal-chars (group 4) doesn't\n *   capture it first, since that group doesn't need to escape its dash.\n * - ([\\x01-\\x1f\\x7f]|^-?[0-9]), catch a UTF control char, or any leading\n *   number (with an optional leading dash). The control or the number (but not\n *   the leading dash) must be hex-escaped,.\n * - ([\\x80-\\uffff0-9a-zA-Z_-]+), catch legal-chars, with the exception of a\n *   solitary dash, which will already have matched in group 1.\n * - [^], finally, a catch-all that allows us to backslash escape the char.\n *\n * Together, this matches everything necessary for CSS.escape.\n */\nvar regex = /(\\0)|^(-)$|([\\x01-\\x1f\\x7f]|^-?[0-9])|([\\x80-\\uffff0-9a-zA-Z_-]+)|[^]/g;\n\nfunction escaper(match, nil, dash, hexEscape, chars) {\n  // Chars is the legal-chars (group 4) capture\n  if (chars) {\n    return chars;\n  }\n  // Nil is the null terminator (group 1) capture\n  if (nil) {\n    return '\\uFFFD';\n  }\n  // Both UTF control chars, and leading numbers (with optional leading dash)\n  // (group 3) must be backslash escaped with a trailing space.  Funnily, the\n  // leading dash must not be escaped, but the number. :shrug:\n  if (hexEscape) {\n    return match.slice(0, -1) + '\\\\' + match.slice(-1).charCodeAt(0).toString(16) + ' '\n  }\n  // Finally, the solitary dash and the catch-all chars require backslash\n  // escaping.\n  return '\\\\' + match;\n}\n\n/**\n * https://drafts.csswg.org/cssom/#serialize-an-identifier\n * @param {string} value\n * @return {string}\n */\nexport function cssEscape(value) {\n  return String(value).replace(regex, escaper);\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {cssEscape} from '../../../third_party/css-escape/css-escape';\nimport {devAssert} from '../assert';\n\n/**\n * @type {boolean|undefined}\n */\nlet scopeSelectorSupported;\n\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\nexport function setScopeSelectorSupportedForTesting(val) {\n  scopeSelectorSupported = val;\n}\n\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element|!ShadowRoot} el\n * @return {boolean}\n */\nexport function isScopeSelectorSupported(el) {\n  if (scopeSelectorSupported !== undefined) {\n    return scopeSelectorSupported;\n  }\n\n  return (scopeSelectorSupported = testScopeSelector(el));\n}\n\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element|!ShadowRoot} el\n * @return {boolean}\n */\nfunction testScopeSelector(el) {\n  try {\n    const doc = el.ownerDocument;\n    const testElement = doc.createElement('div');\n    const testChild = doc.createElement('div');\n    testElement.appendChild(testChild);\n    // NOTE(cvializ, #12383): Firefox's implementation is incomplete,\n    // therefore we test actual functionality of`:scope` as well.\n    return testElement./*OK*/ querySelector(':scope div') === testChild;\n  } catch (e) {\n    return false;\n  }\n}\n\n/**\n * Prefixes a selector for ancestor selection. Splits in subselectors and\n * applies prefix to each.\n *\n * e.g.\n * ```\n *   prependSelectorsWith('div', '.i-amphtml-scoped');\n *   // => '.i-amphtml-scoped div'\n *   prependSelectorsWith('div, ul', ':scope');\n *   // => ':scope div, :scope ul'\n *   prependSelectorsWith('div, ul', 'article >');\n *   // => 'article > div, article > ul'\n * ```\n *\n * @param {string} selector\n * @param {string} distribute\n * @return {string}\n */\nexport function prependSelectorsWith(selector, distribute) {\n  return selector.replace(/^|,/g, `$&${distribute} `);\n}\n\n/**\n * Escapes an ident (ID or a class name) to be used as a CSS selector.\n *\n * See https://drafts.csswg.org/cssom/#serialize-an-identifier.\n *\n * @param {string} ident\n * @return {string}\n * @suppress {uselessCode}\n */\nexport function escapeCssSelectorIdent(ident) {\n  // This gets rewritten to true/false during compilation. It will trigger an\n  // JSC_UNREACHABLE_CODE warning, but that's intentional for DCE.\n  if (IS_ESM) {\n    return CSS.escape(ident);\n  }\n  return cssEscape(ident);\n}\n\n/**\n * Escapes an ident in a way that can be used by :nth-child() psuedo-class.\n *\n * See https://github.com/w3c/csswg-drafts/issues/2306.\n *\n * @param {string|number} ident\n * @return {string}\n */\nexport function escapeCssSelectorNth(ident) {\n  const escaped = String(ident);\n  // Ensure it doesn't close the nth-child psuedo class.\n  devAssert(escaped.indexOf(')') === -1);\n  return escaped;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../assert';\nimport {isScopeSelectorSupported, prependSelectorsWith} from './css-selectors';\n\n/** @fileoverview Helper functions for DOM queries. */\n\n/**\n * Asserts that name is just an alphanumeric word, and does not contain\n * advanced CSS selector features like attributes, psuedo-classes, class names,\n * nor ids.\n * @param {string} name\n */\nfunction assertIsName(name) {\n  devAssert(\n    /^[\\w-]+$/.test(name),\n    `Expected \"${name}\" to be a CSS name composed of alphanumerics and hyphens.`\n  );\n}\n\n/**\n * Finds all elements that matche `selector`, scoped inside `root`\n * for user-agents that do not support native scoping.\n *\n * This method isn't required for modern builds, can be removed.\n *\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n */\nfunction scopedQuerySelectionFallback(root, selector) {\n  const unique = 'i-amphtml-scoped';\n  root.classList.add(unique);\n  const scopedSelector = prependSelectorsWith(selector, `.${unique}`);\n  const elements = root./*OK*/ querySelectorAll(scopedSelector);\n  root.classList.remove(unique);\n  return elements;\n}\n\n/**\n * Finds the first element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {?Element}\n *\n * @suppress {suspiciousCode}\n */\nexport function scopedQuerySelector(root, selector) {\n  if (IS_ESM || isScopeSelectorSupported(root)) {\n    return root./*OK*/ querySelector(prependSelectorsWith(selector, ':scope'));\n  }\n\n  // Only IE.\n  const fallbackResult = scopedQuerySelectionFallback(root, selector);\n  return fallbackResult[0] === undefined ? null : fallbackResult[0];\n}\n\n/**\n * Finds every element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n *\n * @suppress {suspiciousCode}\n */\nexport function scopedQuerySelectorAll(root, selector) {\n  if (IS_ESM || isScopeSelectorSupported(root)) {\n    return root./*OK*/ querySelectorAll(\n      prependSelectorsWith(selector, ':scope')\n    );\n  }\n\n  // Only IE.\n  return scopedQuerySelectionFallback(root, selector);\n}\n\n/**\n * Checks if the given element matches the selector\n * @param  {!Element} el The element to verify\n * @param  {string} selector The selector to check against\n * @return {boolean} True if the element matched the selector. False otherwise.\n */\nexport function matches(el, selector) {\n  const matcher =\n    el.matches ||\n    el.webkitMatchesSelector ||\n    el.mozMatchesSelector ||\n    el.msMatchesSelector ||\n    el.oMatchesSelector;\n  if (matcher) {\n    return matcher.call(el, selector);\n  }\n  return false; // IE8 always returns false.\n}\n\n/**\n * Finds the closest element that satisfies the callback from this element\n * up the DOM subtree.\n * @param {!Element} element\n * @param {function(!Element):boolean} callback\n * @param {Element=} opt_stopAt optional elemnt to stop the search at.\n * @return {?Element}\n */\nexport function closest(element, callback, opt_stopAt) {\n  for (let el = element; el && el !== opt_stopAt; el = el.parentElement) {\n    if (callback(el)) {\n      return el;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the closest node that satisfies the callback from this node\n * up the DOM subtree.\n * @param {!Node} node\n * @param {function(!Node):boolean} callback\n * @return {?Node}\n */\nexport function closestNode(node, callback) {\n  for (let n = node; n; n = n.parentNode) {\n    if (callback(n)) {\n      return n;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the closest ancestor element with the specified selector from this\n * element.\n * @param {!Element} element\n * @param {string} selector\n * @return {?Element} closest ancestor if found.\n */\nexport function closestAncestorElementBySelector(element, selector) {\n  return element.closest\n    ? element.closest(selector)\n    : closest(element, (el) => matches(el, selector));\n}\n\n/**\n * Finds all ancestor elements that satisfy predicate.\n * @param {!Element} child\n * @param {function(!Element):boolean} predicate\n * @return {!Array<!Element>}\n */\nexport function ancestorElements(child, predicate) {\n  const ancestors = [];\n  for (\n    let ancestor = child.parentElement;\n    ancestor;\n    ancestor = ancestor.parentElement\n  ) {\n    if (predicate(ancestor)) {\n      ancestors.push(ancestor);\n    }\n  }\n  return ancestors;\n}\n\n/**\n * Finds all ancestor elements that has the specified tag name.\n * @param {!Element} child\n * @param {string} tagName\n * @return {!Array<!Element>}\n */\nexport function ancestorElementsByTag(child, tagName) {\n  assertIsName(tagName);\n  tagName = tagName.toUpperCase();\n  return ancestorElements(child, (el) => el.tagName == tagName);\n}\n\n/**\n * Finds the first child element that satisfies the callback.\n * TODO(rcebulko): Can we start using generators in childElements and defer to\n * that here?\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function childElement(parent, callback) {\n  for (\n    let child = parent.firstElementChild;\n    child;\n    child = child.nextElementSibling\n  ) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the last child element that satisfies the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function lastChildElement(parent, callback) {\n  for (\n    let child = parent.lastElementChild;\n    child;\n    child = child.previousElementSibling\n  ) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds all child elements that satisfy the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {!Array<!Element>}\n */\nexport function childElements(parent, callback) {\n  const children = [];\n  for (\n    let child = parent.firstElementChild;\n    child;\n    child = child.nextElementSibling\n  ) {\n    if (callback(child)) {\n      children.push(child);\n    }\n  }\n  return children;\n}\n\n/**\n * Finds all child nodes that satisfy the callback.\n * These nodes can include Text, Comment and other child nodes.\n * @param {!Node} parent\n * @param {function(!Node):boolean} callback\n * @return {!Array<!Node>}\n */\nexport function childNodes(parent, callback) {\n  const nodes = [];\n  for (let child = parent.firstChild; child; child = child.nextSibling) {\n    if (callback(child)) {\n      nodes.push(child);\n    }\n  }\n  return nodes;\n}\n\n/**\n * Finds the first child element that has the specified attribute.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} attr\n * @return {?Element}\n */\nexport function childElementByAttr(parent, attr) {\n  assertIsName(attr);\n  return /*OK*/ scopedQuerySelector(parent, `> [${attr}]`);\n}\n\n/**\n * Finds the last child element that has the specified attribute.\n * @param {!Element} parent\n * @param {string} attr\n * @return {?Element}\n */\nexport function lastChildElementByAttr(parent, attr) {\n  assertIsName(attr);\n  return lastChildElement(parent, (el) => {\n    return el.hasAttribute(attr);\n  });\n}\n\n/**\n * Finds all child elements that has the specified attribute.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} attr\n * @return {!NodeList<!Element>}\n */\nexport function childElementsByAttr(parent, attr) {\n  assertIsName(attr);\n  return /*OK*/ scopedQuerySelectorAll(parent, `> [${attr}]`);\n}\n\n/**\n * Finds the first child element that has the specified tag name.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} tagName\n * @return {?Element}\n */\nexport function childElementByTag(parent, tagName) {\n  assertIsName(tagName);\n  return /*OK*/ scopedQuerySelector(parent, `> ${tagName}`);\n}\n\n/**\n * Finds all child elements with the specified tag name.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} tagName\n * @return {!NodeList<!Element>}\n */\nexport function childElementsByTag(parent, tagName) {\n  assertIsName(tagName);\n  return /*OK*/ scopedQuerySelectorAll(parent, `> ${tagName}`);\n}\n\n/**\n * Finds the first descendant element with the specified name.\n * @param {!Element|!Document|!ShadowRoot} element\n * @param {string} tagName\n * @return {?Element}\n */\nexport function elementByTag(element, tagName) {\n  assertIsName(tagName);\n  return element./*OK*/ querySelector(tagName);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {dev, devAssert} from './log';\nimport {dict} from './core/types/object';\nimport {includes} from './core/types/string';\nimport {matches} from './core/dom/query';\nimport {toWin} from './core/window';\n\nconst HTML_ESCAPE_CHARS = {\n  '&': '&amp;',\n  '<': '&lt;',\n  '>': '&gt;',\n  '\"': '&quot;',\n  \"'\": '&#x27;',\n  '`': '&#x60;',\n};\nconst HTML_ESCAPE_REGEX = /(&|<|>|\"|'|`)/g;\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_PROMISE = '__AMP_UPG_PRM';\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_RESOLVER = '__AMP_UPG_RES';\n\n/**\n * @typedef {{\n *   bubbles: (boolean|undefined),\n *   cancelable: (boolean|undefined),\n * }}\n */\nexport let CustomEventOptionsDef;\n\n/** @const {!CustomEventOptionsDef} */\nconst DEFAULT_CUSTOM_EVENT_OPTIONS = {bubbles: true, cancelable: true};\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * callback is executed.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @param {function()} callback\n * @suppress {suspiciousCode}\n */\nexport function waitForChild(parent, checkFunc, callback) {\n  if (checkFunc(parent)) {\n    callback();\n    return;\n  }\n  /** @const {!Window} */\n  const win = toWin(parent.ownerDocument.defaultView);\n  if (IS_ESM || win.MutationObserver) {\n    /** @const {MutationObserver} */\n    const observer = new win.MutationObserver(() => {\n      if (checkFunc(parent)) {\n        observer.disconnect();\n        callback();\n      }\n    });\n    observer.observe(parent, {childList: true});\n  } else {\n    /** @const {number} */\n    const interval = win.setInterval(() => {\n      if (checkFunc(parent)) {\n        win.clearInterval(interval);\n        callback();\n      }\n    }, /* milliseconds */ 5);\n  }\n}\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * promise is resolved.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @return {!Promise}\n */\nexport function waitForChildPromise(parent, checkFunc) {\n  return new Promise((resolve) => {\n    waitForChild(parent, checkFunc, resolve);\n  });\n}\n\n/**\n * Waits for document's body to be available and ready.\n * @param {!Document} doc\n * @param {function()} callback\n */\nexport function waitForBodyOpen(doc, callback) {\n  waitForChild(doc.documentElement, () => !!doc.body, callback);\n}\n\n/**\n * Waits for document's body to be available.\n * @param {!Document} doc\n * @return {!Promise}\n */\nexport function waitForBodyOpenPromise(doc) {\n  return new Promise((resolve) => waitForBodyOpen(doc, resolve));\n}\n\n/**\n * Removes the element.\n * @param {!Element} element\n */\nexport function removeElement(element) {\n  if (element.parentElement) {\n    element.parentElement.removeChild(element);\n  }\n}\n\n/**\n * Removes all child nodes of the specified element.\n * @param {!Element|!DocumentFragment} parent\n */\nexport function removeChildren(parent) {\n  while (parent.firstChild) {\n    parent.removeChild(parent.firstChild);\n  }\n}\n\n/**\n * Copies all children nodes of element \"from\" to element \"to\". Child nodes\n * are deeply cloned. Notice, that this method should be used with care and\n * preferably on smaller subtrees.\n * @param {!Element} from\n * @param {!Element|!DocumentFragment} to\n */\nexport function copyChildren(from, to) {\n  const frag = to.ownerDocument.createDocumentFragment();\n  for (let n = from.firstChild; n; n = n.nextSibling) {\n    frag.appendChild(n.cloneNode(true));\n  }\n  to.appendChild(frag);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n * @param {?Node=} after\n */\nexport function insertAfterOrAtStart(root, element, after = null) {\n  if (!after) {\n    insertAtStart(root, element);\n    return;\n  }\n  const before = after.nextSibling;\n  root.insertBefore(element, before);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n */\nexport function insertAtStart(root, element) {\n  root.insertBefore(element, root.firstChild);\n}\n\n/**\n * Add attributes to an element.\n * @param {!Element} element\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function addAttributesToElement(element, attributes) {\n  for (const attr in attributes) {\n    element.setAttribute(attr, attributes[attr]);\n  }\n  return element;\n}\n\n/**\n * Create a new element on document with specified tagName and attributes.\n * @param {!Document} doc\n * @param {string} tagName\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function createElementWithAttributes(doc, tagName, attributes) {\n  const element = doc.createElement(tagName);\n  return addAttributesToElement(element, attributes);\n}\n\n/**\n * Returns true if node is connected (attached).\n * @param {!Node} node\n * @return {boolean}\n * @see https://dom.spec.whatwg.org/#connected\n */\nexport function isConnectedNode(node) {\n  const connected = node.isConnected;\n  if (connected !== undefined) {\n    return connected;\n  }\n\n  // \"An element is connected if its shadow-including root is a document.\"\n  let n = node;\n  do {\n    n = rootNodeFor(n);\n    if (n.host) {\n      n = n.host;\n    } else {\n      break;\n    }\n  } while (true);\n  return n.nodeType === Node.DOCUMENT_NODE;\n}\n\n/**\n * Returns the root for a given node. Does not cross shadow DOM boundary.\n * @param {!Node} node\n * @return {!Node}\n */\nexport function rootNodeFor(node) {\n  if (Node.prototype.getRootNode) {\n    // Type checker says `getRootNode` may return null.\n    return node.getRootNode() || node;\n  }\n  let n;\n  // Check isShadowRoot() is only needed for the polyfill case.\n  for (\n    n = node;\n    !!n.parentNode && !isShadowRoot(/** @type {HTMLElement} */ (n));\n    n = n.parentNode\n  ) {}\n  return n;\n}\n\n/**\n * Determines if value is actually a `ShadowRoot` node.\n * @param {HTMLElement} value\n * @return {boolean}\n */\nexport function isShadowRoot(value) {\n  if (!value) {\n    return false;\n  }\n  // Node.nodeType == DOCUMENT_FRAGMENT to speed up the tests. Unfortunately,\n  // nodeType of DOCUMENT_FRAGMENT is used currently for ShadowRoot nodes.\n  if (value.tagName == 'I-AMPHTML-SHADOW-ROOT') {\n    return true;\n  }\n  return (\n    value.nodeType == /* DOCUMENT_FRAGMENT */ 11 &&\n    Object.prototype.toString.call(value) === '[object ShadowRoot]'\n  );\n}\n\n/**\n * Returns element data-param- attributes as url parameters key-value pairs.\n * e.g. data-param-some-attr=value -> {someAttr: value}.\n * @param {!HTMLElement} element\n * @param {function(string):string=} opt_computeParamNameFunc to compute the\n *    parameter name, get passed the camel-case parameter name.\n * @param {!RegExp=} opt_paramPattern Regex pattern to match data attributes.\n * @return {!JsonObject}\n */\nexport function getDataParamsFromAttributes(\n  element,\n  opt_computeParamNameFunc,\n  opt_paramPattern\n) {\n  const computeParamNameFunc = opt_computeParamNameFunc || ((key) => key);\n  const {dataset} = element;\n  const params = dict();\n  const paramPattern = opt_paramPattern ? opt_paramPattern : /^param(.+)/;\n  for (const key in dataset) {\n    const matches = key.match(paramPattern);\n    if (matches) {\n      const param = matches[1][0].toLowerCase() + matches[1].substr(1);\n      params[computeParamNameFunc(param)] = dataset[key];\n    }\n  }\n  return params;\n}\n\n/**\n * Whether the element have a next node in the document order.\n * This means either:\n *  a. The element itself has a nextSibling.\n *  b. Any of the element ancestors has a nextSibling.\n * @param {!Element} element\n * @param {?Node} opt_stopNode\n * @return {boolean}\n */\nexport function hasNextNodeInDocumentOrder(element, opt_stopNode) {\n  let currentElement = element;\n  do {\n    if (currentElement.nextSibling) {\n      return true;\n    }\n  } while (\n    (currentElement = currentElement.parentNode) &&\n    currentElement != opt_stopNode\n  );\n  return false;\n}\n\n/**\n * Returns a clone of the content of a template element.\n *\n * Polyfill to replace .content access for browsers that do not support\n * HTMLTemplateElements natively.\n *\n * @param {!HTMLTemplateElement|!Element} template\n * @return {!DocumentFragment}\n */\nexport function templateContentClone(template) {\n  if ('content' in template) {\n    return template.content.cloneNode(true);\n  } else {\n    const content = template.ownerDocument.createDocumentFragment();\n    copyChildren(template, content);\n    return content;\n  }\n}\n\n/**\n * Iterate over an array-like.\n * Test cases: https://jsbench.github.io/#f638cacc866a1b2d6e517e6cfa900d6b\n * @param {!IArrayLike<T>} iterable\n * @param {function(T, number)} cb\n * @template T\n */\nexport function iterateCursor(iterable, cb) {\n  const {length} = iterable;\n  for (let i = 0; i < length; i++) {\n    cb(iterable[i], i);\n  }\n}\n\n/**\n * This method wraps around window's open method. It first tries to execute\n * `open` call with the provided target and if it fails, it retries the call\n * with the `_top` target. This is necessary given that in some embedding\n * scenarios, such as iOS' WKWebView, navigation to `_blank` and other targets\n * is blocked by default.\n *\n * @param {!Window} win\n * @param {string} url\n * @param {string} target\n * @param {string=} opt_features\n * @return {?Window}\n */\nexport function openWindowDialog(win, url, target, opt_features) {\n  // Try first with the specified target. If we're inside the WKWebView or\n  // a similar environments, this method is expected to fail by default for\n  // all targets except `_top`.\n  let res;\n  try {\n    res = win.open(url, target, opt_features);\n  } catch (e) {\n    dev().error('DOM', 'Failed to open url on target: ', target, e);\n  }\n\n  // Then try with `_top` target.\n  if (!res && target != '_top' && !includes(opt_features || '', 'noopener')) {\n    res = win.open(url, '_top');\n  }\n  return res;\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.hasAttribute('type') &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/JSON'\n  );\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonLdScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/LD+JSON'\n  );\n}\n\n/**\n * Whether the page's direction is right to left or not.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isRTL(doc) {\n  const dir =\n    doc.body.getAttribute('dir') ||\n    doc.documentElement.getAttribute('dir') ||\n    'ltr';\n  return dir == 'rtl';\n}\n\n/**\n * Escapes `<`, `>` and other HTML charcaters with their escaped forms.\n * @param {string} text\n * @return {string}\n */\nexport function escapeHtml(text) {\n  if (!text) {\n    return text;\n  }\n  return text.replace(HTML_ESCAPE_REGEX, escapeHtmlChar);\n}\n\n/**\n * @param {string} c\n * @return {string}\n */\nfunction escapeHtmlChar(c) {\n  return HTML_ESCAPE_CHARS[c];\n}\n\n/**\n * Tries to focus on the given element; fails silently if browser throws an\n * exception.\n * @param {!Element} element\n */\nexport function tryFocus(element) {\n  try {\n    element./*OK*/ focus();\n  } catch (e) {\n    // IE <= 7 may throw exceptions when focusing on hidden items.\n  }\n}\n\n/**\n * Whether the given window is in an iframe or not.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isIframed(win) {\n  return win.parent && win.parent != win;\n}\n\n/**\n * Determines if this element is an AMP element\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isAmpElement(element) {\n  const tag = element.tagName;\n  // Use prefix to recognize AMP element. This is necessary because stub\n  // may not be attached yet.\n  return (\n    tag.startsWith('AMP-') &&\n    // Some \"amp-*\" elements are not really AMP elements. :smh:\n    !(tag == 'AMP-STICKY-AD-TOP-PADDING' || tag == 'AMP-BODY')\n  );\n}\n\n/**\n * Return a promise that resolve when an AMP element upgrade from HTMLElement\n * to CustomElement\n * @param {!HTMLElement} element\n * @return {!Promise<!AmpElement>}\n */\nexport function whenUpgradedToCustomElement(element) {\n  devAssert(isAmpElement(element), 'element is not AmpElement');\n  if (element.createdCallback) {\n    // Element already is CustomElement;\n    return Promise.resolve(/**@type {!AmpElement} */ (element));\n  }\n  // If Element is still HTMLElement, wait for it to upgrade to customElement\n  // Note: use pure string to avoid obfuscation between versions.\n  if (!element[UPGRADE_TO_CUSTOMELEMENT_PROMISE]) {\n    const deferred = new Deferred();\n    element[UPGRADE_TO_CUSTOMELEMENT_PROMISE] = deferred.promise;\n    element[UPGRADE_TO_CUSTOMELEMENT_RESOLVER] = deferred.resolve;\n  }\n\n  return element[UPGRADE_TO_CUSTOMELEMENT_PROMISE];\n}\n\n/**\n * Returns true if node is not disabled.\n *\n * IE8 can return false positives, see {@link matches}.\n * @param {!HTMLInputElement} element\n * @return {boolean}\n * @see https://www.w3.org/TR/html5/forms.html#concept-fe-disabled\n */\nexport function isEnabled(element) {\n  return !(element.disabled || matches(element, ':disabled'));\n}\n\n/**\n * A sorting comparator that sorts elements in DOM tree order.\n * A first sibling is sorted to be before its nextSibling.\n * A parent node is sorted to be before a child.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/compareDocumentPosition\n *\n * @param {!Element} element1\n * @param {!Element} element2\n * @return {number}\n */\nexport function domOrderComparator(element1, element2) {\n  if (element1 === element2) {\n    return 0;\n  }\n\n  const pos = element1.compareDocumentPosition(element2);\n  const precedingOrContains =\n    Node.DOCUMENT_POSITION_PRECEDING | Node.DOCUMENT_POSITION_CONTAINS;\n\n  // if fe2 is preceding or contains fe1 then, fe1 is after fe2\n  if (pos & precedingOrContains) {\n    return 1;\n  }\n\n  // if fe2 is following or contained by fe1, then fe1 is before fe2\n  return -1;\n}\n\n/**\n * Like `Element.prototype.toggleAttribute`. This either toggles an attribute\n * on by adding an attribute with an empty value, or toggles it off by removing\n * the attribute. This does not mutate the element if the new state matches\n * the existing state.\n * @param {!Element} element An element to toggle the attribute for.\n * @param {string} name The name of the attribute.\n * @param {boolean=} forced Whether the attribute should be forced on/off. If\n *    not specified, it will be toggled from the current state.\n * @return {boolean} Whether or not the element now has the attribute.\n */\nexport function toggleAttribute(element, name, forced) {\n  const hasAttribute = element.hasAttribute(name);\n  const enabled = forced !== undefined ? forced : !hasAttribute;\n\n  if (enabled !== hasAttribute) {\n    if (enabled) {\n      element.setAttribute(name, '');\n    } else {\n      element.removeAttribute(name);\n    }\n  }\n\n  return enabled;\n}\n\n/**\n * Parses a string as a boolean value using the expanded rules for DOM boolean\n * attributes:\n * - a `null` or `undefined` returns `null`;\n * - an empty string returns `true`;\n * - a \"false\" string returns `false`;\n * - otherwise, `true` is returned.\n *\n * @param {?string|undefined} s\n * @return {boolean|undefined}\n */\nexport function parseBooleanAttribute(s) {\n  return s == null ? undefined : s !== 'false';\n}\n\n/**\n * @param {!Window} win\n * @return {number} The width of the vertical scrollbar, in pixels.\n */\nexport function getVerticalScrollbarWidth(win) {\n  const {documentElement} = win.document;\n  const windowWidth = win./*OK*/ innerWidth;\n  const documentWidth = documentElement./*OK*/ clientWidth;\n  return windowWidth - documentWidth;\n}\n\n/**\n * Dispatches a custom event.\n *\n * @param {!Node} node\n * @param {string} name\n * @param {!Object=} opt_data Event data.\n * @param {!CustomEventOptionsDef=} opt_options\n */\nexport function dispatchCustomEvent(node, name, opt_data, opt_options) {\n  const data = opt_data || {};\n  // Constructors of events need to come from the correct window. Sigh.\n  const event = node.ownerDocument.createEvent('Event');\n\n  // Technically .data is not a property of Event.\n  /**@type {?}*/ (event).data = data;\n\n  const {bubbles, cancelable} = opt_options || DEFAULT_CUSTOM_EVENT_OPTIONS;\n  event.initEvent(name, bubbles, cancelable);\n  node.dispatchEvent(event);\n}\n\n/**\n * Ensures the child is contained by the parent, but not the parent itself.\n *\n * @param {!Node} parent\n * @param {!Node} child\n * @return {boolean}\n */\nexport function containsNotSelf(parent, child) {\n  return child !== parent && parent.contains(child);\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview This is a layer that allows a call to action in a story page.\n * With this, a user could link to an external site from inside a story using\n * the call to action layer, for example.\n *\n * Example:\n * ...\n * <amp-story-page>\n *   <amp-story-cta-layer>\n *     <a href=\"wwww.google.com\"> Visit my site! </a>\n *   </amp-story-cta-layer>\n * <amp-story-page>\n * ...\n */\n\nimport {AmpStoryBaseLayer} from './amp-story-base-layer';\nimport {addAttributesToElement, removeElement} from '../../../src/dom';\nimport {dict} from '../../../src/core/types/object';\nimport {matches} from '../../../src/core/dom/query';\nimport {user} from '../../../src/log';\n\n/**\n * @type {string}\n * @const\n */\nconst TAG = 'amp-story-cta-layer';\n\n/**\n * Call to action button layer template.\n *\n * No pre-rendering to let more computing-intensive elements (like\n * videos) get pre-rendered first. Since this layer will not contain\n * computing-intensive resources such as videos, we can just risk rendering\n * while the user is looking.\n */\nexport class AmpStoryCtaLayer extends AmpStoryBaseLayer {\n  /** @override */\n  buildCallback() {\n    super.buildCallback();\n    this.setOrOverwriteAttributes_();\n    this.checkAndRemoveLayerIfOnFirstPage_();\n  }\n\n  /**\n   * Overwrite or set target attributes that are cta-layer-specific.\n   * @private\n   */\n  setOrOverwriteAttributes_() {\n    const ctaLinks = this.element.querySelectorAll('a');\n    for (let i = 0; i < ctaLinks.length; i++) {\n      addAttributesToElement(ctaLinks[i], dict({'target': '_blank'}));\n\n      if (!ctaLinks[i].getAttribute('role')) {\n        addAttributesToElement(ctaLinks[i], dict({'role': 'link'}));\n      }\n    }\n\n    const ctaButtons = this.element.querySelectorAll('button');\n    for (let i = 0; i < ctaButtons.length; i++) {\n      if (!ctaButtons[i].getAttribute('role')) {\n        addAttributesToElement(ctaButtons[i], dict({'role': 'button'}));\n      }\n    }\n  }\n\n  /**\n   * CTA links or buttons are not allowed on the first amp-story page. Remove\n   * the amp-story-cta-layer if it is found on the first page of the story.\n   * @private\n   */\n  checkAndRemoveLayerIfOnFirstPage_() {\n    if (\n      matches(\n        this.element,\n        'amp-story-page:first-of-type > amp-story-cta-layer'\n      )\n    ) {\n      removeElement(this.element);\n      user().error(\n        TAG,\n        'amp-story-cta-layer is not allowed on the first page' +\n          ' of an amp-story.'\n      );\n    }\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {isEnumValue} from '../../../src/core/types';\nimport {parseQueryString} from '../../../src/core/types/string/url';\n\n/**\n * Embed mode for AMP story.  See ../embed-modes.md for details.\n * @enum {number}\n */\nexport const EmbedMode = {\n  /**\n   * Default mode.\n   */\n  NOT_EMBEDDED: 0,\n\n  /**\n   * TBD embed mode.\n   *\n   * This differs from the NOT_EMBEDDED embed mode in the following ways:\n   * - Hides all system layer buttons\n   * - Disables swipe-based user education\n   * - Disallows ads\n   * - Unmutes audio in the story by default\n   */\n  NAME_TBD: 1,\n\n  /**\n   * This mode is intended for embedders that natively handle sharing the story,\n   * thereby rendering the sharing functionality within the amp-story extension\n   * redundant.\n   *\n   * This differs from the NOT_EMBEDDED embed mode in the following ways:\n   * - Removes share icon from system layer\n   * - TODO(#14923): Removes the link information from embedded UIs.\n   */\n  NO_SHARING: 2,\n\n  /**\n   * This mode is intended for a preview of the story.\n   *\n   * This differs from the NOT_EMBEDDED embed mode in the following ways:\n   * - Auto-advances pages by a given duration.\n   * - Hides all system layer buttons\n   * - Disables swipe-based user education\n   * - Disallows ads\n   */\n  PREVIEW: 3,\n\n  /**\n   * This mode is intended for embedders that natively handle the audio and\n   * sharing experiences, through native controls and viewer communication.\n   *\n   * This differs from the NOT_EMBEDDED embed mode in the following ways:\n   * - Removes share icon from system layer\n   * - Removes audio icon from system layer\n   */\n  NO_SHARING_NOR_AUDIO_UI: 4,\n};\n\n/**\n * Parameter to retrieve the embed mode from the location hash.\n * @type {string}\n */\nexport const EmbedModeParam = 'embedMode';\n\n/**\n * @param {string} str\n * @return {!EmbedMode}\n * @package\n */\nexport function parseEmbedMode(str) {\n  const params = parseQueryString(str);\n  const unsanitizedEmbedMode = params[EmbedModeParam];\n  const embedModeIndex = parseInt(unsanitizedEmbedMode, 10);\n\n  return isEnumValue(EmbedMode, embedModeIndex)\n    ? /** @type {!EmbedMode} */ (embedModeIndex)\n    : EmbedMode.NOT_EMBEDDED;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {removeItem} from '../types/array';\n\n/**\n * This class helps to manage observers. Observers can be added, removed or\n * fired through and instance of this class.\n * @template TYPE\n */\nexport class Observable {\n  /**\n   * Creates an instance of Observable.\n   */\n  constructor() {\n    /** @type {?Array<function(TYPE)>} */\n    this.handlers_ = null;\n  }\n\n  /**\n   * Adds the observer to this instance.\n   * @param {function(TYPE)} handler Observer's handler.\n   * @return {!UnlistenDef}\n   */\n  add(handler) {\n    if (!this.handlers_) {\n      this.handlers_ = [];\n    }\n    this.handlers_.push(handler);\n    return () => {\n      this.remove(handler);\n    };\n  }\n\n  /**\n   * Removes the observer from this instance.\n   * @param {function(TYPE)} handler Observer's instance.\n   */\n  remove(handler) {\n    if (!this.handlers_) {\n      return;\n    }\n    removeItem(this.handlers_, handler);\n  }\n\n  /**\n   * Removes all observers.\n   */\n  removeAll() {\n    if (!this.handlers_) {\n      return;\n    }\n    this.handlers_.length = 0;\n  }\n\n  /**\n   * Fires an event. All observers are called.\n   * @param {TYPE=} opt_event\n   */\n  fire(opt_event) {\n    if (!this.handlers_) {\n      return;\n    }\n    for (const handler of this.handlers_) {\n      handler(opt_event);\n    }\n  }\n\n  /**\n   * Returns number of handlers. Mostly needed for tests.\n   * @return {number}\n   */\n  getHandlerCount() {\n    return this.handlers_?.length ?? 0;\n  }\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from '../mode';\nimport {urls} from '../config';\n\nconst CUSTOM_TEMPLATES = ['amp-mustache'];\nconst LATEST_VERSION = 'latest';\n\n/**\n * Calculate the base url for any scripts.\n * @param {!Location} location The window's location\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateScriptBaseUrl(location, opt_isLocalDev) {\n  if (opt_isLocalDev) {\n    let prefix = `${location.protocol}//${location.host}`;\n    if (\n      location.protocol == 'about:' ||\n      location.protocol == 'blob:' ||\n      location.protocol == 'data:'\n    ) {\n      prefix = '';\n    }\n    return `${prefix}/dist`;\n  }\n  return urls.cdn;\n}\n\n/**\n * Calculate script url for an extension.\n * @param {!Location} location The window's location\n * @param {string} extensionId\n * @param {string} version\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateExtensionScriptUrl(\n  location,\n  extensionId,\n  version,\n  opt_isLocalDev\n) {\n  const fileExtension = getMode().esm ? '.mjs' : '.js';\n  const base = calculateScriptBaseUrl(location, opt_isLocalDev);\n  const rtv = getMode().rtvVersion;\n  const extensionVersion = version ? '-' + version : '';\n  return `${base}/rtv/${rtv}/v0/${extensionId}${extensionVersion}${fileExtension}`;\n}\n\n/**\n * Calculate script url for an entry point.\n * If `opt_rtv` is true, returns the URL matching the current RTV.\n * @param {!Location} location The window's location\n * @param {string} entryPoint\n * @param {boolean=} isLocalDev\n * @param {boolean=} opt_rtv\n * @return {string}\n */\nexport function calculateEntryPointScriptUrl(\n  location,\n  entryPoint,\n  isLocalDev,\n  opt_rtv\n) {\n  const fileExtension = getMode().esm ? '.mjs' : '.js';\n  const base = calculateScriptBaseUrl(location, isLocalDev);\n  if (isLocalDev) {\n    return `${base}/${entryPoint}${fileExtension}`;\n  }\n  if (opt_rtv) {\n    return `${base}/rtv/${getMode().rtvVersion}/${entryPoint}${fileExtension}`;\n  }\n  return `${base}/${entryPoint}${fileExtension}`;\n}\n\n/**\n * Parse the extension version from a given script URL.\n * @param {string} scriptUrl\n * @return {?{extensionId: string, extensionVersion: string}}\n */\nexport function parseExtensionUrl(scriptUrl) {\n  if (!scriptUrl) {\n    return null;\n  }\n  // Note that the \"(\\.max)?\" group only applies to local dev.\n  const matches = scriptUrl.match(\n    /^(.*)\\/(.*)-([0-9.]+|latest)(\\.max)?\\.(?:js|mjs)$/i\n  );\n  const extensionId = matches ? matches[2] : undefined;\n  const extensionVersion = matches ? matches[3] : undefined;\n  if (!extensionId || !extensionVersion) {\n    return null;\n  }\n  return {extensionId, extensionVersion};\n}\n\n/**\n * Create the missing amp extension HTML script element.\n * @param {!Window} win\n * @param {string} extensionId\n * @param {string} version\n * @return {!Element} Script object\n */\nexport function createExtensionScript(win, extensionId, version) {\n  const scriptElement = win.document.createElement('script');\n  scriptElement.async = true;\n  if (isIntermediateExtension(extensionId)) {\n    version = '';\n  } else {\n    scriptElement.setAttribute(\n      CUSTOM_TEMPLATES.indexOf(extensionId) >= 0\n        ? 'custom-template'\n        : 'custom-element',\n      extensionId\n    );\n  }\n  scriptElement.setAttribute('data-script', extensionId);\n  scriptElement.setAttribute('i-amphtml-inserted', '');\n  if (getMode().esm) {\n    scriptElement.setAttribute('type', 'module');\n  }\n\n  // Propagate nonce to all generated script tags.\n  const currentScript = win.document.head.querySelector('script[nonce]');\n  if (currentScript) {\n    scriptElement.setAttribute('nonce', currentScript.getAttribute('nonce'));\n  }\n\n  // Allow error information to be collected\n  // https://github.com/ampproject/amphtml/issues/7353\n  scriptElement.setAttribute('crossorigin', 'anonymous');\n  let loc = win.location;\n  if (getMode(win).test && win.testLocation) {\n    loc = win.testLocation;\n  }\n  const scriptSrc = calculateExtensionScriptUrl(\n    loc,\n    extensionId,\n    version,\n    getMode(win).localDev\n  );\n  scriptElement.src = scriptSrc;\n  return scriptElement;\n}\n\n/**\n * Returns the extension <script> element and attribute for the given\n * extension ID, if it exists. Otherwise, returns null.\n * @param {!Window} win\n * @param {string} extensionId\n * @param {string} version\n * @param {boolean} latest\n * @param {boolean=} includeInserted If true, includes script elements that\n *   are inserted by the runtime dynamically. Default is true.\n * @return {!Array<!Element>}\n */\nexport function getExtensionScripts(\n  win,\n  extensionId,\n  version,\n  latest,\n  includeInserted = true\n) {\n  // Always ignore <script> elements that have a mismatched RTV.\n  const modifier =\n    ':not([i-amphtml-loaded-new-version])' +\n    (includeInserted ? '' : ':not([i-amphtml-inserted])');\n  // We have to match against \"src\" because a few extensions, such as\n  // \"amp-viewer-integration\", do not have \"custom-element\" attribute.\n  const matches = win.document.head./*OK*/ querySelectorAll(\n    `script[src*=\"/${extensionId}-\"]${modifier}`\n  );\n  const filtered = [];\n  for (let i = 0; i < matches.length; i++) {\n    const match = matches[i];\n    const urlParts = parseExtensionUrl(match.src);\n    if (!urlParts) {\n      continue;\n    }\n    const {\n      extensionId: scriptExtensionId,\n      extensionVersion: scriptExtensionVersion,\n    } = urlParts;\n    if (\n      scriptExtensionId == extensionId &&\n      (isIntermediateExtension(extensionId) ||\n        scriptExtensionVersion == version ||\n        (scriptExtensionVersion == LATEST_VERSION && latest))\n    ) {\n      filtered.push(match);\n    }\n  }\n  return filtered;\n}\n\n/**\n * Get list of all the extension JS files.\n * @param {HTMLHeadElement|Element|ShadowRoot|Document} head\n * @return {!Array<{extensionId: string, extensionVersion: string}>}\n */\nexport function extensionScriptsInNode(head) {\n  // ampdoc.getHeadNode() can return null.\n  if (!head) {\n    return [];\n  }\n  // Note: Some extensions don't have [custom-element] or [custom-template]\n  // e.g. amp-viewer-integration.\n  const list = head.querySelectorAll(\n    'script[custom-element],script[custom-template]'\n  );\n  const scripts = [];\n  for (let i = 0; i < list.length; i++) {\n    const script = list[i];\n    const extensionId =\n      script.getAttribute('custom-element') ||\n      script.getAttribute('custom-template');\n    const urlParts = parseExtensionUrl(script.src);\n    if (extensionId && urlParts) {\n      scripts.push({extensionId, extensionVersion: urlParts.extensionVersion});\n    }\n  }\n  return scripts;\n}\n\n/**\n * Verifies that an extension script is present in head for\n * installation.\n * @param {!Window} win\n * @param {string} id\n * @param {string} version\n * @return {boolean}\n */\nexport function extensionScriptInNode(win, id, version) {\n  return extensionScriptsInNode(win.document.head).some(\n    ({extensionId, extensionVersion}) =>\n      id == extensionId && version == extensionVersion\n  );\n}\n\n/**\n * @param {string} extensionId\n * @return {boolean}\n */\nfunction isIntermediateExtension(extensionId) {\n  return extensionId.startsWith('_');\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dom from './dom';\nimport {extensionScriptInNode} from './service/extension-script';\nimport {\n  getAmpdoc,\n  getService,\n  getServiceForDocOrNull,\n  getServicePromise,\n  getServicePromiseForDoc,\n  getServicePromiseOrNull,\n  getServicePromiseOrNullForDoc,\n} from './service';\nimport {userAssert} from './log';\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {string} version The extension version.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailable(\n  win,\n  id,\n  extension,\n  version,\n  opt_element\n) {\n  const s = getServicePromiseOrNull(win, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  return getElementServicePromiseOrNull(\n    win,\n    id,\n    extension,\n    version,\n    opt_element\n  );\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. Services.viewportForDoc(...)) for type safety and because the\n * factory should not be passed around.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an element,\n *     not the extension.\n * @return {!Promise<*>}\n */\nexport function getElementServiceForDoc(element, id, extension, opt_element) {\n  return getElementServiceIfAvailableForDoc(\n    element,\n    id,\n    extension,\n    opt_element\n  ).then((service) => assertService(service, id, extension));\n}\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDoc(\n  element,\n  id,\n  extension,\n  opt_element\n) {\n  const s = getServicePromiseOrNullForDoc(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  const ampdoc = getAmpdoc(element);\n  return ampdoc\n    .whenExtensionsKnown()\n    .then(() => {\n      const version = ampdoc.getExtensionVersion(extension);\n      if (!version) {\n        return null;\n      }\n      const extensions = getService(ampdoc.win, 'extensions');\n      return extensions.waitForExtension(extension, version);\n    })\n    .then((ext) => {\n      if (!ext) {\n        return null;\n      }\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNullForDoc(element, id);\n      }\n      return getServicePromiseForDoc(element, id);\n    });\n}\n\n/**\n * Returns a promise for service for the given id in the embed scope of\n * a given element, if it exists. Falls back to ampdoc scope if the element\n * is not embedded.\n *\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDocInEmbedScope(\n  element,\n  id,\n  extension\n) {\n  const s = getServiceForDocOrNull(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (Promise.resolve(s));\n  }\n  return getElementServiceIfAvailableForDoc(element, id, extension);\n}\n\n/**\n * Throws user error if `service` is null.\n * @param {Object} service\n * @param {string} id\n * @param {string} extension\n * @return {!Object}\n * @private\n * @closurePrimitive {asserts.matchesReturn}\n */\nfunction assertService(service, id, extension) {\n  return /** @type {!Object} */ (\n    userAssert(\n      service,\n      'Service %s was requested to be provided through %s, ' +\n        'but %s is not loaded in the current page. To fix this ' +\n        'problem load the JavaScript file for %s in this page.',\n      id,\n      extension,\n      extension,\n      extension\n    )\n  );\n}\n\n/**\n * Returns the promise for service with `id` on the given window if available.\n * Otherwise, resolves with null (service was not registered).\n * @param {!Window} win\n * @param {string} id\n * @param {string} extension\n * @param {string} version\n * @param {boolean=} opt_element\n * @return {!Promise<Object>}\n * @private\n */\nfunction getElementServicePromiseOrNull(\n  win,\n  id,\n  extension,\n  version,\n  opt_element\n) {\n  return dom\n    .waitForBodyOpenPromise(win.document)\n    .then(() => {\n      // If there is an extension script wait for it to load before trying\n      // to get the service. Prevents a race condition when everything but\n      // the extensions is in cache. If there is no script then it's either\n      // not present, or the service was defined by a test. In those cases\n      // we don't wait around for an extension that does not exist.\n      const extensions = getService(win, 'extensions');\n\n      // TODO(jpettitt) investigate registerExtension to short circuit\n      // the dom call in extensionScriptsInNode()\n      if (!extensionScriptInNode(extensions.win, extension, version)) {\n        return null;\n      }\n      return extensions.waitForExtension(extension, version);\n    })\n    .then((ext) => {\n      if (!ext) {\n        return null;\n      }\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNull(win, id);\n      }\n      return getServicePromise(win, id);\n    });\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  getAmpdoc,\n  getExistingServiceOrNull,\n  getService,\n  getServiceForDoc,\n  getServiceForDocOrNull,\n  getServiceInEmbedWin,\n  getServicePromiseForDoc,\n} from './service';\nimport {\n  getElementServiceForDoc,\n  getElementServiceIfAvailable,\n  getElementServiceIfAvailableForDoc,\n  getElementServiceIfAvailableForDocInEmbedScope,\n} from './element-service';\n\n/** @typedef {!../extensions/amp-subscriptions/0.1/amp-subscriptions.SubscriptionService} */\nexport let SubscriptionService;\n\nexport class Services {\n  /**\n   * Hint: Add extensions folder path to compile.js with\n   * warnings cannot find modules.\n   */\n\n  /**\n   * Returns a promise for the Access service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>} */ (\n      getElementServiceForDoc(element, 'access', 'amp-access')\n    );\n  }\n\n  /**\n   * Returns a promise for the Access service or a promise for null if the\n   * service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>} */ (\n      getElementServiceIfAvailableForDoc(element, 'access', 'amp-access')\n    );\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!SubscriptionService>}\n   */\n  static subscriptionsServiceForDoc(element) {\n    return /** @type {!Promise<!SubscriptionService>} */ (\n      getElementServiceForDoc(element, 'subscriptions', 'amp-subscriptions')\n    );\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?SubscriptionService>}\n   */\n  static subscriptionsServiceForDocOrNull(element) {\n    return /** @type {!Promise<?SubscriptionService>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'subscriptions',\n        'amp-subscriptions'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/action-impl.ActionService}\n   */\n  static actionServiceForDoc(element) {\n    return /** @type {!./service/action-impl.ActionService} */ (\n      getServiceForDocOrNull(element, 'action')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/standard-actions-impl.StandardActions}\n   */\n  static standardActionsForDoc(element) {\n    return /** @type {!./service/standard-actions-impl.StandardActions} */ (\n      getServiceForDocOrNull(element, 'standard-actions')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>}\n   */\n  static activityForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>} */ (\n      getElementServiceForDoc(element, 'activity', 'amp-analytics')\n    );\n  }\n\n  /**\n   * Returns the global instance of the `AmpDocService` service that can be\n   * used to resolve an ampdoc for any node: either in the single-doc or\n   * shadow-doc environment.\n   * @param {!Window} window\n   * @return {!./service/ampdoc-impl.AmpDocService}\n   */\n  static ampdocServiceFor(window) {\n    return /** @type {!./service/ampdoc-impl.AmpDocService} */ (\n      getService(window, 'ampdoc')\n    );\n  }\n\n  /**\n   * Returns the AmpDoc for the specified context node.\n   * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrAmpDoc\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   */\n  static ampdoc(nodeOrAmpDoc) {\n    return getAmpdoc(nodeOrAmpDoc);\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @param {boolean=} loadAnalytics\n   * @return {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDoc(element, loadAnalytics = false) {\n    if (loadAnalytics) {\n      // Get Extensions service and force load analytics extension.\n      const ampdoc = getAmpdoc(element);\n      Services.extensionsFor(ampdoc.win)./*OK*/ installExtensionForDoc(\n        ampdoc,\n        'amp-analytics'\n      );\n    }\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (\n      getElementServiceForDoc(\n        element,\n        'amp-analytics-instrumentation',\n        'amp-analytics'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'amp-analytics-instrumentation',\n        'amp-analytics'\n      )\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/batched-xhr-impl.BatchedXhr}\n   */\n  static batchedXhrFor(window) {\n    return /** @type {!./service/batched-xhr-impl.BatchedXhr} */ (\n      getService(window, 'batched-xhr')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>}\n   */\n  static bindForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>} */ (\n      getElementServiceIfAvailableForDocInEmbedScope(\n        element,\n        'bind',\n        'amp-bind'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-script/0.1/amp-script.AmpScriptService>}\n   */\n  static scriptForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-script/0.1/amp-script.AmpScriptService>} */ (\n      getElementServiceIfAvailableForDocInEmbedScope(\n        element,\n        'amp-script',\n        'amp-script'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/cid-impl.CidDef>}\n   */\n  static cidForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/cid-impl.CidDef>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'cid')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/navigation.Navigation}\n   */\n  static navigationForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/navigation.Navigation} */ (\n      getServiceForDoc(elementOrAmpDoc, 'navigation')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>}\n   */\n  static loaderServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>} */ (\n      getElementServiceForDoc(element, 'loader', 'amp-loader')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>}\n   */\n  static standaloneServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>} */ (\n      getElementServiceForDoc(element, 'standalone', 'amp-standalone')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/crypto-impl.Crypto}\n   */\n  static cryptoFor(window) {\n    return /** @type {!./service/crypto-impl.Crypto} */ (\n      getService(window, 'crypto')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/document-info-impl.DocumentInfoDef} Info about the doc\n   */\n  static documentInfoForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/document-info-impl.DocInfo} */ (\n      getServiceForDoc(elementOrAmpDoc, 'documentInfo')\n    ).get();\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/extensions-impl.Extensions}\n   */\n  static extensionsFor(window) {\n    return /** @type {!./service/extensions-impl.Extensions} */ (\n      getService(window, 'extensions')\n    );\n  }\n\n  /**\n   * Returns a service to register callbacks we wish to execute when an\n   * amp-form is submitted.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>}\n   */\n  static formSubmitForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'form-submit-service')\n    );\n  }\n\n  /**\n   * Returns service to listen for `hidden` attribute mutations.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/hidden-observer-impl.HiddenObserver}\n   */\n  static hiddenObserverForDoc(element) {\n    return /** @type {!./service/hidden-observer-impl.HiddenObserver} */ (\n      getServiceForDocOrNull(element, 'hidden-observer')\n    );\n  }\n\n  /**\n   * Returns service implemented in service/history-impl.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/history-impl.History}\n   */\n  static historyForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/history-impl.History} */ (\n      getServiceForDoc(elementOrAmpDoc, 'history')\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {!./input.Input}\n   */\n  static inputFor(win) {\n    return getService(win, 'input');\n  }\n\n  /**s\n   * Returns a promise for the Inputmask service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>}\n   */\n  static inputmaskServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>} */ (\n      getElementServiceIfAvailableForDoc(element, 'inputmask', 'amp-inputmask')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {?./service/loading-indicator.LoadingIndicatorImpl}\n   */\n  static loadingIndicatorOrNull(elementOrAmpDoc) {\n    return /** @type {?./service/loading-indicator.LoadingIndicatorImpl} */ (\n      getServiceForDocOrNull(elementOrAmpDoc, 'loadingIndicator')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-next-page/1.0/service.NextPageService}\n   */\n  static nextPageServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-next-page/1.0/service.NextPageService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'next-page')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/mutator-interface.MutatorInterface}\n   */\n  static mutatorForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/mutator-interface.MutatorInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'mutator')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/owners-interface.OwnersInterface}\n   */\n  static ownersForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/owners-interface.OwnersInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'owners')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceFor(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (\n      getService(window, 'performance')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceForOrNull(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (\n      getExistingServiceOrNull(window, 'performance')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/platform-impl.Platform}\n   */\n  static platformFor(window) {\n    return /** @type {!./service/platform-impl.Platform} */ (\n      getService(window, 'platform')\n    );\n  }\n\n  /**\n   * Not installed by default; must be installed in extension code before use.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/position-observer/position-observer-impl.PositionObserver}\n   * @throws If the service is not installed.\n   */\n  static positionObserverForDoc(element) {\n    return /** @type {!./service/position-observer/position-observer-impl.PositionObserver} */ (\n      getServiceForDoc(element, 'position-observer')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./preconnect.PreconnectService}\n   */\n  static preconnectFor(window) {\n    return getService(window, 'preconnect');\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/resources-interface.ResourcesInterface}\n   */\n  static resourcesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/resources-interface.ResourcesInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'resources')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/resources-interface.ResourcesInterface>}\n   */\n  static resourcesPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/resources-interface.ResourcesInterface>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'resources')\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService>}\n   */\n  static storyVariableServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService>} */\n      (getElementServiceIfAvailable(win, 'story-variable', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService}\n   */\n  static storyVariableService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService} */\n      (getExistingServiceOrNull(win, 'story-variable'))\n    );\n  }\n\n  /**\n   * Version of the story store service depends on which version of amp-story\n   * the publisher is loading. They all have the same implementation.\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService>}\n   */\n  static storyStoreServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService>} */\n      (getElementServiceIfAvailable(win, 'story-store', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService}\n   */\n  static storyStoreService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService} */\n      (getExistingServiceOrNull(win, 'story-store'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService}\n   */\n  static storyMediaQueryService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService} */\n      (getExistingServiceOrNull(win, 'story-media-query'))\n    );\n  }\n\n  /**\n   * Get promise with story request service\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService>}\n   */\n  static storyRequestServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService>} */\n      (getElementServiceIfAvailable(win, 'story-request', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService}\n   */\n  static storyRequestService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService} */\n      (getExistingServiceOrNull(win, 'story-request'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService}\n   */\n  static mediaPerformanceMetricsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService} */\n      (getExistingServiceOrNull(win, 'media-performance-metrics'))\n    );\n  }\n\n  /**\n   * @param {!Element} el\n   * @return {!Promise<./service/localization.LocalizationService>}\n   */\n  static localizationServiceForOrNull(el) {\n    return /** @type {!Promise<?./service/localization.LocalizationService>} */ (\n      getServicePromiseForDoc(el, 'localization')\n    );\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {?./service/localization.LocalizationService}\n   */\n  static localizationForDoc(element) {\n    return /** @type {?./service/localization.LocalizationService} */ (\n      getServiceForDocOrNull(element, 'localization')\n    );\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>}\n   */\n  static storyAnalyticsServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>} */\n      (\n        getElementServiceIfAvailable(\n          win,\n          'story-analytics',\n          'amp-story',\n          '1.0',\n          true\n        )\n      )\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService}\n   */\n  static storyAnalyticsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService} */\n      (getExistingServiceOrNull(win, 'story-analytics'))\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>}\n   */\n  static webAnimationServiceFor(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>} */\n      (getElementServiceForDoc(element, 'web-animation', 'amp-animation'))\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/real-time-config/real-time-config-impl.RealTimeConfigManager>}\n   */\n  static realTimeConfigForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/real-time-config/real-time-config-impl.RealTimeConfigManager>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'real-time-config')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   */\n  static storageForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'storage')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   * TODO(dmanek): Add tests for this method.\n   */\n  static storageForTopLevelDoc(elementOrAmpDoc) {\n    const thisAmpdoc = Services.ampdoc(elementOrAmpDoc);\n    const ampdocService = Services.ampdocServiceFor(thisAmpdoc.win);\n    const topAmpdoc = ampdocService.isSingleDoc()\n      ? ampdocService.getSingleDoc()\n      : null;\n    // We need to verify that ampdocs are on the same origin, therefore\n    // we compare the windows of both.\n    const ampdoc =\n      topAmpdoc && topAmpdoc.win == thisAmpdoc.win ? topAmpdoc : thisAmpdoc;\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (\n      getServicePromiseForDoc(ampdoc, 'storage')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/template-impl.Templates}\n   */\n  static templatesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/template-impl.Templates} */ (\n      getServiceForDoc(elementOrAmpDoc, 'templates')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/timer-impl.Timer}\n   */\n  static timerFor(window) {\n    // TODO(alabiaga): This will always return the top window's Timer service.\n    return /** @type {!./service/timer-impl.Timer} */ (\n      getServiceInEmbedWin(window, 'timer')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-replacements-impl.UrlReplacements}\n   */\n  static urlReplacementsForDoc(element) {\n    return /** @type {!./service/url-replacements-impl.UrlReplacements} */ (\n      getServiceForDocOrNull(element, 'url-replace')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>}\n   */\n  static userNotificationManagerForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>} */\n      (\n        getElementServiceForDoc(\n          element,\n          'userNotificationManager',\n          'amp-user-notification'\n        )\n      )\n    );\n  }\n\n  /**\n   * Returns a promise for the consentPolicy Service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>}\n   */\n  static consentPolicyServiceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>} */\n      (\n        getElementServiceIfAvailableForDoc(\n          element,\n          'consentPolicyManager',\n          'amp-consent'\n        )\n      )\n    );\n  }\n\n  /**\n   * Returns a promise for the geo service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>}\n   */\n  static geoForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>} */ (\n      getElementServiceIfAvailableForDoc(element, 'geo', 'amp-geo', true)\n    );\n  }\n\n  /**\n   * Unlike most service getters, passing `Node` is necessary for some FIE-scope\n   * services since sometimes we only have the FIE Document for context.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-impl.Url}\n   */\n  static urlForDoc(element) {\n    return /** @type {!./service/url-impl.Url} */ (\n      getServiceForDocOrNull(element, 'url')\n    );\n  }\n\n  /**\n   * Returns a promise for the experiment variants or a promise for null if it\n   * is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>}\n   */\n  static variantsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'variant',\n        'amp-experiment',\n        true\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/video-manager-impl.VideoManager}\n   */\n  static videoManagerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/video-manager-impl.VideoManager} */ (\n      getServiceForDoc(elementOrAmpDoc, 'video-manager')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewer-interface.ViewerInterface}\n   */\n  static viewerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewer-interface.ViewerInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'viewer')\n    );\n  }\n\n  /**\n   * Returns promise for the viewer. This is an unusual case and necessary only\n   * for services that need reference to the viewer before it has been\n   * initialized. Most of the code, however, just should use `viewerForDoc`.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/viewer-interface.ViewerInterface>}\n   */\n  static viewerPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/viewer-interface.ViewerInterface>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'viewer')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/vsync-impl.Vsync}\n   */\n  static vsyncFor(window) {\n    return /** @type {!./service/vsync-impl.Vsync} */ (\n      getService(window, 'vsync')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewport/viewport-interface.ViewportInterface}\n   */\n  static viewportForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewport/viewport-interface.ViewportInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'viewport')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/xhr-impl.Xhr}\n   */\n  static xhrFor(window) {\n    return /** @type {!./service/xhr-impl.Xhr} */ (getService(window, 'xhr'));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-frame-service.AssistjsFrameService}\n   */\n  static assistjsFrameServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-frame-service.AssistjsFrameService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'assistjs-frame-service')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-config-service.AssistjsConfigService}\n   */\n  static assistjsConfigServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-config-service.AssistjsConfigService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'assistjs-config-service')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../amp-cache-url/amp-cache-url.AmpCacheUrlService>}\n   */\n  static cacheUrlServicePromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<?../amp-cache-url/amp-cache-url.AmpCacheUrlService>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'cache-url')\n    );\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isArray} from '../array';\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n\n// NOTE Type are changed to {*} because of\n// https://github.com/google/closure-compiler/issues/1999\n\n/**\n * JSON scalar. It's either string, number or boolean.\n * @typedef {string|number|boolean|null}\n */\nlet JSONScalarDef;\n\n/**\n * JSON object. It's a map with string keys and JSON values.\n * @typedef {!Object<string, ?*>} (* should be JSONValueDef)\n */\nlet JSONObjectDef;\n\n/**\n * JSON array. It's an array with JSON values.\n * @typedef {!Array<?*>} (* should be JSONValueDef)\n */\nlet JSONArrayDef;\n\n/**\n * JSON value. It's either a scalar, an object or an array.\n * @typedef {!JSONScalarDef|!JSONObjectDef|!JSONArrayDef}\n */\nlet JSONValueDef;\n\n/**\n * @typedef {{\n *   YOU_MUST_USE: string,\n *   jsonLiteral: function(),\n *   TO_MAKE_THIS_TYPE: string,\n * }}\n */\nlet InternalJsonLiteralTypeDef;\n\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {string} json JSON string to parse\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function parseJson(json) {\n  return /** @type {?JsonObject} */ (JSON.parse(json));\n}\n\n/**\n * Parses the given `json` string without throwing an exception if not valid.\n * Returns `undefined` if parsing fails.\n * Returns the `Object` corresponding to the JSON string when parsing succeeds.\n * @param {string} json JSON string to parse\n * @param {function(!Error)=} opt_onFailed Optional function that will be called\n *     with the error if parsing fails.\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function tryParseJson(json, opt_onFailed) {\n  try {\n    return parseJson(json);\n  } catch (e) {\n    opt_onFailed?.(e);\n    return null;\n  }\n}\n\n/**\n * Deeply checks strict equality of items in nested arrays and objects.\n *\n * @param {JSONValueDef} a\n * @param {JSONValueDef} b\n * @param {number} depth The maximum depth. Must be finite.\n * @return {boolean}\n * @throws {Error} If depth argument is not finite.\n */\nexport function deepEquals(a, b, depth = 5) {\n  if (!isFinite(depth) || depth < 0) {\n    throw new Error('Invalid depth: ' + depth);\n  }\n  if (a === b) {\n    return true;\n  }\n  /** @type {!Array<{a: JSONValueDef, b: JSONValueDef, depth: number}>} */\n  const queue = [{a, b, depth}];\n  while (queue.length > 0) {\n    const {a, b, depth} = queue.shift();\n    // Only check deep equality if depth > 0.\n    if (depth > 0) {\n      if (typeof a !== typeof b) {\n        return false;\n      } else if (isArray(a) && isArray(b)) {\n        if (a.length !== b.length) {\n          return false;\n        }\n        for (let i = 0; i < a.length; i++) {\n          queue.push({a: a[i], b: b[i], depth: depth - 1});\n        }\n        continue;\n      } else if (a && b && typeof a === 'object' && typeof b === 'object') {\n        const keysA = Object.keys(a);\n        const keysB = Object.keys(b);\n        if (keysA.length !== keysB.length) {\n          return false;\n        }\n        for (const k of keysA) {\n          queue.push({a: a[k], b: b[k], depth: depth - 1});\n        }\n        continue;\n      }\n    }\n    // If we get here, then depth == 0 or (a, b) are primitives.\n    if (a !== b) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * This helper function handles configurations specified in a JSON format.\n *\n * It allows the configuration is to be written in plain JS (which has better\n * dev ergonomics like comments and trailing commas), and allows the\n * configuration to be transformed into an efficient JSON-parsed representation\n * in the dist build. See https://v8.dev/blog/cost-of-javascript-2019#json\n *\n * @param {!Object} obj\n * @return {!JsonObject}\n */\nexport function jsonConfiguration(obj) {\n  return /** @type {!JsonObject} */ (obj);\n}\n\n/**\n * This converts an Object into a suitable type to be used in `includeJsonLiteral`.\n * This doesn't actually do any conversion, it only changes the closure type.\n *\n * @param {?JSONValueDef} value\n * @return {!InternalJsonLiteralTypeDef}\n */\nexport function jsonLiteral(value) {\n  return /** @type {!InternalJsonLiteralTypeDef} */ (value);\n}\n\n/**\n * Allows inclusion of a variable (that's wrapped in a jsonLiteral\n * call) to be included inside a jsonConfiguration.\n *\n * @param {!InternalJsonLiteralTypeDef} value\n * @return {*}\n */\nexport function includeJsonLiteral(value) {\n  return value;\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {EmbedMode, parseEmbedMode} from './embed-mode';\nimport {Observable} from '../../../src/core/data-structures/observable';\nimport {Services} from '../../../src/services';\nimport {deepEquals} from '../../../src/core/types/object/json';\nimport {dev} from '../../../src/log';\nimport {hasOwn} from '../../../src/core/types/object';\nimport {registerServiceBuilder} from '../../../src/service';\n\n/** @type {string} */\nconst TAG = 'amp-story';\n\n/**\n * Util function to retrieve the store service. Ensures we can retrieve the\n * service synchronously from the amp-story codebase without running into race\n * conditions.\n * @param  {!Window} win\n * @return {!AmpStoryStoreService}\n */\nexport const getStoreService = (win) => {\n  let service = Services.storyStoreService(win);\n\n  if (!service) {\n    service = new AmpStoryStoreService(win);\n    registerServiceBuilder(win, 'story-store', function () {\n      return service;\n    });\n  }\n\n  return service;\n};\n\n/**\n * Different UI experiences to display the story.\n * @const @enum {number}\n */\nexport const UIType = {\n  MOBILE: 0,\n  DESKTOP_PANELS: 1, // Default desktop UI.\n  DESKTOP_FULLBLEED: 2, // Desktop UI if landscape mode is enabled.\n  VERTICAL: 3, // Vertical scrolling versions, for search engine bots indexing.\n};\n\n/**\n * States in which an embedded component could be found in.\n * @enum {number}\n */\nexport const EmbeddedComponentState = {\n  HIDDEN: 0, // Component is present in page, but hasn't been interacted with.\n  FOCUSED: 1, // Component has been clicked, a tooltip should be shown.\n  EXPANDED: 2, // Component is in expanded mode.\n};\n\n/**\n * @typedef {{\n *    element: !Element,\n *    state: !EmbeddedComponentState,\n *    clientX: number,\n *    clientY: number,\n * }}\n */\nexport let InteractiveComponentDef;\n\n/**\n * @typedef {{\n *    option: ?../../amp-story-interactive/0.1/amp-story-interactive-abstract.OptionConfigType,\n *    interactiveId: string,\n *    type: ../../amp-story-interactive/0.1/amp-story-interactive-abstract.InteractiveType\n * }}\n */\nexport let InteractiveReactData;\n\n/**\n * @typedef {{\n *    canInsertAutomaticAd: boolean,\n *    canShowAudioUi: boolean,\n *    canShowNavigationOverlayHint: boolean,\n *    canShowPaginationButtons: boolean,\n *    canShowPreviousPageHelp: boolean,\n *    canShowSharingUis: boolean,\n *    canShowSystemLayerButtons: boolean,\n *    viewerCustomControls: !Array<!Object>,\n *    accessState: boolean,\n *    adState: boolean,\n *    pageAttachmentState: boolean,\n *    affiliateLinkState: !Element,\n *    desktopState: boolean,\n *    educationState: boolean,\n *    gyroscopeEnabledState: string,\n *    hasSidebarState: boolean,\n *    infoDialogState: boolean,\n *    interactiveEmbeddedComponentState: !InteractiveComponentDef,\n *    interactiveReactState: !Map<string, !InteractiveReactData>,\n *    keyboardActiveState: boolean,\n *    mutedState: boolean,\n *    pageAudioState: boolean,\n *    pageHasElementsWithPlaybackState: boolean,\n *    panningMediaState: !Map<string, ../../amp-story-panning-media/0.1/amp-story-panning-media.panningMediaPositionDef> ,\n *    pausedState: boolean,\n *    previewState: boolean,\n *    rtlState: boolean,\n *    shareMenuState: boolean,\n *    sidebarState: boolean,\n *    storyHasAudioState: boolean,\n *    storyHasPlaybackUiState: boolean,\n *    storyHasBackgroundAudioState: boolean,\n *    supportedBrowserState: boolean,\n *    systemUiIsVisibleState: boolean,\n *    uiState: !UIType,\n *    viewportWarningState: boolean,\n *    actionsAllowlist: !Array<{tagOrTarget: string, method: string}>,\n *    consentId: ?string,\n *    currentPageId: string,\n *    currentPageIndex: number,\n *    pageIds: !Array<string>,\n *    newPageAvailableId: string,\n *    pageSize: {width: number, height: number},\n * }}\n */\nexport let State;\n\n/** @const @enum {string} */\nexport const StateProperty = {\n  // Embed options.\n  CAN_INSERT_AUTOMATIC_AD: 'canInsertAutomaticAd',\n  CAN_SHOW_AUDIO_UI: 'canShowAudioUi',\n  CAN_SHOW_NAVIGATION_OVERLAY_HINT: 'canShowNavigationOverlayHint',\n  CAN_SHOW_PAGINATION_BUTTONS: 'canShowPaginationButtons',\n  CAN_SHOW_PREVIOUS_PAGE_HELP: 'canShowPreviousPageHelp',\n  CAN_SHOW_SHARING_UIS: 'canShowSharingUis',\n  CAN_SHOW_SYSTEM_LAYER_BUTTONS: 'canShowSystemLayerButtons',\n  VIEWER_CUSTOM_CONTROLS: 'viewerCustomControls',\n\n  // App States.\n  ACCESS_STATE: 'accessState', // amp-access paywall.\n  AD_STATE: 'adState',\n  PAGE_ATTACHMENT_STATE: 'pageAttachmentState',\n  AFFILIATE_LINK_STATE: 'affiliateLinkState',\n  DESKTOP_STATE: 'desktopState',\n  EDUCATION_STATE: 'educationState',\n  GYROSCOPE_PERMISSION_STATE: 'gyroscopePermissionState',\n  HAS_SIDEBAR_STATE: 'hasSidebarState',\n  INFO_DIALOG_STATE: 'infoDialogState',\n  INTERACTIVE_COMPONENT_STATE: 'interactiveEmbeddedComponentState',\n  // State of interactive components (polls, quizzes) on the story.\n  INTERACTIVE_REACT_STATE: 'interactiveReactState',\n  KEYBOARD_ACTIVE_STATE: 'keyboardActiveState',\n  MUTED_STATE: 'mutedState',\n  PAGE_HAS_AUDIO_STATE: 'pageAudioState',\n  PAGE_HAS_ELEMENTS_WITH_PLAYBACK_STATE: 'pageHasElementsWithPlaybackState',\n  PANNING_MEDIA_STATE: 'panningMediaState',\n  PAUSED_STATE: 'pausedState',\n  // Story preview state.\n  PREVIEW_STATE: 'previewState',\n  RTL_STATE: 'rtlState',\n  SHARE_MENU_STATE: 'shareMenuState',\n  SIDEBAR_STATE: 'sidebarState',\n  SUPPORTED_BROWSER_STATE: 'supportedBrowserState',\n  // Any page has audio, or amp-story has a `background-audio` attribute.\n  STORY_HAS_AUDIO_STATE: 'storyHasAudioState',\n  // amp-story has a `background-audio` attribute.\n  STORY_HAS_BACKGROUND_AUDIO_STATE: 'storyHasBackgroundAudioState',\n  // Any page has elements with playback.\n  STORY_HAS_PLAYBACK_UI_STATE: 'storyHasPlaybackUiState',\n  SYSTEM_UI_IS_VISIBLE_STATE: 'systemUiIsVisibleState',\n  UI_STATE: 'uiState',\n  VIEWPORT_WARNING_STATE: 'viewportWarningState',\n\n  // App data.\n  ACTIONS_ALLOWLIST: 'actionsAllowlist',\n  CONSENT_ID: 'consentId',\n  CURRENT_PAGE_ID: 'currentPageId',\n  CURRENT_PAGE_INDEX: 'currentPageIndex',\n  ADVANCEMENT_MODE: 'advancementMode',\n  NAVIGATION_PATH: 'navigationPath',\n  NEW_PAGE_AVAILABLE_ID: 'newPageAvailableId',\n  PAGE_IDS: 'pageIds',\n  PAGE_SIZE: 'pageSize',\n};\n\n/** @const @enum {string} */\nexport const Action = {\n  ADD_INTERACTIVE_REACT: 'addInteractiveReact',\n  ADD_TO_ACTIONS_ALLOWLIST: 'addToActionsAllowlist',\n  CHANGE_PAGE: 'setCurrentPageId',\n  SET_CONSENT_ID: 'setConsentId',\n  SET_ADVANCEMENT_MODE: 'setAdvancementMode',\n  SET_NAVIGATION_PATH: 'setNavigationPath',\n  SET_PAGE_IDS: 'setPageIds',\n  TOGGLE_ACCESS: 'toggleAccess',\n  TOGGLE_AD: 'toggleAd',\n  TOGGLE_AFFILIATE_LINK: 'toggleAffiliateLink',\n  TOGGLE_EDUCATION: 'toggleEducation',\n  TOGGLE_HAS_SIDEBAR: 'toggleHasSidebar',\n  TOGGLE_INFO_DIALOG: 'toggleInfoDialog',\n  TOGGLE_INTERACTIVE_COMPONENT: 'toggleInteractiveComponent',\n  TOGGLE_KEYBOARD_ACTIVE_STATE: 'toggleKeyboardActiveState',\n  TOGGLE_MUTED: 'toggleMuted',\n  TOGGLE_PAGE_ATTACHMENT_STATE: 'togglePageAttachmentState',\n  TOGGLE_PAGE_HAS_AUDIO: 'togglePageHasAudio',\n  TOGGLE_PAGE_HAS_ELEMENT_WITH_PLAYBACK: 'togglePageHasElementWithPlayblack',\n  TOGGLE_PAUSED: 'togglePaused',\n  TOGGLE_RTL: 'toggleRtl',\n  TOGGLE_SHARE_MENU: 'toggleShareMenu',\n  TOGGLE_SIDEBAR: 'toggleSidebar',\n  TOGGLE_SUPPORTED_BROWSER: 'toggleSupportedBrowser',\n  TOGGLE_STORY_HAS_AUDIO: 'toggleStoryHasAudio',\n  TOGGLE_STORY_HAS_BACKGROUND_AUDIO: 'toggleStoryHasBackgroundAudio',\n  TOGGLE_STORY_HAS_PLAYBACK_UI: 'toggleStoryHasPlaybackUi',\n  TOGGLE_SYSTEM_UI_IS_VISIBLE: 'toggleSystemUiIsVisible',\n  TOGGLE_UI: 'toggleUi',\n  SET_GYROSCOPE_PERMISSION: 'setGyroscopePermission',\n  TOGGLE_VIEWPORT_WARNING: 'toggleViewportWarning',\n  ADD_NEW_PAGE_ID: 'addNewPageId',\n  SET_PAGE_SIZE: 'updatePageSize',\n  ADD_PANNING_MEDIA_STATE: 'addPanningMediaState',\n  SET_VIEWER_CUSTOM_CONTROLS: 'setCustomControls',\n};\n\n/**\n * Functions to compare a data structure from the previous to the new state and\n * detect a mutation, when a simple equality test would not work.\n * @private @const {!Object<string, !function(*, *):boolean>}\n */\nconst stateComparisonFunctions = {\n  [StateProperty.ACTIONS_ALLOWLIST]: (old, curr) => old.length !== curr.length,\n  [StateProperty.INTERACTIVE_COMPONENT_STATE]:\n    /**\n     * @param {InteractiveComponentDef} old\n     * @param {InteractiveComponentDef} curr\n     */\n    (old, curr) => old.element !== curr.element || old.state !== curr.state,\n  [StateProperty.NAVIGATION_PATH]: (old, curr) => old.length !== curr.length,\n  [StateProperty.PAGE_IDS]: (old, curr) => old.length !== curr.length,\n  [StateProperty.PAGE_SIZE]: (old, curr) =>\n    old === null ||\n    curr === null ||\n    old.width !== curr.width ||\n    old.height !== curr.height,\n  [StateProperty.PANNING_MEDIA_STATE]: (old, curr) =>\n    old === null || curr === null || !deepEquals(old, curr, 2),\n  [StateProperty.INTERACTIVE_REACT_STATE]: (old, curr) =>\n    !deepEquals(old, curr, 3),\n};\n\n/**\n * Returns the new sate.\n * @param  {!State} state Immutable state\n * @param  {!Action} action\n * @param  {*} data\n * @return {!State} new state\n */\nconst actions = (state, action, data) => {\n  switch (action) {\n    case Action.ADD_INTERACTIVE_REACT:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.INTERACTIVE_REACT_STATE]: {\n          ...state[StateProperty.INTERACTIVE_REACT_STATE],\n          [data['interactiveId']]: data,\n        },\n      });\n    case Action.ADD_NEW_PAGE_ID:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.NEW_PAGE_AVAILABLE_ID]: data,\n      });\n    case Action.ADD_PANNING_MEDIA_STATE:\n      const updatedState = {\n        ...state[StateProperty.PANNING_MEDIA_STATE],\n        ...data,\n      };\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.PANNING_MEDIA_STATE]: updatedState,\n      });\n    case Action.ADD_TO_ACTIONS_ALLOWLIST:\n      const newActionsAllowlist = [].concat(\n        state[StateProperty.ACTIONS_ALLOWLIST],\n        data\n      );\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.ACTIONS_ALLOWLIST]: newActionsAllowlist,\n      });\n    // Triggers the amp-acess paywall.\n    case Action.TOGGLE_ACCESS:\n      // Don't change the PAUSED_STATE if ACCESS_STATE is not changed.\n      if (state[StateProperty.ACCESS_STATE] === data) {\n        return state;\n      }\n\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.ACCESS_STATE]: !!data,\n        [StateProperty.PAUSED_STATE]: !!data,\n      });\n    case Action.TOGGLE_PAGE_ATTACHMENT_STATE:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.PAGE_ATTACHMENT_STATE]: !!data,\n      });\n    // Triggers the ad UI.\n    case Action.TOGGLE_AD:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.AD_STATE]: !!data,\n      });\n    // Expands or collapses the affiliate link.\n    case Action.TOGGLE_AFFILIATE_LINK:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.AFFILIATE_LINK_STATE]: data,\n      });\n    case Action.TOGGLE_EDUCATION:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.EDUCATION_STATE]: !!data,\n      });\n    case Action.TOGGLE_INTERACTIVE_COMPONENT:\n      data = /** @type {InteractiveComponentDef} */ (data);\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.PAUSED_STATE]:\n          data.state === EmbeddedComponentState.EXPANDED ||\n          data.state === EmbeddedComponentState.FOCUSED,\n        [StateProperty.SYSTEM_UI_IS_VISIBLE_STATE]:\n          data.state !== EmbeddedComponentState.EXPANDED ||\n          state.uiState === UIType.DESKTOP_PANELS,\n        [StateProperty.INTERACTIVE_COMPONENT_STATE]: data,\n      });\n    // Shows or hides the info dialog.\n    case Action.TOGGLE_INFO_DIALOG:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.INFO_DIALOG_STATE]: !!data,\n        [StateProperty.PAUSED_STATE]: !!data,\n      });\n    // Shows or hides the audio controls.\n    case Action.TOGGLE_STORY_HAS_AUDIO:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.STORY_HAS_AUDIO_STATE]: !!data,\n      });\n    case Action.TOGGLE_STORY_HAS_BACKGROUND_AUDIO:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.STORY_HAS_BACKGROUND_AUDIO_STATE]: !!data,\n      });\n    // Shows or hides the play/pause controls.\n    case Action.TOGGLE_STORY_HAS_PLAYBACK_UI:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.STORY_HAS_PLAYBACK_UI_STATE]: !!data,\n      });\n    // Mutes or unmutes the story media.\n    case Action.TOGGLE_MUTED:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.MUTED_STATE]: !!data,\n      });\n    case Action.TOGGLE_PAGE_HAS_AUDIO:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.PAGE_HAS_AUDIO_STATE]: !!data,\n      });\n    case Action.TOGGLE_PAGE_HAS_ELEMENT_WITH_PLAYBACK:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.PAGE_HAS_ELEMENTS_WITH_PLAYBACK_STATE]: !!data,\n      });\n    case Action.TOGGLE_PAUSED:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.PAUSED_STATE]: !!data,\n      });\n    case Action.TOGGLE_RTL:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.RTL_STATE]: !!data,\n      });\n    case Action.TOGGLE_KEYBOARD_ACTIVE_STATE:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.KEYBOARD_ACTIVE_STATE]: !!data,\n      });\n    case Action.TOGGLE_SIDEBAR:\n      // Don't change the PAUSED_STATE if SIDEBAR_STATE is not changed.\n      if (state[StateProperty.SIDEBAR_STATE] === data) {\n        return state;\n      }\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.PAUSED_STATE]: !!data,\n        [StateProperty.SIDEBAR_STATE]: !!data,\n      });\n    case Action.TOGGLE_HAS_SIDEBAR:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.HAS_SIDEBAR_STATE]: !!data,\n      });\n    case Action.TOGGLE_SUPPORTED_BROWSER:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.SUPPORTED_BROWSER_STATE]: !!data,\n      });\n    case Action.TOGGLE_SHARE_MENU:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.PAUSED_STATE]: !!data,\n        [StateProperty.SHARE_MENU_STATE]: !!data,\n      });\n    case Action.TOGGLE_SYSTEM_UI_IS_VISIBLE:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.SYSTEM_UI_IS_VISIBLE_STATE]: !!data,\n      });\n    case Action.TOGGLE_UI:\n      if (\n        state[StateProperty.UI_STATE] === UIType.VERTICAL &&\n        data !== UIType.VERTICAL\n      ) {\n        dev().error(TAG, 'Cannot switch away from UIType.VERTICAL');\n        return state;\n      }\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.DESKTOP_STATE]: data === UIType.DESKTOP_PANELS,\n        [StateProperty.UI_STATE]: data,\n      });\n    case Action.SET_GYROSCOPE_PERMISSION:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.GYROSCOPE_PERMISSION_STATE]: data,\n      });\n    case Action.TOGGLE_VIEWPORT_WARNING:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.VIEWPORT_WARNING_STATE]: !!data,\n      });\n    case Action.SET_CONSENT_ID:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.CONSENT_ID]: data,\n      });\n    case Action.CHANGE_PAGE:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.CURRENT_PAGE_ID]: data.id,\n        [StateProperty.CURRENT_PAGE_INDEX]: data.index,\n      });\n    case Action.SET_ADVANCEMENT_MODE:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.ADVANCEMENT_MODE]: data,\n      });\n    case Action.SET_NAVIGATION_PATH:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.NAVIGATION_PATH]: data,\n      });\n    case Action.SET_PAGE_IDS:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.PAGE_IDS]: data,\n      });\n    case Action.SET_PAGE_SIZE:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.PAGE_SIZE]: data,\n      });\n    case Action.SET_VIEWER_CUSTOM_CONTROLS:\n      return /** @type {!State} */ ({\n        ...state,\n        [StateProperty.VIEWER_CUSTOM_CONTROLS]: data,\n      });\n    default:\n      dev().error(TAG, 'Unknown action %s.', action);\n      return state;\n  }\n};\n\n/**\n * Store service.\n */\nexport class AmpStoryStoreService {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {!Object<string, !Observable>} */\n    this.listeners_ = {};\n\n    /** @private {!State} */\n    this.state_ = /** @type {!State} */ ({\n      ...this.getDefaultState_(),\n      ...this.getEmbedOverrides_(),\n    });\n  }\n\n  /**\n   * Retrieves a state property.\n   * @param  {string} key Property to retrieve from the state.\n   * @return {*}\n   */\n  get(key) {\n    if (!hasOwn(this.state_, key)) {\n      dev().error(TAG, 'Unknown state %s.', key);\n      return;\n    }\n    return this.state_[key];\n  }\n\n  /**\n   * Subscribes to a state property mutations.\n   * @param  {string} key\n   * @param  {!Function} listener\n   * @param  {boolean=} callToInitialize Whether the listener should be\n   *                                     triggered with current value.\n   */\n  subscribe(key, listener, callToInitialize = false) {\n    if (!hasOwn(this.state_, key)) {\n      dev().error(TAG, \"Can't subscribe to unknown state %s.\", key);\n      return;\n    }\n    if (!this.listeners_[key]) {\n      this.listeners_[key] = new Observable();\n    }\n    this.listeners_[key].add(listener);\n\n    if (callToInitialize) {\n      listener(this.get(key));\n    }\n  }\n\n  /**\n   * Dispatches an action and triggers the listeners for the updated state\n   * properties.\n   * @param  {!Action} action\n   * @param  {*} data\n   */\n  dispatch(action, data) {\n    const oldState = {...this.state_};\n    this.state_ = actions(this.state_, action, data);\n\n    let comparisonFn;\n    Object.keys(this.listeners_).forEach((key) => {\n      comparisonFn = stateComparisonFunctions[key];\n      if (\n        comparisonFn\n          ? comparisonFn(oldState[key], this.state_[key])\n          : oldState[key] !== this.state_[key]\n      ) {\n        this.listeners_[key].fire(this.state_[key]);\n      }\n    });\n  }\n\n  /**\n   * Retrieves the default state, that could be overriden by an embed mode.\n   * @return {!State}\n   * @private\n   */\n  getDefaultState_() {\n    // Compiler won't resolve the object keys and trigger an error for missing\n    // properties, so we have to force the type.\n    return /** @type {!State} */ ({\n      [StateProperty.CAN_INSERT_AUTOMATIC_AD]: true,\n      [StateProperty.CAN_SHOW_AUDIO_UI]: true,\n      [StateProperty.CAN_SHOW_NAVIGATION_OVERLAY_HINT]: true,\n      [StateProperty.CAN_SHOW_PREVIOUS_PAGE_HELP]: true,\n      [StateProperty.CAN_SHOW_PAGINATION_BUTTONS]: true,\n      [StateProperty.CAN_SHOW_SHARING_UIS]: true,\n      [StateProperty.CAN_SHOW_SYSTEM_LAYER_BUTTONS]: true,\n      [StateProperty.VIEWER_CUSTOM_CONTROLS]: [],\n      [StateProperty.ACCESS_STATE]: false,\n      [StateProperty.AD_STATE]: false,\n      [StateProperty.AFFILIATE_LINK_STATE]: null,\n      [StateProperty.DESKTOP_STATE]: false,\n      [StateProperty.EDUCATION_STATE]: false,\n      [StateProperty.GYROSCOPE_PERMISSION_STATE]: '',\n      [StateProperty.HAS_SIDEBAR_STATE]: false,\n      [StateProperty.INFO_DIALOG_STATE]: false,\n      [StateProperty.INTERACTIVE_COMPONENT_STATE]: {\n        state: EmbeddedComponentState.HIDDEN,\n      },\n      [StateProperty.INTERACTIVE_REACT_STATE]: {},\n      [StateProperty.KEYBOARD_ACTIVE_STATE]: false,\n      [StateProperty.MUTED_STATE]: true,\n      [StateProperty.PAGE_ATTACHMENT_STATE]: false,\n      [StateProperty.PAGE_HAS_AUDIO_STATE]: false,\n      [StateProperty.PAGE_HAS_ELEMENTS_WITH_PLAYBACK_STATE]: false,\n      [StateProperty.PANNING_MEDIA_STATE]: {},\n      [StateProperty.PAUSED_STATE]: false,\n      [StateProperty.RTL_STATE]: false,\n      [StateProperty.SHARE_MENU_STATE]: false,\n      [StateProperty.SIDEBAR_STATE]: false,\n      [StateProperty.SUPPORTED_BROWSER_STATE]: true,\n      [StateProperty.STORY_HAS_AUDIO_STATE]: false,\n      [StateProperty.STORY_HAS_BACKGROUND_AUDIO_STATE]: false,\n      [StateProperty.STORY_HAS_PLAYBACK_UI_STATE]: false,\n      [StateProperty.SYSTEM_UI_IS_VISIBLE_STATE]: true,\n      [StateProperty.UI_STATE]: UIType.MOBILE,\n      [StateProperty.VIEWPORT_WARNING_STATE]: false,\n      // amp-story only allows actions on a case-by-case basis to preserve UX\n      // behaviors. By default, no actions are allowed.\n      [StateProperty.ACTIONS_ALLOWLIST]: [],\n      [StateProperty.CONSENT_ID]: null,\n      [StateProperty.CURRENT_PAGE_ID]: '',\n      [StateProperty.CURRENT_PAGE_INDEX]: 0,\n      [StateProperty.ADVANCEMENT_MODE]: '',\n      [StateProperty.NEW_PAGE_AVAILABLE_ID]: '',\n      [StateProperty.NAVIGATION_PATH]: [],\n      [StateProperty.PAGE_IDS]: [],\n      [StateProperty.PAGE_SIZE]: null,\n      [StateProperty.PREVIEW_STATE]: false,\n    });\n  }\n\n  // @TODO(gmajoulet): These should get their own file if they start growing.\n  /**\n   * Retrieves the embed mode config, that will override the default state.\n   * @return {!Object<StateProperty, *>} Partial state\n   * @protected\n   */\n  getEmbedOverrides_() {\n    const embedMode = parseEmbedMode(this.win_.location.hash);\n    switch (embedMode) {\n      case EmbedMode.NAME_TBD:\n        return {\n          [StateProperty.CAN_INSERT_AUTOMATIC_AD]: false,\n          [StateProperty.CAN_SHOW_NAVIGATION_OVERLAY_HINT]: false,\n          [StateProperty.CAN_SHOW_PAGINATION_BUTTONS]: false,\n          [StateProperty.CAN_SHOW_PREVIOUS_PAGE_HELP]: true,\n          [StateProperty.CAN_SHOW_SYSTEM_LAYER_BUTTONS]: false,\n          [StateProperty.MUTED_STATE]: false,\n        };\n      case EmbedMode.NO_SHARING:\n        return {\n          [StateProperty.CAN_SHOW_SHARING_UIS]: false,\n        };\n      case EmbedMode.PREVIEW:\n        return {\n          [StateProperty.PREVIEW_STATE]: true,\n          [StateProperty.CAN_INSERT_AUTOMATIC_AD]: false,\n          [StateProperty.CAN_SHOW_NAVIGATION_OVERLAY_HINT]: false,\n          [StateProperty.CAN_SHOW_PAGINATION_BUTTONS]: false,\n          [StateProperty.CAN_SHOW_PREVIOUS_PAGE_HELP]: false,\n          [StateProperty.CAN_SHOW_SYSTEM_LAYER_BUTTONS]: false,\n        };\n      case EmbedMode.NO_SHARING_NOR_AUDIO_UI:\n        return {\n          [StateProperty.CAN_SHOW_AUDIO_UI]: false,\n          [StateProperty.CAN_SHOW_SHARING_UIS]: false,\n        };\n      default:\n        return {};\n    }\n  }\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {escapeCssSelectorIdent} from '../../../src/core/dom/css-selectors';\nimport {parseQueryString} from '../../../src/core/types/string/url';\nimport {toWin} from '../../../src/core/window';\n\n/**\n * Returns true if the page should be prerendered (for being an active page or\n * first page).\n * @param {!AmpElement} pageElement\n * @return {boolean}\n */\nexport function isPrerenderActivePage(pageElement) {\n  const win = toWin(pageElement.ownerDocument.defaultView);\n  const hashId = parseQueryString(win.location.href)['page'];\n  let selector = 'amp-story-page:first-of-type';\n  if (hashId) {\n    selector += `, amp-story-page#${escapeCssSelectorIdent(hashId)}`;\n  }\n  const selectorNodes = win.document.querySelectorAll(selector);\n  return selectorNodes[selectorNodes.length - 1] === pageElement;\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview This is a layer that lays its children out into a grid. Its\n * implementation is based off of the CSS Grid Spec.\n *\n * Example:\n * <code>\n * <amp-story-grid-layer template=\"fill\">\n *   ...\n * </amp-story-grid-layer>\n * </code>\n */\n\nimport {AmpStoryBaseLayer} from './amp-story-base-layer';\nimport {StateProperty, getStoreService} from './amp-story-store-service';\nimport {assertDoesNotContainDisplay, px, setStyles} from '../../../src/style';\nimport {isPrerenderActivePage} from './prerender-active-page';\nimport {scopedQuerySelectorAll} from '../../../src/core/dom/query';\n\n/**\n * A mapping of attribute names we support for grid layers to the CSS Grid\n * properties they control.\n * @private @const {!Object<string, string>}\n */\nconst SUPPORTED_CSS_GRID_ATTRIBUTES = {\n  'align-content': 'alignContent',\n  'align-items': 'alignItems',\n  'align-self': 'alignSelf',\n  'grid-area': 'gridArea',\n  'justify-content': 'justifyContent',\n  'justify-items': 'justifyItems',\n  'justify-self': 'justifySelf',\n};\n\n/**\n * Converts the keys of the SUPPORTED_CSS_GRID_ATTRIBUTES object above into a\n * selector for the specified attributes.\n * (e.g. [align-content], [align-items], ...)\n * @private @const {string}\n */\nconst SUPPORTED_CSS_GRID_ATTRIBUTES_SELECTOR = Object.keys(\n  SUPPORTED_CSS_GRID_ATTRIBUTES\n)\n  .map((key) => `[${key}]`)\n  .join(',');\n\n/**\n * The attribute name for grid layer templates.\n * @private @const {string}\n */\nconst TEMPLATE_ATTRIBUTE_NAME = 'template';\n\n/**\n * A mapping of template attribute values to CSS class names.\n * @const {!Object<string, string>}\n */\nexport const GRID_LAYER_TEMPLATE_CLASS_NAMES = {\n  'fill': 'i-amphtml-story-grid-template-fill',\n  'vertical': 'i-amphtml-story-grid-template-vertical',\n  'horizontal': 'i-amphtml-story-grid-template-horizontal',\n  'thirds': 'i-amphtml-story-grid-template-thirds',\n};\n\n/**\n * The attribute name for grid layer presets.\n * @private @const {string}\n */\nconst PRESET_ATTRIBUTE_NAME = 'preset';\n\n/**\n * @typedef {{\n *  aspect-ratio: string,\n *  scaling-factor: ?float,\n * }}\n */\nexport let PresetDetails;\n\n/**\n * The attributes that will be applied for each preset.\n * @private @const {!Object<string, !PresetDetails>}\n */\nconst GRID_LAYER_PRESET_DETAILS = {\n  '2021-background': {\n    'aspect-ratio': '69:116',\n    'scaling-factor': 1.142,\n  },\n  '2021-foreground': {\n    'aspect-ratio': '69:116',\n  },\n};\n\n/**\n * Grid layer template templating system.\n */\nexport class AmpStoryGridLayer extends AmpStoryBaseLayer {\n  /** @override @nocollapse */\n  static prerenderAllowed(element) {\n    return isPrerenderActivePage(element.parentElement);\n  }\n\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n\n    /** @private {?{horiz: number, vert: number}} */\n    this.aspectRatio_ = null;\n\n    /** @private {number} */\n    this.scalingFactor_ = 1;\n  }\n\n  /** @override */\n  buildCallback() {\n    super.buildCallback();\n    this.applyResponsivenessPresets_();\n    this.applyTemplateClassName_();\n    this.setOwnCssGridStyles_();\n    this.setDescendentCssGridStyles_();\n    this.initializeListeners_();\n  }\n\n  /**\n   * Applies the attributes to the layer from the preset specified in the [preset] attribute.\n   * @private\n   */\n  applyResponsivenessPresets_() {\n    if (!this.element.hasAttribute(PRESET_ATTRIBUTE_NAME)) {\n      return;\n    }\n    const preset = this.element.getAttribute(PRESET_ATTRIBUTE_NAME);\n    const presetDetails = GRID_LAYER_PRESET_DETAILS[preset];\n    if (!presetDetails) {\n      return;\n    }\n    Object.entries(presetDetails).forEach((keyValue) =>\n      this.element.setAttribute(keyValue[0], keyValue[1])\n    );\n  }\n\n  /** @private */\n  initializeListeners_() {\n    const aspectRatio = this.element.getAttribute('aspect-ratio');\n    const scalingFactorFloat = parseFloat(\n      this.element.getAttribute('scaling-factor')\n    );\n    if (scalingFactorFloat && scalingFactorFloat > 0) {\n      this.scalingFactor_ = scalingFactorFloat;\n    }\n    if (aspectRatio) {\n      const aspectRatioSplits = aspectRatio.split(':');\n      const horiz = parseInt(aspectRatioSplits[0], 10);\n      const vert = parseInt(aspectRatioSplits[1], 10);\n      if (horiz > 0 && vert > 0) {\n        this.aspectRatio_ = {horiz, vert};\n        const storeService = getStoreService(this.win);\n        storeService.subscribe(\n          StateProperty.PAGE_SIZE,\n          this.updatePageSize_.bind(this),\n          true /* callToInitialize */\n        );\n      }\n    }\n  }\n\n  /**\n   * @param {?{width: number, height: number}} pageSize\n   * @private\n   */\n  updatePageSize_(pageSize) {\n    if (!pageSize) {\n      return;\n    }\n    const {height: vh, width: vw} = pageSize;\n    const {horiz, vert} = this.aspectRatio_;\n    const width = Math.min(vw, (vh * horiz) / vert);\n    const height = Math.min(vh, (vw * vert) / horiz);\n    if (width > 0 && height > 0) {\n      this.getVsync().mutate(() => {\n        this.element.classList.add('i-amphtml-story-grid-template-aspect');\n        setStyles(this.element, {\n          '--i-amphtml-story-layer-width': px(width * this.scalingFactor_),\n          '--i-amphtml-story-layer-height': px(height * this.scalingFactor_),\n        });\n      });\n    }\n  }\n\n  /**\n   * Applies internal CSS class names for the template attribute, so that styles\n   * can use the class name instead of compound\n   * amp-story-grid-layer[template=\"...\"] selectors, since the latter increases\n   * CSS specificity and can prevent users from being able to override styles.\n   * @private\n   */\n  applyTemplateClassName_() {\n    if (this.element.hasAttribute(TEMPLATE_ATTRIBUTE_NAME)) {\n      const templateName = this.element.getAttribute(TEMPLATE_ATTRIBUTE_NAME);\n      const templateClassName = GRID_LAYER_TEMPLATE_CLASS_NAMES[templateName];\n      this.element.classList.add(templateClassName);\n    }\n  }\n\n  /**\n   * Copies the allowlisted CSS grid styles for descendants of the\n   * <amp-story-grid-layer> element.\n   * @private\n   */\n  setDescendentCssGridStyles_() {\n    const elementsToUpgradeStyles = scopedQuerySelectorAll(\n      this.element,\n      SUPPORTED_CSS_GRID_ATTRIBUTES_SELECTOR\n    );\n\n    Array.prototype.forEach.call(elementsToUpgradeStyles, (element) => {\n      this.setCssGridStyles_(element);\n    });\n  }\n\n  /**\n   * Copies the allowlisted CSS grid styles for the <amp-story-grid-layer>\n   * element itself.\n   * @private\n   */\n  setOwnCssGridStyles_() {\n    this.setCssGridStyles_(this.element);\n  }\n\n  /**\n   * Copies the values of an element's attributes to its styles, if the\n   * attributes/properties are in the allowlist.\n   *\n   * @param {!Element} element The element whose styles should be copied from\n   *     its attributes.\n   */\n  setCssGridStyles_(element) {\n    const styles = {};\n    for (let i = element.attributes.length - 1; i >= 0; i--) {\n      const attribute = element.attributes[i];\n      const attributeName = attribute.name.toLowerCase();\n      const propertyName = SUPPORTED_CSS_GRID_ATTRIBUTES[attributeName];\n      if (propertyName) {\n        styles[propertyName] = attribute.value;\n        element.removeAttribute(attributeName);\n      }\n    }\n    setStyles(element, assertDoesNotContainDisplay(styles));\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {Services} from '../../../src/services';\nimport {StateProperty, getStoreService} from './amp-story-store-service';\nimport {dict} from '../../../src/core/types/object';\nimport {registerServiceBuilder} from '../../../src/service';\n\n/**\n * @typedef {!JsonObject}\n */\nexport let StoryVariableDef;\n\n/** @enum {string} */\nexport const AnalyticsVariable = {\n  STORY_INTERACTIVE_ID: 'storyInteractiveId',\n  STORY_INTERACTIVE_RESPONSE: 'storyInteractiveResponse',\n  STORY_INTERACTIVE_TYPE: 'storyInteractiveType',\n  STORY_PAGE_ID: 'storyPageId',\n  STORY_PAGE_INDEX: 'storyPageIndex',\n  STORY_PAGE_COUNT: 'storyPageCount',\n  STORY_IS_MUTED: 'storyIsMuted',\n  STORY_PROGRESS: 'storyProgress',\n  STORY_PREVIOUS_PAGE_ID: 'storyPreviousPageId',\n  STORY_ADVANCEMENT_MODE: 'storyAdvancementMode',\n};\n\n/**\n * Util function to retrieve the variable service. Ensures we can retrieve the\n * service synchronously from the amp-story codebase without running into race\n * conditions.\n * @param {!Window} win\n * @return {!AmpStoryVariableService}\n */\nexport const getVariableService = (win) => {\n  let service = Services.storyVariableService(win);\n\n  if (!service) {\n    service = new AmpStoryVariableService(win);\n    registerServiceBuilder(win, 'story-variable', function () {\n      return service;\n    });\n  }\n\n  return service;\n};\n\n/**\n * Variable service for amp-story.\n * Used for URL replacement service. See usage in src/url-replacements-impl.\n */\nexport class AmpStoryVariableService {\n  /**\n   * @param {!Window} win\n   * @public\n   */\n  constructor(win) {\n    /** @private {!StoryVariableDef} */\n    this.variables_ = dict({\n      [AnalyticsVariable.STORY_INTERACTIVE_ID]: null,\n      [AnalyticsVariable.STORY_INTERACTIVE_RESPONSE]: null,\n      [AnalyticsVariable.STORY_INTERACTIVE_TYPE]: null,\n      [AnalyticsVariable.STORY_PAGE_INDEX]: null,\n      [AnalyticsVariable.STORY_PAGE_ID]: null,\n      [AnalyticsVariable.STORY_PAGE_COUNT]: null,\n      [AnalyticsVariable.STORY_PROGRESS]: null,\n      [AnalyticsVariable.STORY_IS_MUTED]: null,\n      [AnalyticsVariable.STORY_PREVIOUS_PAGE_ID]: null,\n      [AnalyticsVariable.STORY_ADVANCEMENT_MODE]: null,\n    });\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(win);\n\n    this.initializeListeners_();\n  }\n\n  /** @private */\n  initializeListeners_() {\n    this.storeService_.subscribe(StateProperty.PAGE_IDS, (pageIds) => {\n      this.variables_[AnalyticsVariable.STORY_PAGE_COUNT] = pageIds.length;\n    });\n\n    this.storeService_.subscribe(\n      StateProperty.CURRENT_PAGE_ID,\n      (pageId) => {\n        if (!pageId) {\n          return;\n        }\n\n        this.variables_[AnalyticsVariable.STORY_PREVIOUS_PAGE_ID] =\n          this.variables_[AnalyticsVariable.STORY_PAGE_ID];\n\n        this.variables_[AnalyticsVariable.STORY_PAGE_ID] = pageId;\n\n        const pageIndex = /** @type {number} */ (\n          this.storeService_.get(StateProperty.CURRENT_PAGE_INDEX)\n        );\n        this.variables_[AnalyticsVariable.STORY_PAGE_INDEX] = pageIndex;\n\n        const numberOfPages = this.storeService_.get(\n          StateProperty.PAGE_IDS\n        ).length;\n        if (numberOfPages > 0) {\n          if (numberOfPages === 1) {\n            this.variables_[AnalyticsVariable.STORY_PROGRESS] = 0;\n          } else {\n            this.variables_[AnalyticsVariable.STORY_PROGRESS] =\n              pageIndex / (numberOfPages - 1);\n          }\n        }\n      },\n      true /* callToInitialize */\n    );\n  }\n\n  /**\n   * Updates a variable with a new value\n   * @param {string} name\n   * @param {*} update\n   */\n  onVariableUpdate(name, update) {\n    this.variables_[name] = update;\n  }\n\n  /**\n   * @return {!StoryVariableDef}\n   */\n  get() {\n    // TODO(newmius): You should probably Object.freeze this in development.\n    return this.variables_;\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {dict} from './core/types/object';\n\n/**\n * Helper method to trigger analytics event if amp-analytics is available.\n * TODO: Do not expose this function\n * @param {!Element} target\n * @param {string} eventType\n * @param {!JsonObject} vars A map of vars and their values.\n * @param {boolean} enableDataVars A boolean to indicate if data-vars-*\n * attribute value from target element should be included.\n */\nexport function triggerAnalyticsEvent(\n  target,\n  eventType,\n  vars = dict(),\n  enableDataVars = true\n) {\n  Services.analyticsForDocOrNull(target).then((analytics) => {\n    if (!analytics) {\n      return;\n    }\n    analytics.triggerEventForTarget(target, eventType, vars, enableDataVars);\n  });\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {Services} from '../../../src/services';\nimport {StateProperty, getStoreService} from './amp-story-store-service';\nimport {getDataParamsFromAttributes} from '../../../src/dom';\nimport {getVariableService} from './variable-service';\nimport {map} from '../../../src/core/types/object';\nimport {registerServiceBuilder} from '../../../src/service';\nimport {triggerAnalyticsEvent} from '../../../src/analytics';\n\n/** @const {string} */\nexport const ANALYTICS_TAG_NAME = '__AMP_ANALYTICS_TAG_NAME__';\n\n/** @enum {string} */\nexport const StoryAnalyticsEvent = {\n  CLICK_THROUGH: 'story-click-through',\n  FOCUS: 'story-focus',\n  LAST_PAGE_VISIBLE: 'story-last-page-visible',\n  OPEN: 'story-open',\n  CLOSE: 'story-close',\n  PAGE_ATTACHMENT_ENTER: 'story-page-attachment-enter',\n  PAGE_ATTACHMENT_EXIT: 'story-page-attachment-exit',\n  PAGE_VISIBLE: 'story-page-visible',\n  INTERACTIVE: 'story-interactive',\n  STORY_CONTENT_LOADED: 'story-content-loaded',\n  STORY_MUTED: 'story-audio-muted',\n  STORY_UNMUTED: 'story-audio-unmuted',\n};\n\n/**\n * @enum {string}\n * Note: auto advance advancements should always be prefixed with \"autoAdvance\".\n */\nexport const AdvancementMode = {\n  GO_TO_PAGE: 'goToPageAction',\n  AUTO_ADVANCE_TIME: 'autoAdvanceTime',\n  AUTO_ADVANCE_MEDIA: 'autoAdvanceMedia',\n  MANUAL_ADVANCE: 'manualAdvance',\n  ADVANCE_TO_ADS: 'manualAdvanceFromAd',\n  VIEWER_SELECT_PAGE: 'viewerSelectPage',\n};\n\n/** @typedef {!Object<string, !PageEventCountDef>} */\nlet EventsPerPageDef;\n\n/** @typedef {!Object<string, number>} */\nlet PageEventCountDef;\n\n/**\n * Util function to retrieve the analytics service. Ensures we can retrieve the\n * service synchronously from the amp-story codebase without running into race\n * conditions.\n * @param {!Window} win\n * @param {!Element} el\n * @return {!StoryAnalyticsService}\n */\nexport const getAnalyticsService = (win, el) => {\n  let service = Services.storyAnalyticsService(win);\n\n  if (!service) {\n    service = new StoryAnalyticsService(win, el);\n    registerServiceBuilder(win, 'story-analytics', function () {\n      return service;\n    });\n  }\n\n  return service;\n};\n\n/**\n * Intermediate handler for amp-story specific analytics.\n */\nexport class StoryAnalyticsService {\n  /**\n   * @param {!Window} win\n   * @param {!Element} element\n   */\n  constructor(win, element) {\n    /** @protected @const {!Window} */\n    this.win_ = win;\n\n    /** @private @const {!Element} */\n    this.element_ = element;\n\n    /** @const @private {!./variable-service.AmpStoryVariableService} */\n    this.variableService_ = getVariableService(win);\n\n    /** @private {EventsPerPageDef} */\n    this.pageEventsMap_ = map();\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(win);\n\n    this.initializeListeners_();\n  }\n\n  /** @private */\n  initializeListeners_() {\n    this.storeService_.subscribe(\n      StateProperty.CURRENT_PAGE_ID,\n      (pageId) => {\n        const isAd = this.storeService_.get(StateProperty.AD_STATE);\n        if (!pageId || isAd) {\n          return;\n        }\n\n        this.triggerEvent(StoryAnalyticsEvent.PAGE_VISIBLE);\n\n        const pageIds = this.storeService_.get(StateProperty.PAGE_IDS);\n        const pageIndex = this.storeService_.get(\n          StateProperty.CURRENT_PAGE_INDEX\n        );\n        if (pageIndex === pageIds.length - 1) {\n          this.triggerEvent(StoryAnalyticsEvent.LAST_PAGE_VISIBLE);\n        }\n      },\n      true /* callToInitialize */\n    );\n  }\n\n  /**\n   * @param {!StoryAnalyticsEvent} eventType\n   * @param {Element=} element\n   */\n  triggerEvent(eventType, element = null) {\n    this.incrementPageEventCount_(eventType);\n\n    triggerAnalyticsEvent(\n      this.element_,\n      eventType,\n      this.updateDetails(eventType, element)\n    );\n  }\n\n  /**\n   * Updates event details.\n   * @param {!StoryAnalyticsEvent} eventType\n   * @param {Element=} element\n   * @visibleForTesting\n   * @return {!JsonObject}}\n   */\n  updateDetails(eventType, element = null) {\n    const details = {};\n    const vars = this.variableService_.get();\n    const pageId = vars['storyPageId'];\n\n    if (this.pageEventsMap_[pageId][eventType] > 1) {\n      details.repeated = true;\n    }\n\n    if (element) {\n      details.tagName =\n        element[ANALYTICS_TAG_NAME] || element.tagName.toLowerCase();\n      Object.assign(\n        vars,\n        getDataParamsFromAttributes(\n          element,\n          /* computeParamNameFunc */ undefined,\n          /^vars(.+)/\n        )\n      );\n    }\n\n    return /** @type {!JsonObject} */ ({eventDetails: details, ...vars});\n  }\n\n  /**\n   * Keeps count of number of events emitted by page for an event type.\n   * @param {!StoryAnalyticsEvent} eventType\n   * @private\n   */\n  incrementPageEventCount_(eventType) {\n    const vars = this.variableService_.get();\n    const pageId = vars['storyPageId'];\n\n    this.pageEventsMap_[pageId] = this.pageEventsMap_[pageId] || {};\n    this.pageEventsMap_[pageId][eventType] =\n      this.pageEventsMap_[pageId][eventType] || 0;\n    this.pageEventsMap_[pageId][eventType]++;\n  }\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Affiliate link component that expands when clicked.\n */\n\nimport {Services} from '../../../src/services';\nimport {StateProperty, getStoreService} from './amp-story-store-service';\nimport {StoryAnalyticsEvent, getAnalyticsService} from './story-analytics';\nimport {getAmpdoc} from '../../../src/service';\nimport {htmlFor} from '../../../src/static-template';\n\n/**\n * Links that are affiliate links.\n * @const {string}\n */\nexport const AFFILIATE_LINK_SELECTOR = 'a[affiliate-link-icon]';\n\n/**\n * Custom property signifying a built link.\n * @const {string}\n */\nexport const AFFILIATE_LINK_BUILT = '__AMP_AFFILIATE_LINK_BUILT';\n\nexport class AmpStoryAffiliateLink {\n  /**\n   * @param {!Window} win\n   * @param {!Element} element\n   */\n  constructor(win, element) {\n    /** @private {!Window} */\n    this.win_ = win;\n\n    /** @private {!Element} */\n    this.element_ = element;\n\n    /** @private {?Element} */\n    this.textEl_ = null;\n\n    /** @private {?Element} */\n    this.launchEl_ = null;\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win_);\n\n    /** @private {string} */\n    this.text_ = this.element_.textContent;\n\n    /** @private @const {!../../../src/service/mutator-interface.MutatorInterface} */\n    this.mutator_ = Services.mutatorForDoc(getAmpdoc(this.win_.document));\n\n    /** @private @const {!./story-analytics.StoryAnalyticsService} */\n    this.analyticsService_ = getAnalyticsService(this.win_, element);\n  }\n\n  /**\n   * Builds affiliate link.\n   */\n  build() {\n    if (this.element_[AFFILIATE_LINK_BUILT]) {\n      return;\n    }\n\n    this.mutator_.mutateElement(this.element_, () => {\n      this.element_.textContent = '';\n      this.element_.setAttribute('pristine', '');\n      this.addPulseElement_();\n      this.addIconElement_();\n      this.addText_();\n      this.addLaunchElement_();\n    });\n\n    this.initializeListeners_();\n    this.element_[AFFILIATE_LINK_BUILT] = true;\n  }\n\n  /**\n   * Initializes listeners.\n   * @private\n   */\n  initializeListeners_() {\n    this.storeService_.subscribe(\n      StateProperty.AFFILIATE_LINK_STATE,\n      (elementToToggleExpand) => {\n        const expand = this.element_ === elementToToggleExpand;\n        if (expand) {\n          this.element_.setAttribute('expanded', '');\n          this.textEl_.removeAttribute('hidden');\n          this.launchEl_.removeAttribute('hidden');\n        } else {\n          this.element_.removeAttribute('expanded');\n          this.textEl_.setAttribute('hidden', '');\n          this.launchEl_.setAttribute('hidden', '');\n        }\n        if (expand) {\n          this.element_.removeAttribute('pristine');\n          this.analyticsService_.triggerEvent(\n            StoryAnalyticsEvent.FOCUS,\n            this.element_\n          );\n        }\n      }\n    );\n\n    this.element_.addEventListener('click', (event) => {\n      if (this.element_.hasAttribute('expanded')) {\n        event.stopPropagation();\n        this.analyticsService_.triggerEvent(\n          StoryAnalyticsEvent.CLICK_THROUGH,\n          this.element_\n        );\n      }\n    });\n  }\n\n  /**\n   * Adds icon as a child element of <amp-story-affiliate-link>.\n   * @private\n   */\n  addIconElement_() {\n    const iconEl = htmlFor(this.element_)`\n      <div class=\"i-amphtml-story-affiliate-link-circle\">\n        <i class=\"i-amphtml-story-affiliate-link-icon\"></i>\n        <div class=\"i-amphtml-story-reset i-amphtml-hidden\">\n          <span class=\"i-amphtml-story-affiliate-link-text\" hidden></span>\n          <i class=\"i-amphtml-story-affiliate-link-launch\" hidden></i>\n        </div>\n      </div>`;\n    this.element_.appendChild(iconEl);\n  }\n\n  /**\n   * Adds text from <a> tag to expanded link.\n   * @private\n   */\n  addText_() {\n    this.textEl_ = this.element_.querySelector(\n      '.i-amphtml-story-affiliate-link-text'\n    );\n\n    this.textEl_.textContent = this.text_;\n    this.textEl_.setAttribute('hidden', '');\n  }\n\n  /**\n   * Adds launch arrow to expanded link.\n   * @private\n   */\n  addLaunchElement_() {\n    this.launchEl_ = this.element_.querySelector(\n      '.i-amphtml-story-affiliate-link-launch'\n    );\n\n    this.launchEl_.setAttribute('hidden', '');\n  }\n\n  /**\n   * Adds pulse as a child element of <amp-story-affiliate-link>.\n   * @private\n   */\n  addPulseElement_() {\n    const pulseEl = htmlFor(this.element_)`\n      <div class=\"i-amphtml-story-affiliate-link-pulse\"></div>`;\n    this.element_.appendChild(pulseEl);\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../assert';\n\n/**\n * Key string in an action arguments map for an unparsed object literal string.\n *\n * E.g. for the action in <p on=\"tap:AMP.setState({foo: 'bar'})\",\n * then `args[RAW_OBJECT_ARGS_KEY]` is the string \"{foo: 'bar'}\".\n *\n * The action service delegates parsing of object literals to the corresponding\n * extension (in the example above, amp-bind).\n *\n * @see ./service/action-impl.ActionInfoDef\n * @const {string}\n */\nexport const RAW_OBJECT_ARGS_KEY = '__AMP_OBJECT_STRING__';\n\n/**\n * Identifier for an element's default action.\n *\n * @const {string}\n */\nexport const DEFAULT_ACTION = 'activate';\n\n/**\n * Corresponds to degree of user intent, i.e. events triggered with strong\n * user intent have high trust.\n *\n * @enum {number}\n */\nexport const ActionTrust = {\n  /**\n   * Events that are triggered without a user gesture, or triggered by a user\n   * gesture with weak intent (e.g. scroll) are \"low trust\".\n   *\n   * Actions that have low impact on the page's visual state should require\n   * \"low trust\" (e.g. pausing a video).\n   */\n  LOW: 1,\n  /**\n   * Events that are triggered nearly immediately (up to a few seconds) after\n   * a user gesture with strong intent (e.g. tap or swipe) are \"default trust\".\n   *\n   * Actions that can modify the page's visual state (e.g. content jumping)\n   * should require \"default trust\". This is the default required trust level\n   * for actions.\n   */\n  DEFAULT: 2,\n  /**\n   * Events that are triggered immediately after a user gesture with\n   * strong intent (e.g. tap or swipe) are \"high trust\".\n   *\n   * There are no actions yet that require high trust.\n   */\n  HIGH: 3,\n};\n\n/**\n * @param {!ActionTrust} actionTrust\n * @return {string}\n */\nexport function actionTrustToString(actionTrust) {\n  switch (actionTrust) {\n    case ActionTrust.LOW:\n      return 'low';\n    case ActionTrust.HIGH:\n      return 'high';\n    default:\n      devAssert(actionTrust === ActionTrust.DEFAULT);\n      return 'default';\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @enum {number}\n */\nexport const KeyCodes = {\n  ENTER: 13,\n  ESCAPE: 27,\n  SPACE: 32,\n  LEFT_ARROW: 37,\n  UP_ARROW: 38,\n  RIGHT_ARROW: 39,\n  DOWN_ARROW: 40,\n};\n\n/**\n * @enum {string}\n */\nexport const Keys = {\n  ENTER: 'Enter',\n  ESCAPE: 'Escape',\n  SPACE: ' ',\n  LEFT_ARROW: 'ArrowLeft',\n  UP_ARROW: 'ArrowUp',\n  RIGHT_ARROW: 'ArrowRight',\n  DOWN_ARROW: 'ArrowDown',\n  TAB: 'Tab',\n  BACKSPACE: 'Backspace',\n  HOME: 'Home',\n  END: 'End',\n};\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether addEventListener supports options or only takes capture as a boolean\n * @type {boolean|undefined}\n * @visibleForTesting\n */\nlet optsSupported;\n\n/**\n * Whether addEventListener supports options or only takes passive as a boolean\n * @type {boolean|undefined}\n */\nlet passiveSupported;\n\n/**\n * Options supported by addEventListener\n * @typedef AddEventListenerOptsDef\n * @property {undefined|boolean} [capture]\n * @property {undefined|boolean} [once]\n * @property {undefined|boolean} [passive]\n * @property {undefined|!AbortSignal} [signal]\n * }}\n */\nlet AddEventListenerOptsDef;\n\n/**\n * Listens for the specified event on the element.\n *\n * Do not use this directly. This method is implemented as a shared\n * dependency. Use `listen()` in either `event-helper` or `3p-frame-messaging`,\n * depending on your use case.\n *\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {!AddEventListenerOptsDef=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function internalListenImplementation(\n  element,\n  eventType,\n  listener,\n  opt_evtListenerOpts\n) {\n  let localElement = element;\n  let localListener = listener;\n  /** @type {?function(!Event)} */\n  let wrapped = (event) => {\n    try {\n      return localListener(event);\n    } catch (e) {\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR?.(e);\n      throw e;\n    }\n  };\n  const optsSupported = detectEvtListenerOptsSupport();\n  const capture = !!opt_evtListenerOpts?.capture;\n\n  localElement.addEventListener(\n    eventType,\n    wrapped,\n    optsSupported ? opt_evtListenerOpts : capture\n  );\n  return () => {\n    localElement?.removeEventListener(\n      eventType,\n      wrapped,\n      optsSupported ? opt_evtListenerOpts : capture\n    );\n    // Ensure these are GC'd\n    localListener = null;\n    localElement = null;\n    wrapped = null;\n  };\n}\n\n/**\n * Tests whether the browser supports options as an argument of addEventListener\n * or not.\n *\n * @return {boolean}\n */\nexport function detectEvtListenerOptsSupport() {\n  // Only run the test once\n  if (optsSupported !== undefined) {\n    return optsSupported;\n  }\n\n  optsSupported = false;\n  try {\n    // Test whether browser supports EventListenerOptions or not\n    const options = {\n      get capture() {\n        optsSupported = true;\n      },\n    };\n    self.addEventListener('test-options', null, options);\n    self.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return optsSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports options or not.\n */\nexport function resetEvtListenerOptsSupportForTesting() {\n  optsSupported = undefined;\n}\n\n/**\n * Return boolean. if listener option is supported, return `true`.\n * if not supported, return `false`\n * @param {!Window} win\n * @return {boolean}\n */\nexport function supportsPassiveEventListener(win) {\n  if (passiveSupported !== undefined) {\n    return passiveSupported;\n  }\n\n  passiveSupported = false;\n  try {\n    const options = {\n      get passive() {\n        // This function will be called when the browser\n        // attempts to access the passive property.\n        passiveSupported = true;\n        return false;\n      },\n    };\n\n    win.addEventListener('test-options', null, options);\n    win.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return passiveSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports passive options or not.\n */\nexport function resetPassiveSupportedForTesting() {\n  passiveSupported = undefined;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalListenImplementation} from './core/dom/event-helper-listen';\nimport {lastChildElement} from './core/dom/query';\nimport {user} from './log';\n\n/** @const {string}  */\nconst LOAD_FAILURE_PREFIX = 'Failed to load:';\n\n/** @const {string} */\nexport const MEDIA_LOAD_FAILURE_SRC_PROPERTY = '__AMP_MEDIA_LOAD_FAILURE_SRC';\n\n/**\n * Returns a CustomEvent with a given type and detail; supports fallback for IE.\n * @param {!Window} win\n * @param {string} type\n * @param {!JsonObject|string|undefined|null} detail\n * @param {EventInit=} opt_eventInit\n * @return {!Event}\n */\nexport function createCustomEvent(win, type, detail, opt_eventInit) {\n  const eventInit = /** @type {!CustomEventInit} */ ({detail});\n  Object.assign(eventInit, opt_eventInit);\n  // win.CustomEvent is a function on Edge, Chrome, FF, Safari but\n  // is an object on IE 11.\n  if (IS_ESM || typeof win.CustomEvent == 'function') {\n    return new win.CustomEvent(type, eventInit);\n  } else {\n    // Deprecated fallback for IE.\n    const e = win.document.createEvent('CustomEvent');\n    e.initCustomEvent(\n      type,\n      !!eventInit.bubbles,\n      !!eventInit.cancelable,\n      detail\n    );\n    return e;\n  }\n}\n\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listen(element, eventType, listener, opt_evtListenerOpts) {\n  return internalListenImplementation(\n    element,\n    eventType,\n    listener,\n    opt_evtListenerOpts\n  );\n}\n\n/**\n * Returns the data property of an event with the correct type.\n * @param {!Event|{data: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getData(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.data);\n}\n\n/**\n * Returns the detail property of an event with the correct type.\n * @param {!Event|{detail: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getDetail(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.detail);\n}\n\n/**\n * Listens for the specified event on the element and removes the listener\n * as soon as event has been received.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listenOnce(element, eventType, listener, opt_evtListenerOpts) {\n  let localListener = listener;\n  const unlisten = internalListenImplementation(\n    element,\n    eventType,\n    (event) => {\n      try {\n        localListener(event);\n      } finally {\n        // Ensure listener is GC'd\n        localListener = null;\n        unlisten();\n      }\n    },\n    opt_evtListenerOpts\n  );\n  return unlisten;\n}\n\n/**\n * Returns  a promise that will resolve as soon as the specified event has\n * fired on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {Object=} opt_evtListenerOpts\n * @param {function(!UnlistenDef)=} opt_cancel An optional function that, when\n *     provided, will be called with the unlistener. This gives the caller\n *     access to the unlistener, so it may be called manually when necessary.\n * @return {!Promise<!Event>}\n */\nexport function listenOncePromise(\n  element,\n  eventType,\n  opt_evtListenerOpts,\n  opt_cancel\n) {\n  let unlisten;\n  const eventPromise = new Promise((resolve) => {\n    unlisten = listenOnce(element, eventType, resolve, opt_evtListenerOpts);\n  });\n  eventPromise.then(unlisten, unlisten);\n  if (opt_cancel) {\n    opt_cancel(unlisten);\n  }\n  return eventPromise;\n}\n\n/**\n * Whether the specified element/window has been loaded already.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nexport function isLoaded(eleOrWindow) {\n  return !!(\n    eleOrWindow.complete ||\n    eleOrWindow.readyState == 'complete' ||\n    (isHTMLMediaElement(eleOrWindow) && eleOrWindow.readyState > 0) ||\n    // If the passed in thing is a Window, infer loaded state from\n    //\n    (eleOrWindow.document && eleOrWindow.document.readyState == 'complete')\n  );\n}\n\n/**\n * Returns a promise that will resolve or fail based on the eleOrWindow's 'load'\n * and 'error' events. Optionally this method takes a timeout, which will reject\n * the promise if the resource has not loaded by then.\n * @param {T} eleOrWindow Supports both Elements and as a special case Windows.\n * @return {!Promise<T>}\n * @template T\n */\nexport function loadPromise(eleOrWindow) {\n  let unlistenLoad;\n  let unlistenError;\n  if (isLoaded(eleOrWindow)) {\n    return Promise.resolve(eleOrWindow);\n  }\n  const isMediaElement = isHTMLMediaElement(eleOrWindow);\n  if (\n    isMediaElement &&\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] === eleOrWindow.currentSrc\n  ) {\n    return Promise.reject(eleOrWindow);\n  }\n  const loadingPromise = new Promise((resolve, reject) => {\n    // Listen once since IE 5/6/7 fire the onload event continuously for\n    // animated GIFs.\n    if (isMediaElement) {\n      // The following event can be triggered by the media or one of its\n      // sources. Using capture is required as the media events do not bubble.\n      unlistenLoad = listenOnce(eleOrWindow, 'loadedmetadata', resolve, {\n        capture: true,\n      });\n    } else {\n      unlistenLoad = listenOnce(eleOrWindow, 'load', resolve);\n    }\n    // Don't unlisten on error for Windows.\n    if (!eleOrWindow.tagName) {\n      return;\n    }\n    let errorTarget = eleOrWindow;\n    // If the media element has no `src`, it will try to load the sources in\n    // document order. If the last source errors, then the media element\n    // loading errored.\n    if (isMediaElement && !eleOrWindow.hasAttribute('src')) {\n      errorTarget = lastChildElement(\n        eleOrWindow,\n        (child) => child.tagName === 'SOURCE'\n      );\n      if (!errorTarget) {\n        return reject(new Error('Media has no source.'));\n      }\n    }\n    unlistenError = listenOnce(errorTarget, 'error', reject);\n  });\n\n  return loadingPromise.then(\n    () => {\n      if (unlistenError) {\n        unlistenError();\n      }\n      return eleOrWindow;\n    },\n    () => {\n      if (unlistenLoad) {\n        unlistenLoad();\n      }\n      failedToLoad(eleOrWindow);\n    }\n  );\n}\n\n/**\n * Emit error on load failure.\n * @param {!Element|!Window} eleOrWindow Supports both Elements and as a special\n *     case Windows.\n */\nfunction failedToLoad(eleOrWindow) {\n  // Mark the element as errored since some elements - like HTMLMediaElement\n  // using HTMLSourceElement - do not provide any synchronous way to verify if\n  // they already errored, even though the error event was already dispatched.\n  if (isHTMLMediaElement(eleOrWindow)) {\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] =\n      eleOrWindow.currentSrc || true;\n  }\n\n  // Report failed loads as user errors so that they automatically go\n  // into the \"document error\" bucket.\n  let target = eleOrWindow;\n  if (target && target.src) {\n    target = target.src;\n  }\n  throw user().createError(LOAD_FAILURE_PREFIX, target);\n}\n\n/**\n * Returns true if the parameter is a HTMLMediaElement.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nfunction isHTMLMediaElement(eleOrWindow) {\n  return eleOrWindow.tagName === 'AUDIO' || eleOrWindow.tagName === 'VIDEO';\n}\n\n/**\n * Returns true if this error message is was created for a load error.\n * @param {string} message An error message\n * @return {boolean}\n */\nexport function isLoadErrorMessage(message) {\n  return message.indexOf(LOAD_FAILURE_PREFIX) != -1;\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Common AMP events.\n * @enum {string}\n */\nexport const AmpEvents = {\n  DOM_UPDATE: 'amp:dom-update',\n  FORM_DIRTINESS_CHANGE: 'amp:form-dirtiness-change',\n  FORM_VALUE_CHANGE: 'amp:form-value-change',\n  VISIBILITY_CHANGE: 'amp:visibilitychange', // https://github.com/ampproject/amphtml/blob/main/ads/README.md#page-visibility\n  // The following codes are only used for testing.\n  // TODO(choumx): Move these to a separate enum so they can be DCE'd.\n  ATTACHED: 'amp:attached',\n  STUBBED: 'amp:stubbed',\n  LOAD_START: 'amp:load-start',\n  LOAD_END: 'amp:load-end',\n  ERROR: 'amp:error',\n  SIZE_CHANGED: 'amp:size-changed',\n  UNLOAD: 'amp:unload',\n};\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {map} from '../types/object';\n\n/**\n * @template T\n */\nexport class LruCache {\n  /**\n   * @param {number} capacity\n   */\n  constructor(capacity) {\n    /** @private @const {number} */\n    this.capacity_ = capacity;\n\n    /** @private {number} */\n    this.size_ = 0;\n\n    /**\n     * An incrementing counter to define the last access.\n     * @private {number}\n     */\n    this.access_ = 0;\n\n    /** @private {!Object<(number|string), {payload: T, access: number}>} */\n    this.cache_ = map();\n  }\n\n  /**\n   * Returns whether key is cached.\n   *\n   * @param {number|string} key\n   * @return {boolean}\n   */\n  has(key) {\n    return !!this.cache_[key];\n  }\n\n  /**\n   * @param {number|string} key\n   * @return {T} The cached payload.\n   */\n  get(key) {\n    const cacheable = this.cache_[key];\n    if (cacheable) {\n      cacheable.access = ++this.access_;\n      return cacheable.payload;\n    }\n    return undefined;\n  }\n\n  /**\n   * @param {number|string} key\n   * @param {T} payload The payload to cache.\n   */\n  put(key, payload) {\n    if (!this.has(key)) {\n      this.size_++;\n    }\n    this.cache_[key] = {payload, access: this.access_};\n    this.evict_();\n  }\n\n  /**\n   * Evicts the oldest cache entry, if we've exceeded capacity.\n   */\n  evict_() {\n    if (this.size_ <= this.capacity_) {\n      return;\n    }\n\n    const cache = this.cache_;\n    let oldest = this.access_ + 1;\n    let oldestKey;\n    for (const key in cache) {\n      const {access} = cache[key];\n      if (access < oldest) {\n        oldest = access;\n        oldestKey = key;\n      }\n    }\n\n    if (oldestKey !== undefined) {\n      delete cache[oldestKey];\n      this.size_--;\n    }\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {LruCache} from './core/data-structures/lru-cache';\nimport {dict, hasOwn} from './core/types/object';\nimport {endsWith} from './core/types/string';\nimport {getMode} from './mode';\nimport {isArray} from './core/types';\nimport {parseQueryString} from './core/types/string/url';\nimport {urls} from './config';\nimport {userAssert} from './log';\n\n/**\n * @type {!JsonObject}\n */\nconst SERVING_TYPE_PREFIX = dict({\n  // No viewer\n  'c': true,\n  // In viewer\n  'v': true,\n  // Ad landing page\n  'a': true,\n  // Ad\n  'ad': true,\n});\n\n/**\n * Cached a-tag to avoid memory allocation during URL parsing.\n * @type {HTMLAnchorElement}\n */\nlet a;\n\n/**\n * We cached all parsed URLs. As of now there are no use cases\n * of AMP docs that would ever parse an actual large number of URLs,\n * but we often parse the same one over and over again.\n * @type {LruCache}\n */\nlet cache;\n\n/** @private @const Matches amp_js_* parameters in query string. */\nconst AMP_JS_PARAMS_REGEX = /[?&]amp_js[^&]*/;\n\n/** @private @const Matches amp_gsa parameters in query string. */\nconst AMP_GSA_PARAMS_REGEX = /[?&]amp_gsa[^&]*/;\n\n/** @private @const Matches amp_r parameters in query string. */\nconst AMP_R_PARAMS_REGEX = /[?&]amp_r[^&]*/;\n\n/** @private @const Matches amp_kit parameters in query string. */\nconst AMP_KIT_PARAMS_REGEX = /[?&]amp_kit[^&]*/;\n\n/** @private @const Matches usqp parameters from goog experiment in query string. */\nconst GOOGLE_EXPERIMENT_PARAMS_REGEX = /[?&]usqp[^&]*/;\n\nconst INVALID_PROTOCOLS = [\n  /*eslint no-script-url: 0*/ 'javascript:',\n  /*eslint no-script-url: 0*/ 'data:',\n  /*eslint no-script-url: 0*/ 'vbscript:',\n];\n\n/** @const {string} */\nexport const SOURCE_ORIGIN_PARAM = '__amp_source_origin';\n\n/**\n * Returns the correct origin for a given window.\n * @param {!Window} win\n * @return {string} origin\n */\nexport function getWinOrigin(win) {\n  return win.origin || parseUrlDeprecated(win.location.href).origin;\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {string} url\n * @param {boolean=} opt_nocache\n *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n * @return {!Location}\n */\nexport function parseUrlDeprecated(url, opt_nocache) {\n  if (!a) {\n    a = /** @type {!HTMLAnchorElement} */ (self.document.createElement('a'));\n    cache = IS_ESM\n      ? null\n      : self.__AMP_URL_CACHE || (self.__AMP_URL_CACHE = new LruCache(100));\n  }\n\n  return parseUrlWithA(a, url, IS_ESM || opt_nocache ? null : cache);\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {!HTMLAnchorElement} a\n * @param {string} url\n * @param {LruCache=} opt_cache\n *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n * @return {!Location}\n * @restricted\n */\nexport function parseUrlWithA(a, url, opt_cache) {\n  if (IS_ESM) {\n    a.href = '';\n    return /** @type {?} */ (new URL(url, a.href));\n  }\n\n  if (opt_cache && opt_cache.has(url)) {\n    return opt_cache.get(url);\n  }\n\n  a.href = url;\n\n  // IE11 doesn't provide full URL components when parsing relative URLs.\n  // Assigning to itself again does the trick #3449.\n  if (!a.protocol) {\n    a.href = a.href;\n  }\n\n  const info = /** @type {!Location} */ ({\n    href: a.href,\n    protocol: a.protocol,\n    host: a.host,\n    hostname: a.hostname,\n    port: a.port == '0' ? '' : a.port,\n    pathname: a.pathname,\n    search: a.search,\n    hash: a.hash,\n    origin: null, // Set below.\n  });\n\n  // Some IE11 specific polyfills.\n  // 1) IE11 strips out the leading '/' in the pathname.\n  if (info.pathname[0] !== '/') {\n    info.pathname = '/' + info.pathname;\n  }\n\n  // 2) For URLs with implicit ports, IE11 parses to default ports while\n  // other browsers leave the port field empty.\n  if (\n    (info.protocol == 'http:' && info.port == 80) ||\n    (info.protocol == 'https:' && info.port == 443)\n  ) {\n    info.port = '';\n    info.host = info.hostname;\n  }\n\n  // For data URI a.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n  let origin;\n  if (a.origin && a.origin != 'null') {\n    origin = a.origin;\n  } else if (info.protocol == 'data:' || !info.host) {\n    origin = info.href;\n  } else {\n    origin = info.protocol + '//' + info.host;\n  }\n  info.origin = origin;\n\n  // Freeze during testing to avoid accidental mutation.\n  const frozen = getMode().test && Object.freeze ? Object.freeze(info) : info;\n\n  if (opt_cache) {\n    opt_cache.put(url, frozen);\n  }\n\n  return frozen;\n}\n\n/**\n * Appends the string just before the fragment part (or optionally\n * to the front of the query string) of the URL.\n * @param {string} url\n * @param {string} paramString\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function appendEncodedParamStringToUrl(\n  url,\n  paramString,\n  opt_addToFront\n) {\n  if (!paramString) {\n    return url;\n  }\n  const mainAndFragment = url.split('#', 2);\n  const mainAndQuery = mainAndFragment[0].split('?', 2);\n\n  let newUrl =\n    mainAndQuery[0] +\n    (mainAndQuery[1]\n      ? opt_addToFront\n        ? `?${paramString}&${mainAndQuery[1]}`\n        : `?${mainAndQuery[1]}&${paramString}`\n      : `?${paramString}`);\n  newUrl += mainAndFragment[1] ? `#${mainAndFragment[1]}` : '';\n  return newUrl;\n}\n/**\n * Appends a query string field and value to a url. `key` and `value`\n * will be ran through `encodeURIComponent` before appending.\n * @param {string} url\n * @param {string} key\n * @param {string} value\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function addParamToUrl(url, key, value, opt_addToFront) {\n  const field = `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;\n  return appendEncodedParamStringToUrl(url, field, opt_addToFront);\n}\n\n/**\n * Appends query string fields and values to a url. The `params` objects'\n * `key`s and `value`s will be transformed into query string keys/values.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addParamsToUrl(url, params) {\n  return appendEncodedParamStringToUrl(url, serializeQueryString(params));\n}\n\n/**\n * Append query string fields and values to a url, only if the key does not\n * exist in current query string.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addMissingParamsToUrl(url, params) {\n  const location = parseUrlDeprecated(url);\n  const existingParams = parseQueryString(location.search);\n  const paramsToAdd = dict({});\n  const keys = Object.keys(params);\n  for (let i = 0; i < keys.length; i++) {\n    if (!hasOwn(existingParams, keys[i])) {\n      paramsToAdd[keys[i]] = params[keys[i]];\n    }\n  }\n  return addParamsToUrl(url, paramsToAdd);\n}\n\n/**\n * Serializes the passed parameter map into a query string with both keys\n * and values encoded.\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function serializeQueryString(params) {\n  const s = [];\n  for (const k in params) {\n    const v = params[k];\n    if (v == null) {\n      continue;\n    } else if (isArray(v)) {\n      for (let i = 0; i < v.length; i++) {\n        const sv = /** @type {string} */ (v[i]);\n        s.push(`${encodeURIComponent(k)}=${encodeURIComponent(sv)}`);\n      }\n    } else {\n      const sv = /** @type {string} */ (v);\n      s.push(`${encodeURIComponent(k)}=${encodeURIComponent(sv)}`);\n    }\n  }\n  return s.join('&');\n}\n\n/**\n * Returns `true` if the URL is secure: either HTTPS or localhost (for testing).\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isSecureUrlDeprecated(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return (\n    url.protocol == 'https:' ||\n    url.hostname == 'localhost' ||\n    url.hostname == '127.0.0.1' ||\n    endsWith(url.hostname, '.localhost')\n  );\n}\n\n/**\n * Asserts that a given url is HTTPS or protocol relative. It's a user-level\n * assert.\n *\n * Provides an exception for localhost.\n *\n * @param {?string|undefined} urlString\n * @param {!Element|string} elementContext Element where the url was found.\n * @param {string=} sourceName Used for error messages.\n * @return {string}\n */\nexport function assertHttpsUrl(\n  urlString,\n  elementContext,\n  sourceName = 'source'\n) {\n  userAssert(\n    urlString != null,\n    '%s %s must be available',\n    elementContext,\n    sourceName\n  );\n  // (erwinm, #4560): type cast necessary until #4560 is fixed.\n  const theUrlString = /** @type {string} */ (urlString);\n  userAssert(\n    isSecureUrlDeprecated(theUrlString) || /^(\\/\\/)/.test(theUrlString),\n    '%s %s must start with ' +\n      '\"https://\" or \"//\" or be relative and served from ' +\n      'either https or from localhost. Invalid value: %s',\n    elementContext,\n    sourceName,\n    theUrlString\n  );\n  return theUrlString;\n}\n\n/**\n * Asserts that a given url is an absolute HTTP or HTTPS URL.\n * @param {string} urlString\n * @return {string}\n */\nexport function assertAbsoluteHttpOrHttpsUrl(urlString) {\n  userAssert(\n    /^https?\\:/i.test(urlString),\n    'URL must start with \"http://\" or \"https://\". Invalid value: %s',\n    urlString\n  );\n  return parseUrlDeprecated(urlString).href;\n}\n\n/**\n * Returns the URL without fragment. If URL doesn't contain fragment, the same\n * string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function removeFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return url;\n  }\n  return url.substring(0, index);\n}\n\n/**\n * Returns the fragment from the URL. If the URL doesn't contain fragment,\n * the empty string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function getFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return '';\n  }\n  return url.substring(index);\n}\n\n/**\n * Returns whether the URL has the origin of a proxy.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isProxyOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return urls.cdnProxyRegex.test(url.origin);\n}\n\n/**\n * @param {string} uri\n * @return {boolean}\n */\nexport function isAmpScriptUri(uri) {\n  return uri.startsWith('amp-script:');\n}\n\n/**\n * For proxy-origin URLs, returns the serving type. Otherwise, returns null.\n * E.g., 'https://amp-com.cdn.ampproject.org/a/s/amp.com/amp_document.html'\n * returns 'a'.\n * @param {string|!Location} url URL of an AMP document.\n * @return {?string}\n */\nexport function getProxyServingType(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  if (!isProxyOrigin(url)) {\n    return null;\n  }\n  const path = url.pathname.split('/', 2);\n  return path[1];\n}\n\n/**\n * Returns whether the URL origin is localhost.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isLocalhostOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return urls.localhostRegex.test(url.origin);\n}\n\n/**\n * Returns whether the URL has valid protocol.\n * Deep link protocol is valid, but not javascript etc.\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isProtocolValid(url) {\n  if (!url) {\n    return true;\n  }\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return !INVALID_PROTOCOLS.includes(url.protocol);\n}\n\n/**\n * Returns a URL without AMP JS parameters.\n * @param {string} url\n * @return {string}\n */\nexport function removeAmpJsParamsFromUrl(url) {\n  const parsed = parseUrlDeprecated(url);\n  const search = removeAmpJsParamsFromSearch(parsed.search);\n  return parsed.origin + parsed.pathname + search + parsed.hash;\n}\n\n/**\n * Returns a URL without a query string.\n * @param {string} url\n * @return {string}\n */\nexport function removeSearch(url) {\n  const index = url.indexOf('?');\n  if (index == -1) {\n    return url;\n  }\n  const fragment = getFragment(url);\n  return url.substring(0, index) + fragment;\n}\n\n/**\n * Removes parameters that start with amp js parameter pattern and returns the\n * new search string.\n * @param {string} urlSearch\n * @return {string}\n */\nfunction removeAmpJsParamsFromSearch(urlSearch) {\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const search = urlSearch\n    .replace(AMP_JS_PARAMS_REGEX, '')\n    .replace(AMP_GSA_PARAMS_REGEX, '')\n    .replace(AMP_R_PARAMS_REGEX, '')\n    .replace(AMP_KIT_PARAMS_REGEX, '')\n    .replace(GOOGLE_EXPERIMENT_PARAMS_REGEX, '')\n    .replace(/^[?&]/, ''); // Removes first ? or &.\n  return search ? '?' + search : '';\n}\n\n/**\n * Removes parameters with param name and returns the new search string.\n * @param {string} urlSearch\n * @param {string} paramName\n * @return {string}\n */\nexport function removeParamsFromSearch(urlSearch, paramName) {\n  // TODO: reuse the function in removeAmpJsParamsFromSearch. Accept paramNames\n  // as an array.\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const paramRegex = new RegExp(`[?&]${paramName}=[^&]*`, 'g');\n  const search = urlSearch.replace(paramRegex, '').replace(/^[?&]/, '');\n  return search ? '?' + search : '';\n}\n\n/**\n * Returns the source URL of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string}\n */\nexport function getSourceUrl(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n\n  // Not a proxy URL - return the URL itself.\n  if (!isProxyOrigin(url)) {\n    return url.href;\n  }\n\n  // A proxy URL.\n  // Example path that is being matched here.\n  // https://cdn.ampproject.org/c/s/www.origin.com/foo/\n  // The /s/ is optional and signals a secure origin.\n  const path = url.pathname.split('/');\n  const prefix = path[1];\n  userAssert(\n    SERVING_TYPE_PREFIX[prefix],\n    'Unknown path prefix in url %s',\n    url.href\n  );\n  const domainOrHttpsSignal = path[2];\n  const origin =\n    domainOrHttpsSignal == 's'\n      ? 'https://' + decodeURIComponent(path[3])\n      : 'http://' + decodeURIComponent(domainOrHttpsSignal);\n  // Sanity test that what we found looks like a domain.\n  userAssert(origin.indexOf('.') > 0, 'Expected a . in origin %s', origin);\n  path.splice(1, domainOrHttpsSignal == 's' ? 3 : 2);\n  return (\n    origin +\n    path.join('/') +\n    removeAmpJsParamsFromSearch(url.search) +\n    (url.hash || '')\n  );\n}\n\n/**\n * Returns the source origin of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string} The source origin of the URL.\n */\nexport function getSourceOrigin(url) {\n  return parseUrlDeprecated(getSourceUrl(url)).origin;\n}\n\n/**\n * Returns absolute URL resolved based on the relative URL and the base.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n */\nexport function resolveRelativeUrl(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n  if (IS_ESM || typeof URL == 'function') {\n    return new URL(relativeUrlString, baseUrl.href).toString();\n  }\n  return resolveRelativeUrlFallback_(relativeUrlString, baseUrl);\n}\n\n/**\n * Fallback for URL resolver when URL class is not available.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n * @private @visibleForTesting\n */\nexport function resolveRelativeUrlFallback_(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n  relativeUrlString = relativeUrlString.replace(/\\\\/g, '/');\n  const relativeUrl = parseUrlDeprecated(relativeUrlString);\n\n  // Absolute URL.\n  if (relativeUrlString.toLowerCase().startsWith(relativeUrl.protocol)) {\n    return relativeUrl.href;\n  }\n\n  // Protocol-relative URL.\n  if (relativeUrlString.startsWith('//')) {\n    return baseUrl.protocol + relativeUrlString;\n  }\n\n  // Absolute path.\n  if (relativeUrlString.startsWith('/')) {\n    return baseUrl.origin + relativeUrlString;\n  }\n\n  // Relative path.\n  return (\n    baseUrl.origin +\n    baseUrl.pathname.replace(/\\/[^/]*$/, '/') +\n    relativeUrlString\n  );\n}\n\n/**\n * Add \"__amp_source_origin\" query parameter to the URL.\n * @param {!Window} win\n * @param {string} url\n * @return {string}\n */\nexport function getCorsUrl(win, url) {\n  checkCorsUrl(url);\n  const sourceOrigin = getSourceOrigin(win.location.href);\n  return addParamToUrl(url, SOURCE_ORIGIN_PARAM, sourceOrigin);\n}\n\n/**\n * Checks if the url has __amp_source_origin and throws if it does.\n * @param {string} url\n */\nexport function checkCorsUrl(url) {\n  const parsedUrl = parseUrlDeprecated(url);\n  const query = parseQueryString(parsedUrl.search);\n  userAssert(\n    !(SOURCE_ORIGIN_PARAM in query),\n    'Source origin is not allowed in %s',\n    url\n  );\n}\n\n/**\n * Adds the path to the given url.\n *\n * @param {!Location} url\n * @param {string} path\n * @return {string}\n */\nexport function appendPathToUrl(url, path) {\n  const pathname = url.pathname.replace(/\\/?$/, '/') + path.replace(/^\\//, '');\n  return url.origin + pathname + url.search + url.hash;\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Commonly used signals across different elements and documents.\n * @enum {string}\n */\nexport const CommonSignals = {\n  /**\n   * The element's implementation has been registered and ready for upgrade.\n   */\n  READY_TO_UPGRADE: 'ready-upgrade',\n\n  /**\n   * The element has been upgraded from ElementStub to its real implementation.\n   */\n  UPGRADED: 'upgraded',\n\n  /**\n   * The element has been built.\n   */\n  BUILT: 'built',\n\n  /**\n   * The element has been mounted.\n   */\n  MOUNTED: 'mounted',\n\n  /**\n   * The element has started loading.\n   * LOAD_START triggers at the start of the layoutCallback.\n   */\n  LOAD_START: 'load-start',\n\n  /**\n   * Rendering has been confirmed to have been started.\n   * It is a signal to indicate meaningful display (e.g. text could be displayed\n   * CSS is correctly installed/applied).\n   *\n   * Elements can optionally implement RENDER_START signal. (e.g. ad, shadowdoc)\n   * if it want to define its own meaningful display time and toggle visibility.\n   *\n   * Simpler elements's RENDER_START can be equal to the start of the\n   * buildCallback\n   */\n  RENDER_START: 'render-start',\n\n  /**\n   * The element has been loaded.\n   * LOAD_END triggers at the end of the layoutCallback.\n   *\n   */\n  LOAD_END: 'load-end',\n\n  /**\n   * The initial contents of an element/document/embed have been loaded.\n   * INI_LOAD is an optional signal, implemented by ads, story, and elements\n   * that consist of other resources.\n   * It instructs that all critical resources has been loaded, and can be used\n   * for more accurate visibility measurement.\n   * When an element doesn't consist multiple child resources, LOAD_END signal\n   * can be used to indicate resource load completion.\n   * Note: Based on the implementation, INI_LOAD can trigger before or after\n   * LOAD_END.\n   */\n  INI_LOAD: 'ini-load',\n\n  /**\n   * The element has been unlaid out.\n   */\n  UNLOAD: 'unload',\n};\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Registred singleton on AMP doc.\n * @enum {number}\n */\nexport const AMPDOC_SINGLETON_NAME = {\n  TRACKING_IFRAME: 1,\n  LINKER: 2,\n};\n\n/**\n * Enum for tick labels (used by Performance service)\n * @enum {string}\n */\nexport const TickLabel = {\n  ACCESS_AUTHORIZATION: 'aaa',\n  ACCESS_AUTHORIZATION_VISIBLE: 'aaav',\n  ADS_LAYOUT_DELAY: 'adld',\n  BAD_FRAMES: 'bf',\n  BATTERY_DROP: 'bd',\n  CONTENT_LAYOUT_DELAY: 'cld',\n  CUMULATIVE_LAYOUT_SHIFT: 'cls',\n  CUMULATIVE_LAYOUT_SHIFT_2: 'cls-2',\n  // TODO(#33207): Remove after data collection\n  CUMULATIVE_LAYOUT_SHIFT_BEFORE_FCP: 'cls-fcp',\n  CUMULATIVE_LAYOUT_SHIFT_BEFORE_VISIBLE: 'cls-ofv',\n  DOCUMENT_READY: 'dr',\n  END_INSTALL_STYLES: 'e_is',\n  FIRST_CONTENTFUL_PAINT: 'fcp',\n  FIRST_CONTENTFUL_PAINT_VISIBLE: 'fcpv',\n  FIRST_PAINT: 'fp',\n  FIRST_INPUT_DELAY: 'fid',\n  FIRST_INPUT_DELAY_POLYFILL: 'fid-polyfill',\n  FIRST_VIEWPORT_READY: 'pc',\n  GOOD_FRAME_PROBABILITY: 'gfp',\n  INSTALL_STYLES: 'is',\n  LARGEST_CONTENTFUL_PAINT_VISIBLE: 'lcpv',\n  LARGEST_CONTENTFUL_PAINT_LOAD: 'lcpl',\n  LARGEST_CONTENTFUL_PAINT_RENDER: 'lcpr',\n  LONG_TASKS_CHILD: 'ltc',\n  LONG_TASKS_SELF: 'lts',\n  MAKE_BODY_VISIBLE: 'mbv',\n  MESSAGING_READY: 'msr',\n  ON_FIRST_VISIBLE: 'ofv',\n  ON_LOAD: 'ol',\n  TIME_ORIGIN: 'timeOrigin',\n  VIDEO_CACHE_STATE: 'vcs',\n  VIDEO_ERROR: 'verr',\n  VIDEO_ON_FIRST_PAGE: 'vofp',\n  VIDEO_JOINT_LATENCY: 'vjl',\n  VIDEO_MEAN_TIME_BETWEEN_REBUFFER: 'vmtbrb',\n  VIDEO_REBUFFERS: 'vrb',\n  VIDEO_REBUFFER_RATE: 'vrbr',\n  VIDEO_WATCH_TIME: 'vwt',\n};\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CommonSignals} from './core/constants/common-signals';\nimport {Services} from './services';\nimport {TickLabel} from './core/constants/enums';\nimport {dev, devAssert} from './log';\nimport {getAmpdoc} from './service';\nimport {insertAfterOrAtStart, waitForBodyOpenPromise} from './dom';\nimport {map} from './core/types/object';\nimport {rethrowAsync} from './core/error';\nimport {setStyles} from './style';\nimport {waitForServices} from './render-delaying-services';\n\nconst TRANSFORMER_PROP = '__AMP_CSS_TR';\nconst STYLE_MAP_PROP = '__AMP_CSS_SM';\n\n/**\n * Adds the given css text to the given ampdoc.\n *\n * The style tags will be at the beginning of the head before all author\n * styles. One element can be the main runtime CSS. This is guaranteed\n * to always be the first stylesheet in the doc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc The ampdoc that should get the new styles.\n * @param {string} cssText\n * @param {?function(!Element)|undefined} cb Called when the new styles are available.\n *     Not using a promise, because this is synchronous when possible.\n *     for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n * @param {string=} opt_ext\n * @return {!Element}\n */\nexport function installStylesForDoc(\n  ampdoc,\n  cssText,\n  cb,\n  opt_isRuntimeCss,\n  opt_ext\n) {\n  const cssRoot = ampdoc.getHeadNode();\n  const style = insertStyleElement(\n    cssRoot,\n    maybeTransform(cssRoot, cssText),\n    opt_isRuntimeCss || false,\n    opt_ext || null\n  );\n\n  if (cb) {\n    const rootNode = ampdoc.getRootNode();\n    // Styles aren't always available synchronously. E.g. if there is a\n    // pending style download, it will have to finish before the new\n    // style is visible.\n    // For this reason we poll until the style becomes available.\n    // Sync case.\n    if (styleLoaded(rootNode, style)) {\n      cb(style);\n      return style;\n    }\n    // Poll until styles are available.\n    const interval = setInterval(() => {\n      if (styleLoaded(rootNode, style)) {\n        clearInterval(interval);\n        cb(style);\n      }\n    }, 4);\n  }\n  return style;\n}\n\n/**\n * Creates the properly configured style element.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @param {boolean} isRuntimeCss\n * @param {?string} ext\n * @return {!Element}\n */\nfunction insertStyleElement(cssRoot, cssText, isRuntimeCss, ext) {\n  let styleMap = cssRoot[STYLE_MAP_PROP];\n  if (!styleMap) {\n    styleMap = cssRoot[STYLE_MAP_PROP] = map();\n  }\n\n  const isExtCss =\n    !isRuntimeCss && ext && ext != 'amp-custom' && ext != 'amp-keyframes';\n  const key = isRuntimeCss\n    ? 'amp-runtime'\n    : isExtCss\n    ? `amp-extension=${ext}`\n    : null;\n\n  // Check if it has already been created or discovered.\n  if (key) {\n    const existing = getExistingStyleElement(cssRoot, styleMap, key);\n    if (existing) {\n      if (existing.textContent !== cssText) {\n        existing.textContent = cssText;\n      }\n      return existing;\n    }\n  }\n\n  // Create the new style element and append to cssRoot.\n  const doc = cssRoot.ownerDocument || cssRoot;\n  const style = doc.createElement('style');\n  style./*OK*/ textContent = cssText;\n  let afterElement = null;\n  // Make sure that we place style tags after the main runtime CSS. Otherwise\n  // the order is random.\n  if (isRuntimeCss) {\n    style.setAttribute('amp-runtime', '');\n  } else if (isExtCss) {\n    style.setAttribute('amp-extension', ext || '');\n    afterElement = dev().assertElement(\n      getExistingStyleElement(cssRoot, styleMap, 'amp-runtime')\n    );\n  } else {\n    if (ext) {\n      style.setAttribute(ext, '');\n    }\n    afterElement = cssRoot.lastChild;\n  }\n  insertAfterOrAtStart(cssRoot, style, afterElement);\n  if (key) {\n    styleMap[key] = style;\n  }\n  return style;\n}\n\n/**\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {!Object<string, !Element>} styleMap\n * @param {string} key\n * @return {?Element}\n */\nfunction getExistingStyleElement(cssRoot, styleMap, key) {\n  // Already cached.\n  if (styleMap[key]) {\n    return styleMap[key];\n  }\n  // Check if the style has already been added by the server layout.\n  const existing = cssRoot./*OK*/ querySelector(`style[${key}]`);\n  if (existing) {\n    styleMap[key] = existing;\n    return existing;\n  }\n  // Nothing found.\n  return null;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {function(string):string} transformer\n */\nexport function installCssTransformer(cssRoot, transformer) {\n  cssRoot[TRANSFORMER_PROP] = transformer;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @return {string}\n */\nfunction maybeTransform(cssRoot, cssText) {\n  const transformer = cssRoot[TRANSFORMER_PROP];\n  return transformer ? transformer(cssText) : cssText;\n}\n\n/** @private {boolean} */\nlet bodyMadeVisible = false;\n\n/**\n * @param {boolean} value\n * @visibleForTesting\n */\nexport function setBodyMadeVisibleForTesting(value) {\n  bodyMadeVisible = value;\n}\n\n/**\n * Sets the document's body opacity to 1.\n * If the body is not yet available (because our script was loaded\n * synchronously), polls until it is.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisible(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  const win = /** @type {!Window} */ (doc.defaultView);\n  waitForBodyOpenPromise(doc)\n    .then(() => {\n      return waitForServices(win);\n    })\n    .catch((reason) => {\n      rethrowAsync(reason);\n      return [];\n    })\n    .then((services) => {\n      bodyMadeVisible = true;\n      if (INI_LOAD_INOB) {\n        // Force sync measurement to ensure that style recalc is complete\n        // before showing body, which would trigger FCP. This should reduce\n        // make it less likely that a CLS would be triggered after FCP.\n        doc.body./*OK*/ getBoundingClientRect();\n      }\n      setBodyVisibleStyles(doc);\n      const ampdoc = getAmpdoc(doc);\n      ampdoc.signals().signal(CommonSignals.RENDER_START);\n      if (services.length > 0) {\n        const resources = Services.resourcesForDoc(doc.documentElement);\n        resources./*OK*/ schedulePass(1, /* relayoutAll */ true);\n      }\n      try {\n        const perf = Services.performanceFor(win);\n        perf.tick(TickLabel.MAKE_BODY_VISIBLE);\n        perf.flush();\n      } catch (e) {}\n    });\n}\n\n/**\n * Set the document's body opacity to 1. Called in error cases.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisibleRecovery(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  if (bodyMadeVisible) {\n    return;\n  }\n  bodyMadeVisible = true;\n  setBodyVisibleStyles(doc);\n}\n\n/**\n * Make sure that body exists, and make it visible.\n * @param {!Document} doc\n */\nfunction setBodyVisibleStyles(doc) {\n  setStyles(dev().assertElement(doc.body), {\n    opacity: 1,\n    visibility: 'visible',\n    'animation': 'none',\n  });\n}\n\n/**\n * Indicates that the body is always visible. For instance, in case of PWA.\n * This check is on a module level variable, and could be problematic if you are\n * relying on this function across different binaries.\n * @param {!Window} unusedWin\n */\nexport function bodyAlwaysVisible(unusedWin) {\n  bodyMadeVisible = true;\n}\n\n/**\n * Checks whether a style element was registered in the DOM.\n * @param {!Document|!ShadowRoot} doc\n * @param {!Element} style\n * @return {boolean}\n */\nfunction styleLoaded(doc, style) {\n  const sheets = doc.styleSheets;\n  for (let i = 0; i < sheets.length; i++) {\n    const sheet = sheets[i];\n    if (sheet.ownerNode == style) {\n      return true;\n    }\n  }\n  return false;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {AmpEvents} from './core/constants/amp-events';\nimport {Services} from './services';\nimport {\n  USER_ERROR_SENTINEL,\n  dev,\n  isUserErrorEmbed,\n  isUserErrorMessage,\n} from './log';\nimport {dict} from './core/types/object';\nimport {duplicateErrorIfNecessary} from './core/error';\nimport {experimentTogglesOrNull, getBinaryType, isCanary} from './experiments';\nimport {exponentialBackoff} from './core/types/function/exponential-backoff';\nimport {findIndex} from './core/types/array';\nimport {getMode} from './mode';\nimport {isLoadErrorMessage} from './event-helper';\nimport {isProxyOrigin} from './url';\nimport {makeBodyVisibleRecovery} from './style-installer';\nimport {triggerAnalyticsEvent} from './analytics';\nimport {urls} from './config';\n\n/**\n * @const {string}\n */\nconst CANCELLED = 'CANCELLED';\n\n/**\n * @const {string}\n */\nconst BLOCK_BY_CONSENT = 'BLOCK_BY_CONSENT';\n\n/**\n * @const {string}\n */\nconst ABORTED = 'AbortError';\n\n/**\n * The threshold for errors throttled because nothing can be done about\n * them, but we'd still like to report the rough number.\n * @const {number}\n */\nconst NON_ACTIONABLE_ERROR_THROTTLE_THRESHOLD = 0.001;\n\n/**\n * The threshold for errors throttled because nothing can be done about\n * them, but we'd still like to report the rough number.\n * @const {number}\n */\nconst USER_ERROR_THROTTLE_THRESHOLD = 0.1;\n\n/**\n * Chance to post to the new error reporting endpoint.\n * @const {number}\n */\nconst BETA_ERROR_REPORT_URL_FREQ = 0.1;\n\n/**\n * Collects error messages, so they can be included in subsequent reports.\n * That allows identifying errors that might be caused by previous errors.\n */\nlet accumulatedErrorMessages = self.__AMP_ERRORS || [];\n// Use a true global, to avoid multi-module inclusion issues.\nself.__AMP_ERRORS = accumulatedErrorMessages;\n\n/**\n * Pushes element into array, keeping at most the most recent limit elements\n *\n * @param {!Array<T>} array\n * @param {T} element\n * @param {number} limit\n * @template T\n */\nfunction pushLimit(array, element, limit) {\n  if (array.length >= limit) {\n    array.splice(0, array.length - limit + 1);\n  }\n  array.push(element);\n}\n\n/**\n * A wrapper around our exponentialBackoff, to lazy initialize it to avoid an\n * un-DCE'able side-effect.\n * @param {function()} work the function to execute after backoff\n * @return {number} the setTimeout id\n */\nlet reportingBackoff = function (work) {\n  // Set reportingBackoff as the lazy-created function. JS Vooodoooo.\n  reportingBackoff = exponentialBackoff(1.5);\n  return reportingBackoff(work);\n};\n\n/**\n * Attempts to stringify a value, falling back to String.\n * @param {*} value\n * @return {string}\n */\nfunction tryJsonStringify(value) {\n  try {\n    // Cast is fine, because we really don't care here. Just trying.\n    return JSON.stringify(/** @type {!JsonObject} */ (value));\n  } catch (e) {\n    return String(value);\n  }\n}\n\n/**\n * @param {!Window} win\n * @param {*} error\n * @param {!Element=} opt_associatedElement\n */\nexport function reportErrorForWin(win, error, opt_associatedElement) {\n  reportError(error, opt_associatedElement);\n  if (\n    error &&\n    !!win &&\n    isUserErrorMessage(error.message) &&\n    !isUserErrorEmbed(error.message)\n  ) {\n    reportErrorToAnalytics(/** @type {!Error} */ (error), win);\n  }\n}\n\n/**\n * Reports an error. If the error has an \"associatedElement\" property\n * the element is marked with the `i-amphtml-element-error` and displays\n * the message itself. The message is always send to the console.\n * If the error has a \"messageArray\" property, that array is logged.\n * This way one gets the native fidelity of the console for things like\n * elements instead of stringification.\n * @param {*} error\n * @param {!Element=} opt_associatedElement\n * @return {!Error}\n */\nexport function reportError(error, opt_associatedElement) {\n  try {\n    // Convert error to the expected type.\n    let isValidError;\n    if (error) {\n      if (error.message !== undefined) {\n        error = duplicateErrorIfNecessary(/** @type {!Error} */ (error));\n        isValidError = true;\n      } else {\n        const origError = error;\n        error = new Error(tryJsonStringify(origError));\n        error.origError = origError;\n      }\n    } else {\n      error = new Error('Unknown error');\n    }\n    // Report if error is not an expected type.\n    if (!isValidError && getMode().localDev && !getMode().test) {\n      setTimeout(function () {\n        const rethrow = new Error(\n          '_reported_ Error reported incorrectly: ' + error\n        );\n        throw rethrow;\n      });\n    }\n\n    if (error.reported) {\n      return /** @type {!Error} */ (error);\n    }\n    error.reported = true;\n\n    // `associatedElement` is used to add the i-amphtml-error class; in\n    // `#development=1` mode, it also adds `i-amphtml-element-error` to the\n    // element and sets the `error-message` attribute.\n    if (error.messageArray) {\n      const elIndex = findIndex(error.messageArray, (item) => item?.tagName);\n      if (elIndex > -1) {\n        error.associatedElement = error.messageArray[elIndex];\n      }\n    }\n    // Update element.\n    const element = opt_associatedElement || error.associatedElement;\n    if (element && element.classList) {\n      element.classList.add('i-amphtml-error');\n      if (getMode().development) {\n        element.classList.add('i-amphtml-element-error');\n        element.setAttribute('error-message', error.message);\n      }\n    }\n\n    // Report to console.\n    if (\n      self.console &&\n      (isUserErrorMessage(error.message) ||\n        !error.expected ||\n        getMode().localDev)\n    ) {\n      const output = console.error || console.log;\n      if (error.messageArray) {\n        output.apply(console, error.messageArray);\n      } else {\n        if (element) {\n          output.call(console, error.message, element);\n        } else if (!getMode().minified) {\n          output.call(console, error.stack);\n        } else {\n          output.call(console, error.message);\n        }\n      }\n    }\n    if (element && element.dispatchCustomEventForTesting) {\n      element.dispatchCustomEventForTesting(AmpEvents.ERROR, error.message);\n    }\n\n    // 'call' to make linter happy. And .call to make compiler happy\n    // that expects some @this.\n    onError['call'](self, undefined, undefined, undefined, undefined, error);\n  } catch (errorReportingError) {\n    setTimeout(function () {\n      throw errorReportingError;\n    });\n  }\n  return /** @type {!Error} */ (error);\n}\n\n/**\n * Returns an error for a cancellation of a promise.\n * @return {!Error}\n */\nexport function cancellation() {\n  return new Error(CANCELLED);\n}\n\n/**\n * @param {*} errorOrMessage\n * @return {boolean}\n */\nexport function isCancellation(errorOrMessage) {\n  if (!errorOrMessage) {\n    return false;\n  }\n  if (typeof errorOrMessage == 'string') {\n    return errorOrMessage.startsWith(CANCELLED);\n  }\n  if (typeof errorOrMessage.message == 'string') {\n    return errorOrMessage.message.startsWith(CANCELLED);\n  }\n  return false;\n}\n\n/**\n * Returns an error for component blocked by consent\n * @return {!Error}\n */\nexport function blockedByConsentError() {\n  return new Error(BLOCK_BY_CONSENT);\n}\n\n/**\n * @param {*} errorOrMessage\n * @return {boolean}\n */\nexport function isBlockedByConsent(errorOrMessage) {\n  if (!errorOrMessage) {\n    return false;\n  }\n  if (typeof errorOrMessage == 'string') {\n    return errorOrMessage.startsWith(BLOCK_BY_CONSENT);\n  }\n  if (typeof errorOrMessage.message == 'string') {\n    return errorOrMessage.message.startsWith(BLOCK_BY_CONSENT);\n  }\n  return false;\n}\n\n/**\n * Install handling of global unhandled exceptions.\n * @param {!Window} win\n */\nexport function installErrorReporting(win) {\n  win.onerror = /** @type {!Function} */ (onError);\n  win.addEventListener('unhandledrejection', (event) => {\n    if (\n      event.reason &&\n      (event.reason.message === CANCELLED ||\n        event.reason.message === BLOCK_BY_CONSENT ||\n        event.reason.message === ABORTED)\n    ) {\n      event.preventDefault();\n      return;\n    }\n    reportError(event.reason || new Error('rejected promise ' + event));\n  });\n}\n\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {*|undefined} error\n * @this {!Window|undefined}\n */\nfunction onError(message, filename, line, col, error) {\n  // Make an attempt to unhide the body but don't if the error is actually expected.\n  // eslint-disable-next-line local/no-invalid-this\n  if (this && this.document && (!error || !error.expected)) {\n    // eslint-disable-next-line local/no-invalid-this\n    makeBodyVisibleRecovery(this.document);\n  }\n  if (getMode().localDev || getMode().development || getMode().test) {\n    return;\n  }\n  let hasNonAmpJs = false;\n  try {\n    hasNonAmpJs = detectNonAmpJs(self);\n  } catch (ignore) {\n    // Ignore errors during error report generation.\n  }\n  if (hasNonAmpJs && Math.random() > 0.01) {\n    // Only report 1% of errors on pages with non-AMP JS.\n    // These errors can almost never be acted upon, but spikes such as\n    // due to buggy browser extensions may be helpful to notify authors.\n    return;\n  }\n  const data = getErrorReportData(\n    message,\n    filename,\n    line,\n    col,\n    error,\n    hasNonAmpJs\n  );\n  if (data) {\n    reportingBackoff(() => {\n      try {\n        return reportErrorToServerOrViewer(\n          // eslint-disable-next-line local/no-invalid-this\n          this,\n          /** @type {!JsonObject} */\n          (data)\n        ).catch(() => {\n          // catch async errors to avoid recursive errors.\n        });\n      } catch (e) {\n        // catch async errors to avoid recursive errors.\n      }\n    });\n  }\n}\n\n/**\n * Determines the error reporting endpoint which should be used.\n * If changing this URL, keep `docs/spec/amp-errors.md` in sync.\n * @return {string} error reporting endpoint URL.\n */\nfunction chooseReportingUrl_() {\n  return Math.random() < BETA_ERROR_REPORT_URL_FREQ\n    ? urls.betaErrorReporting\n    : urls.errorReporting;\n}\n\n/**\n * Passes the given error data to either server or viewer.\n * @param {!Window} win\n * @param {!JsonObject} data Data from `getErrorReportData`.\n * @return {Promise<undefined>}\n */\nexport function reportErrorToServerOrViewer(win, data) {\n  // Report the error to viewer if it has the capability. The data passed\n  // to the viewer is exactly the same as the data passed to the server\n  // below.\n\n  // Throttle reports from Stable by 90%.\n  if (data['pt'] && Math.random() < 0.9) {\n    return Promise.resolve();\n  }\n\n  return maybeReportErrorToViewer(win, data).then((reportedErrorToViewer) => {\n    if (!reportedErrorToViewer) {\n      const xhr = new XMLHttpRequest();\n      xhr.open('POST', chooseReportingUrl_(), true);\n      xhr.send(JSON.stringify(data));\n    }\n  });\n}\n\n/**\n * Passes the given error data to the viewer if the following criteria is met:\n * - The viewer is a trusted viewer\n * - The viewer has the `errorReporter` capability\n * - The AMP doc is in single doc mode\n * - The AMP doc is opted-in for error interception (`<html>` tag has the\n *   `report-errors-to-viewer` attribute)\n *\n * @param {!Window} win\n * @param {!JsonObject} data Data from `getErrorReportData`.\n * @return {!Promise<boolean>} `Promise<True>` if the error was sent to the\n *     viewer, `Promise<False>` otherwise.\n * @visibleForTesting\n */\nexport function maybeReportErrorToViewer(win, data) {\n  const ampdocService = Services.ampdocServiceFor(win);\n  if (!ampdocService.isSingleDoc()) {\n    return Promise.resolve(false);\n  }\n  const ampdocSingle = ampdocService.getSingleDoc();\n  const htmlElement = ampdocSingle.getRootNode().documentElement;\n  const docOptedIn = htmlElement.hasAttribute('report-errors-to-viewer');\n  if (!docOptedIn) {\n    return Promise.resolve(false);\n  }\n  const viewer = Services.viewerForDoc(ampdocSingle);\n  if (!viewer.hasCapability('errorReporter')) {\n    return Promise.resolve(false);\n  }\n  return viewer.isTrustedViewer().then((viewerTrusted) => {\n    if (!viewerTrusted) {\n      return false;\n    }\n    viewer.sendMessage('error', errorReportingDataForViewer(data));\n    return true;\n  });\n}\n\n/**\n * Strips down the error reporting data to a minimal set\n * to be sent to the viewer.\n * @param {!JsonObject} errorReportData\n * @return {!JsonObject}\n * @visibleForTesting\n */\nexport function errorReportingDataForViewer(errorReportData) {\n  return dict({\n    'm': errorReportData['m'], // message\n    'a': errorReportData['a'], // isUserError\n    's': errorReportData['s'], // error stack\n    'el': errorReportData['el'], // tagName\n    'ex': errorReportData['ex'], // expected error?\n    'v': errorReportData['v'], // runtime\n    'pt': errorReportData['pt'], // is pre-throttled\n  });\n}\n\n/**\n * @param {string|undefined}  message\n * @param {*|undefined} error\n * @return {string}\n */\nfunction buildErrorMessage_(message, error) {\n  if (error) {\n    if (error.message) {\n      message = error.message;\n    } else {\n      // This should never be a string, but sometimes it is.\n      message = String(error);\n    }\n  }\n  if (!message) {\n    message = 'Unknown error';\n  }\n\n  return message;\n}\n\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {*|undefined} error\n * @param {boolean} hasNonAmpJs\n * @return {!JsonObject|undefined} The data to post\n * visibleForTesting\n */\nexport function getErrorReportData(\n  message,\n  filename,\n  line,\n  col,\n  error,\n  hasNonAmpJs\n) {\n  message = buildErrorMessage_(message, error);\n  // An \"expected\" error is still an error, i.e. some features are disabled\n  // or not functioning fully because of it. However, it's an expected\n  // error. E.g. as is the case with some browser API missing (storage).\n  // Thus, the error can be classified differently by log aggregators.\n  // The main goal is to monitor that an \"expected\" error doesn't deteriorate\n  // over time. It's impossible to completely eliminate it.\n  let expected = !!(error && error.expected);\n  if (/_reported_/.test(message)) {\n    return;\n  }\n  if (message == CANCELLED) {\n    return;\n  }\n\n  const detachedWindow = !(self && self.window);\n  const throttleBase = Math.random();\n\n  // We throttle load errors and generic \"Script error.\" errors\n  // that have no information and thus cannot be acted upon.\n  if (\n    isLoadErrorMessage(message) ||\n    // See https://github.com/ampproject/amphtml/issues/7353\n    // for context.\n    message == 'Script error.' ||\n    // Window has become detached, really anything can happen\n    // at this point.\n    detachedWindow\n  ) {\n    expected = true;\n\n    if (throttleBase > NON_ACTIONABLE_ERROR_THROTTLE_THRESHOLD) {\n      return;\n    }\n  }\n\n  const isUserError = isUserErrorMessage(message);\n\n  // Only report a subset of user errors.\n  if (isUserError && throttleBase > USER_ERROR_THROTTLE_THRESHOLD) {\n    return;\n  }\n\n  // This is the App Engine app in\n  // https://github.com/ampproject/error-tracker\n  // It stores error reports via https://cloud.google.com/error-reporting/\n  // for analyzing production issues.\n  const data = /** @type {!JsonObject} */ (Object.create(null));\n  data['v'] = getMode().rtvVersion;\n  data['noAmp'] = hasNonAmpJs ? '1' : '0';\n  data['m'] = message.replace(USER_ERROR_SENTINEL, '');\n  data['a'] = isUserError ? '1' : '0';\n\n  // Errors are tagged with \"ex\" (\"expected\") label to allow loggers to\n  // classify these errors as benchmarks and not exceptions.\n  data['ex'] = expected ? '1' : '0';\n  data['dw'] = detachedWindow ? '1' : '0';\n\n  let runtime = '1p';\n  if (IS_SXG) {\n    runtime = 'sxg';\n    data['sxg'] = '1';\n  } else if (IS_ESM) {\n    runtime = 'esm';\n    data['esm'] = '1';\n  } else if (self.context && self.context.location) {\n    data['3p'] = '1';\n    runtime = '3p';\n  } else if (getMode().runtime) {\n    runtime = getMode().runtime;\n  }\n\n  data['rt'] = runtime;\n\n  // Add our a4a id if we are inabox\n  if (runtime === 'inabox') {\n    data['adid'] = getMode().a4aId;\n  }\n\n  // TODO(erwinm): Remove ca when all systems read `bt` instead of `ca` to\n  // identify js binary type.\n  data['ca'] = isCanary(self) ? '1' : '0';\n\n  // Pass binary type.\n  data['bt'] = getBinaryType(self);\n\n  if (self.location.ancestorOrigins && self.location.ancestorOrigins[0]) {\n    data['or'] = self.location.ancestorOrigins[0];\n  }\n  if (self.viewerState) {\n    data['vs'] = self.viewerState;\n  }\n  // Is embedded?\n  if (self.parent && self.parent != self) {\n    data['iem'] = '1';\n  }\n\n  if (self.AMP && self.AMP.viewer) {\n    const resolvedViewerUrl = self.AMP.viewer.getResolvedViewerUrl();\n    const messagingOrigin = self.AMP.viewer.maybeGetMessagingOrigin();\n    if (resolvedViewerUrl) {\n      data['rvu'] = resolvedViewerUrl;\n    }\n    if (messagingOrigin) {\n      data['mso'] = messagingOrigin;\n    }\n  }\n\n  const exps = [];\n  const experiments = experimentTogglesOrNull(self);\n  for (const exp in experiments) {\n    const on = experiments[exp];\n    exps.push(`${exp}=${on ? '1' : '0'}`);\n  }\n  data['exps'] = exps.join(',');\n\n  if (error) {\n    data['el'] = error.associatedElement?.tagName || 'u'; // Unknown\n\n    if (error.args) {\n      data['args'] = JSON.stringify(error.args);\n    }\n\n    if (!isUserError && !error.ignoreStack && error.stack) {\n      data['s'] = error.stack;\n    }\n\n    // TODO(jridgewell, #18574); Make sure error is always an object.\n    if (error.message) {\n      error.message += ' _reported_';\n    }\n  } else {\n    data['f'] = filename || '';\n    data['l'] = line || '';\n    data['c'] = col || '';\n  }\n  data['r'] = self.document ? self.document.referrer : '';\n  data['ae'] = accumulatedErrorMessages.join(',');\n  data['fr'] = self.location['originalHash'] || self.location.hash;\n\n  // TODO(https://github.com/ampproject/error-tracker/issues/129): Remove once\n  // all clients are serving a version with pre-throttling.\n  if (data['bt'] === 'production') {\n    // Setting this field allows the error reporting service to know that this\n    // error has already been pre-throttled for Stable, so it doesn't need to\n    // throttle again.\n    data['pt'] = '1';\n  }\n\n  pushLimit(accumulatedErrorMessages, message, 25);\n\n  return data;\n}\n\n/**\n * Returns true if it appears like there is non-AMP JS on the\n * current page.\n * @param {!Window} win\n * @return {boolean}\n * @visibleForTesting\n */\nexport function detectNonAmpJs(win) {\n  if (!win.document) {\n    return false;\n  }\n  const scripts = win.document.querySelectorAll('script[src]');\n  for (let i = 0; i < scripts.length; i++) {\n    if (!isProxyOrigin(scripts[i].src.toLowerCase())) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Resets accumulated error messages for testing\n */\nexport function resetAccumulatedErrorMessagesForTesting() {\n  accumulatedErrorMessages = [];\n}\n\n/**\n * @param {!Error} error\n * @param {!Window} win\n */\nexport function reportErrorToAnalytics(error, win) {\n  // Currently this can only be executed in a single-doc mode. Otherwise,\n  // it's not clear which ampdoc the event would belong too.\n  if (Services.ampdocServiceFor(win).isSingleDoc()) {\n    const vars = dict({\n      'errorName': error.name,\n      'errorMessage': error.message,\n    });\n    triggerAnalyticsEvent(\n      getRootElement_(win),\n      'user-error',\n      vars,\n      /** enableDataVars */ false\n    );\n  }\n}\n\n/**\n * @param {!Window} win\n * @return {!Element}\n * @private\n */\nfunction getRootElement_(win) {\n  const root = Services.ampdocServiceFor(win).getSingleDoc().getRootNode();\n  return dev().assertElement(root.documentElement || root.body || root);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ActionTrust,\n  DEFAULT_ACTION,\n  RAW_OBJECT_ARGS_KEY,\n  actionTrustToString,\n} from '../core/constants/action-constants';\nimport {Keys} from '../core/constants/key-codes';\nimport {Services} from '../services';\nimport {debounce, throttle} from '../core/types/function';\nimport {dev, devAssert, user, userAssert} from '../log';\nimport {dict, getValueForExpr, hasOwn, map} from '../core/types/object';\nimport {getDetail} from '../event-helper';\nimport {getMode} from '../mode';\nimport {isAmp4Email} from '../format';\nimport {isArray, toArray} from '../core/types/array';\nimport {isEnabled} from '../dom';\nimport {isFiniteNumber} from '../core/types';\nimport {registerServiceBuilderForDoc} from '../service';\nimport {reportError} from '../error-reporting';\nimport {toWin} from '../core/window';\n\n/** @const {string} */\nconst TAG_ = 'Action';\n\n/** @const {string} */\nconst ACTION_MAP_ = '__AMP_ACTION_MAP__' + Math.random();\n\n/** @const {string} */\nconst ACTION_QUEUE_ = '__AMP_ACTION_QUEUE__';\n\n/** @const {string} */\nconst ACTION_HANDLER_ = '__AMP_ACTION_HANDLER__';\n\n/** @const {number} */\nconst DEFAULT_DEBOUNCE_WAIT = 300; // ms\n\n/** @const {number} */\nconst DEFAULT_THROTTLE_INTERVAL = 100; // ms\n\n/** @const {!Object<string,!Array<string>>} */\nconst NON_AMP_ELEMENTS_ACTIONS_ = {\n  'form': ['submit', 'clear'],\n};\n\nconst DEFAULT_EMAIL_ALLOWLIST = [\n  {tagOrTarget: 'AMP', method: 'setState'},\n  {tagOrTarget: '*', method: 'focus'},\n  {tagOrTarget: '*', method: 'hide'},\n  {tagOrTarget: '*', method: 'show'},\n  {tagOrTarget: '*', method: 'toggleClass'},\n  {tagOrTarget: '*', method: 'toggleVisibility'},\n];\n\n/**\n * Interactable widgets which should trigger tap events when the user clicks\n * or activates via the keyboard. Not all are here, e.g. progressbar, tabpanel,\n * since they are text inputs, readonly, or composite widgets that shouldn't\n * need to trigger tap events from spacebar or enter on their own.\n * See https://www.w3.org/TR/wai-aria-1.1/#widget_roles\n * @const {!Object<boolean>}\n */\nexport const TAPPABLE_ARIA_ROLES = {\n  'button': true,\n  'checkbox': true,\n  'link': true,\n  'listbox': true,\n  'menuitem': true,\n  'menuitemcheckbox': true,\n  'menuitemradio': true,\n  'option': true,\n  'radio': true,\n  'scrollbar': true,\n  'slider': true,\n  'spinbutton': true,\n  'switch': true,\n  'tab': true,\n  'treeitem': true,\n};\n\n/**\n * An expression arg value, e.g. `foo.bar` in `e:t.m(arg=foo.bar)`.\n * @typedef {{expression: string}}\n */\nlet ActionInfoArgExpressionDef;\n\n/**\n * An arg value.\n * @typedef {(boolean|number|string|ActionInfoArgExpressionDef)}\n */\nlet ActionInfoArgValueDef;\n\n/**\n * Map of arg names to their values, e.g. {arg: 123} in `e:t.m(arg=123)`.\n * @typedef {Object<string, ActionInfoArgValueDef>}\n */\nlet ActionInfoArgsDef;\n\n/**\n * @typedef {{\n *   event: string,\n *   target: string,\n *   method: string,\n *   args: ?ActionInfoArgsDef,\n *   str: string\n * }}\n */\nexport let ActionInfoDef;\n\n/**\n * Function called when an action is invoked.\n *\n * Optionally, takes this action's position within all actions triggered by\n * the same event, as well as said action array, as params.\n *\n * If the action is chainable, returns a Promise which resolves when the\n * action is complete. Otherwise, returns null.\n *\n * @typedef {function(!ActionInvocation, number=, !Array<!ActionInfoDef>=):?Promise}\n */\nlet ActionHandlerDef;\n\n/**\n * @typedef {Event|DeferredEvent}\n */\nexport let ActionEventDef;\n\n/**\n * The structure that contains all details of the action method invocation.\n * @struct @const @package For type.\n */\nexport class ActionInvocation {\n  /**\n   * For example:\n   *\n   *   <div id=\"div\" on=\"tap:myForm.submit(foo=bar)\">\n   *     <button id=\"btn\">Submit</button>\n   *   </div>\n   *\n   * `node` is #myForm.\n   * `method` is \"submit\".\n   * `args` is {'foo': 'bar'}.\n   * `source` is #btn.\n   * `caller` is #div.\n   * `event` is a \"click\" Event object.\n   * `actionEventType` is \"tap\".\n   * `trust` depends on whether this action was a result of a user gesture.\n   * `tagOrTarget` is \"amp-form\".\n   * `sequenceId` is a pseudo-UUID.\n   *\n   * @param {!Node} node Element whose action is being invoked.\n   * @param {string} method Name of the action being invoked.\n   * @param {?JsonObject} args Named action arguments.\n   * @param {?Element} source Element that generated the `event`.\n   * @param {?Element} caller Element containing the on=\"...\" action handler.\n   * @param {?ActionEventDef} event The event object that triggered this action.\n   * @param {!ActionTrust} trust The trust level of this invocation's trigger.\n   * @param {?string} actionEventType The AMP event name that triggered this.\n   * @param {?string} tagOrTarget The global target name or the element tagName.\n   * @param {number} sequenceId An identifier for this action's sequence (all\n   *   actions triggered by one event e.g. \"tap:form1.submit, form2.submit\").\n   */\n  constructor(\n    node,\n    method,\n    args,\n    source,\n    caller,\n    event,\n    trust,\n    actionEventType = '?',\n    tagOrTarget = null,\n    sequenceId = Math.random()\n  ) {\n    /** @type {!Node} */\n    this.node = node;\n    /** @const {string} */\n    this.method = method;\n    /** @const {?JsonObject} */\n    this.args = args;\n    /** @const {?Element} */\n    this.source = source;\n    /** @const {?Element} */\n    this.caller = caller;\n    /** @const {?ActionEventDef} */\n    this.event = event;\n    /** @const {!ActionTrust} */\n    this.trust = trust;\n    /** @const {?string} */\n    this.actionEventType = actionEventType;\n    /** @const {string} */\n    this.tagOrTarget = tagOrTarget || node.tagName;\n    /** @const {number} */\n    this.sequenceId = sequenceId;\n  }\n\n  /**\n   * Returns true if the trigger event has a trust equal to or greater than\n   * `minimumTrust`. Otherwise, logs a user error and returns false.\n   * @param {ActionTrust} minimumTrust\n   * @return {boolean}\n   */\n  satisfiesTrust(minimumTrust) {\n    // Sanity check.\n    if (!isFiniteNumber(this.trust)) {\n      dev().error(TAG_, `Invalid trust for '${this.method}': ${this.trust}`);\n      return false;\n    }\n    if (this.trust < minimumTrust) {\n      const t = actionTrustToString(this.trust);\n      user().error(\n        TAG_,\n        `\"${this.actionEventType}\" event with \"${t}\" trust is not allowed to ` +\n          `invoke \"${this.tagOrTarget.toLowerCase()}.${this.method}\".`\n      );\n      return false;\n    }\n    return true;\n  }\n}\n\n/**\n * TODO(dvoytenko): consider splitting this class into two:\n * 1. A class that has a method \"trigger(element, eventType, data)\" and\n *    simply can search target in DOM and trigger methods on it.\n * 2. A class that configures event recognizers and rules and then\n *    simply calls action.trigger.\n */\nexport class ActionService {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {(!Document|!ShadowRoot)=} opt_root\n   */\n  constructor(ampdoc, opt_root) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @const {!Document|!ShadowRoot} */\n    this.root_ = opt_root || ampdoc.getRootNode();\n\n    /** @const {boolean} */\n    this.isEmail_ =\n      this.ampdoc.isSingleDoc() &&\n      isAmp4Email(/** @type {!Document} */ (this.root_));\n\n    /**\n     * Optional allowlist of actions, e.g.:\n     *\n     *     [{tagOrTarget: 'AMP', method: 'navigateTo'},\n     *      {tagOrTarget: 'AMP-FORM', method: 'submit'},\n     *      {tagOrTarget: '*', method: 'show'}]\n     *\n     * If not null, any actions that are not in the allowlist will be ignored\n     * and throw a user error at invocation time. Note that `tagOrTarget` is\n     * always the canonical uppercased form (same as\n     * `Element.prototype.tagName`). If `tagOrTarget` is the wildcard '*', then\n     * the allowlisted method is allowed on any tag or target.\n     *\n     * For AMP4Email format documents, allowed actions are autogenerated.\n     * @private {?Array<{tagOrTarget: string, method: string}>}\n     */\n    this.allowlist_ = this.isEmail_ ? DEFAULT_EMAIL_ALLOWLIST : null;\n\n    /** @const @private {!Object<string, ActionHandlerDef>} */\n    this.globalTargets_ = map();\n\n    /**\n     * @const @private {!Object<string, {handler: ActionHandlerDef, minTrust: ActionTrust}>}\n     */\n    this.globalMethodHandlers_ = map();\n\n    // Add core events.\n    this.addEvent('tap');\n    this.addEvent('submit');\n    this.addEvent('change');\n    this.addEvent('input-debounced');\n    this.addEvent('input-throttled');\n    this.addEvent('valid');\n    this.addEvent('invalid');\n  }\n\n  /**\n   * @param {string} name\n   * TODO(dvoytenko): switch to a system where the event recognizers are\n   * registered with Action instead, e.g. \"doubletap\", \"tap to zoom\".\n   */\n  addEvent(name) {\n    if (name == 'tap') {\n      // TODO(dvoytenko): if needed, also configure touch-based tap, e.g. for\n      // fast-click.\n      this.root_.addEventListener('click', (event) => {\n        if (!event.defaultPrevented) {\n          const element = dev().assertElement(event.target);\n          this.trigger(element, name, event, ActionTrust.HIGH);\n        }\n      });\n      this.root_.addEventListener('keydown', (event) => {\n        const {key, target} = event;\n        const element = dev().assertElement(target);\n        if (key == Keys.ENTER || key == Keys.SPACE) {\n          const role = element.getAttribute('role');\n          const isTapEventRole =\n            role && hasOwn(TAPPABLE_ARIA_ROLES, role.toLowerCase());\n          if (!event.defaultPrevented && isTapEventRole) {\n            const hasAction = this.trigger(\n              element,\n              name,\n              event,\n              ActionTrust.HIGH\n            );\n            // Only if the element has an action do we prevent the default.\n            // In the absence of an action, e.g. on=\"[event].method\", we do not\n            // want to stop default behavior.\n            if (hasAction) {\n              event.preventDefault();\n            }\n          }\n        }\n      });\n    } else if (name == 'submit') {\n      this.root_.addEventListener(name, (event) => {\n        const element = dev().assertElement(event.target);\n        // For get requests, the delegating to the viewer needs to happen\n        // before this.\n        this.trigger(element, name, event, ActionTrust.HIGH);\n      });\n    } else if (name == 'change') {\n      this.root_.addEventListener(name, (event) => {\n        const element = dev().assertElement(event.target);\n        this.addTargetPropertiesAsDetail_(event);\n        this.trigger(element, name, event, ActionTrust.HIGH);\n      });\n    } else if (name == 'input-debounced') {\n      const debouncedInput = debounce(\n        this.ampdoc.win,\n        (event) => {\n          const target = dev().assertElement(event.target);\n          this.trigger(\n            target,\n            name,\n            /** @type {!ActionEventDef} */ (event),\n            ActionTrust.HIGH\n          );\n        },\n        DEFAULT_DEBOUNCE_WAIT\n      );\n\n      this.root_.addEventListener('input', (event) => {\n        // Create a DeferredEvent to avoid races where the browser cleans up\n        // the event object before the async debounced function is called.\n        const deferredEvent = new DeferredEvent(event);\n        this.addTargetPropertiesAsDetail_(deferredEvent);\n        debouncedInput(deferredEvent);\n      });\n    } else if (name == 'input-throttled') {\n      const throttledInput = throttle(\n        this.ampdoc.win,\n        (event) => {\n          const target = dev().assertElement(event.target);\n          this.trigger(\n            target,\n            name,\n            /** @type {!ActionEventDef} */ (event),\n            ActionTrust.HIGH\n          );\n        },\n        DEFAULT_THROTTLE_INTERVAL\n      );\n\n      this.root_.addEventListener('input', (event) => {\n        const deferredEvent = new DeferredEvent(event);\n        this.addTargetPropertiesAsDetail_(deferredEvent);\n        throttledInput(deferredEvent);\n      });\n    } else if (name == 'valid' || name == 'invalid') {\n      this.root_.addEventListener(name, (event) => {\n        const element = dev().assertElement(event.target);\n        this.trigger(element, name, event, ActionTrust.HIGH);\n      });\n    }\n  }\n\n  /**\n   * Registers the action target that will receive all designated actions.\n   * @param {string} name\n   * @param {ActionHandlerDef} handler\n   */\n  addGlobalTarget(name, handler) {\n    this.globalTargets_[name] = handler;\n  }\n\n  /**\n   * Registers the action handler for a common method.\n   * @param {string} name\n   * @param {ActionHandlerDef} handler\n   * @param {ActionTrust} minTrust\n   */\n  addGlobalMethodHandler(name, handler, minTrust = ActionTrust.DEFAULT) {\n    this.globalMethodHandlers_[name] = {handler, minTrust};\n  }\n\n  /**\n   * Triggers the specified event on the target element.\n   * @param {!Element} target\n   * @param {string} eventType\n   * @param {?ActionEventDef} event\n   * @param {!ActionTrust} trust\n   * @param {?JsonObject=} opt_args\n   * @return {boolean} true if the target has an action.\n   */\n  trigger(target, eventType, event, trust, opt_args) {\n    return this.action_(target, eventType, event, trust, opt_args);\n  }\n\n  /**\n   * Triggers execution of the method on a target/method.\n   * @param {!Element} target\n   * @param {string} method\n   * @param {?JsonObject} args\n   * @param {?Element} source\n   * @param {?Element} caller\n   * @param {?ActionEventDef} event\n   * @param {ActionTrust} trust\n   */\n  execute(target, method, args, source, caller, event, trust) {\n    const invocation = new ActionInvocation(\n      target,\n      method,\n      args,\n      source,\n      caller,\n      event,\n      trust\n    );\n    this.invoke_(invocation);\n  }\n\n  /**\n   * Installs action handler for the specified element. The action handler is\n   * responsible for checking invocation trust.\n   *\n   * For AMP elements, use base-element.registerAction() instead.\n   *\n   * @param {!Element} target\n   * @param {ActionHandlerDef} handler\n   */\n  installActionHandler(target, handler) {\n    // TODO(dvoytenko, #7063): switch back to `target.id` with form proxy.\n    const targetId = target.getAttribute('id') || '';\n\n    devAssert(\n      isAmpTagName(targetId) ||\n        target.tagName.toLowerCase() in NON_AMP_ELEMENTS_ACTIONS_,\n      'AMP or special element expected: %s',\n      target.tagName + '#' + targetId\n    );\n\n    if (target[ACTION_HANDLER_]) {\n      dev().error(TAG_, `Action handler already installed for ${target}`);\n      return;\n    }\n    target[ACTION_HANDLER_] = handler;\n\n    /** @const {Array<!ActionInvocation>} */\n    const queuedInvocations = target[ACTION_QUEUE_];\n    if (isArray(queuedInvocations)) {\n      // Invoke and clear all queued invocations now handler is installed.\n      Services.timerFor(toWin(target.ownerDocument.defaultView)).delay(() => {\n        // TODO(dvoytenko, #1260): dedupe actions.\n        queuedInvocations.forEach((invocation) => {\n          try {\n            handler(invocation);\n          } catch (e) {\n            dev().error(TAG_, 'Action execution failed:', invocation, e);\n          }\n        });\n        target[ACTION_QUEUE_].length = 0;\n      }, 1);\n    }\n  }\n\n  /**\n   * Checks if the given element has registered a particular action type.\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  hasAction(element, actionEventType, opt_stopAt) {\n    return !!this.findAction_(element, actionEventType, opt_stopAt);\n  }\n\n  /**\n   * Checks if the given element's registered action resolves to at least one\n   * existing element by id or a global target (e.g. \"AMP\").\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  hasResolvableAction(element, actionEventType, opt_stopAt) {\n    const action = this.findAction_(element, actionEventType, opt_stopAt);\n    if (!action) {\n      return false;\n    }\n    return action.actionInfos.some((action) => {\n      const {target} = action;\n      return !!this.getActionNode_(target);\n    });\n  }\n\n  /**\n   * Checks if the given element's registered action resolves to at least one\n   * existing element by id or a global target (e.g. \"AMP\").\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element} targetElement\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  hasResolvableActionForTarget(\n    element,\n    actionEventType,\n    targetElement,\n    opt_stopAt\n  ) {\n    const action = this.findAction_(element, actionEventType, opt_stopAt);\n    if (!action) {\n      return false;\n    }\n    return action.actionInfos.some((actionInfo) => {\n      const {target} = actionInfo;\n      return this.getActionNode_(target) == targetElement;\n    });\n  }\n\n  /**\n   * For global targets e.g. \"AMP\", returns the document root. Otherwise,\n   * `target` is an element id and the corresponding element is returned.\n   * @param {string} target\n   * @return {?Document|?Element|?ShadowRoot}\n   * @private\n   */\n  getActionNode_(target) {\n    return this.globalTargets_[target]\n      ? this.root_\n      : this.root_.getElementById(target);\n  }\n\n  /**\n   * Sets the action allowlist. Can be used to clear it.\n   * @param {!Array<{tagOrTarget: string, method: string}>} allowlist\n   */\n  setAllowlist(allowlist) {\n    devAssert(\n      allowlist.every((v) => v.tagOrTarget && v.method),\n      'Action allowlist entries should be of shape { tagOrTarget: string, method: string }'\n    );\n    this.allowlist_ = allowlist;\n  }\n\n  /**\n   * Adds an action to the allowlist.\n   * @param {string} tagOrTarget The tag or target to allowlist, e.g.\n   *     'AMP-LIST', '*'.\n   * @param {string|Array<string>} methods The method(s) to allowlist, e.g. 'show', 'hide'.\n   * @param {Array<string>=} opt_forFormat\n   */\n  addToAllowlist(tagOrTarget, methods, opt_forFormat) {\n    // TODO(wg-performance): When it becomes possible to getFormat(),\n    // we can store `format_` instead of `isEmail_` and check\n    // (opt_forFormat && !opt_forFormat.includes(this.format_))\n    if (opt_forFormat && opt_forFormat.includes('email') !== this.isEmail_) {\n      return;\n    }\n    if (!this.allowlist_) {\n      this.allowlist_ = [];\n    }\n    if (!isArray(methods)) {\n      methods = [methods];\n    }\n    methods.forEach((method) => {\n      if (\n        this.allowlist_.some(\n          (v) => v.tagOrTarget == tagOrTarget && v.method == method\n        )\n      ) {\n        return;\n      }\n      this.allowlist_.push({tagOrTarget, method});\n    });\n  }\n\n  /**\n   * @param {!Element} source\n   * @param {string} actionEventType\n   * @param {?ActionEventDef} event\n   * @param {!ActionTrust} trust\n   * @param {?JsonObject=} opt_args\n   * @return {boolean} True if the element has an action.\n   * @private\n   */\n  action_(source, actionEventType, event, trust, opt_args) {\n    const action = this.findAction_(source, actionEventType);\n    if (!action) {\n      return false;\n    }\n    // Use a pseudo-UUID to uniquely identify this sequence of actions.\n    // A sequence is all actions triggered by a single event.\n    const sequenceId = Math.random();\n    // Invoke actions serially, where each action waits for its predecessor\n    // to complete. `currentPromise` is the i'th promise in the chain.\n    /** @type {?Promise} */\n    let currentPromise = null;\n    action.actionInfos.forEach((actionInfo) => {\n      const {args, method, str, target} = actionInfo;\n      const dereferencedArgs = dereferenceArgsVariables(args, event, opt_args);\n      const invokeAction = () => {\n        const node = this.getActionNode_(target);\n        if (!node) {\n          this.error_(`Target \"${target}\" not found for action [${str}].`);\n          return;\n        }\n        const invocation = new ActionInvocation(\n          node,\n          method,\n          dereferencedArgs,\n          source,\n          action.node,\n          event,\n          trust,\n          actionEventType,\n          node.tagName || target,\n          sequenceId\n        );\n        return this.invoke_(invocation);\n      };\n      // Wait for the previous action, if any.\n      currentPromise = currentPromise\n        ? currentPromise.then(invokeAction)\n        : invokeAction();\n    });\n\n    return action.actionInfos.length >= 1;\n  }\n\n  /**\n   * @param {string} message\n   * @param {?Element=} opt_element\n   * @private\n   */\n  error_(message, opt_element) {\n    if (opt_element) {\n      // reportError() supports displaying the element in dev console.\n      const e = user().createError(`[${TAG_}] ${message}`);\n      reportError(e, opt_element);\n      throw e;\n    } else {\n      user().error(TAG_, message);\n    }\n  }\n\n  /**\n   * @param {!ActionInvocation} invocation\n   * @return {?Promise}\n   * @private\n   */\n  invoke_(invocation) {\n    const {method, tagOrTarget} = invocation;\n\n    // Check that this action is allowlisted (if a allowlist is set).\n    if (this.allowlist_) {\n      if (!isActionAllowlisted(invocation, this.allowlist_)) {\n        this.error_(\n          `\"${tagOrTarget}.${method}\" is not allowlisted ${JSON.stringify(\n            this.allowlist_\n          )}.`\n        );\n        return null;\n      }\n    }\n\n    // Handle global targets e.g. \"AMP\".\n    const globalTarget = this.globalTargets_[tagOrTarget];\n    if (globalTarget) {\n      return globalTarget(invocation);\n    }\n\n    // Subsequent handlers assume that invocation target is an Element.\n    const node = dev().assertElement(invocation.node);\n\n    // Handle global actions e.g. \"<any-element-id>.toggle\".\n    const globalMethod = this.globalMethodHandlers_[method];\n    if (globalMethod && invocation.satisfiesTrust(globalMethod.minTrust)) {\n      return globalMethod.handler(invocation);\n    }\n\n    // Handle element-specific actions.\n    const lowerTagName = node.tagName.toLowerCase();\n    if (isAmpTagName(lowerTagName)) {\n      if (node.enqueAction) {\n        node.enqueAction(invocation);\n      } else {\n        this.error_(`Unrecognized AMP element \"${lowerTagName}\".`, node);\n      }\n      return null;\n    }\n\n    // Special non-AMP elements with AMP ID or known supported actions.\n    const nonAmpActions = NON_AMP_ELEMENTS_ACTIONS_[lowerTagName];\n    // TODO(dvoytenko, #7063): switch back to `target.id` with form proxy.\n    const targetId = node.getAttribute('id') || '';\n    if (\n      isAmpTagName(targetId) ||\n      (nonAmpActions && nonAmpActions.indexOf(method) > -1)\n    ) {\n      const handler = node[ACTION_HANDLER_];\n      if (handler) {\n        handler(invocation);\n      } else {\n        node[ACTION_QUEUE_] = node[ACTION_QUEUE_] || [];\n        node[ACTION_QUEUE_].push(invocation);\n      }\n      return null;\n    }\n\n    // Unsupported method.\n    this.error_(\n      `Target (${tagOrTarget}) doesn't support \"${method}\" action.`,\n      invocation.caller\n    );\n\n    return null;\n  }\n\n  /**\n   * @param {!Element} target\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {?{node: !Element, actionInfos: !Array<!ActionInfoDef>}}\n   */\n  findAction_(target, actionEventType, opt_stopAt) {\n    // Go from target up the DOM tree and find the applicable action.\n    let n = target;\n    while (n) {\n      if (opt_stopAt && n == opt_stopAt) {\n        return null;\n      }\n      const actionInfos = this.matchActionInfos_(n, actionEventType);\n      if (actionInfos && isEnabled(n)) {\n        return {node: n, actionInfos: devAssert(actionInfos)};\n      }\n      n = n.parentElement;\n    }\n    return null;\n  }\n\n  /**\n   * @param {!Element} node\n   * @param {string} actionEventType\n   * @return {?Array<!ActionInfoDef>}\n   */\n  matchActionInfos_(node, actionEventType) {\n    const actionMap = this.getActionMap_(node, actionEventType);\n    if (!actionMap) {\n      return null;\n    }\n    return actionMap[actionEventType] || null;\n  }\n\n  /**\n   * @param {!Element} node\n   * @param {string} actionEventType\n   * @return {?Object<string, !Array<!ActionInfoDef>>}\n   */\n  getActionMap_(node, actionEventType) {\n    let actionMap = node[ACTION_MAP_];\n    if (actionMap === undefined) {\n      actionMap = null;\n      if (node.hasAttribute('on')) {\n        const action = node.getAttribute('on');\n        actionMap = parseActionMap(action, node);\n        node[ACTION_MAP_] = actionMap;\n      } else if (node.hasAttribute('execute')) {\n        const action = node.getAttribute('execute');\n        actionMap = parseActionMap(`${actionEventType}:${action}`, node);\n        node[ACTION_MAP_] = actionMap;\n      }\n    }\n    return actionMap;\n  }\n\n  /**\n   * Resets a node's actions with those defined in the given actions string.\n   * @param {!Element} node\n   * @param {string} actionsStr\n   */\n  setActions(node, actionsStr) {\n    node.setAttribute('on', actionsStr);\n\n    // Clear cache.\n    delete node[ACTION_MAP_];\n  }\n\n  /**\n   * Given a browser 'change' or 'input' event, add `detail` property to it\n   * containing allowlisted properties of the target element. Noop if `detail`\n   * is readonly.\n   * @param {!ActionEventDef} event\n   * @private\n   */\n  addTargetPropertiesAsDetail_(event) {\n    const detail = /** @type {!JsonObject} */ (map());\n    const {target} = event;\n\n    if (target.value !== undefined) {\n      detail['value'] = target.value;\n    }\n\n    // Check tagName instead since `valueAsNumber` isn't supported on IE.\n    if (target.tagName == 'INPUT') {\n      // Probably supported natively but convert anyways for consistency.\n      detail['valueAsNumber'] = Number(target.value);\n    }\n\n    if (target.checked !== undefined) {\n      detail['checked'] = target.checked;\n    }\n\n    if (target.min !== undefined || target.max !== undefined) {\n      detail['min'] = target.min;\n      detail['max'] = target.max;\n    }\n\n    if (target.files) {\n      detail['files'] = toArray(target.files).map((file) => ({\n        'name': file.name,\n        'size': file.size,\n        'type': file.type,\n      }));\n    }\n\n    if (Object.keys(detail).length > 0) {\n      try {\n        event.detail = detail;\n      } catch {} // event.detail is readonly\n    }\n  }\n}\n\n/**\n * @param {string} lowercaseTagName\n * @return {boolean}\n * @private\n */\nfunction isAmpTagName(lowercaseTagName) {\n  return lowercaseTagName.substring(0, 4) === 'amp-';\n}\n\n/**\n * Returns `true` if the given action invocation is allowlisted in the given\n * allowlist. Default actions' alias, 'activate', are automatically\n * allowlisted if their corresponding registered alias is allowlisted.\n * @param {!ActionInvocation} invocation\n * @param {!Array<{tagOrTarget: string, method: string}>} allowlist\n * @return {boolean}\n * @private\n */\nfunction isActionAllowlisted(invocation, allowlist) {\n  let {method} = invocation;\n  const {node, tagOrTarget} = invocation;\n  // Use alias if default action is invoked.\n  if (\n    method === DEFAULT_ACTION &&\n    typeof node.getDefaultActionAlias == 'function'\n  ) {\n    method = node.getDefaultActionAlias();\n  }\n  const lcMethod = method.toLowerCase();\n  const lcTagOrTarget = tagOrTarget.toLowerCase();\n  return allowlist.some((w) => {\n    if (\n      w.tagOrTarget.toLowerCase() === lcTagOrTarget ||\n      w.tagOrTarget === '*'\n    ) {\n      if (w.method.toLowerCase() === lcMethod) {\n        return true;\n      }\n    }\n    return false;\n  });\n}\n\n/**\n * A clone of an event object with its function properties replaced.\n * This is useful e.g. for event objects that need to be passed to an async\n * context, but the browser might have cleaned up the original event object.\n * This clone replaces functions with error throws since they won't behave\n * normally after the original object has been destroyed.\n * @private visible for testing\n */\nexport class DeferredEvent {\n  /**\n   * @param {!Event} event\n   */\n  constructor(event) {\n    /** @type {?Object} */\n    this.detail = null;\n\n    cloneWithoutFunctions(event, this);\n  }\n}\n\n/**\n * Clones an object and replaces its function properties with throws.\n * @param {!T} original\n * @param {!T=} opt_dest\n * @return {!T}\n * @template T\n * @private\n */\nfunction cloneWithoutFunctions(original, opt_dest) {\n  const clone = opt_dest || map();\n  for (const prop in original) {\n    const value = original[prop];\n    if (typeof value === 'function') {\n      clone[prop] = notImplemented;\n    } else {\n      clone[prop] = original[prop];\n    }\n  }\n  return clone;\n}\n\n/** @private */\nfunction notImplemented() {\n  devAssert(null, 'Deferred events cannot access native event functions.');\n}\n\n/**\n * @param {string} action\n * @param {!Element} context\n * @return {?Object<string, !Array<!ActionInfoDef>>}\n * @private Visible for testing only.\n */\nexport function parseActionMap(action, context) {\n  const assertAction = assertActionForParser.bind(null, action, context);\n  const assertToken = assertTokenForParser.bind(null, action, context);\n\n  let actionMap = null;\n\n  const toks = new ParserTokenizer(action);\n  let tok;\n  let peek;\n  do {\n    tok = toks.next();\n    if (\n      tok.type == TokenType.EOF ||\n      (tok.type == TokenType.SEPARATOR && tok.value == ';')\n    ) {\n      // Expected, ignore.\n    } else if (tok.type == TokenType.LITERAL || tok.type == TokenType.ID) {\n      // Format: event:target.method\n\n      // Event: \"event:\"\n      const event = tok.value;\n\n      // Target: \":target.\" separator\n      assertToken(toks.next(), [TokenType.SEPARATOR], ':');\n\n      const actions = [];\n\n      // Handlers for event.\n      do {\n        const target = assertToken(toks.next(), [\n          TokenType.LITERAL,\n          TokenType.ID,\n        ]).value;\n\n        // Method: \".method\". Method is optional.\n        let method = DEFAULT_ACTION;\n        let args = null;\n\n        peek = toks.peek();\n        if (peek.type == TokenType.SEPARATOR && peek.value == '.') {\n          toks.next(); // Skip '.'\n          method =\n            assertToken(toks.next(), [TokenType.LITERAL, TokenType.ID]).value ||\n            method;\n\n          // Optionally, there may be arguments: \"(key = value, key = value)\".\n          peek = toks.peek();\n          if (peek.type == TokenType.SEPARATOR && peek.value == '(') {\n            toks.next(); // Skip '('\n            args = tokenizeMethodArguments(toks, assertToken, assertAction);\n          }\n        }\n\n        actions.push({\n          event,\n          target,\n          method,\n          args:\n            args && getMode().test && Object.freeze\n              ? Object.freeze(args)\n              : args,\n          str: action,\n        });\n\n        peek = toks.peek();\n      } while (\n        peek.type == TokenType.SEPARATOR &&\n        peek.value == ',' &&\n        toks.next()\n      ); // skip \",\" when found\n\n      if (!actionMap) {\n        actionMap = map();\n      }\n\n      actionMap[event] = actions;\n    } else {\n      // Unexpected token.\n      assertAction(false, `; unexpected token [${tok.value || ''}]`);\n    }\n  } while (tok.type != TokenType.EOF);\n\n  return actionMap;\n}\n\n/**\n * Tokenizes and returns method arguments, e.g. target.method(arguments).\n * @param {!ParserTokenizer} toks\n * @param {!Function} assertToken\n * @param {!Function} assertAction\n * @return {?ActionInfoArgsDef}\n * @private\n */\nfunction tokenizeMethodArguments(toks, assertToken, assertAction) {\n  let peek = toks.peek();\n  let tok;\n  let args = null;\n  // Object literal. Format: {...}\n  if (peek.type == TokenType.OBJECT) {\n    // Don't parse object literals. Tokenize as a single expression\n    // fragment and delegate to specific action handler.\n    args = map();\n    const {value} = toks.next();\n    args[RAW_OBJECT_ARGS_KEY] = value;\n    assertToken(toks.next(), [TokenType.SEPARATOR], ')');\n  } else {\n    // Key-value pairs. Format: key = value, ....\n    do {\n      tok = toks.next();\n      const {type, value} = tok;\n      if (type == TokenType.SEPARATOR && (value == ',' || value == ')')) {\n        // Expected: ignore.\n      } else if (type == TokenType.LITERAL || type == TokenType.ID) {\n        // Key: \"key = \"\n        assertToken(toks.next(), [TokenType.SEPARATOR], '=');\n        // Value is either a literal or an expression: \"foo.bar.baz\"\n        tok = assertToken(toks.next(/* convertValue */ true), [\n          TokenType.LITERAL,\n          TokenType.ID,\n        ]);\n        const argValueTokens = [tok];\n        // Expressions have one or more dereferences: \".identifier\"\n        if (tok.type == TokenType.ID) {\n          for (\n            peek = toks.peek();\n            peek.type == TokenType.SEPARATOR && peek.value == '.';\n            peek = toks.peek()\n          ) {\n            toks.next(); // Skip '.'.\n            tok = assertToken(toks.next(false), [TokenType.ID]);\n            argValueTokens.push(tok);\n          }\n        }\n        const argValue = argValueForTokens(argValueTokens);\n        if (!args) {\n          args = map();\n        }\n        args[value] = argValue;\n        peek = toks.peek();\n        assertAction(\n          peek.type == TokenType.SEPARATOR &&\n            (peek.value == ',' || peek.value == ')'),\n          'Expected either [,] or [)]'\n        );\n      } else {\n        // Unexpected token.\n        assertAction(false, `; unexpected token [${tok.value || ''}]`);\n      }\n    } while (!(tok.type == TokenType.SEPARATOR && tok.value == ')'));\n  }\n  return args;\n}\n\n/**\n * @param {Array<!TokenDef>} tokens\n * @return {?ActionInfoArgValueDef}\n * @private\n */\nfunction argValueForTokens(tokens) {\n  if (tokens.length == 0) {\n    return null;\n  } else if (tokens.length == 1) {\n    return /** @type {(boolean|number|string)} */ (tokens[0].value);\n  } else {\n    const values = tokens.map((token) => token.value);\n    const expression = values.join('.');\n    return /** @type {ActionInfoArgExpressionDef} */ ({expression});\n  }\n}\n\n/**\n * Dereferences expression args in `args` using values in data.\n * @param {?ActionInfoArgsDef} args\n * @param {?ActionEventDef} event\n * @param {?JsonObject=} opt_args\n * @return {?JsonObject}\n * @private\n */\nexport function dereferenceArgsVariables(args, event, opt_args) {\n  if (!args) {\n    return args;\n  }\n  const data = opt_args || dict({});\n  if (event) {\n    const detail = getDetail(/** @type {!Event} */ (event));\n    if (detail) {\n      data['event'] = detail;\n    }\n  }\n  const applied = map();\n  Object.keys(args).forEach((key) => {\n    let value = args[key];\n    // Only JSON expression strings that contain dereferences (e.g. `foo.bar`)\n    // are processed as ActionInfoArgExpressionDef. We also support\n    // dereferencing strings like `foo` iff there is a corresponding key in\n    // `data`. Otherwise, `foo` is treated as a string \"foo\".\n    if (typeof value == 'object' && value.expression) {\n      const expr = /** @type {ActionInfoArgExpressionDef} */ (value).expression;\n      const exprValue = getValueForExpr(data, expr);\n      // If expr can't be found in data, use null instead of undefined.\n      value = exprValue === undefined ? null : exprValue;\n    }\n    if (data[value]) {\n      applied[key] = data[value];\n    } else {\n      applied[key] = value;\n    }\n  });\n  return applied;\n}\n\n/**\n * @param {string} s\n * @param {!Element} context\n * @param {?T} condition\n * @param {string=} opt_message\n * @return {T}\n * @template T\n * @private\n */\nfunction assertActionForParser(s, context, condition, opt_message) {\n  return userAssert(\n    condition,\n    'Invalid action definition in %s: [%s] %s',\n    context,\n    s,\n    opt_message || ''\n  );\n}\n\n/**\n * @param {string} s\n * @param {!Element} context\n * @param {!TokenDef} tok\n * @param {Array<TokenType>} types\n * @param {*=} opt_value\n * @return {!TokenDef}\n * @private\n */\nfunction assertTokenForParser(s, context, tok, types, opt_value) {\n  if (opt_value !== undefined) {\n    assertActionForParser(\n      s,\n      context,\n      types.includes(tok.type) && tok.value == opt_value,\n      `; expected [${opt_value}]`\n    );\n  } else {\n    assertActionForParser(s, context, types.includes(tok.type));\n  }\n  return tok;\n}\n\n/**\n * @enum {number}\n */\nconst TokenType = {\n  INVALID: 0,\n  EOF: 1,\n  SEPARATOR: 2,\n  LITERAL: 3,\n  ID: 4,\n  OBJECT: 5,\n};\n\n/**\n * @typedef {{type: TokenType, value: *}}\n */\nlet TokenDef;\n\n/** @private @const {string} */\nconst WHITESPACE_SET = ' \\t\\n\\r\\f\\v\\u00A0\\u2028\\u2029';\n\n/** @private @const {string} */\nconst SEPARATOR_SET = ';:.()=,|!';\n\n/** @private @const {string} */\nconst STRING_SET = '\"\\'';\n\n/** @private @const {string} */\nconst OBJECT_SET = '{}';\n\n/** @private @const {string} */\nconst SPECIAL_SET = WHITESPACE_SET + SEPARATOR_SET + STRING_SET + OBJECT_SET;\n\n/** @private */\nclass ParserTokenizer {\n  /**\n   * @param {string} str\n   */\n  constructor(str) {\n    /** @private @const {string} */\n    this.str_ = str;\n\n    /** @private {number} */\n    this.index_ = -1;\n  }\n\n  /**\n   * Returns the next token and advances the position.\n   * @param {boolean=} opt_convertValues\n   * @return {!TokenDef}\n   */\n  next(opt_convertValues) {\n    const tok = this.next_(opt_convertValues || false);\n    this.index_ = tok.index;\n    return tok;\n  }\n\n  /**\n   * Returns the next token but keeps the current position.\n   * @param {boolean=} opt_convertValues\n   * @return {!TokenDef}\n   */\n  peek(opt_convertValues) {\n    return this.next_(opt_convertValues || false);\n  }\n\n  /**\n   * @param {boolean} convertValues\n   * @return {!{type: TokenType, value: *, index: number}}\n   */\n  next_(convertValues) {\n    let newIndex = this.index_ + 1;\n    if (newIndex >= this.str_.length) {\n      return {type: TokenType.EOF, index: this.index_};\n    }\n\n    let c = this.str_.charAt(newIndex);\n\n    // Whitespace: standard set.\n    if (WHITESPACE_SET.indexOf(c) != -1) {\n      newIndex++;\n      for (; newIndex < this.str_.length; newIndex++) {\n        if (WHITESPACE_SET.indexOf(this.str_.charAt(newIndex)) == -1) {\n          break;\n        }\n      }\n      if (newIndex >= this.str_.length) {\n        return {type: TokenType.EOF, index: newIndex};\n      }\n      c = this.str_.charAt(newIndex);\n    }\n\n    // A numeric. Notice that it steals the `.` from separators.\n    if (\n      convertValues &&\n      (isNum(c) ||\n        (c == '.' &&\n          newIndex + 1 < this.str_.length &&\n          isNum(this.str_[newIndex + 1])))\n    ) {\n      let hasFraction = c == '.';\n      let end = newIndex + 1;\n      for (; end < this.str_.length; end++) {\n        const c2 = this.str_.charAt(end);\n        if (c2 == '.') {\n          hasFraction = true;\n          continue;\n        }\n        if (!isNum(c2)) {\n          break;\n        }\n      }\n      const s = this.str_.substring(newIndex, end);\n      const value = hasFraction ? parseFloat(s) : parseInt(s, 10);\n      newIndex = end - 1;\n      return {type: TokenType.LITERAL, value, index: newIndex};\n    }\n\n    // Different separators.\n    if (SEPARATOR_SET.indexOf(c) != -1) {\n      return {type: TokenType.SEPARATOR, value: c, index: newIndex};\n    }\n\n    // String literal.\n    if (STRING_SET.indexOf(c) != -1) {\n      let end = -1;\n      for (let i = newIndex + 1; i < this.str_.length; i++) {\n        if (this.str_.charAt(i) == c) {\n          end = i;\n          break;\n        }\n      }\n      if (end == -1) {\n        return {type: TokenType.INVALID, index: newIndex};\n      }\n      const value = this.str_.substring(newIndex + 1, end);\n      newIndex = end;\n      return {type: TokenType.LITERAL, value, index: newIndex};\n    }\n\n    // Object literal.\n    if (c == '{') {\n      let numberOfBraces = 1;\n      let end = -1;\n      for (let i = newIndex + 1; i < this.str_.length; i++) {\n        const char = this.str_[i];\n        if (char == '{') {\n          numberOfBraces++;\n        } else if (char == '}') {\n          numberOfBraces--;\n        }\n        if (numberOfBraces <= 0) {\n          end = i;\n          break;\n        }\n      }\n      if (end == -1) {\n        return {type: TokenType.INVALID, index: newIndex};\n      }\n      const value = this.str_.substring(newIndex, end + 1);\n      newIndex = end;\n      return {type: TokenType.OBJECT, value, index: newIndex};\n    }\n\n    // Advance until next special character.\n    let end = newIndex + 1;\n    for (; end < this.str_.length; end++) {\n      if (SPECIAL_SET.indexOf(this.str_.charAt(end)) != -1) {\n        break;\n      }\n    }\n    const s = this.str_.substring(newIndex, end);\n    newIndex = end - 1;\n\n    // Boolean literal.\n    if (convertValues && (s == 'true' || s == 'false')) {\n      const value = s == 'true';\n      return {type: TokenType.LITERAL, value, index: newIndex};\n    }\n\n    // Identifier.\n    if (!isNum(s.charAt(0))) {\n      return {type: TokenType.ID, value: s, index: newIndex};\n    }\n\n    // Key.\n    return {type: TokenType.LITERAL, value: s, index: newIndex};\n  }\n}\n\n/**\n * Tests whether a chacter is a number.\n * @param {string} c\n * @return {boolean}\n */\nfunction isNum(c) {\n  return c >= '0' && c <= '9';\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installActionServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    'action',\n    ActionService,\n    /* opt_instantiate */ true\n  );\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {dev} from './log';\nimport {whenUpgradedToCustomElement} from './dom';\n\nexport const MIN_VISIBILITY_RATIO_FOR_AUTOPLAY = 0.5;\n\n/**\n * VideoInterface defines a common video API which any AMP component that plays\n * videos is expected to implement.\n *\n * AMP runtime uses this common API to provide consistent video experience and\n * analytics across all video players.\n *\n * Components implementing this interface must also extend\n * {@link ./base-element.BaseElement} and register with the\n * Video Manager {@link ./service/video-manager-impl.VideoManager} during\n * their `builtCallback`.\n *\n * @interface\n */\nexport class VideoInterface {\n  /**\n   * See `BaseElement`.\n   * @return {!./utils/signals.Signals}\n   */\n  signals() {}\n\n  /**\n   * See `BaseElement`.\n   * @param {function()} unusedMutator\n   * @return {!Promise}\n   */\n  mutateElementSkipRemeasure(unusedMutator) {}\n\n  /**\n   * Whether the component supports video playback in the current platform.\n   * If false, component will be not treated as a video component.\n   * @return {boolean}\n   */\n  supportsPlatform() {}\n\n  /**\n   * Whether users can interact with the video such as pausing it.\n   * Example of non-interactive videos include design background videos where\n   * all controls are hidden from the user.\n   *\n   * @return {boolean}\n   */\n  isInteractive() {}\n\n  /**\n   * Current playback time in seconds at time of trigger.\n   *\n   * This is used for analytics metadata.\n   *\n   * @return {number}\n   */\n  getCurrentTime() {}\n\n  /**\n   * Total duration of the video in seconds\n   *\n   * This is used for analytics metadata.\n   *\n   * @return {number}\n   */\n  getDuration() {}\n\n  /**\n   * Get a 2d array of start and stop times that the user has watched.\n   * This is used for analytics metadata.\n   * @return {!Array<Array<number>>}\n   */\n  getPlayedRanges() {}\n\n  /**\n   * Plays the video.\n   *\n   * @param {boolean} unusedIsAutoplay Whether the call to the `play` method is\n   * triggered by the autoplay functionality. Video players can use this hint\n   * to make decisions such as not playing pre-roll video ads.\n   */\n  play(unusedIsAutoplay) {}\n\n  /**\n   * Pauses the video.\n   */\n  pause() {}\n\n  /**\n   * Mutes the video.\n   * Implementation is required for autoplay and mute/unmute controls on docked\n   * video.\n   */\n  mute() {}\n\n  /**\n   * Unmutes the video.\n   * Implementation is required for autoplay and mute/unmute controls on docked\n   * video.\n   */\n  unmute() {}\n\n  /**\n   * Makes the video UI controls visible.\n   *\n   * AMP will not call this method if `controls` attribute is not set.\n   *\n   * Implementation is required for docked video.\n   */\n  showControls() {}\n\n  /**\n   * Hides the video UI controls.\n   *\n   * AMP will not call this method if `controls` attribute is not set.\n   *\n   * Implementation is required for docked video.\n   */\n  hideControls() {}\n\n  /**\n   * Returns video's meta data (artwork, title, artist, album, etc.) for use\n   * with the Media Session API\n   * @return {!./mediasession-helper.MetadataDef|undefined} metadata\n   *   - artwork (Array): URL to the poster image (preferably a 512x512 PNG)\n   *   - title (string): Name of the video\n   *   - artist (string): Name of the video's author/artist\n   *   - album (string): Name of the video's album if it exists\n   */\n  getMetadata() {}\n\n  /**\n   * If returning true, it's assumed that the embedded video document internally\n   * implements a feature to enter fullscreen on device rotation, so that the\n   * VideoManager does not override it.\n   *\n   * Otherwise, the feature is implemented automatically when using the\n   * `rotate-to-fullscreen` attribute.\n   *\n   * @return {boolean}\n   */\n  preimplementsAutoFullscreen() {}\n\n  /**\n   * If returning true, it's assumed that the embedded video document internally\n   * implements the MediaSession API internally so that the VideoManager won't\n   * replace it.\n   *\n   * Otherwise provided and inferred metadata are used to update the video's\n   * Media Session.\n   *\n   * @return {boolean}\n   */\n  preimplementsMediaSessionAPI() {}\n\n  /**\n   * Enables fullscreen on the internal video element\n   * NOTE: While implementing, keep in mind that Safari/iOS do not allow taking\n   * any element other than <video> to fullscreen, if the player has an internal\n   * implementation of fullscreen (flash for example) then check\n   * if Services.platformFor(this.win).isSafari is true and use the internal\n   * implementation instead. If not, it is recommended to take the iframe\n   * to fullscreen using fullscreenEnter from dom.js\n   */\n  fullscreenEnter() {}\n\n  /**\n   * Quits fullscreen mode\n   */\n  fullscreenExit() {}\n\n  /**\n   * Returns whether the video is currently in fullscreen mode or not.\n   * @return {boolean}\n   */\n  isFullscreen() {}\n\n  /**\n   * Seeks the video to a specified time.\n   * @param {number} unusedTimeSeconds\n   */\n  seekTo(unusedTimeSeconds) {}\n}\n\n/** @type {!AmpElement} */\nVideoInterface.prototype.element;\n\n/** @type {!Window} */\nVideoInterface.prototype.win;\n\n/**\n * Attributes\n *\n * Components implementing the VideoInterface are expected to support\n * the following attributes.\n *\n * @enum {string}\n */\nexport const VideoAttributes = {\n  /**\n   * autoplay\n   *\n   * Whether the developer has configured autoplay on the component.\n   * This is normally done by setting `autoplay` attribute on the component.\n   *\n   * AMP runtime manages autoplay behavior itself using methods such as `play`,\n   * `pause`, `showControls`, `hideControls`, `mute`, etc.. therefore components\n   * should not propagate the autoplay attribute to the underlying player\n   * implementation.\n   *\n   * When a video is requested to autoplay, AMP will automatically\n   * mute and hide the controls for the video, when video is 75% visible in\n   * the viewport, AMP will play the video and later pauses it when 25%\n   * or more of the video exits the viewport. If an auto-playing video also has\n   * controls, AMP will install a tap\n   * handler on the video, and when an end-user taps the video, AMP will show\n   * the controls.\n   *\n   */\n  AUTOPLAY: 'autoplay',\n  /**\n   * dock\n   *\n   * Setting the `dock` attribute on the component makes the video minimize\n   * to the corner when scrolled out of view and has been interacted with.\n   */\n  DOCK: 'dock',\n  /**\n   * rotate-to-fullscreen\n   *\n   * If enabled, this automatically expands the currently visible video and\n   * playing to fullscreen when the user changes the device's orientation to\n   * landscape if the video was started following a user interaction\n   * (not autoplay)\n   *\n   * Dependent upon browser support of\n   * http://caniuse.com/#feat=screen-orientation\n   * and http://caniuse.com/#feat=fullscreen\n   */\n  ROTATE_TO_FULLSCREEN: 'rotate-to-fullscreen',\n  /**\n   * noaudio\n   *\n   * If set and autoplay, the equalizer icon will not be displayed.\n   */\n  NO_AUDIO: 'noaudio',\n};\n\n/**\n * Events\n *\n * Components implementing the VideoInterface are expected to dispatch\n * the following DOM events.\n *\n * @enum {string}\n */\nexport const VideoEvents = {\n  /**\n   * registered\n   *\n   * Fired when the video player element is built and has been registered with\n   * the video manager.\n   *\n   * @event registered\n   */\n  REGISTERED: 'registered',\n\n  /**\n   * load\n   *\n   * Fired when the video player is loaded and calls to methods such as `play()`\n   * are allowed.\n   *\n   * @event load\n   */\n  LOAD: 'load',\n\n  /**\n   * loadedmetadata\n   *\n   * Fired when the video's metadata becomes available (e.g. duration).\n   *\n   * @event loadedmetadata\n   */\n  LOADEDMETADATA: 'loadedmetadata',\n\n  /**\n   * loadeddata\n   *\n   * Fired when the user agent can render the media for the first time.\n   *\n   * @event loadeddata\n   */\n  LOADEDDATA: 'loadeddata',\n\n  /**\n   * play\n   *\n   * Fired when the video plays (either because of autoplay or the play method).\n   *\n   * Note: Because this event was not originally present in this interface, we\n   * cannot rely on all all implementations to emit it.\n   *\n   * @event play\n   */\n  PLAY: 'play',\n\n  /**\n   * playing\n   *\n   * Fired when the video begins playing.\n   *\n   * @event playing\n   */\n  PLAYING: 'playing',\n\n  /**\n   * pause\n   *\n   * Fired when the video pauses.\n   *\n   * @event pause\n   */\n  PAUSE: 'pause',\n\n  /**\n   * ended\n   *\n   * Fired when the video ends.\n   *\n   * This event should be fired in addition to `pause` when video ends.\n   *\n   * @event ended\n   */\n  ENDED: 'ended',\n\n  /**\n   * muted\n   *\n   * Fired when the video is muted.\n   *\n   * @event muted\n   */\n  MUTED: 'muted',\n\n  /**\n   * unmuted\n   *\n   * Fired when the video is unmuted.\n   *\n   * @event unmuted\n   */\n  UNMUTED: 'unmuted',\n\n  /**\n   * amp:video:visibility\n   *\n   * Fired when the video's visibility changes.\n   *\n   * @event amp:video:visibility\n   * @property {boolean} visible Whether the video player is visible or not.\n   */\n  VISIBILITY: 'amp:video:visibility',\n\n  /**\n   * reload\n   *\n   * Fired when the video's src changes.\n   *\n   * @event reloaded\n   */\n  RELOAD: 'reloaded',\n\n  /**\n   * pre/mid/post Ad start\n   *\n   * Fired when an Ad starts playing.\n   *\n   * This is used to remove any overlay shims during Ad play during autoplay\n   * or minimized-to-corner version of the player.\n   *\n   * @event ad_start\n   */\n  AD_START: 'ad_start',\n\n  /**\n   * pre/mid/post Ad ends\n   *\n   * Fired when an Ad ends playing.\n   *\n   * This is used to restore any overlay shims during Ad play during autoplay\n   * or minimized-to-corner version of the player.\n   *\n   * @event ad_end\n   */\n  AD_END: 'ad_end',\n\n  /**\n   * A 3p video player can send signals for analytics whose meaning doesn't\n   * fit for other events. In this case, a `tick` event is sent with additional\n   * information in its data property.\n   *\n   * @event amp:video:tick\n   */\n  CUSTOM_TICK: 'amp:video:tick',\n};\n\n/** @typedef {string} */\nexport let PlayingStateDef;\n\n/**\n * Playing States\n *\n * Internal playing states used to distinguish between video playing on user's\n * command and videos playing automatically\n *\n * @enum {string}\n */\nexport const PlayingStates = {\n  /**\n   * playing_manual\n   *\n   * When the video user manually interacted with the video and the video\n   * is now playing\n   *\n   * @event playing_manual\n   */\n  PLAYING_MANUAL: 'playing_manual',\n\n  /**\n   * playing_auto\n   *\n   * When the video has autoplay and the user hasn't interacted with it yet\n   *\n   * @event playing_auto\n   */\n  PLAYING_AUTO: 'playing_auto',\n\n  /**\n   * paused\n   *\n   * When the video is paused.\n   *\n   * @event paused\n   */\n  PAUSED: 'paused',\n};\n\n/** @enum {string} */\nexport const VideoAnalyticsEvents = {\n  /**\n   * video-ended\n   *\n   * Indicates that a video ended.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-ended\n   */\n  ENDED: 'video-ended',\n\n  /**\n   * video-pause\n   *\n   * Indicates that a video paused.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-pause\n   */\n  PAUSE: 'video-pause',\n\n  /**\n   * video-play\n   *\n   * Indicates that a video began to play.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-play\n   */\n  PLAY: 'video-play',\n\n  /**\n   * video-session\n   *\n   * Indicates that some segment of the video played.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-session\n   */\n  SESSION: 'video-session',\n\n  /**\n   * video-session-visible\n   *\n   * Indicates that some segment of the video played in the viewport.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-session-visible\n   */\n  SESSION_VISIBLE: 'video-session-visible',\n\n  /**\n   * video-seconds-played\n   *\n   * Indicates that a video was playing when the\n   * video-seconds-played interval fired.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-session-visible\n   */\n  SECONDS_PLAYED: 'video-seconds-played',\n\n  /**\n   * video-hosted-custom\n   *\n   * Indicates that a custom event incoming from a 3p frame is to be logged.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-custom\n   */\n  CUSTOM: 'video-hosted-custom',\n\n  /**\n   * video-percentage-played\n   *\n   * Indicates that a percentage interval has been played.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-custom\n   */\n  PERCENTAGE_PLAYED: 'video-percentage-played',\n\n  /**\n   * video-ad-start\n   *\n   * Indicates that an ad begins to play.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-ad-start\n   */\n  AD_START: 'video-ad-start',\n\n  /**\n   * video-ad-end\n   *\n   * Indicates that an ad ended.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-ad-end\n   */\n  AD_END: 'video-ad-end',\n};\n\n/**\n * This key can't predictably collide with custom var names as defined in\n * analytics user configuration.\n * @type {string}\n */\nexport const videoAnalyticsCustomEventTypeKey = '__amp:eventType';\n\n/**\n * Helper union type to be used internally, so that the compiler treats\n * `VideoInterface` objects as `BaseElement`s, which they should be anyway.\n *\n * WARNING: Don't use to `register` at the Service level. Registering should\n * only allow `VideoInterface` as a guarding measure.\n *\n * @typedef {!VideoInterface|!./base-element.BaseElement}\n */\nexport let VideoOrBaseElementDef;\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isDockable(element) {\n  return element.hasAttribute(VideoAttributes.DOCK);\n}\n\n/** @enum {string} */\nexport const VideoServiceSignals = {\n  USER_INTERACTED: 'user-interacted',\n  PLAYBACK_DELEGATED: 'playback-delegated',\n};\n\n/** @param {!AmpElement|!VideoOrBaseElementDef} video */\nexport function delegateAutoplay(video) {\n  whenUpgradedToCustomElement(dev().assertElement(video)).then((el) => {\n    el.signals().signal(VideoServiceSignals.PLAYBACK_DELEGATED);\n  });\n}\n\n/** @param {!AmpElement|!VideoOrBaseElementDef} video */\nexport function userInteractedWith(video) {\n  video.signals().signal(VideoServiceSignals.USER_INTERACTED);\n}\n\n/**\n * Classname that media components should annotate themselves with.\n * This applies to all video and audio playback components, regardless of\n * whether they implement a common interface or not.\n *\n * TODO(go.amp.dev/issue/26984): This isn't exclusive to video, but there's no\n * better place to put this now due to OWNERShip. Move.\n */\nexport const MEDIA_COMPONENT_CLASSNAME = 'i-amphtml-media-component';\n\n/**\n * Annotates media component element with a common classname.\n * This applies to all video and audio playback components, regardless of\n * whether they implement a common interface or not.\n * @param {!Element} element\n *\n * TODO(go.amp.dev/issue/26984): This isn't exclusive to video, but there's no\n * better place to put this now due to OWNERShip. Move.\n */\nexport function setIsMediaComponent(element) {\n  element.classList.add(MEDIA_COMPONENT_CLASSNAME);\n}\n", "/**\n* @license\n* Copyright (c) 2014 The Polymer Project Authors. All rights reserved.\n* Use of this source code is governed by a BSD-style\n* license that can be found in the LICENSE file or at\n* https://developers.google.com/open-source/licenses/bsd\n*/\n\n/*\n  This is a limited shim for ShadowDOM css styling.\n  https://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html#styles\n\n  The intention here is to support only the styling features which can be\n  relatively simply implemented. The goal is to allow users to avoid the\n  most obvious pitfalls and do so without compromising performance significantly.\n  For ShadowDOM styling that's not covered here, a set of best practices\n  can be provided that should allow users to accomplish more complex styling.\n\n  The following is a list of specific ShadowDOM styling features and a brief\n  discussion of the approach used to shim.\n\n  Shimmed features:\n\n  * :host, :host-context: ShadowDOM allows styling of the shadowRoot's host\n  element using the :host rule. To shim this feature, the :host styles are\n  reformatted and prefixed with a given scope name and promoted to a\n  document level stylesheet.\n  For example, given a scope name of .foo, a rule like this:\n\n    :host {\n        background: red;\n      }\n    }\n\n  becomes:\n\n    .foo {\n      background: red;\n    }\n\n  * encapsultion: Styles defined within ShadowDOM, apply only to\n  dom inside the ShadowDOM. Polymer uses one of two techniques to imlement\n  this feature.\n\n  By default, rules are prefixed with the host element tag name\n  as a descendant selector. This ensures styling does not leak out of the 'top'\n  of the element's ShadowDOM. For example,\n\n  div {\n      font-weight: bold;\n    }\n\n  becomes:\n\n  x-foo div {\n      font-weight: bold;\n    }\n\n  becomes:\n\n\n  Alternatively, if WebComponents.ShadowCSS.strictStyling is set to true then\n  selectors are scoped by adding an attribute selector suffix to each\n  simple selector that contains the host element tag name. Each element\n  in the element's ShadowDOM template is also given the scope attribute.\n  Thus, these rules match only elements that have the scope attribute.\n  For example, given a scope name of x-foo, a rule like this:\n\n    div {\n      font-weight: bold;\n    }\n\n  becomes:\n\n    div[x-foo] {\n      font-weight: bold;\n    }\n\n  Note that elements that are dynamically added to a scope must have the scope\n  selector added to them manually.\n\n  * upper/lower bound encapsulation: Styles which are defined outside a\n  shadowRoot should not cross the ShadowDOM boundary and should not apply\n  inside a shadowRoot.\n\n  This styling behavior is not emulated. Some possible ways to do this that\n  were rejected due to complexity and/or performance concerns include: (1) reset\n  every possible property for every possible selector for a given scope name;\n  (2) re-implement css in javascript.\n\n  As an alternative, users should make sure to use selectors\n  specific to the scope in which they are working.\n\n  * ::distributed: This behavior is not emulated. It's often not necessary\n  to style the contents of a specific insertion point and instead, descendants\n  of the host element can be styled selectively. Users can also create an\n  extra node around an insertion point and style that node's contents\n  via descendent selectors. For example, with a shadowRoot like this:\n\n    <style>\n      ::content(div) {\n        background: red;\n      }\n    </style>\n    <content></content>\n\n  could become:\n\n    <style>\n      / *@polyfill .content-container div * /\n      ::content(div) {\n        background: red;\n      }\n    </style>\n    <div class=\"content-container\">\n      <content></content>\n    </div>\n\n  Note the use of @polyfill in the comment above a ShadowDOM specific style\n  declaration. This is a directive to the styling shim to use the selector\n  in comments in lieu of the next selector when running under polyfill.\n*/\n\nexport const ShadowCSS = {\n  strictStyling: false,\n  // change a selector like 'div' to 'name div'\n  /** @this {ShadowCSS} */\n  scopeRules: function(cssRules, scopeSelector, opt_transformer) {\n    var cssText = '';\n    if (cssRules) {\n      Array.prototype.forEach.call(cssRules, function(rule) {\n        if (rule.selectorText && (rule.style && rule.style.cssText !== undefined)) {\n          cssText += this.scopeSelector(rule.selectorText, scopeSelector,\n            this.strictStyling, opt_transformer) + ' {\\n\\t';\n          cssText += this.propertiesFromRule(rule) + '\\n}\\n\\n';\n        } else if (rule.type === CSSRule.MEDIA_RULE) {\n          cssText += '@media ' + rule.media.mediaText + ' {\\n';\n          cssText += this.scopeRules(rule.cssRules, scopeSelector);\n          cssText += '\\n}\\n\\n';\n        } else {\n          // KEYFRAMES_RULE in IE throws when we query cssText\n          // when it contains a -webkit- property.\n          // if this happens, we fallback to constructing the rule\n          // from the CSSRuleSet\n          // https://connect.microsoft.com/IE/feedbackdetail/view/955703/accessing-csstext-of-a-keyframe-rule-that-contains-a-webkit-property-via-cssom-generates-exception\n          try {\n            if (rule.cssText) {\n              cssText += rule.cssText + '\\n\\n';\n            }\n          } catch(x) {\n            if (rule.type === CSSRule.KEYFRAMES_RULE && rule.cssRules) {\n              cssText += this.ieSafeCssTextFromKeyFrameRule(rule);\n            }\n          }\n        }\n      }, this);\n    }\n    return cssText;\n  },\n  /** @this {ShadowCSS} */\n  ieSafeCssTextFromKeyFrameRule: function(rule) {\n    var cssText = '@keyframes ' + rule.name + ' {';\n    Array.prototype.forEach.call(rule.cssRules, function(rule) {\n      cssText += ' ' + rule.keyText + ' {' + rule.style.cssText + '}';\n    });\n    cssText += ' }';\n    return cssText;\n  },\n  /** @this {ShadowCSS} */\n  scopeSelector: function(selector, scopeSelector, strict, opt_transformer) {\n    var r = [], parts = selector.split(',');\n    parts.forEach(function(p) {\n      p = p.trim();\n      if (opt_transformer) {\n        p = opt_transformer(p);\n      }\n      if (this.selectorNeedsScoping(p, scopeSelector)) {\n        p = (strict && !p.match(polyfillHostNoCombinator)) ?\n            this.applyStrictSelectorScope(p, scopeSelector) :\n            this.applySelectorScope(p, scopeSelector);\n      }\n      r.push(p);\n    }, this);\n    return r.join(', ');\n  },\n  /** @this {ShadowCSS} */\n  selectorNeedsScoping: function(selector, scopeSelector) {\n    if (Array.isArray(scopeSelector)) {\n      return true;\n    }\n    var re = this.makeScopeMatcher(scopeSelector);\n    return !selector.match(re);\n  },\n  /** @this {ShadowCSS} */\n  makeScopeMatcher: function(scopeSelector) {\n    scopeSelector = scopeSelector.replace(/\\[/g, '\\\\[').replace(/\\]/g, '\\\\]');\n    return new RegExp('^(' + scopeSelector + ')' + selectorReSuffix, 'm');\n  },\n  /** @this {ShadowCSS} */\n  applySelectorScope: function(selector, selectorScope) {\n    return Array.isArray(selectorScope) ?\n        this.applySelectorScopeList(selector, selectorScope) :\n        this.applySimpleSelectorScope(selector, selectorScope);\n  },\n  // apply an array of selectors\n  /** @this {ShadowCSS} */\n  applySelectorScopeList: function(selector, scopeSelectorList) {\n    var r = [];\n    for (var i=0, s; (s=scopeSelectorList[i]); i++) {\n      r.push(this.applySimpleSelectorScope(selector, s));\n    }\n    return r.join(', ');\n  },\n  // scope via name and [is=name]\n  /** @this {ShadowCSS} */\n  applySimpleSelectorScope: function(selector, scopeSelector) {\n    if (selector.match(polyfillHostRe)) {\n      selector = selector.replace(polyfillHostNoCombinator, scopeSelector);\n      return selector.replace(polyfillHostRe, scopeSelector + ' ');\n    } else {\n      return scopeSelector + ' ' + selector;\n    }\n  },\n  // return a selector with [name] suffix on each simple selector\n  // e.g. .foo.bar > .zot becomes .foo[name].bar[name] > .zot[name]\n  /** @this {ShadowCSS} */\n  applyStrictSelectorScope: function(selector, scopeSelector) {\n    scopeSelector = scopeSelector.replace(/\\[is=([^\\]]*)\\]/g, '$1');\n    var splits = [' ', '>', '+', '~'],\n      scoped = selector,\n      attrName = '[' + scopeSelector + ']';\n    splits.forEach(function(sep) {\n      var parts = scoped.split(sep);\n      scoped = parts.map(function(p) {\n        // remove :host since it should be unnecessary\n        var t = p.trim().replace(polyfillHostRe, '');\n        if (t && (splits.indexOf(t) < 0) && (t.indexOf(attrName) < 0)) {\n          p = t.replace(/([^:]*)(:*)(.*)/, '$1' + attrName + '$2$3');\n        }\n        return p;\n      }).join(sep);\n    });\n    return scoped;\n  },\n  /** @this {ShadowCSS} */\n  propertiesFromRule: function(rule) {\n    var cssText = rule.style.cssText;\n    // TODO(sorvell): Safari cssom incorrectly removes quotes from the content\n    // property. (https://bugs.webkit.org/show_bug.cgi?id=118045)\n    // don't replace attr rules\n    if (rule.style.content && !rule.style.content.match(/['\"]+|attr/)) {\n      cssText = cssText.replace(/content:[^;]*;/g, 'content: \\'' +\n          rule.style.content + '\\';');\n    }\n    // TODO(sorvell): we can workaround this issue here, but we need a list\n    // of troublesome properties to fix https://github.com/Polymer/platform/issues/53\n    //\n    // inherit rules can be omitted from cssText\n    // TODO(sorvell): remove when Blink bug is fixed:\n    // https://code.google.com/p/chromium/issues/detail?id=358273\n    var style = rule.style;\n    for (var i in style) {\n      if (style[i] === 'initial') {\n        cssText += i + ': initial; ';\n      }\n    }\n    return cssText;\n  }\n};\n\nvar selectorRe = /([^{]*)({[\\s\\S]*?})/gim,\n    cssCommentRe = /\\/\\*[^*]*\\*+([^/*][^*]*\\*+)*\\//gim,\n    // TODO(sorvell): remove either content or comment\n    cssCommentNextSelectorRe = /\\/\\*\\s*@polyfill ([^*]*\\*+([^/*][^*]*\\*+)*\\/)([^{]*?){/gim,\n    cssContentNextSelectorRe = /polyfill-next-selector[^}]*content\\:[\\s]*?['\"](.*?)['\"][;\\s]*}([^{]*?){/gim,\n    // TODO(sorvell): remove either content or comment\n    cssCommentRuleRe = /\\/\\*\\s@polyfill-rule([^*]*\\*+([^/*][^*]*\\*+)*)\\//gim,\n    cssContentRuleRe = /(polyfill-rule)[^}]*(content\\:[\\s]*['\"](.*?)['\"])[;\\s]*[^}]*}/gim,\n    // TODO(sorvell): remove either content or comment\n    cssCommentUnscopedRuleRe = /\\/\\*\\s@polyfill-unscoped-rule([^*]*\\*+([^/*][^*]*\\*+)*)\\//gim,\n    cssContentUnscopedRuleRe = /(polyfill-unscoped-rule)[^}]*(content\\:[\\s]*['\"](.*?)['\"])[;\\s]*[^}]*}/gim,\n    cssPseudoRe = /::(x-[^\\s{,(]*)/gim,\n    cssPartRe = /::part\\(([^)]*)\\)/gim,\n    // note: :host pre-processed to -shadowcsshost.\n    polyfillHost = '-shadowcsshost',\n    // note: :host-context pre-processed to -shadowcsshostcontext.\n    polyfillHostContext = '-shadowcsscontext',\n    parenSuffix = ')(?:\\\\((' +\n        '(?:\\\\([^)(]*\\\\)|[^)(]*)+?' +\n        ')\\\\))?([^,{]*)';\n    var cssColonHostRe = new RegExp('(' + polyfillHost + parenSuffix, 'gim'),\n    cssColonHostContextRe = new RegExp('(' + polyfillHostContext + parenSuffix, 'gim'),\n    selectorReSuffix = '([>\\\\s~+\\[.,{:][\\\\s\\\\S]*)?$',\n    colonHostRe = /\\:host/gim,\n    colonHostContextRe = /\\:host-context/gim,\n    /* host name without combinator */\n    polyfillHostNoCombinator = polyfillHost + '-no-combinator',\n    polyfillHostRe = new RegExp(polyfillHost, 'gim'),\n    polyfillHostContextRe = new RegExp(polyfillHostContext, 'gim'),\n    shadowDOMSelectorsRe = [\n      />>>/g,\n      /::shadow/g,\n      /::content/g,\n      // Deprecated selectors\n      /\\/deep\\//g, // former >>>\n      /\\/shadow\\//g, // former ::shadow\n      /\\/shadow-deep\\//g, // former /deep/\n      /\\^\\^/g,     // former /shadow/\n      /\\^(?!=)/g   // former /shadow-deep/\n    ];\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Possible versions of Shadow DOM spec\n * @enum {string}\n */\nexport const ShadowDomVersion = {\n  NONE: 'none',\n  V0: 'v0',\n  V1: 'v1',\n};\n\n/**\n * @type {!ShadowDomVersion|undefined}\n * @visibleForTesting\n */\nlet shadowDomSupportedVersion;\n\n/**\n * @type {boolean|undefined}\n * @visibleForTesting\n */\nlet shadowCssSupported;\n\n/**\n * @param {!ShadowDomVersion|undefined} val\n * @visibleForTesting\n */\nexport function setShadowDomSupportedVersionForTesting(val) {\n  shadowDomSupportedVersion = val;\n}\n\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\nexport function setShadowCssSupportedForTesting(val) {\n  shadowCssSupported = val;\n}\n\n/**\n * Returns `true` if the Shadow DOM is supported.\n * @return {boolean}\n */\nexport function isShadowDomSupported() {\n  return getShadowDomSupportedVersion() != ShadowDomVersion.NONE;\n}\n\n/**\n * Returns `true` if Shadow CSS encapsulation is supported.\n * @return {boolean}\n */\nexport function isShadowCssSupported() {\n  if (shadowCssSupported === undefined) {\n    shadowCssSupported =\n      isShadowDomSupported() &&\n      (isNative(Element.prototype.attachShadow) ||\n        isNative(Element.prototype.createShadowRoot));\n  }\n  return shadowCssSupported;\n}\n\n/**\n * Returns `true` if the passed function is native to the browser, and is not\n * polyfilled\n * @param {Function|undefined} func A function that is attatched to a JS\n * object.\n * @return {boolean}\n */\nfunction isNative(func) {\n  return !!func && func.toString().indexOf('[native code]') != -1;\n}\n\n/**\n * Returns the supported version of Shadow DOM spec.\n * @param {typeof Element=} opt_elementClass optional for testing\n * @return {!ShadowDomVersion}\n */\nexport function getShadowDomSupportedVersion(opt_elementClass) {\n  if (shadowDomSupportedVersion === undefined) {\n    shadowDomSupportedVersion = getShadowDomVersion(\n      opt_elementClass || Element\n    );\n  }\n  return shadowDomSupportedVersion;\n}\n\n/**\n * Returns shadow dom version.\n *\n * @param {!typeof Element} element\n * @return {!ShadowDomVersion}\n */\nfunction getShadowDomVersion(element) {\n  if (!!element.prototype.attachShadow) {\n    return ShadowDomVersion.V1;\n  } else if (!!element.prototype.createShadowRoot) {\n    return ShadowDomVersion.V0;\n  }\n  return ShadowDomVersion.NONE;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {DomWriterBulk, DomWriterStreamer} from './utils/dom-writer';\nimport {Services} from './services';\nimport {ShadowCSS} from '../third_party/webcomponentsjs/ShadowCSS';\nimport {\n  ShadowDomVersion,\n  getShadowDomSupportedVersion,\n  isShadowCssSupported,\n} from './core/dom/web-components';\nimport {dev, devAssert} from './log';\nimport {escapeCssSelectorIdent} from './core/dom/css-selectors';\nimport {installCssTransformer} from './style-installer';\nimport {iterateCursor} from './dom';\nimport {setInitialDisplay, setStyle} from './style';\nimport {toArray} from './core/types/array';\nimport {toWin} from './core/window';\n\n/** @const {!RegExp} */\nconst CSS_SELECTOR_BEG_REGEX = /[^\\.\\-\\_0-9a-zA-Z]/;\n\n/** @const {!RegExp} */\nconst CSS_SELECTOR_END_REGEX = /[^\\-\\_0-9a-zA-Z]/;\n\nconst SHADOW_CSS_CACHE = '__AMP_SHADOW_CSS';\n\n/**\n * @type {boolean|undefined}\n */\nlet shadowDomStreamingSupported;\n\n/**\n * Creates a shadow root for the specified host and returns it. Polyfills\n * shadow root creation if necessary.\n * @param {!Element} hostElement\n * @return {!ShadowRoot}\n */\nexport function createShadowRoot(hostElement) {\n  const win = toWin(hostElement.ownerDocument.defaultView);\n\n  const existingRoot = hostElement.shadowRoot || hostElement.__AMP_SHADOW_ROOT;\n  if (existingRoot) {\n    existingRoot./*OK*/ innerHTML = '';\n    return existingRoot;\n  }\n\n  let shadowRoot;\n  const shadowDomSupported = getShadowDomSupportedVersion();\n  if (shadowDomSupported == ShadowDomVersion.V1) {\n    shadowRoot = hostElement.attachShadow({mode: 'open'});\n    if (!shadowRoot.styleSheets) {\n      Object.defineProperty(shadowRoot, 'styleSheets', {\n        get: function () {\n          const items = [];\n          iterateCursor(shadowRoot.childNodes, (child) => {\n            if (child.tagName === 'STYLE') {\n              items.push(child.sheet);\n            }\n          });\n          return items;\n        },\n      });\n    }\n  } else if (shadowDomSupported == ShadowDomVersion.V0) {\n    shadowRoot = hostElement.createShadowRoot();\n  } else {\n    shadowRoot = createShadowRootPolyfill(hostElement);\n  }\n\n  if (!isShadowCssSupported()) {\n    const rootId = `i-amphtml-sd-${win.Math.floor(win.Math.random() * 10000)}`;\n    shadowRoot['id'] = rootId;\n    shadowRoot.host.classList.add(rootId);\n\n    // CSS isolation.\n    installCssTransformer(shadowRoot, (css) => {\n      return transformShadowCss(shadowRoot, css);\n    });\n  }\n\n  return shadowRoot;\n}\n\n/**\n * Shadow root polyfill.\n * @param {!Element} hostElement\n * @return {!ShadowRoot}\n */\nfunction createShadowRootPolyfill(hostElement) {\n  const doc = hostElement.ownerDocument;\n\n  // Host CSS polyfill.\n  hostElement.classList.add('i-amphtml-shadow-host-polyfill');\n  const hostStyle = doc.createElement('style');\n  hostStyle.textContent =\n    '.i-amphtml-shadow-host-polyfill>:not(i-amphtml-shadow-root)' +\n    '{display:none!important}';\n  hostElement.appendChild(hostStyle);\n\n  // Shadow root.\n  const shadowRoot /** @type {!ShadowRoot} */ =\n    // Cast to ShadowRoot even though it is an Element\n    // TODO(@dvoytenko) Consider to switch to a type union instead.\n    /** @type {?}  */ (doc.createElement('i-amphtml-shadow-root'));\n  hostElement.appendChild(shadowRoot);\n  hostElement.__AMP_SHADOW_ROOT = shadowRoot;\n  Object.defineProperty(hostElement, 'shadowRoot', {\n    enumerable: true,\n    configurable: true,\n    value: shadowRoot,\n  });\n\n  // API: https://www.w3.org/TR/shadow-dom/#the-shadowroot-interface\n\n  shadowRoot.host = hostElement;\n\n  // `getElementById` is resolved via `querySelector('#id')`.\n  shadowRoot.getElementById = function (id) {\n    const escapedId = escapeCssSelectorIdent(id);\n    return /** @type {?HTMLElement} */ (\n      shadowRoot./*OK*/ querySelector(`#${escapedId}`)\n    );\n  };\n\n  // The styleSheets property should have a list of local styles.\n  Object.defineProperty(shadowRoot, 'styleSheets', {\n    get: () => {\n      if (!doc.styleSheets) {\n        return [];\n      }\n      return toArray(doc.styleSheets).filter((styleSheet) =>\n        shadowRoot.contains(styleSheet.ownerNode)\n      );\n    },\n  });\n\n  return shadowRoot;\n}\n\n/**\n * Imports a body into a shadow root with the workaround for a polyfill case.\n * @param {!ShadowRoot} shadowRoot\n * @param {!Element} body\n * @param {boolean} deep\n * @return {!Element}\n */\nexport function importShadowBody(shadowRoot, body, deep) {\n  const doc = shadowRoot.ownerDocument;\n  let resultBody;\n  if (isShadowCssSupported()) {\n    resultBody = dev().assertElement(doc.importNode(body, deep));\n  } else {\n    resultBody = doc.createElement('amp-body');\n    setInitialDisplay(resultBody, 'block');\n    for (let i = 0; i < body.attributes.length; i++) {\n      resultBody.setAttribute(\n        body.attributes[0].name,\n        body.attributes[0].value\n      );\n    }\n    if (deep) {\n      for (let n = body.firstChild; !!n; n = n.nextSibling) {\n        resultBody.appendChild(doc.importNode(n, true));\n      }\n    }\n  }\n  setStyle(resultBody, 'position', 'relative');\n  const oldBody = shadowRoot['body'];\n  if (oldBody) {\n    shadowRoot.removeChild(oldBody);\n  }\n  shadowRoot.appendChild(resultBody);\n  Object.defineProperty(shadowRoot, 'body', {\n    configurable: true,\n    value: resultBody,\n  });\n  return resultBody;\n}\n\n/**\n * If necessary, transforms CSS to isolate AMP CSS within the shaodw root and\n * reduce the possibility of high-level conflicts.\n * @param {!ShadowRoot} shadowRoot\n * @param {string} css\n * @return {string}\n */\nexport function transformShadowCss(shadowRoot, css) {\n  return scopeShadowCss(shadowRoot, css);\n}\n\n/**\n * Transforms CSS to isolate AMP CSS within the shadow root and reduce the\n * possibility of high-level conflicts. There are two types of transformations:\n * 1. Root transformation: `body` -> `amp-body`, etc.\n * 2. Scoping: `a {}` -> `.i-amphtml-sd-123 a {}`.\n *\n * @param {!ShadowRoot} shadowRoot\n * @param {string} css\n * @return {string}\n * @visibleForTesting\n */\nexport function scopeShadowCss(shadowRoot, css) {\n  const id = devAssert(shadowRoot['id']);\n  const doc = shadowRoot.ownerDocument;\n  let rules = null;\n  // Try to use a separate document.\n  try {\n    rules = getStylesheetRules(doc.implementation.createHTMLDocument(''), css);\n  } catch (e) {\n    // Ignore.\n  }\n  // Try to use the current document.\n  if (!rules) {\n    try {\n      rules = getStylesheetRules(doc, css);\n    } catch (e) {\n      // Ignore.\n    }\n  }\n\n  // No rules could be parsed - return css as is.\n  if (!rules) {\n    return css;\n  }\n\n  // Patch selectors.\n  // Invoke `ShadowCSS.scopeRules` via `call` because the way it uses `this`\n  // internally conflicts with Closure compiler's advanced optimizations.\n  const {scopeRules} = ShadowCSS;\n  return scopeRules.call(ShadowCSS, rules, `.${id}`, transformRootSelectors);\n}\n\n/**\n * Replaces top-level selectors such as `html` and `body` with their polyfill\n * counterparts: `amp-html` and `amp-body`.\n * @param {string} selector\n * @return {string}\n */\nfunction transformRootSelectors(selector) {\n  return selector.replace(/(html|body)/g, rootSelectorPrefixer);\n}\n\n/**\n * See `transformRootSelectors`.\n * @param {string} match\n * @param {string} name\n * @param {number} pos\n * @param {string} selector\n * @return {string}\n * @private\n */\nfunction rootSelectorPrefixer(match, name, pos, selector) {\n  const prev = selector.charAt(pos - 1);\n  const next = selector.charAt(pos + match.length);\n  if (\n    (!prev || CSS_SELECTOR_BEG_REGEX.test(prev)) &&\n    (!next || CSS_SELECTOR_END_REGEX.test(next))\n  ) {\n    return 'amp-' + match;\n  }\n  return match;\n}\n\n/**\n * @param {!Document} doc\n * @param {string} css\n * @return {?CSSRuleList}\n */\nfunction getStylesheetRules(doc, css) {\n  const style = /** @type {!HTMLStyleElement} */ (doc.createElement('style'));\n  style./*OK*/ textContent = css;\n  try {\n    (doc.head || doc.documentElement).appendChild(style);\n    if (style.sheet) {\n      return /** @type {!CSSStyleSheet} */ (style.sheet).cssRules;\n    }\n    return null;\n  } finally {\n    if (style.parentNode) {\n      style.parentNode.removeChild(style);\n    }\n  }\n}\n\n/**\n * @param {!ShadowRoot} shadowRoot\n * @param {string} name\n * @param {string} cssText\n */\nexport function installShadowStyle(shadowRoot, name, cssText) {\n  const doc = shadowRoot.ownerDocument;\n  const win = toWin(doc.defaultView);\n  if (\n    shadowRoot.adoptedStyleSheets !== undefined &&\n    win.CSSStyleSheet.prototype.replaceSync !== undefined\n  ) {\n    const cache = win[SHADOW_CSS_CACHE] || (win[SHADOW_CSS_CACHE] = {});\n    let styleSheet = cache[name];\n    if (!styleSheet) {\n      styleSheet = new win.CSSStyleSheet();\n      styleSheet.replaceSync(cssText);\n      cache[name] = styleSheet;\n    }\n    shadowRoot.adoptedStyleSheets =\n      shadowRoot.adoptedStyleSheets.concat(styleSheet);\n  } else {\n    const styleEl = doc.createElement('style');\n    styleEl.setAttribute('data-name', name);\n    styleEl.textContent = cssText;\n    shadowRoot.appendChild(styleEl);\n  }\n}\n\n/**\n * @param {!Window} win\n * @visibleForTesting\n */\nexport function resetShadowStyleCacheForTesting(win) {\n  win[SHADOW_CSS_CACHE] = null;\n}\n\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\nexport function setShadowDomStreamingSupportedForTesting(val) {\n  shadowDomStreamingSupported = val;\n}\n\n/**\n * Returns `true` if the Shadow DOM streaming is supported.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isShadowDomStreamingSupported(win) {\n  if (shadowDomStreamingSupported === undefined) {\n    shadowDomStreamingSupported = calcShadowDomStreamingSupported(win);\n  }\n  return shadowDomStreamingSupported;\n}\n\n/**\n * @param {!Window} win\n * @return {boolean}\n */\nfunction calcShadowDomStreamingSupported(win) {\n  // API must be supported.\n  if (\n    !win.document.implementation ||\n    typeof win.document.implementation.createHTMLDocument != 'function'\n  ) {\n    return false;\n  }\n  // Firefox does not support DOM streaming.\n  // See: https://bugzilla.mozilla.org/show_bug.cgi?id=867102\n  if (Services.platformFor(win).isFirefox()) {\n    return false;\n  }\n  // Assume full streaming support.\n  return true;\n}\n\n/**\n * Creates the Shadow DOM writer available on this platform.\n * @param {!Window} win\n * @return {!./utils/dom-writer.DomWriter}\n */\nexport function createShadowDomWriter(win) {\n  if (isShadowDomStreamingSupported(win)) {\n    return new DomWriterStreamer(win);\n  }\n  return new DomWriterBulk(win);\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {\n  assertHttpsUrl,\n  getSourceOrigin,\n  isProxyOrigin,\n  resolveRelativeUrl,\n} from '../../../src/url';\nimport {\n  closestAncestorElementBySelector,\n  scopedQuerySelectorAll,\n} from '../../../src/core/dom/query';\nimport {createShadowRoot} from '../../../src/shadow-embed';\nimport {dev, user, userAssert} from '../../../src/log';\nimport {getMode} from '../../../src/mode';\n\nimport {setStyle, toggle} from '../../../src/style';\n\n/**\n * Returns millis as number if given a string(e.g. 1s, 200ms etc)\n * @param {string} time\n * @param {number=} fallbackMs Used when `time` is not a valid time string.\n * @return {number|undefined}\n */\nexport function timeStrToMillis(time, fallbackMs = NaN) {\n  const match = time.toLowerCase().match(/^([0-9\\.]+)\\s*(s|ms)$/);\n\n  const num = match ? match[1] : undefined;\n  const units = match ? match[2] : undefined;\n\n  if (!match || match.length !== 3 || (units !== 's' && units !== 'ms')) {\n    return fallbackMs;\n  }\n\n  return Math.round((units == 's' ? 1000 : 1) * parseFloat(num));\n}\n\n/**\n * Determines whether the specified element has an action for its on=\"tap:...\"\n * handler.\n * @param {!Element} el\n * @return {boolean}\n */\nexport function hasTapAction(el) {\n  // There are better ways to determine this, but they're all bound to action\n  // service race conditions. This is good enough for our use case.\n  return (\n    el.hasAttribute('on') && !!el.getAttribute('on').match(/(^|;)\\s*tap\\s*:/)\n  );\n}\n\n/**\n * Calculates a client rect without applying scaling transformations.\n * Note: must be run in a vsync measure context.\n * @param {!Element} el\n * @return {!ClientRect}\n */\nexport function unscaledClientRect(el) {\n  const {height, left, top, width} = el./*OK*/ getBoundingClientRect();\n\n  const scaleFactorX = width == 0 ? 1 : width / el./*OK*/ offsetWidth;\n  const scaleFactorY = height == 0 ? 1 : height / el./*OK*/ offsetHeight;\n\n  return /** @type {!ClientRect} */ ({\n    left: left / scaleFactorX,\n    top: top / scaleFactorY,\n    width: width / scaleFactorX,\n    height: height / scaleFactorY,\n  });\n}\n\n/**\n * Finds an amp-video/amp-audio ancestor.\n * @param {!Element} el\n * @return {?AmpElement}\n */\nexport function ampMediaElementFor(el) {\n  return closestAncestorElementBySelector(el, 'amp-video, amp-audio');\n}\n\n/**\n * Creates a shadow root for the provided container, and appends the element\n * along with its CSS.\n * @param  {!Element} container\n * @param  {!Element} element\n * @param  {string} css\n */\nexport function createShadowRootWithStyle(container, element, css) {\n  const style = self.document.createElement('style');\n  style./*OK*/ textContent = css;\n\n  const containerToUse = getMode().test\n    ? container\n    : createShadowRoot(container);\n\n  containerToUse.appendChild(style);\n  containerToUse.appendChild(element);\n}\n\n/**\n * Parses the resolved CSS color property, that is always in the form of\n * `rgba(0, 0, 0, 1)` or `rgb(0, 0, 0)`, that can be retrieved using\n * `getComputedStyle`.\n * Returns an object containing the R, G, and B 8bit numbers.\n * @param  {string} cssValue\n * @return {!Object<string, number>}\n */\nexport function getRGBFromCssColorValue(cssValue) {\n  const regexPattern = /rgba?\\((\\d{1,3}), (\\d{1,3}), (\\d{1,3})/;\n\n  if (!cssValue.match(regexPattern)) {\n    user().error(\n      'UTILS',\n      'getRGBFromCssColorValue expects a parameter in ' +\n        `the form of 'rgba(0, 0, 0, 1)' or 'rgb(0, 0, 0)' but got ${cssValue}`\n    );\n    // Returns a fallback value, to fail 'gracefully' in case a browser we don't\n    // know about gave an unexpected value.\n    return {r: 0, g: 0, b: 0};\n  }\n\n  const matches = regexPattern.exec(cssValue);\n\n  return {\n    r: Number(matches[1]),\n    g: Number(matches[2]),\n    b: Number(matches[3]),\n  };\n}\n\n/**\n * Returns the color, either black or white, that has the best contrast ratio\n * against the provided RGB 8bit values.\n * @param  {!Object<string, number>} rgb  ie: {r: 0, g: 0, b: 0}\n * @return {string} '#fff' or '#000'\n */\nexport function getTextColorForRGB(rgb) {\n  const {b, g, r} = rgb;\n  // Calculates the relative luminance L.\n  // https://www.w3.org/TR/2008/REC-WCAG20-20081211/#relativeluminancedef\n  const getLinearRGBValue = (x) => {\n    // 8bit to sRGB.\n    x /= 255;\n\n    // Converts the gamma-compressed RGB values to linear RGB.\n    return x <= 0.03928 ? x / 12.92 : Math.pow((x + 0.055) / 1.055, 2.4);\n  };\n\n  const linearR = getLinearRGBValue(r);\n  const linearG = getLinearRGBValue(g);\n  const linearB = getLinearRGBValue(b);\n\n  const L = 0.2126 * linearR + 0.7152 * linearG + 0.0722 * linearB;\n\n  // Determines which one of the white and black text have a better contrast\n  // ratio against the used background color.\n  // https://www.w3.org/TR/2008/REC-WCAG20-20081211/#contrast-ratiodef\n  // @TODO(gmajoulet): Improve the text color for high contrast ratio.\n  // 1 is L for #FFF, and 0 is L for #000.\n  // (1 + 0.05) / (L + 0.05) > (L + 0.05) / (0 + 0.05) toggles for L = 0.179.\n  return L > 0.179 ? '#000' : '#FFF';\n}\n\n/**\n * Sets given attribute to the given element in next `mutate` phase.\n * @param {!AMP.BaseElement} elementImpl\n * @param {string} name\n * @param {string=} opt_value\n */\nexport function setAttributeInMutate(elementImpl, name, opt_value) {\n  const value = opt_value || '';\n  elementImpl.mutateElement(() => {\n    elementImpl.element.setAttribute(name, value);\n  });\n}\n\n/**\n * Removes given attribute from the given element in next `mutate` phase.\n * @param {!AMP.BaseElement} elementImpl\n * @param {string} name\n */\nexport function removeAttributeInMutate(elementImpl, name) {\n  elementImpl.mutateElement(() => {\n    elementImpl.element.removeAttribute(name);\n  });\n}\n\n/**\n * @param {!Element} element\n * @param {string|!Location} url\n */\nexport function userAssertValidProtocol(element, url) {\n  userAssert(\n    Services.urlForDoc(element).isProtocolValid(url),\n    'Unsupported protocol for URL %s',\n    url\n  );\n}\n\n/**\n * Gets the origin url for elements that display a url. It\n * trims the protocol prefix and returns only the hostname of the origin.\n * @param {!Element} element\n * @param {string} url\n * @return {string}\n */\nexport function getSourceOriginForElement(element, url) {\n  let domainName;\n\n  try {\n    domainName = getSourceOrigin(Services.urlForDoc(element).parse(url));\n    // Remove protocol prefix.\n    domainName = Services.urlForDoc(element).parse(domainName).hostname;\n  } catch (e) {\n    // Unknown path prefix in url.\n    domainName = Services.urlForDoc(element).parse(url).hostname;\n  }\n  return domainName;\n}\n\n/**\n * Resolves an image url and optimizes it if served from the cache.\n * @param {!Window} win\n * @param {string} url\n * @return {string}\n */\nexport function resolveImgSrc(win, url) {\n  let urlSrc = resolveRelativeUrl(url, win.location);\n  if (isProxyOrigin(win.location.href)) {\n    // TODO(Enriqe): add extra params for resized image, for example:\n    // (/ii/w${width}/s)\n    urlSrc = urlSrc.replace('/c/s/', '/i/s/');\n  }\n  return urlSrc;\n}\n\n/**\n * Whether a Story should show the URL info dialog.\n * @param {!../../../src/service/viewer-interface.ViewerInterface} viewer\n * @return {boolean}\n */\nexport function shouldShowStoryUrlInfo(viewer) {\n  const showStoryUrlInfo = viewer.getParam('showStoryUrlInfo');\n  return showStoryUrlInfo ? showStoryUrlInfo !== '0' : viewer.isEmbedded();\n}\n\n/**\n * Retrieves an attribute src from the <amp-story> element.\n * @param {!Element} element\n * @param {string} attribute\n * @param {string=} warn\n * @return {?string}\n */\nexport function getStoryAttributeSrc(element, attribute, warn = false) {\n  const storyEl = dev().assertElement(\n    closestAncestorElementBySelector(element, 'AMP-STORY')\n  );\n  const attrSrc = storyEl && storyEl.getAttribute(attribute);\n\n  if (attrSrc) {\n    assertHttpsUrl(attrSrc, storyEl, attribute);\n  } else if (warn) {\n    user().warn('AMP-STORY', `Expected ${attribute} attribute on <amp-story>`);\n  }\n\n  return attrSrc;\n}\n\n/**\n * The attribute name for text background color\n * @private @const {string}\n */\nconst TEXT_BACKGROUND_COLOR_ATTRIBUTE_NAME = 'data-text-background-color';\n\n/**\n * The selector for text background color\n * @private @const {string}\n */\nconst TEXT_BACKGROUND_COLOR_SELECTOR = `[${TEXT_BACKGROUND_COLOR_ATTRIBUTE_NAME}]`;\n\n/**\n * Styles text with a background color based on the value of\n * the data-text-background-color attribute\n * @param {!Element} element\n */\nexport function setTextBackgroundColor(element) {\n  const elementsToUpgradeStyles = scopedQuerySelectorAll(\n    element,\n    TEXT_BACKGROUND_COLOR_SELECTOR\n  );\n\n  Array.prototype.forEach.call(elementsToUpgradeStyles, (el) => {\n    const color = el.getAttribute(TEXT_BACKGROUND_COLOR_ATTRIBUTE_NAME);\n    setStyle(el, 'background-color', color);\n  });\n}\n\n/**\n * Click a clone of the anchor in the context of the light dom.\n * Used to apply linker logic on shadow-dom anchors.\n * @param {!Element} anchorElement\n * @param {!Element} domElement element from the light dom\n */\nexport function triggerClickFromLightDom(anchorElement, domElement) {\n  const outerAnchor = anchorElement.cloneNode();\n  toggle(outerAnchor, false);\n  domElement.appendChild(outerAnchor);\n  outerAnchor.click();\n  outerAnchor.remove();\n}\n", "export const CSS = \".i-amphtml-story-focused-state-layer{top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:100001!important;position:absolute!important}.i-amphtml-story-focused-state-layer.i-amphtml-hidden{opacity:0!important;pointer-events:none!important;transition:opacity 0.1s cubic-bezier(0.4,0.0,1,1)!important}.i-amphtml-story-focused-state-layer-nav-button-container{height:100%!important;width:160px!important;position:absolute!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-direction:column!important;flex-direction:column!important;-ms-flex-pack:center!important;justify-content:center!important}.i-amphtml-story-focused-state-layer-nav-button-container.i-amphtml-story-tooltip-nav-button-left{background-image:linear-gradient(90deg,rgba(33,33,33,0.15) 2%,rgba(33,33,33,0))!important;left:0!important}.i-amphtml-story-focused-state-layer-nav-button-container.i-amphtml-story-tooltip-nav-button-right{background-image:linear-gradient(90deg,rgba(33,33,33,0) 2%,rgba(33,33,33,0.15))!important;right:0!important}.i-amphtml-story-focused-state-layer-nav-button{position:absolute!important;top:0!important;bottom:0!important;margin:auto!important;width:48px!important;height:48px!important;padding:0!important;border:0!important;background-color:transparent!important;filter:drop-shadow(0px 0px 16px rgba(0,0,0,0.5))!important;transition:transform 0.2s cubic-bezier(0.0,0.0,0.2,1)!important}.i-amphtml-story-focused-state-layer-nav-button.i-amphtml-story-tooltip-nav-button-left{left:-8px!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' fill='%23FFF'%3E%3Cpath d='M30.83 14.83 28 12 16 24l12 12 2.83-2.83L21.66 24z'/%3E%3Cpath d='M0 0h48v48H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-hidden .i-amphtml-story-focused-state-layer-nav-button.i-amphtml-story-tooltip-nav-button-left{transform:translate3d(8px,0,0);transition:transform 0s linear .1s!important}.i-amphtml-story-focused-state-layer-nav-button.i-amphtml-story-tooltip-nav-button-right{right:-8px!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' fill='%23FFF'%3E%3Cpath d='m20 12-2.83 2.83L26.34 24l-9.17 9.17L20 36l12-12z'/%3E%3Cpath d='M0 0h48v48H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-hidden .i-amphtml-story-focused-state-layer-nav-button.i-amphtml-story-tooltip-nav-button-right{transform:translate3d(-8px,0,0);transition:transform 0s linear .1s!important}[desktop] .i-amphtml-story-focused-state-layer-nav-button-container{display:none!important}.i-amphtml-hidden>.i-amphtml-story-tooltip,.i-amphtml-hidden>.i-amphtml-story-tooltip.i-amphtml-tooltip-arrow-on-top{transform:translateZ(0)!important;transition:transform 0s linear 0.1s!important}.i-amphtml-story-tooltip{max-width:248px!important;height:40px!important;border-radius:6px!important;padding:8px!important;position:absolute!important;box-sizing:border-box!important;text-decoration:none!important;text-shadow:none!important;font-weight:500!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-align:center!important;align-items:center!important;background:#fff!important;box-shadow:0px 6px 16px rgba(0,0,0,0.16)!important;transform:translate3d(0,-16px,0)!important;transition:transform 0.2s cubic-bezier(0.0,0.0,0.2,1)!important}.i-amphtml-story-tooltip-theme-dark{background:#202125!important}.i-amphtml-story-tooltip.i-amphtml-tooltip-arrow-on-top{transform:translate3d(0,16px,0)!important}.i-amphtml-tooltip-text{text-overflow:ellipsis!important;overflow:hidden!important;white-space:nowrap!important;margin:0px 5px!important;font-family:Roboto,sans-serif!important;font-size:14px!important;color:#3c4043!important;letter-spacing:0!important;line-height:20px!important}.i-amphtml-story-tooltip-theme-dark .i-amphtml-tooltip-text{color:#9aa0a6!important}.i-amphtml-story-tooltip-custom-icon{width:24px!important;height:24px!important;margin:0px 5px!important;background-size:cover!important;background-position:50%!important;background-repeat:no-repeat!important;filter:drop-shadow(0px 0px 8px rgba(0,0,0,0.08))!important;-ms-flex-negative:0;flex-shrink:0;border-radius:50%!important}.i-amphtml-story-tooltip-custom-icon.i-amphtml-hidden{display:none!important}.i-amphtml-tooltip-action-icon{width:16px!important;height:16px!important;margin:0px 5px!important;padding-bottom:2px!important;-ms-flex-negative:0;flex-shrink:0}.i-amphtml-tooltip-action-icon-launch{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 48 48' fill='%23757575'%3E%3Cpath d='M0 0h48v48H0z' fill='none'/%3E%3Cpath d='M38 38H10V10h14V6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h28c2.21 0 4-1.79 4-4V24h-4v14zM28 6v4h7.17L15.51 29.66l2.83 2.83L38 12.83V20h4V6H28z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-tooltip-action-icon-expand{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 48 48' fill='%23757575'%3E%3Cpath d='m17.17 32.92 9.17-9.17-9.17-9.17L20 11.75l12 12-12 12z'/%3E%3Cpath d='M0-.25h48v48H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-tooltip-theme-dark .i-amphtml-tooltip-action-icon-launch{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 48 48' fill='rgba(255, 255, 255, 0.54)'%3E%3Cpath d='M0 0h48v48H0z' fill='none'/%3E%3Cpath d='M38 38H10V10h14V6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h28c2.21 0 4-1.79 4-4V24h-4v14zM28 6v4h7.17L15.51 29.66l2.83 2.83L38 12.83V20h4V6H28z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-tooltip-theme-dark .i-amphtml-tooltip-action-icon-expand{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 48 48' fill='rgba(255, 255, 255, 0.54)'%3E%3Cpath d='m17.17 32.92 9.17-9.17-9.17-9.17L20 11.75l12 12-12 12z'/%3E%3Cpath d='M0-.25h48v48H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-tooltip-arrow{border-right:8px solid transparent!important;border-left:8px solid transparent!important;border-top:10px solid #fff!important;position:absolute!important;bottom:-8px!important}.i-amphtml-story-tooltip-theme-dark .i-amphtml-story-tooltip-arrow{border-top:10px solid #202125!important}.i-amphtml-tooltip-arrow-on-top .i-amphtml-story-tooltip-arrow{bottom:auto!important;top:-8px!important;border-top:0px!important;border-bottom:10px solid #fff!important}.i-amphtml-story-tooltip-theme-dark .i-amphtml-tooltip-arrow-on-top .i-amphtml-story-tooltip-arrow{border-bottom:10px solid #202125!important}.amp-social-share-twitter-no-background{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath d='M0 0h400v400H0z'/%3E%3Cpath fill='%231da1f2' fill-rule='nonzero' d='M153.62 301.59c94.34 0 145.94-78.16 145.94-145.94 0-2.22 0-4.43-.15-6.63A104.36 104.36 0 0 0 325 122.47a102.38 102.38 0 0 1-29.46 8.07 51.47 51.47 0 0 0 22.55-28.37 102.79 102.79 0 0 1-32.57 12.45c-15.9-16.906-41.163-21.044-61.625-10.093-20.461 10.95-31.032 34.266-25.785 56.873A145.62 145.62 0 0 1 92.4 107.81c-13.614 23.436-6.66 53.419 15.88 68.47A50.91 50.91 0 0 1 85 169.86v.65c.007 24.416 17.218 45.445 41.15 50.28a51.21 51.21 0 0 1-23.16.88c6.72 20.894 25.976 35.208 47.92 35.62a102.92 102.92 0 0 1-63.7 22 104.41 104.41 0 0 1-12.21-.74 145.21 145.21 0 0 0 78.62 23'/%3E%3C/g%3E%3C/svg%3E\\\")}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story-tooltip.css*/\";\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {createCustomEvent} from '../../../src/event-helper';\n\n/** @const {!Object<string, string>} */\nexport const EventType = {\n  // Triggered when the user mutes the story\n  MUTE: 'ampstory:mute',\n\n  // Triggered when the user unmutes the story\n  UNMUTE: 'ampstory:unmute',\n\n  // Triggered when the story should switch to a specified page\n  SWITCH_PAGE: 'ampstory:switchpage',\n\n  // Triggered when the story should switch to the previous page\n  PREVIOUS_PAGE: 'ampstory:previouspage',\n\n  // Triggered when the story should switch to the next page\n  NEXT_PAGE: 'ampstory:nextpage',\n\n  // Triggered when a page updates its progress\n  PAGE_PROGRESS: 'ampstory:pageprogress',\n\n  // Triggered when the story should be replayed\n  REPLAY: 'ampstory:replay',\n\n  // DEVELOPMENT MODE ONLY: Triggered when a story page has log entries (e.g.\n  // warnings or errors).\n  DEV_LOG_ENTRIES_AVAILABLE: 'ampstory:devlogentriesavailable',\n\n  // Triggered when user clicks on end 75% of the last page\n  NO_NEXT_PAGE: 'ampstory:nonextpage',\n\n  // Triggered when user clicks on start 25% of the first page\n  NO_PREVIOUS_PAGE: 'ampstory:nopreviouspage',\n\n  // Triggered when a story has loaded at least its initial set of pages.\n  STORY_LOADED: 'ampstory:load',\n\n  // Triggered when a page has loaded at least one frame of all of its media.\n  PAGE_LOADED: 'ampstory:pageload',\n\n  // Dispatches an action to the amp-story store service. Only works under test.\n  DISPATCH_ACTION: 'ampstory:dispatchaction',\n};\n\n/**\n * @param {!Window} win\n * @param {!EventTarget} source\n * @param {string} eventName\n * @param {!JsonObject=} payload\n * @param {!CustomEventInit=} eventInit\n */\nexport function dispatch(\n  win,\n  source,\n  eventName,\n  payload = undefined,\n  eventInit = undefined\n) {\n  const event = createCustomEvent(win, eventName, payload, eventInit);\n  source.dispatchEvent(event);\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {parseJson} from './core/types/object/json';\n\n/**\n * A unique identifier for each localized string.  Localized string IDs should:\n *\n *   - Maintain alphabetical order, by component\n *   - Be prefixed with the name of the extension that uses the string\n *     (e.g. \"AMP_STORY_\"), or with \"AMP_\" if they are general\n *   - NOT be reused; to deprecate an ID, comment it out and prefix its key with\n *     the string \"DEPRECATED_\"\n *\n * Next ID: 98\n *\n * @const @enum {string}\n */\nexport const LocalizedStringId = {\n  // amp-story\n  AMP_STORY_ACTIVATE_BUTTON_TEXT: '83',\n  AMP_STORY_AUDIO_MUTE_BUTTON_LABEL: '66',\n  AMP_STORY_AUDIO_MUTE_BUTTON_TEXT: '31',\n  AMP_STORY_AUDIO_UNMUTE_BUTTON_LABEL: '67',\n  AMP_STORY_AUDIO_UNMUTE_NO_SOUND_TEXT: '33',\n  AMP_STORY_AUDIO_UNMUTE_SOUND_TEXT: '32',\n  AMP_STORY_CLOSE_BUTTON_LABEL: '87',\n  AMP_STORY_CONSENT_ACCEPT_BUTTON_LABEL: '22',\n  AMP_STORY_CONSENT_DECLINE_BUTTON_LABEL: '23',\n  AMP_STORY_CONTINUE_ANYWAY_BUTTON_LABEL: '27',\n  AMP_STORY_DISCOVERY_DIALOG_TEXT: '96',\n  AMP_STORY_DOMAIN_DIALOG_HEADING_LABEL: '25',\n  AMP_STORY_DOMAIN_DIALOG_HEADING_LINK: '26',\n  AMP_STORY_EDUCATION_NAVIGATION_SWIPE_PROGRESS: '78',\n  AMP_STORY_EDUCATION_NAVIGATION_SWIPE_INSTRUCTIONS: '79',\n  AMP_STORY_EDUCATION_NAVIGATION_SWIPE_DISMISS: '80',\n  AMP_STORY_EDUCATION_NAVIGATION_TAP_PROGRESS: '75',\n  AMP_STORY_EDUCATION_NAVIGATION_TAP_PROGRESS_SINGLE: '81',\n  AMP_STORY_EDUCATION_NAVIGATION_TAP_INSTRUCTIONS: '76',\n  AMP_STORY_EDUCATION_NAVIGATION_TAP_DISMISS: '77',\n  AMP_STORY_HAS_NEW_PAGE_TEXT: '64',\n  AMP_STORY_HINT_UI_NEXT_LABEL: '2',\n  AMP_STORY_HINT_UI_PREVIOUS_LABEL: '3',\n  AMP_STORY_INFO_BUTTON_LABEL: '68',\n  AMP_STORY_NEXT_PAGE: '91',\n  AMP_STORY_NEXT_STORY: '90',\n  AMP_STORY_OPEN_OUTLINK_TEXT: '97',\n  AMP_STORY_PAGE_ATTACHMENT_OPEN_LABEL: '35',\n  AMP_STORY_PAGINATION_BUTTON_PREVIOUS_PAGE_LABEL: '82',\n  AMP_STORY_PAGE_ERROR_VIDEO: '65',\n  AMP_STORY_PAGE_PLAY_VIDEO: '34',\n  AMP_STORY_PAUSE_BUTTON_LABEL: '85',\n  AMP_STORY_PLAY_BUTTON_LABEL: '86',\n  AMP_STORY_PREVIOUS_PAGE: '93',\n  AMP_STORY_REPLAY: '92',\n  AMP_STORY_SHARE_BUTTON_LABEL: '69',\n  AMP_STORY_SHARING_CLIPBOARD_FAILURE_TEXT: '4',\n  AMP_STORY_SHARING_CLIPBOARD_SUCCESS_TEXT: '5',\n  AMP_STORY_SHARING_PAGE_LABEL: '62',\n  AMP_STORY_SHARING_PROVIDER_NAME_EMAIL: '6',\n  AMP_STORY_SHARING_PROVIDER_NAME_FACEBOOK: '7',\n  AMP_STORY_SHARING_PROVIDER_NAME_GOOGLE_PLUS: '8',\n  AMP_STORY_SHARING_PROVIDER_NAME_LINE: '63',\n  AMP_STORY_SHARING_PROVIDER_NAME_LINK: '9',\n  AMP_STORY_SHARING_PROVIDER_NAME_LINKEDIN: '10',\n  AMP_STORY_SHARING_PROVIDER_NAME_PINTEREST: '11',\n  AMP_STORY_SHARING_PROVIDER_NAME_SMS: '12',\n  AMP_STORY_SHARING_PROVIDER_NAME_SYSTEM: '13',\n  AMP_STORY_SHARING_PROVIDER_NAME_TUMBLR: '14',\n  AMP_STORY_SHARING_PROVIDER_NAME_TWITTER: '15',\n  AMP_STORY_SHARING_PROVIDER_NAME_WHATSAPP: '16',\n  AMP_STORY_SIDEBAR_BUTTON_LABEL: '70',\n  AMP_STORY_SKIP_TO_NEXT_BUTTON_LABEL: '88',\n  AMP_STORY_TOOLTIP_EXPAND_TWEET: '36',\n  AMP_STORY_WARNING_DESKTOP_HEIGHT_SIZE_TEXT: '37',\n  AMP_STORY_WARNING_DESKTOP_SIZE_TEXT: '18',\n  AMP_STORY_WARNING_DESKTOP_WIDTH_SIZE_TEXT: '38',\n  AMP_STORY_WARNING_EXPERIMENT_DISABLED_TEXT: '19',\n  AMP_STORY_WARNING_LANDSCAPE_ORIENTATION_TEXT: '20',\n  AMP_STORY_WARNING_UNSUPPORTED_BROWSER_TEXT: '21',\n\n  // amp-story-auto-ads\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_APPLY_NOW: '39',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_BOOK_NOW: '40',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_BUY_TICKETS: '41',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_DOWNLOAD: '42',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_EXPLORE: '43',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_GET_NOW: '44',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_INSTALL: '45',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_LEARN_MORE: '46',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_LISTEN: '47',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_MORE: '48',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_OPEN_APP: '49',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_ORDER_NOW: '50',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_PLAY: '51',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_READ: '52',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_SHOP: '53',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_SHOW: '54',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_SHOWTIMES: '55',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_SIGN_UP: '56',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_SUBSCRIBE: '57',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_USE_APP: '58',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_VIEW: '59',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_WATCH: '60',\n  AMP_STORY_AUTO_ADS_BUTTON_LABEL_WATCH_EPISODE: '61',\n\n  // amp-story-interactive\n  AMP_STORY_INTERACTIVE_DISCLAIMER_NOTE: '89',\n  AMP_STORY_INTERACTIVE_RESULTS_SCORE: '84',\n  AMP_STORY_INTERACTIVE_QUIZ_ANSWER_CHOICE_A: '71',\n  AMP_STORY_INTERACTIVE_QUIZ_ANSWER_CHOICE_B: '72',\n  AMP_STORY_INTERACTIVE_QUIZ_ANSWER_CHOICE_C: '73',\n  AMP_STORY_INTERACTIVE_QUIZ_ANSWER_CHOICE_D: '74',\n\n  // DEPRECATED_AMP_STORY_EXPERIMENT_ENABLE_BUTTON_LABEL: '0',\n  // DEPRECATED_AMP_STORY_EXPERIMENT_ENABLED_TEXT: '1',\n  // DEPRECATED_AMP_STORY_CONSENT_DISMISS_DIALOG_BUTTON_LABEL: '24',\n  // DEPRECATED_AMP_STORY_SYSTEM_LAYER_SHARE_WIDGET_LABEL: '17',\n};\n\n/**\n * @typedef {{\n *   string: string,\n *   description: string,\n * }}\n */\nexport let LocalizedStringDef;\n\n/**\n * @typedef {!Object<!LocalizedStringId, !LocalizedStringDef>}\n */\nexport let LocalizedStringBundleDef;\n\n/**\n * Creates a deep copy of the specified LocalizedStringBundle.\n * @param {!LocalizedStringBundleDef} localizedStringBundle\n * @return {!LocalizedStringBundleDef}\n */\nfunction cloneLocalizedStringBundle(localizedStringBundle) {\n  return /** @type {!LocalizedStringBundleDef} */ (\n    parseJson(\n      JSON.stringify(/** @type {!JsonObject} */ (localizedStringBundle))\n    )\n  );\n}\n\n/**\n * Creates a pseudo locale by applying string transformations (specified by the\n * localizationFn) to an existing string bundle, without modifying the original.\n * @param {!LocalizedStringBundleDef} localizedStringBundle The localized\n *     string bundle to be transformed.\n * @param {function(string): string} localizationFn The transformation to be\n *     applied to each string in the bundle.\n * @return {!LocalizedStringBundleDef} The new strings.\n */\nexport function createPseudoLocale(localizedStringBundle, localizationFn) {\n  /** @type {!LocalizedStringBundleDef} */\n  const pseudoLocaleStringBundle = cloneLocalizedStringBundle(\n    localizedStringBundle\n  );\n\n  Object.keys(pseudoLocaleStringBundle).forEach((localizedStringIdAsStr) => {\n    const localizedStringId = /** @type {!LocalizedStringId} */ (\n      localizedStringIdAsStr\n    );\n    pseudoLocaleStringBundle[localizedStringId].string = localizationFn(\n      localizedStringBundle[localizedStringId].string\n    );\n    pseudoLocaleStringBundle[localizedStringId].fallback = localizationFn(\n      localizedStringBundle[localizedStringId].fallback\n    );\n  });\n\n  return pseudoLocaleStringBundle;\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n// The LocalizedStringId type is imported even though it is not used because the\n// compiler does not output types for enums, but we want to distinguish between\n// LocalizedStringId enum values and any other strings.\n// eslint-disable-next-line no-unused-vars\nimport {LocalizedStringId} from '../localized-strings';\nimport {Services} from '../services';\nimport {closest} from '../core/dom/query';\n\n/**\n * Language code used if there is no language code specified by the document.\n * @const {string}\n */\nconst FALLBACK_LANGUAGE_CODE = 'default';\n\n/**\n * @const {!RegExp}\n */\nconst LANGUAGE_CODE_CHUNK_REGEX = /\\w+/gi;\n\n/**\n * Gets the string matching the specified localized string ID in the language\n * specified.\n * @param {!Object<string, !../localized-strings.LocalizedStringBundleDef>} localizedStringBundles\n * @param {!Array<string>} languageCodes\n * @param {!LocalizedStringId} localizedStringId\n * @return {?string}\n */\nfunction findLocalizedString(\n  localizedStringBundles,\n  languageCodes,\n  localizedStringId\n) {\n  let localizedString = null;\n\n  languageCodes.some((languageCode) => {\n    const localizedStringBundle = localizedStringBundles[languageCode];\n    if (localizedStringBundle && localizedStringBundle[localizedStringId]) {\n      localizedString =\n        localizedStringBundle[localizedStringId].string ||\n        localizedStringBundle[localizedStringId].fallback;\n      return !!localizedString;\n    }\n\n    return false;\n  });\n\n  return localizedString;\n}\n\n/**\n * @param {string} languageCode\n * @return {!Array<string>} A list of language codes.\n * @visibleForTesting\n */\nexport function getLanguageCodesFromString(languageCode) {\n  if (!languageCode) {\n    return ['en', FALLBACK_LANGUAGE_CODE];\n  }\n  const matches = languageCode.match(LANGUAGE_CODE_CHUNK_REGEX) || [];\n  return matches.reduce(\n    (fallbackLanguageCodeList, chunk, index) => {\n      const fallbackLanguageCode = matches\n        .slice(0, index + 1)\n        .join('-')\n        .toLowerCase();\n      fallbackLanguageCodeList.unshift(fallbackLanguageCode);\n      return fallbackLanguageCodeList;\n    },\n    [FALLBACK_LANGUAGE_CODE]\n  );\n}\n\n/**\n * Localization service.\n */\nexport class LocalizationService {\n  /**\n   * @param {!Element} element\n   */\n  constructor(element) {\n    this.element_ = element;\n\n    /**\n     * @private @const {?string}\n     */\n    this.viewerLanguageCode_ = Services.viewerForDoc(element).getParam('lang');\n\n    /**\n     * A mapping of language code to localized string bundle.\n     * @private @const {!Object<string, !../localized-strings.LocalizedStringBundleDef>}\n     */\n    this.localizedStringBundles_ = {};\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {!Array<string>}\n   * @private\n   */\n  getLanguageCodesForElement_(element) {\n    const languageEl = closest(element, (el) => el.hasAttribute('lang'));\n    const languageCode = languageEl ? languageEl.getAttribute('lang') : null;\n    const languageCodesToUse = getLanguageCodesFromString(languageCode || '');\n\n    if (this.viewerLanguageCode_) {\n      languageCodesToUse.unshift(this.viewerLanguageCode_);\n    }\n\n    return languageCodesToUse;\n  }\n\n  /**\n   * @param {string} languageCode The language code to associate with the\n   *     specified localized string bundle.\n   * @param {!../localized-strings.LocalizedStringBundleDef} localizedStringBundle\n   *     The localized string bundle to register.\n   * @return {!LocalizationService} For chaining.\n   */\n  registerLocalizedStringBundle(languageCode, localizedStringBundle) {\n    const normalizedLangCode = languageCode.toLowerCase();\n    if (!this.localizedStringBundles_[normalizedLangCode]) {\n      this.localizedStringBundles_[normalizedLangCode] = {};\n    }\n\n    Object.assign(\n      this.localizedStringBundles_[normalizedLangCode],\n      localizedStringBundle\n    );\n    return this;\n  }\n\n  /**\n   * @param {!LocalizedStringId} localizedStringId\n   * @param {!Element=} elementToUse The element where the string will be\n   *     used.  The language is based on the language at that part of the\n   *     document.  If unspecified, will use the document-level language, if\n   *     one exists, or the default otherwise.\n   * @return {?string}\n   */\n  getLocalizedString(localizedStringId, elementToUse = this.element_) {\n    const languageCodes = this.getLanguageCodesForElement_(elementToUse);\n\n    return findLocalizedString(\n      this.localizedStringBundles_,\n      languageCodes,\n      localizedStringId\n    );\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {LocalizationService} from '../../../src/service/localization';\nimport {Services} from '../../../src/services';\nimport {registerServiceBuilderForDoc} from '../../../src/service';\n\n/**\n * Util function to retrieve the localization service. Ensures we can retrieve\n * the service synchronously from the amp-story codebase without running into\n * race conditions.\n * @param {!Element} element\n * @return {!../../../src/service/localization.LocalizationService}\n */\nexport const getLocalizationService = (element) => {\n  let localizationService = Services.localizationForDoc(element);\n\n  if (!localizationService) {\n    localizationService = new LocalizationService(element);\n    registerServiceBuilderForDoc(element, 'localization', function () {\n      return localizationService;\n    });\n  }\n\n  return localizationService;\n};\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Action,\n  EmbeddedComponentState,\n  InteractiveComponentDef,\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {\n  AdvancementMode,\n  StoryAnalyticsEvent,\n  getAnalyticsService,\n} from './story-analytics';\nimport {CSS} from '../../../build/amp-story-tooltip-1.0.css';\nimport {EventType, dispatch} from './events';\nimport {Keys} from '../../../src/core/constants/key-codes';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {Services} from '../../../src/services';\nimport {addAttributesToElement, tryFocus} from '../../../src/dom';\nimport {closest, matches} from '../../../src/core/dom/query';\nimport {\n  createShadowRootWithStyle,\n  getSourceOriginForElement,\n  triggerClickFromLightDom,\n} from './utils';\nimport {dev, devAssert, user, userAssert} from '../../../src/log';\nimport {dict} from '../../../src/core/types/object';\nimport {getAmpdoc} from '../../../src/service';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {htmlFor, htmlRefs} from '../../../src/static-template';\nimport {isProtocolValid, parseUrlDeprecated} from '../../../src/url';\n\nimport {px, resetStyles, setImportantStyles, toggle} from '../../../src/style';\n\n/**\n * Action icons to be placed in tooltip.\n * @enum {string}\n * @private\n */\nconst ActionIcon = {\n  LAUNCH: 'i-amphtml-tooltip-action-icon-launch',\n  EXPAND: 'i-amphtml-tooltip-action-icon-expand',\n};\n\n/** @private @const {number} */\nconst TOOLTIP_CLOSE_ANIMATION_MS = 100;\n\n/** @const {string} */\nconst DARK_THEME_CLASS = 'i-amphtml-story-tooltip-theme-dark';\n\n/**\n * @enum {string}\n */\nconst TooltipTheme = {\n  LIGHT: 'light', // default\n  DARK: 'dark',\n};\n\n/**\n * Since we don't know the actual width of the content inside the iframe\n * and in responsive environments the iframe takes the whole width, we\n * hardcode a limit based on what we know of how the embed behaves (only true\n * for Twitter embeds). See #22334.\n * @const {number}\n * @private\n */\nconst MAX_TWEET_WIDTH_PX = 500;\n\n/**\n * Components that can be expanded.\n * @const {!Object}\n * @package\n */\nexport const EXPANDABLE_COMPONENTS = {\n  'amp-twitter': {\n    customIconClassName: 'amp-social-share-twitter-no-background',\n    actionIcon: ActionIcon.EXPAND,\n    localizedStringId: LocalizedStringId.AMP_STORY_TOOLTIP_EXPAND_TWEET,\n    selector: 'amp-twitter',\n  },\n};\n\n/**\n * Components that can be launched.\n * @const {!Object}\n * @private\n */\nconst LAUNCHABLE_COMPONENTS = {\n  'a': {\n    actionIcon: ActionIcon.LAUNCH,\n    selector: 'a[href]:not([affiliate-link-icon])',\n  },\n};\n\n/**\n * Union of expandable and launchable components.\n * @private\n * @const {!Object}\n */\nconst INTERACTIVE_COMPONENTS = {\n  ...EXPANDABLE_COMPONENTS,\n  ...LAUNCHABLE_COMPONENTS,\n};\n\n/**\n * Gets the list of components with their respective selectors.\n * @param {!Object} components\n * @param {string=} opt_predicate\n * @return {!Object<string, string>}\n */\nfunction getComponentSelectors(components, opt_predicate) {\n  const componentSelectors = {};\n\n  Object.keys(components).forEach((componentName) => {\n    componentSelectors[componentName] = opt_predicate\n      ? components[componentName].selector + opt_predicate\n      : components[componentName].selector;\n  });\n\n  return componentSelectors;\n}\n\n/** @const {string} */\nconst INTERACTIVE_EMBED_SELECTOR = '[interactive]';\n\n/**\n * Selectors of elements that can go into expanded view.\n * @return {!Object}\n */\nexport function expandableElementsSelectors() {\n  // Using indirect invocation to prevent no-export-side-effect issue.\n  return getComponentSelectors(\n    EXPANDABLE_COMPONENTS,\n    INTERACTIVE_EMBED_SELECTOR\n  );\n}\n\n/**\n * Contains all interactive component CSS selectors.\n * @type {!Object}\n */\nconst interactiveSelectors = {\n  ...getComponentSelectors(LAUNCHABLE_COMPONENTS),\n  ...getComponentSelectors(EXPANDABLE_COMPONENTS, INTERACTIVE_EMBED_SELECTOR),\n  EXPANDED_VIEW_OVERLAY:\n    '.i-amphtml-story-expanded-view-overflow, ' +\n    '.i-amphtml-expanded-view-close-button',\n};\n\n/**\n * All selectors that should delegate to the AmpStoryEmbeddedComponent class.\n * @return {!Object}\n */\nexport function interactiveElementsSelectors() {\n  // Using indirect invocation to prevent no-export-side-effect issue.\n  return interactiveSelectors;\n}\n\n/**\n * Maps each embedded element to its corresponding style.\n * @type {!JsonObject}\n */\nconst embedStyleEls = dict();\n\n/**\n * Generates ids for embedded component styles.\n * @type {number}\n */\nlet embedIds = 0;\n\n/**\n * Contains metadata about embedded components, found in <style> elements.\n * @const {string}\n */\nconst AMP_EMBED_DATA = '__AMP_EMBED_DATA__';\n\n/**\n * @typedef {{\n *  id: number,\n *  width: number,\n *  height: number,\n *  scaleFactor: number,\n *  transform: string,\n *  verticalMargin: number,\n *  horizontalMargin: number,\n * }}\n */\nlet EmbedDataDef;\n\n/**\n * @const {string}\n */\nexport const EMBED_ID_ATTRIBUTE_NAME = 'i-amphtml-embed-id';\n\n/**\n * Builds expanded view overlay for expandable components.\n * @param {!Element} element\n * @return {!Element}\n */\nconst buildExpandedViewOverlay = (element) => htmlFor(element)`\n    <div class=\"i-amphtml-story-expanded-view-overflow i-amphtml-story-system-reset\">\n      <button class=\"i-amphtml-expanded-view-close-button\" aria-label=\"close\" role=\"button\"></button>\n    </div>`;\n\n/**\n * Updates embed's corresponding <style> element with embedData.\n * @param {!Element} target\n * @param {!Element} embedStyleEl\n * @param {!EmbedDataDef} embedData\n */\nfunction updateEmbedStyleEl(target, embedStyleEl, embedData) {\n  const embedId = embedData.id;\n  embedStyleEl.textContent = `[${EMBED_ID_ATTRIBUTE_NAME}=\"${embedId}\"]\n  ${buildStringStyleFromEl(target, embedData)}`;\n}\n\n/**\n * Builds a string containing the corresponding style depending on the\n * element.\n * @param {!Element} target\n * @param {!EmbedDataDef} embedData\n * @return {string}\n */\nfunction buildStringStyleFromEl(target, embedData) {\n  switch (target.tagName.toLowerCase()) {\n    case EXPANDABLE_COMPONENTS['amp-twitter'].selector:\n      return buildStringStyleForTweet(embedData);\n    default:\n      return buildDefaultStringStyle(embedData);\n  }\n}\n\n/**\n * Builds string used in the <style> element for tweets. We ignore the height\n * as its non-deterministic.\n * @param {!EmbedDataDef} embedData\n * @return {string}\n */\nfunction buildStringStyleForTweet(embedData) {\n  return `{\n    width: ${px(embedData.width)} !important;\n    transform: ${embedData.transform} !important;\n    margin: ${embedData.verticalMargin}px ${\n    embedData.horizontalMargin\n  }px !important;\n    }`;\n}\n\n/**\n * Builds string used in the <style> element for default embeds.\n * @param {!EmbedDataDef} embedData\n * @return {string}\n */\nfunction buildDefaultStringStyle(embedData) {\n  return `{\n    width: ${px(embedData.width)} !important;\n    height: ${px(embedData.height)} !important;\n    transform: ${embedData.transform} !important;\n    margin: ${embedData.verticalMargin}px ${\n    embedData.horizontalMargin\n  }px !important;\n    }`;\n}\n\n/**\n * Measures styles for a given element in preparation for its expanded animation.\n * @param {!Element} element\n * @param {!Object} state\n * @param {!DOMRect} pageRect\n * @param {!DOMRect} elRect\n * @return {!Object}\n */\nfunction measureStyleForEl(element, state, pageRect, elRect) {\n  switch (element.tagName.toLowerCase()) {\n    case EXPANDABLE_COMPONENTS['amp-twitter'].selector:\n      return measureStylesForTwitter(state, pageRect, elRect);\n    default:\n      return measureDefaultStyles(state, pageRect, elRect);\n  }\n}\n\n/**\n * Since amp-twitter handles its own resize events for its height, we don't\n * resize based on its height, but rather just based on its width.\n * @param {!Object} state\n * @param {!DOMRect} pageRect\n * @param {!DOMRect} elRect\n * @return {!Object}\n */\nfunction measureStylesForTwitter(state, pageRect, elRect) {\n  // If screen is very wide and story has supports-landscape attribute,\n  // we don't want it to take the whole width. We take the maximum width\n  // that the tweet can actually use instead.\n  state.newWidth = Math.min(pageRect.width, MAX_TWEET_WIDTH_PX);\n\n  state.scaleFactor =\n    Math.min(elRect.width, MAX_TWEET_WIDTH_PX) / state.newWidth;\n\n  const shrinkedSize = elRect.height * state.scaleFactor;\n\n  state.verticalMargin = -1 * ((elRect.height - shrinkedSize) / 2);\n  state.horizontalMargin = -1 * ((state.newWidth - elRect.width) / 2);\n\n  return state;\n}\n\n/**\n * Measures styles for a given element in preparation for its expanded\n * animation.\n * @param {!Object} state\n * @param {!DOMRect} pageRect\n * @param {!DOMRect} elRect\n * @return {!Object}\n */\nfunction measureDefaultStyles(state, pageRect, elRect) {\n  if (elRect.width >= elRect.height) {\n    state.newWidth = pageRect.width;\n    state.scaleFactor = elRect.width / state.newWidth;\n    state.newHeight = (elRect.height / elRect.width) * state.newWidth;\n  } else {\n    const maxHeight = pageRect.height - VERTICAL_PADDING;\n    state.newWidth = Math.min(\n      (elRect.width / elRect.height) * maxHeight,\n      pageRect.width\n    );\n    state.newHeight = (elRect.height / elRect.width) * state.newWidth;\n    state.scaleFactor = elRect.height / state.newHeight;\n  }\n\n  state.verticalMargin = -1 * ((state.newHeight - elRect.height) / 2);\n  state.horizontalMargin = -1 * ((state.newWidth - elRect.width) / 2);\n\n  return state;\n}\n\n/**\n * Gets updated style object for a given element.\n * @param {!Element} element\n * @param {number} elId\n * @param {!Object} state\n * @return {!Object}\n */\nfunction updateStyleForEl(element, elId, state) {\n  switch (element.tagName.toLowerCase()) {\n    case EXPANDABLE_COMPONENTS['amp-twitter'].selector:\n      return updateStylesForTwitter(elId, state);\n    default:\n      return updateDefaultStyles(elId, state);\n  }\n}\n\n/**\n * Gets style object for an embedded component, setting negative margins\n * to make up for the expanded size in preparation of the expanded animation.\n * @param {number} elId\n * @param {!Object} state\n * @return {!Object}\n */\nfunction updateDefaultStyles(elId, state) {\n  return {\n    id: elId,\n    width: state.newWidth,\n    height: state.newHeight,\n    scaleFactor: state.scaleFactor,\n    transform: `scale(${state.scaleFactor})`,\n    verticalMargin: state.verticalMargin,\n    horizontalMargin: state.horizontalMargin,\n  };\n}\n\n/**\n * Gets style object for twitter. Notice there is no height or vertical margin\n * since we don't know the final height of tweets even after layout, so we just\n * let the embed handle its own height.\n * @param {number} elId\n * @param {!Object} state\n * @return {!Object}\n */\nfunction updateStylesForTwitter(elId, state) {\n  return {\n    id: elId,\n    width: state.newWidth,\n    scaleFactor: state.scaleFactor,\n    transform: `scale(${state.scaleFactor})`,\n    horizontalMargin: state.horizontalMargin,\n    verticalMargin: state.verticalMargin,\n  };\n}\n\n/**\n * Minimum vertical space needed to position tooltip.\n * @const {number}\n */\nconst MIN_VERTICAL_SPACE = 48;\n\n/**\n * Limits the amount of vertical space a component can take in a page, this\n * makes sure no component is blocking the close button at the top of the\n * expanded view.\n * @const {number}\n * @private\n */\nconst VERTICAL_PADDING = 96;\n\n/**\n * Padding between tooltip and vertical edges of screen.\n * @const {number}\n */\nconst VERTICAL_EDGE_PADDING = 24;\n\n/**\n * Padding between tooltip and horizontal edges of screen.\n * @const {number}\n */\nconst HORIZONTAL_EDGE_PADDING = 32;\n\n/**\n * Padding between tooltip arrow and right edge of the tooltip.\n * @const {number}\n */\nconst TOOLTIP_ARROW_RIGHT_PADDING = 24;\n\n/**\n * @struct @typedef {{\n *   tooltip: !Element,\n *   buttonLeft: !Element,\n *   buttonRight: !Element,\n *   arrow: !Element,\n * }}\n */\nlet tooltipElementsDef;\n\nconst TAG = 'amp-story-embedded-component';\n\n/**\n * Embedded components found in amp-story.\n */\nexport class AmpStoryEmbeddedComponent {\n  /**\n   * @param {!Window} win\n   * @param {!Element} storyEl\n   */\n  constructor(win, storyEl) {\n    /** @private {!Window} */\n    this.win_ = win;\n\n    /** @private {!Element} */\n    this.storyEl_ = storyEl;\n\n    /** @private {?Element} */\n    this.shadowRoot_ = null;\n\n    /** @private {?Element} */\n    this.focusedStateOverlay_ = null;\n\n    /** @private {?Element} */\n    this.tooltip_ = null;\n\n    /** @private {?Element} */\n    this.tooltipArrow_ = null;\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win_);\n\n    /** @private @const {!../../../src/service/mutator-interface.MutatorInterface} */\n    this.mutator_ = Services.mutatorForDoc(getAmpdoc(this.win_.document));\n\n    /** @private @const {!./story-analytics.StoryAnalyticsService} */\n    this.analyticsService_ = getAnalyticsService(this.win_, storyEl);\n\n    /** @private @const {!../../../src/service/owners-interface.OwnersInterface} */\n    this.owners_ = Services.ownersForDoc(getAmpdoc(this.win_.document));\n\n    /** @private @const {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(this.win_);\n\n    /** @private {?Element} */\n    this.expandedViewOverlay_ = null;\n\n    /**\n     * Target producing the tooltip and going to expanded view (when\n     * expandable).\n     * @private {?Element}\n     */\n    this.triggeringTarget_ = null;\n\n    /**\n     * Page containing component.\n     * @private {?Element}\n     */\n    this.componentPage_ = null;\n\n    /** @private */\n    this.expandComponentHandler_ = this.onExpandComponent_.bind(this);\n\n    /** @private */\n    this.embedsToBePaused_ = [];\n\n    this.storeService_.subscribe(\n      StateProperty.INTERACTIVE_COMPONENT_STATE,\n      /** @param {!InteractiveComponentDef} component */ (component) => {\n        this.onComponentStateUpdate_(component);\n      }\n    );\n\n    /** @type {!../../../src/service/history-impl.History} */\n    this.historyService_ = Services.historyForDoc(\n      getAmpdoc(this.win_.document)\n    );\n\n    /** @private {EmbeddedComponentState} */\n    this.state_ = EmbeddedComponentState.HIDDEN;\n\n    /** @private {?Element} */\n    this.buttonLeft_ = null;\n\n    /** @private {?Element} */\n    this.buttonRight_ = null;\n\n    /** @private {number} */\n    this.historyId_ = -1;\n  }\n\n  /**\n   * Reacts to embedded component state updates.\n   * Possible state updates:\n   *\n   *    HIDDEN ==> FOCUSED ==> EXPANDED\n   *      /\\ _________|           |\n   *      ||______________________|\n   *\n   * @param {!InteractiveComponentDef} component\n   * @private\n   */\n  onComponentStateUpdate_(component) {\n    switch (component.state) {\n      case EmbeddedComponentState.HIDDEN:\n        this.setState_(EmbeddedComponentState.HIDDEN, null /** component */);\n        break;\n      case EmbeddedComponentState.FOCUSED:\n        if (this.state_ !== EmbeddedComponentState.HIDDEN) {\n          dev().warn(\n            TAG,\n            `Invalid component update. Not possible to go from ${this.state_}\n              to ${component.state}`\n          );\n        }\n        this.setState_(EmbeddedComponentState.FOCUSED, component);\n        break;\n      case EmbeddedComponentState.EXPANDED:\n        if (this.state_ === EmbeddedComponentState.FOCUSED) {\n          this.setState_(EmbeddedComponentState.EXPANDED, component);\n        } else if (this.state_ === EmbeddedComponentState.EXPANDED) {\n          this.maybeCloseExpandedView_(component.element);\n        } else {\n          dev().warn(\n            TAG,\n            `Invalid component update. Not possible to go from ${this.state_}\n               to ${component.state}`\n          );\n        }\n        break;\n    }\n  }\n\n  /**\n   * Sets new state for the embedded component.\n   * @param {EmbeddedComponentState} state\n   * @param {?InteractiveComponentDef} component\n   * @private\n   */\n  setState_(state, component) {\n    switch (state) {\n      case EmbeddedComponentState.FOCUSED:\n        this.state_ = state;\n        this.onFocusedStateUpdate_(component);\n        this.analyticsService_.triggerEvent(\n          StoryAnalyticsEvent.FOCUS,\n          this.triggeringTarget_\n        );\n        break;\n      case EmbeddedComponentState.HIDDEN:\n        this.state_ = state;\n        this.onFocusedStateUpdate_(null);\n        break;\n      case EmbeddedComponentState.EXPANDED:\n        this.state_ = state;\n        this.onFocusedStateUpdate_(null);\n        this.scheduleEmbedToPause_(component.element);\n        this.toggleExpandedView_(component.element);\n        this.historyService_\n          .push(() => this.close_())\n          .then((historyId) => {\n            this.historyId_ = historyId;\n          });\n        break;\n      default:\n        dev().warn(TAG, `EmbeddedComponentState ${this.state_} does not exist`);\n        break;\n    }\n  }\n\n  /**\n   * Schedules embeds to be paused.\n   * @param {!Element} embedEl\n   * @private\n   */\n  scheduleEmbedToPause_(embedEl) {\n    // Resources that previously called `schedulePause` must also call\n    // `scheduleResume`. Calling `scheduleResume` on resources that did not\n    // previously call `schedulePause` has no effect.\n    this.owners_.scheduleResume(this.storyEl_, embedEl);\n    if (!this.embedsToBePaused_.includes(embedEl)) {\n      this.embedsToBePaused_.push(embedEl);\n    }\n  }\n\n  /**\n   * Toggles expanded view for interactive components that support it.\n   * @param {?Element} targetToExpand\n   * @private\n   */\n  toggleExpandedView_(targetToExpand) {\n    if (!targetToExpand) {\n      this.expandedViewOverlay_ &&\n        this.mutator_.mutateElement(this.expandedViewOverlay_, () => {\n          this.componentPage_.classList.toggle(\n            'i-amphtml-expanded-mode',\n            false\n          );\n          toggle(dev().assertElement(this.expandedViewOverlay_), false);\n          this.closeExpandedEl_();\n        });\n      return;\n    }\n\n    this.animateExpanded_(devAssert(targetToExpand));\n\n    this.expandedViewOverlay_ = this.componentPage_.querySelector(\n      '.i-amphtml-story-expanded-view-overflow'\n    );\n    if (!this.expandedViewOverlay_) {\n      this.buildAndAppendExpandedViewOverlay_();\n    }\n    this.mutator_.mutateElement(\n      dev().assertElement(this.expandedViewOverlay_),\n      () => {\n        toggle(dev().assertElement(this.expandedViewOverlay_), true);\n        this.componentPage_.classList.toggle('i-amphtml-expanded-mode', true);\n      }\n    );\n  }\n\n  /**\n   * Builds the expanded view overlay element and appends it to the page.\n   * @private\n   */\n  buildAndAppendExpandedViewOverlay_() {\n    this.expandedViewOverlay_ = buildExpandedViewOverlay(this.storyEl_);\n    const closeButton = dev().assertElement(\n      this.expandedViewOverlay_.querySelector(\n        '.i-amphtml-expanded-view-close-button'\n      )\n    );\n    const localizationService = getLocalizationService(\n      devAssert(this.storyEl_)\n    );\n    if (localizationService) {\n      const localizedCloseString = localizationService.getLocalizedString(\n        LocalizedStringId.AMP_STORY_CLOSE_BUTTON_LABEL\n      );\n      closeButton.setAttribute('aria-label', localizedCloseString);\n    }\n    this.mutator_.mutateElement(dev().assertElement(this.componentPage_), () =>\n      this.componentPage_.appendChild(this.expandedViewOverlay_)\n    );\n  }\n\n  /**\n   * Closes the expanded view overlay.\n   * @param {?Element} target\n   * @param {boolean=} forceClose Force closing the expanded view.\n   * @private\n   */\n  maybeCloseExpandedView_(target, forceClose = false) {\n    if (\n      (target && matches(target, '.i-amphtml-expanded-view-close-button')) ||\n      forceClose\n    ) {\n      if (this.historyId_ !== -1) {\n        this.historyService_.goBack();\n      } else {\n        // Used for visual diff testing viewer.\n        this.close_();\n      }\n    }\n  }\n\n  /**\n   * Builds the tooltip overlay and appends it to the provided story.\n   * @private\n   * @return {Node}\n   */\n  buildFocusedState_() {\n    this.shadowRoot_ = this.win_.document.createElement('div');\n\n    this.focusedStateOverlay_ = devAssert(\n      this.buildFocusedStateTemplate_(this.win_.document)\n    );\n    createShadowRootWithStyle(this.shadowRoot_, this.focusedStateOverlay_, CSS);\n\n    this.focusedStateOverlay_.addEventListener('click', (event) =>\n      this.onOutsideTooltipClick_(event)\n    );\n\n    this.tooltip_.addEventListener(\n      'click',\n      (event) => {\n        event.stopPropagation();\n        this.analyticsService_.triggerEvent(\n          StoryAnalyticsEvent.CLICK_THROUGH,\n          this.triggeringTarget_\n        );\n        this.tooltip_.href && this.onAnchorClick_(event);\n      },\n      true /** capture */\n    );\n\n    return this.shadowRoot_;\n  }\n\n  /**\n   * Clears tooltip UI and updates store state to hidden.\n   * @private\n   */\n  close_() {\n    // Wait until tooltip closing animation is finished before clearing it.\n    // Otherwise jank is noticeable.\n    this.timer_.delay(() => {\n      this.clearTooltip_();\n    }, TOOLTIP_CLOSE_ANIMATION_MS);\n\n    if (this.state_ === EmbeddedComponentState.EXPANDED) {\n      this.toggleExpandedView_(null);\n    }\n    this.storeService_.dispatch(Action.TOGGLE_INTERACTIVE_COMPONENT, {\n      state: EmbeddedComponentState.HIDDEN,\n    });\n    this.tooltip_.removeEventListener(\n      'click',\n      this.expandComponentHandler_,\n      true /** capture */\n    );\n  }\n\n  /**\n   * Reacts to store updates related to the focused state, when a tooltip is\n   * active.\n   * @param {?InteractiveComponentDef} component\n   * @private\n   */\n  onFocusedStateUpdate_(component) {\n    if (!component) {\n      this.mutator_.mutateElement(\n        dev().assertElement(this.focusedStateOverlay_),\n        () => {\n          this.focusedStateOverlay_.classList.toggle('i-amphtml-hidden', true);\n        }\n      );\n      return;\n    }\n\n    this.triggeringTarget_ = component.element;\n\n    // First time attaching the overlay. Runs only once.\n    if (!this.focusedStateOverlay_) {\n      this.storyEl_.appendChild(this.buildFocusedState_());\n      this.initializeListeners_();\n    }\n\n    // Delay building the tooltip to make sure it runs after clearTooltip_,\n    // in the case the user taps on a target in quick succession.\n    this.timer_.delay(() => {\n      this.buildTooltip_(component);\n    }, TOOLTIP_CLOSE_ANIMATION_MS);\n  }\n\n  /**\n   * Builds and displays tooltip\n   * @param {?InteractiveComponentDef} component\n   * @private\n   */\n  buildTooltip_(component) {\n    this.updateTooltipBehavior_(component.element);\n    this.updateTooltipEl_(component);\n    this.componentPage_ = devAssert(\n      this.storyEl_.querySelector('amp-story-page[active]')\n    );\n\n    this.mutator_.mutateElement(\n      dev().assertElement(this.focusedStateOverlay_),\n      () => {\n        this.focusedStateOverlay_.classList.toggle('i-amphtml-hidden', false);\n        tryFocus(\n          dev().assertElement(\n            this.focusedStateOverlay_.querySelector('a.i-amphtml-story-tooltip')\n          )\n        );\n      }\n    );\n  }\n\n  /**\n   * Attaches listeners that listen for UI updates.\n   * @private\n   */\n  initializeListeners_() {\n    this.storeService_.subscribe(\n      StateProperty.UI_STATE,\n      (uiState) => {\n        this.onUIStateUpdate_(uiState);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(StateProperty.CURRENT_PAGE_ID, () => {\n      // Hide active tooltip when page switch is triggered by keyboard or\n      // desktop buttons.\n      if (this.state_ === EmbeddedComponentState.FOCUSED) {\n        this.close_();\n      }\n\n      // Hide expanded view when page switch is triggered by keyboard or desktop\n      // buttons.\n      if (this.state_ === EmbeddedComponentState.EXPANDED) {\n        this.maybeCloseExpandedView_(\n          null /** target */,\n          true /** forceClose */\n        );\n      }\n\n      // Pauses content inside embeds when a page change occurs.\n      while (this.embedsToBePaused_.length > 0) {\n        const embedEl = this.embedsToBePaused_.pop();\n        this.owners_.schedulePause(this.storyEl_, embedEl);\n      }\n    });\n\n    this.win_.addEventListener('keyup', (event) => {\n      if (\n        event.key === Keys.ESCAPE &&\n        this.state_ === EmbeddedComponentState.EXPANDED\n      ) {\n        event.preventDefault();\n        this.maybeCloseExpandedView_(\n          null /** target */,\n          true /** forceClose */\n        );\n      }\n    });\n  }\n\n  /**\n   * Reacts to desktop state updates and hides navigation buttons since we\n   * already have in the desktop UI.\n   * @param {!UIType} uiState\n   * @private\n   */\n  onUIStateUpdate_(uiState) {\n    this.mutator_.mutateElement(\n      dev().assertElement(this.focusedStateOverlay_),\n      () => {\n        [UIType.DESKTOP_FULLBLEED, UIType.DESKTOP_PANELS].includes(uiState)\n          ? this.focusedStateOverlay_.setAttribute('desktop', '')\n          : this.focusedStateOverlay_.removeAttribute('desktop');\n      }\n    );\n  }\n\n  /**\n   * Builds and attaches the tooltip.\n   * @param {!InteractiveComponentDef} component\n   * @private\n   */\n  updateTooltipEl_(component) {\n    const embedConfig = /** @type {!Object} */ (\n      userAssert(\n        this.getEmbedConfigFor_(component.element),\n        'Invalid embed config for target',\n        component.element\n      )\n    );\n\n    const theme = this.triggeringTarget_.getAttribute('theme');\n    if (theme && TooltipTheme.DARK === theme.toLowerCase()) {\n      this.tooltip_.classList.add(DARK_THEME_CLASS);\n    }\n\n    this.updateTooltipText_(component.element, embedConfig);\n    this.updateTooltipComponentIcon_(component.element, embedConfig);\n    this.updateTooltipActionIcon_(embedConfig);\n    this.updateNavButtons_();\n    this.positionTooltip_(component);\n  }\n\n  /**\n   * Updates tooltip behavior depending on the target.\n   * @param {!Element} target\n   * @private\n   */\n  updateTooltipBehavior_(target) {\n    if (matches(target, LAUNCHABLE_COMPONENTS['a'].selector)) {\n      addAttributesToElement(\n        dev().assertElement(this.tooltip_),\n        dict({'href': this.getElementHref_(target)})\n      );\n      return;\n    }\n\n    if (EXPANDABLE_COMPONENTS[target.tagName.toLowerCase()]) {\n      this.tooltip_.addEventListener(\n        'click',\n        this.expandComponentHandler_,\n        true\n      );\n    }\n  }\n\n  /**\n   * Handles the event of an interactive element coming into expanded view.\n   * @param {!Event} event\n   * @private\n   */\n  onExpandComponent_(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    this.storeService_.dispatch(Action.TOGGLE_INTERACTIVE_COMPONENT, {\n      state: EmbeddedComponentState.EXPANDED,\n      element: this.triggeringTarget_,\n    });\n  }\n\n  /**\n   * Gets href from an element containing a url.\n   * @param {!Element} target\n   * @return {string}\n   * @private\n   */\n  getElementHref_(target) {\n    const elUrl = target.getAttribute('href');\n    if (!isProtocolValid(elUrl)) {\n      user().error(TAG, 'The tooltip url is invalid');\n      return '';\n    }\n\n    return parseUrlDeprecated(elUrl).href;\n  }\n\n  /**\n   * Gets corresponding config for a given embed target.\n   * @param {!Element} target\n   * @return {?Object}\n   */\n  getEmbedConfigFor_(target) {\n    const config = INTERACTIVE_COMPONENTS[target.tagName.toLowerCase()];\n    if (config && matches(target, config.selector)) {\n      return config;\n    }\n\n    user().error(TAG, 'No config matching provided target.');\n    return null;\n  }\n\n  /**\n   * Returns expanded element back to original state.\n   * @private\n   */\n  closeExpandedEl_() {\n    this.triggeringTarget_.classList.toggle(\n      'i-amphtml-expanded-component',\n      false\n    );\n    const embedId = this.triggeringTarget_.getAttribute(\n      EMBED_ID_ATTRIBUTE_NAME\n    );\n\n    const embedStyleEl = dev().assertElement(\n      embedStyleEls[embedId],\n      `Failed to look up embed style element with ID ${embedId}`\n    );\n\n    embedStyleEl[\n      AMP_EMBED_DATA\n    ].transform = `scale(${embedStyleEl[AMP_EMBED_DATA].scaleFactor})`;\n    updateEmbedStyleEl(\n      this.triggeringTarget_,\n      embedStyleEl,\n      embedStyleEl[AMP_EMBED_DATA]\n    );\n  }\n\n  /**\n   * Animates into expanded view. It calculates what the full-screen dimensions\n   * of the element will be, and uses them to deduce the translateX/Y values\n   * once the element reaches its full-screen size.\n   * @param {!Element} target\n   * @private\n   */\n  animateExpanded_(target) {\n    const embedId = target.getAttribute(EMBED_ID_ATTRIBUTE_NAME);\n    const state = {};\n    const embedStyleEl = dev().assertElement(\n      embedStyleEls[embedId],\n      `Failed to look up embed style element with ID ${embedId}`\n    );\n    const embedData = embedStyleEl[AMP_EMBED_DATA];\n    this.mutator_.measureMutateElement(\n      target,\n      /** measure */\n      () => {\n        const targetRect = target./*OK*/ getBoundingClientRect();\n        // TODO(#20832): Store DOMRect for the page in the store to avoid\n        // having to call getBoundingClientRect().\n        const pageRect = this.componentPage_./*OK*/ getBoundingClientRect();\n        const realHeight = target./*OK*/ offsetHeight;\n        const maxHeight = pageRect.height - VERTICAL_PADDING;\n        state.scaleFactor = 1;\n        if (realHeight > maxHeight) {\n          state.scaleFactor = maxHeight / realHeight;\n        }\n\n        // Gap on the left of the element between full-screen size and\n        // current size.\n        const leftGap = (embedData.width - targetRect.width) / 2;\n        // Distance from left of page to what will be the left of the\n        // element in full-screen.\n        const fullScreenLeft = targetRect.left - leftGap - pageRect.left;\n        const centeredLeft = pageRect.width / 2 - embedData.width / 2;\n        state.translateX = centeredLeft - fullScreenLeft;\n\n        // Gap on the top of the element between full-screen size and\n        // current size.\n        const topGap = (realHeight * state.scaleFactor - targetRect.height) / 2;\n        // Distance from top of page to what will be the top of the element in\n        // full-screen.\n        const fullScreenTop = targetRect.top - topGap - pageRect.top;\n        const centeredTop =\n          pageRect.height / 2 - (realHeight * state.scaleFactor) / 2;\n        state.translateY = centeredTop - fullScreenTop;\n      },\n      /** mutate */\n      () => {\n        target.classList.toggle('i-amphtml-expanded-component', true);\n\n        embedData.transform = `translate3d(${state.translateX}px,\n            ${state.translateY}px, 0) scale(${state.scaleFactor})`;\n\n        updateEmbedStyleEl(target, embedStyleEl, embedData);\n      }\n    );\n  }\n\n  /**\n   * Resizes expandable element before it is expanded to full-screen, in\n   * preparation for its animation. It resizes it to its full-screen size, and\n   * scales it down to match size set by publisher, adding negative margins so\n   * that content around stays put.\n   * @param {!Element} pageEl\n   * @param {!Element} element\n   * @param {!../../../src/service/mutator-interface.MutatorInterface} mutator\n   */\n  static prepareForAnimation(pageEl, element, mutator) {\n    let elId = null;\n\n    // When a window resize happens, we must reset the styles and prepare the\n    // animation again.\n    if (element.hasAttribute(EMBED_ID_ATTRIBUTE_NAME)) {\n      elId = parseInt(element.getAttribute(EMBED_ID_ATTRIBUTE_NAME), 10);\n      const embedStyleEl = dev().assertElement(\n        embedStyleEls[elId],\n        `Failed to look up embed style element with ID ${elId}`\n      );\n      embedStyleEl.textContent = '';\n      embedStyleEl[AMP_EMBED_DATA] = {};\n    }\n\n    let state = {};\n    mutator.measureMutateElement(\n      element,\n      /** measure */\n      () => {\n        const pageRect = pageEl./*OK*/ getBoundingClientRect();\n        const elRect = element./*OK*/ getBoundingClientRect();\n        state = measureStyleForEl(element, state, pageRect, elRect);\n      },\n      /** mutate */\n      () => {\n        elId = elId ? elId : ++embedIds;\n        if (!element.hasAttribute(EMBED_ID_ATTRIBUTE_NAME)) {\n          // First time creating <style> element for embed.\n          const html = htmlFor(pageEl);\n          const embedStyleEl = html` <style></style> `;\n\n          element.setAttribute(EMBED_ID_ATTRIBUTE_NAME, elId);\n          pageEl.insertBefore(embedStyleEl, pageEl.firstChild);\n          embedStyleEls[elId] = embedStyleEl;\n        }\n\n        embedStyleEls[elId][AMP_EMBED_DATA] = {\n          ...updateStyleForEl(element, elId, state),\n        };\n\n        const embedStyleEl = dev().assertElement(\n          embedStyleEls[elId],\n          `Failed to look up embed style element with ID ${elId}`\n        );\n        updateEmbedStyleEl(element, embedStyleEl, embedStyleEl[AMP_EMBED_DATA]);\n      }\n    );\n  }\n\n  /**\n   * Updates tooltip text content.\n   * @param {!Element} target\n   * @param {!Object} embedConfig\n   * @private\n   */\n  updateTooltipText_(target, embedConfig) {\n    const tooltipText =\n      target.getAttribute('data-tooltip-text') ||\n      getLocalizationService(this.storyEl_).getLocalizedString(\n        embedConfig.localizedStringId\n      ) ||\n      getSourceOriginForElement(target, this.getElementHref_(target));\n    const existingTooltipText = this.tooltip_.querySelector(\n      '.i-amphtml-tooltip-text'\n    );\n\n    existingTooltipText.textContent = tooltipText;\n  }\n\n  /**\n   * Updates tooltip action icon. This is found on the right of the text.\n   * @param {!Object} embedConfig\n   * @private\n   */\n  updateTooltipActionIcon_(embedConfig) {\n    const actionIcon = this.tooltip_.querySelector(\n      '.i-amphtml-tooltip-action-icon'\n    );\n\n    this.mutator_.mutateElement(dev().assertElement(actionIcon), () => {\n      actionIcon.classList.toggle(embedConfig.actionIcon, true);\n    });\n  }\n\n  /**\n   * Updates tooltip icon. If no icon src is declared, it sets a default for a\n   * given component type.\n   * @param {!Element} target\n   * @param {!Object} embedConfig\n   * @private\n   */\n  updateTooltipComponentIcon_(target, embedConfig) {\n    const iconUrl = target.getAttribute('data-tooltip-icon');\n    if (!isProtocolValid(iconUrl)) {\n      user().error(TAG, 'The tooltip icon url is invalid');\n      return;\n    }\n\n    const tooltipCustomIcon = this.tooltip_.querySelector(\n      '.i-amphtml-story-tooltip-custom-icon'\n    );\n\n    // No icon src specified by publisher and no default icon in config.\n    if (!iconUrl && !embedConfig.customIconClassName) {\n      tooltipCustomIcon.classList.toggle('i-amphtml-hidden', true);\n      return;\n    }\n\n    // Publisher specified a valid icon url.\n    if (iconUrl) {\n      this.mutator_.mutateElement(\n        dev().assertElement(tooltipCustomIcon),\n        () => {\n          setImportantStyles(dev().assertElement(tooltipCustomIcon), {\n            'background-image': `url(${parseUrlDeprecated(iconUrl).href})`,\n          });\n        }\n      );\n      return;\n    }\n\n    // No icon src specified by publisher. Use default icon found in the config.\n    this.mutator_.mutateElement(dev().assertElement(tooltipCustomIcon), () => {\n      tooltipCustomIcon.classList.add(embedConfig.customIconClassName);\n    });\n  }\n\n  /**\n   * Show or hide arrows based on current page.\n   * @private\n   */\n  updateNavButtons_() {\n    if (!this.isLastPage_()) {\n      this.buttonLeft_.removeAttribute('hidden');\n      this.buttonRight_.removeAttribute('hidden');\n    } else {\n      this.storeService_.get(StateProperty.RTL_STATE)\n        ? this.buttonLeft_.setAttribute('hidden', true)\n        : this.buttonRight_.setAttribute('hidden', true);\n    }\n  }\n\n  /**\n   * Is last page.\n   * @return {boolean}\n   * @private\n   */\n  isLastPage_() {\n    const pageIndex = this.storeService_.get(StateProperty.CURRENT_PAGE_INDEX);\n    const pageCount = this.storeService_.get(StateProperty.PAGE_IDS).length;\n    return pageIndex + 1 === pageCount;\n  }\n\n  /**\n   * Positions tooltip and its pointing arrow according to the position of the\n   * target.\n   * @param {!InteractiveComponentDef} component\n   * @private\n   */\n  positionTooltip_(component) {\n    const state = {arrowOnTop: false};\n\n    this.mutator_.measureMutateElement(\n      this.storyEl_,\n      /** measure */\n      () => {\n        const pageRect = this.componentPage_./*OK*/ getBoundingClientRect();\n\n        this.horizontalPositioning_(component, pageRect, state);\n        this.verticalPositioning_(component, pageRect, state);\n      },\n      /** mutate */\n      () => {\n        // Arrow on top or bottom of tooltip.\n        this.tooltip_.classList.toggle(\n          'i-amphtml-tooltip-arrow-on-top',\n          state.arrowOnTop\n        );\n\n        setImportantStyles(dev().assertElement(this.tooltipArrow_), {\n          left: `${state.arrowLeftOffset}px`,\n        });\n        setImportantStyles(devAssert(this.tooltip_), {\n          top: `${state.tooltipTop}px`,\n          left: `${state.tooltipLeft}px`,\n        });\n      }\n    );\n  }\n\n  /**\n   * Positions tooltip and its arrow vertically.\n   * @param {!InteractiveComponentDef} component\n   * @param {!ClientRect} pageRect\n   * @param {!Object} state\n   * @private\n   */\n  verticalPositioning_(component, pageRect, state) {\n    const tooltipHeight = this.tooltip_./*OK*/ offsetHeight;\n    const verticalOffset = VERTICAL_EDGE_PADDING;\n\n    state.tooltipTop = component.clientY - tooltipHeight - verticalOffset;\n    if (state.tooltipTop < pageRect.top + MIN_VERTICAL_SPACE) {\n      // Target is too high up screen, place tooltip facing down with\n      // arrow on top.\n      state.arrowOnTop = true;\n      state.tooltipTop = component.clientY + verticalOffset;\n    }\n  }\n\n  /**\n   * Positions tooltip and its arrow horizontally.\n   * @param {!InteractiveComponentDef} component\n   * @param {!ClientRect} pageRect\n   * @param {!Object} state\n   * @private\n   */\n  horizontalPositioning_(component, pageRect, state) {\n    const tooltipWidth = this.tooltip_./*OK*/ offsetWidth;\n    state.tooltipLeft = component.clientX - tooltipWidth / 2;\n    const maxLeft =\n      pageRect.left + pageRect.width - HORIZONTAL_EDGE_PADDING - tooltipWidth;\n    const minLeft = pageRect.left + HORIZONTAL_EDGE_PADDING;\n\n    // Make sure tooltip is inside bounds of the page.\n    state.tooltipLeft = Math.min(state.tooltipLeft, maxLeft);\n    state.tooltipLeft = Math.max(state.tooltipLeft, minLeft);\n\n    state.arrowLeftOffset = Math.abs(\n      component.clientX -\n        state.tooltipLeft -\n        this.tooltipArrow_./*OK*/ offsetWidth / 2\n    );\n\n    // Make sure tooltip arrow is inside bounds of the tooltip.\n    state.arrowLeftOffset = Math.min(\n      state.arrowLeftOffset,\n      tooltipWidth - TOOLTIP_ARROW_RIGHT_PADDING\n    );\n    state.arrowLeftOffset = Math.max(state.arrowLeftOffset, 0);\n  }\n\n  /**\n   * Handles click outside the tooltip.\n   * @param {!Event} event\n   * @private\n   */\n  onOutsideTooltipClick_(event) {\n    if (\n      !closest(dev().assertElement(event.target), (el) => el == this.tooltip_)\n    ) {\n      event.stopPropagation();\n      this.close_();\n    }\n  }\n\n  /**\n   * Clears any attributes or handlers that may have been added to the tooltip,\n   * but weren't used because the user dismissed the tooltip.\n   * @private\n   */\n  clearTooltip_() {\n    this.mutator_.mutateElement(dev().assertElement(this.tooltip_), () => {\n      const actionIcon = this.tooltip_.querySelector(\n        '.i-amphtml-tooltip-action-icon'\n      );\n      actionIcon.className = 'i-amphtml-tooltip-action-icon';\n\n      const customIcon = this.tooltip_.querySelector(\n        '.i-amphtml-story-tooltip-custom-icon'\n      );\n      customIcon.className = 'i-amphtml-story-tooltip-custom-icon';\n      resetStyles(customIcon, ['background-image']);\n\n      this.tooltip_.removeEventListener(\n        'click',\n        this.expandComponentHandler_,\n        true\n      );\n      this.tooltip_.classList.remove(DARK_THEME_CLASS);\n      this.tooltip_.removeAttribute('href');\n    });\n  }\n\n  /**\n   * Builds the focused state template.\n   * @param {!Document} doc\n   * @return {!Element}\n   * @private\n   */\n  buildFocusedStateTemplate_(doc) {\n    const html = htmlFor(doc);\n    const tooltipOverlay = html`\n      <section\n        class=\"i-amphtml-story-focused-state-layer\n            i-amphtml-story-system-reset i-amphtml-hidden\"\n      >\n        <div\n          class=\"i-amphtml-story-focused-state-layer-nav-button-container\n              i-amphtml-story-tooltip-nav-button-left\"\n        >\n          <button\n            ref=\"buttonLeft\"\n            class=\"i-amphtml-story-focused-state-layer-nav-button\n                i-amphtml-story-tooltip-nav-button-left\"\n          ></button>\n        </div>\n        <div\n          class=\"i-amphtml-story-focused-state-layer-nav-button-container\n              i-amphtml-story-tooltip-nav-button-right\"\n        >\n          <button\n            ref=\"buttonRight\"\n            class=\"i-amphtml-story-focused-state-layer-nav-button\n                    i-amphtml-story-tooltip-nav-button-right\"\n          ></button>\n        </div>\n        <a\n          class=\"i-amphtml-story-tooltip\"\n          target=\"_blank\"\n          ref=\"tooltip\"\n          role=\"tooltip\"\n        >\n          <div class=\"i-amphtml-story-tooltip-custom-icon\"></div>\n          <p class=\"i-amphtml-tooltip-text\" ref=\"text\"></p>\n          <div class=\"i-amphtml-tooltip-action-icon\"></div>\n          <div class=\"i-amphtml-story-tooltip-arrow\" ref=\"arrow\"></div>\n        </a>\n      </section>\n    `;\n    const overlayEls = htmlRefs(tooltipOverlay);\n    const {arrow, buttonLeft, buttonRight, tooltip} =\n      /** @type {!tooltipElementsDef} */ (overlayEls);\n\n    this.tooltip_ = tooltip;\n    this.tooltipArrow_ = arrow;\n    this.buttonLeft_ = buttonLeft;\n    this.buttonRight_ = buttonRight;\n    const rtlState = this.storeService_.get(StateProperty.RTL_STATE);\n\n    this.buttonLeft_.addEventListener('click', (e) =>\n      this.onNavigationalClick_(\n        e,\n        rtlState ? EventType.NEXT_PAGE : EventType.PREVIOUS_PAGE\n      )\n    );\n\n    this.buttonRight_.addEventListener('click', (e) =>\n      this.onNavigationalClick_(\n        e,\n        rtlState ? EventType.PREVIOUS_PAGE : EventType.NEXT_PAGE\n      )\n    );\n\n    return tooltipOverlay;\n  }\n\n  /**\n   * Navigates to next/previous page.\n   * @param {!Event} event\n   * @param {string} direction\n   * @private\n   */\n  onNavigationalClick_(event, direction) {\n    event.preventDefault();\n    this.storeService_.dispatch(\n      Action.SET_ADVANCEMENT_MODE,\n      AdvancementMode.MANUAL_ADVANCE\n    );\n    dispatch(\n      this.win_,\n      dev().assertElement(this.shadowRoot_),\n      direction,\n      undefined,\n      {bubbles: true}\n    );\n  }\n\n  /**\n   * Linkers don't work on shadow root elements so we click a clone of the anchor on the root dom.\n   * @param {!Event} event\n   * @private\n   */\n  onAnchorClick_(event) {\n    event.preventDefault();\n    triggerClickFromLightDom(this.tooltip_, this.storyEl_);\n  }\n\n  /**\n   * @visibleForTesting\n   * @return {?Element}\n   */\n  getShadowRootForTesting() {\n    return this.shadowRoot_;\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {AFFILIATE_LINK_SELECTOR} from './amp-story-affiliate-link';\nimport {\n  Action,\n  EmbeddedComponentState,\n  InteractiveComponentDef,\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {AdvancementMode} from './story-analytics';\nimport {Services} from '../../../src/services';\nimport {TAPPABLE_ARIA_ROLES} from '../../../src/service/action-impl';\nimport {VideoEvents} from '../../../src/video-interface';\nimport {closest, matches} from '../../../src/core/dom/query';\nimport {dev, user} from '../../../src/log';\nimport {escapeCssSelectorIdent} from '../../../src/core/dom/css-selectors';\nimport {getAmpdoc} from '../../../src/service';\nimport {hasTapAction, timeStrToMillis} from './utils';\nimport {interactiveElementsSelectors} from './amp-story-embedded-component';\nimport {listenOnce} from '../../../src/event-helper';\n\n/** @private @const {number} */\nconst HOLD_TOUCH_THRESHOLD_MS = 500;\n\n/** @private @const {number} */\nconst NEXT_SCREEN_AREA_RATIO = 0.75;\n\n/** @private @const {number} */\nconst PREVIOUS_SCREEN_AREA_RATIO = 0.25;\n\n/** @private @const {number} */\nconst TOP_REGION = 0.8;\n\n/**\n * Protected edges of the screen as a percent of page width. When tapped on these areas, we will\n * always perform navigation. Even if a clickable element is there.\n * @const {number}\n * @private\n */\nconst PROTECTED_SCREEN_EDGE_PERCENT = 12;\n\n/**\n * Minimum protected edges of the screen in pixels.\n * If PROTECTED_SCREEN_EDGE_PERCENT results in a protected edge value less than MINIMUM_PROTECTED_SCREEN_EDGE_PX,\n * we will use MINIMUM_PROTECTED_SCREEN_EDGE_PX.\n * @const {number}\n * @private\n */\nconst MINIMUM_PROTECTED_SCREEN_EDGE_PX = 48;\n\n/** @private @const {number} */\nconst MINIMUM_TIME_BASED_AUTO_ADVANCE_MS = 500;\n\n/**\n * Maximum percent of screen that can be occupied by a single link\n * before the link is considered navigation blocking and ignored.\n * @const {number}\n * @private\n */\nconst MAX_LINK_SCREEN_PERCENT = 0.8;\n\nconst INTERACTIVE_EMBEDDED_COMPONENTS_SELECTORS = Object.values(\n  interactiveElementsSelectors()\n).join(',');\n\n/** @const {number} */\nexport const POLL_INTERVAL_MS = 300;\n\n/** @const @enum */\nexport const TapNavigationDirection = {\n  'NEXT': 1,\n  'PREVIOUS': 2,\n};\n\n/**\n * Base class for the AdvancementConfig.  By default, does nothing other than\n * tracking its internal state when started/stopped, and listeners will never be\n * invoked.\n */\nexport class AdvancementConfig {\n  /**\n   * @public\n   */\n  constructor() {\n    /** @private @const {!Array<function(number)>} */\n    this.progressListeners_ = [];\n\n    /** @private @const {!Array<function()>} */\n    this.advanceListeners_ = [];\n\n    /** @private @const {!Array<function()>} */\n    this.previousListeners_ = [];\n\n    /** @private @const {!Array<function(number)>} */\n    this.tapNavigationListeners_ = [];\n\n    /** @private {boolean} */\n    this.isRunning_ = false;\n  }\n\n  /**\n   * @param {function(number)} progressListener A function that handles when the\n   *     progress of the current page has been updated.  It accepts a number\n   *     between 0.0 and 1.0 as its only argument, that represents the current\n   *     progress.\n   */\n  addProgressListener(progressListener) {\n    this.progressListeners_.push(progressListener);\n  }\n\n  /**\n   * @param {function()} advanceListener A function that handles when a\n   *     page should be advanced.\n   */\n  addAdvanceListener(advanceListener) {\n    this.advanceListeners_.push(advanceListener);\n  }\n\n  /**\n   * @param {function()} previousListener A function that handles when a\n   *     page should go back to the previous page.\n   */\n  addPreviousListener(previousListener) {\n    this.previousListeners_.push(previousListener);\n  }\n\n  /**\n   * @param {function(number)} onTapNavigationListener A function that handles when a\n   * navigation listener to be fired.\n   */\n  addOnTapNavigationListener(onTapNavigationListener) {\n    this.tapNavigationListeners_.push(onTapNavigationListener);\n  }\n\n  /**\n   * Invoked when the advancement configuration should begin taking effect.\n   */\n  start() {\n    this.isRunning_ = true;\n  }\n\n  /**\n   * Invoked when the advancement configuration should cease taking effect.\n   * @param {boolean=} unusedCanResume\n   */\n  stop(unusedCanResume) {\n    this.isRunning_ = false;\n  }\n\n  /**\n   * Returns whether the advancement configuration will automatically advance\n   * @return {boolean}\n   */\n  isAutoAdvance() {\n    return false;\n  }\n\n  /**\n   * @return {boolean}\n   * @protected\n   */\n  isRunning() {\n    return this.isRunning_;\n  }\n\n  /**\n   * @return {number}\n   */\n  getProgress() {\n    return 1;\n  }\n\n  /** @protected */\n  onProgressUpdate() {\n    const progress = this.getProgress();\n    this.progressListeners_.forEach((progressListener) => {\n      progressListener(progress);\n    });\n  }\n\n  /** @protected */\n  onAdvance() {\n    this.advanceListeners_.forEach((advanceListener) => {\n      advanceListener();\n    });\n  }\n\n  /** @protected */\n  onPrevious() {\n    this.previousListeners_.forEach((previousListener) => {\n      previousListener();\n    });\n  }\n\n  /**\n   * @param {number} navigationDirection Direction of navigation\n   * @protected\n   */\n  onTapNavigation(navigationDirection) {\n    this.tapNavigationListeners_.forEach((navigationListener) => {\n      navigationListener(navigationDirection);\n    });\n  }\n\n  /**\n   * Provides an AdvancementConfig object for the specified amp-story or\n   * amp-story-page.\n   * @param {!Window} win\n   * @param {!Element} element\n   * @return {!AdvancementConfig|!ManualAdvancement|!TimeBasedAdvancement|!MediaBasedAdvancement}\n   */\n  static forElement(win, element) {\n    const manualAdvancement = ManualAdvancement.fromElement(win, element);\n    if (manualAdvancement) {\n      return manualAdvancement;\n    }\n\n    const autoAdvanceStr = element.getAttribute('auto-advance-after');\n\n    if (autoAdvanceStr) {\n      const timeBasedAdvancement = TimeBasedAdvancement.fromAutoAdvanceString(\n        autoAdvanceStr,\n        win,\n        element\n      );\n      if (timeBasedAdvancement) {\n        return timeBasedAdvancement;\n      }\n\n      const mediaBasedAdvancement = MediaBasedAdvancement.fromAutoAdvanceString(\n        autoAdvanceStr,\n        win,\n        element\n      );\n      if (mediaBasedAdvancement) {\n        return mediaBasedAdvancement;\n      }\n    }\n\n    return new AdvancementConfig();\n  }\n}\n\n/**\n * Always provides a progress of 1.0.  Advances when the user taps the\n * corresponding section, depending on language settings.\n */\nexport class ManualAdvancement extends AdvancementConfig {\n  /**\n   * @param {!Window} win The Window object.\n   * @param {!Element} element The element that, when clicked, can cause\n   *     advancing to the next page or going back to the previous.\n   */\n  constructor(win, element) {\n    super();\n\n    /** @private @const {!Element} */\n    this.element_ = element;\n\n    /** @private {number|string|null} */\n    this.timeoutId_ = null;\n\n    /** @private @const {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(win);\n\n    /** @private {?number} Last touchstart event's timestamp */\n    this.touchstartTimestamp_ = null;\n\n    /** @private {boolean} Saving the paused state before pressing */\n    this.pausedState_ = false;\n\n    /** @private {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = getAmpdoc(win.document);\n\n    this.startListening_();\n\n    if (element.ownerDocument.defaultView) {\n      /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n      this.storeService_ = getStoreService(element.ownerDocument.defaultView);\n    }\n\n    const rtlState = this.storeService_.get(StateProperty.RTL_STATE);\n    this.sections_ = {\n      // Width and navigation direction of each section depend on whether the\n      // document is RTL or LTR.\n      left: {\n        widthRatio: rtlState\n          ? NEXT_SCREEN_AREA_RATIO\n          : PREVIOUS_SCREEN_AREA_RATIO,\n        direction: rtlState\n          ? TapNavigationDirection.NEXT\n          : TapNavigationDirection.PREVIOUS,\n      },\n      right: {\n        widthRatio: rtlState\n          ? PREVIOUS_SCREEN_AREA_RATIO\n          : NEXT_SCREEN_AREA_RATIO,\n        direction: rtlState\n          ? TapNavigationDirection.PREVIOUS\n          : TapNavigationDirection.NEXT,\n      },\n    };\n  }\n\n  /** @override */\n  getProgress() {\n    return 1.0;\n  }\n\n  /**\n   * Binds the event listeners.\n   * @private\n   */\n  startListening_() {\n    this.element_.addEventListener(\n      'touchstart',\n      this.onTouchstart_.bind(this),\n      true\n    );\n    this.element_.addEventListener(\n      'touchend',\n      this.onTouchend_.bind(this),\n      true\n    );\n    this.element_.addEventListener(\n      'click',\n      this.maybePerformNavigation_.bind(this),\n      true\n    );\n    this.ampdoc_.onVisibilityChanged(() => {\n      this.ampdoc_.isVisible() ? this.processTouchend_() : null;\n    });\n  }\n\n  /**\n   * @override\n   */\n  isAutoAdvance() {\n    return false;\n  }\n\n  /**\n   * TouchEvent touchstart events handler.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchstart_(event) {\n    // Don't start the paused state if the event should not be handled by this\n    // class. Also ignores any subsequent touchstart that would happen before\n    // touchend was fired, since it'd reset the touchstartTimestamp (ie: user\n    // touches the screen with a second finger).\n    if (this.touchstartTimestamp_ || !this.shouldHandleEvent_(event)) {\n      return;\n    }\n    this.touchstartTimestamp_ = Date.now();\n    this.pausedState_ = /** @type {boolean} */ (\n      this.storeService_.get(StateProperty.PAUSED_STATE)\n    );\n    this.storeService_.dispatch(Action.TOGGLE_PAUSED, true);\n    this.timeoutId_ = this.timer_.delay(() => {\n      this.storeService_.dispatch(Action.TOGGLE_SYSTEM_UI_IS_VISIBLE, false);\n    }, HOLD_TOUCH_THRESHOLD_MS);\n  }\n\n  /**\n   * TouchEvent touchend events handler.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchend_(event) {\n    // Ignores the event if there's still a user's finger holding the screen.\n    const touchesCount = (event.touches || []).length;\n    if (!this.touchstartTimestamp_ || touchesCount > 0) {\n      return;\n    }\n\n    // Cancels the navigation if user paused the story for over 500ms. Calling\n    // preventDefault on the touchend event ensures the click/tap event won't\n    // fire.\n    if (Date.now() - this.touchstartTimestamp_ > HOLD_TOUCH_THRESHOLD_MS) {\n      event.preventDefault();\n    }\n\n    this.processTouchend_();\n  }\n\n  /**\n   * Logic triggered by touchend events.\n   * @private\n   */\n  processTouchend_() {\n    if (!this.touchstartTimestamp_) {\n      return;\n    }\n    this.storeService_.dispatch(Action.TOGGLE_PAUSED, this.pausedState_);\n    this.touchstartTimestamp_ = null;\n    this.timer_.cancel(this.timeoutId_);\n    this.timeoutId_ = null;\n    if (\n      !this.storeService_.get(StateProperty.SYSTEM_UI_IS_VISIBLE_STATE) &&\n      /** @type {InteractiveComponentDef} */ (\n        this.storeService_.get(StateProperty.INTERACTIVE_COMPONENT_STATE)\n      ).state !== EmbeddedComponentState.EXPANDED\n    ) {\n      this.storeService_.dispatch(Action.TOGGLE_SYSTEM_UI_IS_VISIBLE, true);\n    }\n  }\n\n  /**\n   * Determines whether a click should be used for navigation.  Navigate should\n   * occur unless the click is on the system layer, or on an element that\n   * defines on=\"tap:...\"\n   * @param {!Event} event 'click' event.\n   * @return {boolean} true, if the click should be used for navigation.\n   * @private\n   */\n  isNavigationalClick_(event) {\n    return !closest(\n      dev().assertElement(event.target),\n      (el) => {\n        return hasTapAction(el);\n      },\n      /* opt_stopAt */ this.element_\n    );\n  }\n\n  /**\n   * We want clicks on certain elements to be exempted from normal page\n   * navigation\n   * @param {!Event} event\n   * @return {boolean}\n   * @private\n   */\n  isProtectedTarget_(event) {\n    return !!closest(\n      dev().assertElement(event.target),\n      (el) => {\n        const elementRole = el.getAttribute('role');\n\n        if (elementRole) {\n          return !!TAPPABLE_ARIA_ROLES[elementRole.toLowerCase()];\n        }\n        return false;\n      },\n      /* opt_stopAt */ this.element_\n    );\n  }\n\n  /**\n   * Checks if the event should be handled by ManualAdvancement, or should\n   * follow its capture phase.\n   * @param {!Event} event\n   * @return {boolean}\n   * @private\n   */\n  shouldHandleEvent_(event) {\n    let shouldHandleEvent = false;\n    let tagName;\n\n    closest(\n      dev().assertElement(event.target),\n      (el) => {\n        tagName = el.tagName.toLowerCase();\n\n        if (\n          tagName === 'amp-story-page-attachment' ||\n          tagName === 'amp-story-page-outlink'\n        ) {\n          shouldHandleEvent = false;\n          return true;\n        }\n\n        if (\n          tagName.startsWith('amp-story-interactive-') &&\n          !this.isInStoryPageSideEdge_(event, this.getStoryPageRect_())\n        ) {\n          shouldHandleEvent = false;\n          return true;\n        }\n\n        if (tagName === 'amp-story-page') {\n          shouldHandleEvent = true;\n          return true;\n        }\n\n        return false;\n      },\n      /* opt_stopAt */ this.element_\n    );\n\n    return shouldHandleEvent;\n  }\n\n  /**\n   * For an element to trigger a tooltip it has to be descendant of\n   * amp-story-page but not of amp-story-cta-layer, amp-story-page-attachment or amp-story-page-outlink.\n   * @param {!Event} event\n   * @param {!ClientRect} pageRect\n   * @return {boolean}\n   * @private\n   */\n  canShowTooltip_(event, pageRect) {\n    let valid = true;\n    let tagName;\n    // We have a `pointer-events: none` set to all children of <a> tags inside\n    // of amp-story-grid-layer, which acts as a click shield, making sure we\n    // handle the click before navigation (see amp-story.css). It also ensures\n    // we always get the <a> to be the target, even if it has children (e.g.\n    // <span>).\n    const target = dev().assertElement(event.target);\n\n    if (\n      this.isInStoryPageSideEdge_(event, pageRect) ||\n      this.isTooLargeOnPage_(event, pageRect)\n    ) {\n      event.preventDefault();\n      return false;\n    }\n\n    if (\n      target.getAttribute('show-tooltip') === 'auto' &&\n      this.isInScreenBottom_(target, pageRect)\n    ) {\n      target.setAttribute('target', '_blank');\n      target.setAttribute('role', 'link');\n      return false;\n    }\n\n    return !!closest(\n      target,\n      (el) => {\n        tagName = el.tagName.toLowerCase();\n\n        if (\n          tagName === 'amp-story-cta-layer' ||\n          tagName === 'amp-story-page-attachment' ||\n          tagName === 'amp-story-page-outlink'\n        ) {\n          valid = false;\n          return false;\n        }\n\n        return tagName === 'amp-story-page' && valid;\n      },\n      /* opt_stopAt */ this.element_\n    );\n  }\n\n  /**\n   * Checks if element is inside of the bottom region of the screen.\n   * @param {!Element} target\n   * @param {!ClientRect} pageRect\n   * @return {boolean}\n   * @private\n   */\n  isInScreenBottom_(target, pageRect) {\n    const targetRect = target./*OK*/ getBoundingClientRect();\n    return targetRect.top - pageRect.top >= pageRect.height * TOP_REGION;\n  }\n\n  /**\n   * Checks if click was inside of one of the side edges of the page.\n   * @param {!Event} event\n   * @param {!ClientRect} pageRect\n   * @return {boolean}\n   * @private\n   */\n  isInStoryPageSideEdge_(event, pageRect) {\n    // Clicks with coordinates (0,0) are assumed to be from keyboard or Talkback.\n    // These clicks should never be overriden for navigation.\n    if (event.clientX === 0 && event.clientY === 0) {\n      return false;\n    }\n\n    const sideEdgeWidthFromPercent =\n      pageRect.width * (PROTECTED_SCREEN_EDGE_PERCENT / 100);\n    const sideEdgeLimit = Math.max(\n      sideEdgeWidthFromPercent,\n      MINIMUM_PROTECTED_SCREEN_EDGE_PX\n    );\n\n    return (\n      event.clientX <= pageRect.x + sideEdgeLimit ||\n      event.clientX >= pageRect.x + pageRect.width - sideEdgeLimit\n    );\n  }\n\n  /**\n   * Checks if click target is too large on the page and preventing navigation.\n   * If yes, the link is ignored & logged.\n   * @param {!Event} event\n   * @param {!ClientRect} pageRect\n   * @return {boolean}\n   * @private\n   */\n  isTooLargeOnPage_(event, pageRect) {\n    // Clicks with coordinates (0,0) are assumed to be from keyboard or Talkback.\n    // These clicks should never be overriden for navigation.\n    if (event.clientX === 0 && event.clientY === 0) {\n      return false;\n    }\n\n    const target = dev().assertElement(event.target);\n    const targetRect = target./*OK*/ getBoundingClientRect();\n    if (\n      (targetRect.height * targetRect.width) /\n        (pageRect.width * pageRect.height) >=\n      MAX_LINK_SCREEN_PERCENT\n    ) {\n      user().error(\n        'AMP-STORY-PAGE',\n        'Link was too large; skipped for navigation. For more information, see https://github.com/ampproject/amphtml/issues/31108'\n      );\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Checks if click should be handled by the embedded component logic rather\n   * than by navigation.\n   * @param {!Event} event\n   * @param {!ClientRect} pageRect\n   * @return {boolean}\n   * @private\n   */\n  isHandledByEmbeddedComponent_(event, pageRect) {\n    const target = dev().assertElement(event.target);\n    const stored = /** @type {InteractiveComponentDef} */ (\n      this.storeService_.get(StateProperty.INTERACTIVE_COMPONENT_STATE)\n    );\n    const inExpandedMode = stored.state === EmbeddedComponentState.EXPANDED;\n\n    return (\n      inExpandedMode ||\n      (matches(target, INTERACTIVE_EMBEDDED_COMPONENTS_SELECTORS) &&\n        this.canShowTooltip_(event, pageRect))\n    );\n  }\n\n  /**\n   * Check if click should be handled by the affiliate link logic.\n   * @param {!Element} target\n   * @private\n   * @return {boolean}\n   */\n  isHandledByAffiliateLink_(target) {\n    const clickedOnLink = matches(target, AFFILIATE_LINK_SELECTOR);\n\n    // do not handle if clicking on expanded affiliate link\n    if (clickedOnLink && target.hasAttribute('expanded')) {\n      return false;\n    }\n\n    const expandedElement = this.storeService_.get(\n      StateProperty.AFFILIATE_LINK_STATE\n    );\n\n    return expandedElement != null || clickedOnLink;\n  }\n\n  /**\n   * Performs a system navigation if it is determined that the specified event\n   * was a click intended for navigation.\n   * @param {!Event} event 'click' event\n   * @private\n   */\n  maybePerformNavigation_(event) {\n    const target = dev().assertElement(event.target);\n\n    const pageRect = this.getStoryPageRect_();\n\n    if (this.isHandledByEmbeddedComponent_(event, pageRect)) {\n      event.stopPropagation();\n      event.preventDefault();\n      const embedComponent = /** @type {InteractiveComponentDef} */ (\n        this.storeService_.get(StateProperty.INTERACTIVE_COMPONENT_STATE)\n      );\n      this.storeService_.dispatch(Action.TOGGLE_INTERACTIVE_COMPONENT, {\n        element: target,\n        state: embedComponent.state || EmbeddedComponentState.FOCUSED,\n        clientX: event.clientX,\n        clientY: event.clientY,\n      });\n      return;\n    }\n\n    if (this.isHandledByAffiliateLink_(target)) {\n      event.preventDefault();\n      event.stopPropagation();\n      const clickedOnLink = matches(target, AFFILIATE_LINK_SELECTOR);\n      if (clickedOnLink) {\n        this.storeService_.dispatch(Action.TOGGLE_AFFILIATE_LINK, target);\n      } else {\n        this.storeService_.dispatch(Action.TOGGLE_AFFILIATE_LINK, null);\n      }\n      return;\n    }\n\n    if (\n      !this.isRunning() ||\n      !this.isNavigationalClick_(event) ||\n      this.isProtectedTarget_(event) ||\n      !this.shouldHandleEvent_(event)\n    ) {\n      // If the system doesn't need to handle this click, then we can simply\n      // return and let the event propagate as it would have otherwise.\n      return;\n    }\n\n    event.stopPropagation();\n\n    this.storeService_.dispatch(\n      Action.SET_ADVANCEMENT_MODE,\n      AdvancementMode.MANUAL_ADVANCE\n    );\n\n    // Using `left` as a fallback since Safari returns a ClientRect in some\n    // cases.\n    const offsetLeft = 'x' in pageRect ? pageRect.x : pageRect.left;\n\n    const page = {\n      // Offset starting left of the page.\n      offset: offsetLeft,\n      width: pageRect.width,\n      clickEventX: event.pageX,\n    };\n\n    this.onTapNavigation(this.getTapDirection_(page));\n  }\n\n  /**\n   * Calculates the pageRect based on the UIType.\n   * We can an use LayoutBox for mobile since the story page occupies entire screen.\n   * Desktop UI needs the most recent value from the getBoundingClientRect function.\n   * @return {DOMRect | LayoutBox}\n   * @private\n   */\n  getStoryPageRect_() {\n    if (\n      this.storeService_.get(StateProperty.UI_STATE) !== UIType.DESKTOP_PANELS\n    ) {\n      return this.element_.getLayoutBox();\n    } else {\n      return this.element_\n        .querySelector('amp-story-page[active]')\n        ./*OK*/ getBoundingClientRect();\n    }\n  }\n\n  /**\n   * Decides what direction to navigate depending on which\n   * section of the page was there a click. The navigation direction of each\n   * individual section has been previously defined depending on the language\n   * settings.\n   * @param {!Object} page\n   * @return {number}\n   * @private\n   */\n  getTapDirection_(page) {\n    const {left, right} = this.sections_;\n\n    if (page.clickEventX <= page.offset + left.widthRatio * page.width) {\n      return left.direction;\n    }\n\n    return right.direction;\n  }\n\n  /**\n   * Gets an instance of ManualAdvancement based on the HTML tag of the element.\n   * @param {!Window} win\n   * @param {!Element} element\n   * @return {?AdvancementConfig} An AdvancementConfig, only if the element is\n   *                              an amp-story tag.\n   */\n  static fromElement(win, element) {\n    if (element.tagName.toLowerCase() !== 'amp-story') {\n      return null;\n    }\n    return new ManualAdvancement(win, element);\n  }\n}\n\n/**\n * Provides progress and advancement based on a fixed duration of time,\n * specified in either seconds or milliseconds.\n */\nexport class TimeBasedAdvancement extends AdvancementConfig {\n  /**\n   * @param {!Window} win The Window object.\n   * @param {number} delayMs The duration to wait before advancing.\n   * @param {!Element} element\n   */\n  constructor(win, delayMs, element) {\n    super();\n\n    /** @private @const {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(win);\n\n    if (delayMs < MINIMUM_TIME_BASED_AUTO_ADVANCE_MS) {\n      user().warn(\n        'AMP-STORY-PAGE',\n        `${element.id} has an auto advance duration that is too short. ` +\n          `${MINIMUM_TIME_BASED_AUTO_ADVANCE_MS}ms is used instead.`\n      );\n      delayMs = MINIMUM_TIME_BASED_AUTO_ADVANCE_MS;\n    }\n    /** @private @const {number} */\n    this.delayMs_ = delayMs;\n\n    /** @private {?number} */\n    this.remainingDelayMs_ = null;\n\n    /** @private {?number} */\n    this.startTimeMs_ = null;\n\n    /** @private {number|string|null} */\n    this.timeoutId_ = null;\n\n    if (element.ownerDocument.defaultView) {\n      /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n      this.storeService_ = getStoreService(element.ownerDocument.defaultView);\n    }\n  }\n\n  /**\n   * @return {number} The current timestamp, in milliseconds.\n   * @private\n   */\n  getCurrentTimestampMs_() {\n    return Date.now();\n  }\n\n  /** @override */\n  start() {\n    super.start();\n\n    if (this.remainingDelayMs_) {\n      this.startTimeMs_ =\n        this.getCurrentTimestampMs_() -\n        (this.delayMs_ - this.remainingDelayMs_);\n    } else {\n      this.startTimeMs_ = this.getCurrentTimestampMs_();\n    }\n\n    this.timeoutId_ = this.timer_.delay(\n      () => this.onAdvance(),\n      this.remainingDelayMs_ || this.delayMs_\n    );\n\n    this.onProgressUpdate();\n\n    this.timer_.poll(POLL_INTERVAL_MS, () => {\n      this.onProgressUpdate();\n      return !this.isRunning();\n    });\n  }\n\n  /** @override */\n  stop(canResume = false) {\n    super.stop();\n\n    if (this.timeoutId_ !== null) {\n      this.timer_.cancel(this.timeoutId_);\n    }\n\n    // Store the remaining time if the advancement can be resume, ie: if it is\n    // paused.\n    this.remainingDelayMs_ = canResume\n      ? this.startTimeMs_ + this.delayMs_ - this.getCurrentTimestampMs_()\n      : null;\n  }\n\n  /**\n   * @override\n   */\n  isAutoAdvance() {\n    return true;\n  }\n\n  /** @override */\n  getProgress() {\n    if (this.startTimeMs_ === null) {\n      return 0;\n    }\n\n    const progress =\n      (this.getCurrentTimestampMs_() - this.startTimeMs_) / this.delayMs_;\n\n    return Math.min(Math.max(progress, 0), 1);\n  }\n\n  /** @override */\n  onAdvance() {\n    this.storeService_.dispatch(\n      Action.SET_ADVANCEMENT_MODE,\n      AdvancementMode.AUTO_ADVANCE_TIME\n    );\n    super.onAdvance();\n  }\n\n  /**\n   * Updates the delay (and derived values) from the given auto-advance string.\n   * @param {string} autoAdvanceStr The value of the updated auto-advance-after attribute.\n   */\n  updateTimeDelay(autoAdvanceStr) {\n    const newDelayMs = timeStrToMillis(autoAdvanceStr);\n    if (newDelayMs === undefined || isNaN(newDelayMs)) {\n      return;\n    }\n    if (this.remainingDelayMs_) {\n      this.remainingDelayMs_ += newDelayMs - this.delayMs_;\n    }\n    this.delayMs_ = newDelayMs;\n  }\n\n  /**\n   * Gets an instance of TimeBasedAdvancement based on the value of the\n   * auto-advance string (from the 'auto-advance-after' attribute on the page).\n   * @param {string} autoAdvanceStr The value of the auto-advance-after\n   *     attribute.\n   * @param {!Window} win\n   * @param {!Element} element\n   * @return {?AdvancementConfig} An AdvancementConfig, if time-based\n   *     auto-advance is supported for the specified auto-advance string; null\n   *     otherwise.\n   */\n  static fromAutoAdvanceString(autoAdvanceStr, win, element) {\n    if (!autoAdvanceStr) {\n      return null;\n    }\n\n    const delayMs = timeStrToMillis(autoAdvanceStr);\n    if (delayMs === undefined || isNaN(delayMs)) {\n      return null;\n    }\n\n    return new TimeBasedAdvancement(win, Number(delayMs), element);\n  }\n}\n\n/**\n * Provides progress and advances pages based on the completion percentage of\n * playback of an HTMLMediaElement or a video that implements the AMP\n * video-interface.\n *\n * These are combined into a single AdvancementConfig implementation because we\n * may not know at build time whether a video implements the AMP\n * video-interface, since that is dependent on the amp-video buildCallback\n * having been executed before the amp-story-page buildCallback, which is not\n * guaranteed.\n */\nexport class MediaBasedAdvancement extends AdvancementConfig {\n  /**\n   * @param {!Window} win\n   * @param {!Element} element\n   */\n  constructor(win, element) {\n    super();\n\n    /** @private @const {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(win);\n\n    /** @private {!Element} */\n    this.element_ = element;\n\n    /** @private {?Element} */\n    this.mediaElement_ = null;\n\n    /** @private {!Array<!UnlistenDef>} */\n    this.unlistenFns_ = [];\n\n    /** @protected {?UnlistenDef} */\n    this.unlistenEndedFn_ = null;\n\n    /** @protected {?UnlistenDef} */\n    this.unlistenTimeupdateFn_ = null;\n\n    /** @private {?../../../src/video-interface.VideoInterface} */\n    this.video_ = null;\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(win);\n  }\n\n  /**\n   * Determines whether the element for auto advancement implements the video\n   * interface.\n   * @return {boolean} true, if the specified element implements the video\n   *     interface.\n   * @private\n   */\n  isVideoInterfaceVideo_() {\n    return this.element_.classList.contains('i-amphtml-video-interface');\n  }\n\n  /**\n   * Gets an HTMLMediaElement from an element that wraps it.\n   * @return {?Element} The underlying HTMLMediaElement, if one exists.\n   * @private\n   */\n  getMediaElement_() {\n    const tagName = this.element_.tagName.toLowerCase();\n\n    if (this.element_ instanceof HTMLMediaElement) {\n      return this.element_;\n    } else if (\n      this.element_.hasAttribute('background-audio') &&\n      tagName === 'amp-story-page'\n    ) {\n      return this.element_.querySelector('.i-amphtml-story-background-audio');\n    } else if (tagName === 'amp-audio') {\n      return this.element_.querySelector('audio');\n    }\n\n    return null;\n  }\n\n  /** @override */\n  start() {\n    super.start();\n\n    // Prevents race condition when checking for video interface classname.\n    (this.element_.build ? this.element_.build() : Promise.resolve()).then(() =>\n      this.startWhenBuilt_()\n    );\n  }\n\n  /** @private */\n  startWhenBuilt_() {\n    if (this.isVideoInterfaceVideo_()) {\n      this.startVideoInterfaceElement_();\n      return;\n    }\n\n    if (!this.mediaElement_) {\n      this.mediaElement_ = this.getMediaElement_();\n    }\n\n    if (this.mediaElement_) {\n      this.startHtmlMediaElement_();\n      return;\n    }\n\n    user().error(\n      'AMP-STORY-PAGE',\n      `Element with ID ${this.element_.id} is not a media element ` +\n        'supported for automatic advancement.'\n    );\n  }\n\n  /** @private */\n  startHtmlMediaElement_() {\n    const mediaElement = dev().assertElement(\n      this.mediaElement_,\n      'Media element was unspecified.'\n    );\n\n    // Removes [loop] attribute if specified, so the 'ended' event can trigger.\n    this.mediaElement_.removeAttribute('loop');\n\n    this.unlistenFns_.push(\n      listenOnce(mediaElement, 'ended', () => this.onAdvance())\n    );\n\n    this.onProgressUpdate();\n\n    this.timer_.poll(POLL_INTERVAL_MS, () => {\n      this.onProgressUpdate();\n      return !this.isRunning();\n    });\n  }\n\n  /** @private */\n  startVideoInterfaceElement_() {\n    this.element_.getImpl().then((video) => {\n      this.video_ = video;\n    });\n\n    // Removes [loop] attribute if specified, so the 'ended' event can trigger.\n    this.element_.querySelector('video').removeAttribute('loop');\n\n    this.unlistenFns_.push(\n      listenOnce(this.element_, VideoEvents.ENDED, () => this.onAdvance(), {\n        capture: true,\n      })\n    );\n\n    this.onProgressUpdate();\n\n    this.timer_.poll(POLL_INTERVAL_MS, () => {\n      this.onProgressUpdate();\n      return !this.isRunning();\n    });\n  }\n\n  /** @override */\n  stop() {\n    super.stop();\n    this.unlistenFns_.forEach((fn) => fn());\n  }\n\n  /**\n   * @override\n   */\n  isAutoAdvance() {\n    return true;\n  }\n\n  /** @override */\n  getProgress() {\n    if (this.isVideoInterfaceVideo_()) {\n      if (this.video_ && this.video_.getDuration()) {\n        return this.video_.getCurrentTime() / this.video_.getDuration();\n      }\n\n      return 0;\n    }\n\n    if (this.mediaElement_ && this.mediaElement_.duration) {\n      return this.mediaElement_.currentTime / this.mediaElement_.duration;\n    }\n\n    return super.getProgress();\n  }\n\n  /** @override */\n  onAdvance() {\n    this.storeService_.dispatch(\n      Action.SET_ADVANCEMENT_MODE,\n      AdvancementMode.AUTO_ADVANCE_MEDIA\n    );\n    super.onAdvance();\n  }\n\n  /**\n   * Gets an instance of MediaBasedAdvancement based on the value of the\n   * auto-advance string (from the 'auto-advance-after' attribute on the page).\n   * @param {string} autoAdvanceStr The value of the auto-advance-after\n   *     attribute.\n   * @param {!Window} win\n   * @param {!Element} pageEl\n   * @return {?AdvancementConfig} An AdvancementConfig, if media-element-based\n   *     auto-advance is supported for the specified auto-advance string; null\n   *     otherwise.\n   */\n  static fromAutoAdvanceString(autoAdvanceStr, win, pageEl) {\n    try {\n      // amp-video, amp-audio, as well as amp-story-page with a background audio\n      // are eligible for media based auto advance.\n      let element = pageEl.querySelector(\n        `amp-video[data-id=${escapeCssSelectorIdent(autoAdvanceStr)}],\n          amp-video#${escapeCssSelectorIdent(autoAdvanceStr)},\n          amp-audio[data-id=${escapeCssSelectorIdent(autoAdvanceStr)}],\n          amp-audio#${escapeCssSelectorIdent(autoAdvanceStr)}`\n      );\n      if (\n        matches(\n          pageEl,\n          `amp-story-page[background-audio]#${escapeCssSelectorIdent(\n            autoAdvanceStr\n          )}`\n        )\n      ) {\n        element = pageEl;\n      }\n      if (!element) {\n        if (autoAdvanceStr) {\n          user().warn(\n            'AMP-STORY-PAGE',\n            `Element with ID ${pageEl.id} has no media element ` +\n              'supported for automatic advancement.'\n          );\n        }\n        return null;\n      }\n\n      return new MediaBasedAdvancement(win, element);\n    } catch (e) {\n      return null;\n    }\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// WARNING\n// WARNING\n// WARNING\n// WARNING\n// File must be synced with amp.extens.js\n\n/**\n * A struct for parameters for `Element.animate` call.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Element/animate\n *\n * @typedef {{\n *   target: !Element,\n *   keyframes: !WebKeyframesDef,\n *   vars: ?Object<string, *>,\n *   timing: !WebAnimationTimingDef,\n * }}\n */\nexport let InternalWebAnimationRequestDef;\n\n/**\n * @typedef {\n *   !WebMultiAnimationDef|\n *   !WebSwitchAnimationDef|\n *   !WebCompAnimationDef|\n *   !WebKeyframeAnimationDef\n * }\n */\nexport let WebAnimationDef;\n\n/**\n * @mixes WebAnimationSelectorDef\n * @mixes WebAnimationTimingDef\n * @mixes WebAnimationVarsDef\n * @mixes WebAnimationConditionalDef\n * @typedef {{\n *   animations: !Array<!WebAnimationDef>,\n * }}\n */\nexport let WebMultiAnimationDef;\n\n/**\n * @mixes WebAnimationSelectorDef\n * @mixes WebAnimationTimingDef\n * @mixes WebAnimationVarsDef\n * @mixes WebAnimationConditionalDef\n * @typedef {{\n *   switch: !Array<!WebAnimationDef>,\n * }}\n */\nexport let WebSwitchAnimationDef;\n\n/**\n * @mixes WebAnimationSelectorDef\n * @mixes WebAnimationTimingDef\n * @mixes WebAnimationVarsDef\n * @mixes WebAnimationConditionalDef\n * @typedef {{\n *   animation: string,\n * }}\n */\nexport let WebCompAnimationDef;\n\n/**\n * @mixes WebAnimationSelectorDef\n * @mixes WebAnimationTimingDef\n * @mixes WebAnimationVarsDef\n * @mixes WebAnimationConditionalDef\n * @typedef {{\n *   keyframes: (string|!WebKeyframesDef),\n * }}\n */\nexport let WebKeyframeAnimationDef;\n\n/**\n * @typedef {!Object<string, *>|!Array<!Object<string, *>>}\n */\nexport let WebKeyframesDef;\n\n/**\n * See https://developer.mozilla.org/en-US/docs/Web/API/AnimationEffectTimingProperties\n *\n * @mixin\n * @typedef {{\n *   duration: (time|undefined),\n *   delay: (time|undefined),\n *   endDelay: (time|undefined),\n *   iterations: (number|string|undefined),\n *   iterationStart: (number|undefined),\n *   easing: (string|undefined),\n *   direction: (!WebAnimationTimingDirection|undefined),\n *   fill: (!WebAnimationTimingFill|undefined),\n * }}\n */\nexport let WebAnimationTimingDef;\n\n/**\n * Indicates an extension to a type that allows specifying vars. Vars are\n * specified as properties with the name in the format of `--varName`.\n *\n * @mixin\n * @typedef {Object}\n */\nexport let WebAnimationVarsDef;\n\n/**\n * Defines media parameters for an animation.\n *\n * @mixin\n * @typedef {{\n *   media: (string|undefined),\n *   supports: (string|undefined),\n * }}\n */\nexport let WebAnimationConditionalDef;\n\n/**\n * @typedef {{\n *   target: (!Element|undefined),\n *   selector: (string|undefined),\n *   subtargets: (!Array<!WebAnimationSubtargetDef>|undefined),\n * }}\n */\nexport let WebAnimationSelectorDef;\n\n/**\n * @mixes WebAnimationTimingDef\n * @mixes WebAnimationVarsDef\n * @typedef {{\n *   matcher: (function(!Element, number):boolean|undefined),\n *   index: (number|undefined),\n *   selector: (string|undefined),\n * }}\n */\nexport let WebAnimationSubtargetDef;\n\n/**\n * @typedef {{\n *   scope: (!Element|undefined),\n *   scaleByScope: (boolean|undefined),\n * }}\n *\n * - scope delimits selectors.\n * - scaleByScope determines that CSS resolution should treat the scope\n *   element as a virtual viewport, so that:\n *   1. vw/vh units are relative to the scope's size\n *   2. element's x() and y() coords are relative to the scope's top-left corner\n *   3. element's size and position (width()/height()/x()/y()) are inversely\n *      relative to the scope's transformed scale, e.g. if the scope is scaled\n *      to 90%, the element's dimensions will be returned as if it was unscaled\n *      to 100%.\n */\nexport let WebAnimationBuilderOptionsDef;\n\n/**\n * See https://developer.mozilla.org/en-US/docs/Web/API/Animation/playState\n * @enum {string}\n */\nexport const WebAnimationPlayState = {\n  IDLE: 'idle',\n  PENDING: 'pending',\n  RUNNING: 'running',\n  PAUSED: 'paused',\n  FINISHED: 'finished',\n};\n\n/**\n * See https://developer.mozilla.org/en-US/docs/Web/API/AnimationEffectTimingProperties/direction\n * @enum {string}\n */\nexport const WebAnimationTimingDirection = {\n  NORMAL: 'normal',\n  REVERSE: 'reverse',\n  ALTERNATE: 'alternate',\n  ALTERNATE_REVERSE: 'alternate-reverse',\n};\n\n/**\n * See https://developer.mozilla.org/en-US/docs/Web/API/AnimationEffectTimingProperties/fill\n * @enum {string}\n */\nexport const WebAnimationTimingFill = {\n  NONE: 'none',\n  FORWARDS: 'forwards',\n  BACKWARDS: 'backwards',\n  BOTH: 'both',\n  AUTO: 'auto',\n};\n\n/** @const {!Object<string, boolean>} */\nconst ALLOWLISTED_PROPS = {\n  'opacity': true,\n  'transform': true,\n  'transform-origin': true,\n  'visibility': true,\n  'offset-distance': true,\n  'offsetDistance': true,\n  'clip-path': true,\n  'clipPath': true,\n};\n\n/**\n * @param {string} prop\n * @return {boolean}\n */\nexport function isAllowlistedProp(prop) {\n  return ALLOWLISTED_PROPS[prop] || false;\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Common animations utility functions used in the animation\n * presets.\n */\n\nimport {StoryAnimationDimsDef, WebKeyframesDef} from './animation-types';\nimport {rotate, scale, translate} from '../../../src/style';\n\n/**\n * Translates the element on the 2d plane according to the given points.\n * @param {number} startX Starting point in the abscissa.\n * @param {number} startY Starting point in the ordinate.\n * @param {number} endX Ending point in the abscissa.\n * @param {number} endY Ending point in the ordinate.\n * @return {WebKeyframesDef} Keyframes that make up the animation.\n */\nexport function translate2d(startX, startY, endX, endY) {\n  return [\n    {transform: translate(startX, startY)},\n    {transform: translate(endX, endY)},\n  ];\n}\n\n/**\n * Translates and rotates the element on the 2d plane.\n * @param {number} startX Starting point in the abscissa.\n * @param {number} startY Starting point in the ordinate.\n * @param {number} endX Ending point in the abscissa.\n * @param {number} endY Ending point in the ordinate.\n * @param {number} direction -1 for left, 1 for right\n * @return {WebKeyframesDef} Keyframes that make up the animation.\n */\nexport function rotateAndTranslate(startX, startY, endX, endY, direction) {\n  return [\n    {transform: translate(startX, startY) + ' ' + rotate(direction * 120)},\n    {transform: translate(endX, endY) + ' ' + rotate(0)},\n  ];\n}\n\n/**\n * Gradually shows and grows the element while translating it on the 2d plane.\n * @param {number} startX Starting point in the abscissa.\n * @param {number} startY Starting point in the ordinate.\n * @param {number} endX Ending point in the abscissa.\n * @param {number} endY Ending point in the ordinate.\n * @return {WebKeyframesDef} Keyframes that make up the animation.\n */\nexport function whooshIn(startX, startY, endX, endY) {\n  return [\n    {\n      opacity: 0,\n      transform: translate(startX, startY) + ' ' + scale(0.15),\n    },\n    {\n      opacity: 1,\n      transform: translate(endX, endY) + ' ' + scale(1),\n    },\n  ];\n}\n\n/**\n * Checks if either of the target's dimensions are smaller than or equal to\n * those of the page.\n * @param {StoryAnimationDimsDef} dimensions Dimensions of page and target.\n * @return {boolean}\n * @visibleForTesting\n */\nexport function targetFitsWithinPage(dimensions) {\n  return (\n    dimensions.targetWidth <= dimensions.pageWidth ||\n    dimensions.targetHeight <= dimensions.pageHeight\n  );\n}\n\n/**\n * Calculate target scaling factor so that it is at least 25% larger than the\n * page.\n * @param {StoryAnimationDimsDef} dimensions Dimensions of page and target.\n * @return {number}\n */\nexport function calculateTargetScalingFactor(dimensions) {\n  if (targetFitsWithinPage(dimensions)) {\n    const scalingFactor = 1.25;\n    const widthFactor =\n      dimensions.pageWidth > dimensions.targetWidth\n        ? dimensions.pageWidth / dimensions.targetWidth\n        : 1;\n    const heightFactor =\n      dimensions.pageHeight > dimensions.targetHeight\n        ? dimensions.pageHeight / dimensions.targetHeight\n        : 1;\n    return Math.max(widthFactor, heightFactor) * scalingFactor;\n  }\n  return 1;\n}\n\n/**\n * Scale the image in every frame by a certain factor.\n * @param {WebKeyframesDef} keyframes Keyframes that will be used for the animation.\n * @param {number} scalingFactor Scaling factor at which target will be scaled.\n * @return {WebKeyframesDef}\n */\nfunction enlargeKeyFrames(keyframes, scalingFactor) {\n  /** @type {!Array} */ (keyframes).forEach((frame) => {\n    frame['transform'] += ' ' + scale(scalingFactor);\n    frame['transform-origin'] = 'left top';\n  });\n  return keyframes;\n}\n\n/**\n * Translates the element and scales it if necessary.\n * @param {number} startX Starting point in the abscissa.\n * @param {number} startY Starting point in the ordinate.\n * @param {number} endX Ending point in the abscissa.\n * @param {number} endY Ending point in the ordinate.\n * @param {number} scalingFactor Factor by which target will be scaled.\n * @return {WebKeyframesDef} Keyframes that make up the animation.\n */\nexport function scaleAndTranslate(startX, startY, endX, endY, scalingFactor) {\n  if (scalingFactor === 1) {\n    return translate2d(startX, startY, endX, endY);\n  }\n  return enlargeKeyFrames(\n    translate2d(startX, startY, endX, endY),\n    scalingFactor\n  );\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {GRID_LAYER_TEMPLATE_CLASS_NAMES} from './amp-story-grid-layer';\nimport {StoryAnimationPresetDef} from './animation-types';\nimport {\n  calculateTargetScalingFactor,\n  rotateAndTranslate,\n  scaleAndTranslate,\n  translate2d,\n  whooshIn,\n} from './animation-presets-utils';\nimport {px} from '../../../src/style';\nimport {userAssert} from '../../../src/log';\n\n/** @const {string} */\nconst FULL_BLEED_CATEGORY = 'full-bleed';\n/** @const {string} */\nconst FILL_TEMPLATE_LAYOUT = 'fill';\n/** @const {number} */\nconst SCALE_HIGH_DEFAULT = 3;\n/** @const {number} */\nconst SCALE_LOW_DEFAULT = 1;\n\n/** @const {string} */\nconst SCALE_START_ATTRIBUTE_NAME = 'scale-start';\n/** @const {string} */\nconst SCALE_END_ATTRIBUTE_NAME = 'scale-end';\n/** @const {string} */\nconst TRANSLATE_X_ATTRIBUTE_NAME = 'translate-x';\n/** @const {string} */\nconst TRANSLATE_Y_ATTRIBUTE_NAME = 'translate-y';\n/** @const {string} */\nconst DEFAULT_CURVE = '0.4, 0.4, 0.0, 1';\n\n/** @const {!Array<string>} */\nexport const PRESET_OPTION_ATTRIBUTES = [\n  SCALE_START_ATTRIBUTE_NAME,\n  SCALE_END_ATTRIBUTE_NAME,\n  TRANSLATE_X_ATTRIBUTE_NAME,\n  TRANSLATE_Y_ATTRIBUTE_NAME,\n];\n\n/**\n * A list of animations that are full bleed.\n * @private @const {!Array<string>}\n */\nconst FULL_BLEED_ANIMATION_NAMES = [\n  'pan-up',\n  'pan-down',\n  'pan-right',\n  'pan-left',\n  'zoom-in',\n  'zoom-out',\n];\n\n/**\n * A mapping of animation categories to corresponding CSS class names.\n * @private @const {!Object<string, string>}\n */\nconst ANIMATION_CSS_CLASS_NAMES = {\n  [FULL_BLEED_CATEGORY]:\n    'i-amphtml-story-grid-template-with-full-bleed-animation',\n};\n\n/**\n * Perform style-specific operations for presets.\n * @param {!Element} el\n * @param {string} presetName\n */\nexport function setStyleForPreset(el, presetName) {\n  // For full bleed animations.\n  if (FULL_BLEED_ANIMATION_NAMES.indexOf(presetName) >= 0) {\n    const parent = el.parentElement;\n    if (\n      parent.classList.contains(\n        GRID_LAYER_TEMPLATE_CLASS_NAMES[FILL_TEMPLATE_LAYOUT]\n      )\n    ) {\n      parent.classList.remove(\n        GRID_LAYER_TEMPLATE_CLASS_NAMES[FILL_TEMPLATE_LAYOUT]\n      );\n    }\n    parent.classList.add(ANIMATION_CSS_CLASS_NAMES[FULL_BLEED_CATEGORY]);\n  }\n}\n\n/**\n * First keyframe will always be considered offset: 0 and will be applied to the\n * element as the first frame before animation starts.\n * @type {!Object<string, !StoryAnimationPresetDef>}\n */\nexport const presets = {\n  'pulse': {\n    duration: 600,\n    easing: 'cubic-bezier(0.3, 0.0, 0.0, 1)',\n    keyframes: [\n      {\n        offset: 0,\n        transform: 'scale(1)',\n      },\n      {\n        offset: 0.25,\n        transform: 'scale(0.95)',\n      },\n      {\n        offset: 0.75,\n        transform: 'scale(1.05)',\n      },\n      {\n        offset: 1,\n        transform: 'scale(1)',\n      },\n    ],\n  },\n  'fly-in-left': {\n    duration: 600,\n    easing: `cubic-bezier(0.2, 0.6, 0.0, 1)`,\n    keyframes(dimensions) {\n      const offsetX = -(dimensions.targetX + dimensions.targetWidth);\n      return translate2d(offsetX, 0, 0, 0);\n    },\n  },\n  'fly-in-right': {\n    duration: 600,\n    easing: `cubic-bezier(0.2, 0.6, 0.0, 1)`,\n    keyframes(dimensions) {\n      const offsetX = dimensions.pageWidth - dimensions.targetX;\n      return translate2d(offsetX, 0, 0, 0);\n    },\n  },\n  'fly-in-top': {\n    duration: 600,\n    easing: `cubic-bezier(0.2, 0.6, 0.0, 1)`,\n    keyframes(dimensions) {\n      const offsetY = -(dimensions.targetY + dimensions.targetHeight);\n      return translate2d(0, offsetY, 0, 0);\n    },\n  },\n  'fly-in-bottom': {\n    duration: 600,\n    easing: `cubic-bezier(0.2, 0.6, 0.0, 1)`,\n    keyframes(dimensions) {\n      const offsetY = dimensions.pageHeight - dimensions.targetY;\n      return translate2d(0, offsetY, 0, 0);\n    },\n  },\n  'rotate-in-left': {\n    duration: 1000,\n    easing: `cubic-bezier(${DEFAULT_CURVE})`,\n    keyframes(dimensions) {\n      const offsetX = -(dimensions.targetX + dimensions.targetWidth);\n      return rotateAndTranslate(offsetX, 0, 0, 0, -1);\n    },\n  },\n  'rotate-in-right': {\n    duration: 1000,\n    easing: `cubic-bezier(${DEFAULT_CURVE})`,\n    keyframes(dimensions) {\n      const offsetX = dimensions.pageWidth - dimensions.targetX;\n      return rotateAndTranslate(offsetX, 0, 0, 0, 1);\n    },\n  },\n  'fade-in': {\n    duration: 600,\n    easing: `cubic-bezier(${DEFAULT_CURVE})`,\n    keyframes: [\n      {\n        opacity: 0,\n      },\n      {\n        opacity: 1,\n      },\n    ],\n  },\n  'scale-fade-up': {\n    duration: 600,\n    easing: `cubic-bezier(${DEFAULT_CURVE})`,\n    keyframes: [\n      {\n        opacity: 0,\n        transform: 'scale(0.8)',\n      },\n      {\n        opacity: 1,\n        transform: 'scale(1)',\n      },\n    ],\n  },\n  'scale-fade-down': {\n    duration: 600,\n    easing: `cubic-bezier(${DEFAULT_CURVE})`,\n    keyframes: [\n      {\n        opacity: 0,\n        transform: 'scale(1.4)',\n      },\n      {\n        opacity: 1,\n        transform: 'scale(1)',\n      },\n    ],\n  },\n  'drop': {\n    duration: 1600,\n    easing: `linear`,\n    keyframes(dimensions) {\n      const maxBounceHeight = Math.max(\n        160,\n        dimensions.targetY + dimensions.targetHeight\n      );\n      return [\n        {\n          offset: 0.0,\n          transform: `translateY(${px(Number(-maxBounceHeight))})`,\n          easing: 'cubic-bezier(.5, 0, 1, 1)',\n        },\n        {\n          offset: 0.29,\n          transform: `translateY(0)`,\n          easing: 'cubic-bezier(0, 0, .5, 1)',\n        },\n        {\n          offset: 0.45,\n          transform: `translateY(${px(-maxBounceHeight * 0.2812)})`,\n          easing: 'cubic-bezier(.5, 0, 1, 1)',\n        },\n        {\n          offset: 0.61,\n          transform: `translateY(0)`,\n          easing: 'cubic-bezier(0, 0, .5, 1)',\n        },\n        {\n          offset: 0.71,\n          transform: `translateY(${px(-maxBounceHeight * 0.0956)})`,\n          easing: 'cubic-bezier(.5, 0, 1, 1)',\n        },\n        {\n          offset: 0.8,\n          transform: `translateY(0)`,\n          easing: 'cubic-bezier(0, 0, .5, 1)',\n        },\n        {\n          offset: 0.85,\n          transform: `translateY(${px(-maxBounceHeight * 0.0359)})`,\n          easing: 'cubic-bezier(.5, 0, 1, 1)',\n        },\n        {\n          offset: 0.92,\n          transform: `translateY(0)`,\n          easing: 'cubic-bezier(0, 0, .5, 1)',\n        },\n        {\n          offset: 0.96,\n          transform: `translateY(${px(-maxBounceHeight * 0.0156)})`,\n          easing: 'cubic-bezier(.5, 0, 1, 1)',\n        },\n        {\n          offset: 1,\n          transform: `translateY(0)`,\n          easing: 'cubic-bezier(0, 0, .5, 1)',\n        },\n      ];\n    },\n  },\n  'twirl-in': {\n    duration: 1000,\n    easing: `cubic-bezier(${DEFAULT_CURVE})`,\n    keyframes: [\n      {\n        transform: 'rotate(-540deg) scale(0.1)',\n        opacity: 0,\n      },\n      {\n        transform: 'none',\n        opacity: 1,\n      },\n    ],\n  },\n  'whoosh-in-left': {\n    duration: 600,\n    easing: `cubic-bezier(${DEFAULT_CURVE})`,\n    keyframes(dimensions) {\n      const offsetX = -(dimensions.targetX + dimensions.targetWidth);\n      return whooshIn(offsetX, 0, 0, 0);\n    },\n  },\n  'whoosh-in-right': {\n    duration: 600,\n    easing: `cubic-bezier(${DEFAULT_CURVE})`,\n    keyframes(dimensions) {\n      const offsetX = dimensions.pageWidth - dimensions.targetX;\n      return whooshIn(offsetX, 0, 0, 0);\n    },\n  },\n  'pan-left': {\n    duration: 1000,\n    easing: 'linear',\n    keyframes(dimensions, options) {\n      const translateX = options[TRANSLATE_X_ATTRIBUTE_NAME];\n      const scalingFactor = calculateTargetScalingFactor(dimensions);\n      dimensions.targetWidth *= scalingFactor;\n      dimensions.targetHeight *= scalingFactor;\n\n      const offsetX = dimensions.pageWidth - dimensions.targetWidth;\n      const offsetY = (dimensions.pageHeight - dimensions.targetHeight) / 2;\n\n      return scaleAndTranslate(\n        offsetX,\n        offsetY,\n        translateX ? offsetX + translateX : 0,\n        offsetY,\n        scalingFactor\n      );\n    },\n  },\n  'pan-right': {\n    duration: 1000,\n    easing: 'linear',\n    keyframes(dimensions, options) {\n      const translateX = options[TRANSLATE_X_ATTRIBUTE_NAME];\n\n      const scalingFactor = calculateTargetScalingFactor(dimensions);\n      dimensions.targetWidth *= scalingFactor;\n      dimensions.targetHeight *= scalingFactor;\n\n      const offsetX = dimensions.pageWidth - dimensions.targetWidth;\n      const offsetY = (dimensions.pageHeight - dimensions.targetHeight) / 2;\n\n      return scaleAndTranslate(\n        0,\n        offsetY,\n        -translateX || offsetX,\n        offsetY,\n        scalingFactor\n      );\n    },\n  },\n  'pan-down': {\n    duration: 1000,\n    easing: 'linear',\n    keyframes(dimensions, options) {\n      const translateY = options[TRANSLATE_Y_ATTRIBUTE_NAME];\n      const scalingFactor = calculateTargetScalingFactor(dimensions);\n      dimensions.targetWidth *= scalingFactor;\n      dimensions.targetHeight *= scalingFactor;\n\n      const offsetX = -dimensions.targetWidth / 2;\n      const offsetY = dimensions.pageHeight - dimensions.targetHeight;\n\n      return scaleAndTranslate(\n        offsetX,\n        0,\n        offsetX,\n        -translateY || offsetY,\n        scalingFactor\n      );\n    },\n  },\n  'pan-up': {\n    duration: 1000,\n    easing: 'linear',\n    keyframes(dimensions, options) {\n      const translateY = options[TRANSLATE_Y_ATTRIBUTE_NAME];\n      const scalingFactor = calculateTargetScalingFactor(dimensions);\n      dimensions.targetWidth *= scalingFactor;\n      dimensions.targetHeight *= scalingFactor;\n\n      const offsetX = -dimensions.targetWidth / 2;\n      const offsetY = dimensions.pageHeight - dimensions.targetHeight;\n\n      return scaleAndTranslate(\n        offsetX,\n        offsetY,\n        offsetX,\n        translateY ? offsetY + translateY : 0,\n        scalingFactor\n      );\n    },\n  },\n  'zoom-in': {\n    duration: 1000,\n    easing: 'linear',\n    keyframes(unusedDimensions, options) {\n      const scaleStart = options[SCALE_START_ATTRIBUTE_NAME];\n      const scaleEnd = options[SCALE_END_ATTRIBUTE_NAME];\n\n      if (scaleStart) {\n        userAssert(\n          scaleEnd > scaleStart,\n          '\"scale-end\" value must be greater ' +\n            'than \"scale-start\" value when using \"zoom-in\" animation.'\n        );\n      }\n\n      return [\n        {transform: `scale(${scaleStart || SCALE_LOW_DEFAULT})`},\n        {transform: `scale(${scaleEnd || SCALE_HIGH_DEFAULT})`},\n      ];\n    },\n  },\n  'zoom-out': {\n    duration: 1000,\n    easing: 'linear',\n    keyframes(unusedDimensions, options) {\n      const scaleStart = options[SCALE_START_ATTRIBUTE_NAME];\n      const scaleEnd = options[SCALE_END_ATTRIBUTE_NAME];\n\n      if (scaleStart) {\n        userAssert(\n          scaleStart > scaleEnd,\n          '\"scale-start\" value must be ' +\n            'higher than \"scale-end\" value when using \"zoom-out\" animation.'\n        );\n      }\n\n      return [\n        {transform: `scale(${scaleStart || SCALE_HIGH_DEFAULT})`},\n        {transform: `scale(${scaleEnd || SCALE_LOW_DEFAULT})`},\n      ];\n    },\n  },\n};\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {childElementsByTag} from './core/dom/query';\nimport {isJsonScriptTag} from './dom';\nimport {parseJson} from './core/types/object/json';\n\n/**\n * Helper method to get the json config from an element <script> tag\n * @param {!Element} element\n * @return {?JsonObject}\n * @throws {!Error} If element does not have exactly one <script> child\n * with type=\"application/json\", or if the <script> contents are not valid JSON.\n */\nexport function getChildJsonConfig(element) {\n  const scripts = childElementsByTag(element, 'script');\n  const n = scripts.length;\n  if (n !== 1) {\n    throw new Error(`Found ${scripts.length} <script> children. Expected 1.`);\n  }\n  const script = scripts[0];\n  if (!isJsonScriptTag(script)) {\n    throw new Error('<script> child must have type=\"application/json\"');\n  }\n  try {\n    return parseJson(script.textContent);\n  } catch (unusedError) {\n    throw new Error('Failed to parse <script> contents. Is it valid JSON?');\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../../../src/core/data-structures/promise';\nimport {\n  PRESET_OPTION_ATTRIBUTES,\n  presets,\n  setStyleForPreset,\n} from './animation-presets';\nimport {Services} from '../../../src/services';\nimport {\n  StoryAnimationConfigDef,\n  StoryAnimationDimsDef,\n  StoryAnimationPresetDef,\n  WebAnimationDef,\n  WebAnimationPlayState,\n  WebAnimationSelectorDef,\n  WebAnimationTimingDef,\n  WebKeyframesCreateFnDef,\n  WebKeyframesDef,\n} from './animation-types';\nimport {assertDoesNotContainDisplay, setStyles} from '../../../src/style';\nimport {dev, devAssert, user, userAssert} from '../../../src/log';\nimport {escapeCssSelectorIdent} from '../../../src/core/dom/css-selectors';\nimport {getChildJsonConfig} from '../../../src/json';\nimport {map, omit} from '../../../src/core/types/object';\nimport {\n  scopedQuerySelector,\n  scopedQuerySelectorAll,\n} from '../../../src/core/dom/query';\nimport {timeStrToMillis, unscaledClientRect} from './utils';\n\nconst TAG = 'AMP-STORY';\n\n/** @const {string} */\nexport const ANIMATE_IN_ATTRIBUTE_NAME = 'animate-in';\n/** @const {string} */\nconst ANIMATE_IN_DURATION_ATTRIBUTE_NAME = 'animate-in-duration';\n/** @const {string} */\nconst ANIMATE_IN_DELAY_ATTRIBUTE_NAME = 'animate-in-delay';\n/** @const {string} */\nconst ANIMATE_IN_AFTER_ATTRIBUTE_NAME = 'animate-in-after';\n/** @const {string} */\nconst ANIMATE_IN_TIMING_FUNCTION_ATTRIBUTE_NAME = 'animate-in-timing-function';\n/** @const {string} */\nconst ANIMATABLE_ELEMENTS_SELECTOR = `[${ANIMATE_IN_ATTRIBUTE_NAME}]`;\n\n/** @const {string} */\nconst DEFAULT_EASING = 'cubic-bezier(0.4, 0.0, 0.2, 1)';\n\n/**\n * @param {!Element} element\n * @return {boolean}\n * TODO(alanorozco): maybe memoize?\n */\nexport function hasAnimations(element) {\n  const selector = `${ANIMATABLE_ELEMENTS_SELECTOR},>amp-story-animation`;\n  return !!scopedQuerySelector(element, selector);\n}\n\n/** @enum {number} */\nconst PlaybackActivity = {\n  START: 0,\n  FINISH: 1,\n};\n\n/**\n * @param {!Element} root\n * @param {!Element} element\n * @return {?string}\n */\nfunction getSequencingStartAfterId(root, element) {\n  if (!element.hasAttribute(ANIMATE_IN_AFTER_ATTRIBUTE_NAME)) {\n    return null;\n  }\n  const dependencyId = element.getAttribute(ANIMATE_IN_AFTER_ATTRIBUTE_NAME);\n\n  if (!root.querySelector(`#${escapeCssSelectorIdent(dependencyId)}`)) {\n    user().warn(\n      TAG,\n      `The attribute '${ANIMATE_IN_AFTER_ATTRIBUTE_NAME}' in tag ` +\n        `'${element.tagName}' is set to the invalid value ` +\n        `'${dependencyId}'. No children of parenting 'amp-story-page' ` +\n        `exist with id ${dependencyId}.`\n    );\n    return null;\n  }\n\n  return dependencyId;\n}\n\n/** Wraps WebAnimationRunner for story page elements. */\nexport class AnimationRunner {\n  /**\n   * @param {!Element} page\n   * @param {!StoryAnimationConfigDef} config\n   * @param {!Promise<!../../amp-animation/0.1/web-animations.Builder>} webAnimationBuilderPromise\n   * @param {!../../../src/service/vsync-impl.Vsync} vsync\n   * @param {!AnimationSequence} sequence\n   */\n  constructor(page, config, webAnimationBuilderPromise, vsync, sequence) {\n    const {preset, source, spec, startAfterId} = config;\n\n    /** @private @const */\n    this.page_ = page;\n\n    /** @private @const */\n    this.source_ = source;\n\n    /** @private @const */\n    this.vsync_ = vsync;\n\n    /** @private @const {?Element} */\n    this.presetTarget_ = !!preset ? dev().assertElement(spec.target) : null;\n\n    /** @private @const */\n    this.sequence_ = sequence;\n\n    /** @private @const {?string} */\n    this.startAfterId_ = startAfterId;\n\n    /** @private @const {!Promise<!WebAnimationDef>} */\n    this.resolvedSpecPromise_ = this.resolveSpec_(config);\n\n    /**\n     * @private @const {!Promise<\n     *    !../../amp-animation/0.1/runners/animation-runner.AnimationRunner>}\n     */\n    this.runnerPromise_ = this.resolvedSpecPromise_.then((webAnimDef) =>\n      webAnimationBuilderPromise.then((builder) =>\n        builder.createRunner(webAnimDef)\n      )\n    );\n\n    /**\n     * Evaluated set of CSS properties for first animation frame.\n     * @private @const {!Promise<?Object<string, *>>}\n     */\n    this.firstFrameProps_ = this.resolvedSpecPromise_.then((spec) => {\n      const {keyframes} = spec;\n      if (!this.presetTarget_) {\n        // It's only possible to backfill the first frame if we can define it\n        // as native CSS. <amp-animation> has CSS extensions and can have\n        // keyframes defined in a way that prevents us from doing this.\n        //\n        // To avoid visual jumps, this depends on the author properly\n        // defining their CSS so that the initial visual state matches the\n        // initial animation frame.\n        return null;\n      }\n      devAssert(\n        !keyframes[0].offset,\n        'First keyframe offset for animation preset should be 0 or undefined'\n      );\n      return omit(keyframes[0], ['offset']);\n    });\n\n    /** @private {?../../amp-animation/0.1/runners/animation-runner.AnimationRunner} */\n    this.runner_ = null;\n\n    /** @private {?PlaybackActivity} */\n    this.scheduledActivity_ = null;\n\n    /** @private {?Promise} */\n    this.scheduledWait_ = null;\n\n    if (this.presetTarget_) {\n      const {delay} = /** @type {!WebAnimationTimingDef} */ (spec);\n      userAssert(\n        dev().assertNumber(delay) >= 0,\n        'Negative delays are not allowed in amp-story \"animate-in\" animations.'\n      );\n    }\n\n    this.runnerPromise_.then((runner) => this.onRunnerReady_(runner));\n  }\n\n  /**\n   * @param {!Element} page\n   * @param {!StoryAnimationConfigDef} config\n   * @param {!Promise<!../../amp-animation/0.1/web-animations.Builder>} webAnimationBuilderPromise\n   * @param {!../../../src/service/vsync-impl.Vsync} vsync\n   * @param {!AnimationSequence} sequence\n   * @return {!AnimationRunner}\n   */\n  static create(page, config, webAnimationBuilderPromise, vsync, sequence) {\n    return new AnimationRunner(\n      page,\n      config,\n      webAnimationBuilderPromise,\n      vsync,\n      sequence\n    );\n  }\n\n  /**\n   * @return {!Promise<!StoryAnimationDimsDef>}\n   * @visibleForTesting\n   */\n  getDims() {\n    return this.vsync_.measurePromise(() => {\n      const target = dev().assertElement(this.presetTarget_);\n      const targetRect = unscaledClientRect(target);\n      const pageRect = unscaledClientRect(this.page_);\n\n      // TODO(alanorozco, https://go.amp.dev/issue/27758):\n      // Expose equivalents to <amp-animation>\n      // - targetWidth/targetHeight are already available as width()/height()\n      // - pageWidth/pageHeight should be exposed as vw/vh\n      // - targetX/targetY should be exposed somehow (?)\n      //\n      // TODO(alanorozco, https://go.amp.dev/issue/27758):\n      // After exposing these to <amp-animation> syntax, we\n      // can get rid of this entire method (and this async chain!) if we ensure\n      // that presets avoid visual jumps either via:\n      // a) default styles and/or\n      // b) by not using special <amp-animation> syntax in initial keyframe.\n      return /** @type {!StoryAnimationDimsDef} */ ({\n        pageWidth: pageRect.width,\n        pageHeight: pageRect.height,\n        targetWidth: targetRect.width,\n        targetHeight: targetRect.height,\n        targetX: targetRect.left - pageRect.left,\n        targetY: targetRect.top - pageRect.top,\n      });\n    });\n  }\n\n  /**\n   * Evaluates a preset's keyframes function using dimensions.\n   * @param {!WebKeyframesDef|!WebKeyframesCreateFnDef} keyframesOrCreateFn\n   * @param {!Object<string, *>=} keyframeOptions\n   * @return {!Promise<!WebKeyframesDef>}\n   * @private\n   */\n  resolvePresetKeyframes_(keyframesOrCreateFn, keyframeOptions) {\n    if (typeof keyframesOrCreateFn === 'function') {\n      return this.getDims().then((dimensions) => {\n        const fn = /** @type {!WebKeyframesCreateFnDef} */ (\n          keyframesOrCreateFn\n        );\n        return fn(dimensions, keyframeOptions || {});\n      });\n    }\n    return Promise.resolve(keyframesOrCreateFn);\n  }\n\n  /**\n   * Resolves an animation spec that may be incomplete, like from an\n   * [animate-in] preset.\n   * @param {!StoryAnimationConfigDef} config\n   * @return {!Promise<!WebAnimationDef>}\n   */\n  resolveSpec_(config) {\n    const {keyframeOptions, preset, spec} = config;\n    if (!preset) {\n      // This is an amp-animation config, so it's already formed how the\n      // WebAnimations Builder wants it.\n      return Promise.resolve(/** @type {!WebAnimationDef} */ (spec));\n    }\n    // The need for this cast is an unfortunate result of using @mixes in\n    // WebAnimationDef. Otherwise Closure will not understand the timing props\n    // mixed in from another type.\n    const {delay, duration, easing} = /** @type {!WebAnimationTimingDef} */ (\n      spec\n    );\n    const {target} = /** @type {!WebAnimationSelectorDef} */ (spec);\n    return this.resolvePresetKeyframes_(preset.keyframes, keyframeOptions).then(\n      (keyframes) => ({\n        keyframes,\n        target,\n        delay,\n        duration,\n        easing,\n        fill: 'forwards',\n      })\n    );\n  }\n\n  /**\n   * Applies the first animation frame as CSS props. This is similar to filling\n   * the animation backwards, except:\n   * - it evaluates before amp-animation is ready to prevent a race and cause\n   *   a visual jump before being able to fill the first frame\n   * - it allows for sequencing before an animation has started, like with\n   *   `animate-in-after`.\n   * @return {!Promise<void>}\n   */\n  applyFirstFrame() {\n    if (this.hasStarted()) {\n      return Promise.resolve();\n    }\n\n    if (this.runner_) {\n      this.runner_.cancel();\n    }\n\n    return this.firstFrameProps_.then((firstFrameProps) => {\n      if (!firstFrameProps) {\n        // These are only available when they can be evaluated:\n        // - delay is not negative\n        // - first frame is defined in plain CSS, so it does not use special\n        //   <amp-animation> CSS syntax/extensions.\n        //\n        // We can't guarantee any of these properties when using\n        // <amp-story-animation> effects, but we can do it for our own presets.\n        return;\n      }\n      return this.vsync_.mutatePromise(() => {\n        setStyles(\n          dev().assertElement(this.presetTarget_),\n          assertDoesNotContainDisplay(devAssert(firstFrameProps))\n        );\n      });\n    });\n  }\n\n  /** Starts or resumes the animation. */\n  start() {\n    if (this.hasStarted()) {\n      return;\n    }\n\n    this.playback_(PlaybackActivity.START, this.getStartWaitPromise_());\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  getStartWaitPromise_() {\n    if (this.startAfterId_) {\n      return this.sequence_.waitFor(this.startAfterId_);\n    }\n    return Promise.resolve();\n  }\n\n  /**\n   * @param {!../../amp-animation/0.1/runners/animation-runner.AnimationRunner} runner\n   * @private\n   */\n  startWhenReady_(runner) {\n    runner.start();\n  }\n\n  /** @return {boolean} */\n  hasStarted() {\n    return (\n      this.isActivityScheduled_(PlaybackActivity.START) ||\n      (!!this.runner_ &&\n        devAssert(this.runner_).getPlayState() == WebAnimationPlayState.RUNNING)\n    );\n  }\n\n  /** Force-finishes all animations. */\n  finish() {\n    if (!this.runner_) {\n      this.notifyFinish_();\n    }\n    this.playback_(PlaybackActivity.FINISH);\n  }\n\n  /** Pauses the animation. */\n  pause() {\n    // Animation hasn't started yet since it's waiting for a sequenced\n    // animation.\n    if (this.scheduledWait_ !== null) {\n      return;\n    }\n\n    if (this.runner_) {\n      try {\n        this.runner_.pause();\n      } catch (e) {\n        // This fails when the animation is finished explicitly\n        // (runner.finish()) since this destroys internal players. This is fine.\n      }\n    }\n  }\n\n  /** Resumes the animation. */\n  resume() {\n    // Animation hasn't started yet since it's waiting for a sequenced\n    // animation.\n    if (this.scheduledWait_ !== null) {\n      return;\n    }\n\n    if (this.runner_) {\n      devAssert(this.runner_).resume();\n    }\n  }\n\n  /**\n   * @param {!../../amp-animation/0.1/runners/animation-runner.AnimationRunner} runner\n   * @private\n   */\n  finishWhenReady_(runner) {\n    if (this.runner_) {\n      // Init or no-op if the runner was already running.\n      runner.start();\n      runner.finish();\n    }\n  }\n\n  /** Cancels animation. */\n  cancel() {\n    this.scheduledActivity_ = null;\n    this.scheduledWait_ = null;\n\n    if (this.runner_) {\n      devAssert(this.runner_).cancel();\n    }\n  }\n\n  /**\n   * @param {!PlaybackActivity} activity\n   * @param {!Promise=} opt_wait\n   * @private\n   */\n  playback_(activity, opt_wait) {\n    const wait = opt_wait || null;\n\n    this.scheduledActivity_ = activity;\n    this.scheduledWait_ = wait;\n\n    if (this.runner_) {\n      this.playbackWhenReady_(activity, wait);\n    }\n  }\n\n  /**\n   * Executes playback activity if runner is ready.\n   * @param {!PlaybackActivity} activity\n   * @param {?Promise} wait\n   * @private\n   */\n  playbackWhenReady_(activity, wait) {\n    const runner =\n      /**\n       * @type {!../../amp-animation/0.1/runners/animation-runner.AnimationRunner}\n       */\n      (\n        devAssert(\n          this.runner_,\n          'Tried to execute playbackWhenReady_ before runner was resolved.'\n        )\n      );\n\n    (wait || Promise.resolve()).then(() => {\n      if (!this.isActivityScheduled_(activity)) {\n        return;\n      }\n\n      this.scheduledActivity_ = null;\n      this.scheduledWait_ = null;\n\n      switch (activity) {\n        case PlaybackActivity.START:\n          return this.startWhenReady_(runner);\n        case PlaybackActivity.FINISH:\n          return this.finishWhenReady_(runner);\n      }\n    });\n  }\n\n  /**\n   * Marks runner as ready and executes playback activity if needed.\n   * @param {!../../amp-animation/0.1/runners/animation-runner.AnimationRunner} runner\n   * @private\n   */\n  onRunnerReady_(runner) {\n    this.runner_ = runner;\n\n    runner.onPlayStateChanged((state) => {\n      if (state == WebAnimationPlayState.FINISHED) {\n        this.notifyFinish_();\n      }\n    });\n\n    if (!this.isActivityScheduled_()) {\n      return;\n    }\n\n    this.playbackWhenReady_(\n      /** @type {!PlaybackActivity} */ (this.scheduledActivity_),\n      this.scheduledWait_\n    );\n  }\n\n  /**\n   * @param {!PlaybackActivity=} opt_activity\n   * @return {boolean}\n   * @private\n   */\n  isActivityScheduled_(opt_activity) {\n    if (!opt_activity) {\n      return this.scheduledActivity_ !== null;\n    }\n    return this.scheduledActivity_ === opt_activity;\n  }\n\n  /** @private */\n  notifyFinish_() {\n    if (this.source_.id) {\n      this.sequence_.notifyFinish(this.source_.id);\n    }\n  }\n}\n\n// TODO(alanorozco): Looping animations\n/** Manager for animations in story pages. */\nexport class AnimationManager {\n  /**\n   * @param {!Element} page\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(page, ampdoc) {\n    /** @private @const */\n    this.page_ = page;\n\n    /** @private @const */\n    this.ampdoc_ = ampdoc;\n\n    /** @private @const */\n    this.vsync_ = Services.vsyncFor(this.ampdoc_.win);\n\n    /** @private @const */\n    this.builderPromise_ = this.createAnimationBuilderPromise_();\n\n    /** @private {?Array<!AnimationRunner>} */\n    this.runners_ = null;\n\n    /** @private */\n    this.sequence_ = AnimationSequence.create();\n  }\n\n  /**\n   * Decouples constructor so it can be stubbed in tests.\n   * @param {!Element} page\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} unusedBaseUrl\n   * @return {!AnimationManager}\n   */\n  static create(page, ampdoc, unusedBaseUrl) {\n    return new AnimationManager(page, ampdoc);\n  }\n\n  /**\n   * Applies first frame to target element before starting animation.\n   * @return {!Promise}\n   */\n  applyFirstFrame() {\n    return Promise.all(\n      this.getOrCreateRunners_().map((runner) => runner.applyFirstFrame())\n    );\n  }\n\n  /** Starts all entrance animations for the page. */\n  animateIn() {\n    this.getRunners_().forEach((runner) => runner.start());\n  }\n\n  /** Skips all entrance animations for the page. */\n  finishAll() {\n    this.getRunners_().forEach((runner) => runner.finish());\n  }\n\n  /** Cancels all entrance animations for the page. */\n  cancelAll() {\n    if (!this.runners_) {\n      // nothing to cancel when the first frame has not been applied yet.\n      return;\n    }\n    this.getRunners_().forEach((runner) => runner.cancel());\n  }\n\n  /** Pauses all animations in the page. */\n  pauseAll() {\n    if (!this.runners_) {\n      return;\n    }\n    this.getRunners_().forEach((runner) => runner.pause());\n  }\n\n  /** Resumes all animations in the page. */\n  resumeAll() {\n    if (!this.runners_) {\n      return;\n    }\n    this.getRunners_().forEach((runner) => runner.resume());\n  }\n\n  /**\n   * Determines if there is an animation running.\n   * @return {boolean}\n   */\n  hasAnimationStarted() {\n    return this.getRunners_().some((runner) => runner.hasStarted());\n  }\n\n  /**\n   * @return {!Array<!AnimationRunner>}\n   * @private\n   */\n  getRunners_() {\n    return devAssert(this.runners_, 'Executed before applyFirstFrame');\n  }\n\n  /**\n   * Gets or creates AnimationRunners.\n   * These are either from an <amp-story-animation> spec or resolved from\n   * presets via animate-in attributes.\n   * If a page element contains both kinds of definitions, they'll run\n   * concurrently.\n   * @return {!Array<!AnimationRunner>}\n   * @private\n   */\n  getOrCreateRunners_() {\n    if (!this.runners_) {\n      this.runners_ = Array.prototype.map\n        .call(\n          scopedQuerySelectorAll(this.page_, ANIMATABLE_ELEMENTS_SELECTOR),\n          (el) => {\n            const preset = this.getPreset_(el);\n            if (!preset) {\n              return null;\n            }\n            return this.createRunner_({\n              preset,\n              source: el,\n              startAfterId: getSequencingStartAfterId(this.page_, el),\n              keyframeOptions: this.getKeyframeOptions_(el),\n              spec: this.partialAnimationSpecFromPreset_(el, preset),\n            });\n          }\n        )\n        .concat(\n          Array.prototype.map.call(\n            this.page_.querySelectorAll(\n              'amp-story-animation[trigger=visibility]'\n            ),\n            (el) =>\n              this.createRunner_({\n                source: el,\n                startAfterId: getSequencingStartAfterId(this.page_, el),\n                // Casting since we're getting a JsonObject. This will be\n                // validated during preparation phase.\n                spec: /** @type {!WebAnimationDef} */ (getChildJsonConfig(el)),\n              })\n          )\n        )\n        .filter(Boolean);\n    }\n    return devAssert(this.runners_);\n  }\n\n  /**\n   * @param {!StoryAnimationConfigDef} config\n   * @return {!AnimationRunner}\n   */\n  createRunner_(config) {\n    return AnimationRunner.create(\n      this.page_,\n      config,\n      devAssert(this.builderPromise_),\n      this.vsync_,\n      this.sequence_\n    );\n  }\n\n  /**\n   * @param {!Element} el\n   * @param {!StoryAnimationPresetDef} preset\n   * @return {!WebAnimationDef}\n   * @private\n   */\n  partialAnimationSpecFromPreset_(el, preset) {\n    const animationDef = {\n      target: el,\n      delay: preset.delay || 0,\n      duration: preset.duration || 0,\n      easing: preset.easing || DEFAULT_EASING,\n\n      // This field is so that we type this as a WebAnimationDef, but it's\n      // replaced when passed to an AnimationRunner.\n      keyframes: [],\n    };\n\n    if (el.hasAttribute(ANIMATE_IN_DURATION_ATTRIBUTE_NAME)) {\n      animationDef.duration = timeStrToMillis(\n        el.getAttribute(ANIMATE_IN_DURATION_ATTRIBUTE_NAME),\n        animationDef.duration\n      );\n    }\n\n    if (el.hasAttribute(ANIMATE_IN_DELAY_ATTRIBUTE_NAME)) {\n      animationDef.delay = timeStrToMillis(\n        el.getAttribute(ANIMATE_IN_DELAY_ATTRIBUTE_NAME),\n        animationDef.delay\n      );\n    }\n\n    if (el.hasAttribute(ANIMATE_IN_TIMING_FUNCTION_ATTRIBUTE_NAME)) {\n      animationDef.easing = el.getAttribute(\n        ANIMATE_IN_TIMING_FUNCTION_ATTRIBUTE_NAME\n      );\n    }\n\n    return animationDef;\n  }\n\n  /**\n   * @return {!Promise<!../../amp-animation/0.1/web-animations.Builder>}\n   * @private\n   */\n  createAnimationBuilderPromise_() {\n    return Services.extensionsFor(this.ampdoc_.win)\n      .installExtensionForDoc(this.ampdoc_, 'amp-animation')\n      .then(() => Services.webAnimationServiceFor(this.page_))\n      .then((webAnimationService) =>\n        webAnimationService.createBuilder({\n          scope: this.page_,\n          scaleByScope: true,\n        })\n      );\n  }\n\n  /**\n   * @param {!Element} el\n   * @return {?StoryAnimationPresetDef}\n   */\n  getPreset_(el) {\n    const name = el.getAttribute(ANIMATE_IN_ATTRIBUTE_NAME);\n\n    if (!presets[name]) {\n      user().warn(\n        TAG,\n        'Invalid',\n        ANIMATE_IN_ATTRIBUTE_NAME,\n        'preset',\n        name,\n        'for element',\n        el\n      );\n      return null;\n    }\n\n    // TODO(alanorozco): This should be part of a mutate cycle.\n    setStyleForPreset(el, name);\n\n    return presets[name];\n  }\n\n  /**\n   * @param {!Element} el\n   * @return {!Object<string, *>}\n   * @private\n   */\n  getKeyframeOptions_(el) {\n    const options = {};\n\n    PRESET_OPTION_ATTRIBUTES.forEach((name) => {\n      if (!el.hasAttribute(name)) {\n        return;\n      }\n      const value = parseFloat(el.getAttribute(name));\n\n      if (isNaN(value) || value <= 0) {\n        user().warn(\n          TAG,\n          name,\n          'attribute must be a positive number. Found negative or zero in element',\n          el\n        );\n        return;\n      }\n\n      options[name] = value;\n    });\n\n    return options;\n  }\n}\n\n/** Bus for animation sequencing. */\nexport class AnimationSequence {\n  /**\n   * @public\n   */\n  constructor() {\n    /** @private @const {!Object<string, !Promise>} */\n    this.subscriptionPromises_ = map();\n\n    /** @private @const {!Object<string, !Function>} */\n    this.subscriptionResolvers_ = map();\n  }\n\n  /**\n   * Decouples constructor for testing.\n   *\n   * @return {!AnimationSequence}\n   */\n  static create() {\n    return new AnimationSequence();\n  }\n\n  /**\n   * Notifies dependent elements that animation has finished.\n   * @param {string} id\n   */\n  notifyFinish(id) {\n    if (id in this.subscriptionPromises_) {\n      devAssert(this.subscriptionResolvers_[id])();\n\n      delete this.subscriptionPromises_[id];\n    }\n  }\n\n  /**\n   * Waits for another element to finish animating.\n   * @param {string} id\n   * @return {!Promise<void>}\n   */\n  waitFor(id) {\n    if (!(id in this.subscriptionPromises_)) {\n      const deferred = new Deferred();\n      this.subscriptionPromises_[id] = deferred.promise;\n      this.subscriptionResolvers_[id] = deferred.resolve;\n    }\n    return this.subscriptionPromises_[id];\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {LocalizedStringId} from '../../../src/localized-strings'; // eslint-disable-line no-unused-vars\nimport {createElementWithAttributes} from '../../../src/dom';\nimport {devAssert} from '../../../src/log';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {hasOwn} from '../../../src/core/types/object';\nimport {isArray} from '../../../src/core/types';\n\n/**\n * @typedef {{\n *   tag: string,\n *   attrs: (!JsonObject|undefined),\n *   localizedStringId: (!LocalizedStringId|undefined),\n *   unlocalizedString: (string|undefined),\n *   localizedLabelId: (!LocalizedStringId|undefined),\n *   children: (!Array<!ElementDef>|undefined),\n * }}\n */\nexport let ElementDef;\n\n/**\n * @param {!Document} doc\n * @param {!ElementDef|!Array<!ElementDef>} elementsDef\n * @return {!Node}\n */\nexport function renderSimpleTemplate(doc, elementsDef) {\n  if (isArray(elementsDef)) {\n    return renderMulti(doc, /** @type {!Array<!ElementDef>} */ (elementsDef));\n  }\n  return renderSingle(doc, /** @type {!ElementDef} */ (elementsDef));\n}\n\n/**\n * @param {!Document} doc\n * @param {!ElementDef} elementDef\n * @return {!Element}\n */\nexport function renderAsElement(doc, elementDef) {\n  return renderSingle(doc, elementDef);\n}\n\n/**\n * @param {!Document} doc\n * @param {!Array<!ElementDef>} elementsDef\n * @return {!Node}\n */\nfunction renderMulti(doc, elementsDef) {\n  const fragment = doc.createDocumentFragment();\n  elementsDef.forEach((elementDef) =>\n    fragment.appendChild(renderSingle(doc, elementDef))\n  );\n  return fragment;\n}\n\n/**\n * @param {!Document} doc\n * @param {!ElementDef} elementDef\n * @return {!Element}\n */\nfunction renderSingle(doc, elementDef) {\n  const el = hasOwn(elementDef, 'attrs')\n    ? createElementWithAttributes(\n        doc,\n        elementDef.tag,\n        /** @type {!JsonObject} */ (elementDef.attrs)\n      )\n    : doc.createElement(elementDef.tag);\n\n  const hasLocalizedTextContent = hasOwn(elementDef, 'localizedStringId');\n  const hasLocalizedLabel = hasOwn(elementDef, 'localizedLabelId');\n  if (hasLocalizedTextContent || hasLocalizedLabel) {\n    const localizationService = getLocalizationService(devAssert(doc.body));\n    devAssert(localizationService, 'Could not retrieve LocalizationService.');\n\n    if (hasLocalizedTextContent) {\n      el.textContent = localizationService.getLocalizedString(\n        /** @type {!LocalizedStringId} */ (elementDef.localizedStringId)\n      );\n    }\n\n    if (hasLocalizedLabel) {\n      const labelString = localizationService.getLocalizedString(\n        /** @type {!LocalizedStringId} */ (elementDef.localizedLabelId)\n      );\n      if (labelString) {\n        el.setAttribute('aria-label', labelString);\n      }\n    }\n  }\n\n  if (hasOwn(elementDef, 'unlocalizedString')) {\n    el.textContent = elementDef.unlocalizedString;\n  }\n\n  if (hasOwn(elementDef, 'children')) {\n    el.appendChild(\n      renderMulti(doc, /** @type {!Array<!ElementDef>} */ (elementDef.children))\n    );\n  }\n\n  return el;\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {dev} from '../../../src/log';\nimport {dict} from './../../../src/core/types/object';\nimport {renderAsElement} from './simple-template';\n\n/** @const {string} */\nconst SPINNER_ACTIVE_ATTRIBUTE = 'active';\n\n/** @private @const {!./simple-template.ElementDef} */\nconst SPINNER = {\n  tag: 'div',\n  attrs: dict({\n    'class': 'i-amphtml-story-spinner',\n    'aria-hidden': 'true',\n    'aria-label': 'Loading video',\n  }),\n  children: [\n    {\n      tag: 'div',\n      attrs: dict({\n        'class': 'i-amphtml-story-spinner-container',\n      }),\n      children: [\n        {\n          tag: 'div',\n          attrs: dict({\n            'class': 'i-amphtml-story-spinner-layer',\n          }),\n          children: [\n            {\n              tag: 'div',\n              attrs: dict({\n                'class': 'i-amphtml-story-spinner-circle-clipper left',\n              }),\n            },\n            {\n              tag: 'div',\n              attrs: dict({\n                'class': 'i-amphtml-story-spinner-circle-clipper right',\n              }),\n            },\n          ],\n        },\n      ],\n    },\n  ],\n};\n\n/**\n * Loading spinner UI element.\n */\nexport class LoadingSpinner {\n  /**\n   * @param {!Document} doc\n   */\n  constructor(doc) {\n    /** @private @const {!Document} */\n    this.doc_ = doc;\n\n    /** @public {?Element} */\n    this.root_ = null;\n\n    /** @private {boolean} */\n    this.isActive_ = false;\n  }\n\n  /**\n   * @return {!Element}\n   */\n  build() {\n    if (this.root_) {\n      return this.root_;\n    }\n\n    this.root_ = renderAsElement(this.doc_, SPINNER);\n\n    return this.getRoot();\n  }\n\n  /** @return {!Element} */\n  getRoot() {\n    return dev().assertElement(this.root_);\n  }\n\n  /** @param {boolean} isActive */\n  toggle(isActive) {\n    if (isActive === this.isActive_) {\n      return;\n    }\n    if (isActive) {\n      this.root_.setAttribute(SPINNER_ACTIVE_ATTRIBUTE, '');\n      this.root_.setAttribute('aria-hidden', 'false');\n    } else {\n      this.root_.removeAttribute(SPINNER_ACTIVE_ATTRIBUTE);\n      this.root_.setAttribute('aria-hidden', 'true');\n    }\n    this.isActive_ = isActive;\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ampMediaElementFor} from './utils';\nimport {removeElement} from '../../../src/dom';\nimport {toArray} from '../../../src/core/types/array';\n\n/**\n * Class handling HTMLMediaElements sources.\n */\nexport class Sources {\n  /**\n   * @param {?string=} srcAttr The 'src' attribute of the media element.\n   * @param {!Array<!Element>=} srcEls Any child <source> tags of the\n   *     media element.\n   * @param {!Array<!Element>=} trackEls Any child <track> tags of the\n   *     media element.\n   */\n  constructor(srcAttr = null, srcEls = [], trackEls = []) {\n    /** @private @const {?string} */\n    this.srcAttr_ = srcAttr;\n\n    /** @private @const {!Array<!Element>} */\n    this.srcEls_ = srcEls;\n\n    /** @private @const {!Array<!Element>} */\n    this.trackEls_ = trackEls;\n  }\n\n  /**\n   * Applies track tags to a specified element. This is done in a separate\n   * method from the source tags, because we must wait for \"loadedmetadata\"\n   * video event before doing this.\n   * @param {!HTMLMediaElement} element The element to adopt the text tracks\n   *     represented by this object.\n   * @private\n   */\n  applyTracksToElement_(element) {\n    Array.prototype.forEach.call(this.trackEls_, (trackEl) => {\n      const track = document.createElement('track');\n      track.id = trackEl.id;\n      track.kind = trackEl.kind;\n      track.label = trackEl.label;\n      track.srclang = trackEl.srclang;\n      track.default = trackEl.default;\n      track.src = trackEl.src;\n      track.addEventListener('load', () => {\n        track.mode = 'showing';\n        element.textTracks[0].mode = 'showing';\n      });\n      element.appendChild(track);\n    });\n  }\n\n  /**\n   * Applies the src attribute and source tags to a specified element.\n   * @param {!Window} win\n   * @param {!HTMLMediaElement} element The element to adopt the sources\n   *     represented by this object.\n   */\n  applyToElement(win, element) {\n    Sources.removeFrom(win, element);\n\n    if (!this.srcAttr_) {\n      element.removeAttribute('src');\n    } else {\n      element.setAttribute('src', this.srcAttr_);\n    }\n\n    Array.prototype.forEach.call(this.srcEls_, (srcEl) =>\n      element.appendChild(srcEl)\n    );\n    if (element.changedSources) {\n      element.changedSources();\n    }\n\n    if (this.trackEls_.length > 0) {\n      // Wait for \"loadedmetadata\" before adding tracks.\n      // Firefox adds tracks, but does not toggle them on unless video metadata\n      // is loaded first.\n      if (element.readyState >= 1 /* HAVE_METADATA */) {\n        this.applyTracksToElement_(element);\n      } else {\n        const addTracksHandler = () => {\n          element.removeEventListener('loadedmetadata', addTracksHandler);\n          this.applyTracksToElement_(element);\n        };\n\n        element.addEventListener('loadedmetadata', addTracksHandler);\n      }\n    }\n  }\n\n  /**\n   * Removes and returns the sources from a specified element.\n   * @param {!Window} win\n   * @param {!Element} element The element whose sources should be removed and\n   *     returned.\n   * @return {!Sources} An object representing the sources of the specified\n   *     element.\n   */\n  static removeFrom(win, element) {\n    const elementToUse = ampMediaElementFor(element) || element;\n\n    let srcEl = null;\n    // If the src attribute is specified, create a source element from it as it\n    // prevents race conditions between amp-story and amp-video propagating or\n    // removing attributes from amp-video/video elements.\n    if (elementToUse.hasAttribute('src')) {\n      srcEl = Sources.createSourceElement(win, elementToUse);\n      elementToUse.removeAttribute('src');\n    }\n\n    const srcEls = toArray(elementToUse.querySelectorAll('source'));\n    srcEls.forEach((srcEl) => removeElement(srcEl));\n\n    const trackEls = toArray(elementToUse.querySelectorAll('track'));\n    trackEls.forEach((trackEl) => removeElement(trackEl));\n\n    // If the src attribute is present, browsers will follow it and ignore the\n    // HTMLSourceElements. To ensure this behavior, drop the sources if the src\n    // was specified.\n    // cf: https://html.spec.whatwg.org/#concept-media-load-algorithm\n    const sourcesToUse = srcEl ? [srcEl] : srcEls;\n\n    return new Sources(null /** srcAttr */, sourcesToUse, trackEls);\n  }\n\n  /**\n   * Creates a HTMLSourceElement from the element src attribute.\n   * @param {!Window} win\n   * @param {!Element} element\n   * @return {!Element}\n   */\n  static createSourceElement(win, element) {\n    const srcEl = win.document.createElement('source');\n\n    const srcAttr = element.getAttribute('src');\n    srcEl.setAttribute('src', srcAttr);\n\n    const origSrcAttr = element.getAttribute('amp-orig-src');\n    if (origSrcAttr) {\n      srcEl.setAttribute('amp-orig-src', origSrcAttr);\n    }\n\n    const typeAttr = element.getAttribute('type');\n    if (typeAttr) {\n      srcEl.setAttribute('type', typeAttr);\n    }\n\n    return srcEl;\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred, tryResolve} from '../../../src/core/data-structures/promise';\nimport {Sources} from './sources';\nimport {isConnectedNode} from '../../../src/dom';\n\n/**\n * The name for a boolean property on an element indicating whether that element\n * has already been \"blessed\".\n * @const {string}\n */\nexport const ELEMENT_BLESSED_PROPERTY_NAME = '__AMP_MEDIA_IS_BLESSED__';\n\n/**\n * CSS class names that should not be removed from an element when swapping it\n * into/out of the DOM.\n * @const {!Array<string>}\n */\nconst PROTECTED_CSS_CLASS_NAMES = [\n  'i-amphtml-pool-media',\n  'i-amphtml-pool-audio',\n  'i-amphtml-pool-video',\n];\n\n/**\n * Attribute names that should not be removed from an element when swapping it\n * into/out of the DOM.\n * @const {!Array<string>}\n */\nconst PROTECTED_ATTRIBUTES = ['id', 'src', 'class', 'autoplay'];\n\n/**\n * Determines whether a CSS class name is allowed to be removed or copied from\n * media elements.\n * @param {string} cssClassName The CSS class name name to check.\n * @return {boolean} true, if the specified CSS class name is allowed to be\n *     removed or copied from media elements; false otherwise.\n * @private\n */\nfunction isProtectedCssClassName(cssClassName) {\n  return PROTECTED_CSS_CLASS_NAMES.indexOf(cssClassName) >= 0;\n}\n\n/**\n * Determines whether an attribute is allowed to be removed or copied from\n * media elements.\n * @param {string} attributeName The attribute name to check.\n * @return {boolean} true, if the specified attribute is allowed to be removed\n *     or copied from media elements; false otherwise.\n * @private\n */\nfunction isProtectedAttributeName(attributeName) {\n  return PROTECTED_ATTRIBUTES.indexOf(attributeName) >= 0;\n}\n\n/**\n * Copies all unprotected CSS classes from fromEl to toEl.\n * @param {!Element} fromEl The element from which CSS classes should\n *     be copied.\n * @param {!Element} toEl The element to which CSS classes should be\n *     copied.\n * @private\n */\nfunction copyCssClasses(fromEl, toEl) {\n  // Remove all of the unprotected CSS classes from the toEl.\n  for (let i = toEl.classList.length - 1; i >= 0; i--) {\n    const cssClass = toEl.classList.item(i);\n    if (!isProtectedCssClassName(cssClass)) {\n      toEl.classList.remove(cssClass);\n    }\n  }\n\n  // Copy all of the unprotected CSS classes from the fromEl to the toEl.\n  for (let i = 0; i < fromEl.classList.length; i++) {\n    const cssClass = fromEl.classList.item(i);\n    if (!isProtectedCssClassName(cssClass)) {\n      toEl.classList.add(cssClass);\n    }\n  }\n}\n\n/**\n * Copies all unprotected attributes from fromEl to toEl.\n * @param {!Element} fromEl The element from which attributes should\n *     be copied.\n * @param {!Element} toEl The element to which attributes should be\n *     copied.\n * @private\n */\nfunction copyAttributes(fromEl, toEl) {\n  const fromAttributes = fromEl.attributes;\n  const toAttributes = toEl.attributes;\n\n  // Remove all of the unprotected attributes from the toEl.\n  for (let i = toAttributes.length - 1; i >= 0; i--) {\n    const attributeName = toAttributes[i].name;\n    if (!isProtectedAttributeName(attributeName)) {\n      toEl.removeAttribute(attributeName);\n    }\n  }\n\n  // Copy all of the unprotected attributes from the fromEl to the toEl.\n  for (let i = 0; i < fromAttributes.length; i++) {\n    const {name: attributeName, value: attributeValue} = fromAttributes[i];\n    if (!isProtectedAttributeName(attributeName)) {\n      toEl.setAttribute(attributeName, attributeValue);\n    }\n  }\n}\n\n/**\n * Base class for tasks executed in order on HTMLMediaElements.\n */\nexport class MediaTask {\n  /**\n   * @param {string} name\n   * @param {!Object=} options\n   */\n  constructor(name, options = {}) {\n    /** @private @const {string} */\n    this.name_ = name;\n\n    const deferred = new Deferred();\n\n    /** @private @const {!Promise} */\n    this.completionPromise_ = deferred.promise;\n\n    /** @protected @const {!Object} */\n    this.options = options;\n\n    /** @private {?function()} */\n    this.resolve_ = deferred.resolve;\n\n    /** @private {?function(*)} */\n    this.reject_ = deferred.reject;\n  }\n\n  /**\n   * @return {string} The name of this task.\n   */\n  getName() {\n    return this.name_;\n  }\n\n  /**\n   * @return {!Promise<*>} A promise that is resolved when the task has\n   *     completed execution.\n   */\n  whenComplete() {\n    return this.completionPromise_;\n  }\n\n  /**\n   * @param {!HTMLMediaElement} mediaEl The element on which this task should be\n   *     executed.\n   * @return {!Promise} A promise that is resolved when the task has completed\n   *     execution.\n   */\n  execute(mediaEl) {\n    return this.executeInternal(mediaEl).then(this.resolve_, this.reject_);\n  }\n\n  /**\n   * @param {!HTMLMediaElement} unusedMediaEl The element on which this task\n   *     should be executed.\n   * @return {*} TODO(#23582): Specify return type\n   * @protected\n   */\n  executeInternal(unusedMediaEl) {\n    return Promise.resolve();\n  }\n\n  /**\n   * @return {boolean} true, if this task must be executed synchronously, e.g.\n   *    if it requires a user gesture.\n   */\n  requiresSynchronousExecution() {\n    return false;\n  }\n\n  /**\n   * @param {*} reason The reason for failing the task.\n   * @protected\n   */\n  failTask(reason) {\n    this.reject_(reason);\n  }\n}\n\n/**\n * Plays the specified media element.\n */\nexport class PlayTask extends MediaTask {\n  /**\n   * @public\n   */\n  constructor() {\n    super('play');\n  }\n\n  /** @override */\n  executeInternal(mediaEl) {\n    if (!mediaEl.paused) {\n      // We do not want to invoke play() if the media element is already\n      // playing, as this can interrupt playback in some browsers.\n      return Promise.resolve();\n    }\n\n    // The play() invocation is wrapped in a Promise.resolve(...) due to the\n    // fact that some browsers return a promise from media elements' play()\n    // function, while others return a boolean.\n    return tryResolve(() => mediaEl.play());\n  }\n}\n\n/**\n * Pauses the specified media element.\n */\nexport class PauseTask extends MediaTask {\n  /**\n   * @public\n   */\n  constructor() {\n    super('pause');\n  }\n\n  /** @override */\n  executeInternal(mediaEl) {\n    mediaEl.pause();\n    return Promise.resolve();\n  }\n}\n\n/**\n * Unmutes the specified media element.\n */\nexport class UnmuteTask extends MediaTask {\n  /**\n   * @public\n   */\n  constructor() {\n    super('unmute');\n  }\n\n  /** @override */\n  executeInternal(mediaEl) {\n    mediaEl.muted = false;\n    mediaEl.removeAttribute('muted');\n    return Promise.resolve();\n  }\n}\n\n/**\n * Mutes the specified media element.\n */\nexport class MuteTask extends MediaTask {\n  /**\n   * @public\n   */\n  constructor() {\n    super('mute');\n  }\n\n  /** @override */\n  executeInternal(mediaEl) {\n    mediaEl.muted = true;\n    mediaEl.setAttribute('muted', '');\n    return Promise.resolve();\n  }\n}\n\n/**\n * Seeks the specified media element to the provided time, in seconds.\n */\nexport class SetCurrentTimeTask extends MediaTask {\n  /**\n   * @param {!Object=} options\n   */\n  constructor(options = {currentTime: 0}) {\n    super('setCurrentTime', options);\n  }\n\n  /** @override */\n  executeInternal(mediaEl) {\n    mediaEl.currentTime = this.options.currentTime;\n    return Promise.resolve();\n  }\n}\n\n/**\n * Loads the specified media element.\n */\nexport class LoadTask extends MediaTask {\n  /**\n   * @public\n   */\n  constructor() {\n    super('load');\n  }\n\n  /** @override */\n  executeInternal(mediaEl) {\n    mediaEl.load();\n    return Promise.resolve();\n  }\n\n  /** @override */\n  requiresSynchronousExecution() {\n    // When recycling a media pool element, its sources are removed and the\n    // LoadTask runs to reset it (buffered data, readyState, etc). It needs to\n    // run synchronously so the media element can't be used in a new context\n    // but with old data.\n    return true;\n  }\n}\n\n/**\n * \"Blesses\" the specified media element for future playback without a user\n * gesture.  In order for this to bless the media element, this function must\n * be invoked in response to a user gesture.\n */\nexport class BlessTask extends MediaTask {\n  /**\n   * @public\n   */\n  constructor() {\n    super('bless');\n  }\n\n  /** @override */\n  requiresSynchronousExecution() {\n    return true;\n  }\n\n  /** @override */\n  executeInternal(mediaEl) {\n    const isMuted = mediaEl.muted;\n    mediaEl.muted = false;\n    if (isMuted) {\n      mediaEl.muted = true;\n    }\n    return Promise.resolve();\n  }\n}\n\n/**\n * Updates the sources of the specified media element.\n */\nexport class UpdateSourcesTask extends MediaTask {\n  /**\n   * @param {!Window} win\n   * @param {!Sources} newSources The sources to which the media element should\n   *     be updated.\n   */\n  constructor(win, newSources) {\n    super('update-src');\n\n    /** @private {!Window} */\n    this.win_ = win;\n\n    /** @private @const {!Sources} */\n    this.newSources_ = newSources;\n  }\n\n  /** @override */\n  executeInternal(mediaEl) {\n    Sources.removeFrom(this.win_, mediaEl);\n    this.newSources_.applyToElement(this.win_, mediaEl);\n    return Promise.resolve();\n  }\n\n  /** @override */\n  requiresSynchronousExecution() {\n    return true;\n  }\n}\n\n/**\n * Swaps a media element into the DOM, in the place of a placeholder element.\n */\nexport class SwapIntoDomTask extends MediaTask {\n  /**\n   * @param {!Element} placeholderEl The element to be replaced by the media\n   *     element on which this task is executed.\n   */\n  constructor(placeholderEl) {\n    super('swap-into-dom');\n\n    /** @private @const {!Element} */\n    this.placeholderEl_ = placeholderEl;\n  }\n\n  /** @override */\n  executeInternal(mediaEl) {\n    if (!isConnectedNode(this.placeholderEl_)) {\n      this.failTask('Cannot swap media for element that is not in DOM.');\n      return Promise.resolve();\n    }\n\n    copyCssClasses(this.placeholderEl_, mediaEl);\n    copyAttributes(this.placeholderEl_, mediaEl);\n    this.placeholderEl_.parentElement.replaceChild(\n      mediaEl,\n      this.placeholderEl_\n    );\n    return Promise.resolve();\n  }\n\n  /** @override */\n  requiresSynchronousExecution() {\n    return true;\n  }\n}\n\n/**\n * Swaps a media element out the DOM, replacing it with a placeholder element.\n */\nexport class SwapOutOfDomTask extends MediaTask {\n  /**\n   * @param {!Element} placeholderEl The element to replace the media element on\n   *     which this task is executed.\n   */\n  constructor(placeholderEl) {\n    super('swap-out-of-dom');\n\n    /** @private @const {!Element} */\n    this.placeholderEl_ = placeholderEl;\n  }\n\n  /** @override */\n  executeInternal(mediaEl) {\n    copyCssClasses(mediaEl, this.placeholderEl_);\n    copyAttributes(mediaEl, this.placeholderEl_);\n    mediaEl.parentElement.replaceChild(this.placeholderEl_, mediaEl);\n    return Promise.resolve();\n  }\n\n  /** @override */\n  requiresSynchronousExecution() {\n    return true;\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BlessTask,\n  ELEMENT_BLESSED_PROPERTY_NAME,\n  LoadTask,\n  MuteTask,\n  PauseTask,\n  PlayTask,\n  SetCurrentTimeTask,\n  SwapIntoDomTask,\n  SwapOutOfDomTask,\n  UnmuteTask,\n  UpdateSourcesTask,\n} from './media-tasks';\nimport {MEDIA_LOAD_FAILURE_SRC_PROPERTY} from '../../../src/event-helper';\nimport {Services} from '../../../src/services';\nimport {Sources} from './sources';\nimport {ampMediaElementFor} from './utils';\nimport {dev, devAssert} from '../../../src/log';\nimport {findIndex} from '../../../src/core/types/array';\nimport {isConnectedNode} from '../../../src/dom';\nimport {matches} from '../../../src/core/dom/query';\nimport {toWin} from '../../../src/core/window';\nimport {userInteractedWith} from '../../../src/video-interface';\n\n/** @const @enum {string} */\nexport const MediaType = {\n  UNSUPPORTED: 'unsupported',\n  AUDIO: 'audio',\n  VIDEO: 'video',\n};\n\n/** @const @enum {string} */\nconst MediaElementOrigin = {\n  PLACEHOLDER: 'placeholder',\n  POOL: 'pool',\n};\n\n/**\n * A marker type to indicate an element that originated in the document that is\n * being swapped for an element from the pool.\n * @typedef {!Element}\n */\nexport let PlaceholderElementDef;\n\n/**\n * A marker type to indicate an element that originated from the pool itself.\n * @typedef {!HTMLMediaElement}\n */\nlet PoolBoundElementDef;\n\n/**\n * An element pulled from the DOM.  It is yet to be resolved into a\n * PlaceholderElement or a PoolBoundElement.\n * @typedef {!PlaceholderElementDef|!PoolBoundElementDef}\n */\nexport let DomElementDef;\n\n/**\n * Represents the distance of an element from the current place in the document.\n * @typedef {function(!DomElementDef): number}\n */\nexport let ElementDistanceFnDef;\n\n/**\n * Represents a task to be executed on a media element.\n * @typedef {function(!PoolBoundElementDef, *): !Promise}\n */\nlet ElementTask_1_0_Def; // eslint-disable-line google-camelcase/google-camelcase\n\n/**\n * @const {string}\n */\nconst PLACEHOLDER_ELEMENT_ID_PREFIX = 'i-amphtml-placeholder-media-';\n\n/**\n * @const {string}\n */\nconst POOL_ELEMENT_ID_PREFIX = 'i-amphtml-pool-media-';\n\n/**\n * @const {string}\n */\nconst POOL_MEDIA_ELEMENT_PROPERTY_NAME = '__AMP_MEDIA_POOL_ID__';\n\n/**\n * @const {string}\n */\nconst ELEMENT_TASK_QUEUE_PROPERTY_NAME = '__AMP_MEDIA_ELEMENT_TASKS__';\n\n/**\n * @const {string}\n */\nconst MEDIA_ELEMENT_ORIGIN_PROPERTY_NAME = '__AMP_MEDIA_ELEMENT_ORIGIN__';\n\n/**\n * The name for a string attribute that represents the ID of a media element\n * that the element containing this attribute replaced.\n * @const {string}\n */\nexport const REPLACED_MEDIA_PROPERTY_NAME = 'replaced-media';\n\n/**\n * @type {!Object<string, !MediaPool>}\n */\nconst instances = {};\n\n/**\n * @type {number}\n */\nlet nextInstanceId = 0;\n\n/**\n * \uD83C\uDF79 MediaPool\n * Keeps a pool of N media elements to be shared across components.\n */\nexport class MediaPool {\n  /**\n   * @param {!Window} win The window object.\n   * @param {!Object<!MediaType, number>} maxCounts The maximum amount of each\n   *     media element that can be allocated by the pool.\n   * @param {!ElementDistanceFnDef} distanceFn A function that, given an\n   *     element, returns the distance of that element from the current position\n   *     in the document.  The definition of \"distance\" can be implementation-\n   *     dependant, as long as it is consistent between invocations.\n   */\n  constructor(win, maxCounts, distanceFn) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private @const {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(win);\n\n    /**\n     * The function used to retrieve the distance between an element and the\n     * current position in the document.\n     * @private @const {!ElementDistanceFnDef}\n     */\n    this.distanceFn_ = distanceFn;\n\n    /**\n     * Holds all of the pool-bound media elements that have been allocated.\n     * @const {!Object<!MediaType, !Array<!PoolBoundElementDef>>}\n     * @visibleForTesting\n     */\n    this.allocated = {};\n\n    /**\n     * Holds all of the pool-bound media elements that have not been allocated.\n     * @const {!Object<!MediaType, !Array<!PoolBoundElementDef>>}\n     * @visibleForTesting\n     */\n    this.unallocated = {};\n\n    /**\n     * Maps a media element's ID to the object containing its sources.\n     * @private @const {!Object<string, !Sources>}\n     */\n    this.sources_ = {};\n\n    /**\n     * Maps a media element's ID to the element.  This is necessary, as elements\n     * are kept in memory when they are swapped out of the DOM.\n     * @private @const {!Object<string, !PlaceholderElementDef>}\n     */\n    this.placeholderEls_ = {};\n\n    /**\n     * Counter used to produce unique IDs for placeholder media elements.\n     * @private {number}\n     */\n    this.placeholderIdCounter_ = 0;\n\n    /**\n     * Whether the media elements in this MediaPool instance have been \"blessed\"\n     * for unmuted playback without user gesture.\n     * @private {boolean}\n     */\n    this.blessed_ = false;\n\n    /** @private {?Array<!AmpElement>} */\n    this.ampElementsToBless_ = null;\n\n    /** @const {!Object<string, (function(): !PoolBoundElementDef)>} */\n    this.mediaFactory_ = {\n      [MediaType.AUDIO]: () => {\n        const audioEl = this.win_.document.createElement('audio');\n        audioEl.setAttribute('muted', '');\n        audioEl.muted = true;\n        audioEl.classList.add('i-amphtml-pool-media');\n        audioEl.classList.add('i-amphtml-pool-audio');\n        return audioEl;\n      },\n      [MediaType.VIDEO]: () => {\n        const videoEl = this.win_.document.createElement('video');\n        videoEl.setAttribute('muted', '');\n        videoEl.muted = true;\n        videoEl.setAttribute('playsinline', '');\n        videoEl.classList.add('i-amphtml-pool-media');\n        videoEl.classList.add('i-amphtml-pool-video');\n        return videoEl;\n      },\n    };\n\n    this.initializeMediaPool_(maxCounts);\n  }\n\n  /**\n   * Fills the media pool by creating the maximum number of media elements for\n   * each of the types of media elements.  We need to create these eagerly so\n   * that all media elements exist by the time that blessAll() is invoked,\n   * thereby \"blessing\" all media elements for playback without user gesture.\n   * @param {!Object<!MediaType, number>} maxCounts The maximum amount of each\n   *     media element that can be allocated by the pool.\n   * @private\n   */\n  initializeMediaPool_(maxCounts) {\n    let poolIdCounter = 0;\n\n    this.forEachMediaType_((key) => {\n      const type = MediaType[key];\n      const count = maxCounts[type] || 0;\n\n      if (count <= 0) {\n        return;\n      }\n\n      const ctor = devAssert(\n        this.mediaFactory_[type],\n        `Factory for media type \\`${type}\\` unset.`\n      );\n\n      // Cloning nodes is faster than building them.\n      // Construct a seed media element as a small optimization.\n      const mediaElSeed = ctor.call(this);\n\n      this.allocated[type] = [];\n      this.unallocated[type] = [];\n\n      // Reverse-looping is generally faster and Closure would usually make\n      // this optimization automatically. However, it skips it due to a\n      // comparison with the itervar below, so we have to roll it by hand.\n      for (let i = count; i > 0; i--) {\n        // Use seed element at end of set to prevent wasting it.\n        const mediaEl = /** @type {!PoolBoundElementDef} */ (\n          i == 1 ? mediaElSeed : mediaElSeed.cloneNode(/* deep */ true)\n        );\n        mediaEl.addEventListener('error', this.onMediaError_, {capture: true});\n        mediaEl.id = POOL_ELEMENT_ID_PREFIX + poolIdCounter++;\n        // In Firefox, cloneNode() does not properly copy the muted property\n        // that was set in the seed. We need to set it again here.\n        mediaEl.muted = true;\n        mediaEl[MEDIA_ELEMENT_ORIGIN_PROPERTY_NAME] = MediaElementOrigin.POOL;\n        this.unallocated[type].push(mediaEl);\n      }\n    });\n  }\n\n  /**\n   * Handles HTMLMediaElement and children HTMLSourceElement error events. Marks\n   * the media as errored, as there is no other way to check if the load failed\n   * when the media is using HTMLSourceElements.\n   * @param {!Event} event\n   * @private\n   */\n  onMediaError_(event) {\n    const target = dev().assertElement(event.target);\n    if (!matches(target, 'source:last-of-type, video[src]')) {\n      return;\n    }\n    const media = target.tagName === 'SOURCE' ? target.parentElement : target;\n    media[MEDIA_LOAD_FAILURE_SRC_PROPERTY] = media.currentSrc || true;\n  }\n\n  /**\n   * @return {!Sources} The default source, empty.\n   * @private\n   */\n  getDefaultSource_() {\n    return new Sources();\n  }\n\n  /**\n   * Comparison function that compares the distance of each element from the\n   * current position in the document.\n   * @param {!PoolBoundElementDef} mediaA The first element to compare.\n   * @param {!PoolBoundElementDef} mediaB The second element to compare.\n   * @return {number}\n   * @private\n   */\n  compareMediaDistances_(mediaA, mediaB) {\n    const distanceA = this.distanceFn_(mediaA);\n    const distanceB = this.distanceFn_(mediaB);\n    return distanceA < distanceB ? -1 : 1;\n  }\n\n  /**\n   * @return {string} A unique ID.\n   * @private\n   */\n  createPlaceholderElementId_() {\n    return PLACEHOLDER_ELEMENT_ID_PREFIX + this.placeholderIdCounter_++;\n  }\n\n  /**\n   * @param {!DomElementDef} mediaElement\n   * @return {boolean}\n   * @private\n   */\n  isPoolMediaElement_(mediaElement) {\n    return (\n      mediaElement[MEDIA_ELEMENT_ORIGIN_PROPERTY_NAME] ===\n      MediaElementOrigin.POOL\n    );\n  }\n\n  /**\n   * Gets the media type from a given element.\n   * @param {!PoolBoundElementDef|!PlaceholderElementDef} mediaElement The\n   *     element whose media type should be retrieved.\n   * @return {!MediaType}\n   * @private\n   */\n  getMediaType_(mediaElement) {\n    const tagName = mediaElement.tagName.toLowerCase();\n    switch (tagName) {\n      case 'audio':\n        return MediaType.AUDIO;\n      case 'video':\n        return MediaType.VIDEO;\n      default:\n        return MediaType.UNSUPPORTED;\n    }\n  }\n\n  /**\n   * Reserves an element of the specified type by removing it from the set of\n   * unallocated elements and returning it.\n   * @param {!MediaType} mediaType The type of media element to reserve.\n   * @return {?PoolBoundElementDef} The reserved element, if one exists.\n   * @private\n   */\n  reserveUnallocatedMediaElement_(mediaType) {\n    return this.unallocated[mediaType].pop();\n  }\n\n  /**\n   * Retrieves the media element from the pool that matches the specified\n   * element, if one exists.\n   * @param {!MediaType} mediaType The type of media element to get.\n   * @param {!DomElementDef} domMediaEl The element whose matching media\n   *     element should be retrieved.\n   * @return {?PoolBoundElementDef} The media element in the pool that\n   *     represents the specified media element\n   */\n  getMatchingMediaElementFromPool_(mediaType, domMediaEl) {\n    if (this.isAllocatedMediaElement_(mediaType, domMediaEl)) {\n      // The media element in the DOM was already from the pool.\n      return /** @type {!PoolBoundElementDef} */ (domMediaEl);\n    }\n\n    const allocatedEls = this.allocated[mediaType];\n    const index = findIndex(allocatedEls, (poolMediaEl) => {\n      return poolMediaEl[REPLACED_MEDIA_PROPERTY_NAME] === domMediaEl.id;\n    });\n\n    return allocatedEls[index];\n  }\n\n  /**\n   * Allocates the specified media element of the specified type.\n   * @param {!MediaType} mediaType The type of media element to allocate.\n   * @param {!PoolBoundElementDef} poolMediaEl The element to be allocated.\n   * @private\n   */\n  allocateMediaElement_(mediaType, poolMediaEl) {\n    this.allocated[mediaType].push(poolMediaEl);\n\n    const unallocatedEls = this.unallocated[mediaType];\n    const indexToRemove = unallocatedEls.indexOf(poolMediaEl);\n\n    if (indexToRemove >= 0) {\n      unallocatedEls.splice(indexToRemove, 1);\n    }\n  }\n\n  /**\n   * Deallocates and returns the media element of the specified type furthest\n   * from the current position in the document.\n   * @param {!MediaType} mediaType The type of media element to deallocate.\n   * @param {!PlaceholderElementDef=} opt_elToAllocate If specified, the element\n   *     that is trying to be allocated, such that another element must be\n   *     evicted.\n   * @return {?PoolBoundElementDef} The deallocated element, if one exists.\n   * @private\n   */\n  deallocateMediaElement_(mediaType, opt_elToAllocate) {\n    const allocatedEls = this.allocated[mediaType];\n\n    // Sort the allocated media elements by distance to ensure that we are\n    // evicting the media element that is furthest from the current place in the\n    // document.\n    allocatedEls.sort((a, b) => this.compareMediaDistances_(a, b));\n\n    // Do not deallocate any media elements if the element being loaded or\n    // played is further than the farthest allocated element.\n    if (opt_elToAllocate) {\n      const furthestEl = allocatedEls[allocatedEls.length - 1];\n      if (\n        !furthestEl ||\n        this.distanceFn_(furthestEl) < this.distanceFn_(opt_elToAllocate)\n      ) {\n        return null;\n      }\n    }\n\n    // De-allocate a media element.\n    const poolMediaEl = allocatedEls.pop();\n    this.unallocated[mediaType].push(poolMediaEl);\n    return poolMediaEl;\n  }\n\n  /**\n   * Forcibly deallocates a specific media element, regardless of its distance\n   * from the current position in the document.\n   * @param {!PoolBoundElementDef} poolMediaEl The element to be deallocated.\n   * @return {!Promise} A promise that is resolved when the specified media\n   *     element has been successfully deallocated.\n   */\n  forceDeallocateMediaElement_(poolMediaEl) {\n    const mediaType = this.getMediaType_(poolMediaEl);\n    const allocatedEls = this.allocated[mediaType];\n    const removeFromDom = isConnectedNode(poolMediaEl)\n      ? this.swapPoolMediaElementOutOfDom_(poolMediaEl)\n      : Promise.resolve();\n\n    return removeFromDom.then(() => {\n      const index = allocatedEls.indexOf(poolMediaEl);\n      devAssert(index >= 0, 'Cannot deallocate unallocated media element.');\n      allocatedEls.splice(index, 1);\n      this.unallocated[mediaType].push(poolMediaEl);\n    });\n  }\n\n  /**\n   * Evicts an element of the specified type, replaces it in the DOM with the\n   * original media element, and returns it.\n   * @param {!MediaType} mediaType The type of media element to evict.\n   * @param {!PlaceholderElementDef=} opt_elToAllocate If specified, the element\n   *     that is trying to be allocated, such that another element must be\n   *     evicted.\n   * @return {?PoolBoundElementDef} A media element of the specified type.\n   * @private\n   */\n  evictMediaElement_(mediaType, opt_elToAllocate) {\n    const poolMediaEl = this.deallocateMediaElement_(\n      mediaType,\n      opt_elToAllocate\n    );\n    if (!poolMediaEl) {\n      return null;\n    }\n\n    this.swapPoolMediaElementOutOfDom_(poolMediaEl);\n    return poolMediaEl;\n  }\n\n  /**\n   * @param {!MediaType} mediaType The media type to check.\n   * @param {!DomElementDef} domMediaEl The element to check.\n   * @return {boolean} true, if the specified element has already been allocated\n   *     as the specified type of media element.\n   * @private\n   */\n  isAllocatedMediaElement_(mediaType, domMediaEl) {\n    // Since we don't know whether or not the specified domMediaEl is a\n    // placeholder or originated from the pool, we coerce it to a pool-bound\n    // element, to check against the allocated list of pool-bound elements.\n    const poolMediaEl = /** @type {!PoolBoundElementDef} */ (domMediaEl);\n    return this.allocated[mediaType].indexOf(poolMediaEl) >= 0;\n  }\n\n  /**\n   * Replaces a media element that was originally in the DOM with a media\n   * element from the pool.\n   * @param {!PlaceholderElementDef} placeholderEl The placeholder element\n   *     originating from the DOM.\n   * @param {!PoolBoundElementDef} poolMediaEl The media element originating\n   *     from the pool.\n   * @param {!Sources} sources The sources for the media element.\n   * @return {!Promise} A promise that is resolved when the media element has\n   *     been successfully swapped into the DOM.\n   * @private\n   */\n  swapPoolMediaElementIntoDom_(placeholderEl, poolMediaEl, sources) {\n    const ampMediaForPoolEl = ampMediaElementFor(poolMediaEl);\n    const ampMediaForDomEl = ampMediaElementFor(placeholderEl);\n    poolMediaEl[REPLACED_MEDIA_PROPERTY_NAME] = placeholderEl.id;\n\n    return this.enqueueMediaElementTask_(\n      poolMediaEl,\n      new SwapIntoDomTask(placeholderEl)\n    )\n      .then(() =>\n        Promise.all([\n          this.maybeResetAmpMedia_(ampMediaForPoolEl),\n          this.maybeResetAmpMedia_(ampMediaForDomEl),\n        ])\n      )\n      .then(() =>\n        this.enqueueMediaElementTask_(\n          poolMediaEl,\n          new UpdateSourcesTask(this.win_, sources)\n        )\n      )\n      .then(() => this.enqueueMediaElementTask_(poolMediaEl, new LoadTask()))\n      .catch(() => {\n        this.forceDeallocateMediaElement_(poolMediaEl);\n      });\n  }\n\n  /**\n   * @param {?Element} componentEl\n   * @return {!Promise}\n   * @private\n   */\n  maybeResetAmpMedia_(componentEl) {\n    if (!componentEl) {\n      return Promise.resolve();\n    }\n\n    if (componentEl.tagName.toLowerCase() == 'amp-audio') {\n      // TODO(alanorozco): Implement reset for amp-audio\n      return Promise.resolve();\n    }\n\n    return componentEl.getImpl().then((impl) => {\n      if (impl.resetOnDomChange) {\n        impl.resetOnDomChange();\n      }\n    });\n  }\n\n  /**\n   * @param {!PoolBoundElementDef} poolMediaEl The element whose source should\n   *     be reset.\n   * @return {!Promise} A promise that is resolved when the pool media element\n   *     has been reset.\n   */\n  resetPoolMediaElementSource_(poolMediaEl) {\n    const defaultSources = this.getDefaultSource_();\n\n    return this.enqueueMediaElementTask_(\n      poolMediaEl,\n      new UpdateSourcesTask(this.win_, defaultSources)\n    ).then(() => this.enqueueMediaElementTask_(poolMediaEl, new LoadTask()));\n  }\n\n  /**\n   * Removes a pool media element from the DOM and replaces it with the video\n   * that it originally replaced.\n   * @param {!PoolBoundElementDef} poolMediaEl The pool media element to remove\n   *     from the DOM.\n   * @return {!Promise} A promise that is resolved when the media element has\n   *     been successfully swapped out of the DOM.\n   * @private\n   */\n  swapPoolMediaElementOutOfDom_(poolMediaEl) {\n    const placeholderElId = poolMediaEl[REPLACED_MEDIA_PROPERTY_NAME];\n    const placeholderEl = /** @type {!PlaceholderElementDef} */ (\n      dev().assertElement(\n        this.placeholderEls_[placeholderElId],\n        `No media element ${placeholderElId} to put back into DOM after` +\n          'eviction.'\n      )\n    );\n    poolMediaEl[REPLACED_MEDIA_PROPERTY_NAME] = null;\n\n    const swapOutOfDom = this.enqueueMediaElementTask_(\n      poolMediaEl,\n      new SwapOutOfDomTask(placeholderEl)\n    );\n\n    this.resetPoolMediaElementSource_(poolMediaEl);\n    return swapOutOfDom;\n  }\n\n  /**\n   * @param {function(string)} callbackFn\n   * @private\n   */\n  forEachMediaType_(callbackFn) {\n    Object.keys(MediaType).forEach(callbackFn.bind(this));\n  }\n\n  /**\n   * Invokes a function for all media managed by the media pool.\n   * @param {function(!PoolBoundElementDef)} callbackFn The function to be\n   *     invoked.\n   * @private\n   */\n  forEachMediaElement_(callbackFn) {\n    [this.allocated, this.unallocated].forEach((mediaSet) => {\n      this.forEachMediaType_((key) => {\n        const type = MediaType[key];\n        const els = /** @type {!Array} */ (mediaSet[type]);\n        if (!els) {\n          return;\n        }\n        els.forEach(callbackFn.bind(this));\n      });\n    });\n  }\n\n  /**\n   * Preloads the content of the specified media element in the DOM and returns\n   * a media element that can be used in its stead for playback.\n   * @param {!DomElementDef} domMediaEl The media element, found in the\n   *     DOM, whose content should be loaded.\n   * @return {Promise<!PoolBoundElementDef|undefined>} A media element from the pool that\n   *     can be used to replace the specified element.\n   */\n  loadInternal_(domMediaEl) {\n    if (!isConnectedNode(domMediaEl)) {\n      // Don't handle nodes that aren't even in the document.\n      return Promise.resolve();\n    }\n\n    const mediaType = this.getMediaType_(domMediaEl);\n    const existingPoolMediaEl = this.getMatchingMediaElementFromPool_(\n      mediaType,\n      domMediaEl\n    );\n    if (existingPoolMediaEl) {\n      // The element being loaded already has an allocated media element.\n      return Promise.resolve(\n        /** @type {!PoolBoundElementDef} */ (existingPoolMediaEl)\n      );\n    }\n\n    // Since this is not an existing pool media element, we can be certain that\n    // it is a placeholder element.\n    const placeholderEl = /** @type {!PlaceholderElementDef} */ (domMediaEl);\n\n    const sources = this.sources_[placeholderEl.id];\n    devAssert(sources instanceof Sources, 'Cannot play unregistered element.');\n\n    const poolMediaEl =\n      this.reserveUnallocatedMediaElement_(mediaType) ||\n      this.evictMediaElement_(mediaType, placeholderEl);\n\n    if (!poolMediaEl) {\n      // If there is no space in the pool to allocate a new element, and no\n      // element can be evicted, do not return any element.\n      return Promise.resolve();\n    }\n\n    this.allocateMediaElement_(mediaType, poolMediaEl);\n\n    return this.swapPoolMediaElementIntoDom_(\n      placeholderEl,\n      poolMediaEl,\n      sources\n    ).then(() => poolMediaEl);\n  }\n\n  /**\n   * \"Blesses\" the specified media element for future playback without a user\n   * gesture.  In order for this to bless the media element, this function must\n   * be invoked in response to a user gesture.\n   * @param {!PoolBoundElementDef} poolMediaEl The media element to bless.\n   * @return {!Promise} A promise that is resolved when blessing the media\n   *     element is complete.\n   */\n  bless_(poolMediaEl) {\n    if (poolMediaEl[ELEMENT_BLESSED_PROPERTY_NAME]) {\n      return Promise.resolve();\n    }\n\n    return this.enqueueMediaElementTask_(poolMediaEl, new BlessTask());\n  }\n\n  /**\n   * Registers the specified element to be usable by the media pool.  Elements\n   * should be registered as early as possible, in order to prevent them from\n   * being played while not managed by the media pool.  If the media element is\n   * already registered, this is a no-op.  Registering elements from within the\n   * pool is not allowed, and will also be a no-op.\n   * @param {!DomElementDef} domMediaEl The media element to be\n   *     registered.\n   * @return {!Promise} A promise that is resolved when the element has been\n   *     successfully registered, or rejected otherwise.\n   */\n  register(domMediaEl) {\n    const parent = domMediaEl.parentNode;\n    if (parent && parent.signals) {\n      this.trackAmpElementToBless_(/** @type {!AmpElement} */ (parent));\n    }\n\n    if (this.isPoolMediaElement_(domMediaEl)) {\n      // This media element originated from the media pool.\n      return Promise.resolve();\n    }\n\n    // Since this is not an existing pool media element, we can be certain that\n    // it is a placeholder element.\n    const placeholderEl = /** @type {!PlaceholderElementDef} */ (domMediaEl);\n    placeholderEl[MEDIA_ELEMENT_ORIGIN_PROPERTY_NAME] =\n      MediaElementOrigin.PLACEHOLDER;\n\n    const id = placeholderEl.id || this.createPlaceholderElementId_();\n    if (this.sources_[id] && this.placeholderEls_[id]) {\n      // This media element is already registered.\n      return Promise.resolve();\n    }\n\n    // This media element has not yet been registered.\n    placeholderEl.id = id;\n    const sources = Sources.removeFrom(this.win_, placeholderEl);\n    this.sources_[id] = sources;\n    this.placeholderEls_[id] = placeholderEl;\n\n    if (placeholderEl instanceof HTMLMediaElement) {\n      placeholderEl.muted = true;\n      placeholderEl.setAttribute('muted', '');\n      placeholderEl.pause();\n    }\n\n    return Promise.resolve();\n  }\n\n  /**\n   * @param {!AmpElement} element\n   * @private\n   */\n  trackAmpElementToBless_(element) {\n    this.ampElementsToBless_ = this.ampElementsToBless_ || [];\n    this.ampElementsToBless_.push(element);\n  }\n\n  /**\n   * Preloads the content of the specified media element in the DOM.\n   * @param {!DomElementDef} domMediaEl The media element, found in the\n   *     DOM, whose content should be loaded.\n   * @return {!Promise} A promise that is resolved when the specified media\n   *     element has successfully started preloading.\n   */\n  preload(domMediaEl) {\n    // Empty then() invocation hides the value yielded by the loadInternal_\n    // promise, so that we do not leak the pool media element outside of the\n    // scope of the media pool.\n    return this.loadInternal_(domMediaEl).then();\n  }\n\n  /**\n   * Plays the specified media element in the DOM by replacing it with a media\n   * element from the pool and playing that.\n   * @param {!DomElementDef} domMediaEl The media element to be played.\n   * @return {!Promise} A promise that is resolved when the specified media\n   *     element has been successfully played.\n   */\n  play(domMediaEl) {\n    return this.loadInternal_(domMediaEl).then((poolMediaEl) => {\n      if (!poolMediaEl) {\n        return Promise.resolve();\n      }\n\n      return this.enqueueMediaElementTask_(poolMediaEl, new PlayTask());\n    });\n  }\n\n  /**\n   * Pauses the specified media element in the DOM.\n   * @param {!DomElementDef} domMediaEl The media element to be paused.\n   * @param {boolean=} rewindToBeginning Whether to rewind the currentTime\n   *     of media items to the beginning.\n   * @return {!Promise} A promise that is resolved when the specified media\n   *     element has been successfully paused.\n   */\n  pause(domMediaEl, rewindToBeginning = false) {\n    const mediaType = this.getMediaType_(domMediaEl);\n    const poolMediaEl = this.getMatchingMediaElementFromPool_(\n      mediaType,\n      domMediaEl\n    );\n\n    if (!poolMediaEl) {\n      return Promise.resolve();\n    }\n\n    return this.enqueueMediaElementTask_(poolMediaEl, new PauseTask()).then(\n      () => {\n        if (rewindToBeginning) {\n          this.enqueueMediaElementTask_(\n            /** @type {!PoolBoundElementDef} */ (poolMediaEl),\n            new SetCurrentTimeTask({currentTime: 0})\n          );\n        }\n      }\n    );\n  }\n\n  /**\n   * Rewinds a specified media element in the DOM to 0.\n   * @param {!DomElementDef} domMediaEl The media element to be rewound.\n   * @return {!Promise} A promise that is resolved when the\n   *     specified media element has been successfully rewound.\n   */\n  rewindToBeginning(domMediaEl) {\n    return this.setCurrentTime(domMediaEl, 0 /** currentTime */);\n  }\n\n  /**\n   * Sets currentTime for a specified media element in the DOM.\n   * @param {!DomElementDef} domMediaEl The media element.\n   * @param {number} currentTime The time to seek to, in seconds.\n   * @return {!Promise} A promise that is resolved when the\n   *     specified media element has been successfully set to the given time.\n   */\n  setCurrentTime(domMediaEl, currentTime) {\n    const mediaType = this.getMediaType_(domMediaEl);\n    const poolMediaEl = this.getMatchingMediaElementFromPool_(\n      mediaType,\n      domMediaEl\n    );\n\n    if (!poolMediaEl) {\n      return Promise.resolve();\n    }\n\n    return this.enqueueMediaElementTask_(\n      poolMediaEl,\n      new SetCurrentTimeTask({currentTime})\n    );\n  }\n\n  /**\n   * Mutes the specified media element in the DOM.\n   * @param {!DomElementDef} domMediaEl The media element to be muted.\n   * @return {!Promise} A promise that is resolved when the specified media\n   *     element has been successfully muted.\n   */\n  mute(domMediaEl) {\n    const mediaType = this.getMediaType_(domMediaEl);\n    const poolMediaEl = this.getMatchingMediaElementFromPool_(\n      mediaType,\n      domMediaEl\n    );\n\n    if (!poolMediaEl) {\n      return Promise.resolve();\n    }\n\n    return this.enqueueMediaElementTask_(poolMediaEl, new MuteTask());\n  }\n\n  /**\n   * Unmutes the specified media element in the DOM.\n   * @param {!DomElementDef} domMediaEl The media element to be unmuted.\n   * @return {!Promise} A promise that is resolved when the specified media\n   *     element has been successfully paused.\n   */\n  unmute(domMediaEl) {\n    const mediaType = this.getMediaType_(domMediaEl);\n    const poolMediaEl = this.getMatchingMediaElementFromPool_(\n      mediaType,\n      domMediaEl\n    );\n\n    if (!poolMediaEl) {\n      return Promise.resolve();\n    }\n\n    return this.enqueueMediaElementTask_(poolMediaEl, new UnmuteTask());\n  }\n\n  /**\n   * \"Blesses\" all media elements in the media pool for future playback without\n   * a user gesture.  In order for this to bless the media elements, this\n   * function must be invoked in response to a user gesture.\n   * @return {!Promise} A promise that is resolved when all media elements in\n   *     the pool are blessed.\n   */\n  blessAll() {\n    if (this.blessed_) {\n      return Promise.resolve();\n    }\n\n    const blessPromises = [];\n\n    (this.ampElementsToBless_ || []).forEach(userInteractedWith);\n\n    this.ampElementsToBless_ = null; // GC\n\n    this.forEachMediaElement_((mediaEl) => {\n      blessPromises.push(this.bless_(mediaEl));\n    });\n\n    return Promise.all(blessPromises).then(\n      () => {\n        this.blessed_ = true;\n      },\n      (reason) => {\n        dev().expectedError('AMP-STORY', 'Blessing all media failed: ', reason);\n      }\n    );\n  }\n\n  /**\n   * @param {!PoolBoundElementDef} mediaEl The element whose task queue should\n   *     be executed.\n   * @private\n   */\n  executeNextMediaElementTask_(mediaEl) {\n    const queue = mediaEl[ELEMENT_TASK_QUEUE_PROPERTY_NAME];\n    if (queue.length === 0) {\n      return;\n    }\n\n    const task = queue[0];\n\n    const executionFn = () => {\n      task\n        .execute(mediaEl)\n        .catch((reason) => dev().error('AMP-STORY', reason))\n        .then(() => {\n          // Run regardless of success or failure of task execution.\n          queue.shift();\n          this.executeNextMediaElementTask_(mediaEl);\n        });\n    };\n\n    if (task.requiresSynchronousExecution()) {\n      executionFn.call(this);\n    } else {\n      this.timer_.delay(executionFn.bind(this), 0);\n    }\n  }\n\n  /**\n   * @param {!PoolBoundElementDef} mediaEl The element for which the specified\n   *     task should be executed.\n   * @param {!./media-tasks.MediaTask} task The task to be executed.\n   * @return {!Promise} A promise that is resolved when the specified task is\n   *     completed.\n   * @private\n   */\n  enqueueMediaElementTask_(mediaEl, task) {\n    if (!mediaEl[ELEMENT_TASK_QUEUE_PROPERTY_NAME]) {\n      mediaEl[ELEMENT_TASK_QUEUE_PROPERTY_NAME] = [];\n    }\n\n    const queue = mediaEl[ELEMENT_TASK_QUEUE_PROPERTY_NAME];\n    const isQueueRunning = queue.length !== 0;\n\n    queue.push(task);\n\n    if (!isQueueRunning) {\n      this.executeNextMediaElementTask_(mediaEl);\n    }\n\n    return task.whenComplete();\n  }\n\n  /**\n   * @param {!MediaPoolRoot} root\n   * @return {!MediaPool}\n   */\n  static for(root) {\n    const element = root.getElement();\n    const existingId = element[POOL_MEDIA_ELEMENT_PROPERTY_NAME];\n    const hasInstanceAllocated = existingId && instances[existingId];\n\n    if (hasInstanceAllocated) {\n      return instances[existingId];\n    }\n\n    const newId = String(nextInstanceId++);\n    element[POOL_MEDIA_ELEMENT_PROPERTY_NAME] = newId;\n    instances[newId] = new MediaPool(\n      toWin(root.getElement().ownerDocument.defaultView),\n      root.getMaxMediaElementCounts(),\n      (element) => root.getElementDistance(element)\n    );\n\n    return instances[newId];\n  }\n}\n\n/**\n * Defines a common interface for elements that contain a MediaPool.\n *\n * @interface\n */\nexport class MediaPoolRoot {\n  /**\n   * @return {!Element} The root element of this media pool.\n   */\n  getElement() {}\n\n  /**\n   * @param {!Element} unusedElement The element whose distance should be\n   *    retrieved.\n   * @return {number} A numerical distance representing how far the specified\n   *     element is from the user's current position in the document.  The\n   *     absolute magnitude of this number is irrelevant; the relative magnitude\n   *     is used to determine which media elements should be evicted (elements\n   *     furthest from the user's current position in the document are evicted\n   *     from the MediaPool first).\n   */\n  getElementDistance(unusedElement) {}\n\n  /**\n   * @return {!Object<!MediaType, number>} The maximum amount of each media\n   *     type to allow within this element.\n   */\n  getMaxMediaElementCounts() {}\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {addAttributesToElement} from './dom';\nimport {closestAncestorElementBySelector} from './core/dom/query';\nimport {deserializeMessage, isAmpMessage} from './3p-frame-messaging';\nimport {dev, devAssert} from './log';\nimport {dict} from './core/types/object';\nimport {getData} from './event-helper';\nimport {parseUrlDeprecated} from './url';\nimport {remove} from './core/types/array';\nimport {setStyle} from './style';\nimport {tryParseJson} from './core/types/object/json';\n\n/**\n * Sentinel used to force unlistening after a iframe is detached.\n * @type {string}\n */\nconst UNLISTEN_SENTINEL = 'unlisten';\n\n/**\n * @typedef {{\n *   frame: !Element,\n *   events: !Object<string, !Array<function(!JsonObject)>>\n * }}\n */\nlet WindowEventsDef;\n\n/**\n * Returns a mapping from a URL's origin to an array of windows and their\n * listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {boolean=} opt_create create the mapping if it does not exist\n * @return {?Object<string, !Array<!WindowEventsDef>>}\n */\nfunction getListenFors(parentWin, opt_create) {\n  let {listeningFors} = parentWin;\n\n  if (!listeningFors && opt_create) {\n    listeningFors = parentWin.listeningFors = Object.create(null);\n  }\n  return listeningFors || null;\n}\n\n/**\n * Returns an array of WindowEventsDef that have had any listenFor listeners\n * registered for this sentinel.\n * @param {?Window} parentWin the window that created the iframe\n * @param {string} sentinel the sentinel of the message\n * @param {boolean=} opt_create create the array if it does not exist\n * @return {?Array<!WindowEventsDef>}\n */\nfunction getListenForSentinel(parentWin, sentinel, opt_create) {\n  const listeningFors = getListenFors(parentWin, opt_create);\n  if (!listeningFors) {\n    return listeningFors;\n  }\n\n  let listenSentinel = listeningFors[sentinel];\n  if (!listenSentinel && opt_create) {\n    listenSentinel = listeningFors[sentinel] = [];\n  }\n  return listenSentinel || null;\n}\n\n/**\n * Returns an mapping of event names to listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {!Element} iframe the iframe element who's context will trigger the\n *     event\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @return {?Object<string, !Array<function(!JsonObject, !Window, string, !MessageEvent)>>}\n */\nfunction getOrCreateListenForEvents(parentWin, iframe, opt_is3P) {\n  const sentinel = getSentinel_(iframe, opt_is3P);\n  const listenSentinel = getListenForSentinel(parentWin, sentinel, true);\n\n  let windowEvents;\n  for (let i = 0; i < listenSentinel.length; i++) {\n    const we = listenSentinel[i];\n    if (we.frame === iframe) {\n      windowEvents = we;\n      break;\n    }\n  }\n\n  if (!windowEvents) {\n    windowEvents = {\n      frame: iframe,\n      events: Object.create(null),\n    };\n    listenSentinel.push(windowEvents);\n  }\n\n  return windowEvents.events;\n}\n\n/**\n * Returns an mapping of event names to listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {string} sentinel the sentinel of the message\n * @param {string} origin the source window's origin\n * @param {?Window} triggerWin the window that triggered the event\n * @return {?Object<string, !Array<function(!JsonObject, !Window, string, !MessageEvent)>>}\n */\nfunction getListenForEvents(parentWin, sentinel, origin, triggerWin) {\n  const listenSentinel = getListenForSentinel(parentWin, sentinel);\n\n  if (!listenSentinel) {\n    return listenSentinel;\n  }\n\n  // Find the entry for the frame.\n  // TODO(@nekodo): Add a WeakMap<Window, WindowEventsDef> cache to\n  //     speed up this process.\n  let windowEvents;\n  for (let i = 0; i < listenSentinel.length; i++) {\n    const we = listenSentinel[i];\n    const {contentWindow} = we.frame;\n    if (!contentWindow) {\n      setTimeout(dropListenSentinel, 0, listenSentinel);\n    } else if (\n      triggerWin == contentWindow ||\n      isDescendantWindow(contentWindow, triggerWin)\n    ) {\n      // 3p code path, we may accept messages from nested frames.\n      windowEvents = we;\n      break;\n    }\n  }\n\n  return windowEvents ? windowEvents.events : null;\n}\n\n/**\n * Checks whether one window is a descendant of another by climbing\n * the parent chain.\n * @param {?Window} ancestor potential ancestor window\n * @param {?Window} descendant potential descendant window\n * @return {boolean}\n */\nfunction isDescendantWindow(ancestor, descendant) {\n  for (let win = descendant; win && win != win.parent; win = win.parent) {\n    if (win == ancestor) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Removes any listenFors registed on listenSentinel that do not have\n * a contentWindow (the frame was removed from the DOM tree).\n * @param {!Array<!WindowEventsDef>} listenSentinel\n */\nfunction dropListenSentinel(listenSentinel) {\n  const noopData = dict({'sentinel': UNLISTEN_SENTINEL});\n\n  for (let i = listenSentinel.length - 1; i >= 0; i--) {\n    const windowEvents = listenSentinel[i];\n\n    if (!windowEvents.frame.contentWindow) {\n      listenSentinel.splice(i, 1);\n\n      const {events} = windowEvents;\n      for (const name in events) {\n        // Splice here, so that each unlisten does not shift the array\n        events[name].splice(0, Infinity).forEach((event) => {\n          event(noopData);\n        });\n      }\n    }\n  }\n}\n\n/**\n * Registers the global listenFor event listener if it has yet to be.\n * @param {?Window} parentWin\n */\nfunction registerGlobalListenerIfNeeded(parentWin) {\n  if (parentWin.listeningFors) {\n    return;\n  }\n  const listenForListener = function (event) {\n    if (!getData(event)) {\n      return;\n    }\n    const data = parseIfNeeded(getData(event));\n\n    if (!data || !data['sentinel']) {\n      return;\n    }\n\n    const listenForEvents = getListenForEvents(\n      parentWin,\n      data['sentinel'],\n      event.origin,\n      event.source\n    );\n    if (!listenForEvents) {\n      return;\n    }\n\n    let listeners = listenForEvents[data['type']];\n    if (!listeners) {\n      return;\n    }\n\n    // We slice to avoid issues with adding another listener or unlistening\n    // during iteration. We could move to a Doubly Linked List with\n    // backtracking, but that's overly complicated.\n    listeners = listeners.slice();\n    for (let i = 0; i < listeners.length; i++) {\n      const listener = listeners[i];\n      listener(data, event.source, event.origin, event);\n    }\n  };\n\n  parentWin.addEventListener('message', listenForListener);\n}\n\n/**\n * Allows listening for message from the iframe. Returns an unlisten\n * function to remove the listener.\n *\n * @param {?Element} iframe\n * @param {string} typeOfMessage\n * @param {?function(!JsonObject, !Window, string, !MessageEvent)} callback Called when a\n *     message of this type arrives for this iframe.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @param {boolean=} opt_includingNestedWindows set to true if messages from\n *     nested frames should also be accepted.\n * @param {boolean=} opt_allowOpaqueOrigin set to true if messages from\n       opaque origins (origin == null) are allowed.\n * @return {!UnlistenDef}\n */\nexport function listenFor(\n  iframe,\n  typeOfMessage,\n  callback,\n  opt_is3P,\n  opt_includingNestedWindows,\n  opt_allowOpaqueOrigin\n) {\n  devAssert(iframe.src, 'only iframes with src supported');\n  devAssert(\n    !iframe.parentNode,\n    'cannot register events on an attached ' +\n      'iframe. It will cause hair-pulling bugs like #2942'\n  );\n  devAssert(callback);\n  const parentWin = iframe.ownerDocument.defaultView;\n\n  registerGlobalListenerIfNeeded(parentWin);\n\n  const listenForEvents = getOrCreateListenForEvents(\n    parentWin,\n    iframe,\n    opt_is3P\n  );\n\n  const iframeOrigin = parseUrlDeprecated(iframe.src).origin;\n  let events =\n    listenForEvents[typeOfMessage] || (listenForEvents[typeOfMessage] = []);\n\n  let unlisten;\n  let listener = function (data, source, origin, event) {\n    const sentinel = data['sentinel'];\n\n    // Exclude messages that don't satisfy amp sentinel rules.\n    if (sentinel == 'amp') {\n      // For `amp` sentinel, nested windows are not allowed\n      if (source != iframe.contentWindow) {\n        return;\n      }\n\n      // For `amp` sentinel origin must match unless opaque origin is allowed\n      const isOpaqueAndAllowed = origin == 'null' && opt_allowOpaqueOrigin;\n      if (iframeOrigin != origin && !isOpaqueAndAllowed) {\n        return;\n      }\n    }\n\n    // Exclude nested frames if necessary.\n    // Note that the source was already verified to be either the contentWindow\n    // of the iframe itself or a descendant window within it.\n    if (!opt_includingNestedWindows && source != iframe.contentWindow) {\n      return;\n    }\n\n    if (data.sentinel == UNLISTEN_SENTINEL) {\n      unlisten();\n      return;\n    }\n    callback(data, source, origin, event);\n  };\n\n  events.push(listener);\n\n  return (unlisten = function () {\n    if (listener) {\n      const index = events.indexOf(listener);\n      if (index > -1) {\n        events.splice(index, 1);\n      }\n      // Make sure references to the unlisten function do not keep\n      // alive too much.\n      listener = null;\n      events = null;\n      callback = null;\n    }\n  });\n}\n\n/**\n * Returns a promise that resolves when one of given messages has been observed\n * for the first time. And remove listener for all other messages.\n * @param {!Element} iframe\n * @param {string|!Array<string>} typeOfMessages\n * @param {boolean=} opt_is3P\n * @return {!Promise<!{data: !JsonObject, source: !Window, origin: string, event: !MessageEvent}>}\n */\nexport function listenForOncePromise(iframe, typeOfMessages, opt_is3P) {\n  const unlistenList = [];\n  if (typeof typeOfMessages == 'string') {\n    typeOfMessages = [typeOfMessages];\n  }\n  return new Promise((resolve) => {\n    for (let i = 0; i < typeOfMessages.length; i++) {\n      const message = typeOfMessages[i];\n      const unlisten = listenFor(\n        iframe,\n        message,\n        (data, source, origin, event) => {\n          for (let i = 0; i < unlistenList.length; i++) {\n            unlistenList[i]();\n          }\n          resolve({data, source, origin, event});\n        },\n        opt_is3P\n      );\n      unlistenList.push(unlisten);\n    }\n  });\n}\n\n/**\n * Posts a message to the iframe.\n * @param {!Element} iframe The iframe.\n * @param {string} type Type of the message.\n * @param {!JsonObject} object Message payload.\n * @param {string} targetOrigin origin of the target.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n */\nexport function postMessage(iframe, type, object, targetOrigin, opt_is3P) {\n  postMessageToWindows(\n    iframe,\n    [{win: iframe.contentWindow, origin: targetOrigin}],\n    type,\n    object,\n    opt_is3P\n  );\n}\n\n/**\n * Posts an identical message to multiple target windows with the same\n * sentinel.\n * The message is serialized only once.\n * @param {!Element} iframe The iframe.\n * @param {!Array<{win: !Window, origin: string}>} targets to send the message\n *     to, pairs of window and its origin.\n * @param {string} type Type of the message.\n * @param {!JsonObject} object Message payload.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n */\nexport function postMessageToWindows(iframe, targets, type, object, opt_is3P) {\n  if (!iframe.contentWindow) {\n    return;\n  }\n  object['type'] = type;\n  object['sentinel'] = getSentinel_(iframe, opt_is3P);\n  let payload = object;\n  if (opt_is3P) {\n    // Serialize ourselves because that is much faster in Chrome.\n    payload = 'amp-' + JSON.stringify(object);\n  }\n  for (let i = 0; i < targets.length; i++) {\n    const target = targets[i];\n    target.win./*OK*/ postMessage(payload, target.origin);\n  }\n}\n\n/**\n * Gets the sentinel string.\n * @param {!Element} iframe The iframe.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @return {string} Sentinel string.\n * @private\n */\nfunction getSentinel_(iframe, opt_is3P) {\n  return opt_is3P ? iframe.getAttribute('data-amp-3p-sentinel') : 'amp';\n}\n\n/**\n * JSON parses event.data if it needs to be\n * @param {*} data\n * @return {?JsonObject} object message\n * @private\n * @visibleForTesting\n */\nexport function parseIfNeeded(data) {\n  if (typeof data == 'string') {\n    if (data.charAt(0) == '{') {\n      data =\n        tryParseJson(data, (e) => {\n          dev().warn(\n            'IFRAME-HELPER',\n            'Postmessage could not be parsed. ' +\n              'Is it in a valid JSON format?',\n            e\n          );\n        }) || null;\n    } else if (isAmpMessage(data)) {\n      data = deserializeMessage(data);\n    } else {\n      data = null;\n    }\n  }\n  return /** @type {?JsonObject} */ (data);\n}\n\n/**\n * Manages a postMessage API for an iframe with a subscription message and\n * a way to broadcast messages to all subscribed windows, which\n * in turn must all be descendants of the contentWindow of the iframe.\n */\nexport class SubscriptionApi {\n  /**\n   * @param {!Element} iframe The iframe.\n   * @param {string} type Type of the subscription message.\n   * @param {boolean} is3p set to true if the iframe is 3p.\n   * @param {function(!JsonObject, !Window, string)} requestCallback Callback\n   *     invoked whenever a new window subscribes.\n   */\n  constructor(iframe, type, is3p, requestCallback) {\n    /** @private @const {!Element} */\n    this.iframe_ = iframe;\n    /** @private @const {boolean} */\n    this.is3p_ = is3p;\n    /** @private @const {!Array<{win: !Window, origin: string}>} */\n    this.clientWindows_ = [];\n\n    /** @private @const {!UnlistenDef} */\n    this.unlisten_ = listenFor(\n      this.iframe_,\n      type,\n      (data, source, origin) => {\n        // This message might be from any window within the iframe, we need\n        // to keep track of which windows want to be sent updates.\n        if (!this.clientWindows_.some((entry) => entry.win == source)) {\n          this.clientWindows_.push({win: source, origin});\n        }\n        requestCallback(data, source, origin);\n      },\n      this.is3p_,\n      // For 3P frames we also allow nested frames within them to subscribe..\n      this.is3p_ /* opt_includingNestedWindows */\n    );\n  }\n\n  /**\n   * Sends a message to all subscribed windows.\n   * @param {string} type Type of the message.\n   * @param {!JsonObject} data Message payload.\n   */\n  send(type, data) {\n    // Remove clients that have been removed from the DOM.\n    remove(this.clientWindows_, (client) => !client.win.parent);\n    postMessageToWindows(\n      this.iframe_,\n      this.clientWindows_,\n      type,\n      data,\n      this.is3p_\n    );\n  }\n\n  /**\n   * Destroys iframe.\n   */\n  destroy() {\n    this.unlisten_();\n    this.clientWindows_.length = 0;\n  }\n}\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nexport function looksLikeTrackingIframe(element) {\n  const {height, width} = element.getLayoutSize();\n  // This heuristic is subject to change.\n  if (width > 10 || height > 10) {\n    return false;\n  }\n  // Iframe is not tracking iframe if open with user interaction\n  return !closestAncestorElementBySelector(element, '.i-amphtml-overlay');\n}\n\n// Most common ad sizes\n// Array of [width, height] pairs.\nconst adSizes = [\n  [300, 250],\n  [320, 50],\n  [300, 50],\n  [320, 100],\n];\n\n/**\n * Guess whether this element might be an ad.\n * @param {!Element} element An amp-iframe element.\n * @return {boolean}\n * @visibleForTesting\n */\nexport function isAdLike(element) {\n  const {height, width} = element.getLayoutSize();\n  for (let i = 0; i < adSizes.length; i++) {\n    const refWidth = adSizes[i][0];\n    const refHeight = adSizes[i][1];\n    if (refHeight > height) {\n      continue;\n    }\n    if (refWidth > width) {\n      continue;\n    }\n    // Fuzzy matching to account for padding.\n    if (height - refHeight <= 20 && width - refWidth <= 20) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * @param {!Element} iframe\n * @return {!Element}\n */\nexport function disableScrollingOnIframe(iframe) {\n  addAttributesToElement(iframe, dict({'scrolling': 'no'}));\n\n  // This shouldn't work, but it does on Firefox.\n  // https://stackoverflow.com/a/15494969\n  setStyle(iframe, 'overflow', 'hidden');\n\n  return iframe;\n}\n\n/**\n * Returns true if win's properties can be accessed and win is defined.\n * This functioned is used to determine if a window is cross-domained\n * from the perspective of the current window.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function canInspectWindow(win) {\n  // TODO: this is not reliable.  The compiler assumes that property reads are\n  // side-effect free.  The recommended fix is to use goog.reflect.sinkValue\n  // but since we're not using the closure library I'm not sure how to do this.\n  // See https://github.com/google/closure-compiler/issues/3156\n  try {\n    // win['test'] could be truthy but not true the compiler shouldn't be able\n    // to optimize this check away.\n    return !!win.location.href && (win['test'] || true);\n  } catch (unusedErr) {\n    return false;\n  }\n}\n\n/** @const {string} */\nexport const FIE_EMBED_PROP = '__AMP_EMBED__';\n\n/**\n * Returns the embed created using `installFriendlyIframeEmbed` or `null`.\n * Caution: This will only return the FIE after the iframe has 'loaded'. If you\n * are checking before this signal you may be in a race condition that returns\n * null.\n * @param {!HTMLIFrameElement} iframe\n * @return {?./friendly-iframe-embed.FriendlyIframeEmbed}\n */\nexport function getFriendlyIframeEmbedOptional(iframe) {\n  return /** @type {?./friendly-iframe-embed.FriendlyIframeEmbed} */ (\n    iframe[FIE_EMBED_PROP]\n  );\n}\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isInFie(element) {\n  return (\n    element.classList.contains('i-amphtml-fie') ||\n    !!closestAncestorElementBySelector(element, '.i-amphtml-fie')\n  );\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {LogLevel, devAssert} from '../../../src/log';\nimport {scopedQuerySelectorAll} from '../../../src/core/dom/query';\nimport {tryResolve} from '../../../src/core/data-structures/promise';\n\n/** @typedef {function(!Element): (boolean|!Promise<boolean>)} */\nlet ElementPredicate_1_0_Def; // eslint-disable-line google-camelcase/google-camelcase\n\n/**\n * A log type is an abstract rule or best practice that should be followed when\n * constructing a story.  This is internal to this file, which handles finding\n * specific instances of these log types, and returning them as log entries.\n *\n * message: (required) The message shown to developers in development mode if\n *     the best practice is not followed.\n * level: (required) The log level at which this entry should be logged.\n * moreInfo: (optional) A URL to a page containing additional documentation on\n *     the best practice.\n * selector: (optional) A selector to be queried on the currently-active page,\n *     and whose results will be subject to the best practice (given that they\n *     also match the precondition).  If unspecified, the amp-story-page itself\n *     is assumed to be subject to the best practice.\n * precondition: (optional) A predicate that takes an element and returns true\n *     if the specified element should be subject to the best practice.  If\n *     unspecified, all elements that match the selector are subject to the best\n *     practice.\n * predicate: (optional) A predicate that takes an element and returns true if\n *     the element follows the best practice, or false otherwise.  If\n *     unspecified, all elements are assumed not to follow the best practice.\n *\n * @typedef {{\n *   message: string,\n *   level: !LogLevel,\n *   moreInfo: (string|undefined),\n *   selector: (string|undefined),\n *   precondition: (!ElementPredicate_1_0_Def|undefined),\n *   predicate: (!ElementPredicate_1_0_Def|undefined),\n * }}\n */\nlet AmpStoryLogType_1_0_Def; // eslint-disable-line google-camelcase/google-camelcase\n\n/**\n * A log entry is a more concrete version of a rule or best practice; it refers\n * to whether a specific element on a specific page of a specific story conforms\n * to a given best practice.\n *\n * @typedef {{\n *   element: !Element,\n *   rootElement: !Element,\n *   message: string,\n *   level: !LogLevel,\n *   conforms: boolean,\n *   moreInfo: (string|undefined),\n * }}\n */\nexport let AmpStoryLogEntryDef;\n\n/** @private @const {string} */\nconst AMPPROJECT_DOCS = 'https://www.ampproject.org/docs';\n\n/**\n * @param {!HTMLMediaElement} el\n * @return {!Promise<Image>}\n */\nfunction getPosterFromVideo(el) {\n  return new Promise((resolve, reject) => {\n    const poster = new Image();\n    poster.onload = () => resolve(poster);\n    poster.onerror = reject;\n    poster.src = el.getAttribute('poster');\n  });\n}\n\n/** @enum {!AmpStoryLogType_1_0_Def} */\nconst LogType = {\n  /** Errors */\n  VIDEOS_POSTER_SPECIFIED: {\n    message: 'Videos should specify a poster image.',\n    moreInfo: AMPPROJECT_DOCS + '/reference/components/amp-video#poster',\n    selector: 'video:not([poster])',\n    level: LogLevel.ERROR,\n  },\n\n  /** Warnings */\n  IMAGES_MAX_720P_OR_SRCSET: {\n    message:\n      'Images should not be larger than 720p.  If you wish to use' +\n      ' images that are larger than 720p, you should specify a srcset.',\n    moreInfo: AMPPROJECT_DOCS + '/guides/responsive/art_direction#srcset',\n    selector: 'img:not([srcset])',\n    predicate: (el) => el.naturalWidth <= 720 && el.naturalHeight <= 1280,\n    level: LogLevel.WARN,\n  },\n\n  IMAGES_PORTRAIT: {\n    message: 'Full-bleed images should be in portrait orientation.',\n    selector: 'amp-story-grid-layer[template=\"fill\"] > amp-img > img',\n    predicate: (el) => el.naturalWidth < el.naturalHeight,\n    level: LogLevel.WARN,\n  },\n\n  VIDEOS_MAX_720P: {\n    message: 'Videos should not be larger than 720p.',\n    selector: 'video',\n    predicate: (el) => el.videoWidth <= 720 && el.videoHeight <= 1280,\n    level: LogLevel.WARN,\n  },\n\n  VIDEOS_PORTRAIT: {\n    message: 'Full-bleed videos should be in portrait orientation.',\n    selector: 'amp-story-grid-layer[template=\"fill\"] > amp-video > video',\n    predicate: (el) => el.videoWidth < el.videoHeight,\n    level: LogLevel.WARN,\n  },\n\n  VIDEO_POSTER_MAX_720P: {\n    message: 'Video poster images should not be larger than 720p.',\n    selector: 'video[poster]',\n    predicate: (el) =>\n      getPosterFromVideo(el).then((poster) => {\n        return poster.naturalWidth <= 720 && poster.naturalHeight <= 1280;\n      }),\n    level: LogLevel.WARN,\n  },\n\n  VIDEO_POSTER_POTRAIT: {\n    message:\n      'Poster images for full-bleed videos should be in portrait ' +\n      'orientation.',\n    selector:\n      'amp-story-grid-layer[template=\"fill\"] > amp-video > video[poster]',\n    predicate: (el) =>\n      getPosterFromVideo(el).then(\n        (poster) => poster.naturalWidth < poster.naturalHeight\n      ),\n    level: LogLevel.WARN,\n  },\n};\n\n/**\n * Gets the log type associated with the specified key.\n * @param {string} logTypeKey\n * @return {!AmpStoryLogType_1_0_Def}\n */\nfunction getLogType(logTypeKey) {\n  const logType = LogType[logTypeKey];\n  devAssert(logType, `There is no log type \"${logTypeKey}\".`);\n  devAssert(\n    logType.message,\n    `Log type \"${logTypeKey}\" has no associated message.`\n  );\n  devAssert(\n    logType.level,\n    `Log type \"${logTypeKey}\" has no associated log level.`\n  );\n\n  return logType;\n}\n\n/**\n * @param {!Element} rootElement\n * @param {!AmpStoryLogType_1_0_Def} logType\n * @param {!Element} element\n * @return {!Promise<!AmpStoryLogEntryDef>}\n */\nfunction getLogEntry(rootElement, logType, element) {\n  const predicate = logType.predicate || ((unusedEl) => false);\n\n  return tryResolve(() => predicate(element)).then((conforms) => {\n    return new Promise((resolve) => {\n      resolve({\n        rootElement,\n        element,\n        conforms,\n        level: logType.level,\n        message: logType.message,\n        moreInfo: logType.moreInfo,\n      });\n    });\n  });\n}\n\n/**\n * @param {!Element} rootElement\n * @param {!AmpStoryLogType_1_0_Def} logType\n * @return {!Array<!Promise<!AmpStoryLogEntryDef>>}\n */\nfunction getLogEntriesForType(rootElement, logType) {\n  const precondition = logType.precondition || ((unusedEl) => true);\n\n  const elements = logType.selector\n    ? [].slice.call(scopedQuerySelectorAll(rootElement, logType.selector))\n    : [rootElement];\n\n  return elements\n    .filter(precondition)\n    .map(getLogEntry.bind(/** thisArg */ null, rootElement, logType));\n}\n\n/**\n * @param {!AmpStoryLogEntryDef} logEntryA\n * @param {!AmpStoryLogEntryDef} logEntryB\n * @return {number}\n */\nfunction logEntryCompareFn(logEntryA, logEntryB) {\n  if (logEntryA.conforms == logEntryB.conforms) {\n    // For entries within that are all conformant or all non-conformant, sort by\n    // log level, with most severe entries first and least severe entries last.\n    return logEntryA.level <= logEntryB.level ? -1 : 1;\n  } else {\n    // false < true, so non-conformant issues go before conformant ones.\n    return logEntryA.conforms < logEntryB.conforms ? -1 : 1;\n  }\n}\n\n/**\n * Gets a promise which yields a list of log entries for the specified element.\n * @param {!Element} rootElement\n * @return {!Promise<!Array<!AmpStoryLogEntryDef>>}\n */\nexport function getLogEntries(rootElement) {\n  const logEntryPromises = Object.keys(LogType).reduce((entries, key) => {\n    const logType = getLogType(key);\n    const newEntries = getLogEntriesForType(rootElement, logType);\n    return entries.concat(newEntries);\n  }, []);\n\n  return Promise.all(logEntryPromises).then((logEntries) => {\n    return logEntries.sort(logEntryCompareFn);\n  });\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  MEDIA_LOAD_FAILURE_SRC_PROPERTY,\n  listen,\n} from '../../../src/event-helper';\nimport {Services} from '../../../src/services';\nimport {TickLabel} from '../../../src/core/constants/enums';\nimport {dev} from '../../../src/log';\nimport {escapeCssSelectorIdent} from '../../../src/core/dom/css-selectors';\nimport {lastChildElement, matches} from '../../../src/core/dom/query';\nimport {registerServiceBuilder} from '../../../src/service';\nimport {urls} from '../../../src/config';\n\n/**\n * Media status.\n * @enum\n */\nconst Status = {\n  ERRORED: 0,\n  PAUSED: 1,\n  PLAYING: 2,\n  WAITING: 3,\n};\n\n/**\n * Cache serving status.\n * @enum\n */\nconst CacheState = {\n  ORIGIN: 0, // Served from origin.\n  ORIGIN_CACHE_MISS: 1, // Served from origin even though cache URL was present.\n  CACHE: 2, // Served from cache.\n};\n\n/**\n * Video is first page status.\n * @enum\n */\nconst FirstPageState = {\n  NOT_ON_FIRST_PAGE: 0, // Video is not on the first page.\n  ON_FIRST_PAGE: 1, // Video is on the first page.\n};\n\n/**\n * @typedef {{\n *   start: number,\n *   playing: number,\n *   waiting: number,\n * }}\n */\nlet TimeStampsDef;\n\n/**\n * @typedef {{\n *   error: ?number,\n *   jointLatency: number,\n *   rebuffers: number,\n *   rebufferTime: number,\n *   watchTime: number\n * }}\n */\nlet MetricsDef;\n\n/**\n * @typedef {{\n *   media: !HTMLMediaElement,\n *   status: number,\n *   unlisteners: !Array<!UnlistenDef>,\n *   timeStamps: !TimeStampsDef,\n *   metrics: !MetricsDef\n * }}\n */\nlet MediaEntryDef;\n\n/** @type {number} */\nconst MINIMUM_TIME_THRESHOLD_MS = 1000;\n\n/** @type {number} */\nconst REBUFFER_THRESHOLD_MS = 250;\n\n/** @type {string} */\nconst TAG = 'media-performance-metrics';\n\n/**\n * Util function to retrieve the media performance metrics service. Ensures we\n * can retrieve the service synchronously from the amp-story codebase without\n * running into race conditions.\n * @param  {!Window} win\n * @return {!MediaPerformanceMetricsService}\n */\nexport const getMediaPerformanceMetricsService = (win) => {\n  let service = Services.mediaPerformanceMetricsService(win);\n\n  if (!service) {\n    service = new MediaPerformanceMetricsService(win);\n    registerServiceBuilder(win, 'media-performance-metrics', function () {\n      return service;\n    });\n  }\n\n  return service;\n};\n\n/**\n * Media performance metrics service.\n * @final\n */\nexport class MediaPerformanceMetricsService {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!WeakMap<HTMLMediaElement|EventTarget|null, !MediaEntryDef>} */\n    this.mediaMap_ = new WeakMap();\n\n    /** @private @const {!../../../src/service/performance-impl.Performance} */\n    this.performanceService_ = Services.performanceFor(win);\n\n    /** @private @const {!../../../src/service/url-impl.Url} */\n    this.urlService_ = Services.urlForDoc(win.document.body);\n  }\n\n  /**\n   * Identifies if the viewer is able to track performance. If the document is\n   * not embedded, there is no messaging channel, so no performance tracking is\n   * needed since there is nobody to forward the events.\n   * @return {boolean}\n   */\n  isPerformanceTrackingOn() {\n    return this.performanceService_.isPerformanceTrackingOn();\n  }\n\n  /**\n   * Starts recording performance metrics for a a given HTMLMediaElement. This\n   * method has to be called right before trying to play the media. This allows\n   * to reliably record joint latency (time to play), as well initial buffering.\n   * @param {!HTMLMediaElement} media\n   */\n  startMeasuring(media) {\n    // Media must start paused in order to determine the joint latency, and\n    // initial buffering, if any.\n    if (!media.paused) {\n      dev().expectedError(TAG, 'media must start paused');\n      return;\n    }\n\n    const unlisteners = this.listen_(media);\n    const mediaEntry = this.getNewMediaEntry_(media, unlisteners);\n    this.mediaMap_.set(media, mediaEntry);\n\n    // Checks if the media already errored (eg: could have failed the source\n    // selection).\n    if (\n      media.error ||\n      media[MEDIA_LOAD_FAILURE_SRC_PROPERTY] === media.currentSrc\n    ) {\n      mediaEntry.metrics.error = media.error ? media.error.code : 0;\n      mediaEntry.status = Status.ERRORED;\n    }\n  }\n\n  /**\n   * Stops recording, computes, and sends performance metrics collected for the\n   * given media element.\n   * @param {!HTMLMediaElement} media\n   * @param {boolean=} sendMetrics\n   */\n  stopMeasuring(media, sendMetrics = true) {\n    const mediaEntry = this.mediaMap_.get(media);\n\n    if (!mediaEntry) {\n      return;\n    }\n\n    mediaEntry.unlisteners.forEach((unlisten) => unlisten());\n    this.mediaMap_.delete(media);\n\n    switch (mediaEntry.status) {\n      case Status.PLAYING:\n        this.addWatchTime_(mediaEntry);\n        break;\n      case Status.WAITING:\n        this.addRebuffer_(mediaEntry);\n        break;\n    }\n\n    if (sendMetrics) {\n      this.sendMetrics_(mediaEntry);\n    }\n  }\n\n  /**\n   * @param {!MediaEntryDef} mediaEntry\n   * @private\n   */\n  sendMetrics_(mediaEntry) {\n    const {media, metrics} = mediaEntry;\n\n    let videoCacheState;\n    if (this.urlService_.isProxyOrigin(media.currentSrc)) {\n      videoCacheState = CacheState.CACHE;\n    } else {\n      // Media is served from origin. Checks if there was a cached source.\n      const {hostname} = this.urlService_.parse(urls.cdn);\n      videoCacheState = media.querySelector(\n        `[src*=\"${escapeCssSelectorIdent(hostname)}\"]`\n      )\n        ? CacheState.ORIGIN_CACHE_MISS\n        : CacheState.ORIGIN;\n    }\n    this.performanceService_.tickDelta(\n      TickLabel.VIDEO_CACHE_STATE,\n      videoCacheState\n    );\n    this.performanceService_.tickDelta(\n      TickLabel.VIDEO_ON_FIRST_PAGE,\n      matches(media, `amp-story-page:first-of-type ${media.tagName}`)\n        ? FirstPageState.ON_FIRST_PAGE\n        : FirstPageState.NOT_ON_FIRST_PAGE\n    );\n\n    // If the media errored.\n    if (metrics.error !== null) {\n      this.performanceService_.tickDelta(\n        TickLabel.VIDEO_ERROR,\n        metrics.error || 0\n      );\n      this.performanceService_.flush();\n      return;\n    }\n\n    // If the user was on the video for less than one second, ignore the metrics\n    // (eg: users tapping through a story, or scrolling through content).\n    if (\n      !metrics.jointLatency &&\n      Date.now() - mediaEntry.timeStamps.start < MINIMUM_TIME_THRESHOLD_MS\n    ) {\n      return;\n    }\n\n    // If the playback did not start.\n    if (!metrics.jointLatency) {\n      this.performanceService_.tickDelta(\n        TickLabel.VIDEO_ERROR,\n        5 /* Custom error code */\n      );\n      this.performanceService_.flush();\n      return;\n    }\n\n    const rebufferRate = Math.round(\n      (metrics.rebufferTime / (metrics.rebufferTime + metrics.watchTime)) * 100\n    );\n\n    this.performanceService_.tickDelta(\n      TickLabel.VIDEO_JOINT_LATENCY,\n      metrics.jointLatency\n    );\n    this.performanceService_.tickDelta(\n      TickLabel.VIDEO_WATCH_TIME,\n      metrics.watchTime\n    );\n    this.performanceService_.tickDelta(\n      TickLabel.VIDEO_REBUFFERS,\n      metrics.rebuffers\n    );\n    this.performanceService_.tickDelta(\n      TickLabel.VIDEO_REBUFFER_RATE,\n      rebufferRate\n    );\n    if (metrics.rebuffers) {\n      this.performanceService_.tickDelta(\n        TickLabel.VIDEO_MEAN_TIME_BETWEEN_REBUFFER,\n        Math.round(metrics.watchTime / metrics.rebuffers)\n      );\n    }\n    this.performanceService_.flush();\n  }\n\n  /**\n   * @param {!HTMLMediaElement} media\n   * @param {!Array<!UnlistenDef>} unlisteners\n   * @return {!MediaEntryDef}\n   * @private\n   */\n  getNewMediaEntry_(media, unlisteners) {\n    return {\n      media,\n      status: Status.PAUSED,\n      unlisteners,\n      timeStamps: {\n        start: Date.now(),\n        playing: 0,\n        waiting: 0,\n      },\n      metrics: {\n        error: null,\n        jointLatency: 0,\n        meanTimeBetweenRebuffers: 0,\n        rebuffers: 0,\n        rebufferTime: 0,\n        watchTime: 0,\n      },\n    };\n  }\n\n  /**\n   * Increments the watch time with the duration from the last `playing` event.\n   * @param {!MediaEntryDef} mediaEntry\n   * @private\n   */\n  addWatchTime_(mediaEntry) {\n    mediaEntry.metrics.watchTime += Date.now() - mediaEntry.timeStamps.playing;\n  }\n\n  /**\n   * Increments the rebuffer time with the duration from the last `waiting`\n   * event, and increments the rebuffers count.\n   * @param {!MediaEntryDef} mediaEntry\n   * @private\n   */\n  addRebuffer_(mediaEntry) {\n    const rebufferTime = Date.now() - mediaEntry.timeStamps.waiting;\n    if (rebufferTime > REBUFFER_THRESHOLD_MS) {\n      mediaEntry.metrics.rebuffers++;\n      mediaEntry.metrics.rebufferTime += rebufferTime;\n    }\n  }\n\n  /**\n   * @param {!HTMLMediaElement} media\n   * @return {!Array<!UnlistenDef>}\n   * @private\n   */\n  listen_(media) {\n    const unlisteners = [\n      listen(media, 'ended', this.onPauseOrEnded_.bind(this)),\n      listen(media, 'pause', this.onPauseOrEnded_.bind(this)),\n      listen(media, 'playing', this.onPlaying_.bind(this)),\n      listen(media, 'waiting', this.onWaiting_.bind(this)),\n    ];\n\n    // If the media element has no `src`, it will try to load the sources in\n    // document order. If the last source errors, then the media element\n    // loading errored.\n    let errorTarget = media;\n    if (!media.hasAttribute('src')) {\n      errorTarget = lastChildElement(\n        media,\n        (child) => child.tagName === 'SOURCE'\n      );\n    }\n    unlisteners.push(\n      listen(errorTarget || media, 'error', this.onError_.bind(this))\n    );\n\n    return unlisteners;\n  }\n\n  /**\n   * @param {!Event} event\n   * @private\n   */\n  onError_(event) {\n    // Media error target could be either HTMLMediaElement or HTMLSourceElement.\n    const media =\n      event.target.tagName === 'SOURCE' ? event.target.parent : event.target;\n    const mediaEntry = this.mediaMap_.get(media);\n\n    mediaEntry.metrics.error = media.error ? media.error.code : 0;\n    mediaEntry.status = Status.ERRORED;\n  }\n\n  /**\n   * @param {!Event} event\n   * @private\n   */\n  onPauseOrEnded_(event) {\n    const mediaEntry = this.mediaMap_.get(event.target);\n\n    if (mediaEntry.status === Status.PLAYING) {\n      this.addWatchTime_(mediaEntry);\n    }\n    mediaEntry.status = Status.PAUSED;\n  }\n\n  /**\n   * @param {!Event} event\n   * @private\n   */\n  onPlaying_(event) {\n    const mediaEntry = this.mediaMap_.get(event.target);\n    const {metrics, timeStamps} = mediaEntry;\n\n    if (!metrics.jointLatency) {\n      metrics.jointLatency = Date.now() - timeStamps.start;\n    }\n\n    if (mediaEntry.status === Status.WAITING) {\n      this.addRebuffer_(mediaEntry);\n    }\n\n    timeStamps.playing = Date.now();\n    mediaEntry.status = Status.PLAYING;\n  }\n\n  /**\n   * @param {!Event} event\n   * @private\n   */\n  onWaiting_(event) {\n    const mediaEntry = this.mediaMap_.get(event.target);\n    const {timeStamps} = mediaEntry;\n\n    if (mediaEntry.status === Status.PLAYING) {\n      this.addWatchTime_(mediaEntry);\n    }\n\n    timeStamps.waiting = Date.now();\n    mediaEntry.status = Status.WAITING;\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {dev} from '../log';\nimport {setStyles} from '../style';\n\n/**\n * @param {!Window} win\n * @return {!Promise<boolean>}\n */\nexport function detectIsAutoplaySupported(win) {\n  // To detect autoplay, we create a video element and call play on it, if\n  // `paused` is true after `play()` call, autoplay is supported. Although\n  // this is unintuitive, it works across browsers and is currently the lightest\n  // way to detect autoplay without using a data source.\n  const detectionElement = /** @type {!HTMLVideoElement} */ (\n    win.document.createElement('video')\n  );\n\n  // NOTE(aghassemi): We need both attributes and properties due to Chrome and\n  // Safari differences when dealing with non-attached elements.\n  detectionElement.setAttribute('muted', '');\n  detectionElement.setAttribute('playsinline', '');\n  detectionElement.setAttribute('webkit-playsinline', '');\n  detectionElement.setAttribute('height', '0');\n  detectionElement.setAttribute('width', '0');\n\n  detectionElement.muted = true;\n  detectionElement.playsInline = true;\n  detectionElement['playsinline'] = true;\n  detectionElement['webkitPlaysinline'] = true;\n\n  setStyles(detectionElement, {\n    position: 'fixed',\n    top: '0',\n    width: '0',\n    height: '0',\n    opacity: '0',\n  });\n\n  // Promise wrapped this way to catch both sync throws and async rejections.\n  // More info: https://github.com/tc39/proposal-promise-try\n  new Promise((resolve) => resolve(detectionElement.play())).catch(() => {\n    // Suppress any errors, useless to report as they are expected.\n  });\n\n  return Promise.resolve(!detectionElement.paused);\n}\n\nconst AUTOPLAY_SUPPORTED_WIN_PROP = '__AMP_AUTOPLAY';\n\n/**\n * Determines autoplay support.\n *\n * Note that even if platfrom supports autoplay, users or browsers can disable\n * autoplay to save data / battery. This detects both platfrom support and\n * when autoplay has been disabled by the user.\n *\n * @param {!Window} win\n * @return {!Promise<boolean>}\n */\nexport function isAutoplaySupported(win) {\n  if (win[AUTOPLAY_SUPPORTED_WIN_PROP] == null) {\n    win[AUTOPLAY_SUPPORTED_WIN_PROP] = detectIsAutoplaySupported(win);\n  }\n  return win[AUTOPLAY_SUPPORTED_WIN_PROP];\n}\n\n/**\n * @param {!Window} win\n * @visibleForTesting\n */\nexport function resetIsAutoplaySupported(win) {\n  delete win[AUTOPLAY_SUPPORTED_WIN_PROP];\n}\n\n/**\n * @param {!Element} element\n * @return {!Element}\n */\nexport function getInternalVideoElementFor(element) {\n  return dev().assertElement(element.querySelector('video, iframe'));\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isExperimentOn} from '../../../src/experiments';\n\n/**\n * Returns true if new inline attachment UI is enabled.\n * @param {!Window} win\n * @return {boolean}\n */\nexport const isPageAttachmentUiV2ExperimentOn = (win) => {\n  return isExperimentOn(win, 'amp-story-page-attachment-ui-v2');\n};\n", "export const CSS = \"@keyframes open-attachment-fly-in{0%{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}@keyframes open-attachment-icon{0%{transform:translateY(14px)}to{transform:translateY(0)}}@keyframes open-attachment-icon-explode{0%{transform:scale(0)}to{transform:scale(1);box-shadow:0 1px 3px 1px rgba(0,0,0,0.12)}}@keyframes open-attachment-icon-color{0%{background:#fff}to{background:rgba(0,0,0,0.87);text-shadow:none}}@keyframes open-attachment-bar-left{0%{transform:rotate(0deg)}to{transform:rotate(-30deg)}}@keyframes open-attachment-bar-right{0%{transform:rotate(0deg)}to{transform:rotate(30deg)}}.i-amphtml-story-page-open-attachment{display:none!important}.i-amphtml-story-page-open-attachment[active]{display:-ms-flexbox!important;display:flex!important;-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important;-ms-flex-direction:column!important;flex-direction:column!important;position:absolute!important;bottom:0!important;left:0!important;width:100%!important;background:linear-gradient(0,rgba(0,0,0,0.15),transparent)!important;pointer-events:none!important;z-index:3!important;animation:open-attachment-fly-in 0.3s cubic-bezier(0.4,0,0.2,1) both!important;-webkit-touch-callout:default!important;text-decoration:none!important}.i-amphtml-story-page-open-attachment>*{cursor:pointer!important;pointer-events:auto!important}.i-amphtml-story-page-open-attachment-icon{display:block!important;height:32px!important;width:32px!important;cursor:pointer!important;animation:open-attachment-icon 0.2s cubic-bezier(0.4,0,0.2,1) 2s both!important}.i-amphtml-story-page-open-attachment-icon:after{content:\\\"\\\"!important;position:absolute!important;top:0!important;left:0!important;height:100%!important;width:100%!important;background:#fff!important;border-radius:100%!important;z-index:-1!important;animation:open-attachment-icon-explode 0.25s cubic-bezier(0.4,0,0.2,1) 2s both!important}.i-amphtml-story-outlink-page-open-attachment-bar-left,.i-amphtml-story-outlink-page-open-attachment-bar-right,.i-amphtml-story-page-open-attachment-bar-left,.i-amphtml-story-page-open-attachment-bar-right{position:absolute!important;display:block!important;height:3px!important;width:12px!important;border-radius:3px!important;top:14px!important}.i-amphtml-story-page-open-attachment-bar-left{left:6px!important;animation:open-attachment-icon-color 0.25s cubic-bezier(0.4,0,0.2,1) 2s both,open-attachment-bar-left 0.3s cubic-bezier(0.4,0,0.2,1) both!important}.i-amphtml-story-page-open-attachment-bar-right{right:6px!important;animation:open-attachment-icon-color 0.25s cubic-bezier(0.4,0,0.2,1) 2s both,open-attachment-bar-right 0.3s cubic-bezier(0.4,0,0.2,1) both!important}.i-amphtml-story-page-open-attachment-label{position:relative!important;padding:12px 32px 20px!important;height:16px!important;max-width:calc(100% - 64px)!important;color:#fff!important;font-family:Roboto,sans-serif!important;font-size:16px!important;font-weight:700!important;letter-spacing:0.3px;line-height:16px!important;overflow:hidden!important;text-overflow:ellipsis!important;text-shadow:0px 0px 6px rgba(0,0,0,0.36)!important;white-space:nowrap!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment{--i-amphtml-chip-background-color:hsla(0,0%,100%,0.5)!important;--i-amphtml-img-background-color:#fff!important;--i-amphtml-label-text-color:#fff!important;--i-amphtml-arrow-color:#000!important;--i-amphtml-page-attachment-ui-animation-delay:1s!important;--i-amphtml-page-attachment-ui-animation-duration:.6s!important}[theme=dark].i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment{--i-amphtml-chip-background-color:rgba(0,0,0,0.5)!important;--i-amphtml-img-background-color:#000!important;--i-amphtml-label-text-color:#000!important;--i-amphtml-arrow-color:#fff!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment{display:-ms-flexbox!important;display:flex!important;-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important;-ms-flex-direction:column!important;flex-direction:column!important;position:absolute!important;bottom:0!important;left:0!important;width:100%!important;background:linear-gradient(0,rgba(0,0,0,0.15),transparent)!important;pointer-events:none!important;-webkit-touch-callout:default!important;text-decoration:none!important;animation:none!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment:not([active]){visibility:hidden!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-label{font-family:Roboto,sans-serif!important;font-size:16px!important;font-weight:700!important;letter-spacing:0.3px;overflow:hidden!important;text-overflow:ellipsis!important;white-space:nowrap!important;max-width:210px!important;line-height:18px!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-open-attachment-label{color:var(--i-amphtml-label-text-color)!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-inline-page-attachment-chip{background-color:var(--i-amphtml-chip-background-color)!important;display:-ms-flexbox!important;display:flex!important;border-radius:24px!important;-ms-flex-align:center!important;align-items:center!important;overflow:hidden!important;margin-bottom:12px!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment[active] .i-amphtml-story-inline-page-attachment-chip{animation:tap-scale var(--i-amphtml-page-attachment-ui-animation-duration) var(--i-amphtml-page-attachment-ui-animation-delay) both!important}.i-amphtml-story-inline-page-attachment-chip:only-child{margin-bottom:20px!important}.i-amphtml-story-inline-page-attachment-img{background-size:contain!important;background-repeat:no-repeat!important;height:48px!important;width:48px!important;background-color:var(--i-amphtml-img-background-color)!important}.i-amphtml-story-inline-page-attachment-img:nth-child(2){margin-inline-start:1px!important}.i-amphtml-story-inline-page-attachment-arrow{position:relative!important;height:32px!important;width:32px!important;border-radius:50%!important;background-color:var(--i-amphtml-img-background-color)!important}.i-amphtml-story-inline-page-attachment-arrow:not(:only-child){margin:8px!important}.i-amphtml-story-inline-page-attachment-arrow:before{content:\\\"\\\"!important;position:absolute!important;top:0!important;left:0!important;width:100%!important;height:100%!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='8'%3E%3Cpath d='M18 7.7c-.2 0-.5-.1-.7-.2l-7.3-4-7.3 4c-.7.4-1.6.2-2-.6-.4-.7-.1-1.6.6-2l8-4.4c.5-.2 1-.2 1.5 0l8 4.4c.7.4 1 1.3.6 2-.4.5-.9.8-1.4.8z'/%3E%3C/svg%3E\\\")!important;background-position:50%!important;background-size:auto!important;background-repeat:no-repeat!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment[active] .i-amphtml-story-inline-page-attachment-arrow:before{animation:move-up-arrow-in-circle var(--i-amphtml-page-attachment-ui-animation-duration) var(--i-amphtml-page-attachment-ui-animation-delay) both!important}[theme=dark] .i-amphtml-story-inline-page-attachment-arrow:before{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg fill='%23fff' xmlns='http://www.w3.org/2000/svg' width='20' height='8'%3E%3Cpath d='M18 7.7c-.2 0-.5-.1-.7-.2l-7.3-4-7.3 4c-.7.4-1.6.2-2-.6-.4-.7-.1-1.6.6-2l8-4.4c.5-.2 1-.2 1.5 0l8 4.4c.7.4 1 1.3.6 2-.4.5-.9.8-1.4.8z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-amp-story-page-attachment-ui-v2:not([href]) .i-amphtml-story-page-attachment-label{margin-bottom:20px!important;color:var(--i-amphtml-label-text-color)!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment{--i-amphtml-outlink-cta-background-color:#fff!important;--i-amphtml-outlink-cta-text-color:#000!important;background:linear-gradient(0,rgba(0,0,0,0.25),transparent)!important}[theme=dark].i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment{--i-amphtml-outlink-cta-background-color:#000!important;--i-amphtml-outlink-cta-text-color:#fff!important;background:linear-gradient(0,hsla(0,0%,100%,0.25),hsla(0,0%,100%,0))!important}[href].i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment{background:none!important}[href].i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment[active]{animation:tap-scale var(--i-amphtml-page-attachment-ui-animation-duration) var(--i-amphtml-page-attachment-ui-animation-delay) both!important}.i-amphtml-story-outlink-page-attachment-arrow{display:block!important;cursor:pointer!important;margin-bottom:10px!important;fill:var(--i-amphtml-outlink-cta-background-color)!important;filter:drop-shadow(0px 2px 6px rgba(0,0,0,0.3))!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-open-attachment[active] .i-amphtml-story-outlink-page-attachment-arrow{animation:move-up-arrow var(--i-amphtml-page-attachment-ui-animation-duration) var(--i-amphtml-page-attachment-ui-animation-delay) both!important}@keyframes move-up-arrow{0%,to{opacity:1;transform:translateY(0)}45%{opacity:0;transform:translateY(-7px)}45.01%{transform:translateY(5px)}}@keyframes move-up-arrow-in-circle{0%,to{opacity:1;transform:translateY(0)}45%{opacity:0;transform:translateY(-4px)}45.01%{transform:translateY(3px)}}@keyframes tap-scale{0%,to{transform:scale(1)}45%{transform:scale(.9)}}.i-amphtml-story-outlink-page-attachment-outlink-chip{display:-ms-flexbox!important;display:flex!important;position:relative!important;padding:10px 6px!important;margin:0 0 20px!important;height:16px!important;max-width:calc(100% - 64px)!important;border-radius:30px!important;background:var(--i-amphtml-outlink-cta-background-color)!important;place-items:center!important;box-shadow:0px 4px 10px rgba(0,0,0,.15)!important}.i-amphtml-story-outlink-page-attachment-img{height:24px!important;width:24px!important;vertical-align:middle!important;background-size:cover!important;background-repeat:no-repeat!important;background-position:50%!important;border-radius:50%!important}[href] .i-amphtml-story-page-attachment-label{padding-inline-start:6px!important;padding-inline-end:8px!important;color:var(--i-amphtml-outlink-cta-text-color)!important}.i-amphtml-story-outlink-page-attachment-label:only-child{padding-inline-start:8px!important}.i-amphtml-story-page-open-attachment-link-icon{width:24px!important;height:24px!important;fill:var(--i-amphtml-outlink-cta-text-color)!important}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story-open-page-attachment.css*/\";\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @typedef {!Array<{query: ?MediaQueryList, value: string}>} */\nlet ExprDef;\n\nconst TRUE_VALUE = '1';\n\nexport class MediaQueryProps {\n  /**\n   * @param {!Window} win\n   * @param {function()} callback\n   */\n  constructor(win, callback) {\n    /** @private @const */\n    this.win_ = win;\n\n    /** @private @const */\n    this.callback_ = callback;\n\n    /** @private {!Object<string, !ExprDef>} */\n    this.exprMap_ = {};\n\n    /** @private {?Object<string, !ExprDef>} */\n    this.prevExprMap_ = null;\n  }\n\n  /**\n   * Starts the resolution pass. After the pass is complete the new queries\n   * will be tracked and the old queries will be untracked.\n   */\n  start() {\n    this.prevExprMap_ = this.exprMap_;\n    this.exprMap_ = {};\n  }\n\n  /**\n   * @param {string} queryString\n   * @return {boolean} value\n   */\n  resolveMatchQuery(queryString) {\n    // This will create a list query like this:\n    // `[{query: matchMedia(queryString), value: true}, {query: null, value: false}]`\n    return (\n      this.resolve_(queryString, parseMediaQueryMatchExpr, TRUE_VALUE) ===\n      TRUE_VALUE\n    );\n  }\n\n  /**\n   * @param {string} exprString\n   * @return {string} value\n   */\n  resolveListQuery(exprString) {\n    return this.resolve_(exprString, parseMediaQueryListExpr, '');\n  }\n\n  /**\n   * Completes the resolution pass. The new queries are tracked for changes\n   * and the old queries are untracked.\n   */\n  complete() {\n    for (const k in this.prevExprMap_) {\n      if (!(k in this.exprMap_)) {\n        toggleOnChange(this.prevExprMap_[k], this.callback_, false);\n      }\n    }\n    this.prevExprMap_ = null;\n  }\n\n  /**\n   * Stops tracking of all queries.\n   */\n  dispose() {\n    for (const k in this.exprMap_) {\n      toggleOnChange(this.exprMap_[k], this.callback_, false);\n    }\n    this.exprMap_ = {};\n  }\n\n  /**\n   * @param {string} exprString\n   * @param {function(!Window, string):!ExprDef} parser\n   * @param {string} emptyExprValue\n   * @return {string} value\n   */\n  resolve_(exprString, parser, emptyExprValue) {\n    if (!exprString.trim()) {\n      return emptyExprValue;\n    }\n    let expr = this.exprMap_[exprString] || this.prevExprMap_[exprString];\n    if (!expr) {\n      expr = parser(this.win_, exprString);\n      toggleOnChange(expr, this.callback_, true);\n    }\n    this.exprMap_[exprString] = expr;\n    return resolveMediaQueryListExpr(expr);\n  }\n}\n\n/**\n * @param {!Window} win\n * @param {string} queryString\n * @return {!ExprDef}\n */\nfunction parseMediaQueryMatchExpr(win, queryString) {\n  const query = win.matchMedia(queryString);\n  return [\n    {query, value: TRUE_VALUE},\n    {query: null, value: ''},\n  ];\n}\n\n/**\n * @param {!Window} win\n * @param {string} exprString\n * @return {!ExprDef}\n */\nfunction parseMediaQueryListExpr(win, exprString) {\n  return (\n    exprString\n      .split(',')\n      .map((part) => {\n        part = part.replace(/\\s+/g, ' ').trim();\n        if (part.length == 0) {\n          return;\n        }\n\n        let queryString;\n        let value;\n\n        // Process the expression from the end.\n        const lastChar = part.charAt(part.length - 1);\n        let div;\n        if (lastChar == ')') {\n          // Value is the CSS function, e.g. `calc(50vw + 10px)`.\n\n          // First, skip to the opening paren.\n          let parens = 1;\n          div = part.length - 2;\n          for (; div >= 0; div--) {\n            const c = part.charAt(div);\n            if (c == '(') {\n              parens--;\n            } else if (c == ')') {\n              parens++;\n            }\n            if (parens == 0) {\n              break;\n            }\n          }\n\n          // Then, skip to the begining to the function's name.\n          const funcEnd = div - 1;\n          if (div > 0) {\n            div--;\n            for (; div >= 0; div--) {\n              const c = part.charAt(div);\n              if (\n                !(\n                  c == '%' ||\n                  c == '-' ||\n                  c == '_' ||\n                  (c >= 'a' && c <= 'z') ||\n                  (c >= 'A' && c <= 'Z') ||\n                  (c >= '0' && c <= '9')\n                )\n              ) {\n                break;\n              }\n            }\n          }\n          if (div >= funcEnd) {\n            // Invalid condition.\n            return null;\n          }\n        } else {\n          // Value is the length or a percent: accept a wide range of values,\n          // including invalid values - they will be later asserted to conform\n          // to exact CSS length or percent value.\n          div = part.length - 2;\n          for (; div >= 0; div--) {\n            const c = part.charAt(div);\n            if (\n              !(\n                c == '%' ||\n                c == '.' ||\n                (c >= 'a' && c <= 'z') ||\n                (c >= 'A' && c <= 'Z') ||\n                (c >= '0' && c <= '9')\n              )\n            ) {\n              break;\n            }\n          }\n        }\n        if (div >= 0) {\n          queryString = part.substring(0, div + 1).trim();\n          value = part.substring(div + 1).trim();\n        } else {\n          value = part;\n          queryString = undefined;\n        }\n\n        if (!value) {\n          return null;\n        }\n\n        const query = queryString ? win.matchMedia(queryString) : null;\n        return {query, value};\n      })\n      // Remove any items that did not match the regex above and are\n      // undefined as a result.\n      .filter(Boolean)\n  );\n}\n\n/**\n * @param {!ExprDef} expr\n * @return {string} value\n */\nfunction resolveMediaQueryListExpr(expr) {\n  for (let i = 0; i < expr.length; i++) {\n    const {query, value} = expr[i];\n    if (!query || query.matches) {\n      return value;\n    }\n  }\n  return '';\n}\n\n/**\n * @param {!ExprDef} expr\n * @param {function()} callback\n * @param {boolean} on\n */\nfunction toggleOnChange(expr, callback, on) {\n  for (let i = 0; i < expr.length; i++) {\n    const {query} = expr[i];\n    if (query) {\n      // The `onchange` API is preferred, but the IE only supports\n      // the `addListener/removeListener` APIs.\n      if (query.onchange !== undefined) {\n        query.onchange = on ? callback : null;\n      } else {\n        if (on) {\n          query.addListener(callback);\n        } else {\n          query.removeListener(callback);\n        }\n      }\n    }\n  }\n}\n\n/**\n * Detect prefers-reduced-motion.\n * Native animations will not run when a device is set up to reduced motion.\n * In that case, we need to disable all animation treatment, and whatever\n * setup changes that depend on an animation running later on.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function prefersReducedMotion(win) {\n  return !!win.matchMedia('(prefers-reduced-motion: reduce)')?.matches;\n}\n", "export const CSS = \":host{all:initial!important;color:initial!important}.i-amphtml-story-draggable-drawer-header{display:-ms-flexbox!important;display:flex!important;position:relative!important;height:40px!important;background:#fff!important;border-radius:8px 8px 0 0!important;box-shadow:0 1px 2px 1px rgba(0,0,0,0.12)!important;z-index:1!important}.i-amphtml-story-draggable-drawer-theme-dark{background:#202125!important}.i-amphtml-story-page-attachment-close-button{display:block!important;padding:8px!important;height:24px!important;width:24px!important;background-origin:content-box!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 36 36' fill='rgba(0, 0, 0, 0.54)'%3E%3Cpath d='M28.5 9.62 26.38 7.5 18 15.88 9.62 7.5 7.5 9.62 15.88 18 7.5 26.38l2.12 2.12L18 20.12l8.38 8.38 2.12-2.12L20.12 18z'/%3E%3Cpath d='M0 0h36v36H0z' fill='none'/%3E%3C/svg%3E\\\")!important;background-repeat:no-repeat!important;color:rgba(0,0,0,0.87)!important;cursor:pointer!important;box-sizing:content-box!important;border:none!important;background-color:transparent!important}.i-amphtml-story-draggable-drawer-theme-dark .i-amphtml-story-page-attachment-close-button{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 36 36' fill='rgba(255, 255, 255, 0.54)'%3E%3Cpath d='M28.5 9.62 26.38 7.5 18 15.88 9.62 7.5 7.5 9.62 15.88 18 7.5 26.38l2.12 2.12L18 20.12l8.38 8.38 2.12-2.12L20.12 18z'/%3E%3Cpath d='M0 0h36v36H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-page-attachment-title{font-family:Roboto,sans-serif!important;width:calc(100% - 80px)!important;padding-right:40px!important;color:rgba(0,0,0,0.87)!important;font-size:16px!important;line-height:40px!important;overflow:hidden!important;text-align:center!important;text-overflow:ellipsis!important;white-space:nowrap!important}.i-amphtml-story-draggable-drawer-theme-dark .i-amphtml-story-page-attachment-close-button,.i-amphtml-story-draggable-drawer-theme-dark .i-amphtml-story-page-attachment-title{color:#9aa0a6!important}.i-amphtml-story-draggable-drawer-header-attachment-remote{display:none!important}:host{border-radius:inherit!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-draggable-drawer-header{--i-amphtml-draggable-drawer-background-color:#fff!important;--i-amphtml-draggable-drawer-text-color:#202125!important;--i-amphtml-draggable-drawer-handle-color:rgba(0,0,0,.2)!important;background:var(--i-amphtml-draggable-drawer-background-color)!important;-ms-flex-pack:center!important;justify-content:center!important;box-shadow:none!important;border-radius:inherit!important;height:auto!important;position:sticky!important;top:0!important}[theme=dark].i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-draggable-drawer-header{--i-amphtml-draggable-drawer-background-color:#202125!important;--i-amphtml-draggable-drawer-text-color:#fff!important;--i-amphtml-draggable-drawer-handle-color:hsla(0,0%,100%,0.2)!important}:not([desktop]).i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-draggable-drawer-header{height:20px!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-draggable-drawer-header .i-amphtml-story-draggable-drawer-header-title-and-close{opacity:1!important;height:44px!important;width:100%!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important;background:var(--i-amphtml-draggable-drawer-background-color)!important;border-radius:inherit!important}:not([desktop]).i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-draggable-drawer-header .i-amphtml-story-draggable-drawer-header-title-and-close{position:absolute!important;opacity:0!important;transition:opacity .3s,visibility .3s!important;visibility:hidden!important}:not([desktop]).i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-draggable-drawer-header.i-amphtml-story-draggable-drawer-header-stuck .i-amphtml-story-draggable-drawer-header-title-and-close{opacity:1!important;visibility:visible!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-title{font-size:14px!important;position:absolute!important;padding:0!important;color:var(--i-amphtml-draggable-drawer-text-color)!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-close-button{margin-inline-start:auto!important;width:14px!important;height:14px!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 14 14'%3E%3Cpath fill='rgba(0, 0, 0, .4)' d='M13.295 2.115a.997.997 0 1 0-1.41-1.41L7 5.59 2.115.705a.997.997 0 1 0-1.41 1.41L5.59 7 .705 11.885a.997.997 0 1 0 1.41 1.41L7 8.41l4.885 4.885a.997.997 0 1 0 1.41-1.41L8.41 7l4.885-4.885z'/%3E%3C/svg%3E\\\")!important;padding:15px!important}[theme=dark].i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-close-button{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 14 14'%3E%3Cpath fill='rgba(255, 255, 255, .4)' d='M13.295 2.115a.997.997 0 1 0-1.41-1.41L7 5.59 2.115.705a.997.997 0 1 0-1.41 1.41L5.59 7 .705 11.885a.997.997 0 1 0 1.41 1.41L7 8.41l4.885 4.885a.997.997 0 1 0 1.41-1.41L8.41 7l4.885-4.885z'/%3E%3C/svg%3E\\\")!important}:not([desktop]).i-amphtml-amp-story-page-attachment-ui-v2:before{content:\\\"\\\"!important;position:absolute!important;top:8px!important;width:40px!important;height:3px!important;background-color:var(--i-amphtml-draggable-drawer-handle-color)!important;border-radius:3px!important}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story-draggable-drawer-header.css*/\";\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Action,\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {CSS} from '../../../build/amp-story-draggable-drawer-header-1.0.css';\nimport {Layout} from '../../../src/layout';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {Services} from '../../../src/services';\nimport {closest} from '../../../src/core/dom/query';\nimport {createShadowRootWithStyle} from './utils';\nimport {dev, devAssert} from '../../../src/log';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {htmlFor} from '../../../src/static-template';\nimport {isAmpElement} from '../../../src/dom';\nimport {isPageAttachmentUiV2ExperimentOn} from './amp-story-page-attachment-ui-v2';\nimport {listen} from '../../../src/event-helper';\nimport {resetStyles, setImportantStyles, toggle} from '../../../src/style';\n\n/** @const {number} */\nconst TOGGLE_THRESHOLD_PX = 50;\n\n/**\n * @enum {number}\n */\nexport const DrawerState = {\n  CLOSED: 0,\n  DRAGGING_TO_CLOSE: 1,\n  DRAGGING_TO_OPEN: 2,\n  OPEN: 3,\n};\n\n/**\n * Drawer's template.\n * @param {!Element} element\n * @return {!Element}\n */\nconst getTemplateEl = (element) => {\n  return htmlFor(element)`\n    <div class=\"i-amphtml-story-draggable-drawer\">\n      <div class=\"i-amphtml-story-draggable-drawer-container\">\n        <div class=\"i-amphtml-story-draggable-drawer-content\"></div>\n      </div>\n    </div>`;\n};\n\n/**\n * Drawer's header template.\n * @param {!Element} element\n * @return {!Element}\n */\nconst getHeaderEl = (element) => {\n  return htmlFor(element)`\n    <div class=\"i-amphtml-story-draggable-drawer-header\"></div>`;\n};\n\n/**\n * Abstract draggable drawer.\n * @abstract\n */\nexport class DraggableDrawer extends AMP.BaseElement {\n  /** @override @nocollapse */\n  static prerenderAllowed() {\n    return false;\n  }\n\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n\n    /** @private {!Array<!Element>} AMP components within the drawer. */\n    this.ampComponents_ = [];\n\n    /** @protected {?Element} */\n    this.containerEl_ = null;\n\n    /** @protected {?Element} */\n    this.contentEl_ = null;\n\n    /** @private {number} Max value in pixels that can be dragged when opening the drawer. */\n    this.dragCap_ = Infinity;\n\n    /** @protected {?Element} */\n    this.headerEl_ = null;\n\n    /** @private {boolean} */\n    this.ignoreCurrentSwipeYGesture_ = false;\n\n    /** @protected {!DrawerState} */\n    this.state_ = DrawerState.CLOSED;\n\n    /** @protected @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win);\n\n    /** @private {!Object} */\n    this.touchEventState_ = {\n      startX: 0,\n      startY: 0,\n      lastY: 0,\n      swipingUp: null,\n      isSwipeY: null,\n    };\n\n    /** @private {!Array<function()>} */\n    this.touchEventUnlisteners_ = [];\n\n    /** @private {number} Threshold in pixels above which the drawer opens itself. */\n    this.openThreshold_ = Infinity;\n\n    /**\n     * For amp-story-page-attachment-ui-v2 experiment\n     * Used for offsetting drag.\n     * @protected {?number}\n     */\n    this.spacerElHeight_ = null;\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return layout === Layout.NODISPLAY;\n  }\n\n  /** @override */\n  buildCallback() {\n    this.element.classList.add('amp-story-draggable-drawer-root');\n\n    const templateEl = getTemplateEl(this.element);\n    const headerShadowRootEl = this.win.document.createElement('div');\n    this.headerEl_ = getHeaderEl(this.element);\n\n    createShadowRootWithStyle(headerShadowRootEl, this.headerEl_, CSS);\n\n    this.containerEl_ = dev().assertElement(\n      templateEl.querySelector('.i-amphtml-story-draggable-drawer-container')\n    );\n    this.contentEl_ = dev().assertElement(\n      this.containerEl_.querySelector(\n        '.i-amphtml-story-draggable-drawer-content'\n      )\n    );\n\n    if (isPageAttachmentUiV2ExperimentOn(this.win)) {\n      const spacerEl = this.win.document.createElement('button');\n      spacerEl.classList.add('i-amphtml-story-draggable-drawer-spacer');\n      spacerEl.classList.add('i-amphtml-story-system-reset');\n      spacerEl.setAttribute('role', 'button');\n      const localizationService = getLocalizationService(\n        devAssert(this.element)\n      );\n      if (localizationService) {\n        const localizedCloseString = localizationService.getLocalizedString(\n          LocalizedStringId.AMP_STORY_CLOSE_BUTTON_LABEL\n        );\n        spacerEl.setAttribute('aria-label', localizedCloseString);\n      }\n      this.containerEl_.insertBefore(spacerEl, this.contentEl_);\n      this.contentEl_.appendChild(headerShadowRootEl);\n      this.element.classList.add('i-amphtml-amp-story-page-attachment-ui-v2');\n      this.headerEl_.classList.add('i-amphtml-amp-story-page-attachment-ui-v2');\n    } else {\n      templateEl.insertBefore(headerShadowRootEl, templateEl.firstChild);\n    }\n\n    this.element.appendChild(templateEl);\n    this.element.setAttribute('aria-hidden', true);\n  }\n\n  /** @override */\n  layoutCallback() {\n    this.initializeListeners_();\n\n    const walker = this.win.document.createTreeWalker(\n      this.element,\n      NodeFilter.SHOW_ELEMENT,\n      null /** filter */,\n      false /** entityReferenceExpansion */\n    );\n    while (walker.nextNode()) {\n      const el = dev().assertElement(walker.currentNode);\n      if (isAmpElement(el)) {\n        this.ampComponents_.push(el);\n        Services.ownersForDoc(this.element).setOwner(el, this.element);\n      }\n    }\n    return Promise.resolve();\n  }\n\n  /**\n   * @protected\n   */\n  initializeListeners_() {\n    this.storeService_.subscribe(\n      StateProperty.UI_STATE,\n      (uiState) => {\n        this.onUIStateUpdate_(uiState);\n      },\n      true /** callToInitialize */\n    );\n\n    if (isPageAttachmentUiV2ExperimentOn(this.win)) {\n      const spacerEl = dev().assertElement(\n        this.element.querySelector('.i-amphtml-story-draggable-drawer-spacer')\n      );\n\n      // Handle click on spacer element to close.\n      spacerEl.addEventListener('click', () => {\n        this.close_();\n      });\n\n      // For displaying sticky header on mobile.\n      new this.win.IntersectionObserver((e) => {\n        this.headerEl_.classList.toggle(\n          'i-amphtml-story-draggable-drawer-header-stuck',\n          !e[0].isIntersecting\n        );\n      }).observe(spacerEl);\n\n      // Update spacerElHeight_ on resize for drag offset.\n      new this.win.ResizeObserver((e) => {\n        this.spacerElHeight_ = e[0].contentRect.height;\n      }).observe(spacerEl);\n\n      // Reset scroll position on end of close transiton.\n      this.element.addEventListener('transitionend', (e) => {\n        if (\n          e.propertyName === 'transform' &&\n          this.state_ === DrawerState.CLOSED\n        ) {\n          this.containerEl_./*OK*/ scrollTop = 0;\n        }\n      });\n    }\n  }\n\n  /**\n   * Reacts to UI state updates.\n   * @param {!UIType} uiState\n   * @protected\n   */\n  onUIStateUpdate_(uiState) {\n    const isMobile = uiState === UIType.MOBILE;\n\n    isMobile\n      ? this.startListeningForTouchEvents_()\n      : this.stopListeningForTouchEvents_();\n\n    this.headerEl_.toggleAttribute('desktop', !isMobile);\n  }\n\n  /**\n   * @private\n   */\n  startListeningForTouchEvents_() {\n    // If the element is a direct descendant of amp-story-page, authorize\n    // swiping up by listening to events at the page level. Otherwise, only\n    // authorize swiping down to close by listening to events at the current\n    // element level.\n    const parentEl = this.element.parentElement;\n    const el = dev().assertElement(\n      parentEl.tagName === 'AMP-STORY-PAGE' ? parentEl : this.element\n    );\n\n    this.touchEventUnlisteners_.push(\n      listen(el, 'touchstart', this.onTouchStart_.bind(this), {\n        capture: true,\n      })\n    );\n    this.touchEventUnlisteners_.push(\n      listen(el, 'touchmove', this.onTouchMove_.bind(this), {\n        capture: true,\n      })\n    );\n    this.touchEventUnlisteners_.push(\n      listen(el, 'touchend', this.onTouchEnd_.bind(this), {\n        capture: true,\n      })\n    );\n  }\n\n  /**\n   * @private\n   */\n  stopListeningForTouchEvents_() {\n    this.touchEventUnlisteners_.forEach((fn) => fn());\n    this.touchEventUnlisteners_ = [];\n  }\n\n  /**\n   * Helper to retrieve the touch coordinates from a TouchEvent.\n   * @param {!Event} event\n   * @return {?{x: number, y: number}}\n   * @private\n   */\n  getClientTouchCoordinates_(event) {\n    const {touches} = event;\n    if (!touches || touches.length < 1) {\n      return null;\n    }\n\n    const {clientX: x, clientY: y} = touches[0];\n    return {x, y};\n  }\n\n  /**\n   * Handles touchstart events to detect swipeY interactions.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchStart_(event) {\n    const coordinates = this.getClientTouchCoordinates_(event);\n    if (!coordinates) {\n      return;\n    }\n\n    this.touchEventState_.startX = coordinates.x;\n    this.touchEventState_.startY = coordinates.y;\n  }\n\n  /**\n   * Handles touchmove events to detect swipeY interactions.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchMove_(event) {\n    if (this.touchEventState_.isSwipeY === false) {\n      return;\n    }\n\n    const coordinates = this.getClientTouchCoordinates_(event);\n    if (!coordinates) {\n      return;\n    }\n\n    const {x, y} = coordinates;\n\n    this.touchEventState_.swipingUp = y < this.touchEventState_.lastY;\n    this.touchEventState_.lastY = y;\n\n    if (\n      this.state_ === DrawerState.CLOSED &&\n      !this.touchEventState_.swipingUp\n    ) {\n      return;\n    }\n\n    if (this.shouldStopPropagation_()) {\n      event.stopPropagation();\n    }\n\n    if (this.touchEventState_.isSwipeY === null) {\n      this.touchEventState_.isSwipeY =\n        Math.abs(this.touchEventState_.startY - y) >\n        Math.abs(this.touchEventState_.startX - x);\n      if (!this.touchEventState_.isSwipeY) {\n        return;\n      }\n    }\n\n    this.onSwipeY_({\n      event,\n      data: {\n        swipingUp: this.touchEventState_.swipingUp,\n        deltaY: y - this.touchEventState_.startY,\n        last: false,\n      },\n    });\n  }\n\n  /**\n   * Checks for when scroll event should be stopped from propagating.\n   * @return {boolean}\n   * @private\n   */\n  shouldStopPropagation_() {\n    return (\n      this.state_ !== DrawerState.CLOSED ||\n      (this.state_ === DrawerState.CLOSED && this.touchEventState_.swipingUp)\n    );\n  }\n\n  /**\n   * Handles touchend events to detect swipeY interactions.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchEnd_(event) {\n    if (this.touchEventState_.isSwipeY === true) {\n      this.onSwipeY_({\n        event,\n        data: {\n          swipingUp: this.touchEventState_.swipingUp,\n          deltaY: this.touchEventState_.lastY - this.touchEventState_.startY,\n          last: true,\n        },\n      });\n    }\n\n    this.touchEventState_.startX = 0;\n    this.touchEventState_.startY = 0;\n    this.touchEventState_.lastY = 0;\n    this.touchEventState_.swipingUp = null;\n    this.touchEventState_.isSwipeY = null;\n  }\n\n  /**\n   * Handles swipeY events, detected by the touch events listeners.\n   * @param {{event: !Event, data: !Object}} gesture\n   * @private\n   */\n  onSwipeY_(gesture) {\n    const {data} = gesture;\n\n    if (this.ignoreCurrentSwipeYGesture_) {\n      this.ignoreCurrentSwipeYGesture_ = !data.last;\n      return;\n    }\n\n    const {deltaY, swipingUp} = data;\n\n    // If the drawer is open, figure out if the user is trying to scroll the\n    // content, or actually close the drawer.\n    if (this.state_ === DrawerState.OPEN) {\n      const isContentSwipe = this.isDrawerContentDescendant_(\n        dev().assertElement(gesture.event.target)\n      );\n\n      // If user is swiping up, exit so the event bubbles up and maybe scrolls\n      // the drawer content.\n      // If user is swiping down and scrollTop is above zero, exit and let the\n      // user scroll the content.\n      // If user is swiping down and scrollTop is zero, don't exit and start\n      // dragging/closing the drawer.\n      if (\n        (isContentSwipe && deltaY < 0) ||\n        (isContentSwipe && deltaY > 0 && this.containerEl_./*OK*/ scrollTop > 0)\n      ) {\n        this.ignoreCurrentSwipeYGesture_ = true;\n        return;\n      }\n    }\n\n    gesture.event.preventDefault();\n\n    if (data.last === true) {\n      if (this.state_ === DrawerState.DRAGGING_TO_CLOSE) {\n        !swipingUp && deltaY > TOGGLE_THRESHOLD_PX\n          ? this.close_()\n          : this.open();\n      }\n\n      if (this.state_ === DrawerState.DRAGGING_TO_OPEN) {\n        swipingUp && -deltaY > TOGGLE_THRESHOLD_PX\n          ? this.open()\n          : this.close_();\n      }\n\n      return;\n    }\n\n    if (\n      this.state_ === DrawerState.DRAGGING_TO_OPEN &&\n      swipingUp &&\n      -deltaY > this.openThreshold_\n    ) {\n      this.open();\n      return;\n    }\n\n    this.drag_(deltaY);\n  }\n\n  /**\n   * Whether the element is a descendant of drawer-content.\n   * @param {!Element} element\n   * @return {boolean}\n   * @private\n   */\n  isDrawerContentDescendant_(element) {\n    return !!closest(\n      element,\n      (el) => {\n        return el.classList.contains(\n          'i-amphtml-story-draggable-drawer-content'\n        );\n      },\n      /* opt_stopAt */ this.element\n    );\n  }\n\n  /**\n   * Sets a swipe threshold in pixels above which the drawer opens itself.\n   * @param {number} openThreshold\n   * @protected\n   */\n  setOpenThreshold_(openThreshold) {\n    this.openThreshold_ = openThreshold;\n  }\n\n  /**\n   * Sets the max value in pixels that can be dragged when opening the drawer.\n   * @param {number} dragCap\n   * @protected\n   */\n  setDragCap_(dragCap) {\n    this.dragCap_ = dragCap;\n  }\n\n  /**\n   * Drags the drawer on the screen upon user interaction.\n   * @param {number} deltaY\n   * @private\n   */\n  drag_(deltaY) {\n    let translate;\n\n    switch (this.state_) {\n      case DrawerState.CLOSED:\n      case DrawerState.DRAGGING_TO_OPEN:\n        if (deltaY > 0) {\n          return;\n        }\n        this.state_ = DrawerState.DRAGGING_TO_OPEN;\n        let drag = Math.max(deltaY, -this.dragCap_);\n        if (isPageAttachmentUiV2ExperimentOn(this.win)) {\n          drag -= this.spacerElHeight_;\n        }\n        translate = `translate3d(0, calc(100% + ${drag}px), 0)`;\n        break;\n      case DrawerState.OPEN:\n      case DrawerState.DRAGGING_TO_CLOSE:\n        if (deltaY < 0) {\n          return;\n        }\n        this.state_ = DrawerState.DRAGGING_TO_CLOSE;\n        translate = `translate3d(0, ${deltaY}px, 0)`;\n        break;\n    }\n\n    this.mutateElement(() => {\n      setImportantStyles(this.element, {\n        transform: translate,\n        transition: 'none',\n        visibility: 'visible',\n      });\n    });\n  }\n\n  /**\n   * Fully opens the drawer from its current position.\n   * @param {boolean=} shouldAnimate\n   */\n  open(shouldAnimate = true) {\n    if (this.state_ === DrawerState.OPEN) {\n      return;\n    }\n\n    this.state_ = DrawerState.OPEN;\n\n    this.storeService_.dispatch(Action.TOGGLE_PAUSED, true);\n\n    this.mutateElement(() => {\n      this.element.setAttribute('aria-hidden', false);\n      resetStyles(this.element, ['transform', 'transition', 'visibility']);\n\n      if (!shouldAnimate) {\n        // Resets the 'transition' property, and removes this override in the\n        // next frame, after the element is positioned.\n        setImportantStyles(this.element, {transition: 'initial'});\n        this.mutateElement(() => resetStyles(this.element, ['transition']));\n      }\n\n      this.element.classList.add('i-amphtml-story-draggable-drawer-open');\n      toggle(dev().assertElement(this.containerEl_), true);\n    }).then(() => {\n      const owners = Services.ownersForDoc(this.element);\n      owners.scheduleLayout(this.element, this.ampComponents_);\n      owners.scheduleResume(this.element, this.ampComponents_);\n    });\n  }\n\n  /**\n   * Can be overriden for implementations using the browser history to close the\n   * drawer.\n   * @protected\n   */\n  close_() {\n    this.closeInternal_();\n  }\n\n  /**\n   * Fully closes the drawer from its current position.\n   * @param {boolean=} shouldAnimate\n   * @protected\n   */\n  closeInternal_(shouldAnimate = true) {\n    if (this.state_ === DrawerState.CLOSED) {\n      return;\n    }\n\n    this.state_ = DrawerState.CLOSED;\n\n    this.storeService_.dispatch(Action.TOGGLE_PAUSED, false);\n\n    this.mutateElement(() => {\n      this.element.setAttribute('aria-hidden', true);\n      resetStyles(this.element, ['transform', 'transition']);\n\n      if (!shouldAnimate) {\n        // Resets the 'transition' property, and removes this override in the\n        // next frame, after the element is positioned.\n        setImportantStyles(this.element, {transition: 'initial'});\n        this.mutateElement(() => resetStyles(this.element, ['transition']));\n      }\n\n      this.element.classList.remove('i-amphtml-story-draggable-drawer-open');\n    }).then(() => {\n      const owners = Services.ownersForDoc(this.element);\n      owners.schedulePause(this.element, this.ampComponents_);\n    });\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Gets state from History.\n * But IE11 throws if there is no state.\n *\n * @param {!History} history\n * @return {*}\n */\nexport function getState(history) {\n  try {\n    return history.state;\n  } catch (e) {\n    return null;\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {dict} from '../../../src/core/types/object';\nimport {getState} from '../../../src/core/window/history';\nimport {parseJson} from '../../../src/core/types/object/json';\n\nconst EXPIRATION_DURATION_MILLIS = 10 * 60 * 1000; // 10 Minutes\nconst CREATION_TIME = 'time';\nconst STATE = 'state';\n/** @visibleForTesting */\nexport const LOCAL_STORAGE_KEY = 'amp-story-state';\n\n/** @enum {string} */\nexport const HistoryState = {\n  ATTACHMENT_PAGE_ID: 'ampStoryAttachmentPageId',\n  NAVIGATION_PATH: 'ampStoryNavigationPath',\n};\n\n/**\n * Updates the value for a given state in the window history.\n * Also persists state in localStorage for 10 minutes, so that state is\n * persisted if Stories are shown within viewers that may recycle\n * iframes or webviews.\n * @param {!Window} win\n * @param {string} stateName\n * @param {string|boolean|Array<string>|null} value\n */\nexport function setHistoryState(win, stateName, value) {\n  const {history} = win;\n  const state = getState(history) || {};\n  const newHistory = {\n    ...state,\n    [stateName]: value,\n  };\n\n  history.replaceState(newHistory, '');\n  setLocalStorageState(win, newHistory);\n}\n\n/**\n * Returns the value of a given state of the window history or localStorage.\n * See `setHistoryState` for an explanation of the use of localStorage.\n * @param {!Window} win\n * @param {string} stateName\n * @return {string|boolean|Array<string>|null}\n */\nexport function getHistoryState(win, stateName) {\n  const {history} = win;\n  let state = getState(history);\n  // We do get an early state but without a navigation path. In that case we\n  // prefer localStorage.\n  if (!state || !state[stateName]) {\n    state = getLocalStorageState(win);\n  }\n  if (state) {\n    return /** @type {string|boolean|Array<string>|null} */ (\n      state[stateName] || null\n    );\n  }\n  return null;\n}\n\n/**\n * Get history state from localStorage.\n * @param {!Window} win\n * @return {*}\n */\nfunction getLocalStorageState(win) {\n  // We definitely don't want to restore state from localStorage if the URL\n  // is explicit about it.\n  const {hash} = win.location;\n  if (\n    hash.indexOf('page=') != -1 ||\n    hash.indexOf('ignoreLocalStorageHistory') != -1\n  ) {\n    return undefined;\n  }\n  const container = getLocalStorageStateContainer(win);\n  const holder = container && container[getDocumentKey(win)];\n  return holder && holder[STATE];\n}\n\n/**\n * Set history state in localStorage.\n * State is keyed off of the URL-minus fragment of the Story.\n * @param {!Window} win\n * @param {*} state\n */\nfunction setLocalStorageState(win, state) {\n  const container = getLocalStorageStateContainer(win);\n  container[getDocumentKey(win)] = {\n    [STATE]: state,\n    [CREATION_TIME]: Date.now(),\n  };\n  writeLocalStorage(win, container);\n}\n\n/**\n * Gets a dictionary of all history states on the current origin.\n * If an entry is expired, removes it from the set and writes the new\n * set back to storage.\n * @param {!Window} win\n * @return {!JsonObject}\n */\nfunction getLocalStorageStateContainer(win) {\n  const container = readLocalStorage(win);\n  if (!container) {\n    return dict();\n  }\n  const now = Date.now();\n  let expired = false;\n  Object.keys(container).forEach((href) => {\n    const item = container[href];\n    if (now > item[CREATION_TIME] + EXPIRATION_DURATION_MILLIS) {\n      delete container[href];\n      expired = true;\n    }\n  });\n  if (expired) {\n    writeLocalStorage(win, container);\n  }\n  return container;\n}\n\n/**\n * Returns the key under which we store state for the current document.\n * @param {!Window} win\n * @return {string}\n */\nfunction getDocumentKey(win) {\n  return win.location.href.replace(/\\#.*/, '');\n}\n\n/**\n * @param {!Window} win\n * @return {?JsonObject}\n */\nfunction readLocalStorage(win) {\n  try {\n    return parseJson(win.localStorage.getItem(LOCAL_STORAGE_KEY));\n  } catch (e) {\n    return null;\n  }\n}\n\n/**\n * @param {!Window} win\n * @param {JsonObject} container\n */\nfunction writeLocalStorage(win, container) {\n  try {\n    win.localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(container));\n  } catch (e) {}\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Action, StateProperty, UIType} from './amp-story-store-service';\nimport {DraggableDrawer, DrawerState} from './amp-story-draggable-drawer';\nimport {HistoryState, setHistoryState} from './history';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {Services} from '../../../src/services';\nimport {StoryAnalyticsEvent, getAnalyticsService} from './story-analytics';\nimport {buildOpenAttachmentElementLinkIcon} from './amp-story-open-page-attachment';\nimport {closest} from '../../../src/core/dom/query';\nimport {dev, devAssert} from '../../../src/log';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {getState} from '../../../src/core/window/history';\nimport {htmlFor, htmlRefs} from '../../../src/static-template';\nimport {isPageAttachmentUiV2ExperimentOn} from './amp-story-page-attachment-ui-v2';\nimport {removeElement} from '../../../src/dom';\nimport {setImportantStyles, toggle} from '../../../src/style';\n\nimport {triggerClickFromLightDom} from './utils';\n\n/** @const {string} */\nconst DARK_THEME_CLASS = 'i-amphtml-story-draggable-drawer-theme-dark';\n\n/**\n * Distance to swipe before opening attachment.\n * @const {number}\n */\nconst OPEN_THRESHOLD_PX = 150;\n\n/**\n * Max pixels to transform the remote attachment URL preview. Equivilent to the height of preview element.\n * @const {number}\n */\nconst DRAG_CAP_PX = 48;\n\n/**\n * Max pixels to transform the remote attachment URL preview. Equivilent to the height of preview element.\n * Used for the amp-story-outlink-page-attachment-v2 experiment.\n * @const {number}\n */\nconst DRAG_CAP_PX_V2 = 56;\n\n/**\n * Duration of post-tap URL preview progress bar animation minus 100ms.\n * The minus 100ms roughly accounts for the small system delay in opening a link.\n * Used for the amp-story-outlink-page-attachment-v2 experiment.\n * @const {number}\n */\nconst POST_TAP_ANIMATION_DURATION = 500;\n\n/**\n * @enum {string}\n */\nexport const AttachmentTheme = {\n  LIGHT: 'light', // default\n  DARK: 'dark',\n  CUSTOM: 'custom',\n};\n\n/**\n * @enum\n */\nconst AttachmentType = {\n  INLINE: 0,\n  OUTLINK: 1,\n};\n\n/**\n * AMP Story page attachment.\n */\nexport class AmpStoryPageAttachment extends DraggableDrawer {\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n\n    /** @private @const {!./story-analytics.StoryAnalyticsService} */\n    this.analyticsService_ = getAnalyticsService(this.win, this.element);\n\n    /** @private @const {!../../../src/service/history-impl.History} */\n    this.historyService_ = Services.historyForDoc(this.element);\n\n    /** @private {?AttachmentType} */\n    this.type_ = null;\n  }\n\n  /**\n   * @override\n   */\n  buildCallback() {\n    super.buildCallback();\n\n    const theme = this.element.getAttribute('theme')?.toLowerCase();\n    if (theme && AttachmentTheme.DARK === theme) {\n      if (isPageAttachmentUiV2ExperimentOn(this.win)) {\n        this.headerEl_.setAttribute('theme', theme);\n        this.element.setAttribute('theme', theme);\n      } else {\n        this.headerEl_.classList.add(DARK_THEME_CLASS);\n        this.element.classList.add(DARK_THEME_CLASS);\n      }\n    }\n\n    // Outlinks can be an amp-story-page-outlink or the legacy version,\n    // an amp-story-page-attachment with an href.\n    const isOutlink =\n      this.element.tagName === 'AMP-STORY-PAGE-OUTLINK' ||\n      this.element.hasAttribute('href');\n    this.type_ = isOutlink ? AttachmentType.OUTLINK : AttachmentType.INLINE;\n\n    if (this.type_ === AttachmentType.INLINE) {\n      this.buildInline_();\n    }\n\n    if (this.type_ === AttachmentType.OUTLINK) {\n      if (isPageAttachmentUiV2ExperimentOn(this.win)) {\n        this.buildRemoteV2_();\n      } else {\n        this.buildRemote_();\n      }\n    }\n\n    this.win.addEventListener('pageshow', (event) => {\n      // On browser back, Safari does not reload the page but resumes its cached\n      // version. This event's parameter lets us know when this happens so we\n      // can cleanup the remote opening animation.\n      if (event.persisted) {\n        this.closeInternal_(false /** shouldAnimate */);\n      }\n    });\n\n    toggle(this.element, true);\n    this.element.setAttribute('aria-live', 'assertive');\n  }\n\n  /**\n   * Builds inline page attachment's drawer UI.\n   * @private\n   */\n  buildInline_() {\n    const closeButtonEl = htmlFor(this.element)`\n          <button class=\"i-amphtml-story-page-attachment-close-button\" aria-label=\"close\"\n              role=\"button\">\n          </button>`;\n    const localizationService = getLocalizationService(devAssert(this.element));\n\n    const titleEl = htmlFor(this.element)`\n    <span class=\"i-amphtml-story-page-attachment-title\"></span>`;\n\n    if (localizationService) {\n      const localizedCloseString = localizationService.getLocalizedString(\n        LocalizedStringId.AMP_STORY_CLOSE_BUTTON_LABEL\n      );\n      closeButtonEl.setAttribute('aria-label', localizedCloseString);\n    }\n\n    if (this.element.hasAttribute('data-title')) {\n      titleEl.textContent = this.element.getAttribute('data-title');\n    }\n\n    if (isPageAttachmentUiV2ExperimentOn(this.win)) {\n      const titleAndCloseWrapperEl = this.headerEl_.appendChild(\n        htmlFor(this.element)`\n            <div class=\"i-amphtml-story-draggable-drawer-header-title-and-close\"></div>`\n      );\n      titleAndCloseWrapperEl.appendChild(closeButtonEl);\n      titleAndCloseWrapperEl.appendChild(titleEl);\n    } else {\n      this.headerEl_.appendChild(closeButtonEl);\n      this.headerEl_.appendChild(titleEl);\n    }\n\n    const templateEl = this.element.querySelector(\n      '.i-amphtml-story-draggable-drawer'\n    );\n\n    while (this.element.firstChild && this.element.firstChild !== templateEl) {\n      this.contentEl_.appendChild(this.element.firstChild);\n    }\n\n    // Ensures the content of the attachment won't be rendered/loaded until we\n    // actually need it.\n    toggle(dev().assertElement(this.containerEl_), true);\n  }\n\n  /**\n   * Builds remote page attachment's drawer UI.\n   * Can be removed when amp-story-page-attachment-ui-v2 is laumched.\n   * @private\n   */\n  buildRemote_() {\n    this.setDragCap_(DRAG_CAP_PX);\n    this.setOpenThreshold_(OPEN_THRESHOLD_PX);\n\n    this.headerEl_.classList.add(\n      'i-amphtml-story-draggable-drawer-header-attachment-remote'\n    );\n    this.element.classList.add('i-amphtml-story-page-attachment-remote');\n    // Use an anchor element to make this a real link in vertical rendering.\n    const link = htmlFor(this.element)`\n    <a class=\"i-amphtml-story-page-attachment-remote-content\" target=\"_blank\">\n      <span class=\"i-amphtml-story-page-attachment-remote-title\"></span>\n      <span class=\"i-amphtml-story-page-attachment-remote-icon\"></span>\n    </a>`;\n    // URL will be validated and resolved based on the canonical URL if relative\n    // when navigating.\n    link.setAttribute('href', this.element.getAttribute('href'));\n    this.contentEl_.appendChild(link);\n\n    this.contentEl_.querySelector(\n      '.i-amphtml-story-page-attachment-remote-title'\n    ).textContent =\n      this.element.getAttribute('data-title') ||\n      Services.urlForDoc(this.element).getSourceOrigin(\n        this.element.getAttribute('href') ||\n          // Used if amp-story-page-attachment-ui-v2 is off and\n          // this.elmement is an amp-story-page-outlink.\n          this.element.querySelector('a').getAttribute('href')\n      );\n  }\n\n  /**\n   * Builds remote V2 page attachment's drawer UI.\n   * Used for the amp-story-page-attachment-ui-v2 experiment.\n   * @private\n   */\n  buildRemoteV2_() {\n    this.setDragCap_(DRAG_CAP_PX_V2);\n    this.setOpenThreshold_(OPEN_THRESHOLD_PX);\n\n    this.headerEl_.classList.add(\n      'i-amphtml-story-draggable-drawer-header-attachment-remote'\n    );\n    this.element.classList.add('i-amphtml-story-page-attachment-remote');\n    // Use an anchor element to make this a real link in vertical rendering.\n    const link = htmlFor(this.element)`\n      <a class=\"i-amphtml-story-page-attachment-remote-content\" target=\"_blank\">\n        <span class=\"i-amphtml-story-page-attachment-remote-title\"><span ref=\"openStringEl\"></span><span ref=\"urlStringEl\"></span></span>\n        <svg class=\"i-amphtml-story-page-attachment-remote-icon\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 48 48\"><path d=\"M38 38H10V10h14V6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h28c2.21 0 4-1.79 4-4V24h-4v14zM28 6v4h7.17L15.51 29.66l2.83 2.83L38 12.83V20h4V6H28z\"></path></svg>\n      </a>`;\n\n    // For backwards compatibility if element is amp-story-page-outlink.\n    const hrefAttr =\n      this.element.tagName === 'AMP-STORY-PAGE-OUTLINK'\n        ? this.element.querySelector('a').getAttribute('href')\n        : this.element.getAttribute('href');\n\n    // URL will be validated and resolved based on the canonical URL if relative\n    // when navigating.\n    link.setAttribute('href', hrefAttr);\n    const {openStringEl, urlStringEl} = htmlRefs(link);\n\n    // Set image.\n    const openImgAttr = this.element.getAttribute('cta-image');\n    if (openImgAttr && openImgAttr !== 'none') {\n      const ctaImgEl = this.win.document.createElement('div');\n      ctaImgEl.classList.add('i-amphtml-story-page-attachment-remote-img');\n      setImportantStyles(ctaImgEl, {\n        'background-image': 'url(' + openImgAttr + ')',\n      });\n      link.prepend(ctaImgEl);\n    } else if (!openImgAttr) {\n      // Attach link icon SVG by default.\n      const linkImage = buildOpenAttachmentElementLinkIcon(link);\n      link.prepend(linkImage);\n    }\n\n    // Set url prevew text.\n    const localizationService = getLocalizationService(devAssert(this.element));\n    if (localizationService) {\n      const localizedOpenString = localizationService.getLocalizedString(\n        LocalizedStringId.AMP_STORY_OPEN_OUTLINK_TEXT\n      );\n      openStringEl.textContent = localizedOpenString;\n    }\n    urlStringEl.textContent = hrefAttr;\n\n    this.contentEl_.appendChild(link);\n  }\n\n  /**\n   * @override\n   */\n  initializeListeners_() {\n    super.initializeListeners_();\n\n    const closeButtonEl = this.headerEl_.querySelector(\n      '.i-amphtml-story-page-attachment-close-button'\n    );\n    if (closeButtonEl) {\n      closeButtonEl.addEventListener(\n        'click',\n        () => this.close_(),\n        true /** useCapture */\n      );\n    }\n\n    // Always open links in a new tab.\n    this.contentEl_.addEventListener(\n      'click',\n      (event) => {\n        const {target} = event;\n        if (target.tagName.toLowerCase() === 'a') {\n          target.setAttribute('target', '_blank');\n        }\n      },\n      true /** useCapture */\n    );\n\n    // Closes the attachment on opacity background clicks.\n    this.element.addEventListener(\n      'click',\n      (event) => {\n        if (\n          event.target.tagName.toLowerCase() === 'amp-story-page-attachment'\n        ) {\n          this.close_();\n        }\n      },\n      true /** useCapture */\n    );\n\n    // Closes the remote attachment drawer when navigation deeplinked to an app.\n    if (this.type_ === AttachmentType.OUTLINK) {\n      const ampdoc = this.getAmpDoc();\n      ampdoc.onVisibilityChanged(() => {\n        if (ampdoc.isVisible() && this.state_ === DrawerState.OPEN) {\n          this.closeInternal_(false /** shouldAnimate */);\n        }\n      });\n    }\n  }\n\n  /**\n   * @override\n   */\n  open(shouldAnimate = true) {\n    if (this.state_ === DrawerState.OPEN) {\n      return;\n    }\n\n    super.open(shouldAnimate);\n\n    this.storeService_.dispatch(Action.TOGGLE_PAGE_ATTACHMENT_STATE, true);\n    this.storeService_.dispatch(Action.TOGGLE_SYSTEM_UI_IS_VISIBLE, false);\n\n    // Don't create a new history entry for remote attachment as user is\n    // navigating away.\n    if (this.type_ !== AttachmentType.OUTLINK) {\n      const currentHistoryState = /** @type {!Object} */ (\n        getState(this.win.history)\n      );\n      const historyState = {\n        ...currentHistoryState,\n        [HistoryState.ATTACHMENT_PAGE_ID]: this.storeService_.get(\n          StateProperty.CURRENT_PAGE_ID\n        ),\n      };\n      this.historyService_.push(() => this.closeInternal_(), historyState);\n    }\n\n    this.analyticsService_.triggerEvent(StoryAnalyticsEvent.OPEN, this.element);\n    this.analyticsService_.triggerEvent(\n      StoryAnalyticsEvent.PAGE_ATTACHMENT_ENTER\n    );\n\n    if (this.type_ === AttachmentType.OUTLINK) {\n      if (\n        isPageAttachmentUiV2ExperimentOn(this.win) ||\n        this.element.parentElement.querySelector('amp-story-page-outlink')\n      ) {\n        this.openRemoteV2_();\n      } else {\n        this.openRemote_();\n      }\n    }\n  }\n\n  /**\n   * Triggers a remote attachment preview URL animation on mobile,\n   * and redirects to the specified URL.\n   * @private\n   */\n  openRemoteV2_() {\n    // If the element is an amp-story-page-outlink the click target is its anchor element child.\n    // This is for SEO and analytics optimisation.\n    // Otherwise the element is the legacy version, amp-story-page-attachment with an href,\n    // and a click target is the button built by the component.\n    const programaticallyClickOnTarget = () => {\n      const pageOutlinkChild = this.element.parentElement\n        .querySelector('amp-story-page-outlink')\n        ?.querySelector('a');\n\n      const pageAttachmentChild = this.element.parentElement\n        ?.querySelector('.i-amphtml-story-page-open-attachment-host')\n        .shadowRoot.querySelector('a.i-amphtml-story-page-open-attachment');\n\n      if (pageOutlinkChild) {\n        pageOutlinkChild.click();\n      } else if (pageAttachmentChild) {\n        triggerClickFromLightDom(pageAttachmentChild, this.element);\n      }\n    };\n\n    const isMobileUI =\n      this.storeService_.get(StateProperty.UI_STATE) === UIType.MOBILE;\n    if (!isMobileUI) {\n      programaticallyClickOnTarget();\n    } else {\n      // Timeout to shows post-tap animation on mobile only.\n      Services.timerFor(this.win).delay(() => {\n        programaticallyClickOnTarget();\n      }, POST_TAP_ANIMATION_DURATION);\n    }\n  }\n\n  /**\n   * Triggers a remote attachment opening animation, and redirects to the\n   * specified URL.\n   * @private\n   */\n  openRemote_() {\n    const animationEl = this.win.document.createElement('div');\n    animationEl.classList.add('i-amphtml-story-page-attachment-expand');\n    const storyEl = closest(this.element, (el) => el.tagName === 'AMP-STORY');\n\n    this.mutateElement(() => {\n      storyEl.appendChild(animationEl);\n    }).then(() => {\n      // Give some time for the 120ms CSS animation to run (cf\n      // amp-story-page-attachment.css). The navigation itself will take some\n      // time, depending on the target and network conditions.\n      this.win.setTimeout(() => {\n        const clickTarget = this.element.parentElement\n          .querySelector('.i-amphtml-story-page-open-attachment-host')\n          .shadowRoot.querySelector('a.i-amphtml-story-page-open-attachment');\n        triggerClickFromLightDom(clickTarget, this.element);\n      });\n    }, 50);\n  }\n\n  /**\n   * Ensures the history state we added when opening the drawer is popped,\n   * and closes the drawer either directly, or through the onPop callback.\n   * @override\n   */\n  close_() {\n    switch (this.state_) {\n      // If the drawer was open, pop the history entry that was added, which\n      // will close the drawer through the onPop callback.\n      case DrawerState.OPEN:\n      case DrawerState.DRAGGING_TO_CLOSE:\n        this.historyService_.goBack();\n        break;\n      // If the drawer was not open, no history entry was added, so we can\n      // close the drawer directly.\n      case DrawerState.DRAGGING_TO_OPEN:\n        this.closeInternal_();\n        break;\n    }\n  }\n\n  /**\n   * @override\n   */\n  closeInternal_(shouldAnimate = true) {\n    if (this.state_ === DrawerState.CLOSED) {\n      return;\n    }\n\n    super.closeInternal_(shouldAnimate);\n\n    this.storeService_.dispatch(Action.TOGGLE_PAGE_ATTACHMENT_STATE, false);\n    this.storeService_.dispatch(Action.TOGGLE_SYSTEM_UI_IS_VISIBLE, true);\n\n    const storyEl = closest(this.element, (el) => el.tagName === 'AMP-STORY');\n    const animationEl = storyEl.querySelector(\n      '.i-amphtml-story-page-attachment-expand'\n    );\n    if (animationEl) {\n      this.mutateElement(() => {\n        removeElement(dev().assertElement(animationEl));\n      });\n    }\n\n    setHistoryState(this.win, HistoryState.ATTACHMENT_PAGE_ID, null);\n\n    this.analyticsService_.triggerEvent(\n      StoryAnalyticsEvent.CLOSE,\n      this.element\n    );\n    this.analyticsService_.triggerEvent(\n      StoryAnalyticsEvent.PAGE_ATTACHMENT_EXIT\n    );\n  }\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Helper for amp-story rendering of page-attachment UI.\n */\nimport {AttachmentTheme} from './amp-story-page-attachment';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {computedStyle, setImportantStyles} from '../../../src/style';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {getRGBFromCssColorValue, getTextColorForRGB} from './utils';\nimport {htmlFor, htmlRefs} from '../../../src/static-template';\nimport {isPageAttachmentUiV2ExperimentOn} from './amp-story-page-attachment-ui-v2';\nimport {toWin} from '../../../src/core/window';\n\n/**\n * @enum {string}\n */\nconst CtaAccentElement = {\n  TEXT: 'text',\n  BACKGROUND: 'background',\n};\n\n/**\n * @param {!Element} element\n * @return {!Element}\n */\nexport const buildOldAttachmentElement = (element) =>\n  htmlFor(element)`\n    <a class=\"\n        i-amphtml-story-page-open-attachment i-amphtml-story-system-reset\"\n        role=\"button\" target=\"_top\">\n      <span class=\"i-amphtml-story-page-open-attachment-icon\">\n        <span class=\"i-amphtml-story-page-open-attachment-bar-left\"></span>\n        <span class=\"i-amphtml-story-page-open-attachment-bar-right\"></span>\n      </span>\n      <span class=\"i-amphtml-story-page-open-attachment-label\"></span>\n    </a>`;\n\n/**\n * For amp-story-page-attachment-ui-v2.\n * No image by default, if images are defined they are appended to the template.\n * @param {!Element} element\n * @return {!Element}\n */\nexport const buildOpenInlineAttachmentElement = (element) =>\n  htmlFor(element)`\n    <a class=\"i-amphtml-story-page-open-attachment i-amphtml-story-system-reset i-amphtml-amp-story-page-attachment-ui-v2\" role=\"button\">\n      <div class=\"i-amphtml-story-inline-page-attachment-chip\" ref=\"chipEl\">\n        <div class=\"i-amphtml-story-inline-page-attachment-arrow\"></div>\n      </div>\n    </a>`;\n\n/**\n * For amp-story-page-attachment-ui-v2.\n * @param {!Element} element\n * @return {!Element}\n */\nconst buildOpenOutlinkAttachmentElement = (element) =>\n  htmlFor(element)`\n    <a class=\"i-amphtml-story-page-open-attachment i-amphtml-amp-story-page-attachment-ui-v2\" role=\"button\" target=\"_top\">\n      <svg class=\"i-amphtml-story-outlink-page-attachment-arrow\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 8\" width=\"20px\" height=\"8px\"><path d=\"M18,7.7c-0.2,0-0.5-0.1-0.7-0.2l-7.3-4l-7.3,4C2,7.9,1.1,7.7,0.7,6.9c-0.4-0.7-0.1-1.6,0.6-2l8-4.4c0.5-0.2,1-0.2,1.5,0l8,4.4c0.7,0.4,1,1.3,0.6,2C19,7.4,18.5,7.7,18,7.7z\"></path></svg>\n      <div class=\"i-amphtml-story-outlink-page-attachment-outlink-chip\" ref=\"chipEl\">\n        <span class=\"i-amphtml-story-page-attachment-label\" ref=\"ctaLabelEl\"></span>\n      </div>\n    </a>`;\n\n/**\n * For amp-story-page-attachment-ui-v2.\n * @param {!Element} element\n * @return {!Element}\n */\nexport const buildOpenAttachmentElementLinkIcon = (element) =>\n  htmlFor(element)`\n  <svg class=\"i-amphtml-story-page-open-attachment-link-icon\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\">\n    <path fill-opacity=\".1\" d=\"M12 0c6.6 0 12 5.4 12 12s-5.4 12-12 12S0 18.6 0 12 5.4 0 12 0z\"></path>\n    <path d=\"M13.8 14.6c.1.1.2.3.2.5s-.1.3-.2.5L12.3 17c-.7.7-1.7 1.1-2.7 1.1-1 0-1.9-.4-2.7-1.1-.7-.7-1.1-1.7-1.1-2.7 0-1 .4-1.9 1.1-2.7l1.5-1.5c.2 0 .3-.1.5-.1s.3.1.5.2c.1.1.2.3.2.5s-.1.4-.2.5l-1.5 1.5c-.5.5-.7 1.1-.7 1.7 0 .6.3 1.3.7 1.7.5.5 1.1.7 1.7.7s1.3-.3 1.7-.7l1.5-1.5c.3-.3.7-.3 1 0zM17 7c-.7-.7-1.7-1.1-2.7-1.1-1 0-1.9.4-2.7 1.1l-1.5 1.5c0 .1-.1.3-.1.4 0 .2.1.3.2.5.1.1.3.2.5.2s.3-.1.5-.2l1.5-1.5c.5-.5 1.1-.7 1.7-.7.6 0 1.3.3 1.7.7.5.5.7 1.1.7 1.7 0 .6-.3 1.3-.7 1.7l-1.5 1.5c-.1.1-.2.3-.2.5s.1.3.2.5c.1.1.3.2.5.2s.3-.1.5-.2l1.5-1.5c.7-.7 1.1-1.7 1.1-2.7-.1-1-.5-1.9-1.2-2.6zm-7.9 7.2c0 .2.1.3.2.5.1.1.3.2.5.2s.4-.1.5-.2l4.5-4.5c.1-.1.2-.3.2-.5s-.1-.4-.2-.5c-.3-.2-.8-.2-1 .1l-4.5 4.5c-.1.1-.2.3-.2.4z\"></path>\n  </svg>`;\n\n/**\n * Determines which open attachment UI to render.\n * @param {!Element} pageEl\n * @param {!Element} attachmentEl\n * @return {!Element}\n */\nexport const renderPageAttachmentUI = (pageEl, attachmentEl) => {\n  if (isPageAttachmentUiV2ExperimentOn(pageEl.getAmpDoc().win)) {\n    // Outlinks can be an amp-story-page-outlink or the legacy version,\n    // an amp-story-page-attachment with an href.\n    const isOutlink =\n      attachmentEl.tagName === 'AMP-STORY-PAGE-OUTLINK' ||\n      attachmentEl.getAttribute('href');\n    if (isOutlink) {\n      return renderOutlinkPageAttachmentUI(pageEl, attachmentEl);\n    } else {\n      return renderInlinePageAttachmentUi(pageEl, attachmentEl);\n    }\n  }\n  // This codepath can be removed after amp-story-page-attachment-ui-v2 is launched.\n  return renderOldPageAttachmentUI(pageEl, attachmentEl);\n};\n\n/**\n * Renders default page attachment UI.\n * @param {!Element} pageEl\n * @param {!Element} attachmentEl\n * @return {!Element}\n */\nconst renderOldPageAttachmentUI = (pageEl, attachmentEl) => {\n  const openAttachmentEl = buildOldAttachmentElement(pageEl);\n\n  // If the attachment is a link, copy href to the element so it can be previewed on hover and long press.\n  const attachmentHref = attachmentEl.getAttribute('href');\n  if (attachmentHref) {\n    openAttachmentEl.setAttribute('href', attachmentHref);\n  }\n\n  const textEl = openAttachmentEl.querySelector(\n    '.i-amphtml-story-page-open-attachment-label'\n  );\n\n  const openLabelAttr =\n    attachmentEl.getAttribute('cta-text') ||\n    attachmentEl.getAttribute('data-cta-text');\n  const openLabel =\n    (openLabelAttr && openLabelAttr.trim()) ||\n    getLocalizationService(pageEl).getLocalizedString(\n      LocalizedStringId.AMP_STORY_PAGE_ATTACHMENT_OPEN_LABEL\n    );\n\n  // Copy title to the element if it exists.\n  const attachmentTitle = attachmentEl.getAttribute('data-title');\n  if (attachmentTitle) {\n    openAttachmentEl.setAttribute('title', attachmentTitle);\n  }\n\n  textEl.textContent = openLabel;\n\n  return openAttachmentEl;\n};\n\n/**\n * Renders inline page attachment UI.\n * @param {!Element} pageEl\n * @param {!Element} attachmentEl\n * @return {!Element}\n */\nconst renderOutlinkPageAttachmentUI = (pageEl, attachmentEl) => {\n  const openAttachmentEl = buildOpenOutlinkAttachmentElement(pageEl);\n\n  // amp-story-page-outlink requires an anchor element child for SEO and analytics optimisations.\n  // amp-story-page-attachment uses this same codepath and allows an href attribute.\n  // This is hidden with css. Clicks are simulated from it when a remote attachment is clicked.\n  const anchorChild = pageEl\n    .querySelector('amp-story-page-outlink')\n    ?.querySelector('a');\n\n  // Copy href to the element so it can be previewed on hover and long press.\n  const attachmentHref =\n    anchorChild?.getAttribute('href') || attachmentEl.getAttribute('href');\n  if (attachmentHref) {\n    openAttachmentEl.setAttribute('href', attachmentHref);\n  }\n\n  // Copy title to the element if it exists.\n  const attachmentTitle =\n    anchorChild?.getAttribute('title') || attachmentEl.getAttribute('title');\n  if (attachmentTitle) {\n    openAttachmentEl.setAttribute('title', attachmentTitle);\n  }\n\n  // Get elements.\n  const {chipEl, ctaLabelEl} = htmlRefs(openAttachmentEl);\n\n  // Set theme.\n  let themeAttribute = attachmentEl.getAttribute('theme');\n  if (themeAttribute) {\n    themeAttribute = themeAttribute.toLowerCase();\n  }\n  openAttachmentEl.setAttribute('theme', themeAttribute);\n\n  if (themeAttribute === AttachmentTheme.CUSTOM) {\n    setCustomThemeStyles(attachmentEl, openAttachmentEl);\n  }\n\n  // Append text & aria-label.\n  const openLabelAttr =\n    anchorChild?.textContent ||\n    attachmentEl.getAttribute('cta-text') ||\n    attachmentEl.getAttribute('data-cta-text');\n  const openLabel = openLabelAttr\n    ? openLabelAttr.trim()\n    : getLocalizationService(pageEl).getLocalizedString(\n        LocalizedStringId.AMP_STORY_PAGE_ATTACHMENT_OPEN_LABEL\n      );\n  ctaLabelEl.textContent = openLabel;\n  openAttachmentEl.setAttribute('aria-label', openLabel);\n\n  // Set image.\n  const openImgAttr = attachmentEl.getAttribute('cta-image');\n  if (openImgAttr && openImgAttr !== 'none') {\n    const ctaImgEl = htmlFor(chipEl)`\n      <div class=\"i-amphtml-story-outlink-page-attachment-img\"></div>`;\n    setImportantStyles(ctaImgEl, {\n      'background-image': 'url(' + openImgAttr + ')',\n    });\n    chipEl.prepend(ctaImgEl);\n  } else if (!openImgAttr) {\n    // Attach link icon SVG by default.\n    const linkImage = buildOpenAttachmentElementLinkIcon(attachmentEl);\n    chipEl.prepend(linkImage);\n  }\n\n  return openAttachmentEl;\n};\n\n/**\n * Renders inline page attachment UI.\n * @param {!Element} pageEl\n * @param {!Element} attachmentEl\n * @return {!Element}\n */\nconst renderInlinePageAttachmentUi = (pageEl, attachmentEl) => {\n  const openAttachmentEl = buildOpenInlineAttachmentElement(pageEl);\n\n  // Set theme.\n  const theme = attachmentEl.getAttribute('theme');\n  if (theme && AttachmentTheme.DARK === theme.toLowerCase()) {\n    openAttachmentEl.setAttribute('theme', AttachmentTheme.DARK);\n  }\n\n  // Append text & aria-label if defined.\n  const openLabelAttr =\n    attachmentEl.getAttribute('cta-text') ||\n    attachmentEl.getAttribute('data-cta-text');\n  const openLabel =\n    (openLabelAttr && openLabelAttr.trim()) ||\n    getLocalizationService(pageEl).getLocalizedString(\n      LocalizedStringId.AMP_STORY_PAGE_ATTACHMENT_OPEN_LABEL\n    );\n  openAttachmentEl.setAttribute('aria-label', openLabel);\n\n  if (openLabel !== 'none') {\n    const textEl = htmlFor(openAttachmentEl)`\n      <span class=\"i-amphtml-story-page-attachment-label\"></span>`;\n    textEl.textContent = openLabel;\n    openAttachmentEl.appendChild(textEl);\n  }\n\n  // Add images if they are defined.\n  const {chipEl} = htmlRefs(openAttachmentEl);\n  const makeImgElWithBG = (openImgAttr) => {\n    const ctaImgEl = htmlFor(chipEl)`\n      <div class=\"i-amphtml-story-inline-page-attachment-img\"></div>`;\n    setImportantStyles(ctaImgEl, {\n      'background-image': 'url(' + openImgAttr + ')',\n    });\n    return ctaImgEl;\n  };\n\n  const openImgAttr2 = attachmentEl.getAttribute('cta-image-2');\n  if (openImgAttr2) {\n    chipEl.prepend(makeImgElWithBG(openImgAttr2));\n  }\n\n  const openImgAttr = attachmentEl.getAttribute('cta-image');\n  if (openImgAttr) {\n    chipEl.prepend(makeImgElWithBG(openImgAttr));\n  }\n\n  return openAttachmentEl;\n};\n\n/**\n * Sets custom theme attributes.\n * @param {!Element} attachmentEl\n * @param {!Element} openAttachmentEl\n */\nexport const setCustomThemeStyles = (attachmentEl, openAttachmentEl) => {\n  const accentColor = attachmentEl.getAttribute('cta-accent-color');\n\n  // Calculating contrast color (black or white) needed for outlink CTA UI.\n  let contrastColor = null;\n  if (accentColor) {\n    setImportantStyles(attachmentEl, {\n      'background-color': attachmentEl.getAttribute('cta-accent-color'),\n    });\n\n    const win = toWin(attachmentEl.ownerDocument.defaultView);\n    const styles = computedStyle(win, attachmentEl);\n    const rgb = getRGBFromCssColorValue(styles['background-color']);\n    contrastColor = getTextColorForRGB(rgb);\n    setImportantStyles(attachmentEl, {\n      'background-color': '',\n    });\n  }\n  if (\n    attachmentEl.getAttribute('cta-accent-element') ===\n    CtaAccentElement.BACKGROUND\n  ) {\n    setImportantStyles(openAttachmentEl, {\n      '--i-amphtml-outlink-cta-background-color': accentColor,\n      '--i-amphtml-outlink-cta-text-color': contrastColor,\n    });\n    setImportantStyles(attachmentEl, {\n      '--i-amphtml-outlink-cta-background-color': accentColor,\n      '--i-amphtml-outlink-cta-text-color': contrastColor,\n    });\n  } else {\n    setImportantStyles(openAttachmentEl, {\n      '--i-amphtml-outlink-cta-background-color': contrastColor,\n      '--i-amphtml-outlink-cta-text-color': accentColor,\n    });\n    setImportantStyles(attachmentEl, {\n      '--i-amphtml-outlink-cta-background-color': contrastColor,\n      '--i-amphtml-outlink-cta-text-color': accentColor,\n    });\n  }\n};\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {createElementWithAttributes} from '../../../src/dom';\nimport {dev} from '../../../src/log';\nimport {dict} from '../../../src/core/types/object';\nimport {includes} from '../../../src/core/types/string';\n\n/**\n * Renders the page description, and videos title/alt attributes in the page.\n * @param {!./amp-story-page.AmpStoryPage} page\n * @param {!Array<?Element>} videos\n */\nexport function renderPageDescription(page, videos) {\n  const descriptionElId = `i-amphtml-story-${page.element.id}-description`;\n  const descriptionEl = createElementWithAttributes(\n    page.win.document,\n    'div',\n    dict({\n      'class': 'i-amphtml-story-page-description',\n      'id': descriptionElId,\n    })\n  );\n  const append = (el) => {\n    page.mutateElement(() => {\n      descriptionEl.appendChild(el);\n      // Add descriptionEl to actual page if that hasn't happened yet.\n      if (descriptionEl.parentNode) {\n        return;\n      }\n      page.element.parentElement.insertBefore(\n        descriptionEl,\n        page.element.nextElementSibling\n      );\n      if (!page.element.getAttribute('aria-labelledby')) {\n        page.element.setAttribute('aria-labelledby', descriptionElId);\n      }\n    });\n  };\n\n  const addTagToDescriptionEl = (tagName, text) => {\n    if (!text) {\n      return;\n    }\n    const el = page.win.document.createElement(tagName);\n    el./* OK */ textContent = text;\n    append(el);\n  };\n\n  addTagToDescriptionEl('h2', page.element.getAttribute('title'));\n\n  videos.forEach((videoEl) => {\n    addTagToDescriptionEl('p', videoEl.getAttribute('alt'));\n    addTagToDescriptionEl('p', videoEl.getAttribute('title'));\n    addTagToDescriptionEl('p', videoEl.getAttribute('aria-label'));\n    fetchCaptions(page, videoEl).then((text) => {\n      addTagToDescriptionEl('p', text);\n    });\n  });\n}\n\n/**\n * Fetches captions for a video if available and returns them as plain\n * text.\n * @param {!./amp-story-page.AmpStoryPage} page\n * @param {!Element} videoEl\n * @return {!Promise<string|undefined>}\n */\nfunction fetchCaptions(page, videoEl) {\n  // Prefer the default track, otherwise pick the first.\n  // Could be extended to prefer the language of the doc.\n  const track =\n    videoEl.querySelector('track[default]') || videoEl.querySelector('track');\n  if (!track || !track.src) {\n    return Promise.resolve();\n  }\n  return Services.xhrFor(page.win)\n    .fetchText(track.src, {\n      mode: 'cors',\n    })\n    .then((response) => {\n      if (!response.ok) {\n        return;\n      }\n      return response.text().then(extractTextContent);\n    });\n}\n\n/**\n * Extract the text content from a captions file.\n * @param {string} text\n * @return {string}\n * @visibleForTesting\n */\nexport function extractTextContent(text) {\n  text = text.trim();\n  if (text.startsWith('WEBVTT')) {\n    return extractTextContentWebVtt(text);\n  }\n  if (includes(text, 'http://www.w3.org/ns/ttml')) {\n    return extractTextContentTtml(text);\n  }\n\n  return '';\n}\n\n/**\n * Extract the text content from a TTML file.\n * https://www.w3.org/TR/2018/REC-ttml2-20181108/\n * @param {string} text\n * @return {string}\n */\nfunction extractTextContentTtml(text) {\n  try {\n    const doc = new DOMParser().parseFromString(text, 'text/xml');\n    return doc\n      .querySelector('body')\n      .textContent.replace(/[\\s\\n\\r]+/g, ' ')\n      .trim();\n  } catch (e) {\n    dev().error('TTML', e.message);\n  }\n  return '';\n}\n\n/**\n * Extract the text content from a WebVTT file.\n * https://www.w3.org/TR/webvtt1/\n * @param {string} text\n * @return {string}\n */\nfunction extractTextContentWebVtt(text) {\n  const queue = /^\\d\\d\\:\\d\\d/;\n  let seenQueue = false;\n  text = text\n    .split(/[\\n\\r]+/)\n    .filter((line) => {\n      const isQueue = queue.test(line);\n      seenQueue = seenQueue || isQueue;\n      // Filter queues and everything before.\n      if (!seenQueue || isQueue) {\n        return false;\n      }\n      // Filter comments.\n      return !/^NOTE\\s+/.test(line);\n    })\n    .map((line) => {\n      return (\n        line\n          // Strip multiline indicators.\n          .replace(/^- /, '')\n      );\n    })\n    .join(' ');\n  // Super loose HTML parsing to get HTML entity parsing and removal\n  // of WebVTT elements.\n  const div = document.createElement('div');\n  div./* element is never added to DOM */ innerHTML = text;\n  return div.textContent;\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\n\n/**\n * @const {string}\n */\nconst BACKGROUND_AUDIO_ELEMENT_CLASS_NAME = 'i-amphtml-story-background-audio';\n\n/**\n * Adds support for the background-audio property on the specified element.\n * @param {!Element} element The element to upgrade with support for background\n *     audio.\n * @param {boolean=} loop\n * @return {?Element} audioEl\n */\nexport function upgradeBackgroundAudio(element, loop = true) {\n  if (!element.hasAttribute('background-audio')) {\n    return null;\n  }\n  const audioEl = element.ownerDocument.createElement('audio');\n  const audioSrc = Services.urlForDoc(element).assertHttpsUrl(\n    element.getAttribute('background-audio'),\n    element\n  );\n  audioEl.setAttribute('src', audioSrc);\n  audioEl.setAttribute('preload', 'auto');\n  if (loop) {\n    audioEl.setAttribute('loop', '');\n  }\n  audioEl.setAttribute('autoplay', '');\n  audioEl.setAttribute('muted', '');\n  audioEl.muted = true;\n  audioEl.classList.add(BACKGROUND_AUDIO_ELEMENT_CLASS_NAME);\n  element.appendChild(audioEl);\n\n  return audioEl;\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Embeds a single page in a story\n *\n * Example:\n * <code>\n * <amp-story-page>\n *   ...\n * </amp-story-page>\n * </code>\n */\nimport {\n  AFFILIATE_LINK_SELECTOR,\n  AmpStoryAffiliateLink,\n} from './amp-story-affiliate-link';\nimport {\n  Action,\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {AdvancementConfig} from './page-advancement';\nimport {AmpEvents} from '../../../src/core/constants/amp-events';\nimport {\n  AmpStoryEmbeddedComponent,\n  EMBED_ID_ATTRIBUTE_NAME,\n  EXPANDABLE_COMPONENTS,\n  expandableElementsSelectors,\n} from './amp-story-embedded-component';\nimport {AnimationManager, hasAnimations} from './animation';\nimport {CommonSignals} from '../../../src/core/constants/common-signals';\nimport {Deferred} from '../../../src/core/data-structures/promise';\nimport {EventType, dispatch} from './events';\nimport {Layout} from '../../../src/layout';\nimport {LoadingSpinner} from './loading-spinner';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {MediaPool} from './media-pool';\nimport {Services} from '../../../src/services';\nimport {VideoEvents, delegateAutoplay} from '../../../src/video-interface';\nimport {\n  addAttributesToElement,\n  iterateCursor,\n  whenUpgradedToCustomElement,\n} from '../../../src/dom';\nimport {\n  closestAncestorElementBySelector,\n  scopedQuerySelectorAll,\n} from '../../../src/core/dom/query';\nimport {createShadowRootWithStyle, setTextBackgroundColor} from './utils';\nimport {debounce} from '../../../src/core/types/function';\nimport {dev} from '../../../src/log';\nimport {dict} from '../../../src/core/types/object';\nimport {getAmpdoc} from '../../../src/service';\nimport {getFriendlyIframeEmbedOptional} from '../../../src/iframe-helper';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {getLogEntries} from './logging';\nimport {getMediaPerformanceMetricsService} from './media-performance-metrics-service';\nimport {getMode} from '../../../src/mode';\nimport {htmlFor} from '../../../src/static-template';\nimport {isAutoplaySupported} from '../../../src/utils/video';\nimport {isExperimentOn} from '../../../src/experiments';\nimport {isPageAttachmentUiV2ExperimentOn} from './amp-story-page-attachment-ui-v2';\nimport {isPrerenderActivePage} from './prerender-active-page';\nimport {listen, listenOnce} from '../../../src/event-helper';\nimport {CSS as pageAttachmentCSS} from '../../../build/amp-story-open-page-attachment-0.1.css';\nimport {prefersReducedMotion} from '../../../src/core/dom/media-query-props';\nimport {px, toggle} from '../../../src/style';\nimport {renderPageAttachmentUI} from './amp-story-open-page-attachment';\nimport {renderPageDescription} from './semantic-render';\n\nimport {toArray} from '../../../src/core/types/array';\nimport {upgradeBackgroundAudio} from './audio';\n\n/**\n * CSS class for an amp-story-page that indicates the entire page is loaded.\n * @const {string}\n */\nconst PAGE_LOADED_CLASS_NAME = 'i-amphtml-story-page-loaded';\n\n/**\n * Selectors for media elements.\n * Only get the page media: direct children of amp-story-page (ie:\n * background-audio), or descendant of amp-story-grid-layer. That excludes media\n * contained in amp-story-page-attachment.\n * @enum {string}\n */\nexport const Selectors = {\n  // which media to wait for on page layout.\n  ALL_AMP_MEDIA:\n    'amp-story-grid-layer amp-audio, ' +\n    'amp-story-grid-layer amp-video, amp-story-grid-layer amp-img, ' +\n    'amp-story-grid-layer amp-anim',\n  ALL_AMP_VIDEO: 'amp-story-grid-layer amp-video',\n  ALL_IFRAMED_MEDIA: 'audio, video',\n  ALL_PLAYBACK_AMP_MEDIA:\n    'amp-story-grid-layer amp-audio, amp-story-grid-layer amp-video',\n  // TODO(gmajoulet): Refactor the way these selectors are used. They will be\n  // passed to scopedQuerySelectorAll which expects only one selector and not\n  // multiple separated by commas. `> audio` has to be kept first of the list to\n  // work with this current implementation.\n  ALL_PLAYBACK_MEDIA:\n    '> audio, amp-story-grid-layer audio, amp-story-grid-layer video',\n  ALL_VIDEO: 'amp-story-grid-layer video',\n  ALL_TABBABLE: 'a, amp-twitter > iframe',\n};\n\n/** @private @const {string} */\nconst EMBEDDED_COMPONENTS_SELECTORS = Object.keys(EXPANDABLE_COMPONENTS).join(\n  ', '\n);\n\n/** @private @const {string} */\nconst INTERACTIVE_EMBEDDED_COMPONENTS_SELECTORS = Object.values(\n  expandableElementsSelectors()\n).join(',');\n\n/** @private @const {number} */\nconst RESIZE_TIMEOUT_MS = 1000;\n\n/** @private @const {string} */\nconst TAG = 'amp-story-page';\n\n/** @private @const {string} */\nconst ADVERTISEMENT_ATTR_NAME = 'ad';\n\n/** @private @const {number} */\nconst REWIND_TIMEOUT_MS = 350;\n\n/** @private @const {string} */\nconst DEFAULT_PREVIEW_AUTO_ADVANCE_DURATION = '2s';\n\n/** @private @const {string} */\nconst VIDEO_PREVIEW_AUTO_ADVANCE_DURATION = '5s';\n\n/** @private @const {number} */\nconst VIDEO_MINIMUM_AUTO_ADVANCE_DURATION_S = 2;\n\n/**\n * @param {!Element} element\n * @return {!Element}\n */\nconst buildPlayMessageElement = (element) =>\n  htmlFor(element)`\n      <button role=\"button\" class=\"i-amphtml-story-page-play-button i-amphtml-story-system-reset\">\n        <span class=\"i-amphtml-story-page-play-label\"></span>\n        <span class='i-amphtml-story-page-play-icon'></span>\n      </button>`;\n\n/**\n * @param {!Element} element\n * @return {!Element}\n */\nconst buildErrorMessageElement = (element) =>\n  htmlFor(element)`\n      <div class=\"i-amphtml-story-page-error i-amphtml-story-system-reset\">\n        <span class=\"i-amphtml-story-page-error-label\"></span>\n        <span class='i-amphtml-story-page-error-icon'></span>\n      </div>`;\n\n/**\n * amp-story-page states.\n * @enum {number}\n */\nexport const PageState = {\n  NOT_ACTIVE: 0, // Page is not displayed. Could still be visible on desktop.\n  PLAYING: 1, // Page is currently the main page, and playing.\n  PAUSED: 2, // Page is currently the main page, but not playing.\n};\n\n/** @const @enum {string}*/\nexport const NavigationDirection = {\n  NEXT: 'next',\n  PREVIOUS: 'previous',\n};\n\n/**\n * Prepares an embed for its expanded mode animation. Since this requires\n * calculating the size of the embed, we debounce after each resize event to\n * make sure we have the final size before doing the calculation for the\n * animation.\n * @param {!Window} win\n * @param {!Element} page\n * @param {!../../../src/service/mutator-interface.MutatorInterface} mutator\n * @return {function(!Element, ?UnlistenDef)}\n */\nfunction debounceEmbedResize(win, page, mutator) {\n  return debounce(\n    win,\n    (el, unlisten) => {\n      AmpStoryEmbeddedComponent.prepareForAnimation(\n        page,\n        dev().assertElement(el),\n        mutator\n      );\n      if (unlisten) {\n        unlisten();\n      }\n    },\n    RESIZE_TIMEOUT_MS\n  );\n}\n\n/**\n * The <amp-story-page> custom element, which represents a single page of\n * an <amp-story>.\n */\nexport class AmpStoryPage extends AMP.BaseElement {\n  /** @override @nocollapse */\n  static prerenderAllowed(element) {\n    return isPrerenderActivePage(element);\n  }\n\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n\n    /** @private {?AnimationManager} */\n    this.animationManager_ = null;\n\n    /** @private {?AdvancementConfig} */\n    this.advancement_ = null;\n\n    /** @const @private {!function(boolean)} */\n    this.debounceToggleLoadingSpinner_ = debounce(\n      this.win,\n      (isActive) => this.toggleLoadingSpinner_(!!isActive),\n      100\n    );\n\n    /** @private {?LoadingSpinner} */\n    this.loadingSpinner_ = null;\n\n    /** @private {?Element} */\n    this.playMessageEl_ = null;\n\n    /** @private {?Element} */\n    this.errorMessageEl_ = null;\n\n    /** @private {?Element} */\n    this.openAttachmentEl_ = null;\n\n    /** @private @const {!../../../src/service/mutator-interface.MutatorInterface} */\n    this.mutator_ = Services.mutatorForDoc(getAmpdoc(this.win.document));\n\n    const deferred = new Deferred();\n\n    /** @private @const {!./media-performance-metrics-service.MediaPerformanceMetricsService} */\n    this.mediaPerformanceMetricsService_ = getMediaPerformanceMetricsService(\n      this.win\n    );\n\n    /** @private {!Array<!HTMLMediaElement>} */\n    this.performanceTrackedVideos_ = [];\n\n    /** @private {?Promise} */\n    this.registerAllMediaPromise_ = null;\n\n    /** @private @const {!Promise<!MediaPool>} */\n    this.mediaPoolPromise_ = deferred.promise;\n\n    /** @private @const {!function(!MediaPool)} */\n    this.mediaPoolResolveFn_ = deferred.resolve;\n\n    /** @private @const {!function(*)} */\n    this.mediaPoolRejectFn_ = deferred.reject;\n\n    /** @private {!PageState} */\n    this.state_ = PageState.NOT_ACTIVE;\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win);\n\n    /** @private {?Element} */\n    this.cssVariablesStyleEl_ = null;\n\n    /** @private {?../../../src/layout-rect.LayoutSizeDef} */\n    this.layoutBox_ = null;\n\n    /** @private {!Array<function()>} */\n    this.unlisteners_ = [];\n\n    /** @private @const {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(this.win);\n\n    /** @private {!Deferred} */\n    this.backgroundAudioDeferred_ = new Deferred();\n\n    /**\n     * Whether the user agent matches a bot.  This is used to prevent resource\n     * optimizations that make the document less useful at crawl time, e.g.\n     * removing sources from videos.\n     * @private @const {boolean}\n     */\n    this.isBotUserAgent_ = Services.platformFor(this.win).isBot();\n\n    /** @private {?number} Time at which an audio element failed playing. */\n    this.playAudioElementFromTimestamp_ = null;\n  }\n\n  /**\n   * @private\n   */\n  maybeCreateAnimationManager_() {\n    if (this.animationManager_) {\n      return;\n    }\n    if (prefersReducedMotion(this.win)) {\n      return;\n    }\n    if (!hasAnimations(this.element)) {\n      return;\n    }\n    this.animationManager_ = AnimationManager.create(\n      this.element,\n      this.getAmpDoc(),\n      this.getAmpDoc().getUrl()\n    );\n  }\n\n  /** @override */\n  buildCallback() {\n    this.delegateVideoAutoplay();\n    this.markMediaElementsWithPreload_();\n    this.initializeMediaPool_();\n    this.maybeCreateAnimationManager_();\n    this.maybeSetPreviewDuration_();\n    this.maybeSetStoryNextUp_();\n    this.advancement_ = AdvancementConfig.forElement(this.win, this.element);\n    this.advancement_.addPreviousListener(() => this.previous());\n    this.advancement_.addAdvanceListener(() =>\n      this.next(/* opt_isAutomaticAdvance */ true)\n    );\n    this.advancement_.addProgressListener((progress) =>\n      this.emitProgress_(progress)\n    );\n    this.setDescendantCssTextStyles_();\n    this.storeService_.subscribe(\n      StateProperty.UI_STATE,\n      (uiState) => this.onUIStateUpdate_(uiState),\n      true /* callToInitialize */\n    );\n    this.setPageDescription_();\n    this.element.setAttribute('role', 'region');\n    this.initializeImgAltTags_();\n    this.initializeTabbableElements_();\n  }\n\n  /** @private */\n  maybeSetPreviewDuration_() {\n    if (this.storeService_.get(StateProperty.PREVIEW_STATE)) {\n      const videos = this.getAllVideos_();\n\n      const autoAdvanceAttr =\n        videos.length > 0\n          ? VIDEO_PREVIEW_AUTO_ADVANCE_DURATION\n          : DEFAULT_PREVIEW_AUTO_ADVANCE_DURATION;\n\n      addAttributesToElement(\n        this.element,\n        dict({\n          'auto-advance-after': autoAdvanceAttr,\n        })\n      );\n    }\n  }\n\n  /**\n   * Reads the storyNextUp param if provided and sets the auto-advance-after\n   * attribute to the given value if there isn't one set by the publisher. The\n   * auto-advance-after attribute may later be set to the duration of the first\n   * video if there is one, once the metadata is available.\n   * @private\n   */\n  maybeSetStoryNextUp_() {\n    const autoAdvanceAttr = this.element.getAttribute('auto-advance-after');\n    // This is a private param used for testing, it may be changed\n    // or removed without notice.\n    const storyNextUpParam = Services.viewerForDoc(this.element).getParam(\n      'storyNextUp'\n    );\n    if (autoAdvanceAttr !== null || storyNextUpParam === null) {\n      return;\n    }\n    addAttributesToElement(\n      this.element,\n      dict({\n        'auto-advance-after': storyNextUpParam,\n      })\n    );\n    this.listenAndUpdateAutoAdvanceDuration_();\n  }\n\n  /**\n   * If there's a video on the page, this sets a listener to update\n   * the TimeBasedAdvancement when the first video's duration becomes available.\n   * @private\n   */\n  listenAndUpdateAutoAdvanceDuration_() {\n    const video = this.getFirstAmpVideo_();\n    if (video === null) {\n      return;\n    }\n    whenUpgradedToCustomElement(video)\n      .then(() => video.getImpl())\n      .then((videoImpl) => {\n        const videoDuration = videoImpl.getDuration();\n        if (!isNaN(videoDuration)) {\n          this.maybeUpdateAutoAdvanceTime_(videoDuration);\n          return;\n        }\n        listenOnce(video, VideoEvents.LOADEDMETADATA, () => {\n          this.maybeUpdateAutoAdvanceTime_(videoImpl.getDuration());\n        });\n      });\n  }\n\n  /**\n   * If advancement_ is a TimeBasedConfig, this updates the 'auto-advance-after'\n   * attribute and updates the time delay used by the page's AdvancementConfig.\n   * If the duration is < 2 seconds, the default is left unchanged.\n   * @param {number} duration The updated duration for the page, in seconds.\n   * @private\n   */\n  maybeUpdateAutoAdvanceTime_(duration) {\n    if (\n      duration < VIDEO_MINIMUM_AUTO_ADVANCE_DURATION_S ||\n      !this.advancement_ ||\n      !this.advancement_.updateTimeDelay\n    ) {\n      return;\n    }\n    this.advancement_.updateTimeDelay(duration + 's');\n    // 'auto-advance-after' is only read during buildCallback(), but we update it\n    // here to keep the DOM consistent with the AdvancementConfig.\n    addAttributesToElement(\n      this.element,\n      dict({'auto-advance-after': duration + 's'})\n    );\n  }\n\n  /**\n   * Returns the first amp-video in the amp-story-page if there is one, otherwise\n   * returns null.\n   * @return {?Element}\n   * @private\n   */\n  getFirstAmpVideo_() {\n    const videos = this.getAllAmpVideos_();\n    return videos.length === 0 ? null : videos[0];\n  }\n\n  /**\n   * Delegates video autoplay so the video manager does not follow the\n   * autoplay attribute that may have been set by a publisher, which could\n   * play videos from an inactive page.\n   */\n  delegateVideoAutoplay() {\n    iterateCursor(this.element.querySelectorAll('amp-video'), delegateAutoplay);\n  }\n\n  /** @private */\n  initializeMediaPool_() {\n    const storyEl = dev().assertElement(\n      closestAncestorElementBySelector(this.element, 'amp-story'),\n      'amp-story-page must be a descendant of amp-story.'\n    );\n\n    whenUpgradedToCustomElement(storyEl)\n      .then(() => storyEl.getImpl())\n      .then(\n        (storyImpl) => this.mediaPoolResolveFn_(MediaPool.for(storyImpl)),\n        (reason) => this.mediaPoolRejectFn_(reason)\n      );\n  }\n\n  /**\n   * Marks any AMP elements that represent media elements with preload=\"auto\".\n   * @private\n   */\n  markMediaElementsWithPreload_() {\n    const mediaSet = this.element.querySelectorAll('amp-audio, amp-video');\n    Array.prototype.forEach.call(mediaSet, (mediaItem) => {\n      mediaItem.setAttribute('preload', 'auto');\n    });\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return layout == Layout.CONTAINER;\n  }\n\n  /**\n   * Updates the state of the page.\n   * @param {!PageState} state\n   */\n  setState(state) {\n    switch (state) {\n      case PageState.NOT_ACTIVE:\n        this.element.removeAttribute('active');\n        if (this.openAttachmentEl_) {\n          this.openAttachmentEl_.removeAttribute('active');\n        }\n        this.pause_();\n        this.state_ = state;\n        break;\n      case PageState.PLAYING:\n        if (this.state_ === PageState.NOT_ACTIVE) {\n          this.element.setAttribute('active', '');\n          this.resume_();\n          if (this.openAttachmentEl_) {\n            this.openAttachmentEl_.setAttribute('active', '');\n          }\n        }\n\n        if (this.state_ === PageState.PAUSED) {\n          this.advancement_.start();\n          this.playAllMedia_();\n          this.animationManager_?.resumeAll();\n        }\n\n        this.state_ = state;\n        break;\n      case PageState.PAUSED:\n        this.advancement_.stop(true /** canResume */);\n        this.pauseAllMedia_(false /** rewindToBeginning */);\n        this.animationManager_?.pauseAll();\n        this.state_ = state;\n        break;\n      default:\n        dev().warn(TAG, `PageState ${state} does not exist`);\n        break;\n    }\n  }\n\n  /**\n   * @private\n   */\n  pause_() {\n    this.advancement_.stop(false /** canResume */);\n\n    this.stopMeasuringAllVideoPerformance_();\n    this.stopListeningToVideoEvents_();\n    this.toggleErrorMessage_(false);\n    this.togglePlayMessage_(false);\n    this.playAudioElementFromTimestamp_ = null;\n\n    if (\n      this.storeService_.get(StateProperty.UI_STATE) === UIType.DESKTOP_PANELS\n    ) {\n      // The rewinding is delayed on desktop so that it happens at a lower\n      // opacity instead of immediately jumping to the first frame. See #17985.\n      this.pauseAllMedia_(false /** rewindToBeginning */);\n      this.timer_.delay(() => {\n        this.rewindAllMedia_();\n      }, REWIND_TIMEOUT_MS);\n    } else {\n      this.pauseAllMedia_(true /** rewindToBeginning */);\n    }\n\n    if (!this.storeService_.get(StateProperty.MUTED_STATE)) {\n      this.muteAllMedia();\n    }\n\n    this.animationManager_?.cancelAll();\n  }\n\n  /**\n   * @private\n   */\n  resume_() {\n    const registerAllPromise = this.registerAllMedia_();\n\n    if (this.isActive()) {\n      registerAllPromise.then(() => {\n        this.signals()\n          .whenSignal(CommonSignals.LOAD_END)\n          .then(() => {\n            if (this.state_ == PageState.PLAYING) {\n              this.advancement_.start();\n            }\n          });\n        this.preloadAllMedia_().then(() => {\n          this.startMeasuringAllVideoPerformance_();\n          this.startListeningToVideoEvents_();\n          // iOS 14.2 and 14.3 requires play to be called before unmute\n          this.playAllMedia_().then(() => {\n            if (!this.storeService_.get(StateProperty.MUTED_STATE)) {\n              this.unmuteAllMedia();\n            }\n          });\n        });\n      });\n      this.maybeStartAnimations_();\n      this.checkPageHasAudio_();\n      this.checkPageHasElementWithPlayback_();\n      this.findAndPrepareEmbeddedComponents_();\n    }\n\n    this.reportDevModeErrors_();\n  }\n\n  /** @override */\n  layoutCallback() {\n    // Do not loop if the audio is used to auto-advance.\n    const loop =\n      this.element.getAttribute('id') !==\n      this.element.getAttribute('auto-advance-after');\n    upgradeBackgroundAudio(this.element, loop);\n    this.backgroundAudioDeferred_.resolve();\n\n    this.muteAllMedia();\n    this.getViewport().onResize(\n      debounce(this.win, () => this.onResize_(), RESIZE_TIMEOUT_MS)\n    );\n\n    this.renderOpenAttachmentUI_();\n\n    return Promise.all([\n      this.beforeVisible(),\n      this.waitForMediaLayout_(),\n      this.mediaPoolPromise_,\n    ]);\n  }\n\n  /** @override */\n  onLayoutMeasure() {\n    const layoutBox = this.getLayoutSize();\n    // Only measures from the first story page, that always gets built because\n    // of the prerendering optimizations in place.\n    if (\n      !isPrerenderActivePage(this.element) ||\n      (this.layoutBox_ &&\n        this.layoutBox_.width === layoutBox.width &&\n        this.layoutBox_.height === layoutBox.height)\n    ) {\n      return;\n    }\n\n    this.layoutBox_ = layoutBox;\n\n    return this.getVsync().runPromise(\n      {\n        measure: (state) => {\n          const uiState = this.storeService_.get(StateProperty.UI_STATE);\n          // The desktop panels UI uses CSS scale. Retrieving clientHeight/Width\n          // ensures we are getting the raw size, ignoring the scale.\n          const {height, width} =\n            uiState === UIType.DESKTOP_PANELS\n              ? {\n                  height: this.element./*OK*/ clientHeight,\n                  width: this.element./*OK*/ clientWidth,\n                }\n              : layoutBox;\n          state.height = height;\n          state.width = width;\n          state.vh = height / 100;\n          state.vw = width / 100;\n          state.fiftyVw = Math.round(width / 2);\n          state.vmin = Math.min(state.vh, state.vw);\n          state.vmax = Math.max(state.vh, state.vw);\n        },\n        mutate: (state) => {\n          const {height, width} = state;\n          if (state.vh === 0 && state.vw === 0) {\n            return;\n          }\n          this.storeService_.dispatch(Action.SET_PAGE_SIZE, {height, width});\n          if (!this.cssVariablesStyleEl_) {\n            const doc = this.win.document;\n            this.cssVariablesStyleEl_ = doc.createElement('style');\n            this.cssVariablesStyleEl_.setAttribute('type', 'text/css');\n            doc.head.appendChild(this.cssVariablesStyleEl_);\n          }\n          this.cssVariablesStyleEl_.textContent =\n            `:root {` +\n            `--story-page-vh: ${px(state.vh)};` +\n            `--story-page-vw: ${px(state.vw)};` +\n            `--story-page-vmin: ${px(state.vmin)};` +\n            `--story-page-vmax: ${px(state.vmax)};` +\n            `--i-amphtml-story-page-50vw: ${px(state.fiftyVw)};` +\n            `}`;\n        },\n      },\n      {}\n    );\n  }\n\n  /**\n   * @private\n   */\n  onResize_() {\n    this.findAndPrepareEmbeddedComponents_(true /* forceResize */);\n  }\n\n  /**\n   * Reacts to UI state updates.\n   * @param {!UIType} uiState\n   * @private\n   */\n  onUIStateUpdate_(uiState) {\n    // On vertical rendering, render all the animations with their final state.\n    if (uiState === UIType.VERTICAL) {\n      this.maybeFinishAnimations_();\n    }\n  }\n\n  /** @return {!Promise} */\n  beforeVisible() {\n    return this.maybeApplyFirstAnimationFrame();\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  waitForMediaLayout_() {\n    const mediaSet = toArray(this.getMediaBySelector_(Selectors.ALL_AMP_MEDIA));\n\n    const mediaPromises = mediaSet.map((mediaEl) => {\n      return new Promise((resolve) => {\n        switch (mediaEl.tagName.toLowerCase()) {\n          case 'amp-anim':\n          case 'amp-img':\n          case 'amp-story-360':\n            // Don't block media layout on a fallback element that will likely\n            // never build/load.\n            if (mediaEl.hasAttribute('fallback')) {\n              resolve();\n              return;\n            }\n\n            whenUpgradedToCustomElement(mediaEl)\n              .then((el) => el.signals().whenSignal(CommonSignals.LOAD_END))\n              .then(resolve, resolve);\n            break;\n          case 'amp-audio':\n          case 'amp-video':\n            if (mediaEl.readyState >= 2) {\n              resolve();\n              return;\n            }\n\n            mediaEl.addEventListener('canplay', resolve, true /* useCapture */);\n            break;\n          default:\n            // Any other tags should not block loading.\n            resolve();\n        }\n\n        // We suppress errors so that Promise.all will still wait for all\n        // promises to complete, even if one has failed.  We do nothing with the\n        // error, as the resource itself and/or code that loads it should handle\n        // the error.\n        mediaEl.addEventListener('error', resolve, true /* useCapture */);\n      });\n    });\n    return Promise.all(mediaPromises).then(() => this.markPageAsLoaded_());\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  waitForPlaybackMediaLayout_() {\n    const mediaSet = toArray(\n      this.getMediaBySelector_(Selectors.ALL_PLAYBACK_AMP_MEDIA)\n    );\n\n    const mediaPromises = mediaSet.map((mediaEl) => {\n      return new Promise((resolve) => {\n        switch (mediaEl.tagName.toLowerCase()) {\n          case 'amp-audio':\n          case 'amp-video':\n            const signal =\n              mediaEl.getAttribute('layout') === Layout.NODISPLAY\n                ? CommonSignals.BUILT\n                : CommonSignals.LOAD_END;\n\n            whenUpgradedToCustomElement(mediaEl)\n              .then((el) => el.signals().whenSignal(signal))\n              .then(resolve, resolve);\n            break;\n          case 'audio': // Already laid out as built from background-audio attr.\n          default:\n            // Any other tags should not block loading.\n            resolve();\n        }\n      });\n    });\n\n    if (this.element.hasAttribute('background-audio')) {\n      mediaPromises.push(this.backgroundAudioDeferred_.promise);\n    }\n\n    return Promise.all(mediaPromises);\n  }\n\n  /**\n   * Finds embedded components in page and prepares them.\n   * @param {boolean=} forceResize\n   * @private\n   */\n  findAndPrepareEmbeddedComponents_(forceResize = false) {\n    this.addClickShieldToEmbeddedComponents_();\n    this.resizeInteractiveEmbeddedComponents_(forceResize);\n    this.buildAffiliateLinks_();\n  }\n\n  /**\n   * Adds a pseudo element on top of the embed to block clicks from going into\n   * the iframe.\n   * @private\n   */\n  addClickShieldToEmbeddedComponents_() {\n    const componentEls = toArray(\n      scopedQuerySelectorAll(this.element, EMBEDDED_COMPONENTS_SELECTORS)\n    );\n\n    if (componentEls.length <= 0) {\n      return;\n    }\n\n    this.mutateElement(() => {\n      componentEls.forEach((el) => {\n        el.classList.add('i-amphtml-embedded-component');\n      });\n    });\n  }\n\n  /**\n   * Resizes interactive embeds to prepare them for their expanded animation.\n   * @param {boolean} forceResize\n   * @private\n   */\n  resizeInteractiveEmbeddedComponents_(forceResize) {\n    toArray(\n      scopedQuerySelectorAll(\n        this.element,\n        INTERACTIVE_EMBEDDED_COMPONENTS_SELECTORS\n      )\n    ).forEach((el) => {\n      const debouncePrepareForAnimation = debounceEmbedResize(\n        this.win,\n        this.element,\n        this.mutator_\n      );\n\n      if (forceResize) {\n        debouncePrepareForAnimation(el, null /* unlisten */);\n      } else if (!el.hasAttribute(EMBED_ID_ATTRIBUTE_NAME)) {\n        // Element has not been prepared for its animation yet.\n        const unlisten = listen(el, AmpEvents.SIZE_CHANGED, () => {\n          debouncePrepareForAnimation(el, unlisten);\n        });\n        // Run in case target never changes size.\n        debouncePrepareForAnimation(el, null /* unlisten */);\n      }\n    });\n  }\n\n  /**\n   * Initializes affiliate links.\n   */\n  buildAffiliateLinks_() {\n    toArray(\n      scopedQuerySelectorAll(this.element, AFFILIATE_LINK_SELECTOR)\n    ).forEach((el) => {\n      const link = new AmpStoryAffiliateLink(this.win, el);\n      link.build();\n    });\n  }\n\n  /** @private */\n  markPageAsLoaded_() {\n    dispatch(\n      this.win,\n      this.element,\n      EventType.PAGE_LOADED,\n      /* payload */ undefined,\n      {bubbles: true}\n    );\n    this.mutateElement(() => {\n      this.element.classList.add(PAGE_LOADED_CLASS_NAME);\n    });\n  }\n\n  /**\n   * Gets all media elements on this page.\n   * @return {!Array<?Element>}\n   * @private\n   */\n  getAllMedia_() {\n    return this.getMediaBySelector_(Selectors.ALL_PLAYBACK_MEDIA);\n  }\n\n  /**\n   * Gets all video elements on this page.\n   * @return {!Array<?Element>}\n   * @private\n   */\n  getAllVideos_() {\n    return this.getMediaBySelector_(Selectors.ALL_VIDEO);\n  }\n\n  /**\n   * Gets all amp video elements on this page.\n   * @return {!Array<?Element>}\n   * @private\n   */\n  getAllAmpVideos_() {\n    return this.getMediaBySelector_(Selectors.ALL_AMP_VIDEO);\n  }\n\n  /**\n   * Gets media on page by given selector. Finds elements through friendly\n   * iframe (if one exists).\n   * @param {string} selector\n   * @return {!Array<?Element>}\n   * @private\n   */\n  getMediaBySelector_(selector) {\n    const iframe = this.element.querySelector('iframe');\n    const fie =\n      iframe &&\n      getFriendlyIframeEmbedOptional(\n        /** @type {!HTMLIFrameElement} */ (iframe)\n      );\n    const mediaSet = [];\n\n    iterateCursor(scopedQuerySelectorAll(this.element, selector), (el) =>\n      mediaSet.push(el)\n    );\n\n    if (fie) {\n      iterateCursor(\n        scopedQuerySelectorAll(\n          fie.win.document.body,\n          Selectors.ALL_IFRAMED_MEDIA\n        ),\n        (el) => mediaSet.push(el)\n      );\n    }\n\n    return mediaSet;\n  }\n\n  /**\n   * @return {!Promise<boolean>}\n   * @private\n   */\n  isAutoplaySupported_() {\n    return isAutoplaySupported(this.win);\n  }\n\n  /**\n   * Applies the specified callback to each media element on the page, after the\n   * media element is loaded.\n   * @param {function(!./media-pool.MediaPool, !Element)} callbackFn The\n   *     callback to be applied to each media element.\n   * @return {!Promise} Promise that resolves after the callbacks are called.\n   * @private\n   */\n  whenAllMediaElements_(callbackFn) {\n    const mediaSet = toArray(this.getAllMedia_());\n\n    return this.mediaPoolPromise_.then((mediaPool) => {\n      const promises = mediaSet.map((mediaEl) => {\n        return callbackFn(mediaPool, dev().assertElement(mediaEl));\n      });\n\n      return Promise.all(promises);\n    });\n  }\n\n  /**\n   * Pauses all media on this page.\n   * @param {boolean=} rewindToBeginning Whether to rewind the currentTime\n   *     of media items to the beginning.\n   * @return {!Promise} Promise that resolves after the callbacks are called.\n   * @private\n   */\n  pauseAllMedia_(rewindToBeginning = false) {\n    return this.whenAllMediaElements_((mediaPool, mediaEl) => {\n      return this.pauseMedia_(\n        mediaPool,\n        mediaEl,\n        /** @type {boolean} */ (rewindToBeginning)\n      );\n    });\n  }\n\n  /**\n   * Pauses the given media.\n   * @param {!./media-pool.MediaPool} mediaPool\n   * @param {!Element} mediaEl\n   * @param {boolean} rewindToBeginning Whether to rewind the currentTime\n   *     of media items to the beginning.\n   * @return {!Promise} Promise that resolves after the media is paused.\n   * @private\n   */\n  pauseMedia_(mediaPool, mediaEl, rewindToBeginning) {\n    if (this.isBotUserAgent_) {\n      mediaEl.pause();\n      return Promise.resolve();\n    } else {\n      return mediaPool.pause(\n        /** @type {!./media-pool.DomElementDef} */ (mediaEl),\n        rewindToBeginning\n      );\n    }\n  }\n\n  /**\n   * Plays all media on this page.\n   * @return {!Promise} Promise that resolves after the callbacks are called.\n   * @private\n   */\n  playAllMedia_() {\n    return this.whenAllMediaElements_((mediaPool, mediaEl) => {\n      return this.playMedia_(mediaPool, mediaEl);\n    });\n  }\n\n  /**\n   * Plays the given media.\n   * @param {!./media-pool.MediaPool} mediaPool\n   * @param {!Element} mediaEl\n   * @return {!Promise} Promise that resolves after the media is played.\n   * @private\n   */\n  playMedia_(mediaPool, mediaEl) {\n    if (this.isBotUserAgent_) {\n      mediaEl.play();\n      return Promise.resolve();\n    } else {\n      return this.loadPromise(mediaEl).then(\n        () => {\n          return mediaPool\n            .play(/** @type {!./media-pool.DomElementDef} */ (mediaEl))\n            .catch((unusedError) => {\n              // Auto playing the media failed, which could be caused by a data\n              // saver, or a battery saving mode. Display a message so we can\n              // get a user gesture to bless the media elements, and play them.\n              if (mediaEl.tagName === 'VIDEO') {\n                this.debounceToggleLoadingSpinner_(false);\n\n                // If autoplay got rejected, display a \"play\" button. If\n                // autoplay was supported, dispay an error message.\n                this.isAutoplaySupported_().then((isAutoplaySupported) => {\n                  if (isAutoplaySupported) {\n                    this.toggleErrorMessage_(true);\n                    return;\n                  }\n\n                  // Error was expected, don't send the performance metrics.\n                  this.stopMeasuringAllVideoPerformance_(\n                    false /** sendMetrics */\n                  );\n                  this.togglePlayMessage_(true);\n                });\n              }\n\n              if (mediaEl.tagName === 'AUDIO') {\n                this.playAudioElementFromTimestamp_ = Date.now();\n              }\n            });\n        },\n        () => {\n          this.debounceToggleLoadingSpinner_(false);\n          this.toggleErrorMessage_(true);\n        }\n      );\n    }\n  }\n\n  /**\n   * Preloads all media on this page.\n   * @return {!Promise} Promise that resolves after the callbacks are called.\n   * @private\n   */\n  preloadAllMedia_() {\n    return this.whenAllMediaElements_((mediaPool, mediaEl) =>\n      this.preloadMedia_(mediaPool, mediaEl)\n    );\n  }\n\n  /**\n   * Preloads the given media.\n   * @param {!./media-pool.MediaPool} mediaPool\n   * @param {!Element} mediaEl\n   * @return {!Promise<!Element|undefined>} Promise that resolves with the preloading element.\n   * @private\n   */\n  preloadMedia_(mediaPool, mediaEl) {\n    if (this.isBotUserAgent_) {\n      // No-op.\n      return Promise.resolve();\n    } else {\n      return mediaPool.preload(\n        /** @type {!./media-pool.DomElementDef} */ (mediaEl)\n      );\n    }\n  }\n\n  /**\n   * Mutes all media on this page.\n   * @return {!Promise} Promise that resolves after the callbacks are called.\n   */\n  muteAllMedia() {\n    return this.whenAllMediaElements_((mediaPool, mediaEl) => {\n      this.muteMedia_(mediaPool, mediaEl);\n    });\n  }\n\n  /**\n   * Mutes the given media.\n   * @param {!./media-pool.MediaPool} mediaPool\n   * @param {!Element} mediaEl\n   * @return {!Promise} Promise that resolves after the media is muted.\n   * @private\n   */\n  muteMedia_(mediaPool, mediaEl) {\n    if (this.isBotUserAgent_) {\n      mediaEl.muted = true;\n      mediaEl.setAttribute('muted', '');\n      return Promise.resolve();\n    } else {\n      return mediaPool.mute(\n        /** @type {!./media-pool.DomElementDef} */ (mediaEl)\n      );\n    }\n  }\n\n  /**\n   * Unmutes all media on this page.\n   * @return {!Promise} Promise that resolves after the callbacks are called.\n   */\n  unmuteAllMedia() {\n    return this.whenAllMediaElements_((mediaPool, mediaEl) => {\n      this.unmuteMedia_(mediaPool, mediaEl);\n    });\n  }\n\n  /**\n   * Unmutes the given media.\n   * @param {!./media-pool.MediaPool} mediaPool\n   * @param {!Element} mediaEl\n   * @return {!Promise} Promise that resolves after the media is unmuted.\n   * @private\n   */\n  unmuteMedia_(mediaPool, mediaEl) {\n    if (this.isBotUserAgent_) {\n      mediaEl.muted = false;\n      mediaEl.removeAttribute('muted');\n      if (mediaEl.tagName === 'AUDIO' && mediaEl.paused) {\n        mediaEl.play();\n      }\n      return Promise.resolve();\n    } else {\n      mediaEl = /** @type {!./media-pool.DomElementDef} */ (mediaEl);\n      const promises = [mediaPool.unmute(mediaEl)];\n\n      // Audio element might not be playing if the page navigation did not\n      // happen after a user intent, and the media element was not \"blessed\".\n      // On unmute, make sure this audio element is playing, at the expected\n      // currentTime.\n      if (\n        mediaEl.tagName === 'AUDIO' &&\n        mediaEl.paused &&\n        this.playAudioElementFromTimestamp_\n      ) {\n        const currentTime =\n          (Date.now() - this.playAudioElementFromTimestamp_) / 1000;\n        if (mediaEl.hasAttribute('loop') || currentTime < mediaEl.duration) {\n          promises.push(\n            mediaPool.setCurrentTime(mediaEl, currentTime % mediaEl.duration)\n          );\n          promises.push(mediaPool.play(mediaEl));\n        }\n\n        this.playAudioElementFromTimestamp_ = null;\n      }\n\n      return Promise.all(promises);\n    }\n  }\n\n  /**\n   * Registers all media on this page.\n   * @return {!Promise} Promise that resolves after the callbacks are called.\n   * @private\n   */\n  registerAllMedia_() {\n    if (!this.registerAllMediaPromise_) {\n      this.registerAllMediaPromise_ = this.waitForPlaybackMediaLayout_().then(\n        () => this.whenAllMediaElements_((p, e) => this.registerMedia_(p, e))\n      );\n    }\n\n    return this.registerAllMediaPromise_;\n  }\n\n  /**\n   * Registers the given media.\n   * @param {!./media-pool.MediaPool} mediaPool\n   * @param {!Element} mediaEl\n   * @return {!Promise} Promise that resolves after the media is registered.\n   * @private\n   */\n  registerMedia_(mediaPool, mediaEl) {\n    if (this.isBotUserAgent_) {\n      // No-op.\n      return Promise.resolve();\n    } else {\n      return mediaPool.register(\n        /** @type {!./media-pool.DomElementDef} */ (mediaEl)\n      );\n    }\n  }\n\n  /**\n   * Rewinds all media on this page.\n   * @return {!Promise} Promise that resolves after the callbacks are called.\n   * @private\n   */\n  rewindAllMedia_() {\n    return this.whenAllMediaElements_((mediaPool, mediaEl) => {\n      if (this.isBotUserAgent_) {\n        mediaEl.currentTime = 0;\n        return Promise.resolve();\n      } else {\n        return mediaPool.rewindToBeginning(\n          /** @type {!./media-pool.DomElementDef} */ (mediaEl)\n        );\n      }\n    });\n  }\n\n  /**\n   * Starts playing animations, if the animation manager is available.\n   * @private\n   */\n  maybeStartAnimations_() {\n    this.animationManager_?.animateIn();\n  }\n\n  /**\n   * Finishes playing animations instantly, if the animation manager is\n   * available.\n   * @private\n   */\n  maybeFinishAnimations_() {\n    if (!this.animationManager_) {\n      return;\n    }\n    this.signals()\n      .whenSignal(CommonSignals.LOAD_END)\n      .then(() => this.maybeApplyFirstAnimationFrame())\n      .then(() => {\n        this.animationManager_.finishAll();\n      });\n  }\n\n  /**\n   * @return {!Promise}\n   */\n  maybeApplyFirstAnimationFrame() {\n    return Promise.resolve(this.animationManager_?.applyFirstFrame());\n  }\n\n  /**\n   * @return {number} The distance from the current page to the active page.\n   */\n  getDistance() {\n    return parseInt(this.element.getAttribute('distance'), 10);\n  }\n\n  /**\n   * @param {number} distance The distance from the current page to the active\n   *     page.\n   */\n  setDistance(distance) {\n    // TODO(ccordry) refactor this when pages are managed\n    if (this.isAd()) {\n      distance = Math.min(distance, 2);\n    }\n\n    this.element.setAttribute('distance', distance);\n    this.element.setAttribute('aria-hidden', distance != 0);\n\n    const registerAllPromise = this.registerAllMedia_();\n\n    if (distance > 0 && distance <= 2) {\n      this.findAndPrepareEmbeddedComponents_();\n      registerAllPromise.then(() => this.preloadAllMedia_());\n    }\n    this.toggleTabbableElements_(distance == 0);\n  }\n\n  /**\n   * @return {boolean} Whether this page is currently active.\n   */\n  isActive() {\n    return this.element.hasAttribute('active');\n  }\n\n  /**\n   * Emits an event indicating that the progress of the current page has changed\n   * to the specified value.\n   * @param {number} progress The progress from 0.0 to 1.0.\n   */\n  emitProgress_(progress) {\n    // Don't emit progress for ads, since the progress bar is hidden.\n    // Don't emit progress for inactive pages, because race conditions.\n    if (this.isAd() || this.state_ === PageState.NOT_ACTIVE) {\n      return;\n    }\n\n    const payload = dict({\n      'pageId': this.element.id,\n      'progress': progress,\n    });\n    const eventInit = {bubbles: true};\n    dispatch(\n      this.win,\n      this.element,\n      EventType.PAGE_PROGRESS,\n      payload,\n      eventInit\n    );\n  }\n\n  /**\n   * Returns all of the pages that are one hop from this page.\n   * @return {!Array<string>}\n   */\n  getAdjacentPageIds() {\n    const adjacentPageIds = isExperimentOn(this.win, 'amp-story-branching')\n      ? this.actions_()\n      : [];\n\n    const autoAdvanceNext = this.getNextPageId(\n      true /* opt_isAutomaticAdvance */\n    );\n    const manualAdvanceNext = this.getNextPageId(\n      false /* opt_isAutomaticAdvance */\n    );\n    const previous = this.getPreviousPageId();\n\n    if (autoAdvanceNext) {\n      adjacentPageIds.push(autoAdvanceNext);\n    }\n\n    if (manualAdvanceNext && manualAdvanceNext != autoAdvanceNext) {\n      adjacentPageIds.push(manualAdvanceNext);\n    }\n\n    if (previous) {\n      adjacentPageIds.push(previous);\n    }\n\n    return adjacentPageIds;\n  }\n\n  /**\n   * Gets the ID of the previous page in the story (before the current page).\n   * @return {?string} Returns the ID of the next page in the story, or null if\n   *     there isn't one.\n   */\n  getPreviousPageId() {\n    if (this.element.hasAttribute('i-amphtml-return-to')) {\n      return this.element.getAttribute('i-amphtml-return-to');\n    }\n\n    const navigationPath = this.storeService_.get(\n      StateProperty.NAVIGATION_PATH\n    );\n\n    const pagePathIndex = navigationPath.lastIndexOf(this.element.id);\n    const previousPageId = navigationPath[pagePathIndex - 1];\n\n    if (previousPageId) {\n      return previousPageId;\n    }\n\n    // If the page was loaded with a `#page=foo` hash, it could have no\n    // navigation path but still a previous page in the DOM.\n    const previousElement = this.element.previousElementSibling;\n    if (previousElement && previousElement.tagName.toLowerCase() === TAG) {\n      return previousElement.id;\n    }\n\n    return null;\n  }\n\n  /**\n   * Gets the ID of the next page in the story (after the current page).\n   * @param {boolean=} isAutomaticAdvance Whether this navigation was caused\n   *     by an automatic advancement after a timeout.\n   * @return {?string} Returns the ID of the next page in the story, or null if\n   *     there isn't one.\n   */\n  getNextPageId(isAutomaticAdvance = false) {\n    if (isAutomaticAdvance && this.element.hasAttribute('auto-advance-to')) {\n      return this.element.getAttribute('auto-advance-to');\n    }\n\n    const advanceAttr = isExperimentOn(this.win, 'amp-story-branching')\n      ? 'advance-to'\n      : 'i-amphtml-advance-to';\n\n    if (this.element.hasAttribute(advanceAttr)) {\n      return this.element.getAttribute(advanceAttr);\n    }\n    const nextElement = this.element.nextElementSibling;\n    if (nextElement && nextElement.tagName.toLowerCase() === TAG) {\n      return nextElement.id;\n    }\n\n    return null;\n  }\n\n  /**\n   * Finds any elements in the page that has a goToPage action.\n   * @return {!Array<string>} The IDs of the potential next pages in the story\n   * or null if there aren't any.\n   * @private\n   */\n  actions_() {\n    const actionElements = Array.prototype.slice.call(\n      this.element.querySelectorAll('[on*=goToPage]')\n    );\n\n    const actionAttrs = actionElements.map((action) =>\n      action.getAttribute('on')\n    );\n\n    return actionAttrs.reduce((res, actions) => {\n      // Handling for multiple actions on one event or multiple events.\n      const actionList = /** @type {!Array} */ (actions.split(/[;,]+/));\n      actionList.forEach((action) => {\n        if (action.indexOf('goToPage') >= 0) {\n          // The pageId is in between the equals sign & closing parenthesis.\n          res.push(action.slice(action.search('=(.*)') + 1, -1));\n        }\n      });\n      return res;\n    }, []);\n  }\n\n  /**\n   * Navigates to the previous page in the story.\n   */\n  previous() {\n    const pageId = this.getPreviousPageId();\n\n    if (pageId === null) {\n      dispatch(\n        this.win,\n        this.element,\n        EventType.NO_PREVIOUS_PAGE,\n        /* payload */ undefined,\n        {bubbles: true}\n      );\n      return;\n    }\n\n    this.storeService_.dispatch(Action.TOGGLE_PAUSED, false);\n    this.switchTo_(pageId, NavigationDirection.PREVIOUS);\n  }\n\n  /**\n   * Navigates to the next page in the story.\n   * @param {boolean=} isAutomaticAdvance Whether this navigation was caused\n   *     by an automatic advancement after a timeout.\n   */\n  next(isAutomaticAdvance = false) {\n    const pageId = this.getNextPageId(isAutomaticAdvance);\n\n    if (!pageId) {\n      dispatch(\n        this.win,\n        this.element,\n        EventType.NO_NEXT_PAGE,\n        /* payload */ undefined,\n        {bubbles: true}\n      );\n      return;\n    }\n\n    this.storeService_.dispatch(Action.TOGGLE_PAUSED, false);\n    this.switchTo_(pageId, NavigationDirection.NEXT);\n  }\n\n  /**\n   * @param {string} targetPageId\n   * @param {!NavigationDirection} direction\n   * @private\n   */\n  switchTo_(targetPageId, direction) {\n    const payload = dict({\n      'targetPageId': targetPageId,\n      'direction': direction,\n    });\n    const eventInit = {bubbles: true};\n    dispatch(this.win, this.element, EventType.SWITCH_PAGE, payload, eventInit);\n  }\n\n  /**\n   * Checks if the page has any audio.\n   * @private\n   */\n  checkPageHasAudio_() {\n    const pageHasAudio =\n      this.element.hasAttribute('background-audio') ||\n      this.element.querySelector('amp-audio') ||\n      this.hasVideoWithAudio_();\n\n    this.storeService_.dispatch(Action.TOGGLE_PAGE_HAS_AUDIO, pageHasAudio);\n  }\n\n  /**\n   * Checks if the page has any videos with audio.\n   * @return {boolean}\n   * @private\n   */\n  hasVideoWithAudio_() {\n    const ampVideoEls = this.element.querySelectorAll('amp-video');\n    return Array.prototype.some.call(\n      ampVideoEls,\n      (video) => !video.hasAttribute('noaudio')\n    );\n  }\n\n  /**\n   * Checks if the page has elements with playback.\n   * @private\n   */\n  checkPageHasElementWithPlayback_() {\n    const pageHasElementWithPlayback =\n      this.isAutoAdvance() ||\n      this.element.hasAttribute('background-audio') ||\n      this.getAllMedia_().length > 0;\n\n    this.storeService_.dispatch(\n      Action.TOGGLE_PAGE_HAS_ELEMENT_WITH_PLAYBACK,\n      pageHasElementWithPlayback\n    );\n  }\n\n  /**\n   * @private\n   */\n  reportDevModeErrors_() {\n    if (!getMode().development) {\n      return;\n    }\n\n    getLogEntries(this.element).then((logEntries) => {\n      dispatch(\n        this.win,\n        this.element,\n        EventType.DEV_LOG_ENTRIES_AVAILABLE,\n        // ? is OK because all consumers are internal.\n        /** @type {?} */ (logEntries),\n        {bubbles: true}\n      );\n    });\n  }\n\n  /**\n   * Starts measuring video performance metrics, if performance tracking is on.\n   * Has to be called directly before playing the video.\n   * @private\n   */\n  startMeasuringAllVideoPerformance_() {\n    if (!this.mediaPerformanceMetricsService_.isPerformanceTrackingOn()) {\n      return;\n    }\n\n    const videoEls = /** @type {!Array<!HTMLMediaElement>} */ (\n      this.getAllVideos_()\n    );\n    for (let i = 0; i < videoEls.length; i++) {\n      this.startMeasuringVideoPerformance_(videoEls[i]);\n    }\n  }\n\n  /**\n   * @param {!HTMLMediaElement} videoEl\n   * @private\n   */\n  startMeasuringVideoPerformance_(videoEl) {\n    if (!this.mediaPerformanceMetricsService_.isPerformanceTrackingOn()) {\n      return;\n    }\n\n    this.performanceTrackedVideos_.push(videoEl);\n    this.mediaPerformanceMetricsService_.startMeasuring(videoEl);\n  }\n\n  /**\n   * Stops measuring video performance metrics, if performance tracking is on.\n   * Computes and sends the metrics.\n   * @param {boolean=} sendMetrics\n   * @private\n   */\n  stopMeasuringAllVideoPerformance_(sendMetrics = true) {\n    if (!this.mediaPerformanceMetricsService_.isPerformanceTrackingOn()) {\n      return;\n    }\n\n    for (let i = 0; i < this.performanceTrackedVideos_.length; i++) {\n      this.mediaPerformanceMetricsService_.stopMeasuring(\n        this.performanceTrackedVideos_[i],\n        sendMetrics\n      );\n    }\n  }\n\n  /**\n   * Displays a loading spinner whenever the video is buffering.\n   * Has to be called after the mediaPool preload method, that swaps the video\n   * elements with new amp elements.\n   * @private\n   */\n  startListeningToVideoEvents_() {\n    const videoEls = this.getAllVideos_();\n\n    if (videoEls.length) {\n      const alreadyPlaying = videoEls.some((video) => video.currentTime != 0);\n      if (!alreadyPlaying) {\n        this.debounceToggleLoadingSpinner_(true);\n      }\n    }\n\n    Array.prototype.forEach.call(videoEls, (videoEl) => {\n      this.unlisteners_.push(\n        listen(videoEl, 'playing', () =>\n          this.debounceToggleLoadingSpinner_(false)\n        )\n      );\n      this.unlisteners_.push(\n        listen(videoEl, 'waiting', () =>\n          this.debounceToggleLoadingSpinner_(true)\n        )\n      );\n    });\n  }\n\n  /**\n   * @private\n   */\n  stopListeningToVideoEvents_() {\n    this.debounceToggleLoadingSpinner_(false);\n    this.unlisteners_.forEach((unlisten) => unlisten());\n    this.unlisteners_ = [];\n  }\n\n  /**\n   * @private\n   */\n  buildAndAppendLoadingSpinner_() {\n    this.loadingSpinner_ = new LoadingSpinner(this.win.document);\n    this.element.appendChild(this.loadingSpinner_.build());\n  }\n\n  /**\n   * Has to be called through the `debounceToggleLoadingSpinner_` method, to\n   * avoid the spinner flashing on the screen when the video loops, or during\n   * navigation transitions.\n   * Builds the loading spinner and attaches it to the DOM on first call.\n   * @param {boolean} isActive\n   * @private\n   */\n  toggleLoadingSpinner_(isActive) {\n    this.mutateElement(() => {\n      if (!this.loadingSpinner_) {\n        this.buildAndAppendLoadingSpinner_();\n      }\n\n      this.loadingSpinner_.toggle(isActive);\n    });\n  }\n\n  /**\n   * Builds and appends a message and icon to play the story on tap.\n   * This message is built when the playback failed (data saver, low battery\n   * modes, ...).\n   * @private\n   */\n  buildAndAppendPlayMessage_() {\n    this.playMessageEl_ = buildPlayMessageElement(this.element);\n    const labelEl = this.playMessageEl_.querySelector(\n      '.i-amphtml-story-page-play-label'\n    );\n    labelEl.textContent = getLocalizationService(\n      this.element\n    ).getLocalizedString(LocalizedStringId.AMP_STORY_PAGE_PLAY_VIDEO);\n\n    this.playMessageEl_.addEventListener('click', () => {\n      this.togglePlayMessage_(false);\n      this.startMeasuringAllVideoPerformance_();\n      this.mediaPoolPromise_\n        .then((mediaPool) => mediaPool.blessAll())\n        .then(() => this.playAllMedia_());\n    });\n\n    this.mutateElement(() => this.element.appendChild(this.playMessageEl_));\n  }\n\n  /**\n   * Toggles the visibility of the \"Play video\" fallback message.\n   * @param {boolean} isActive\n   * @private\n   */\n  togglePlayMessage_(isActive) {\n    if (!isActive) {\n      this.playMessageEl_ &&\n        this.mutateElement(() =>\n          toggle(dev().assertElement(this.playMessageEl_), false)\n        );\n      return;\n    }\n\n    if (!this.playMessageEl_) {\n      this.buildAndAppendPlayMessage_();\n    }\n\n    this.mutateElement(() =>\n      toggle(dev().assertElement(this.playMessageEl_), true)\n    );\n  }\n\n  /**\n   * Builds and appends a message and icon to indicate a video error state.\n   * @private\n   */\n  buildAndAppendErrorMessage_() {\n    this.errorMessageEl_ = buildErrorMessageElement(this.element);\n    const labelEl = this.errorMessageEl_.querySelector(\n      '.i-amphtml-story-page-error-label'\n    );\n    labelEl.textContent = getLocalizationService(\n      this.element\n    ).getLocalizedString(LocalizedStringId.AMP_STORY_PAGE_ERROR_VIDEO);\n\n    this.mutateElement(() => this.element.appendChild(this.errorMessageEl_));\n  }\n\n  /**\n   * Toggles the visibility of the \"Play video\" fallback message.\n   * @param {boolean} isActive\n   * @private\n   */\n  toggleErrorMessage_(isActive) {\n    if (!isActive) {\n      this.errorMessageEl_ &&\n        this.mutateElement(() =>\n          toggle(dev().assertElement(this.errorMessageEl_), false)\n        );\n      return;\n    }\n\n    if (!this.errorMessageEl_) {\n      this.buildAndAppendErrorMessage_();\n    }\n\n    this.mutateElement(() =>\n      toggle(dev().assertElement(this.errorMessageEl_), true)\n    );\n  }\n\n  /**\n   * Renders the open attachment UI affordance.\n   * @private\n   */\n  renderOpenAttachmentUI_() {\n    // AttachmentEl can be either amp-story-page-attachment or amp-story-page-outlink\n    const attachmentEl = this.element.querySelector(\n      'amp-story-page-attachment, amp-story-page-outlink'\n    );\n    if (!attachmentEl) {\n      return;\n    }\n\n    // To prevent 'title' attribute from being used by browser, copy value to 'data-title' and remove.\n    if (attachmentEl.hasAttribute('title')) {\n      attachmentEl.setAttribute(\n        'data-title',\n        attachmentEl.getAttribute('title')\n      );\n      attachmentEl.removeAttribute('title');\n    }\n\n    if (!this.openAttachmentEl_) {\n      this.openAttachmentEl_ = renderPageAttachmentUI(\n        this.element,\n        attachmentEl\n      );\n\n      // This ensures `active` is set on first render.\n      // Otherwise setState may be called before this.openAttachmentEl_ exists.\n      if (this.element.hasAttribute('active')) {\n        this.openAttachmentEl_.setAttribute('active', '');\n      }\n\n      const container = this.win.document.createElement('div');\n      container.classList.add('i-amphtml-story-page-open-attachment-host');\n      container.setAttribute('role', 'button');\n\n      container.addEventListener('click', (e) => {\n        if (isPageAttachmentUiV2ExperimentOn(this.win)) {\n          // Prevent default so link can be opened programmatically after URL preview is shown.\n          e.preventDefault();\n        }\n        this.openAttachment();\n      });\n\n      this.mutateElement(() => {\n        this.element.appendChild(container);\n        createShadowRootWithStyle(\n          container,\n          this.openAttachmentEl_,\n          pageAttachmentCSS\n        );\n      });\n    }\n  }\n\n  /**\n   * Opens the attachment, if any.\n   * @param {boolean=} shouldAnimate\n   */\n  openAttachment(shouldAnimate = true) {\n    const attachmentEl = this.element.querySelector(\n      'amp-story-page-attachment, amp-story-page-outlink'\n    );\n\n    if (!attachmentEl) {\n      return;\n    }\n\n    attachmentEl.getImpl().then((attachment) => attachment.open(shouldAnimate));\n  }\n\n  /**\n   * check to see if this page is a wrapper for an ad\n   * @return {boolean}\n   */\n  isAd() {\n    return this.element.hasAttribute(ADVERTISEMENT_ATTR_NAME);\n  }\n\n  /**\n   * Sets text styles for descendants of the\n   * <amp-story-page> element.\n   * @private\n   */\n  setDescendantCssTextStyles_() {\n    setTextBackgroundColor(this.element);\n  }\n\n  /**\n   * Sets the description of the page, from its title and its videos\n   * alt/title attributes.\n   * @private\n   */\n  setPageDescription_() {\n    if (this.isBotUserAgent_) {\n      renderPageDescription(this, this.getAllAmpVideos_());\n    }\n\n    if (!this.isBotUserAgent_ && this.element.hasAttribute('title')) {\n      // Strip the title attribute from the page on non-bot user agents, to\n      // prevent the browser tooltip.\n      if (!this.element.getAttribute('aria-label')) {\n        this.element.setAttribute(\n          'aria-label',\n          this.element.getAttribute('title')\n        );\n      }\n      this.element.removeAttribute('title');\n    }\n  }\n\n  /**\n   * Adds an empty alt tag to amp-img elements if not present.\n   * Prevents screen readers from announcing the img src value.\n   * @private\n   */\n  initializeImgAltTags_() {\n    toArray(this.element.querySelectorAll('amp-img')).forEach((ampImgNode) => {\n      if (!ampImgNode.getAttribute('alt')) {\n        ampImgNode.setAttribute('alt', '');\n        // If the child img element is in the dom, propogate the attribute to it.\n        const childImgNode = ampImgNode.querySelector('img');\n        childImgNode &&\n          ampImgNode\n            .getImpl()\n            .then((ampImg) => ampImg.propagateAttributes('alt', childImgNode));\n      }\n    });\n  }\n\n  /**\n   * Returns whether the page will automatically advance\n   * @return {boolean}\n   */\n  isAutoAdvance() {\n    return this.advancement_.isAutoAdvance();\n  }\n\n  /**\n   * Set the i-amphtml-orig-tabindex to the default tabindex of tabbable elements\n   */\n  initializeTabbableElements_() {\n    toArray(\n      scopedQuerySelectorAll(this.element, Selectors.ALL_TABBABLE)\n    ).forEach((el) => {\n      el.setAttribute(\n        'i-amphtml-orig-tabindex',\n        el.getAttribute('tabindex') || 0\n      );\n    });\n  }\n\n  /**\n   * Toggles the tabbable elements (buttons, links, etc) to only reach them when page is active.\n   * @param {boolean} toggle\n   */\n  toggleTabbableElements_(toggle) {\n    toArray(\n      scopedQuerySelectorAll(this.element, Selectors.ALL_TABBABLE)\n    ).forEach((el) => {\n      el.setAttribute(\n        'tabindex',\n        toggle ? el.getAttribute('i-amphtml-orig-tabindex') : -1\n      );\n    });\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Action,\n  StateProperty,\n  getStoreService,\n} from './amp-story-store-service';\nimport {Layout} from '../../../src/layout';\nimport {closest} from '../../../src/core/dom/query';\nimport {copyChildren, removeChildren} from '../../../src/dom';\nimport {dev, user} from '../../../src/log';\nimport {getStoryAttributeSrc} from './utils';\nimport {htmlFor} from '../../../src/static-template';\nimport {isArray, isObject} from '../../../src/core/types';\nimport {parseJson} from '../../../src/core/types/object/json';\nimport {setImportantStyles} from '../../../src/style';\n\n/** @const {string} */\nconst TAG = 'amp-story-access';\n\n/**\n * @enum {string}\n */\nexport const Type = {\n  BLOCKING: 'blocking',\n  NOTIFICATION: 'notification',\n};\n\n/**\n * Story access blocking type template.\n * @param {!Element} element\n * @return {!Element}\n */\nconst getBlockingTemplate = (element) => {\n  return htmlFor(element)`\n      <div class=\"i-amphtml-story-access-overflow\">\n        <div class=\"i-amphtml-story-access-container\">\n          <div class=\"i-amphtml-story-access-header\">\n            <div class=\"i-amphtml-story-access-logo\"></div>\n          </div>\n          <div class=\"i-amphtml-story-access-content\"></div>\n        </div>\n      </div>`;\n};\n\n/**\n * Story access notification type template.\n * @param {!Element} element\n * @return {!Element}\n */\nconst getNotificationTemplate = (element) => {\n  return htmlFor(element)`\n      <div class=\"i-amphtml-story-access-overflow\">\n        <div class=\"i-amphtml-story-access-container\">\n          <div class=\"i-amphtml-story-access-content\">\n            <span class=\"i-amphtml-story-access-close-button\" role=\"button\">\n              &times;\n            </span>\n          </div>\n        </div>\n      </div>`;\n};\n\n/**\n * The <amp-story-access> custom element.\n */\nexport class AmpStoryAccess extends AMP.BaseElement {\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n\n    /** @private {?Element} */\n    this.containerEl_ = null;\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win);\n  }\n\n  /** @override */\n  buildCallback() {\n    // Defaults to blocking paywall.\n    if (!this.element.hasAttribute('type')) {\n      this.element.setAttribute('type', Type.BLOCKING);\n    }\n\n    const drawerEl = this.renderDrawerEl_();\n\n    this.containerEl_ = dev().assertElement(\n      drawerEl.querySelector('.i-amphtml-story-access-container')\n    );\n    const contentEl = dev().assertElement(\n      drawerEl.querySelector('.i-amphtml-story-access-content')\n    );\n\n    copyChildren(this.element, contentEl);\n    removeChildren(this.element);\n\n    this.element.appendChild(drawerEl);\n\n    this.allowlistActions_();\n\n    this.initializeListeners_();\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return layout == Layout.CONTAINER;\n  }\n\n  /**\n   * @private\n   */\n  initializeListeners_() {\n    this.storeService_.subscribe(StateProperty.ACCESS_STATE, (isAccess) => {\n      this.onAccessStateChange_(isAccess);\n    });\n\n    this.storeService_.subscribe(\n      StateProperty.CURRENT_PAGE_INDEX,\n      (currentPageIndex) => {\n        this.onCurrentPageIndexChange_(currentPageIndex);\n      },\n      true /** callToInitialize */\n    );\n\n    this.element.addEventListener('click', (event) => this.onClick_(event));\n  }\n\n  /**\n   * Reacts to access state updates, and shows/hides the UI accordingly.\n   * @param {boolean} isAccess\n   * @private\n   */\n  onAccessStateChange_(isAccess) {\n    if (this.getType_() === Type.BLOCKING) {\n      this.toggle_(isAccess);\n    }\n  }\n\n  /**\n   * Reacts to story active page index update, and maybe display the\n   * \"notification\" story-access.\n   * @param {number} currentPageIndex\n   */\n  onCurrentPageIndexChange_(currentPageIndex) {\n    if (this.getType_() === Type.NOTIFICATION) {\n      // Only show the notification if on the first page of the story.\n      // Note: this can be overriden by an amp-access attribute that might\n      // show/hide the notification based on the user's authorizations.\n      this.toggle_(currentPageIndex === 0);\n    }\n  }\n\n  /**\n   * Handles click events and maybe closes the paywall.\n   * @param {!Event} event\n   * @return {*} TODO(#23582): Specify return type\n   * @private\n   */\n  onClick_(event) {\n    const el = dev().assertElement(event.target);\n\n    if (el.classList.contains('i-amphtml-story-access-close-button')) {\n      return this.toggle_(false);\n    }\n\n    // Closes the menu if click happened outside of the main container.\n    if (!closest(el, (el) => el === this.containerEl_, this.element)) {\n      this.storeService_.dispatch(Action.TOGGLE_ACCESS, false);\n    }\n  }\n\n  /**\n   * @param {boolean} show\n   * @private\n   */\n  toggle_(show) {\n    this.mutateElement(() => {\n      this.element.classList.toggle('i-amphtml-story-access-visible', show);\n    });\n  }\n\n  /**\n   * Returns the element's type.\n   * @return {string}\n   * @private\n   */\n  getType_() {\n    return this.element.getAttribute('type').toLowerCase();\n  }\n\n  /**\n   * Renders and returns an empty drawer element element that will contain the\n   * publisher provided DOM, depending on the type of <amp-story-access>.\n   * Blocking template gets a header containing the publisher's logo, and\n   * notification template gets a \"dismiss\" button.\n   * @return {!Element|undefined}\n   * @private\n   */\n  renderDrawerEl_() {\n    switch (this.getType_()) {\n      case Type.BLOCKING:\n        const drawerEl = getBlockingTemplate(this.element);\n\n        const logoSrc = getStoryAttributeSrc(\n          this.element,\n          'publisher-logo-src',\n          /* warn */ true\n        );\n\n        if (logoSrc) {\n          const logoEl = dev().assertElement(\n            drawerEl.querySelector('.i-amphtml-story-access-logo')\n          );\n          setImportantStyles(logoEl, {'background-image': `url(${logoSrc})`});\n        }\n\n        return drawerEl;\n        break;\n      case Type.NOTIFICATION:\n        return getNotificationTemplate(this.element);\n        break;\n      default:\n        user().error(\n          TAG,\n          'Unknown \"type\" attribute, expected one of: ' +\n            'blocking, notification.'\n        );\n    }\n  }\n\n  /**\n   * Allowlists the <amp-access> actions.\n   * Depending on the publisher configuration, actions can be:\n   *   - login\n   *   - login-<namespace>\n   *   - login-<namespace>-<type>\n   *\n   * Publishers can provide one (object) or multiple (array) configurations,\n   * identified by their \"namespace\" property.\n   * Each configuration can have one or multiple login URLs, called \"type\".\n   * All the namespace/type pairs have to be allowlisted.\n   * @private\n   */\n  allowlistActions_() {\n    const accessEl = dev().assertElement(\n      this.win.document.getElementById('amp-access'),\n      'Cannot find the amp-access configuration'\n    );\n\n    // Configuration validation is handled by the amp-access extension.\n    let accessConfig = /** @type {!Array|!Object} */ (\n      parseJson(accessEl.textContent)\n    );\n\n    if (!isArray(accessConfig)) {\n      accessConfig = [accessConfig];\n\n      // If there is only one configuration and the publisher provided a\n      // namespace, we want to allow actions with or without namespace.\n      if (accessConfig[0].namespace) {\n        accessConfig.push({...accessConfig[0], namespace: undefined});\n      }\n    }\n\n    const actions = [];\n\n    /** @type {!Array} */ (accessConfig).forEach((config) => {\n      const {login, namespace} = /** @type {{login, namespace}} */ (config);\n\n      if (isObject(login)) {\n        const types = Object.keys(login);\n        types.forEach((type) =>\n          actions.push(this.getActionObject_(namespace, type))\n        );\n      } else {\n        actions.push(this.getActionObject_(namespace));\n      }\n    });\n\n    this.storeService_.dispatch(Action.ADD_TO_ACTIONS_ALLOWLIST, actions);\n  }\n\n  /**\n   * Allowlists an action for the given namespace / type pair.\n   * @param {string=} namespace\n   * @param {string=} type\n   * @return {*} TODO(#23582): Specify return type\n   * @private\n   */\n  getActionObject_(namespace = undefined, type = undefined) {\n    const method = ['login', namespace, type].filter(Boolean).join('-');\n    return {tagOrTarget: 'SCRIPT', method};\n  }\n}\n", "export const CSS = \":host{all:initial!important;color:initial!important}.i-amphtml-story-consent{display:-ms-flexbox!important;display:flex!important;-ms-flex-direction:column!important;flex-direction:column!important;z-index:100005!important}.i-amphtml-story-consent,.i-amphtml-story-consent:before{position:absolute!important;top:0!important;left:0!important;height:100%!important;width:100%!important}.i-amphtml-story-consent:before{content:\\\"\\\"!important;background:#000!important;opacity:0.55!important}.i-amphtml-story-consent-overflow{margin-top:auto!important;overflow-y:auto!important;overflow-x:hidden!important;-webkit-overflow-scrolling:touch!important}.i-amphtml-story-consent-container{position:relative!important;margin:88px 0 72px!important;background:#fff!important;border-radius:8px 8px 0 0!important;color:rgba(0,0,0,0.87)!important;font-family:Roboto,sans-serif!important;text-align:start!important;overflow:hidden!important}.i-amphtml-story-consent-header{position:relative!important;height:80px!important;min-height:80px!important;background:var(--primary-color,#f0f0f0)!important;z-index:2!important}.i-amphtml-story-consent-logo{position:absolute!important;bottom:-32px!important;margin-left:-32px!important;left:50%!important;height:64px!important;width:64px!important;background:#f0f0f0!important;background-position:50%!important;background-repeat:no-repeat!important;background-size:contain!important;border-radius:5px!important}.i-amphtml-story-consent-logo:before{content:\\\"\\\"!important;position:absolute!important;top:-6px!important;bottom:-6px!important;left:-6px!important;right:-6px!important;background:#fff!important;border-radius:6px!important;box-shadow:0 2px 3px rgba(0,0,0,0.12)!important;z-index:-1!important}.i-amphtml-story-consent-content{padding:42px 16px 16px!important;font-size:14px!important;z-index:0!important}.i-amphtml-story-consent-vendors{margin:0!important;padding:0!important;list-style:none!important}.i-amphtml-story-consent-vendor{height:40px!important;border-bottom:1px solid #f0f0f0!important;line-height:40px!important;text-overflow:ellipsis!important;overflow:hidden!important}.i-amphtml-story-consent-external-link{position:relative!important;display:inline-block!important;margin:24px 0!important;color:rgba(0,0,0,0.87)!important;font-size:15px!important;font-weight:700!important;text-decoration:none!important}.i-amphtml-story-consent-external-link:hover{text-decoration:underline!important}.i-amphtml-story-consent-external-link:after{content:\\\"\\\"!important;position:absolute!important;display:block!important;height:16px!important;width:16px!important;top:3px!important;right:-20px!important;background:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='rgba(0, 0, 0, 0.87)'%3E%3Cpath d='M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\") 50% no-repeat!important}.i-amphtml-story-consent-external-link.i-amphtml-hidden{display:none!important}.i-amphtml-story-consent-actions{position:absolute!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;-ms-flex-align:center!important;align-items:center!important;bottom:0!important;left:0!important;right:0!important;height:72px!important;min-height:72px!important;background:#fff!important;box-shadow:0 -2px 3px rgba(0,0,0,0.12)!important;z-index:1!important}.i-amphtml-story-consent-action{position:relative!important;padding:0 24px!important;margin:0 12px!important;height:40px!important;width:40vw!important;background:#fff!important;border:none!important;border-radius:40px!important;box-sizing:border-box!important;cursor:pointer!important;font-size:13px!important;font-weight:700!important;line-height:40px!important;text-align:center!important;text-transform:uppercase!important}.i-amphtml-story-consent-action.i-amphtml-hidden{display:none!important}.i-amphtml-story-consent-action-accept{background:var(--primary-color,#000)!important;color:#fff!important}.i-amphtml-story-consent-action-reject{border:1px solid #000!important}@media (min-width:420px){.i-amphtml-story-consent{-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important}.i-amphtml-story-consent-overflow{margin-top:0!important}.i-amphtml-story-consent-container{display:-ms-flexbox!important;display:flex!important;-ms-flex-direction:column!important;flex-direction:column!important;margin:0!important;max-height:60vh!important;min-height:40vh!important;width:calc(100vw - 80px)!important;max-width:800px!important}.i-amphtml-story-consent-content{margin:0 auto!important;max-width:424px!important;-ms-flex-positive:1!important;flex-grow:1!important;overflow-y:auto!important}.i-amphtml-story-consent-content::-webkit-scrollbar{width:0px!important;background:transparent!important}.i-amphtml-story-consent-actions{position:relative!important;left:0px!important;right:0px!important}.i-amphtml-story-consent-action{width:33vw!important;max-width:200px!important}}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story-consent.css*/\";\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Action,\n  StateProperty,\n  getStoreService,\n} from './amp-story-store-service';\nimport {ActionTrust} from '../../../src/core/constants/action-constants';\nimport {CSS} from '../../../build/amp-story-consent-1.0.css';\nimport {Layout} from '../../../src/layout';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {Services} from '../../../src/services';\nimport {assertAbsoluteHttpOrHttpsUrl, assertHttpsUrl} from '../../../src/url';\nimport {\n  childElementByTag,\n  closest,\n  closestAncestorElementBySelector,\n  matches,\n} from '../../../src/core/dom/query';\nimport {computedStyle, setImportantStyles} from '../../../src/style';\nimport {\n  createShadowRootWithStyle,\n  getRGBFromCssColorValue,\n  getTextColorForRGB,\n  triggerClickFromLightDom,\n} from './utils';\nimport {dev, user, userAssert} from '../../../src/log';\nimport {dict} from './../../../src/core/types/object';\nimport {isArray} from '../../../src/core/types';\nimport {isJsonScriptTag} from '../../../src/dom';\n\nimport {parseJson} from '../../../src/core/types/object/json';\nimport {renderAsElement} from './simple-template';\n\n/** @const {string} */\nconst TAG = 'amp-story-consent';\n\n/**\n * Default optional config parameters.\n * @const {!Object}\n */\nconst DEFAULT_OPTIONAL_PARAMETERS = {\n  externalLink: {},\n  onlyAccept: false,\n};\n\n// TODO(gmajoulet): switch to `htmlFor` static template helper.\n/**\n * Story consent template.\n * @param {!Object} config\n * @param {string} consentId\n * @param {?string} logoSrc\n * @return {!./simple-template.ElementDef}\n * @private @const\n */\nconst getTemplate = (config, consentId, logoSrc) => ({\n  tag: 'div',\n  attrs: dict({\n    'class': 'i-amphtml-story-consent i-amphtml-story-system-reset',\n  }),\n  children: [\n    {\n      tag: 'div',\n      attrs: dict({'class': 'i-amphtml-story-consent-overflow'}),\n      children: [\n        {\n          tag: 'div',\n          attrs: dict({'class': 'i-amphtml-story-consent-container'}),\n          children: [\n            {\n              tag: 'div',\n              attrs: dict({'class': 'i-amphtml-story-consent-header'}),\n              children: [\n                {\n                  tag: 'div',\n                  attrs: dict({\n                    'class': 'i-amphtml-story-consent-logo',\n                    'style': logoSrc\n                      ? `background-image: url('${logoSrc}') !important;`\n                      : '',\n                  }),\n                  children: [],\n                },\n              ],\n            },\n            {\n              tag: 'div',\n              attrs: dict({'class': 'i-amphtml-story-consent-content'}),\n              children: [\n                {\n                  tag: 'h3',\n                  attrs: dict({}),\n                  children: [],\n                  unlocalizedString: config.title,\n                },\n                {\n                  tag: 'p',\n                  attrs: dict({}),\n                  children: [],\n                  unlocalizedString: config.message,\n                },\n                {\n                  tag: 'ul',\n                  attrs: dict({'class': 'i-amphtml-story-consent-vendors'}),\n                  children:\n                    config.vendors &&\n                    config.vendors.map((vendor) => ({\n                      tag: 'li',\n                      attrs: dict({'class': 'i-amphtml-story-consent-vendor'}),\n                      children: [],\n                      unlocalizedString: vendor,\n                    })),\n                },\n                {\n                  tag: 'a',\n                  attrs: dict({\n                    'class':\n                      'i-amphtml-story-consent-external-link ' +\n                      (!(config.externalLink.title && config.externalLink.href)\n                        ? 'i-amphtml-hidden'\n                        : ''),\n                    'href': config.externalLink.href,\n                    'target': '_top',\n                    'title': config.externalLink.title,\n                  }),\n                  children: [],\n                  unlocalizedString: config.externalLink.title,\n                },\n              ],\n            },\n          ],\n        },\n        {\n          tag: 'div',\n          attrs: dict({'class': 'i-amphtml-story-consent-actions'}),\n          children: [\n            {\n              tag: 'button',\n              attrs: dict({\n                'class':\n                  'i-amphtml-story-consent-action ' +\n                  'i-amphtml-story-consent-action-reject' +\n                  (config.onlyAccept === true ? ' i-amphtml-hidden' : ''),\n                'on': `tap:${consentId}.reject`,\n              }),\n              children: [],\n              localizedStringId:\n                LocalizedStringId.AMP_STORY_CONSENT_DECLINE_BUTTON_LABEL,\n            },\n            {\n              tag: 'button',\n              attrs: dict({\n                'class':\n                  'i-amphtml-story-consent-action ' +\n                  'i-amphtml-story-consent-action-accept',\n                'on': `tap:${consentId}.accept`,\n              }),\n              children: [],\n              localizedStringId:\n                LocalizedStringId.AMP_STORY_CONSENT_ACCEPT_BUTTON_LABEL,\n            },\n          ],\n        },\n      ],\n    },\n  ],\n});\n\n/**\n * The <amp-story-consent> custom element.\n */\nexport class AmpStoryConsent extends AMP.BaseElement {\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n\n    /** @private {?../../../src/service/action-impl.ActionService} */\n    this.actions_ = null;\n\n    /** @private {?Object} */\n    this.consentConfig_ = null;\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win);\n\n    /** @private {?Object} */\n    this.storyConsentConfig_ = null;\n\n    /** @private {?Element} */\n    this.storyConsentEl_ = null;\n  }\n\n  /** @override */\n  buildCallback() {\n    this.actions_ = Services.actionServiceForDoc(this.element);\n\n    this.assertAndParseConfig_();\n\n    const storyEl = dev().assertElement(\n      closestAncestorElementBySelector(this.element, 'AMP-STORY')\n    );\n    const consentEl = closestAncestorElementBySelector(\n      this.element,\n      'AMP-CONSENT'\n    );\n    const consentId = consentEl.id;\n\n    this.storeConsentId_(consentId);\n\n    const logoSrc = storyEl && storyEl.getAttribute('publisher-logo-src');\n\n    if (logoSrc) {\n      assertHttpsUrl(logoSrc, storyEl, 'publisher-logo-src');\n    } else {\n      user().warn(\n        TAG,\n        'Expected \"publisher-logo-src\" attribute on <amp-story>'\n      );\n    }\n\n    // Story consent config is set by the `assertAndParseConfig_` method.\n    if (this.storyConsentConfig_) {\n      this.storyConsentEl_ = renderAsElement(\n        this.win.document,\n        getTemplate(this.storyConsentConfig_, consentId, logoSrc)\n      );\n      createShadowRootWithStyle(this.element, this.storyConsentEl_, CSS);\n\n      // Allow <amp-consent> actions in STAMP (defaults to no actions allowed).\n      const actions = [\n        {tagOrTarget: 'AMP-CONSENT', method: 'accept'},\n        {tagOrTarget: 'AMP-CONSENT', method: 'prompt'},\n        {tagOrTarget: 'AMP-CONSENT', method: 'reject'},\n      ];\n      this.storeService_.dispatch(Action.ADD_TO_ACTIONS_ALLOWLIST, actions);\n\n      this.setAcceptButtonFontColor_();\n\n      this.initializeListeners_();\n    }\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return layout == Layout.NODISPLAY;\n  }\n\n  /**\n   * @private\n   */\n  initializeListeners_() {\n    this.storyConsentEl_.addEventListener(\n      'click',\n      (event) => this.onClick_(event),\n      true /** useCapture */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.RTL_STATE,\n      (rtlState) => {\n        this.onRtlStateUpdate_(rtlState);\n      },\n      true /** callToInitialize */\n    );\n  }\n\n  /**\n   * Listens to click events to trigger the actions programatically.\n   * Since events bubble up from the Shadow DOM but their target is updated to\n   * the Shadow root, the top level actions event listeners would not detect\n   * and trigger the actions upon click events.\n   * @param {!Event} event\n   * @private\n   */\n  onClick_(event) {\n    if (!event.target) {\n      return;\n    }\n    if (event.target.hasAttribute('on')) {\n      const targetEl = dev().assertElement(event.target);\n      this.actions_.trigger(targetEl, 'tap', event, ActionTrust.HIGH);\n    }\n    const anchorClicked = closest(event.target, (e) => matches(e, 'a[href]'));\n    if (anchorClicked) {\n      triggerClickFromLightDom(anchorClicked, this.element);\n      event.preventDefault();\n    }\n  }\n\n  /**\n   * Reacts to RTL state updates and triggers the UI for RTL.\n   * @param {boolean} rtlState\n   * @private\n   */\n  onRtlStateUpdate_(rtlState) {\n    const mutator = () => {\n      rtlState\n        ? this.storyConsentEl_.setAttribute('dir', 'rtl')\n        : this.storyConsentEl_.removeAttribute('dir');\n    };\n\n    this.mutateElement(mutator, this.storyConsentEl_);\n  }\n\n  /**\n   * Validates the story-consent config. `story-consent` is a new parameter\n   * specific to stories, added on the `amp-consent` JSON config.\n   * @private\n   */\n  assertAndParseConfig_() {\n    // Validation of the amp-consent config is handled by the amp-consent\n    // javascript.\n    const parentEl = dev().assertElement(this.element.parentElement);\n    const consentScript = childElementByTag(parentEl, 'script');\n    this.consentConfig_ = consentScript && parseJson(consentScript.textContent);\n    this.mergeLegacyConsents_();\n\n    // amp-consent already triggered console errors, step out to avoid polluting\n    // the console.\n    if (!this.consentConfig_) {\n      return;\n    }\n\n    const storyConsentScript = childElementByTag(this.element, 'script');\n\n    userAssert(\n      storyConsentScript && isJsonScriptTag(storyConsentScript),\n      `${TAG} config should be put in a <script> tag with ` +\n        'type=\"application/json\"'\n    );\n\n    this.storyConsentConfig_ = {\n      ...DEFAULT_OPTIONAL_PARAMETERS,\n      ...parseJson(storyConsentScript.textContent),\n    };\n\n    user().assertString(\n      this.storyConsentConfig_.title,\n      `${TAG}: config requires a title`\n    );\n    user().assertString(\n      this.storyConsentConfig_.message,\n      `${TAG}: config requires a message`\n    );\n    userAssert(\n      this.storyConsentConfig_.vendors &&\n        isArray(this.storyConsentConfig_.vendors),\n      `${TAG}: config requires an array of vendors`\n    );\n    user().assertBoolean(\n      this.storyConsentConfig_.onlyAccept,\n      `${TAG}: config requires \"onlyAccept\" to be a boolean`\n    );\n\n    // Runs the validation if any of the title or link are provided, since\n    // both have to be provided for the external link to be displayed.\n    if (\n      this.storyConsentConfig_.externalLink.href ||\n      this.storyConsentConfig_.externalLink.title\n    ) {\n      user().assertString(\n        this.storyConsentConfig_.externalLink.title,\n        `${TAG}: config requires \"externalLink.title\" to be a string`\n      );\n      user().assertString(\n        this.storyConsentConfig_.externalLink.href,\n        `${TAG}: config requires \"externalLink.href\" to be an absolute URL`\n      );\n      assertAbsoluteHttpOrHttpsUrl(this.storyConsentConfig_.externalLink.href);\n    }\n  }\n\n  /**\n   * Merge legacy `consents` policy object from\n   * amp-consent config into top level.\n   * @private\n   */\n  mergeLegacyConsents_() {\n    const legacyConsents = this.consentConfig_['consents'];\n    if (legacyConsents) {\n      const policyId = Object.keys(legacyConsents)[0];\n      const policy = legacyConsents[policyId];\n      this.consentConfig_.consentInstanceId = policyId;\n      this.consentConfig_.checkConsentHref = policy.checkConsentHref;\n      this.consentConfig_.promptIfUnknownForGeoGroup =\n        policy.promptIfUnknownForGeoGroup;\n      delete this.consentConfig_['consents'];\n    }\n  }\n\n  /**\n   * @param {string} consentId\n   * @private\n   */\n  storeConsentId_(consentId) {\n    // checkConsentHref response overrides the amp-geo config, if provided.\n    if (this.consentConfig_.checkConsentHref) {\n      this.storeService_.dispatch(Action.SET_CONSENT_ID, consentId);\n      return;\n    }\n\n    // If using amp-access with amp-geo, only set the consent id if the user is\n    // in the expected geo group.\n    const geoGroup = this.consentConfig_.promptIfUnknownForGeoGroup;\n    if (geoGroup) {\n      Services.geoForDocOrNull(this.element).then((geo) => {\n        const matchedGeoGroups = /** @type {!Array<string>} */ (\n          geo.matchedISOCountryGroups\n        );\n        if (geo && !matchedGeoGroups.includes(geoGroup)) {\n          return;\n        }\n        this.storeService_.dispatch(Action.SET_CONSENT_ID, consentId);\n      });\n    }\n  }\n\n  /**\n   * Sets the accept button font color to either white or black, depending on\n   * the publisher custom background color.\n   * Must be called from the `buildCallback` or in another vsync mutate state.\n   * @private\n   */\n  setAcceptButtonFontColor_() {\n    const buttonEl = dev().assertElement(\n      this.storyConsentEl_.querySelector(\n        '.i-amphtml-story-consent-action-accept'\n      )\n    );\n    const styles = computedStyle(this.win, buttonEl);\n\n    const rgb = getRGBFromCssColorValue(styles['background-color']);\n    const color = getTextColorForRGB(rgb);\n\n    setImportantStyles(buttonEl, {color});\n  }\n}\n", "export const CSS = \".i-amphtml-story-hint-container{transition-property:opacity!important;transition-duration:200ms!important;contain:strict!important;pointer-events:none!important;position:absolute!important;left:0!important;top:0!important;right:0!important;bottom:0!important;z-index:2!important}.i-amphtml-story-hint-container.i-amphtml-hidden{opacity:0!important}.i-amphtml-story-hint-container .i-amphtml-story-navigation-help-overlay{position:absolute!important;left:0!important;top:0!important;right:0!important;bottom:0!important;background:rgba(0,0,0,0.7)!important;-ms-flex-direction:row!important;flex-direction:row!important;color:#fff!important;font-size:20px!important;padding:16px 0!important}.i-amphtml-story-navigation-help-section{position:relative!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important}.prev-page,[dir=rtl].prev-page{-ms-flex:1!important;flex:1!important}.show-first-page-overlay .i-amphtml-story-navigation-help-overlay{background:transparent!important}.show-first-page-overlay .prev-page{background:linear-gradient(90deg,rgba(0,0,0,0.5),transparent)!important}[dir=rtl].show-first-page-overlay .prev-page{background:linear-gradient(270deg,rgba(0,0,0,0.5),transparent)!important}.show-first-page-overlay .next-page{opacity:0!important}.show-first-page-overlay .i-amphtml-story-hint-placeholder{display:none!important}.show-first-page-overlay .i-amphtml-story-navigation-help-overlay{padding:0px!important}.i-amphtml-story-hint-container .next-page{-ms-flex:3!important;flex:3!important;background-image:linear-gradient(#e0d5d5 60%,rgba(255,255,255,0) 0)!important;background-position:0!important;background-size:1px 15px!important;background-repeat:repeat-y!important}[dir=rtl].i-amphtml-story-hint-container .next-page{border-left:none!important;background-position:100%!important}.show-first-page-overlay .i-amphtml-story-navigation-help-overlay,.show-navigation-overlay .i-amphtml-story-navigation-help-overlay{display:-ms-flexbox!important;display:flex!important}.show-first-page-overlay .prev-page .i-amphtml-story-hint-tap-button{visibility:hidden}.show-navigation-overlay .prev-page .i-amphtml-story-hint-tap-button-icon:before{content:\\\"\\\"!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 24 24'%3E%3Cpath d='M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important;width:30px!important;height:30px!important;display:inline-block!important}[dir=rtl].show-navigation-overlay .prev-page .i-amphtml-story-hint-tap-button-icon:before{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 24 24'%3E%3Cpath d='M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-hint-container .i-amphtml-story-hint-tap-button{position:relative!important;width:44px!important;height:44px!important}.i-amphtml-story-hint-tap-button:after,.i-amphtml-story-hint-tap-button:before{position:absolute!important;content:\\\"\\\"!important;width:44px!important;height:44px!important;border-radius:50%!important;background-color:hsla(0,0%,100%,0.5)!important;left:0!important;right:0!important}.i-amphtml-story-hint-tap-button:before{animation:expandingBubble 1000ms cubic-bezier(0.4,0,0.2,1) infinite!important}.i-amphtml-story-hint-tap-button:after{background-color:#fff!important}.i-amphtml-story-hint-container .i-amphtml-story-hint-tap-button-icon{position:absolute!important;z-index:1!important;height:44px!important;width:44px!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;-ms-flex-align:center!important;align-items:center!important}.i-amphtml-story-hint-tap-button-icon:after,.i-amphtml-story-hint-tap-button-icon:before{vertical-align:middle!important;margin:0 2px!important;background-position:50%}.next-page .i-amphtml-story-hint-tap-button-icon:after{content:\\\"\\\"!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 24 24'%3E%3Cpath d='M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important;width:24px!important;height:24px!important;display:inline-block!important}[dir=rtl] .next-page .i-amphtml-story-hint-tap-button-icon:after{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 24 24'%3E%3Cpath d='M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-hint-placeholder{top:50%!important;position:absolute!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-direction:column!important;flex-direction:column!important;-ms-flex-align:center!important;align-items:center!important}.i-amphtml-story-hint-container .i-amphtml-story-hint-tap-button-text{color:#fff!important;font-size:16px!important;font-family:Roboto-Medium,sans-serif!important;margin-top:24px!important;text-align:center!important;word-break:break-word!important;padding:0 6px!important}@keyframes expandingBubble{0%{transform:scale(1);opacity:0}50%{transform:scale(1.5);opacity:1}to{transform:scale(1);opacity:0}}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story-hint.css*/\";\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CSS} from '../../../build/amp-story-hint-1.0.css';\nimport {\n  EmbeddedComponentState,\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {Services} from '../../../src/services';\nimport {createShadowRootWithStyle} from './utils';\nimport {dict} from '../../../src/core/types/object';\nimport {renderAsElement} from './simple-template';\n\n/** @private @const {!./simple-template.ElementDef} */\nconst TEMPLATE = {\n  tag: 'aside',\n  attrs: dict({\n    'class':\n      'i-amphtml-story-hint-container ' +\n      'i-amphtml-story-system-reset i-amphtml-hidden',\n  }),\n  children: [\n    {\n      tag: 'div',\n      attrs: dict({'class': 'i-amphtml-story-navigation-help-overlay'}),\n      children: [\n        {\n          tag: 'div',\n          attrs: dict({\n            'class': 'i-amphtml-story-navigation-help-section prev-page',\n          }),\n          children: [\n            {\n              tag: 'div',\n              attrs: dict({'class': 'i-amphtml-story-hint-placeholder'}),\n              children: [\n                {\n                  tag: 'div',\n                  attrs: dict({'class': 'i-amphtml-story-hint-tap-button'}),\n                  children: [\n                    {\n                      tag: 'div',\n                      attrs: dict({\n                        'class': 'i-amphtml-story-hint-tap-button-icon',\n                      }),\n                    },\n                  ],\n                },\n                {\n                  tag: 'div',\n                  attrs: dict({\n                    'class': 'i-amphtml-story-hint-tap-button-text',\n                  }),\n                  localizedStringId:\n                    LocalizedStringId.AMP_STORY_HINT_UI_PREVIOUS_LABEL,\n                },\n              ],\n            },\n          ],\n        },\n        {\n          tag: 'div',\n          attrs: dict({\n            'class': 'i-amphtml-story-navigation-help-section next-page',\n          }),\n          children: [\n            {\n              tag: 'div',\n              attrs: dict({'class': 'i-amphtml-story-hint-placeholder'}),\n              children: [\n                {\n                  tag: 'div',\n                  attrs: dict({'class': 'i-amphtml-story-hint-tap-button'}),\n                  children: [\n                    {\n                      tag: 'div',\n                      attrs: dict({\n                        'class': 'i-amphtml-story-hint-tap-button-icon',\n                      }),\n                    },\n                  ],\n                },\n                {\n                  tag: 'div',\n                  attrs: dict({\n                    'class': 'i-amphtml-story-hint-tap-button-text',\n                  }),\n                  localizedStringId:\n                    LocalizedStringId.AMP_STORY_HINT_UI_NEXT_LABEL,\n                },\n              ],\n            },\n          ],\n        },\n      ],\n    },\n  ],\n};\n\n/** @type {string} */\nconst NAVIGATION_OVERLAY_CLASS = 'show-navigation-overlay';\n\n/** @type {string} */\nconst FIRST_PAGE_OVERLAY_CLASS = 'show-first-page-overlay';\n\n/** @type {number} */\nconst NAVIGATION_OVERLAY_TIMEOUT = 3000;\n\n/** @type {number} */\nconst FIRST_PAGE_NAVIGATION_OVERLAY_TIMEOUT = 275;\n\n/**\n * User Hint Layer for <amp-story>.\n */\nexport class AmpStoryHint {\n  /**\n   * @param {!Window} win\n   * @param {!Element} parentEl Element where to append the component\n   */\n  constructor(win, parentEl) {\n    /** @private {!Window} */\n    this.win_ = win;\n\n    /** @private {boolean} Whether the component is built. */\n    this.isBuilt_ = false;\n\n    /** @private {!Document} */\n    this.document_ = this.win_.document;\n\n    /** @const @private {!../../../src/service/vsync-impl.Vsync} */\n    this.vsync_ = Services.vsyncFor(this.win_);\n\n    /** @const @private {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(this.win_);\n\n    /** @private {?Element} */\n    this.hintContainer_ = null;\n\n    /** @private {?(number|string)} */\n    this.hintTimeout_ = null;\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win_);\n\n    /** @private @const {!Element} */\n    this.parentEl_ = parentEl;\n  }\n\n  /**\n   * Builds the hint layer DOM.\n   */\n  build() {\n    if (this.isBuilt()) {\n      return;\n    }\n\n    this.isBuilt_ = true;\n\n    const root = this.document_.createElement('div');\n    this.hintContainer_ = renderAsElement(this.document_, TEMPLATE);\n    createShadowRootWithStyle(root, this.hintContainer_, CSS);\n\n    this.storeService_.subscribe(\n      StateProperty.RTL_STATE,\n      (rtlState) => {\n        this.onRtlStateUpdate_(rtlState);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.SYSTEM_UI_IS_VISIBLE_STATE,\n      (isVisible) => {\n        this.onSystemUiIsVisibleStateUpdate_(isVisible);\n      }\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.INTERACTIVE_COMPONENT_STATE,\n      /** @param {./amp-story-store-service.InteractiveComponentDef} component */ (\n        component\n      ) => {\n        this.hideOnFocusedState_(\n          component.state === EmbeddedComponentState.FOCUSED\n        );\n      }\n    );\n\n    this.vsync_.mutate(() => {\n      this.parentEl_.appendChild(root);\n    });\n  }\n\n  /**\n   * Whether the component is built.\n   * @return {boolean}\n   */\n  isBuilt() {\n    return this.isBuilt_;\n  }\n\n  /**\n   * Shows the given hint, only if not desktop.\n   * @param {string} hintClass\n   * @private\n   */\n  showHint_(hintClass) {\n    if (this.storeService_.get(StateProperty.UI_STATE) !== UIType.MOBILE) {\n      return;\n    }\n\n    this.build();\n\n    this.vsync_.mutate(() => {\n      this.hintContainer_.classList.toggle(\n        NAVIGATION_OVERLAY_CLASS,\n        hintClass == NAVIGATION_OVERLAY_CLASS\n      );\n      this.hintContainer_.classList.toggle(\n        FIRST_PAGE_OVERLAY_CLASS,\n        hintClass == FIRST_PAGE_OVERLAY_CLASS\n      );\n      this.hintContainer_.classList.remove('i-amphtml-hidden');\n\n      const hideTimeout =\n        hintClass == NAVIGATION_OVERLAY_CLASS\n          ? NAVIGATION_OVERLAY_TIMEOUT\n          : FIRST_PAGE_NAVIGATION_OVERLAY_TIMEOUT;\n      this.hideAfterTimeout(hideTimeout);\n    });\n  }\n\n  /**\n   * Show navigation overlay DOM.\n   */\n  showNavigationOverlay() {\n    // Don't show the overlay if the share menu is open.\n    if (this.storeService_.get(StateProperty.SHARE_MENU_STATE)) {\n      return;\n    }\n\n    this.showHint_(NAVIGATION_OVERLAY_CLASS);\n  }\n\n  /**\n   * Show navigation overlay DOM.\n   */\n  showFirstPageHintOverlay() {\n    this.showHint_(FIRST_PAGE_OVERLAY_CLASS);\n  }\n\n  /**\n   * Hides the overlay after a given time\n   * @param {number} timeout\n   */\n  hideAfterTimeout(timeout) {\n    this.hintTimeout_ = this.timer_.delay(() => this.hideInternal_(), timeout);\n  }\n\n  /**\n   * Hide all navigation hints.\n   */\n  hideAllNavigationHint() {\n    this.hideInternal_();\n\n    if (this.hintTimeout_ !== null) {\n      this.timer_.cancel(this.hintTimeout_);\n      this.hintTimeout_ = null;\n    }\n  }\n\n  /** @private */\n  hideInternal_() {\n    if (!this.isBuilt()) {\n      return;\n    }\n\n    this.vsync_.mutate(() => {\n      this.hintContainer_.classList.add('i-amphtml-hidden');\n    });\n  }\n\n  /**\n   * Reacts to RTL state updates and triggers the UI for RTL.\n   * @param {boolean} rtlState\n   * @private\n   */\n  onRtlStateUpdate_(rtlState) {\n    this.vsync_.mutate(() => {\n      rtlState\n        ? this.hintContainer_.setAttribute('dir', 'rtl')\n        : this.hintContainer_.removeAttribute('dir');\n    });\n  }\n\n  /**\n   * Reacts to system UI visibility state updates.\n   * @param {boolean} isVisible\n   * @private\n   */\n  onSystemUiIsVisibleStateUpdate_(isVisible) {\n    if (!isVisible) {\n      this.hideAllNavigationHint();\n    }\n  }\n\n  /**\n   * Hides navigation hint if tooltip is open.\n   * @param {boolean} isActive\n   * @private\n   */\n  hideOnFocusedState_(isActive) {\n    if (isActive) {\n      this.hideAllNavigationHint();\n    }\n  }\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CommonSignals} from '../../../src/core/constants/common-signals';\nimport {Services} from '../../../src/services';\nimport {whenUpgradedToCustomElement} from '../../../src/dom';\n\n/**\n * Maximum milliseconds to wait for service to load.\n * Needs to be shorter than the render delay timeout to account for the latency\n * downloading and executing the amp-story js.\n * @const\n */\nconst LOAD_TIMEOUT = 2900;\n\n/** @implements {../../../src/render-delaying-services.RenderDelayingService} */\nexport class AmpStoryRenderService {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /**\n     * @private {!../../../src/service/ampdoc-impl.AmpDoc}\n     */\n    this.ampdoc_ = ampdoc;\n\n    /** @const @private {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(ampdoc.win);\n  }\n\n  /**\n   * Function to return a promise for when it is finished delaying render, and\n   * is ready.  Implemented from RenderDelayingService\n   * @return {!Promise}\n   */\n  whenReady() {\n    const whenReadyPromise = this.ampdoc_.whenReady().then((body) => {\n      const storyEl = body.querySelector('amp-story[standalone]');\n\n      if (!storyEl) {\n        return;\n      }\n\n      return whenUpgradedToCustomElement(storyEl).then(() => {\n        return storyEl.signals().whenSignal(CommonSignals.LOAD_END);\n      });\n    });\n\n    return Promise.race([whenReadyPromise, this.timer_.promise(LOAD_TIMEOUT)]);\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Action,\n  StateProperty,\n  getStoreService,\n} from './amp-story-store-service';\nimport {AnalyticsVariable, getVariableService} from './variable-service';\nimport {dev, user} from '../../../src/log';\nimport {dict} from '../../../src/core/types/object';\n\n/** @type {string} */\nconst TAG = 'amp-story-viewer-messaging-handler';\n\n/** @enum {number} */\nconst DataSources = {\n  STORE_SERVICE: 0,\n  VARIABLE_SERVICE: 2,\n};\n\n/**\n * @typedef {{\n *   dataSource: !DataSources,\n *   property: (!StateProperty|!AnalyticsVariable)\n * }}\n */\nlet GetStateConfigurationDef;\n\n/** @enum {!GetStateConfigurationDef} */\nconst GET_STATE_CONFIGURATIONS = {\n  'CURRENT_PAGE_ID': {\n    dataSource: DataSources.STORE_SERVICE,\n    property: StateProperty.CURRENT_PAGE_ID,\n  },\n  'EDUCATION_STATE': {\n    dataSource: DataSources.STORE_SERVICE,\n    property: StateProperty.EDUCATION_STATE,\n  },\n  'MUTED_STATE': {\n    dataSource: DataSources.STORE_SERVICE,\n    property: StateProperty.MUTED_STATE,\n  },\n  'PAGE_ATTACHMENT_STATE': {\n    dataSource: DataSources.STORE_SERVICE,\n    property: StateProperty.PAGE_ATTACHMENT_STATE,\n  },\n  'STORY_PROGRESS': {\n    dataSource: DataSources.VARIABLE_SERVICE,\n    property: AnalyticsVariable.STORY_PROGRESS,\n  },\n};\n\n/** @typedef {{action: !Action, isValueValid: function(*):boolean}} */\nlet SetStateConfigurationDef;\n\n/** @enum {!SetStateConfigurationDef} */\nconst SET_STATE_CONFIGURATIONS = {\n  'MUTED_STATE': {\n    action: Action.TOGGLE_MUTED,\n    isValueValid: (value) => typeof value === 'boolean',\n  },\n};\n\n/**\n * Viewer messaging handler.\n */\nexport class AmpStoryViewerMessagingHandler {\n  /**\n   * @param {!Window} win\n   * @param {!../../../src/service/viewer-interface.ViewerInterface} viewer\n   */\n  constructor(win, viewer) {\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(win);\n\n    /** @private @const {!./variable-service.AmpStoryVariableService} */\n    this.variableService_ = getVariableService(win);\n\n    /** @private @const {!../../../src/service/viewer-interface.ViewerInterface} */\n    this.viewer_ = viewer;\n  }\n\n  /**\n   * @public\n   */\n  startListening() {\n    this.viewer_.onMessageRespond('getDocumentState', (data) =>\n      this.onGetDocumentState_(data)\n    );\n    this.viewer_.onMessage('onDocumentState', (data) =>\n      this.onOnDocumentState_(data)\n    );\n    this.viewer_.onMessageRespond('setDocumentState', (data) =>\n      this.onSetDocumentState_(data)\n    );\n    this.viewer_.onMessageRespond('customDocumentUI', (data) =>\n      this.onCustomDocumentUI_(data)\n    );\n  }\n\n  /**\n   * @param {string} eventType\n   * @param {?JsonObject|string|undefined} data\n   * @param {boolean=} cancelUnsent\n   */\n  send(eventType, data, cancelUnsent = false) {\n    this.viewer_.sendMessage(eventType, data, cancelUnsent);\n  }\n\n  /**\n   * Handles 'getDocumentState' viewer messages.\n   * @param {!Object=} data\n   * @return {!Promise}\n   * @private\n   */\n  onGetDocumentState_(data = {}) {\n    const {state} = data;\n    const config = GET_STATE_CONFIGURATIONS[state];\n\n    if (!config) {\n      return Promise.reject(`Invalid 'state' parameter`);\n    }\n\n    let value;\n\n    switch (config.dataSource) {\n      case DataSources.STORE_SERVICE:\n        value = this.storeService_.get(config.property);\n        break;\n      case DataSources.VARIABLE_SERVICE:\n        value = this.variableService_.get()[config.property];\n        break;\n      default:\n        dev().error(TAG, 'Unknown data source %s.', config.dataSource);\n        break;\n    }\n\n    return Promise.resolve({state, value});\n  }\n\n  /**\n   * Handles 'onDocumentState' viewer messages.\n   * @param {!Object=} data\n   * @private\n   */\n  onOnDocumentState_(data = {}) {\n    const {state} = data;\n    const config = GET_STATE_CONFIGURATIONS[state];\n\n    if (!config) {\n      user().error(TAG, `Invalid 'state' parameter`);\n      return;\n    }\n\n    this.storeService_.subscribe(config.property, (value) => {\n      this.viewer_.sendMessage(\n        'documentStateUpdate',\n        dict({'state': state, 'value': value})\n      );\n    });\n  }\n\n  /**\n   * Handles 'setDocumentState' viewer messages.\n   * @param {!Object=} data\n   * @return {!Promise<!Object|undefined>}\n   * @private\n   */\n  onSetDocumentState_(data = {}) {\n    const {state, value} = data;\n    const config = SET_STATE_CONFIGURATIONS[state];\n\n    if (!config) {\n      return Promise.reject(`Invalid 'state' parameter`);\n    }\n\n    if (!config.isValueValid(value)) {\n      return Promise.reject(`Invalid 'value' parameter`);\n    }\n\n    this.storeService_.dispatch(config.action, value);\n\n    return Promise.resolve({state, value});\n  }\n\n  /**\n   * Handles 'customDocumentUI' viewer messages.\n   * @param {!Object} data\n   * @private\n   */\n  onCustomDocumentUI_(data) {\n    this.storeService_.dispatch(\n      Action.SET_VIEWER_CUSTOM_CONTROLS,\n      data.controls\n    );\n  }\n}\n", "export const CSS = \"amp-story-access{position:absolute!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-direction:column!important;flex-direction:column!important;top:0!important;left:0!important;height:100%!important;width:100%!important;z-index:100003!important;transform:translate3d(0,100vh,0)!important;transition-delay:0.15s!important;pointer-events:none!important}amp-story-access[amp-access-hide]{display:none!important}amp-story-access[type=blocking]{z-index:100004!important}amp-story-access.i-amphtml-story-access-visible{transform:translateZ(0)!important;transition-delay:0s!important}amp-story-access[type=blocking]:before{content:\\\"\\\"!important;position:absolute!important;top:0!important;left:0!important;height:100%!important;width:100%!important;background:#000!important;opacity:0!important;pointer-events:auto!important;transition:opacity 0.15s cubic-bezier(0.4,0.0,1,1)!important}amp-story-access[type=blocking].i-amphtml-story-access-visible:before{opacity:0.55!important;transition:opacity 0.2s cubic-bezier(0.0,0.0,0.2,1)!important}.i-amphtml-story-access-overflow{margin-top:auto!important;overflow-y:auto!important;overflow-x:hidden!important;pointer-events:auto!important;-webkit-overflow-scrolling:touch!important}.i-amphtml-story-access-container{position:relative!important;margin:88px 0 0!important;padding:0px!important;background:#fff!important;border-radius:8px 8px 0 0!important;color:rgba(0,0,0,0.87)!important;font-family:Roboto,sans-serif!important;overflow:hidden!important;text-align:start!important;transform:translate3d(0,100%,0)!important;transition:transform 0.15s cubic-bezier(0.4,0.0,1,1)!important}.i-amphtml-story-access-visible .i-amphtml-story-access-container{transform:translateZ(0)!important;transition:transform 0.2s cubic-bezier(0.0,0.0,0.2,1)!important}[type=notification] .i-amphtml-story-access-container{box-shadow:0 -1px 2px 1px rgba(0,0,0,0.12)!important;max-height:calc(var(--story-page-vh, 1vh)*20)!important}.i-amphtml-story-access-header{position:relative!important;margin:0 0 48px!important;height:80px!important;min-height:80px!important;background:var(--primary-color,#f0f0f0)!important;z-index:2!important}.i-amphtml-story-access-logo{position:absolute!important;bottom:-32px!important;margin-left:-32px!important;left:50%!important;height:64px!important;width:64px!important;background:#f0f0f0!important;background-position:50%!important;background-repeat:no-repeat!important;background-size:contain!important;border-radius:5px!important}.i-amphtml-story-access-logo:before{content:\\\"\\\"!important;position:absolute!important;top:-6px!important;bottom:-6px!important;left:-6px!important;right:-6px!important;background:#fff!important;border-radius:6px!important;box-shadow:0 2px 3px rgba(0,0,0,0.12)!important;z-index:-1!important}.i-amphtml-story-access-close-button{position:absolute!important;top:0!important;right:0!important;height:36px!important;width:36px!important;color:#757575!important;cursor:pointer!important;font-size:24px!important;line-height:36px!important;text-align:center!important}.i-amphtml-story-access-content{padding:16px!important;font-size:14px!important;z-index:0!important}@media (min-width:420px){amp-story-access{-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important}.i-amphtml-story-access-container{margin:0!important;width:calc(100vw - 80px)!important;max-width:800px!important}.i-amphtml-story-access-content{margin:0 auto!important;max-width:424px!important;-ms-flex-positive:1!important;flex-grow:1!important;overflow-y:auto!important}.i-amphtml-story-access-content::-webkit-scrollbar,.i-amphtml-story-access-overflow::-webkit-scrollbar{width:0px!important;background:transparent!important}[type=blocking] .i-amphtml-story-access-overflow{margin-top:0!important;border-radius:6px!important;box-shadow:0 1px 3px 1px rgba(0,0,0,0.2)!important}[type=blocking] .i-amphtml-story-access-container{display:-ms-flexbox!important;display:flex!important;-ms-flex-direction:column!important;flex-direction:column!important;max-height:60vh!important;min-height:20vh!important;border-radius:0px!important;opacity:0!important;transform:translateZ(0)!important;transition:opacity 0.15s cubic-bezier(0.4,0.0,1,1)!important}[type=blocking].i-amphtml-story-access-visible .i-amphtml-story-access-container{opacity:1!important;transition:opacity 0.2s cubic-bezier(0.0,0.0,0.2,1)!important}}[affiliate-link-icon]{position:relative!important;width:50px!important;height:50px!important}[affiliate-link-icon]:not([expanded]),[affiliate-link-icon]:not([expanded]) .i-amphtml-story-affiliate-link-circle{animation:i-amphtml-story-affiliate-link-collapse 0.2s cubic-bezier(0.4,0.0,0.2,1) forwards!important}[affiliate-link-icon][pristine],[affiliate-link-icon][pristine] .i-amphtml-story-affiliate-link-circle{animation:none!important}amp-story-page[active] [affiliate-link-icon][expanded],amp-story-page[active] [affiliate-link-icon][expanded] .i-amphtml-story-affiliate-link-circle{animation:i-amphtml-story-affiliate-link-expand 0.2s cubic-bezier(0.4,0.0,0.2,1) forwards!important;transform-origin:left!important}@keyframes i-amphtml-story-affiliate-link-expand{0%{width:40px;border-radius:50%}to{width:160px;border-radius:20px}}@keyframes i-amphtml-story-affiliate-link-collapse{0%{width:160px;border-radius:20px}to{width:40px;border-radius:50%}}.i-amphtml-story-affiliate-link-circle{position:absolute!important;background:#fff!important;margin:5px!important;width:40px!important;height:40px!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:justify!important;justify-content:space-between!important;border-radius:20px!important}[affiliate-link-icon][expanded] .i-amphtml-story-affiliate-link-circle{overflow:hidden!important}[affiliate-link-icon] .i-amphtml-story-reset.i-amphtml-hidden{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:justify!important;justify-content:space-between!important}.i-amphtml-story-affiliate-link-text{visibility:hidden!important;text-align:center!important;text-overflow:ellipsis!important;overflow:hidden!important;white-space:nowrap!important;max-width:70px!important;width:70px!important;font-family:Roboto,sans-serif!important;font-size:14px!important;color:#3c4043!important;letter-spacing:0!important;line-height:40px!important}.i-amphtml-story-affiliate-link-launch{visibility:hidden!important;background-position:50%!important;background-repeat:no-repeat!important;background-size:18px 18px!important;width:40px!important;height:40px!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 48 48' fill='%23757575'%3E%3Cpath d='M0 0h48v48H0z' fill='none'/%3E%3Cpath d='M38 38H10V10h14V6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h28c2.21 0 4-1.79 4-4V24h-4v14zM28 6v4h7.17L15.51 29.66l2.83 2.83L38 12.83V20h4V6H28z'/%3E%3C/svg%3E\\\")!important}amp-story-page[active] .i-amphtml-story-affiliate-link-pulse{position:absolute!important;border-radius:50%!important;background:hsla(0,0%,100%,0.4)!important;margin:5px!important;width:40px!important;height:40px!important;animation:pulse 1.5s cubic-bezier(0.4,0.0,0.2,1) infinite alternate!important}@keyframes pulse{0%{transform:scale(1)}to{transform:scale(1.3)}}[affiliate-link-icon][expanded] .i-amphtml-story-affiliate-link-pulse{animation:none!important}[affiliate-link-icon][expanded] .i-amphtml-story-affiliate-link-launch,[affiliate-link-icon][expanded] .i-amphtml-story-affiliate-link-text{visibility:visible!important}@media any-hover{[affiliate-link-icon]:hover .i-amphtml-story-affiliate-link-circle{background:hsla(0,0%,100%,0.4)!important}[affiliate-link-icon]:hover .i-amphtml-story-affiliate-link-pulse{background:none!important;animation:none!important}}.i-amphtml-story-affiliate-link-icon{background-position:50%!important;background-repeat:no-repeat!important;background-size:24px 24px!important;color:rgba(0,0,0,0.54)!important;width:40px!important;height:40px!important}[affiliate-link-icon=shopping-cart] .i-amphtml-story-affiliate-link-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23005AF0'%3E%3Cpath d='M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1.003 1.003 0 0 0 20 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important}[affiliate-link-icon=offer] .i-amphtml-story-affiliate-link-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23005AF0'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='m21.41 11.58-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z'/%3E%3C/svg%3E\\\")!important}[affiliate-link-icon=flight] .i-amphtml-story-affiliate-link-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23005AF0'%3E%3Cpath d='M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important}[affiliate-link-icon=hotel] .i-amphtml-story-affiliate-link-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23005AF0'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z'/%3E%3C/svg%3E\\\")!important}[affiliate-link-icon=movie] .i-amphtml-story-affiliate-link-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23005AF0'%3E%3Cpath d='m18 4 2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important}[affiliate-link-icon=activity] .i-amphtml-story-affiliate-link-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23005AF0'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M20 12c0-1.1.9-2 2-2V6c0-1.1-.9-2-2-2H4c-1.1 0-1.99.9-1.99 2v4c1.1 0 1.99.9 1.99 2s-.89 2-2 2v4c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-4c-1.1 0-2-.9-2-2zm-4.42 4.8L12 14.5l-3.58 2.3 1.08-4.12-3.29-2.69 4.24-.25L12 5.8l1.54 3.95 4.24.25-3.29 2.69 1.09 4.11z'/%3E%3C/svg%3E\\\")!important}[affiliate-link-icon=more-to-read] .i-amphtml-story-affiliate-link-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23005AF0'%3E%3Cpath fill='none' d='M-74 29h48v48h-48V29zM0 0h24v24H0V0zm0 0h24v24H0V0z'/%3E%3Cpath d='M13 12h7v1.5h-7zm0-2.5h7V11h-7zm0 5h7V16h-7zM21 4H3c-1.1 0-2 .9-2 2v13c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 15h-9V6h9v13z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-background{background-color:transparent}amp-sidebar{background-color:#fff}amp-story[standalone].i-amphtml-story-desktop-panels{max-width:none!important;max-height:none!important;width:100vw!important;--i-amphtml-story-inactive-page-scale-factor:0.9}.i-amphtml-story-desktop-panels amp-story-page.i-amphtml-element{transform:perspective(1px) scale(var(--i-amphtml-story-inactive-page-scale-factor)) translateX(calc(250% + 192px)) translateY(0%)!important;opacity:0.05!important;transform-origin:left!important;border-radius:0!important;box-shadow:none!important}.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-visited],[dir=rtl] .i-amphtml-story-desktop-panels amp-story-page.i-amphtml-element{transform:perspective(1px) scale(var(--i-amphtml-story-inactive-page-scale-factor)) translateX(calc(-350% - 192px)) translateY(0%)!important}[dir=rtl] .i-amphtml-story-desktop-panels amp-story-page[i-amphtml-visited]{transform:perspective(1px) scale(var(--i-amphtml-story-inactive-page-scale-factor)) translateX(calc(250% + 192px)) translateY(0%)!important}.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"1\\\"],.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"2\\\"],.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"-1\\\"],.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"-2\\\"]{transition:opacity 350ms ease-out,transform 350ms cubic-bezier(0.4,0.0,0.2,1)!important}.i-amphtml-story-desktop-panels amp-story-page[active],.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"0\\\"],[dir=rtl] .i-amphtml-story-desktop-panels amp-story-page[active],[dir=rtl] .i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"0\\\"]{transform:perspective(1px) scale(1.0) translateX(calc(var(--i-amphtml-story-page-50vw, 50%)*-1)) translateY(0%)!important;opacity:1!important;transition:opacity 350ms cubic-bezier(0.0,0.0,0.2,1),transform 350ms cubic-bezier(0.4,0.0,0.2,1)!important}.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"-2\\\"],[dir=rtl] .i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"2\\\"]{transform:perspective(1px) scale(var(--i-amphtml-story-inactive-page-scale-factor)) translateX(calc(var(--i-amphtml-story-page-50vw, 50%)*-5 - 128px)) translateY(0%)!important}.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"-1\\\"],[dir=rtl] .i-amphtml-story-desktop-panels amp-story-page[active]+amp-story-page:not([i-amphtml-desktop-position]):not([distance]),[dir=rtl] .i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"1\\\"]{transform:perspective(1px) scale(var(--i-amphtml-story-inactive-page-scale-factor)) translateX(calc(var(--i-amphtml-story-page-50vw, 50%)*-3 - 64px)) translateY(0%)!important}.i-amphtml-story-desktop-panels .prev-container,[dir=rtl] .i-amphtml-story-desktop-panels .next-container{left:calc(50% - var(--i-amphtml-story-page-50vw, 50%)*var(--i-amphtml-story-inactive-page-scale-factor)*3 - 64px*var(--i-amphtml-story-inactive-page-scale-factor))!important}.i-amphtml-story-desktop-panels .next-container,[dir=rtl] .i-amphtml-story-desktop-panels .prev-container{left:calc(var(--i-amphtml-story-page-50vw, 50%)*var(--i-amphtml-story-inactive-page-scale-factor) + 50% + 64px*var(--i-amphtml-story-inactive-page-scale-factor))!important}.i-amphtml-story-desktop-panels amp-story-page[active]+amp-story-page:not([i-amphtml-desktop-position]):not([distance]),.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"1\\\"],[dir=rtl] .i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"-1\\\"]{transform:perspective(1px) scale(var(--i-amphtml-story-inactive-page-scale-factor)) translate(calc(var(--i-amphtml-story-page-50vw, 50%) + 64px))!important}.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"2\\\"],[dir=rtl] .i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"-2\\\"]{transform:perspective(1px) scale(var(--i-amphtml-story-inactive-page-scale-factor)) translate(calc(var(--i-amphtml-story-page-50vw, 50%)*3 + 128px))!important}.i-amphtml-story-next-hover>amp-story-page[i-amphtml-desktop-position=\\\"1\\\"],.i-amphtml-story-prev-hover>amp-story-page[i-amphtml-desktop-position=\\\"-1\\\"]{opacity:0.3!important}.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"1\\\"][amp-access-hide]:before{content:\\\"\\\"!important;position:absolute!important;top:50%!important;left:50%!important;margin:-48px 0 0 -48px!important;width:96px!important;height:96px!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='96' height='96' viewBox='0 0 24 24' fill='%23FFF'%3E%3Cdefs%3E%3Cpath id='a' d='M0 0h24v24H0V0z'/%3E%3C/defs%3E%3CclipPath id='b'%3E%3Cuse xlink:href='%23a' overflow='visible'/%3E%3C/clipPath%3E%3Cpath clip-path='url(%23b)' d='M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM8.9 6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2H8.9V6zM18 20H6V10h12v10z'/%3E%3C/svg%3E\\\")!important;z-index:4!important}.i-amphtml-story-desktop-panels amp-story-page[i-amphtml-desktop-position=\\\"1\\\"][amp-access-hide]>*{filter:blur(8px)!important}.i-amphtml-story-desktop-panels .i-amphtml-story-media-query-matcher,.i-amphtml-story-desktop-panels>amp-story-page{left:50%!important;right:auto!important;margin:auto!important;max-height:75vh!important;max-width:45vh!important;min-width:320px!important;min-height:533px!important}.i-amphtml-story-desktop-panels .i-amphtml-story-button-container{height:calc(75vh*var(--i-amphtml-story-inactive-page-scale-factor))!important;width:calc(45vh*var(--i-amphtml-story-inactive-page-scale-factor))!important;min-width:calc(320px*var(--i-amphtml-story-inactive-page-scale-factor))!important;min-height:calc(533px*var(--i-amphtml-story-inactive-page-scale-factor))!important}.amp-story-draggable-drawer-root{display:block!important;position:absolute!important;top:0!important;left:0!important;height:100%!important;width:100%!important;overflow:hidden!important;z-index:4!important;transform:translate3d(0,100%,0)!important;transition:transform 0.25s cubic-bezier(0.4,0.0,1,1),visibility 0s linear 0.4s!important;visibility:hidden!important}.amp-story-draggable-drawer-root[hidden]{display:none!important}.amp-story-draggable-drawer-root.i-amphtml-story-draggable-drawer-open{transform:translateZ(0)!important;transition:transform 0.4s cubic-bezier(0.0,0.0,0.2,1),visibility 0s linear 0s!important;visibility:visible!important}.i-amphtml-story-draggable-drawer{height:100%!important}.i-amphtml-story-draggable-drawer-container{height:calc(100% - 40px)!important;background:#fff!important;overflow-y:auto!important;-webkit-overflow-scrolling:touch!important;transition:background 0.3s cubic-bezier(0.4,0.0,0.2,1)!important}.i-amphtml-story-draggable-drawer-theme-dark .i-amphtml-story-draggable-drawer-container{background:#202125!important}.i-amphtml-story-draggable-drawer-container[hidden]{display:block!important;background:hsla(0,0%,100%,0.92)!important}.i-amphtml-story-draggable-drawer-theme-dark .i-amphtml-story-draggable-drawer-container[hidden]{background:rgba(32,33,37,0.82)!important}.i-amphtml-story-draggable-drawer-content{opacity:1!important;transition:opacity 0.3s cubic-bezier(0.0,0.0,0.2,1)!important}.i-amphtml-story-draggable-drawer-container[hidden] .i-amphtml-story-draggable-drawer-content{opacity:0!important}.i-amphtml-story-draggable-drawer-container[hidden] .i-amphtml-story-draggable-drawer-content>*{display:none!important}[desktop] .amp-story-draggable-drawer-root{display:-ms-flexbox!important;display:flex!important;-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important;background:rgba(0,0,0,0.55)!important;opacity:0!important;transition:opacity 0.15s cubic-bezier(0.4,0.0,1,1),transform 0s linear 0.15s,visibility 0s linear 0.4s!important}[desktop] .amp-story-draggable-drawer-root.i-amphtml-story-draggable-drawer-open{opacity:1!important;transition:opacity 0.3s cubic-bezier(0.0,0.0,0.2,1),visibility 0s linear 0s!important;transform:translateZ(0)!important}[desktop] .i-amphtml-story-draggable-drawer{height:60vh!important;width:800px!important;border-radius:8px!important;overflow:hidden!important}[desktop] .i-amphtml-amp-story-page-attachment-ui-v2.amp-story-draggable-drawer-root{background:none!important}.i-amphtml-amp-story-page-attachment-ui-v2.amp-story-draggable-drawer-root{--i-amphtml-draggable-drawer-background-color:#fff!important;--i-amphtml-draggable-drawer-text-color:#202125!important}[theme=dark].i-amphtml-amp-story-page-attachment-ui-v2.amp-story-draggable-drawer-root{--i-amphtml-draggable-drawer-background-color:#202125!important;--i-amphtml-draggable-drawer-text-color:#fff!important}amp-story:not([desktop]) .i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-draggable-drawer-container{border-radius:16px!important;height:100%!important;border-radius:16px 16px 0 0!important;background:none!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-direction:column!important;flex-direction:column!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-draggable-drawer-spacer{display:none!important}amp-story:not([desktop]) .i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-draggable-drawer-spacer{background:none!important;display:block!important;height:calc(var(--story-page-vh)*100)!important;min-height:calc(var(--story-page-vh)*20)!important}body:not(.amp-mode-keyboard-active) amp-story:not([desktop]) .i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-draggable-drawer-spacer{outline:none!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-draggable-drawer-content{background:var(--i-amphtml-draggable-drawer-background-color)!important;color:var(--i-amphtml-draggable-drawer-text-color)!important}amp-story:not([desktop]) .i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-draggable-drawer-content{border-radius:inherit!important}:host{visibility:inherit!important}.i-amphtml-story-page-attachment-remote{height:48px!important;bottom:0!important;top:auto!important}.i-amphtml-story-page-attachment-remote .i-amphtml-story-draggable-drawer-container{height:100%!important;border-radius:8px 8px 0 0!important;box-shadow:0 1px 2px 1px rgba(0,0,0,0.12)!important}.i-amphtml-story-page-attachment-remote-content{display:-ms-flexbox!important;display:flex!important;padding:0 24px!important;-ms-flex-align:center!important;align-items:center!important;color:rgba(0,0,0,0.87)!important;font-family:Roboto,sans-serif!important;font-size:15px!important;-ms-flex-pack:justify!important;justify-content:space-between!important;line-height:48px!important;text-decoration:none!important}.i-amphtml-story-page-attachment-remote-title{max-width:calc(100% - 30px)!important;overflow:hidden!important;text-overflow:ellipsis!important}.i-amphtml-story-draggable-drawer-theme-dark .i-amphtml-story-page-attachment-remote-title{color:#9aa0a6!important}.i-amphtml-story-page-attachment-remote-icon{display:block!important;height:24px!important;width:24px!important;padding:0px!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 48 48' fill='%239AA0A6'%3E%3Cpath d='M0 0h48v48H0z' fill='none'/%3E%3Cpath d='M38 38H10V10h14V6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h28c2.21 0 4-1.79 4-4V24h-4v14zM28 6v4h7.17L15.51 29.66l2.83 2.83L38 12.83V20h4V6H28z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-page-attachment-expand{position:relative!important;width:100%!important;height:100%!important;background:#fff!important;z-index:100000!important;animation:i-amphtml-open-3p-attachment 120ms cubic-bezier(0.0,0.0,0.2,1) forwards!important}@keyframes i-amphtml-open-3p-attachment{0%{transform:scaleX(0);opacity:0.3}to{transform:scaleX(1);opacity:1}}amp-story[desktop] .i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-attachment-remote{display:none!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-attachment-remote{height:56px!important;--i-amphtml-outlink-cta-background-color:#fff!important;--i-amphtml-outlink-cta-text-color:#000!important}[theme=dark].i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-attachment-remote{--i-amphtml-outlink-cta-background-color:#000!important;--i-amphtml-outlink-cta-text-color:#fff!important}[href].i-amphtml-amp-story-page-attachment-ui-v2.amp-story-draggable-drawer-root.i-amphtml-story-draggable-drawer-open{transition-duration:.3s!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-remote-content{height:56px!important;padding-inline-start:12px!important;padding-inline-end:18px!important;background:var(--i-amphtml-outlink-cta-background-color)!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-remote-content .i-amphtml-story-page-attachment-remote-img,.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-remote-content .i-amphtml-story-page-open-attachment-link-icon{width:32px!important;height:32px!important;-ms-flex-negative:0!important;flex-shrink:0!important;padding:0px!important;border-radius:50%!important;background-size:cover!important;background-repeat:no-repeat!important;overflow:hidden!important}.i-amphtml-amp-story-page-attachment-ui-v2 svg.i-amphtml-story-page-open-attachment-link-icon{fill:var(--i-amphtml-outlink-cta-text-color)!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-remote-title{font-size:14px!important;padding:0 12px!important;color:var(--i-amphtml-outlink-cta-text-color)!important;display:-ms-flexbox!important;display:flex!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-remote-title :first-child{font-weight:700!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-remote-title :first-child:after{content:\\\"\\\\00a0 \\\"!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-remote-title :nth-child(2){white-space:nowrap!important;overflow:hidden!important;text-overflow:ellipsis!important}.i-amphtml-amp-story-page-attachment-ui-v2 .i-amphtml-story-page-attachment-remote-icon{margin-inline-start:auto!important;width:20px!important;height:20px!important;-ms-flex-negative:0!important;flex-shrink:0!important;fill:var(--i-amphtml-outlink-cta-text-color)!important;background:none!important}.i-amphtml-story-page-attachment-remote>a:first-child{display:none!important}.i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-attachment-remote.i-amphtml-story-draggable-drawer-open:after{content:\\\"\\\"!important;position:absolute!important;width:100%!important;height:4px!important;color:#000!important;bottom:0!important;background-color:var(--i-amphtml-outlink-cta-text-color)!important;opacity:.6!important;transform-origin:left!important;animation:progress-bar-animation .6s cubic-bezier(0.4,0.0,1,1) both!important}[dir=rtl] .i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-attachment-remote.i-amphtml-story-draggable-drawer-open:after{transform-origin:right!important}@keyframes progress-bar-animation{0%{transform:scaleX(0)}to{transform:scaleX(1)}}amp-story:not([desktop]) .i-amphtml-amp-story-page-attachment-ui-v2.i-amphtml-story-page-attachment-remote .i-amphtml-story-draggable-drawer-spacer{display:none!important}[orientation=landscape] [position=landscape-half-left]{width:50%!important;left:0!important;right:auto!important}[orientation=landscape] [position=landscape-half-right]{width:50%!important;left:auto!important;right:0!important}amp-story{font-display:optional}amp-story-grid-layer:not([aspect-ratio]){overflow:hidden}amp-story-grid-layer *{box-sizing:border-box;margin:0}.i-amphtml-story-grid-template-fill amp-anim img,.i-amphtml-story-grid-template-fill amp-img img,.i-amphtml-story-grid-template-fill amp-video video,.i-amphtml-story-grid-template-with-full-bleed-animation amp-img img{-o-object-fit:cover;object-fit:cover}.i-amphtml-story-grid-template-vertical{-ms-flex-line-pack:start;align-content:start;grid-gap:16px;-ms-flex-pack:stretch;justify-content:stretch;justify-items:start}.i-amphtml-story-grid-template-vertical>*{width:100%}.i-amphtml-story-grid-template-horizontal{-ms-flex-line-pack:stretch;align-content:stretch;-ms-flex-align:start;align-items:start;grid-gap:16px;-ms-flex-pack:start;justify-content:start}amp-story-grid-layer{padding:68px 32px 32px}amp-story-grid-layer.i-amphtml-story-has-page-attachment.i-amphtml-story-has-interactive{padding-bottom:104px}amp-story-grid-layer.i-amphtml-story-has-CTA-layer.i-amphtml-story-has-interactive{padding-bottom:20%}amp-story[standalone][i-amphtml-vertical]{height:auto!important;contain:initial!important}[i-amphtml-vertical] *{transition-delay:0s!important;transition-duration:0s!important}[i-amphtml-vertical] amp-story-page{position:relative!important;height:178vw!important;contain:initial!important;overflow:visible!important}amp-story[i-amphtml-vertical].i-amphtml-element amp-story-page.i-amphtml-element{transform:none!important}[i-amphtml-vertical] .i-amphtml-story-draggable-drawer-container[hidden] .i-amphtml-story-draggable-drawer-content{opacity:1!important}[i-amphtml-vertical] .i-amphtml-story-draggable-drawer-container[hidden] .i-amphtml-story-draggable-drawer-content>*{display:block!important}[i-amphtml-vertical] amp-story-page-attachment{display:block!important;position:relative!important;transform:none!important}[i-amphtml-vertical] .i-amphtml-story-page-attachment-remote-title{overflow:visible!important}[i-amphtml-vertical] .amp-story-draggable-drawer-root{visibility:visible!important}[i-amphtml-vertical] .i-amphtml-story-page-description{background:#fff!important;display:block!important;padding:32px!important;width:auto!important;z-index:9999999!important}[i-amphtml-vertical] .i-amphtml-story-page-description>*{background:#fff!important;color:#000!important;font-size:1rem!important}[i-amphtml-vertical] .i-amphtml-story-page-description>h2{font-size:1.5rem!important}.i-amphtml-story-button-container{cursor:pointer!important;position:absolute!important;width:30px!important;top:0!important;bottom:0!important;height:calc(100vh - 150px)!important;margin:auto 0!important;background:none!important;transition:opacity 150ms linear,visibility 150ms linear!important;outline:none!important;z-index:100002!important}amp-story:not([desktop]) .i-amphtml-story-button-container{pointer-events:none!important}.i-amphtml-story-button-container.next-container>.i-amphtml-story-button-move,.next-container{left:auto!important;right:0!important}[dir=rtl] .i-amphtml-story-button-container.next-container>.i-amphtml-story-button-move,[dir=rtl] .next-container{left:0!important;right:auto!important}.i-amphtml-story-desktop-fullbleed .i-amphtml-story-button-container{pointer-events:none!important}[dir=rtl] amp-story:not([desktop]) .i-amphtml-story-button-move,amp-story:not([desktop]) .i-amphtml-story-button-move{width:100%!important;height:100%!important;border:none!important;padding:0!important;pointer-events:none!important;background-repeat:no-repeat!important;background-color:transparent!important;filter:invert(100%) drop-shadow(0 0 3px rgba(0,0,0,0.5))!important}body:not(.amp-mode-keyboard-active) amp-story:not([desktop]) .i-amphtml-story-button-move{background:none!important}[desktop] .i-amphtml-story-button-move{display:-ms-flexbox!important;display:flex!important;position:fixed!important;top:0!important;bottom:0!important;margin:auto 40px!important;width:60px!important;height:60px!important;border-radius:50%!important;border:0!important;background-color:#fff!important;background-repeat:no-repeat!important;background-size:12px 17px!important;-ms-flex-pack:center!important;justify-content:center!important;-ms-flex-align:center!important;align-items:center!important;opacity:.5!important;transition:opacity 150ms linear,transform 350ms linear!important;cursor:pointer!important;pointer-events:all!important}.i-amphtml-story-desktop-fullbleed .i-amphtml-story-button-move{height:48px!important;width:48px!important;margin:auto 12px!important;background-color:transparent!important;background-size:auto!important;filter:drop-shadow(0 0 16px rgba(0,0,0,0.5))!important;opacity:1!important}.prev-container>.i-amphtml-story-button-move,[dir=rtl] .i-amphtml-story-fwd-next>.i-amphtml-story-button-move{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='16' height='25' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m15.7 22-9.5-9.5L15.7 3l-3-3L.4 12.6 12.8 25'/%3E%3C/svg%3E\\\")!important;background-position:45% 50%!important;left:0!important;right:auto!important}.i-amphtml-story-desktop-fullbleed .prev-container>.i-amphtml-story-button-move,.i-amphtml-story-desktop-fullbleed[dir=rtl] .i-amphtml-story-fwd-next>.i-amphtml-story-button-move{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 24 24' fill='%23FFF'%3E%3Cpath d='M11.67 3.87 9.9 2.1 0 12l9.9 9.9 1.77-1.77L3.54 12z'/%3E%3Cpath fill='none' d='M0 0h24v24H0z'/%3E%3C/svg%3E\\\")!important;background-position:10px 0!important}.i-amphtml-story-fwd-next>.i-amphtml-story-button-move,[dir=rtl] .prev-container>.i-amphtml-story-button-move{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='16' height='25' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m.3 3 9.5 9.5L.3 22l3 3 12.4-12.5L3.2 0'/%3E%3C/svg%3E\\\")!important;background-position:55% 50%!important;left:auto!important;right:0!important}.i-amphtml-story-desktop-fullbleed .i-amphtml-story-fwd-next>.i-amphtml-story-button-move,.i-amphtml-story-desktop-fullbleed[dir=rtl] .prev-container>.i-amphtml-story-button-move{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' fill='%23FFF'%3E%3Cpath d='M11.76 8.24 27.51 24 11.76 39.76 16 44l20-20L16 4z'/%3E%3Cpath fill='none' d='M0 0h48v48H0z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-fwd-replay{pointer-events:none!important}.i-amphtml-story-fwd-replay>.i-amphtml-story-button-move{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24'%3E%3Cpath d='M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important;background-position:50%;background-size:32px 32px!important}.i-amphtml-story-desktop-fullbleed .i-amphtml-story-fwd-replay>.i-amphtml-story-button-move{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' fill='%23FFF'%3E%3Cpath d='M0 0h48v48H0z' fill='none'/%3E%3Cpath d='M24 10V2L14 12l10 10v-8c6.63 0 12 5.37 12 12s-5.37 12-12 12-12-5.37-12-12H8c0 8.84 7.16 16 16 16s16-7.16 16-16-7.16-16-16-16z'/%3E%3C/svg%3E\\\")!important;background-size:auto!important}.i-amphtml-story-fwd-more>.i-amphtml-story-button-move{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z'/%3E%3C/svg%3E\\\")!important;background-position:50%;background-size:32px 32px!important}.i-amphtml-story-desktop-fullbleed .i-amphtml-story-fwd-more>.i-amphtml-story-button-move{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' fill='%23FFF'%3E%3Cpath d='M0 0h48v48H0z' fill='none'/%3E%3Cpath d='M12 20c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm24 0c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm-12 0c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z'/%3E%3C/svg%3E\\\")!important;background-size:auto!important}.i-amphtml-story-button-hidden{visibility:hidden!important;opacity:0!important;pointer-events:none!important}.i-amphtml-story-desktop-panels.i-amphtml-story-next-hover>.i-amphtml-story-fwd-next>.i-amphtml-story-button-move{transform:translateX(8px)!important;opacity:1!important}.i-amphtml-story-desktop-panels.i-amphtml-story-next-hover>.i-amphtml-story-fwd-replay>.i-amphtml-story-button-move{opacity:1!important}.i-amphtml-story-desktop-panels.i-amphtml-story-prev-hover>.i-amphtml-story-back-prev>.i-amphtml-story-button-move{transform:translateX(-8px)!important;opacity:1!important}amp-story,amp-story-cta-layer,amp-story-page{contain:strict!important;overflow:hidden!important;-webkit-touch-callout:none!important}amp-story-grid-layer{contain:size layout!important;-webkit-touch-callout:none!important}amp-story amp-consent{position:absolute!important;top:0!important;left:0!important;height:100%!important;width:100%!important;background:none!important;z-index:initial!important}@media (prefers-reduced-motion:reduce){*,:after,:before{animation-duration:0s!important;transition-duration:0s!important}}amp-consent.amp-hidden{display:none!important}.i-amphtml-story-system-reset,.i-amphtml-story-system-reset *{border:none!important;box-sizing:initial!important;color:initial!important;font-family:Roboto,sans-serif!important;font-size:initial!important;font-weight:initial!important;height:auto!important;margin:0!important;padding:0!important;text-align:start!important;text-shadow:none!important;width:auto!important}amp-story{height:100%!important;position:relative!important;text-rendering:geometricPrecision!important;-webkit-user-select:none!important;-ms-user-select:none!important;user-select:none!important;width:100%!important;-ms-touch-action:manipulation!important;touch-action:manipulation!important}html.i-amphtml-story-standalone{font-size:calc(var(--story-page-vmax, 8px)*2.5)}html.i-amphtml-story-standalone,html.i-amphtml-story-standalone body{font-size:calc(var(--story-page-vh, 8px)*2.5);height:100%!important;margin:0!important;padding:0!important;width:100%!important;border:0!important;cursor:auto!important;-webkit-tap-highlight-color:rgba(0,0,0,0)!important}h4,p{font-size:1rem}h1{font-size:2rem}h2{font-size:1.5rem}h3{font-size:1.17rem}h5{font-size:0.83rem}h6{font-size:0.67rem}html.i-amphtml-story-standalone #i-amphtml-wrapper body{border-top:none!important;overflow:hidden!important}amp-story[standalone]{-ms-flex-item-align:center!important;align-self:center!important;box-shadow:2px 2px 20px rgba(0,0,0,0.5)!important;height:100%!important;justify-self:center!important;max-height:initial!important;max-width:initial!important;min-height:initial!important;min-width:initial!important}amp-story[standalone].amp-notbuilt{min-height:1px!important}amp-story[standalone]:-webkit-full-screen{height:100vh!important;max-height:none!important;max-width:none!important}amp-story[standalone]:-ms-fullscreen{height:100vh!important;max-height:none!important;max-width:none!important}amp-story[standalone]:fullscreen{height:100vh!important;max-height:none!important;max-width:none!important}amp-story[hide]{display:none!important}amp-story .amp-video-eq{height:14px!important;width:14px!important}amp-story .amp-video-eq .amp-video-eq-col{margin-right:2px!important}amp-story .amp-video-eq .amp-video-eq-col:last-child{margin-right:0!important}.i-amphtml-story-no-audio-ui .amp-video-eq,amp-story .amp-video-eq:not(.amp-video-eq-play){display:none!important}.i-amphtml-story-media-query-matcher,amp-story-page{bottom:0!important;height:auto!important;left:0!important;position:absolute!important;right:0!important;top:0!important;opacity:1!important;-ms-touch-action:none!important;touch-action:none!important;transition:none!important;z-index:0!important}.i-amphtml-story-media-query-matcher{height:inherit!important;width:inherit!important;border:0!important;z-index:-1!important}amp-story-page[active]{z-index:1!important}.i-amphtml-story-sidebar[open]{animation-timing-function:cubic-bezier(0.0,0.0,0.2,1)!important;animation-duration:0.3s!important;animation-name:i-amphtml-sidebar-slide-in-right}[desktop] .i-amphtml-story-sidebar{min-width:25%!important;max-width:600px!important}.i-amphtml-story-sidebar{min-width:75%!important;max-width:360px!important;animation-timing-function:cubic-bezier(0.4,0.0,1,1)!important;animation-duration:0.2s!important;animation-name:i-amphtml-sidebar-slide-out-right}amp-story-page:not(:first-of-type):not([distance]):not([active]),amp-story-page:not([active]){transform:translateY(1000vh)!important}amp-story-page[active],amp-story-page[distance=\\\"0\\\"],amp-story-page[distance=\\\"1\\\"]{transform:translateY(0)!important}amp-story-page[distance=\\\"2\\\"]{transform:translateY(100%)!important}amp-story-page [data-text-background-color]{border-radius:3px!important;line-height:1.5em!important;padding:2px 4px!important;text-indent:0!important;box-decoration-break:clone!important;-webkit-box-decoration-break:clone!important}.i-amphtml-story-attachment-active amp-story-page[active]:after{content:\\\"\\\"!important;display:block!important;left:0!important;top:0!important;bottom:0!important;right:0!important;position:absolute!important;background:#000!important;z-index:2!important;animation:i-amphtml-drawwer-overlay-opacity 0.3s cubic-bezier(0.0,0.0,0.2,1) forwards!important}@keyframes i-amphtml-drawer-overlay-opacity{0%{opacity:0}to{opacity:0.75}}.i-amphtml-story-attachment-active amp-story-page[active]:after{z-index:3!important;animation:i-amphtml-attachment-overlay-opacity 0.3s cubic-bezier(0.0,0.0,0.2,1) forwards!important}@keyframes i-amphtml-attachment-overlay-opacity{0%{opacity:0}to{opacity:0.5}}.i-amphtml-story-opacity-mask{position:absolute!important;top:0!important;bottom:0!important;width:100%!important;height:100%!important;opacity:1!important;display:block!important;background-image:none!important;background-color:rgba(0,0,0,0.75)!important;visibility:visible;z-index:100003!important;transition:visibility 0.3s,opacity 0.3s cubic-bezier(0.0,0.0,0.2,1)!important}.i-amphtml-story-opacity-mask[hidden]{opacity:0!important;pointer-events:none!important;display:block!important;visibility:hidden;transition:visibility 0.2s,opacity 0.2s cubic-bezier(0.4,0.0,1,1)!important}.i-amphtml-sidebar-mask{display:none!important}amp-story-cta-layer{display:block!important;top:80%!important;margin:0!important;z-index:3!important}amp-story-cta-layer,amp-story-grid-layer{position:absolute!important;right:0!important;bottom:0!important;left:0!important}amp-story-grid-layer{box-sizing:border-box!important;display:grid!important;top:0!important;z-index:2!important;pointer-events:none!important}amp-story-grid-layer[anchor*=left]{margin-left:0!important}amp-story-grid-layer[anchor*=top]{margin-top:0!important}amp-story-grid-layer[anchor*=bottom]{margin-bottom:0!important}amp-story-grid-layer[anchor*=right]{margin-right:0!important;margin-left:auto!important}amp-story-grid-layer amp-video:after{content:\\\"\\\"!important;position:absolute!important;height:100%!important;width:100%!important;top:0!important;left:0!important}.i-amphtml-story-grid-template-fill amp-img img,.i-amphtml-story-grid-template-fill amp-video video{position:absolute!important}amp-story-page[active]:not(.i-amphtml-layout) amp-video.i-amphtml-poolbound{display:none!important}amp-story-grid-layer>*{pointer-events:auto!important}amp-story-grid-layer a *{pointer-events:none!important}amp-story-grid-layer .i-amphtml-embedded-component:after{content:\\\"\\\"!important;position:absolute!important;height:100%!important;width:100%!important;top:0!important;left:0!important}.i-amphtml-expanded-mode .i-amphtml-embedded-component:after{height:0px!important;width:0px!important}.i-amphtml-expanded-mode amp-story-grid-layer,.i-amphtml-expanded-mode amp-story-grid-layer *{contain:none!important;z-index:auto!important}.i-amphtml-expanded-mode .i-amphtml-embedded-component.i-amphtml-expanded-component{z-index:1!important;transition:transform 0.225s cubic-bezier(0.4,0.0,0.2,1)!important}.i-amphtml-story-grid-template-with-full-bleed-animation{position:absolute!important;display:block!important;padding:0!important}.i-amphtml-story-grid-template-fill>*{bottom:0!important;height:auto!important;left:0!important;position:absolute!important;right:0!important;top:0!important;width:auto!important}.i-amphtml-story-grid-template-vertical{grid-auto-flow:row!important;grid-template-columns:100%!important}.i-amphtml-story-grid-template-horizontal{grid-auto-flow:column!important;grid-template-rows:100%!important}.i-amphtml-story-grid-template-thirds{height:100%!important;grid-template-rows:33% 33% 33%!important;grid-template-areas:\\\"upper-third\\\" \\\"middle-third\\\" \\\"lower-third\\\"!important}.i-amphtml-story-grid-template-aspect{margin:auto;width:var(--i-amphtml-story-layer-width,100%);height:var(--i-amphtml-story-layer-height,100%);font-size:calc(var(--i-amphtml-story-layer-height, 100vh)/10);margin-left:calc(var(--story-page-vw, 1%)*100*0.5 - var(--i-amphtml-story-layer-width, 100%)*0.5)}.i-amphtml-story-dev-logs-button[data-count=\\\"0\\\"]{display:none!important}.i-amphtml-story-dev-logs-button{background-position:50%!important;background-repeat:no-repeat!important}.i-amphtml-story-dev-logs-button:after{background-color:#fff!important;border-radius:6px!important;box-sizing:border-box!important;color:#444;content:attr(data-count)!important;display:inline-block!important;font-family:Roboto!important;font-size:11px!important;height:12px!important;line-height:12px!important;padding:0 6px!important;position:absolute!important;right:0!important;top:6px!important}.i-amphtml-story-error-button{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23DB4437'%3E%3Cpath d='M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-warning-button{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23FFC107'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-success-button{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%230F9D58'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/%3E%3C/svg%3E\\\")!important}amp-story[standalone] .i-amphtml-story-developer-log{background:rgba(0,0,0,0.85)!important;bottom:0!important;box-sizing:border-box!important;color:#fff!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-direction:column!important;flex-direction:column!important;font-family:Roboto!important;left:0!important;max-height:45%!important;padding:0!important;position:fixed!important;right:0!important;text-align:start!important;z-index:100002!important}.i-amphtml-story-developer-log-header{-ms-flex-align:center!important;align-items:center!important;background:rgb(3,169,244,0.85)!important;display:-ms-flexbox!important;display:flex!important;font-weight:700!important;-ms-flex-pack:justify!important;justify-content:space-between!important;padding:12px 20px!important;text-align:center!important}.i-amphtml-story-developer-log-close,.i-amphtml-story-developer-log-header{-ms-flex-positive:0!important;flex-grow:0!important;-ms-flex-negative:0!important;flex-shrink:0!important}.i-amphtml-story-developer-log-close{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg fill='%23FFF' height='24' width='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-developer-log-context{color:#000!important;font-family:Roboto Mono!important}.i-amphtml-story-developer-log-entries{list-style-type:none!important;margin:0!important;overflow-x:hidden!important;overflow-y:auto!important;padding:0!important}.i-amphtml-story-developer-log-entry{-ms-flex-align:center!important;align-items:center!important;border-bottom:1px solid hsla(0,0%,100%,0.5)!important;display:-ms-flexbox!important;display:flex!important;padding:20px!important}.i-amphtml-story-developer-log-entry:before{background-position:50%!important;background-repeat:no-repeat!important;background-size:cover!important;content:\\\"\\\";display:inline-block!important;-ms-flex-positive:0!important;flex-grow:0!important;-ms-flex-negative:0!important;flex-shrink:0!important;height:32px!important;margin-right:20px!important;width:32px!important}.i-amphtml-story-developer-log-entry-error:before{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23DB4437'%3E%3Cpath d='M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-developer-log-entry-warning:before{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23FFC107'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-developer-log-entry-success:before{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%230F9D58'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-toast{position:absolute!important;bottom:0!important;left:0!important;right:0!important;display:inline-block!important;padding:1.16em 1.33em!important;line-height:1.33!important;color:#fff!important;background:#212121!important;animation:toast 2.2s!important;animation-fill-mode:both!important;font-family:Roboto,sans-serif!important;font-weight:400!important;font-size:12px!important;max-width:640px!important;z-index:100004!important}@media (min-width:640px){.i-amphtml-story-toast{right:auto!important;font-size:14px!important;margin:0 auto 1.16em 1.16em!important;border-radius:6px}}@keyframes toast{0%{transform:translateY(100px);easing:cubic-bezier(0.0,0.0,0.2,1)}8%{transform:translateY(0)}92%{transform:translateY(0);easing:cubic-bezier(0.4,0.0,1,1)}to{transform:translateY(100px)}}.i-amphtml-story-copy-successful{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23fff'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/%3E%3C/svg%3E\\\")!important;background-repeat:no-repeat!important;background-size:16px 16px!important;padding-left:24px!important;color:#fff!important;display:-ms-flexbox!important;display:flex!important}.i-amphtml-story-copy-url{-ms-flex:1!important;flex:1!important;color:hsla(0,0%,100%,0.5)!important;margin-left:40px!important;text-overflow:ellipsis!important;overflow:hidden!important;white-space:nowrap!important}.i-amphtml-story-spinner,amp-story .amp-video-eq{right:12px!important;bottom:12px!important}[dir=rtl] .i-amphtml-story-spinner,[dir=rtl] amp-story .amp-video-eq{left:12px!important;right:auto!important}.i-amphtml-story-spinner{display:inline-block!important;position:absolute!important;width:24px!important;height:24px!important;z-index:10!important}.i-amphtml-story-spinner-container{width:100%!important;height:100%!important;direction:ltr!important}.i-amphtml-story-spinner[active] .i-amphtml-story-spinner-container{animation:container-rotate 1294ms linear infinite!important}@keyframes container-rotate{to{transform:rotate(360deg)}}.i-amphtml-story-spinner-layer{position:absolute!important;width:100%!important;height:100%!important;opacity:0!important;white-space:nowrap!important;color:#fff!important}.i-amphtml-story-spinner[active] .i-amphtml-story-spinner-layer{animation-name:fill-unfill-rotate!important;animation-duration:4400ms!important;animation-timing-function:cubic-bezier(0.4,0.0,0.2,1)!important;animation-iteration-count:infinite!important;opacity:1!important;filter:drop-shadow(0px 1px 3px rgba(0,0,0,0.25))!important}@keyframes fill-unfill-rotate{12.5%{transform:rotate(135deg)}25%{transform:rotate(270deg)}37.5%{transform:rotate(405deg)}50%{transform:rotate(540deg)}62.5%{transform:rotate(675deg)}75%{transform:rotate(810deg)}87.5%{transform:rotate(945deg)}to{transform:rotate(1080deg)}}.i-amphtml-story-spinner-circle-clipper{display:inline-block!important;position:relative!important;width:50%!important;height:100%!important;overflow:hidden!important}.i-amphtml-story-spinner-layer:after{left:45%!important;width:10%!important;border-top-style:solid!important}.i-amphtml-story-spinner-circle-clipper:after,.i-amphtml-story-spinner-layer:after{content:\\\"\\\"!important;box-sizing:border-box!important;position:absolute!important;top:0!important;border-width:3px!important;border-radius:50%!important}.i-amphtml-story-spinner-circle-clipper:after{bottom:0!important;width:200%!important;border-style:solid!important;border-bottom-color:transparent!important}.i-amphtml-story-spinner-circle-clipper.left:after{left:0!important;border-right-color:transparent!important;transform:rotate(129deg)!important}.i-amphtml-story-spinner-circle-clipper.right:after{left:-100%!important;border-left-color:transparent!important;transform:rotate(-129deg)!important}.i-amphtml-story-spinner[active] .i-amphtml-story-spinner-circle-clipper:after{animation-duration:1100ms!important;animation-timing-function:cubic-bezier(0.4,0.0,0.2,1)!important;animation-iteration-count:infinite!important}.i-amphtml-story-spinner[active] .i-amphtml-story-spinner-circle-clipper.left:after{animation-name:left-spin!important}.i-amphtml-story-spinner[active] .i-amphtml-story-spinner-circle-clipper.right:after{animation-name:right-spin!important}@keyframes left-spin{0%{transform:rotate(130deg)}50%{transform:rotate(-5deg)}to{transform:rotate(130deg)}}@keyframes right-spin{0%{transform:rotate(-130deg)}50%{transform:rotate(5deg)}to{transform:rotate(-130deg)}}.i-amphtml-story-page-error,.i-amphtml-story-page-play-button{display:-ms-flexbox!important;display:flex!important;-ms-flex-align:center!important;align-items:center!important;position:absolute!important;bottom:0!important;right:0!important;height:40px!important;border:0!important;margin:8px 0 0 8px!important;padding:0!important;animation:play-button-fly-in 0.4s cubic-bezier(0.4,0.0,0.2,1)!important;background-color:transparent!important;z-index:10000!important}.i-amphtml-story-expanded-view-overflow{top:0!important;left:0!important;width:100%!important;height:100%!important;background-color:#000!important;position:absolute!important}.i-amphtml-expanded-view-close-button{position:absolute!important;top:0!important;left:0!important;margin:12px!important;height:24px!important;width:24px!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 36 36' fill='rgba(255, 255, 255, 0.8)'%3E%3Cpath d='M28.5 9.62 26.38 7.5 18 15.88 9.62 7.5 7.5 9.62 15.88 18 7.5 26.38l2.12 2.12L18 20.12l8.38 8.38 2.12-2.12L20.12 18z'/%3E%3Cpath d='M0 0h36v36H0z' fill='none'/%3E%3C/svg%3E\\\")!important;cursor:pointer!important;text-align:center!important;background-color:transparent!important}@keyframes play-button-fly-in{0%{opacity:0;transform:translateX(12px)}to{opacity:1;transform:translateX(0)}}.i-amphtml-story-page-error[hidden],.i-amphtml-story-page-play-button[hidden]{display:none!important}.i-amphtml-story-page-error-label,.i-amphtml-story-page-play-label{color:#fff!important;font-family:Roboto,sans-serif!important;font-size:16px!important;text-shadow:0px 0px 6px rgba(0,0,0,0.36)!important}.i-amphtml-story-page-error-icon,.i-amphtml-story-page-play-icon{display:inline-block!important;height:24px!important;width:24px!important;margin:0 8px!important;border-radius:24px!important;filter:drop-shadow(0px 0px 6px rgba(0,0,0,0.36))!important}.i-amphtml-story-page-error-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23FFF'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-page-play-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 48 48' fill='%23FFF'%3E%3Cpath d='M0 0h48v48H0z' fill='none'/%3E%3Cpath d='M24 4C12.95 4 4 12.95 4 24s8.95 20 20 20 20-8.95 20-20S35.05 4 24 4zm-4 29V15l12 9-12 9z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-interactive-component{-ms-flex-item-align:center;align-self:center;height:auto!important;pointer-events:none!important;min-width:14em!important;max-width:25em!important;font-size:calc(var(--story-page-vmin)*3);width:100%;--interactive-accent-color:#005af0;--interactive-prompt-background:var(--interactive-accent-color);--interactive-prompt-text-color:#fff;--interactive-prompt-alignment:initial;--i-amphtml-interactive-option-accent-color:var(--interactive-accent-color)!important;--i-amphtml-interactive-option-background-color:#fff!important;--i-amphtml-interactive-options-chip-background-color:var(--i-amphtml-interactive-option-background-color)!important;--i-amphtml-interactive-option-text-color:#55595e!important;--i-amphtml-interactive-theme-border:rgba(85,89,94,0.2)!important;--i-amphtml-interactive-theme-shading:rgba(85,89,94,0.2)!important;--i-amphtml-interactive-theme-shading-base:#dedee1!important;--i-amphtml-interactive-theme-shading-flash:rgba(85,89,94,0.5)!important;--i-amphtml-interactive-chip-radius:2em!important;--i-amphtml-interactive-chip-shadow:0px 0px 0px transparent!important;--i-amphtml-interactive-chip-shadow-inset:inset 0px 0px 0px transparent!important;--i-amphtml-interactive-answer-choice-border:var(--interactive-accent-color)!important;--i-amphtml-interactive-answer-choice-background:#fff!important;--i-amphtml-interactive-prompt-text-size:1.375em!important;--i-amphtml-interactive-prompt-line-height:1.3em!important;--i-amphtml-interactive-strong-text-color:#000!important;--i-amphtml-interactive-animation-time:.3s!important;--i-amphtml-interactive-ease-out-curve:cubic-bezier(.3,0,0,1)!important;--i-amphtml-interactive-animation-delay:0s!important;--i-amphtml-interactive-component-shadow:0px 4px 12px rgba(60,64,67,0.08),0px 2px 4px rgba(60,64,67,0.12);--i-amphtml-interactive-prompt-clamp:4!important;--i-amphtml-interactive-results-prompt-margin:20px!important}.i-amphtml-story-interactive-component[theme=dark]{--i-amphtml-interactive-option-text-color:#a7adb4!important;--i-amphtml-interactive-option-background-color:#202124!important;--i-amphtml-interactive-theme-border:hsla(212,8%,68%,0.2)!important;--i-amphtml-interactive-theme-shading:hsla(212,8%,68%,0.2)!important;--i-amphtml-interactive-theme-shading-base:#3c3d3f!important;--i-amphtml-interactive-theme-shading-flash:hsla(212,8%,68%,0.5)!important;--i-amphtml-interactive-strong-text-color:#fff!important}.i-amphtml-story-interactive-component[chip-style=shadow]{--i-amphtml-interactive-chip-shadow:0px 2px 8px rgba(60,60,60,0.2)!important;--i-amphtml-interactive-chip-shadow-inset:inset 4px 4px 8px rgba(0,0,0,0.2)!important;--i-amphtml-interactive-theme-border:transparent!important}.i-amphtml-story-interactive-component:not(amp-story-interactive-results)[chip-style=transparent]{--i-amphtml-interactive-options-chip-background-color:transparent!important;--interactive-prompt-background:transparent!important;--interactive-prompt-alignment:center;--i-amphtml-interactive-chip-shadow:0px 2px 8px rgba(60,60,60,0.2)!important;--i-amphtml-interactive-chip-shadow-inset:inset 4px 4px 8px rgba(0,0,0,0.2)!important;--i-amphtml-interactive-theme-border:transparent!important;--i-amphtml-interactive-component-shadow:none!important}.i-amphtml-story-interactive-component[chip-style=shadow][theme=dark]{--i-amphtml-interactive-chip-shadow:0px 2px 8px 0px rgba(0,0,0,0.6)!important;--i-amphtml-interactive-chip-shadow-inset:inset 4px 4px 8px rgba(0,0,0,0.4)!important}.i-amphtml-story-interactive-component[prompt-size=large]{--i-amphtml-interactive-prompt-text-size:1.75em!important;--i-amphtml-interactive-prompt-clamp:3!important}.i-amphtml-story-interactive-component[prompt-size=small]{--i-amphtml-interactive-prompt-text-size:1.125em!important}amp-story-interactive-binary-poll.i-amphtml-story-interactive-component,amp-story-interactive-results.i-amphtml-story-interactive-component{max-width:18em!important}amp-story-interactive-binary-poll[theme=dark],amp-story-interactive-poll[theme=dark]{--i-amphtml-interactive-option-accent-color:#fff!important}amp-story-interactive-results:not([chip-style=transparent]){--interactive-prompt-text-color:var(--i-amphtml-interactive-strong-text-color)}amp-story-interactive-results[chip-style=transparent]{--i-amphtml-interactive-option-text-color:#000!important;--i-amphtml-interactive-options-chip-background-color:transparent!important;--interactive-prompt-background:transparent;--i-amphtml-interactive-component-shadow:none!important;--interactive-prompt-text-color:#000;--i-amphtml-interactive-results-prompt-margin:0px!important}amp-story-interactive-results[theme=dark][chip-style=transparent]{--i-amphtml-interactive-option-text-color:#fff!important;--interactive-prompt-text-color:#fff}amp-story-page.i-amphtml-story-desktop-panels .i-amphtml-story-interactive-component{--i-amphtml-interactive-animation-delay:350ms!important}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story.css*/\";\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\n\n/**\n * Pass class helps to manage single-pass process. A pass is scheduled using\n * delay method. Only one pass can be pending at a time. If no pass is pending\n * the process is considered to be \"idle\".\n */\nexport class Pass {\n  /**\n   * Creates a new Pass instance.\n   * @param {!Window} win\n   * @param {function()} handler Handler to be executed when pass is triggered.\n   * @param {number=} opt_defaultDelay Default delay to be used when schedule\n   *   is called without one.\n   */\n  constructor(win, handler, opt_defaultDelay) {\n    this.timer_ = Services.timerFor(win);\n\n    /** @private @const {function()} */\n    this.handler_ = handler;\n\n    /** @private @const {number} */\n    this.defaultDelay_ = opt_defaultDelay || 0;\n\n    /** @private {number|string} */\n    this.scheduled_ = -1;\n\n    /** @private {number} */\n    this.nextTime_ = 0;\n\n    /** @private {boolean} */\n    this.running_ = false;\n\n    /**\n     * @private\n     * @const {function()}\n     */\n    this.boundPass_ = () => {\n      this.pass_();\n    };\n  }\n\n  /**\n   * Whether or not a pass is currently pending.\n   * @return {boolean}\n   */\n  isPending() {\n    return this.scheduled_ != -1;\n  }\n\n  /**\n   * Tries to schedule a new pass optionally with specified delay. If the new\n   * requested pass is requested before the pending pass, the pending pass is\n   * canceled. If the new pass is requested after the pending pass, the newly\n   * requested pass is ignored.\n   *\n   * Returns {@code true} if the pass has been scheduled and {@code false} if\n   * ignored.\n   *\n   * @param {number=} opt_delay Delay to schedule the pass. If not specified\n   *   the default delay is used, falling back to 0.\n   * @return {boolean}\n   */\n  schedule(opt_delay) {\n    let delay = opt_delay || this.defaultDelay_;\n    if (this.running_ && delay < 10) {\n      // If we get called recursively, wait at least 10ms for the next\n      // execution.\n      delay = 10;\n    }\n\n    const nextTime = Date.now() + delay;\n    // Schedule anew if nothing is scheduled currently or if the new time is\n    // sooner then previously requested.\n    if (!this.isPending() || nextTime - this.nextTime_ < -10) {\n      this.cancel();\n      this.nextTime_ = nextTime;\n      this.scheduled_ = this.timer_.delay(this.boundPass_, delay);\n\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   *\n   */\n  pass_() {\n    this.scheduled_ = -1;\n    this.nextTime_ = 0;\n    this.running_ = true;\n    this.handler_();\n    this.running_ = false;\n  }\n\n  /**\n   * Cancels the pending pass if any.\n   */\n  cancel() {\n    if (this.isPending()) {\n      this.timer_.cancel(this.scheduled_);\n      this.scheduled_ = -1;\n    }\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from './core/data-structures/observable';\nimport {Pass} from './pass';\nimport {devAssert} from './log';\nimport {findIndex} from './core/types/array';\nimport {supportsPassiveEventListener} from './core/dom/event-helper-listen';\nimport {toWin} from './core/window';\n\nconst PROP_ = '__AMP_Gestures';\n\n/**\n * A gesture object contains the type and data of the gesture such as\n * a tap or a double-tap or a swipe. See {@link GestureRecognizer} for\n * more details.\n * @struct\n * @const\n * @template DATA\n */\nexport class Gesture {\n  /**\n   * @param {string} type The gesture's string type.\n   * @param {DATA} data The data of the gesture.\n   * @param {time} time The time that the gesture has been emitted.\n   * @param {?Event} event An optional browser event that resulted in the\n   *   gesture.\n   */\n  constructor(type, data, time, event) {\n    /** @const {string} */\n    this.type = type;\n    /** @const {DATA} */\n    this.data = data;\n    /** @const {number} */\n    this.time = time;\n    /** @const {?Event} */\n    this.event = event;\n  }\n}\n\n/**\n * Gestures object manages all gestures on a particular element. It listens\n * to all pointer events and delegates them to individual gesture recognizers.\n * When a recognizer has recognized a gesture and ready to start emitting it\n * it requests permission to do so from this class which resolves conflicts\n * between competing recognizers to decide which gesture should go forward.\n */\nexport class Gestures {\n  /**\n   * Creates if not yet created and returns the shared Gestures instance for\n   * the specified element.\n   * @param {!Element} element\n   * @param {boolean=} opt_shouldNotPreventDefault\n   * @param {boolean=} opt_shouldStopPropagation\n   * @return {!Gestures}\n   */\n  static get(\n    element,\n    opt_shouldNotPreventDefault = false,\n    opt_shouldStopPropagation = false\n  ) {\n    let res = element[PROP_];\n    if (!res) {\n      res = new Gestures(\n        element,\n        opt_shouldNotPreventDefault,\n        opt_shouldStopPropagation\n      );\n      element[PROP_] = res;\n    }\n    return res;\n  }\n\n  /**\n   * @param {!Element} element\n   * @param {boolean} shouldNotPreventDefault\n   * @param {boolean} shouldStopPropagation\n   */\n  constructor(element, shouldNotPreventDefault, shouldStopPropagation) {\n    /** @private {!Element} */\n    this.element_ = element;\n\n    /** @private {!Array<!GestureRecognizer>} */\n    this.recognizers_ = [];\n\n    /** @private {!Array<boolean>} */\n    this.tracking_ = [];\n\n    /** @private {!Array<time>} */\n    this.ready_ = [];\n\n    /** @private {!Array<time>} */\n    this.pending_ = [];\n\n    /** @private {?GestureRecognizer} */\n    this.eventing_ = null;\n\n    /** @private {boolean} */\n    this.shouldNotPreventDefault_ = shouldNotPreventDefault;\n\n    /** @private {boolean} */\n    this.shouldStopPropagation_ = shouldStopPropagation;\n\n    /**\n     * This variable indicates that the eventing has stopped on this\n     * event cycle.\n     * @private {boolean}\n     */\n    this.wasEventing_ = false;\n\n    /** @private {!Pass} */\n    this.pass_ = new Pass(\n      toWin(element.ownerDocument.defaultView),\n      this.doPass_.bind(this)\n    );\n\n    /** @private {!Observable} */\n    this.pointerDownObservable_ = new Observable();\n\n    /**\n     * Observers for each type of registered gesture types.\n     * @private {!Object<string, !Observable<!Gesture>>}\n     */\n    this.overservers_ = Object.create(null);\n\n    /** @private @const {function(!Event)} */\n    this.boundOnTouchStart_ = this.onTouchStart_.bind(this);\n    /** @private @const {function(!Event)} */\n    this.boundOnTouchEnd_ = this.onTouchEnd_.bind(this);\n    /** @private @const {function(!Event)} */\n    this.boundOnTouchMove_ = this.onTouchMove_.bind(this);\n    /** @private @const {function(!Event)} */\n    this.boundOnTouchCancel_ = this.onTouchCancel_.bind(this);\n\n    const win = element.ownerDocument.defaultView;\n    const passiveSupported = supportsPassiveEventListener(toWin(win));\n    this.element_.addEventListener(\n      'touchstart',\n      this.boundOnTouchStart_,\n      passiveSupported ? {passive: true} : false\n    );\n    this.element_.addEventListener('touchend', this.boundOnTouchEnd_);\n    this.element_.addEventListener(\n      'touchmove',\n      this.boundOnTouchMove_,\n      passiveSupported ? {passive: true} : false\n    );\n    this.element_.addEventListener('touchcancel', this.boundOnTouchCancel_);\n\n    /** @private {boolean} */\n    this.passAfterEvent_ = false;\n  }\n\n  /**\n   * Unsubscribes from all pointer events and removes the shared cache instance.\n   */\n  cleanup() {\n    this.element_.removeEventListener('touchstart', this.boundOnTouchStart_);\n    this.element_.removeEventListener('touchend', this.boundOnTouchEnd_);\n    this.element_.removeEventListener('touchmove', this.boundOnTouchMove_);\n    this.element_.removeEventListener('touchcancel', this.boundOnTouchCancel_);\n    delete this.element_[PROP_];\n    this.pass_.cancel();\n  }\n\n  /**\n   * Subscribes to a gesture emitted by the specified recognizer. For a first\n   * gesture handler registered in this method the recognizer is installed\n   * and from that point on it participates in the event processing.\n   *\n   * @param {function(new:GestureRecognizer, !Gestures)} recognizerConstr\n   * @param {function(!Gesture)} handler\n   * @return {!UnlistenDef}\n   * @template DATA\n   */\n  onGesture(recognizerConstr, handler) {\n    const recognizer = new recognizerConstr(this);\n    const type = recognizer.getType();\n    let overserver = this.overservers_[type];\n    if (!overserver) {\n      this.recognizers_.push(recognizer);\n      overserver = new Observable();\n      this.overservers_[type] = overserver;\n    }\n    return overserver.add(handler);\n  }\n\n  /**\n   * Unsubscribes all handlers from the given gesture recognizer. Returns\n   * true if anything was done. Returns false if there were no handlers\n   * registered on the given gesture recognizer in first place.\n   *\n   * @param {function(new:GestureRecognizer, !Gestures)} recognizerConstr\n   * @return {boolean}\n   */\n  removeGesture(recognizerConstr) {\n    const type = new recognizerConstr(this).getType();\n    const overserver = this.overservers_[type];\n    if (overserver) {\n      overserver.removeAll();\n      const index = findIndex(this.recognizers_, (e) => e.getType() == type);\n      if (index < 0) {\n        return false;\n      }\n      // Remove the recognizer as well as all associated tracking state\n      this.recognizers_.splice(index, 1);\n      this.ready_.splice(index, 1);\n      this.pending_.splice(index, 1);\n      this.tracking_.splice(index, 1);\n      delete this.overservers_[type];\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /**\n   * Subscribes to pointer down events, such as \"touchstart\" or \"mousedown\".\n   * @param {!Function} handler\n   * @return {!UnlistenDef}\n   */\n  onPointerDown(handler) {\n    return this.pointerDownObservable_.add(handler);\n  }\n\n  /**\n   * Handles all \"touchstart\" events and dispatches them to the tracking\n   * recognizers.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchStart_(event) {\n    const now = Date.now();\n    this.wasEventing_ = false;\n\n    this.pointerDownObservable_.fire(event);\n\n    for (let i = 0; i < this.recognizers_.length; i++) {\n      if (this.ready_[i]) {\n        // If the recognizer is in the \"ready\" state, it won't receive\n        // any more touch series until it's allowed to emit.\n        continue;\n      }\n      if (this.pending_[i] && this.pending_[i] < now) {\n        // Pending state expired. Reset.\n        this.stopTracking_(i);\n      }\n      if (this.recognizers_[i].onTouchStart(event)) {\n        // When a recognizer is interested in the touch series it returns \"true\"\n        // from its onTouchStart method. For this recognizer we start tracking\n        // the whole series of touch events from touchstart to touchend. Other\n        // recognizers will not receive them unless they return \"true\" from\n        // onTouchStart.\n        this.startTracking_(i);\n      }\n    }\n\n    this.afterEvent_(event);\n  }\n\n  /**\n   * Handles all \"touchmove\" events and dispatches them to the tracking\n   * recognizers.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchMove_(event) {\n    const now = Date.now();\n\n    for (let i = 0; i < this.recognizers_.length; i++) {\n      if (!this.tracking_[i]) {\n        // The whole touch series are ignored for non-tracking recognizers.\n        continue;\n      }\n      if (this.pending_[i] && this.pending_[i] < now) {\n        // Pending state expired. Reset.\n        this.stopTracking_(i);\n        continue;\n      }\n      if (!this.recognizers_[i].onTouchMove(event)) {\n        // Recognizer lost interest in the series. Reset.\n        this.stopTracking_(i);\n      }\n    }\n\n    this.afterEvent_(event);\n  }\n\n  /**\n   * Handles all \"touchend\" events and dispatches them to the tracking\n   * recognizers.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchEnd_(event) {\n    const now = Date.now();\n\n    for (let i = 0; i < this.recognizers_.length; i++) {\n      if (!this.tracking_[i]) {\n        // The whole touch series are ignored for non-tracking recognizers.\n        continue;\n      }\n      if (this.pending_[i] && this.pending_[i] < now) {\n        // Pending state expired. Reset.\n        this.stopTracking_(i);\n        continue;\n      }\n\n      this.recognizers_[i].onTouchEnd(event);\n\n      const isReady = !this.pending_[i];\n      const isExpired = this.pending_[i] < now;\n      const isEventing = this.eventing_ == this.recognizers_[i];\n\n      if (!isEventing && (isReady || isExpired)) {\n        this.stopTracking_(i);\n      }\n    }\n\n    this.afterEvent_(event);\n  }\n\n  /**\n   * Handles all \"touchcancel\" events. Cancels all tracking/emitting\n   * recognizers.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchCancel_(event) {\n    for (let i = 0; i < this.recognizers_.length; i++) {\n      this.cancelEventing_(i);\n    }\n    this.afterEvent_(event);\n  }\n\n  /**\n   * Callback for a gesture recognizer to communicate that it's ready to\n   * start emitting gestures. Gestures instance may or may not allow the\n   * recognizer to proceed.\n   * @param {!GestureRecognizer} recognizer\n   * @param {number} offset\n   * @private\n   * @restricted\n   * @visibleForTesting\n   */\n  signalReady_(recognizer, offset) {\n    // Somebody got here first.\n    if (this.eventing_) {\n      recognizer.acceptCancel();\n      return;\n    }\n\n    // Set the recognizer as ready and wait for the pass to\n    // make the decision.\n    const now = Date.now();\n    for (let i = 0; i < this.recognizers_.length; i++) {\n      if (this.recognizers_[i] == recognizer) {\n        this.ready_[i] = now + offset;\n        this.pending_[i] = 0;\n      }\n    }\n    this.passAfterEvent_ = true;\n  }\n\n  /**\n   * Callback for a gesture recognizer to communicate that it's close to\n   * start emitting gestures, but needs more time to see more events. Once\n   * this time expires the recognizer should either signal readiness or it\n   * will be canceled.\n   * @param {!GestureRecognizer} recognizer\n   * @param {number} timeLeft\n   * @private\n   * @restricted\n   * @visibleForTesting\n   */\n  signalPending_(recognizer, timeLeft) {\n    // Somebody got here first.\n    if (this.eventing_) {\n      recognizer.acceptCancel();\n      return;\n    }\n\n    const now = Date.now();\n    for (let i = 0; i < this.recognizers_.length; i++) {\n      if (this.recognizers_[i] == recognizer) {\n        this.pending_[i] = now + timeLeft;\n      }\n    }\n  }\n\n  /**\n   * Callback for a gesture recognizer to communicate that it's done\n   * emitting gestures.\n   * @param {!GestureRecognizer} recognizer\n   * @private\n   * @restricted\n   * @visibleForTesting\n   */\n  signalEnd_(recognizer) {\n    if (this.eventing_ == recognizer) {\n      this.eventing_ = null;\n      this.wasEventing_ = true;\n    }\n  }\n\n  /**\n   * Callback for a gesture emit the gesture. Only the currently emitting\n   * recognizer is allowed to emit gestures.\n   * @param {!GestureRecognizer} recognizer\n   * @param {*} data\n   * @param {?Event} event\n   * @private\n   * @restricted\n   * @visibleForTesting\n   */\n  signalEmit_(recognizer, data, event) {\n    devAssert(\n      this.eventing_ == recognizer,\n      'Recognizer is not currently allowed: %s',\n      recognizer.getType()\n    );\n    const overserver = this.overservers_[recognizer.getType()];\n    if (overserver) {\n      overserver.fire(\n        new Gesture(recognizer.getType(), data, Date.now(), event)\n      );\n    }\n  }\n\n  /**\n   * @param {!Event} event\n   * @private\n   */\n  afterEvent_(event) {\n    let cancelEvent = !!this.eventing_ || this.wasEventing_;\n    this.wasEventing_ = false;\n    if (!cancelEvent) {\n      const now = Date.now();\n      for (let i = 0; i < this.recognizers_.length; i++) {\n        if (this.ready_[i] || (this.pending_[i] && this.pending_[i] >= now)) {\n          cancelEvent = true;\n          break;\n        }\n      }\n    }\n    if (cancelEvent) {\n      event.stopPropagation();\n      if (!this.shouldNotPreventDefault_) {\n        event.preventDefault();\n      }\n    } else if (this.shouldStopPropagation_) {\n      event.stopPropagation();\n    }\n    if (this.passAfterEvent_) {\n      this.passAfterEvent_ = false;\n      this.doPass_();\n    }\n  }\n\n  /**\n   * The pass that decides which recognizers can start emitting and which\n   * are canceled.\n   * @private\n   */\n  doPass_() {\n    const now = Date.now();\n\n    // The \"most ready\" recognizer is the youngest in the \"ready\" set.\n    // Otherwise we wouldn't wait for it at all.\n    let readyIndex = -1;\n    for (let i = 0; i < this.recognizers_.length; i++) {\n      if (!this.ready_[i]) {\n        if (this.pending_[i] && this.pending_[i] < now) {\n          // Pending state expired. Reset.\n          this.stopTracking_(i);\n        }\n        continue;\n      }\n      if (readyIndex == -1 || this.ready_[i] > this.ready_[readyIndex]) {\n        readyIndex = i;\n      }\n    }\n\n    if (readyIndex == -1) {\n      // Nothing to do.\n      return;\n    }\n\n    // Look for conflicts.\n    let waitTime = 0;\n    for (let i = 0; i < this.recognizers_.length; i++) {\n      if (this.ready_[i] || !this.tracking_[i]) {\n        continue;\n      }\n      waitTime = Math.max(waitTime, this.pending_[i] - now);\n    }\n\n    if (waitTime < 2) {\n      // We waited long enough.\n      this.startEventing_(readyIndex);\n      return;\n    }\n\n    // Some conflicts: have to wait to see who wins.\n    this.pass_.schedule(waitTime);\n  }\n\n  /**\n   * This recognizer is given \"go ahead\" and all others are canceled.\n   * @param {number} index\n   * @private\n   */\n  startEventing_(index) {\n    const recognizer = this.recognizers_[index];\n    for (let i = 0; i < this.recognizers_.length; i++) {\n      if (i != index) {\n        this.cancelEventing_(i);\n      }\n    }\n    this.ready_[index] = 0;\n    this.pending_[index] = 0;\n    this.eventing_ = recognizer;\n    recognizer.acceptStart();\n  }\n\n  /**\n   * @param {number} index\n   * @private\n   */\n  startTracking_(index) {\n    this.tracking_[index] = true;\n    this.pending_[index] = 0;\n  }\n\n  /**\n   * @param {number} index\n   * @private\n   */\n  stopTracking_(index) {\n    this.tracking_[index] = false;\n    this.pending_[index] = 0;\n    if (!this.ready_[index]) {\n      this.recognizers_[index].acceptCancel();\n    }\n  }\n\n  /**\n   * @param {number} index\n   * @private\n   */\n  cancelEventing_(index) {\n    this.ready_[index] = 0;\n    this.stopTracking_(index);\n  }\n}\n\n/**\n * The gesture recognizer receives the pointer events from Gestures instance.\n * Based on these events, it can \"recognize\" the gesture it's responsible for,\n * request to start emitting and emit gestures. Gestures instances manages\n * several competing recognizers and decides which ones get to emit gestures\n * and which do not.\n *\n * The recognizer can be in several main states:\n * 1. Tracking state. In this state the recognizer is receiving the series of\n *    touch events from touchstart to touchend. To get into this state the\n *    recognizer has to return \"true\" from the {@link onTouchStart}.\n * 2. Pending state (optional). The recognizer matched part of the gesture,\n *    but needs more time to get track more events. It requests more time\n *    by calling {@link signalPending}, By the end of this time the recognizer\n *    has either matched the gesture or has been canceled.\n * 3. Ready state. The recognizer matched the whole gesture and ready to start\n *    emitting. It communicates to the Gestures this readiness by calling\n *    {@link signalReady}.\n * 5. Emitting state. If Gestures decides to go ahead with this recognizer, it\n *    will call {@link acceptStart} method. Otherwise, it will call\n *    {@link acceptCancel} method. Once in the emitting state, the recognizer\n *    can emit any number of events by calling {@link signalEmit}.\n * 6. Complete state. Once done, the recognizer can call {@link signalEnd} to\n *    communicate that it's done.\n *\n * @template DATA\n */\nexport class GestureRecognizer {\n  /**\n   * @param {string} type\n   * @param {!Gestures} manager\n   */\n  constructor(type, manager) {\n    /** @private @const {string} */\n    this.type_ = type;\n\n    /** @private @const {!Gestures} */\n    this.manager_ = manager;\n  }\n\n  /**\n   * Returns the type of the gesture emitted by the instance of this class.\n   * It has to be unique in the scope of the Gestures instance.\n   * @return {string}\n   */\n  getType() {\n    return this.type_;\n  }\n\n  /**\n   * The recognizer can call this method to communicate that it's ready to\n   * start emitting the gesture. Optionally it can pass a zero, positive or\n   * negative offset - a time on how much the gesture should be penalized or\n   * given advantage in conflict resolution. The recognizer at this point is\n   * in the \"ready\" state.\n   * @param {time} offset\n   */\n  signalReady(offset) {\n    this.manager_.signalReady_(this, offset);\n  }\n\n  /**\n   * The recognizer can call this method to communicate that it needs more\n   * time (timeLeft) to match the gesture. By the end of this time the\n   * recognizer has to either transit to the ready state using\n   * {@link signalReady} or it will be canceled. The recognizer is in the\n   * \"pending\" state.\n   * @param {time} timeLeft\n   */\n  signalPending(timeLeft) {\n    this.manager_.signalPending_(this, timeLeft);\n  }\n\n  /**\n   * The recognizer can call this method to communicate that it's done\n   * emitting the gestures. It will return to the waiting state. Recognizer\n   * can only call this method if it has previously received the\n   * {@link acceptStart} call.\n   */\n  signalEnd() {\n    this.manager_.signalEnd_(this);\n  }\n\n  /**\n   * The recognizer can call this method to emit the gestures while in the\n   * \"emitting\" state. Recognizer can only call this method if it has\n   * previously received the {@link acceptStart} call.\n   * @param {DATA} data\n   * @param {?Event} event\n   */\n  signalEmit(data, event) {\n    this.manager_.signalEmit_(this, data, event);\n  }\n\n  /**\n   * The Gestures instance calls this method to allow the recognizer to start\n   * emitting the gestures. At this point the recognizer is in the \"emitting\"\n   * state. It will be in this state until it calls {@link signalEnd} or\n   * the {@link acceptCancel} is called by the Gestures instance.\n   */\n  acceptStart() {}\n\n  /**\n   * The Gestures instance calls this method to reset the recognizer. At this\n   * point the recognizer is in the initial waiting state.\n   */\n  acceptCancel() {}\n\n  /**\n   * The Gestures instance calls this method for each \"touchstart\" event. If\n   * the recognizer wants to receive other touch events in the series, it has\n   * to return \"true\".\n   * @param {!Event} unusedEvent\n   * @return {boolean}\n   */\n  onTouchStart(unusedEvent) {\n    return false;\n  }\n\n  /**\n   * The Gestures instance calls this method for each \"touchmove\" event. If\n   * the recognizer wants to continue receiving touch events in the series,\n   * it has to return \"true\".\n   * @param {!Event} unusedEvent\n   * @return {boolean}\n   */\n  onTouchMove(unusedEvent) {\n    return false;\n  }\n\n  /**\n   * The Gestures instance calls this method for the \"touchend\" event.\n   * Somewhere within this touch series the recognizer has to call\n   * {@link signalReady} or {@link signalPending} or it will be reset for the\n   * next touch series.\n   * @param {!Event} unusedEvent\n   */\n  onTouchEnd(unusedEvent) {}\n}\n", "export const CSS = \":host{all:initial!important;color:initial!important}.amp-social-share-facebook{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M211.9 197.4h-36.7v59.9h36.7v175.8h70.5V256.5h49.2l5.2-59.1h-54.4v-33.7c0-13.9 2.8-19.5 16.3-19.5h38.2V82.9h-48.8c-52.5 0-76.1 23.1-76.1 67.3-.1 38.6-.1 47.2-.1 47.2z'/%3E%3C/svg%3E\\\")}.amp-social-share-pinterest{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M266.6 76.5c-100.2 0-150.7 71.8-150.7 131.7 0 36.3 13.7 68.5 43.2 80.6 4.8 2 9.2.1 10.6-5.3 1-3.7 3.3-13 4.3-16.9 1.4-5.3.9-7.1-3-11.8-8.5-10-13.9-23-13.9-41.3 0-53.3 39.9-101 103.8-101 56.6 0 87.7 34.6 87.7 80.8 0 60.8-26.9 112.1-66.8 112.1-22.1 0-38.6-18.2-33.3-40.6 6.3-26.7 18.6-55.5 18.6-74.8 0-17.3-9.3-31.7-28.4-31.7-22.5 0-40.7 23.3-40.7 54.6 0 19.9 6.7 33.4 6.7 33.4s-23.1 97.8-27.1 114.9c-8.1 34.1-1.2 75.9-.6 80.1.3 2.5 3.6 3.1 5 1.2 2.1-2.7 28.9-35.9 38.1-69 2.6-9.4 14.8-58 14.8-58 7.3 14 28.7 26.3 51.5 26.3 67.8 0 113.8-61.8 113.8-144.5-.1-62.6-53.1-120.8-133.6-120.8z'/%3E%3C/svg%3E\\\")}.amp-social-share-linkedin{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M186.4 142.4c0 19-15.3 34.5-34.2 34.5-18.9 0-34.2-15.4-34.2-34.5 0-19 15.3-34.5 34.2-34.5 18.9 0 34.2 15.5 34.2 34.5zm-5 58.9h-57.8v186.8h57.8V201.3zm92.4 0h-55.4v186.8h55.4v-98c0-26.3 12.1-41.9 35.2-41.9 21.3 0 31.5 15 31.5 41.9v98H398V269.8c0-50-28.3-74.2-68-74.2-39.6 0-56.3 30.9-56.3 30.9v-25.2h.1z'/%3E%3C/svg%3E\\\")}.amp-social-share-gplus{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M179.7 237.6v46.6h77c-3.1 20-23.3 58.7-77 58.7-46.3 0-84.1-38.5-84.1-85.9 0-47.4 37.8-85.9 84.1-85.9 26.4 0 44 11.3 54.1 21l36.8-35.5C247 134.4 216.4 121 179.7 121 104.7 121 44 181.8 44 257s60.7 136 135.7 136C258 393 310 337.8 310 260.1c0-8.9-1-15.7-2.1-22.5H179.7zm288.3-.9h-38.7V198h-38.6v38.7H352v38.6h38.7V314h38.6v-38.7H468'/%3E%3C/svg%3E\\\")}.amp-social-share-email{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M101.3 141.6v228.9h309.5V141.6H101.3zm274.4 26.2L256 259.3l-119.6-91.5h239.3zm-248.1 26.3 64.1 49.1-64.1 64.1V194.1zm.2 150.1 84.9-84.9 43.2 33.1 43-32.9 84.7 84.7H127.8zm256.6-36.4L320 243.4l64.4-49.3v113.7z'/%3E%3C/svg%3E\\\")}.amp-social-share-twitter{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath d='M0 0h400v400H0z'/%3E%3Cpath fill='%23FFF' fill-rule='nonzero' d='M153.62 301.59c94.34 0 145.94-78.16 145.94-145.94 0-2.22 0-4.43-.15-6.63A104.36 104.36 0 0 0 325 122.47a102.38 102.38 0 0 1-29.46 8.07 51.47 51.47 0 0 0 22.55-28.37 102.79 102.79 0 0 1-32.57 12.45c-15.9-16.906-41.163-21.044-61.625-10.093-20.461 10.95-31.032 34.266-25.785 56.873A145.62 145.62 0 0 1 92.4 107.81c-13.614 23.436-6.66 53.419 15.88 68.47A50.91 50.91 0 0 1 85 169.86v.65c.007 24.416 17.218 45.445 41.15 50.28a51.21 51.21 0 0 1-23.16.88c6.72 20.894 25.976 35.208 47.92 35.62a102.92 102.92 0 0 1-63.7 22 104.41 104.41 0 0 1-12.21-.74 145.21 145.21 0 0 0 78.62 23'/%3E%3C/g%3E%3C/svg%3E\\\")}.amp-social-share-tumblr{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M210.8 80.3c-2.3 18.3-6.4 33.4-12.4 45.2-6 11.9-13.9 22-23.9 30.5-9.9 8.5-21.8 14.9-35.7 19.5v50.6h38.9v124.5c0 16.2 1.7 28.6 5.1 37.1 3.4 8.5 9.5 16.6 18.3 24.2 8.8 7.6 19.4 13.4 31.9 17.5s26.8 6.1 43 6.1c14.3 0 27.6-1.4 39.9-4.3 12.3-2.9 26-7.9 41.2-15v-55.9c-17.8 11.7-35.7 17.5-53.7 17.5-10.1 0-19.1-2.4-27-7.1-5.9-3.5-10-8.2-12.2-14-2.2-5.8-3.3-19.1-3.3-39.7v-91.1h84.6v-55.8h-84.4v-90h-50.3z'/%3E%3C/svg%3E\\\")}.amp-social-share-whatsapp{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='46' height='46'%3E%3Cpath fill='%23FFF' d='M35.4 10.4C32 6.9 27.3 5 22.5 5 12.3 5 4.1 13.3 4.2 23.4c0 3.2.9 6.3 2.4 9.1L4 42l9.7-2.5c2.7 1.5 5.7 2.2 8.7 2.2 10.1 0 18.3-8.3 18.3-18.4 0-4.9-1.9-9.5-5.3-12.9zM22.5 38.6c-2.7 0-5.4-.7-7.7-2.1l-.6-.3-5.8 1.5L9.9 32l-.4-.6c-4.4-7.1-2.3-16.5 4.9-20.9 7.2-4.4 16.5-2.3 20.9 4.9 4.4 7.2 2.3 16.5-4.9 20.9-2.3 1.5-5.1 2.3-7.9 2.3zm8.8-11.1-1.1-.5s-1.6-.7-2.6-1.2c-.1 0-.2-.1-.3-.1-.3 0-.5.1-.7.2 0 0-.1.1-1.5 1.7-.1.2-.3.3-.5.3h-.1c-.1 0-.3-.1-.4-.2l-.5-.2c-1.1-.5-2.1-1.1-2.9-1.9-.2-.2-.5-.4-.7-.6-.7-.7-1.4-1.5-1.9-2.4l-.1-.2c-.1-.1-.1-.2-.2-.4 0-.2 0-.4.1-.5 0 0 .4-.5.7-.8.2-.2.3-.5.5-.7.2-.3.3-.7.2-1-.1-.5-1.3-3.2-1.6-3.8-.2-.3-.4-.4-.7-.5h-1.1c-.2 0-.4.1-.6.1l-.1.1c-.2.1-.4.3-.6.4-.2.2-.3.4-.5.6-.7.9-1.1 2-1.1 3.1 0 .8.2 1.6.5 2.3l.1.3c.9 1.9 2.1 3.6 3.7 5.1l.4.4c.3.3.6.5.8.8 2.1 1.8 4.5 3.1 7.2 3.8.3.1.7.1 1 .2h1c.5 0 1.1-.2 1.5-.4.3-.2.5-.2.7-.4l.2-.2c.2-.2.4-.3.6-.5.2-.2.4-.4.5-.6.2-.4.3-.9.4-1.4v-.7s-.1-.1-.3-.2z'/%3E%3C/svg%3E\\\")}.amp-social-share-line{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 511.99'%3E%3Cpath d='M443.2 233.29c0-84.14-84.35-152.6-188-152.6s-188 68.46-188 152.6c0 75.43 66.9 138.61 157.26 150.55 6.13 1.32 14.46 4 16.57 9.27 1.89 4.76 1.24 12.2.61 17 0 0-2.21 13.26-2.69 16.09-.82 4.75-3.78 18.6 16.29 10.14s108.21-63.76 147.66-109.16c27.25-29.89 40.3-60.18 40.3-93.89zm-254.38 44.92a3.67 3.67 0 0 1-3.66 3.67h-52.69a3.6 3.6 0 0 1-2.53-1l-.06-.05v-.05a3.65 3.65 0 0 1-1-2.53v-81.96a3.66 3.66 0 0 1 3.66-3.66h13.19a3.66 3.66 0 0 1 3.66 3.66v65.07h35.84a3.66 3.66 0 0 1 3.66 3.66zm31.8 0a3.65 3.65 0 0 1-3.66 3.65h-13.2a3.65 3.65 0 0 1-3.66-3.65v-81.92a3.66 3.66 0 0 1 3.66-3.66H217a3.66 3.66 0 0 1 3.66 3.66zm90.78 0a3.65 3.65 0 0 1-3.66 3.65h-13.19a3.67 3.67 0 0 1-.94-.12h-.05l-.25-.08h-.11l-.18-.08-.17-.08-.11-.06-.22-.14a3.45 3.45 0 0 1-.93-.9L254 229.56v48.66a3.66 3.66 0 0 1-3.67 3.65H237.1a3.65 3.65 0 0 1-3.66-3.65v-81.93a3.66 3.66 0 0 1 3.66-3.66h13.86l.21.05h.13l.21.07h.12a1.31 1.31 0 0 1 .21.08l.12.06.19.11a.41.41 0 0 1 .11.07l.19.13.1.07.19.16.07.07a2.28 2.28 0 0 1 .22.22 3.58 3.58 0 0 1 .28.37L290.89 245v-48.71a3.66 3.66 0 0 1 3.66-3.66h13.19a3.66 3.66 0 0 1 3.66 3.66zm72.83-68.74a3.66 3.66 0 0 1-3.65 3.67h-35.84V227h35.84a3.66 3.66 0 0 1 3.65 3.67v13.19a3.65 3.65 0 0 1-3.65 3.66h-35.84v13.85h35.84a3.65 3.65 0 0 1 3.65 3.66v13.19a3.66 3.66 0 0 1-3.65 3.67h-52.7a3.66 3.66 0 0 1-2.53-1l-.05-.05a.12.12 0 0 1-.05-.05 3.65 3.65 0 0 1-1-2.53V196.3a3.6 3.6 0 0 1 1-2.52l.06-.07a3.63 3.63 0 0 1 2.54-1h52.7a3.66 3.66 0 0 1 3.65 3.67z' style='fill:%23fff' data-name='\u30EC\u30A4\u30E4\u30FC 1'/%3E%3C/svg%3E\\\")}.amp-social-share-sms{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='30' height='29' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke='%23FFF' stroke-width='3' d='M8.73 26v-5.658H2V2h25.97L28 20.355l-12.062.042z' fill='none' fill-rule='evenodd'/%3E%3C/svg%3E\\\")}.amp-social-share-system{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg fill='%23fff' height='24' width='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z'/%3E%3C/svg%3E\\\")}amp-social-share{background-repeat:no-repeat;background-position:50%;background-size:contain;text-decoration:none;cursor:pointer;position:relative}amp-social-share:focus{outline:2px solid #0389ff;outline-offset:2px}.amp-social-share-twitter{background-color:#1da1f2}.amp-social-share-facebook{background-color:#32529f}.amp-social-share-pinterest{background-color:#e60023}.amp-social-share-linkedin{background-color:#0077b5}.amp-social-share-gplus{background-color:#dc4e41}.amp-social-share-tumblr{background-color:#3c5a77}.amp-social-share-email{background-color:#000}.amp-social-share-whatsapp{background-color:#25d366}.amp-social-share-line{background-color:#52b448}.amp-social-share-sms{background-color:#ca2b63}.amp-social-share-system{background-color:#000}.i-amphtml-story-share-widget{display:block!important;margin:16px 8px!important}.i-amphtml-story-no-sharing .i-amphtml-story-share-widget{display:none!important}.i-amphtml-story-share-widget-scrollable{padding:16px 0!important;overflow:auto!important}.i-amphtml-story-share-widget::-webkit-scrollbar{width:0px!important;background:transparent!important}.i-amphtml-story-share-list{list-style:none!important;padding:0 8px!important;margin:0!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-wrap:wrap!important;flex-wrap:wrap!important;width:100%!important}.i-amphtml-story-share-item{width:48px!important;height:66px!important;padding:0 16px!important;margin-bottom:12px!important}@media (max-width:410px){.i-amphtml-story-share-item{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;padding:0!important;min-width:60px!important;width:25%!important}}@media (min-width:410px) and (max-width:500px){.i-amphtml-story-share-item{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;padding:0!important;width:20%!important}}@media (min-width:500px) and (max-width:720px){.i-amphtml-story-share-item{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;padding:0!important;width:16.66%!important}}.i-amphtml-story-share-widget-scrollable .i-amphtml-story-share-list{-ms-flex-wrap:nowrap!important;flex-wrap:nowrap!important}.i-amphtml-story-share-widget-scrollable>*>.i-amphtml-story-share-item{display:block!important;margin:0!important;padding:0 16px!important;min-width:auto!important}.i-amphtml-story-share-item:empty{display:none!important}.i-amphtml-story-share-icon{box-sizing:border-box!important;position:relative!important;width:48px!important;height:48px!important;display:block!important;cursor:pointer!important;border-radius:4px!important;overflow:visible!important;background-position:8px 8px!important;background-size:32px 32px!important;background-repeat:no-repeat!important}.i-amphtml-story-share-icon.amp-social-share-facebook{background-size:38px 38px!important;background-position:5px 5px!important}.i-amphtml-story-share-icon:focus{outline:2px solid #0389ff!important;outline-offset:2px!important}.i-amphtml-story-share-icon[type=email]{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important;background-color:#9aa0a6!important}.i-amphtml-story-share-icon[type=system]{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23fff'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z'/%3E%3C/svg%3E\\\")!important;background-color:#9aa0a6!important}.i-amphtml-story-share-icon-link{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z'/%3E%3C/svg%3E\\\")!important;background-color:#9aa0a6!important}.i-amphtml-story-share-icon .i-amphtml-story-share-label{position:absolute!important;top:48px!important;left:0!important;width:100%!important;color:rgba(0,0,0,0.87)!important;padding-top:5px!important;text-transform:capitalize!important;font-family:Roboto,sans-serif!important;font-weight:400!important;line-height:13px!important;font-size:11px!important;text-align:center!important}.i-amphtml-story-info-dialog{position:absolute!important;top:0!important;left:0!important;height:100%!important;width:100%!important;z-index:100001!important;transform:translate3d(0,-100%,0)!important;transition-delay:0.15s!important}.i-amphtml-story-info-dialog-visible{transform:translateZ(0)!important;transition-delay:0s!important}.i-amphtml-story-info-dialog:before{content:\\\"\\\"!important;position:absolute!important;top:0!important;left:0!important;height:100%!important;width:100%!important;background:#000!important;opacity:0!important;transition:opacity 0.15s cubic-bezier(0.4,0.0,1,1)!important}.i-amphtml-story-info-dialog.i-amphtml-story-info-dialog-visible:before{opacity:0.55!important;transition:opacity 0.2s cubic-bezier(0.0,0.0,0.2,1)!important}.i-amphtml-story-info-dialog-container{position:absolute!important;top:0!important;left:0!important;right:0!important;height:auto!important;background:#fff!important;border-radius:0 0 8px 8px!important;transform:translate3d(0,-100%,0)!important;transition:transform 0.15s cubic-bezier(0.4,0.0,1,1)!important;padding:20px!important;font-family:Roboto,sans-serif!important}.i-amphtml-story-info-dialog-visible .i-amphtml-story-info-dialog-container{transform:translateZ(0)!important;transition:transform 0.2s cubic-bezier(0.0,0.0,0.2,1)!important}.i-amphtml-story-info-heading{display:block!important;font-size:14px!important;font-weight:700!important;margin:0 0 8px!important}.i-amphtml-story-info-link{color:#000!important;display:block!important;margin:0!important;opacity:0.64!important;font-size:12px!important;text-decoration:none!important}.i-amphtml-story-info-moreinfo{color:#4285f4!important;display:none!important;font-family:Roboto-Medium,sans-serif!important;font-size:12px!important;letter-spacing:0.5px!important;margin:16px 0 0;text-decoration:none!important}.i-amphtml-story-info-moreinfo.i-amphtml-story-info-moreinfo-visible{display:block!important}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story-info-dialog.css*/\";\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ANALYTICS_TAG_NAME,\n  StoryAnalyticsEvent,\n  getAnalyticsService,\n} from './story-analytics';\nimport {\n  Action,\n  StateProperty,\n  getStoreService,\n} from './amp-story-store-service';\nimport {CSS} from '../../../build/amp-story-info-dialog-1.0.css';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {Services} from '../../../src/services';\nimport {assertAbsoluteHttpOrHttpsUrl} from '../../../src/url';\nimport {closest, matches} from '../../../src/core/dom/query';\nimport {createShadowRootWithStyle, triggerClickFromLightDom} from './utils';\nimport {dev} from '../../../src/log';\nimport {getAmpdoc} from '../../../src/service';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {htmlFor} from '../../../src/static-template';\n\n/** @const {string} Class to toggle the info dialog. */\nexport const DIALOG_VISIBLE_CLASS = 'i-amphtml-story-info-dialog-visible';\n\n/** @const {string} Class to toggle the info dialog link. */\nexport const MOREINFO_VISIBLE_CLASS = 'i-amphtml-story-info-moreinfo-visible';\n\n/**\n * A dialog that provides a link to the canonical URL of the story, as well as\n * a link to any more information that the viewer would like to provide about\n * linking on that platform.\n */\nexport class InfoDialog {\n  /**\n   * @param {!Window} win\n   * @param {!Element} parentEl Element where to append the component\n   */\n  constructor(win, parentEl) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {?Element} */\n    this.element_ = null;\n\n    /** @private {?Element} */\n    this.innerContainerEl_ = null;\n\n    /** @private {boolean} */\n    this.isBuilt_ = false;\n\n    /** @private @const {!../../../src/service/localization.LocalizationService} */\n    this.localizationService_ = getLocalizationService(parentEl);\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win_);\n\n    /** @private {!./story-analytics.StoryAnalyticsService} */\n    this.analyticsService_ = getAnalyticsService(this.win_, parentEl);\n\n    /** @private @const {!Element} */\n    this.parentEl_ = parentEl;\n\n    /** @private @const {!../../../src/service/mutator-interface.MutatorInterface} */\n    this.mutator_ = Services.mutatorForDoc(getAmpdoc(this.win_.document));\n\n    /** @private {?Element} */\n    this.moreInfoLinkEl_ = null;\n\n    /** @const @private {!../../../src/service/viewer-interface.ViewerInterface} */\n    this.viewer_ = Services.viewerForDoc(this.parentEl_);\n  }\n\n  /**\n   * Builds and appends the component in the story.\n   * @return {!Promise} used for testing to ensure that the component is built\n   *     before assertions.\n   */\n  build() {\n    if (this.isBuilt()) {\n      return Promise.resolve();\n    }\n\n    this.isBuilt_ = true;\n    const root = this.win_.document.createElement('div');\n    const html = htmlFor(this.parentEl_);\n    this.element_ = html`\n      <div class=\"i-amphtml-story-info-dialog i-amphtml-story-system-reset\">\n        <div class=\"i-amphtml-story-info-dialog-container\">\n          <h1 class=\"i-amphtml-story-info-heading\"></h1>\n          <a class=\"i-amphtml-story-info-link\"></a>\n          <a class=\"i-amphtml-story-info-moreinfo\"></a>\n        </div>\n      </div>\n    `;\n\n    createShadowRootWithStyle(root, this.element_, CSS);\n    this.initializeListeners_();\n\n    this.innerContainerEl_ = this.element_.querySelector(\n      '.i-amphtml-story-info-dialog-container'\n    );\n\n    const appendPromise = this.mutator_.mutateElement(this.parentEl_, () => {\n      this.parentEl_.appendChild(root);\n    });\n\n    const pageUrl = Services.documentInfoForDoc(\n      getAmpdoc(this.parentEl_)\n    ).canonicalUrl;\n\n    return Promise.all([\n      appendPromise,\n      this.setHeading_(),\n      this.setPageLink_(pageUrl),\n      this.requestMoreInfoLink_().then((moreInfoUrl) =>\n        this.setMoreInfoLinkUrl_(moreInfoUrl)\n      ),\n    ]);\n  }\n\n  /**\n   * Whether the element has been built.\n   * @return {boolean}\n   */\n  isBuilt() {\n    return this.isBuilt_;\n  }\n\n  /**\n   * @private\n   */\n  initializeListeners_() {\n    this.storeService_.subscribe(StateProperty.INFO_DIALOG_STATE, (isOpen) => {\n      this.onInfoDialogStateUpdated_(isOpen);\n    });\n\n    this.element_.addEventListener('click', (event) =>\n      this.onInfoDialogClick_(event)\n    );\n  }\n\n  /**\n   * Reacts to dialog state updates and decides whether to show either the\n   * native system sharing, or the fallback UI.\n   * @param {boolean} isOpen\n   * @private\n   */\n  onInfoDialogStateUpdated_(isOpen) {\n    this.mutator_.mutateElement(dev().assertElement(this.element_), () => {\n      this.element_.classList.toggle(DIALOG_VISIBLE_CLASS, isOpen);\n    });\n\n    this.element_[ANALYTICS_TAG_NAME] = 'amp-story-info-dialog';\n    this.analyticsService_.triggerEvent(\n      isOpen ? StoryAnalyticsEvent.OPEN : StoryAnalyticsEvent.CLOSE,\n      this.element_\n    );\n  }\n\n  /**\n   * Handles click events and maybe closes the dialog.\n   * @param  {!Event} event\n   */\n  onInfoDialogClick_(event) {\n    const el = dev().assertElement(event.target);\n    // Closes the dialog if click happened outside of the dialog main container.\n    if (!closest(el, (el) => el === this.innerContainerEl_, this.element_)) {\n      this.close_();\n    }\n    const anchorClicked = closest(event.target, (e) => matches(e, 'a[href]'));\n    if (anchorClicked) {\n      triggerClickFromLightDom(anchorClicked, this.element);\n      event.preventDefault();\n    }\n  }\n\n  /**\n   * Closes the info dialog.\n   * @private\n   */\n  close_() {\n    this.storeService_.dispatch(Action.TOGGLE_INFO_DIALOG, false);\n  }\n\n  /**\n   * @return {!Promise<?string>} The URL to visit to receive more info on this\n   *     page.\n   * @private\n   */\n  requestMoreInfoLink_() {\n    if (!this.viewer_.isEmbedded()) {\n      return Promise.resolve(null);\n    }\n    return this.viewer_\n      ./*OK*/ sendMessageAwaitResponse('moreInfoLinkUrl', /* data */ undefined)\n      .then((moreInfoUrl) => {\n        if (!moreInfoUrl) {\n          return null;\n        }\n        return assertAbsoluteHttpOrHttpsUrl(dev().assertString(moreInfoUrl));\n      });\n  }\n\n  /**\n   * Sets the heading on the dialog.\n   * @return {*} TODO(#23582): Specify return type\n   */\n  setHeading_() {\n    const label = this.localizationService_.getLocalizedString(\n      LocalizedStringId.AMP_STORY_DOMAIN_DIALOG_HEADING_LABEL\n    );\n    const headingEl = dev().assertElement(\n      this.element_.querySelector('.i-amphtml-story-info-heading')\n    );\n\n    return this.mutator_.mutateElement(headingEl, () => {\n      headingEl.textContent = label;\n    });\n  }\n\n  /**\n   * @param {string} pageUrl The URL to the canonical version of the current\n   *     document.\n   * @return {*} TODO(#23582): Specify return type\n   */\n  setPageLink_(pageUrl) {\n    const linkEl = dev().assertElement(\n      this.element_.querySelector('.i-amphtml-story-info-link')\n    );\n\n    return this.mutator_.mutateElement(linkEl, () => {\n      linkEl.setAttribute('href', pageUrl);\n\n      // Add zero-width space character (\\u200B) after \".\" and \"/\" characters\n      // to help line-breaks occur more naturally.\n      linkEl.textContent = pageUrl.replace(/([/.]+)/gi, '$1\\u200B');\n    });\n  }\n\n  /**\n   * @param {?string} moreInfoUrl The URL to the \"more info\" page, if there is\n   * one.\n   * @return {*} TODO(#23582): Specify return type\n   */\n  setMoreInfoLinkUrl_(moreInfoUrl) {\n    if (!moreInfoUrl) {\n      return Promise.resolve();\n    }\n\n    this.moreInfoLinkEl_ = dev().assertElement(\n      this.element_.querySelector('.i-amphtml-story-info-moreinfo')\n    );\n\n    return this.mutator_.mutateElement(this.moreInfoLinkEl_, () => {\n      const label = this.localizationService_.getLocalizedString(\n        LocalizedStringId.AMP_STORY_DOMAIN_DIALOG_HEADING_LINK\n      );\n      this.moreInfoLinkEl_.classList.add(MOREINFO_VISIBLE_CLASS);\n      this.moreInfoLinkEl_.setAttribute(\n        'href',\n        dev().assertString(moreInfoUrl)\n      );\n      this.moreInfoLinkEl_.setAttribute('target', '_blank');\n      this.moreInfoLinkEl_.textContent = label;\n    });\n  }\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Action, getStoreService} from './amp-story-store-service';\nimport {CommonSignals} from '../../../src/core/constants/common-signals';\nimport {Services} from '../../../src/services';\nimport {createElementWithAttributes} from '../../../src/dom';\nimport {dict} from '../../../src/core/types/object';\nimport {lastChildElement} from '../../../src/core/dom/query';\nimport {userAssert} from '../../../src/log';\n\n/**\n * Property used for storing id of custom slot. This custom slot can be used to\n * replace the default \"items\" and \"update\" slot.\n * @const {string}\n */\nconst AMP_LIVE_LIST_CUSTOM_SLOT_ID = 'AMP_LIVE_LIST_CUSTOM_SLOT_ID';\n\nexport class LiveStoryManager {\n  /**\n   * @param {!./amp-story.AmpStory} ampStory\n   */\n  constructor(ampStory) {\n    /** @private @const {!./amp-story.AmpStory} */\n    this.ampStory_ = ampStory;\n\n    /** @private @const {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = this.ampStory_.getAmpDoc();\n\n    /** @private @const {!Element} */\n    this.storyEl_ = ampStory.element;\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.ampStory_.win);\n  }\n\n  /**\n   * Initializes an amp-live-list component with the story-specific\n   * configuration and appends it to the DOM.\n   */\n  build() {\n    const liveListEl = createElementWithAttributes(\n      this.ampStory_.win.document,\n      'amp-live-list',\n      dict({\n        'id': 'i-amphtml-' + this.storyEl_.id + '-dynamic-list',\n        'data-poll-interval':\n          this.storyEl_.getAttribute('data-poll-interval') || 15000,\n        'sort': 'ascending',\n        'disable-scrolling': '',\n        'disable-pagination': '',\n        'auto-insert': '',\n      })\n    );\n    liveListEl[AMP_LIVE_LIST_CUSTOM_SLOT_ID] = userAssert(\n      this.storyEl_.id,\n      'amp-story must contain id to use the live story functionality'\n    );\n\n    this.ampStory_.element\n      .signals()\n      .whenSignal(CommonSignals.LOAD_END)\n      .then(() => {\n        Services.extensionsFor(this.ampdoc_.win).installExtensionForDoc(\n          this.ampdoc_,\n          'amp-live-list'\n        );\n        this.storyEl_.insertBefore(liveListEl, this.storyEl_.firstElementChild);\n      });\n  }\n\n  /**\n   * Updates the client amp-story with the changes from the server document.\n   */\n  update() {\n    const lastNewPageEl = lastChildElement(this.storyEl_, (page) =>\n      page.classList.contains('amp-live-list-item-new')\n    );\n\n    const storyPages = this.storyEl_.querySelectorAll('amp-story-page');\n    const pageIds = Array.prototype.map.call(storyPages, (el) => el.id);\n\n    this.storeService_.dispatch(Action.SET_PAGE_IDS, pageIds);\n    this.storeService_.dispatch(Action.ADD_NEW_PAGE_ID, lastNewPageEl.id);\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  Action,\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {AdvancementMode} from './story-analytics';\nimport {EventType, dispatch} from './events';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {Services} from '../../../src/services';\nimport {dev, devAssert} from '../../../src/log';\n\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {htmlFor} from '../../../src/static-template';\n\n/** @struct @typedef {{className: string, triggers: (string|undefined)}} */\nlet ButtonState_1_0_Def; // eslint-disable-line google-camelcase/google-camelcase\n\n/** @const {!Object<string, !ButtonState_1_0_Def>} */\nconst BackButtonStates = {\n  HIDDEN: {className: 'i-amphtml-story-button-hidden'},\n  PREVIOUS_PAGE: {\n    className: 'i-amphtml-story-back-prev',\n    triggers: EventType.PREVIOUS_PAGE,\n    label: LocalizedStringId.AMP_STORY_PREVIOUS_PAGE,\n  },\n};\n\n/** @const {!Object<string, !ButtonState_1_0_Def>} */\nconst ForwardButtonStates = {\n  HIDDEN: {className: 'i-amphtml-story-button-hidden'},\n  NEXT_PAGE: {\n    className: 'i-amphtml-story-fwd-next',\n    triggers: EventType.NEXT_PAGE,\n    label: LocalizedStringId.AMP_STORY_NEXT_PAGE,\n  },\n  NEXT_STORY: {\n    className: 'i-amphtml-story-fwd-next',\n    triggers: EventType.NEXT_PAGE,\n    label: LocalizedStringId.AMP_STORY_NEXT_STORY,\n  },\n  REPLAY: {\n    className: 'i-amphtml-story-fwd-replay',\n    triggers: EventType.REPLAY,\n    label: LocalizedStringId.AMP_STORY_REPLAY,\n  },\n};\n\n/**\n * @param {!Element} element\n * @return {!Element}\n */\nconst buildPaginationButton = (element) =>\n  htmlFor(element)`\n      <div class=\"i-amphtml-story-button-container\">\n        <button class=\"i-amphtml-story-button-move\"></button>\n      </div>`;\n\n/**\n * @param {!Element} hoverEl\n * @param {!Element} targetEl\n * @param {string} className\n * @return {?Array<function(!Event)>}\n */\nfunction setClassOnHover(hoverEl, targetEl, className) {\n  const enterListener = () => targetEl.classList.add(className);\n  const exitListener = () => targetEl.classList.remove(className);\n  hoverEl.addEventListener('mouseenter', enterListener);\n  hoverEl.addEventListener('mouseleave', exitListener);\n  return [enterListener, exitListener];\n}\n\n/**\n * Desktop navigation buttons.\n */\nclass PaginationButton {\n  /**\n   * @param {!Document} doc\n   * @param {!ButtonState_1_0_Def} initialState\n   * @param {!./amp-story-store-service.AmpStoryStoreService} storeService\n   * @param {!Window} win\n   */\n  constructor(doc, initialState, storeService, win) {\n    /** @private {!ButtonState_1_0_Def} */\n    this.state_ = initialState;\n\n    /** @public @const {!Element} */\n    this.element = buildPaginationButton(doc);\n\n    /** @private @const {!Element} */\n    this.buttonElement_ = dev().assertElement(\n      this.element.querySelector('button')\n    );\n\n    /** @private @const {!../../../src/service/localization.LocalizationService} */\n    this.localizationService_ = getLocalizationService(doc);\n\n    this.element.classList.add(initialState.className);\n    initialState.label &&\n      this.buttonElement_.setAttribute(\n        'aria-label',\n        this.localizationService_.getLocalizedString(initialState.label)\n      );\n    this.element.addEventListener('click', (e) => this.onClick_(e));\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = storeService;\n\n    /** @private @const {!Window} */\n    this.win_ = win;\n  }\n\n  /** @param {!ButtonState_1_0_Def} state */\n  updateState(state) {\n    if (state === this.state_) {\n      return;\n    }\n    this.element.classList.remove(this.state_.className);\n    this.element.classList.add(state.className);\n    state.label\n      ? this.buttonElement_.setAttribute(\n          'aria-label',\n          this.localizationService_.getLocalizedString(state.label)\n        )\n      : this.buttonElement_.removeAttribute('aria-label');\n\n    this.state_ = state;\n  }\n\n  /**\n   * @return {!ButtonState_1_0_Def}\n   */\n  getState() {\n    return this.state_;\n  }\n\n  /**\n   * @param {!Event} e\n   * @private\n   */\n  onClick_(e) {\n    e.preventDefault();\n\n    this.storeService_.dispatch(\n      Action.SET_ADVANCEMENT_MODE,\n      AdvancementMode.MANUAL_ADVANCE\n    );\n\n    if (this.state_.triggers) {\n      dispatch(\n        this.win_,\n        this.element,\n        devAssert(this.state_.triggers),\n        /* payload */ undefined,\n        {bubbles: true}\n      );\n      return;\n    }\n    if (this.state_.action) {\n      this.storeService_.dispatch(this.state_.action, this.state_.data);\n      return;\n    }\n  }\n}\n\n/** Pagination buttons layer. */\nexport class PaginationButtons {\n  /**\n   * @param {!./amp-story.AmpStory} ampStory\n   */\n  constructor(ampStory) {\n    /** @private @const {!./amp-story.AmpStory} */\n    this.ampStory_ = ampStory;\n\n    const {win} = this.ampStory_;\n    const doc = win.document;\n    this.storeService_ = getStoreService(win);\n\n    /** @private @const {!PaginationButton} */\n    this.forwardButton_ = new PaginationButton(\n      doc,\n      ForwardButtonStates.NEXT_PAGE,\n      this.storeService_,\n      win\n    );\n\n    /** @private @const {!PaginationButton} */\n    this.backButton_ = new PaginationButton(\n      doc,\n      BackButtonStates.HIDDEN,\n      this.storeService_,\n      win\n    );\n\n    this.forwardButton_.element.classList.add('next-container');\n    this.backButton_.element.classList.add('prev-container');\n\n    /** @private {?ButtonState_1_0_Def} */\n    this.backButtonStateToRestore_ = null;\n\n    /** @private {?ButtonState_1_0_Def} */\n    this.forwardButtonStateToRestore_ = null;\n\n    /** @private {?Array<function(!Event)>} */\n    this.hoverListeners_ = null;\n\n    this.initializeListeners_();\n\n    this.ampStory_.element.appendChild(this.forwardButton_.element);\n    this.ampStory_.element.appendChild(this.backButton_.element);\n  }\n\n  /** @private */\n  addHoverListeners_() {\n    if (this.hoverListeners_) {\n      return;\n    }\n\n    const forwardButtonListeners = setClassOnHover(\n      this.forwardButton_.element,\n      this.ampStory_.element,\n      'i-amphtml-story-next-hover'\n    );\n\n    const backButtonListeners = setClassOnHover(\n      this.backButton_.element,\n      this.ampStory_.element,\n      'i-amphtml-story-prev-hover'\n    );\n\n    this.hoverListeners_ = forwardButtonListeners.concat(backButtonListeners);\n  }\n\n  /** @private */\n  initializeListeners_() {\n    this.storeService_.subscribe(\n      StateProperty.CURRENT_PAGE_INDEX,\n      (pageIndex) => {\n        this.onCurrentPageIndexUpdate_(pageIndex);\n      }\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.PAGE_IDS,\n      () => {\n        const currentPageIndex = Number(\n          this.storeService_.get(StateProperty.CURRENT_PAGE_INDEX)\n        );\n        this.onCurrentPageIndexUpdate_(currentPageIndex);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.SYSTEM_UI_IS_VISIBLE_STATE,\n      (isVisible) => {\n        this.onSystemUiIsVisibleStateUpdate_(isVisible);\n      }\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.UI_STATE,\n      (uiState) => {\n        this.onUIStateUpdate_(uiState);\n      },\n      true /** callToInitialize */\n    );\n  }\n\n  /**\n   * @param {number} pageIndex\n   * @private\n   */\n  onCurrentPageIndexUpdate_(pageIndex) {\n    const totalPages = this.storeService_.get(StateProperty.PAGE_IDS).length;\n\n    if (pageIndex === 0) {\n      this.backButton_.updateState(BackButtonStates.HIDDEN);\n    }\n\n    if (pageIndex > 0) {\n      this.backButton_.updateState(BackButtonStates.PREVIOUS_PAGE);\n    }\n\n    if (pageIndex < totalPages - 1) {\n      this.forwardButton_.updateState(ForwardButtonStates.NEXT_PAGE);\n    }\n\n    if (pageIndex === totalPages - 1) {\n      const viewer = Services.viewerForDoc(this.ampStory_.element);\n      if (viewer.hasCapability('swipe')) {\n        this.forwardButton_.updateState(ForwardButtonStates.NEXT_STORY);\n      } else {\n        this.forwardButton_.updateState(ForwardButtonStates.REPLAY);\n      }\n    }\n  }\n\n  /**\n   * Reacts to system UI visibility state updates.\n   * @param {boolean} isVisible\n   * @private\n   */\n  onSystemUiIsVisibleStateUpdate_(isVisible) {\n    if (isVisible) {\n      this.backButton_.updateState(\n        /** @type {!ButtonState_1_0_Def} */ (\n          devAssert(this.backButtonStateToRestore_)\n        )\n      );\n      this.forwardButton_.updateState(\n        /** @type {!ButtonState_1_0_Def} */ (\n          devAssert(this.forwardButtonStateToRestore_)\n        )\n      );\n    } else {\n      this.backButtonStateToRestore_ = this.backButton_.getState();\n      this.backButton_.updateState(BackButtonStates.HIDDEN);\n      this.forwardButtonStateToRestore_ = this.forwardButton_.getState();\n      this.forwardButton_.updateState(ForwardButtonStates.HIDDEN);\n    }\n  }\n\n  /**\n   * Reacts to UI state updates.\n   * @param {!UIType} uiState\n   * @private\n   */\n  onUIStateUpdate_(uiState) {\n    if (\n      uiState === UIType.DESKTOP_PANELS ||\n      uiState === UIType.DESKTOP_FULLBLEED\n    ) {\n      this.addHoverListeners_();\n    }\n  }\n}\n", "export const CSS = \":host{all:initial!important;color:initial!important}.amp-social-share-facebook{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M211.9 197.4h-36.7v59.9h36.7v175.8h70.5V256.5h49.2l5.2-59.1h-54.4v-33.7c0-13.9 2.8-19.5 16.3-19.5h38.2V82.9h-48.8c-52.5 0-76.1 23.1-76.1 67.3-.1 38.6-.1 47.2-.1 47.2z'/%3E%3C/svg%3E\\\")}.amp-social-share-pinterest{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M266.6 76.5c-100.2 0-150.7 71.8-150.7 131.7 0 36.3 13.7 68.5 43.2 80.6 4.8 2 9.2.1 10.6-5.3 1-3.7 3.3-13 4.3-16.9 1.4-5.3.9-7.1-3-11.8-8.5-10-13.9-23-13.9-41.3 0-53.3 39.9-101 103.8-101 56.6 0 87.7 34.6 87.7 80.8 0 60.8-26.9 112.1-66.8 112.1-22.1 0-38.6-18.2-33.3-40.6 6.3-26.7 18.6-55.5 18.6-74.8 0-17.3-9.3-31.7-28.4-31.7-22.5 0-40.7 23.3-40.7 54.6 0 19.9 6.7 33.4 6.7 33.4s-23.1 97.8-27.1 114.9c-8.1 34.1-1.2 75.9-.6 80.1.3 2.5 3.6 3.1 5 1.2 2.1-2.7 28.9-35.9 38.1-69 2.6-9.4 14.8-58 14.8-58 7.3 14 28.7 26.3 51.5 26.3 67.8 0 113.8-61.8 113.8-144.5-.1-62.6-53.1-120.8-133.6-120.8z'/%3E%3C/svg%3E\\\")}.amp-social-share-linkedin{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M186.4 142.4c0 19-15.3 34.5-34.2 34.5-18.9 0-34.2-15.4-34.2-34.5 0-19 15.3-34.5 34.2-34.5 18.9 0 34.2 15.5 34.2 34.5zm-5 58.9h-57.8v186.8h57.8V201.3zm92.4 0h-55.4v186.8h55.4v-98c0-26.3 12.1-41.9 35.2-41.9 21.3 0 31.5 15 31.5 41.9v98H398V269.8c0-50-28.3-74.2-68-74.2-39.6 0-56.3 30.9-56.3 30.9v-25.2h.1z'/%3E%3C/svg%3E\\\")}.amp-social-share-gplus{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M179.7 237.6v46.6h77c-3.1 20-23.3 58.7-77 58.7-46.3 0-84.1-38.5-84.1-85.9 0-47.4 37.8-85.9 84.1-85.9 26.4 0 44 11.3 54.1 21l36.8-35.5C247 134.4 216.4 121 179.7 121 104.7 121 44 181.8 44 257s60.7 136 135.7 136C258 393 310 337.8 310 260.1c0-8.9-1-15.7-2.1-22.5H179.7zm288.3-.9h-38.7V198h-38.6v38.7H352v38.6h38.7V314h38.6v-38.7H468'/%3E%3C/svg%3E\\\")}.amp-social-share-email{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M101.3 141.6v228.9h309.5V141.6H101.3zm274.4 26.2L256 259.3l-119.6-91.5h239.3zm-248.1 26.3 64.1 49.1-64.1 64.1V194.1zm.2 150.1 84.9-84.9 43.2 33.1 43-32.9 84.7 84.7H127.8zm256.6-36.4L320 243.4l64.4-49.3v113.7z'/%3E%3C/svg%3E\\\")}.amp-social-share-twitter{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath d='M0 0h400v400H0z'/%3E%3Cpath fill='%23FFF' fill-rule='nonzero' d='M153.62 301.59c94.34 0 145.94-78.16 145.94-145.94 0-2.22 0-4.43-.15-6.63A104.36 104.36 0 0 0 325 122.47a102.38 102.38 0 0 1-29.46 8.07 51.47 51.47 0 0 0 22.55-28.37 102.79 102.79 0 0 1-32.57 12.45c-15.9-16.906-41.163-21.044-61.625-10.093-20.461 10.95-31.032 34.266-25.785 56.873A145.62 145.62 0 0 1 92.4 107.81c-13.614 23.436-6.66 53.419 15.88 68.47A50.91 50.91 0 0 1 85 169.86v.65c.007 24.416 17.218 45.445 41.15 50.28a51.21 51.21 0 0 1-23.16.88c6.72 20.894 25.976 35.208 47.92 35.62a102.92 102.92 0 0 1-63.7 22 104.41 104.41 0 0 1-12.21-.74 145.21 145.21 0 0 0 78.62 23'/%3E%3C/g%3E%3C/svg%3E\\\")}.amp-social-share-tumblr{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M210.8 80.3c-2.3 18.3-6.4 33.4-12.4 45.2-6 11.9-13.9 22-23.9 30.5-9.9 8.5-21.8 14.9-35.7 19.5v50.6h38.9v124.5c0 16.2 1.7 28.6 5.1 37.1 3.4 8.5 9.5 16.6 18.3 24.2 8.8 7.6 19.4 13.4 31.9 17.5s26.8 6.1 43 6.1c14.3 0 27.6-1.4 39.9-4.3 12.3-2.9 26-7.9 41.2-15v-55.9c-17.8 11.7-35.7 17.5-53.7 17.5-10.1 0-19.1-2.4-27-7.1-5.9-3.5-10-8.2-12.2-14-2.2-5.8-3.3-19.1-3.3-39.7v-91.1h84.6v-55.8h-84.4v-90h-50.3z'/%3E%3C/svg%3E\\\")}.amp-social-share-whatsapp{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='46' height='46'%3E%3Cpath fill='%23FFF' d='M35.4 10.4C32 6.9 27.3 5 22.5 5 12.3 5 4.1 13.3 4.2 23.4c0 3.2.9 6.3 2.4 9.1L4 42l9.7-2.5c2.7 1.5 5.7 2.2 8.7 2.2 10.1 0 18.3-8.3 18.3-18.4 0-4.9-1.9-9.5-5.3-12.9zM22.5 38.6c-2.7 0-5.4-.7-7.7-2.1l-.6-.3-5.8 1.5L9.9 32l-.4-.6c-4.4-7.1-2.3-16.5 4.9-20.9 7.2-4.4 16.5-2.3 20.9 4.9 4.4 7.2 2.3 16.5-4.9 20.9-2.3 1.5-5.1 2.3-7.9 2.3zm8.8-11.1-1.1-.5s-1.6-.7-2.6-1.2c-.1 0-.2-.1-.3-.1-.3 0-.5.1-.7.2 0 0-.1.1-1.5 1.7-.1.2-.3.3-.5.3h-.1c-.1 0-.3-.1-.4-.2l-.5-.2c-1.1-.5-2.1-1.1-2.9-1.9-.2-.2-.5-.4-.7-.6-.7-.7-1.4-1.5-1.9-2.4l-.1-.2c-.1-.1-.1-.2-.2-.4 0-.2 0-.4.1-.5 0 0 .4-.5.7-.8.2-.2.3-.5.5-.7.2-.3.3-.7.2-1-.1-.5-1.3-3.2-1.6-3.8-.2-.3-.4-.4-.7-.5h-1.1c-.2 0-.4.1-.6.1l-.1.1c-.2.1-.4.3-.6.4-.2.2-.3.4-.5.6-.7.9-1.1 2-1.1 3.1 0 .8.2 1.6.5 2.3l.1.3c.9 1.9 2.1 3.6 3.7 5.1l.4.4c.3.3.6.5.8.8 2.1 1.8 4.5 3.1 7.2 3.8.3.1.7.1 1 .2h1c.5 0 1.1-.2 1.5-.4.3-.2.5-.2.7-.4l.2-.2c.2-.2.4-.3.6-.5.2-.2.4-.4.5-.6.2-.4.3-.9.4-1.4v-.7s-.1-.1-.3-.2z'/%3E%3C/svg%3E\\\")}.amp-social-share-line{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 511.99'%3E%3Cpath d='M443.2 233.29c0-84.14-84.35-152.6-188-152.6s-188 68.46-188 152.6c0 75.43 66.9 138.61 157.26 150.55 6.13 1.32 14.46 4 16.57 9.27 1.89 4.76 1.24 12.2.61 17 0 0-2.21 13.26-2.69 16.09-.82 4.75-3.78 18.6 16.29 10.14s108.21-63.76 147.66-109.16c27.25-29.89 40.3-60.18 40.3-93.89zm-254.38 44.92a3.67 3.67 0 0 1-3.66 3.67h-52.69a3.6 3.6 0 0 1-2.53-1l-.06-.05v-.05a3.65 3.65 0 0 1-1-2.53v-81.96a3.66 3.66 0 0 1 3.66-3.66h13.19a3.66 3.66 0 0 1 3.66 3.66v65.07h35.84a3.66 3.66 0 0 1 3.66 3.66zm31.8 0a3.65 3.65 0 0 1-3.66 3.65h-13.2a3.65 3.65 0 0 1-3.66-3.65v-81.92a3.66 3.66 0 0 1 3.66-3.66H217a3.66 3.66 0 0 1 3.66 3.66zm90.78 0a3.65 3.65 0 0 1-3.66 3.65h-13.19a3.67 3.67 0 0 1-.94-.12h-.05l-.25-.08h-.11l-.18-.08-.17-.08-.11-.06-.22-.14a3.45 3.45 0 0 1-.93-.9L254 229.56v48.66a3.66 3.66 0 0 1-3.67 3.65H237.1a3.65 3.65 0 0 1-3.66-3.65v-81.93a3.66 3.66 0 0 1 3.66-3.66h13.86l.21.05h.13l.21.07h.12a1.31 1.31 0 0 1 .21.08l.12.06.19.11a.41.41 0 0 1 .11.07l.19.13.1.07.19.16.07.07a2.28 2.28 0 0 1 .22.22 3.58 3.58 0 0 1 .28.37L290.89 245v-48.71a3.66 3.66 0 0 1 3.66-3.66h13.19a3.66 3.66 0 0 1 3.66 3.66zm72.83-68.74a3.66 3.66 0 0 1-3.65 3.67h-35.84V227h35.84a3.66 3.66 0 0 1 3.65 3.67v13.19a3.65 3.65 0 0 1-3.65 3.66h-35.84v13.85h35.84a3.65 3.65 0 0 1 3.65 3.66v13.19a3.66 3.66 0 0 1-3.65 3.67h-52.7a3.66 3.66 0 0 1-2.53-1l-.05-.05a.12.12 0 0 1-.05-.05 3.65 3.65 0 0 1-1-2.53V196.3a3.6 3.6 0 0 1 1-2.52l.06-.07a3.63 3.63 0 0 1 2.54-1h52.7a3.66 3.66 0 0 1 3.65 3.67z' style='fill:%23fff' data-name='\u30EC\u30A4\u30E4\u30FC 1'/%3E%3C/svg%3E\\\")}.amp-social-share-sms{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='30' height='29' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke='%23FFF' stroke-width='3' d='M8.73 26v-5.658H2V2h25.97L28 20.355l-12.062.042z' fill='none' fill-rule='evenodd'/%3E%3C/svg%3E\\\")}.amp-social-share-system{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg fill='%23fff' height='24' width='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z'/%3E%3C/svg%3E\\\")}amp-social-share{background-repeat:no-repeat;background-position:50%;background-size:contain;text-decoration:none;cursor:pointer;position:relative}amp-social-share:focus{outline:2px solid #0389ff;outline-offset:2px}.amp-social-share-twitter{background-color:#1da1f2}.amp-social-share-facebook{background-color:#32529f}.amp-social-share-pinterest{background-color:#e60023}.amp-social-share-linkedin{background-color:#0077b5}.amp-social-share-gplus{background-color:#dc4e41}.amp-social-share-tumblr{background-color:#3c5a77}.amp-social-share-email{background-color:#000}.amp-social-share-whatsapp{background-color:#25d366}.amp-social-share-line{background-color:#52b448}.amp-social-share-sms{background-color:#ca2b63}.amp-social-share-system{background-color:#000}.i-amphtml-story-share-widget{display:block!important;margin:16px 8px!important}.i-amphtml-story-no-sharing .i-amphtml-story-share-widget{display:none!important}.i-amphtml-story-share-widget-scrollable{padding:16px 0!important;overflow:auto!important}.i-amphtml-story-share-widget::-webkit-scrollbar{width:0px!important;background:transparent!important}.i-amphtml-story-share-list{list-style:none!important;padding:0 8px!important;margin:0!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-wrap:wrap!important;flex-wrap:wrap!important;width:100%!important}.i-amphtml-story-share-item{width:48px!important;height:66px!important;padding:0 16px!important;margin-bottom:12px!important}@media (max-width:410px){.i-amphtml-story-share-item{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;padding:0!important;min-width:60px!important;width:25%!important}}@media (min-width:410px) and (max-width:500px){.i-amphtml-story-share-item{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;padding:0!important;width:20%!important}}@media (min-width:500px) and (max-width:720px){.i-amphtml-story-share-item{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;padding:0!important;width:16.66%!important}}.i-amphtml-story-share-widget-scrollable .i-amphtml-story-share-list{-ms-flex-wrap:nowrap!important;flex-wrap:nowrap!important}.i-amphtml-story-share-widget-scrollable>*>.i-amphtml-story-share-item{display:block!important;margin:0!important;padding:0 16px!important;min-width:auto!important}.i-amphtml-story-share-item:empty{display:none!important}.i-amphtml-story-share-icon{box-sizing:border-box!important;position:relative!important;width:48px!important;height:48px!important;display:block!important;cursor:pointer!important;border-radius:4px!important;overflow:visible!important;background-position:8px 8px!important;background-size:32px 32px!important;background-repeat:no-repeat!important}.i-amphtml-story-share-icon.amp-social-share-facebook{background-size:38px 38px!important;background-position:5px 5px!important}.i-amphtml-story-share-icon:focus{outline:2px solid #0389ff!important;outline-offset:2px!important}.i-amphtml-story-share-icon[type=email]{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important;background-color:#9aa0a6!important}.i-amphtml-story-share-icon[type=system]{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23fff'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z'/%3E%3C/svg%3E\\\")!important;background-color:#9aa0a6!important}.i-amphtml-story-share-icon-link{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z'/%3E%3C/svg%3E\\\")!important;background-color:#9aa0a6!important}.i-amphtml-story-share-icon .i-amphtml-story-share-label{position:absolute!important;top:48px!important;left:0!important;width:100%!important;color:rgba(0,0,0,0.87)!important;padding-top:5px!important;text-transform:capitalize!important;font-family:Roboto,sans-serif!important;font-weight:400!important;line-height:13px!important;font-size:11px!important;text-align:center!important}.i-amphtml-story-share-menu{position:absolute!important;top:0!important;left:0!important;height:100%!important;width:100%!important;z-index:100003!important;transform:translate3d(0,100vh,0)!important;transition-delay:0.15s!important;pointer-events:none!important;visibility:hidden!important}.i-amphtml-story-share-menu-visible{transform:translateZ(0)!important;transition-delay:0s!important;pointer-events:auto!important;visibility:initial!important}.i-amphtml-story-share-menu:before{content:\\\"\\\"!important;position:absolute!important;top:0!important;left:0!important;height:100%!important;width:100%!important;background:#000!important;opacity:0!important;transition:opacity 0.15s cubic-bezier(0.4,0.0,1,1)!important}.i-amphtml-story-share-menu.i-amphtml-story-share-menu-visible:before{opacity:0.55!important;transition:opacity 0.2s cubic-bezier(0.0,0.0,0.2,1)!important}.i-amphtml-story-share-menu-container{position:absolute!important;bottom:0!important;left:0!important;right:0!important;height:auto!important;background:#fff!important;border-radius:8px 8px 0 0!important;transform:translate3d(0,100%,0)!important;transition:transform 0.15s cubic-bezier(0.4,0.0,1,1)!important}.i-amphtml-story-share-menu-visible .i-amphtml-story-share-menu-container{transform:translateZ(0)!important;transition:transform 0.2s cubic-bezier(0.0,0.0,0.2,1)!important}.i-amphtml-story-share-menu-close-button{display:none!important}.i-amphtml-story-share-menu .i-amphtml-story-share-item{height:72px!important}[desktop].i-amphtml-story-share-menu{display:-ms-flexbox!important;display:flex!important;-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important}[desktop] .i-amphtml-story-share-menu-container{position:relative!important;margin:0!important;max-width:320px!important;opacity:0!important;transform:none!important;transition:opacity 0.15s cubic-bezier(0.4,0.0,1,1)!important}[desktop].i-amphtml-story-share-menu-visible .i-amphtml-story-share-menu-container{border-radius:8px!important;opacity:1!important;transform:none!important;transition:opacity 0.2s cubic-bezier(0.0,0.0,0.2,1)!important}[desktop] .i-amphtml-story-share-menu-close-button{display:block!important;position:absolute!important;top:0!important;right:0!important;height:30px!important;width:30px!important;color:#9aa0a6!important;cursor:pointer!important;font-size:24px!important;line-height:30px!important;text-align:center!important;border:0!important;padding:0!important;background:none!important}[desktop].i-amphtml-story-share-menu .i-amphtml-story-share-item{padding:0!important;height:66px!important;margin:12px!important}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story-share-menu.css*/\";\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {Services} from '../../../src/services';\nimport {createElementWithAttributes, removeElement} from '../../../src/dom';\nimport {toWin} from '../../../src/core/window';\n\n/** @private @const {string} */\nconst TOAST_CLASSNAME = 'i-amphtml-story-toast';\n\n/**\n * The 'alert' role assertively announces toast content to screen readers.\n * @private @const {string}\n * */\nconst TOAST_ROLE = 'alert';\n\n/**\n * Should be higher than total animation time.\n * @private @const {number}\n */\nconst TOAST_VISIBLE_TIME_MS = 2600;\n\n/**\n * UI notifications service, displaying a message to the user for a limited\n * amount of time.\n */\nexport class Toast {\n  /**\n   * @param {!Element} storyEl\n   * @param {!Node|string} childNodeOrText\n   */\n  static show(storyEl, childNodeOrText) {\n    const win = toWin(storyEl.ownerDocument.defaultView);\n\n    const toast = createElementWithAttributes(\n      win.document,\n      'div',\n      /** @type {!JsonObject} */ ({\n        'class': TOAST_CLASSNAME,\n        'role': TOAST_ROLE,\n      })\n    );\n\n    if (typeof childNodeOrText == 'string') {\n      toast.textContent = childNodeOrText;\n    } else {\n      toast.appendChild(childNodeOrText);\n    }\n\n    storyEl.appendChild(toast);\n\n    Services.timerFor(win).delay(\n      () => removeElement(toast),\n      TOAST_VISIBLE_TIME_MS\n    );\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {removeElement} from './dom';\nimport {setStyles} from './style';\n\n/**\n * @param {!Window} win\n * @param {string} text\n * @return {boolean}\n */\nexport function copyTextToClipboard(win, text) {\n  let copySuccessful = false;\n  const doc = win.document;\n\n  const textarea = doc.createElement('textarea');\n\n  setStyles(textarea, {\n    'position': 'fixed',\n    'top': 0,\n    'left': 0,\n    'width': '50px',\n    'height': '50px',\n    'padding': 0,\n    'border': 'none',\n    'outline': 'none',\n    'background': 'transparent',\n  });\n\n  textarea.value = text;\n  textarea.readOnly = true;\n  textarea.contentEditable = true;\n\n  doc.body.appendChild(textarea);\n  win.getSelection().removeAllRanges();\n\n  textarea./*OK*/ focus();\n  textarea.setSelectionRange(0, text.length);\n\n  try {\n    copySuccessful = doc.execCommand('copy');\n  } catch (e) {\n    // \uD83E\uDD37\n  }\n\n  removeElement(textarea);\n\n  return copySuccessful;\n}\n\n/**\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isCopyingToClipboardSupported(doc) {\n  return doc.queryCommandSupported('copy');\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {getChildJsonConfig} from '../../../src/json';\nimport {isProtocolValid} from '../../../src/url';\nimport {once} from '../../../src/core/types/function';\nimport {registerServiceBuilder} from '../../../src/service';\nimport {user, userAssert} from '../../../src/log';\n\n/** @private @const {string} */\nexport const CONFIG_SRC_ATTRIBUTE_NAME = 'src';\n\n/** @private const {string} */\nexport const CREDENTIALS_ATTRIBUTE_NAME = 'data-credentials';\n\n/** @private @const {string} */\nconst TAG = 'amp-story-request-service';\n\n/**\n * Service to send XHRs.\n */\nexport class AmpStoryRequestService {\n  /**\n   * @param {!Window} win\n   * @param {!Element} storyElement\n   */\n  constructor(win, storyElement) {\n    /** @private @const {!Element} */\n    this.storyElement_ = storyElement;\n\n    /** @private @const {!../../../src/service/xhr-impl.Xhr} */\n    this.xhr_ = Services.xhrFor(win);\n\n    /** @const @type {function():(!Promise<!JsonObject>|!Promise<null>)} */\n    this.loadShareConfig = once(() => this.loadShareConfigImpl_());\n  }\n\n  /**\n   * @param {string} rawUrl\n   * @param {Object=} opts\n   * @return {(!Promise<!JsonObject>|!Promise<null>)}\n   */\n  executeRequest(rawUrl, opts = {}) {\n    if (!isProtocolValid(rawUrl)) {\n      user().error(TAG, 'Invalid config url.');\n      return Promise.resolve(null);\n    }\n\n    return Services.urlReplacementsForDoc(this.storyElement_)\n      .expandUrlAsync(user().assertString(rawUrl))\n      .then((url) => this.xhr_.fetchJson(url, opts))\n      .then((response) => {\n        userAssert(response.ok, 'Invalid HTTP response');\n        return response.json();\n      });\n  }\n\n  /**\n   * Retrieves the publisher share providers.\n   * Has to be called through `loadShareConfig`.\n   * @return {(!Promise<!JsonObject>|!Promise<null>)}\n   */\n  loadShareConfigImpl_() {\n    const shareConfigEl = this.storyElement_.querySelector(\n      'amp-story-social-share, amp-story-bookend'\n    );\n    if (!shareConfigEl) {\n      return Promise.resolve();\n    }\n\n    if (shareConfigEl.hasAttribute(CONFIG_SRC_ATTRIBUTE_NAME)) {\n      const rawUrl = shareConfigEl.getAttribute(CONFIG_SRC_ATTRIBUTE_NAME);\n      const credentials = shareConfigEl.getAttribute(\n        CREDENTIALS_ATTRIBUTE_NAME\n      );\n      return this.executeRequest(rawUrl, credentials ? {credentials} : {});\n    }\n\n    // Fallback. Check for an inline json config.\n    let config = null;\n    try {\n      config = getChildJsonConfig(shareConfigEl);\n    } catch (err) {}\n\n    return Promise.resolve(config);\n  }\n}\n\n/**\n * Util function to retrieve the request service. Ensures we can retrieve the\n * service synchronously from the amp-story codebase without running into race\n * conditions.\n * @param  {!Window} win\n * @param  {!Element} storyEl\n * @return {!AmpStoryRequestService}\n */\nexport const getRequestService = (win, storyEl) => {\n  let service = Services.storyRequestService(win);\n\n  if (!service) {\n    service = new AmpStoryRequestService(win, storyEl);\n    registerServiceBuilder(win, 'story-request', function () {\n      return service;\n    });\n  }\n\n  return service;\n};\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {Services} from '../../../src/services';\nimport {Toast} from './toast';\nimport {\n  copyTextToClipboard,\n  isCopyingToClipboardSupported,\n} from '../../../src/clipboard';\nimport {dev, devAssert, user} from '../../../src/log';\nimport {dict, map} from './../../../src/core/types/object';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {getRequestService} from './amp-story-request-service';\nimport {isObject} from '../../../src/core/types';\nimport {listen} from '../../../src/event-helper';\nimport {renderAsElement, renderSimpleTemplate} from './simple-template';\n\n/**\n * Maps share provider type to visible name.\n * If the name only needs to be capitalized (e.g. `facebook` to `Facebook`) it\n * does not need to be included here.\n * @const {!Object<string, !LocalizedStringId>}\n */\nconst SHARE_PROVIDER_LOCALIZED_STRING_ID = map({\n  'system': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_SYSTEM,\n  'email': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_EMAIL,\n  'facebook': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_FACEBOOK,\n  'line': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_LINE,\n  'linkedin': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_LINKEDIN,\n  'pinterest': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_PINTEREST,\n  'gplus': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_GOOGLE_PLUS,\n  'tumblr': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_TUMBLR,\n  'twitter': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_TWITTER,\n  'whatsapp': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_WHATSAPP,\n  'sms': LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_SMS,\n});\n\n/**\n * Key for share providers in config.\n * @const {string}\n */\nexport const SHARE_PROVIDERS_KEY = 'shareProviders';\n\n/**\n * Deprecated key for share providers in config.\n * @const {string}\n */\nexport const DEPRECATED_SHARE_PROVIDERS_KEY = 'share-providers';\n\n/** @private @const {!./simple-template.ElementDef} */\nconst TEMPLATE = {\n  tag: 'div',\n  attrs: dict({'class': 'i-amphtml-story-share-widget'}),\n  children: [\n    {\n      tag: 'ul',\n      attrs: dict({'class': 'i-amphtml-story-share-list'}),\n      children: [\n        {\n          tag: 'li',\n          attrs: dict({'class': 'i-amphtml-story-share-system'}),\n        },\n      ],\n    },\n  ],\n};\n\n/** @private @const {!./simple-template.ElementDef} */\nconst SHARE_ITEM_TEMPLATE = {\n  tag: 'li',\n  attrs: dict({'class': 'i-amphtml-story-share-item'}),\n};\n\n/**\n * @private\n * @param {!Element} el\n * @return {./simple-template-ElementDef}\n */\nfunction buildLinkShareItemTemplate(el) {\n  return {\n    tag: 'div',\n    attrs: dict({\n      'class': 'i-amphtml-story-share-icon i-amphtml-story-share-icon-link',\n      'tabindex': 0,\n      'role': 'button',\n      'aria-label': getLocalizationService(el).getLocalizedString(\n        LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_LINK\n      ),\n    }),\n    children: [\n      {\n        tag: 'span',\n        attrs: dict({'class': 'i-amphtml-story-share-label'}),\n        localizedStringId:\n          LocalizedStringId.AMP_STORY_SHARING_PROVIDER_NAME_LINK,\n      },\n    ],\n  };\n}\n\n/**\n * @param {!JsonObject=} opt_params\n * @return {!JsonObject}\n */\nfunction buildProviderParams(opt_params) {\n  const attrs = dict();\n\n  if (opt_params) {\n    Object.keys(opt_params).forEach((field) => {\n      if (field === 'provider') {\n        return;\n      }\n      attrs[`data-param-${field}`] = opt_params[field];\n    });\n  }\n\n  return attrs;\n}\n\n/**\n * @param {!Document} doc\n * @param {string} shareType\n * @param {!JsonObject=} opt_params\n * @return {!Node}\n */\nfunction buildProvider(doc, shareType, opt_params) {\n  const shareProviderLocalizedStringId = devAssert(\n    SHARE_PROVIDER_LOCALIZED_STRING_ID[shareType],\n    `No localized string to display name for share type ${shareType}.`\n  );\n\n  return renderSimpleTemplate(\n    doc,\n    /** @type {!Array<!./simple-template.ElementDef>} */ ([\n      {\n        tag: 'amp-social-share',\n        attrs: /** @type {!JsonObject} */ (\n          Object.assign(\n            dict({\n              'width': 48,\n              'height': 48,\n              'class': 'i-amphtml-story-share-icon',\n              'type': shareType,\n            }),\n            buildProviderParams(opt_params)\n          )\n        ),\n        children: [\n          {\n            tag: 'span',\n            attrs: dict({'class': 'i-amphtml-story-share-label'}),\n            localizedStringId: shareProviderLocalizedStringId,\n          },\n        ],\n      },\n    ])\n  );\n}\n\n/**\n * @param {!Document} doc\n * @param {string} url\n * @return {!Element}\n */\nfunction buildCopySuccessfulToast(doc, url) {\n  return renderAsElement(\n    doc,\n    /** @type {!./simple-template.ElementDef} */ ({\n      tag: 'div',\n      attrs: dict({'class': 'i-amphtml-story-copy-successful'}),\n      children: [\n        {\n          tag: 'div',\n          localizedStringId:\n            LocalizedStringId.AMP_STORY_SHARING_CLIPBOARD_SUCCESS_TEXT,\n        },\n        {\n          tag: 'div',\n          attrs: dict({'class': 'i-amphtml-story-copy-url'}),\n          unlocalizedString: url,\n        },\n      ],\n    })\n  );\n}\n\n/**\n * Social share widget for the system button.\n */\nexport class ShareWidget {\n  /**\n   * @param {!Window} win\n   * @param {!Element} storyEl\n   */\n  constructor(win, storyEl) {\n    /** @private {?../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = null;\n\n    /** @protected @const {!Window} */\n    this.win = win;\n\n    /** @protected @const {!Element} */\n    this.storyEl = storyEl;\n\n    /** @protected {?Element} */\n    this.root = null;\n\n    /** @private @const {!./amp-story-request-service.AmpStoryRequestService} */\n    this.requestService_ = getRequestService(this.win, storyEl);\n  }\n\n  /**\n   * @param {!Window} win\n   * @param {!Element} storyEl\n   * @return {!ShareWidget}\n   */\n  static create(win, storyEl) {\n    return new ShareWidget(win, storyEl);\n  }\n\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @return {!Element}\n   */\n  build(ampdoc) {\n    devAssert(!this.root, 'Already built.');\n\n    this.ampdoc_ = ampdoc;\n\n    this.root = renderAsElement(this.win.document, TEMPLATE);\n\n    this.loadProviders();\n    this.maybeAddLinkShareButton_();\n    this.maybeAddSystemShareButton_();\n\n    return this.root;\n  }\n\n  /**\n   * @return {!../../../src/service/ampdoc-impl.AmpDoc}\n   * @private\n   */\n  getAmpDoc_() {\n    return devAssert(this.ampdoc_);\n  }\n\n  /** @private */\n  maybeAddLinkShareButton_() {\n    if (!isCopyingToClipboardSupported(this.win.document)) {\n      return;\n    }\n\n    const linkShareButton = renderAsElement(\n      this.win.document,\n      buildLinkShareItemTemplate(this.storyEl)\n    );\n\n    this.add_(linkShareButton);\n\n    listen(linkShareButton, 'click', (e) => {\n      e.preventDefault();\n      this.copyUrlToClipboard_();\n    });\n    listen(linkShareButton, 'keyup', (e) => {\n      const code = e.charCode || e.keyCode;\n      // Check if pressed Space or Enter to trigger button.\n      if (code === 32 || code === 13) {\n        e.preventDefault();\n        this.copyUrlToClipboard_();\n      }\n    });\n  }\n\n  /**\n   * @private\n   */\n  copyUrlToClipboard_() {\n    const url = Services.documentInfoForDoc(this.getAmpDoc_()).canonicalUrl;\n\n    if (!copyTextToClipboard(this.win, url)) {\n      const localizationService = getLocalizationService(this.storyEl);\n      devAssert(localizationService, 'Could not retrieve LocalizationService.');\n      const failureString = localizationService.getLocalizedString(\n        LocalizedStringId.AMP_STORY_SHARING_CLIPBOARD_FAILURE_TEXT\n      );\n      Toast.show(this.storyEl, dev().assertString(failureString));\n      return;\n    }\n\n    Toast.show(this.storyEl, buildCopySuccessfulToast(this.win.document, url));\n  }\n\n  /** @private */\n  maybeAddSystemShareButton_() {\n    if (!this.isSystemShareSupported()) {\n      // `amp-social-share` will hide `system` buttons when not supported, but\n      // we also need to avoid adding it for rendering reasons.\n      return;\n    }\n\n    const container = dev()\n      .assertElement(this.root)\n      .querySelector('.i-amphtml-story-share-system');\n\n    this.loadRequiredExtensions();\n\n    container.appendChild(buildProvider(this.win.document, 'system'));\n  }\n\n  /**\n   * NOTE(alanorozco): This is a duplicate of the logic in the\n   * `amp-social-share` component.\n   * @param  {!../../../src/service/ampdoc-impl.AmpDoc=}  ampdoc\n   * @return {boolean} Whether the browser supports native system sharing.\n   */\n  isSystemShareSupported(ampdoc = this.getAmpDoc_()) {\n    const viewer = Services.viewerForDoc(ampdoc);\n\n    const platform = Services.platformFor(this.win);\n\n    // Chrome exports navigator.share in WebView but does not implement it.\n    // See https://bugs.chromium.org/p/chromium/issues/detail?id=765923\n    const isChromeWebview = viewer.isWebviewEmbedded() && platform.isChrome();\n\n    return 'share' in navigator && !isChromeWebview;\n  }\n\n  /**\n   * Loads and applies the share providers configured by the publisher.\n   * @protected\n   */\n  loadProviders() {\n    this.loadRequiredExtensions();\n\n    this.requestService_.loadShareConfig().then((config) => {\n      const providers =\n        config &&\n        (config[SHARE_PROVIDERS_KEY] || config[DEPRECATED_SHARE_PROVIDERS_KEY]);\n      if (!providers) {\n        return;\n      }\n      this.setProviders_(providers);\n    });\n  }\n\n  /**\n   * @param {(!Object<string, (!JsonObject|boolean)> | !Array<!Object|string>)} providers\n   * @private\n   * TODO(alanorozco): Set story metadata in share config.\n   */\n  setProviders_(providers) {\n    /** @type {!Array} */ (providers).forEach((provider) => {\n      if (isObject(provider)) {\n        this.add_(\n          buildProvider(\n            this.win.document,\n            provider['provider'],\n            /** @type {!JsonObject} */ (provider)\n          )\n        );\n        return;\n      }\n\n      if (provider == 'system') {\n        user().warn(\n          'AMP-STORY',\n          '`system` is not a valid share provider type. Native sharing is ' +\n            'enabled by default and cannot be turned off.',\n          provider\n        );\n        return;\n      }\n      this.add_(\n        buildProvider(this.win.document, /** @type {string} */ (provider))\n      );\n    });\n  }\n\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc=} ampdoc\n   */\n  loadRequiredExtensions(ampdoc = this.getAmpDoc_()) {\n    Services.extensionsFor(this.win).installExtensionForDoc(\n      ampdoc,\n      'amp-social-share'\n    );\n  }\n\n  /**\n   * @param {!Node} node\n   * @private\n   */\n  add_(node) {\n    const list = devAssert(this.root).lastElementChild;\n    const item = renderAsElement(this.win.document, SHARE_ITEM_TEMPLATE);\n\n    item.appendChild(node);\n\n    // `lastElementChild` is the system share button container, which should\n    // always be last in list\n    list.insertBefore(item, list.lastElementChild);\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ANALYTICS_TAG_NAME,\n  StoryAnalyticsEvent,\n  getAnalyticsService,\n} from './story-analytics';\nimport {\n  Action,\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {CSS} from '../../../build/amp-story-share-menu-1.0.css';\nimport {Keys} from '../../../src/core/constants/key-codes';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {Services} from '../../../src/services';\nimport {ShareWidget} from './amp-story-share';\nimport {closest} from '../../../src/core/dom/query';\nimport {createShadowRootWithStyle} from './utils';\nimport {dev, devAssert} from '../../../src/log';\nimport {getAmpdoc} from '../../../src/service';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {htmlFor} from '../../../src/static-template';\nimport {setStyles} from '../../../src/style';\n\n/** @const {string} Class to toggle the share menu. */\nexport const VISIBLE_CLASS = 'i-amphtml-story-share-menu-visible';\n\n/**\n * Quick share template, used as a fallback if native sharing is not supported.\n * @param {!Element} element\n * @return {!Element}\n */\nconst getTemplate = (element) => {\n  return htmlFor(element)`\n    <div class=\"i-amphtml-story-share-menu i-amphtml-story-system-reset\" aria-hidden=\"true\" role=\"alert\">\n      <div class=\"i-amphtml-story-share-menu-container\">\n        <button class=\"i-amphtml-story-share-menu-close-button\" aria-label=\"close\" role=\"button\">\n          &times;\n        </button>\n      </div>\n    </div>`;\n};\n\n/**\n * System amp-social-share button template.\n * @param {!Element} element\n * @return {!Element}\n */\nconst getAmpSocialSystemShareTemplate = (element) => {\n  return htmlFor(element)`<amp-social-share type=\"system\"></amp-social-share>`;\n};\n\n/**\n * Share menu UI.\n */\nexport class ShareMenu {\n  /**\n   * @param {!Window} win\n   * @param {!Element} storyEl Element where to append the component\n   */\n  constructor(win, storyEl) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {?Element} */\n    this.element_ = null;\n\n    /** @private {?Element} */\n    this.closeButton_ = null;\n\n    /** @private {?Element} */\n    this.innerContainerEl_ = null;\n\n    /** @private {boolean} */\n    this.isBuilt_ = false;\n\n    /** @private {boolean} */\n    this.isSystemShareSupported_ = false;\n\n    /** @private @const {!ShareWidget} */\n    this.shareWidget_ = ShareWidget.create(this.win_, storyEl);\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win_);\n\n    /** @private {!./story-analytics.StoryAnalyticsService} */\n    this.analyticsService_ = getAnalyticsService(this.win_, storyEl);\n\n    /** @private @const {!Element} */\n    this.parentEl_ = storyEl;\n\n    /** @const @private {!../../../src/service/vsync-impl.Vsync} */\n    this.vsync_ = Services.vsyncFor(this.win_);\n  }\n\n  /**\n   * Builds and appends the component in the story. Could build either the\n   * amp-social-share button to display the native system sharing, or a fallback\n   * UI.\n   */\n  build() {\n    if (this.isBuilt()) {\n      return;\n    }\n\n    this.isBuilt_ = true;\n\n    this.isSystemShareSupported_ = this.shareWidget_.isSystemShareSupported(\n      getAmpdoc(this.parentEl_)\n    );\n\n    this.isSystemShareSupported_\n      ? this.buildForSystemSharing_()\n      : this.buildForFallbackSharing_();\n  }\n\n  /**\n   * Whether the element has been built.\n   * @return {boolean}\n   */\n  isBuilt() {\n    return this.isBuilt_;\n  }\n\n  /**\n   * Builds a hidden amp-social-share button that triggers the native system\n   * sharing UI.\n   * @private\n   */\n  buildForSystemSharing_() {\n    this.shareWidget_.loadRequiredExtensions(getAmpdoc(this.parentEl_));\n    this.element_ = getAmpSocialSystemShareTemplate(this.parentEl_);\n\n    this.initializeListeners_();\n\n    this.vsync_.mutate(() => {\n      setStyles(dev().assertElement(this.element_), {\n        'visibility': 'hidden',\n        'pointer-events': 'none',\n        'z-index': -1,\n      });\n      this.parentEl_.appendChild(this.element_);\n    });\n  }\n\n  /**\n   * Builds and appends the fallback UI.\n   * @private\n   */\n  buildForFallbackSharing_() {\n    const root = this.win_.document.createElement('div');\n    root.classList.add('i-amphtml-story-share-menu-host');\n\n    this.element_ = getTemplate(this.parentEl_);\n    createShadowRootWithStyle(root, this.element_, CSS);\n\n    this.closeButton_ = dev().assertElement(\n      this.element_.querySelector('.i-amphtml-story-share-menu-close-button')\n    );\n    const localizationService = getLocalizationService(\n      devAssert(this.parentEl_)\n    );\n    if (localizationService) {\n      const localizedCloseString = localizationService.getLocalizedString(\n        LocalizedStringId.AMP_STORY_CLOSE_BUTTON_LABEL\n      );\n      this.closeButton_.setAttribute('aria-label', localizedCloseString);\n    }\n\n    this.initializeListeners_();\n\n    this.vsync_.run({\n      measure: () => {\n        this.innerContainerEl_ = this.element_./*OK*/ querySelector(\n          '.i-amphtml-story-share-menu-container'\n        );\n      },\n      mutate: () => {\n        this.parentEl_.appendChild(root);\n        // Preloads and renders the share widget content.\n        const shareWidget = this.shareWidget_.build(getAmpdoc(this.parentEl_));\n        this.innerContainerEl_.appendChild(shareWidget);\n      },\n    });\n  }\n\n  /**\n   * @private\n   */\n  initializeListeners_() {\n    this.storeService_.subscribe(\n      StateProperty.UI_STATE,\n      (uiState) => {\n        this.onUIStateUpdate_(uiState);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(StateProperty.SHARE_MENU_STATE, (isOpen) => {\n      this.onShareMenuStateUpdate_(isOpen);\n    });\n\n    // Don't listen to click events if the system share is supported, since the\n    // native layer handles all the UI interactions.\n    if (!this.isSystemShareSupported_) {\n      this.element_.addEventListener('click', (event) =>\n        this.onShareMenuClick_(event)\n      );\n\n      this.win_.addEventListener('keyup', (event) => {\n        if (event.key == Keys.ESCAPE) {\n          event.preventDefault();\n          this.close_();\n        }\n      });\n    }\n  }\n\n  /**\n   * Reacts to menu state updates and decides whether to show either the native\n   * system sharing, or the fallback UI.\n   * @param {boolean} isOpen\n   * @private\n   */\n  onShareMenuStateUpdate_(isOpen) {\n    if (this.isSystemShareSupported_ && isOpen) {\n      // Dispatches a click event on the amp-social-share button to trigger the\n      // native system sharing UI. This has to be done upon user interaction.\n      this.element_.dispatchEvent(new Event('click'));\n\n      // There is no way to know when the user dismisses the native system share\n      // menu, so we pretend it is closed on the story end, and let the native\n      // end handle the UI interactions.\n      this.close_();\n    }\n\n    if (!this.isSystemShareSupported_) {\n      this.vsync_.mutate(() => {\n        this.element_.classList.toggle(VISIBLE_CLASS, isOpen);\n        this.element_.setAttribute('aria-hidden', !isOpen);\n      });\n    }\n    this.element_[ANALYTICS_TAG_NAME] = 'amp-story-share-menu';\n    this.analyticsService_.triggerEvent(\n      isOpen ? StoryAnalyticsEvent.OPEN : StoryAnalyticsEvent.CLOSE,\n      this.element_\n    );\n  }\n\n  /**\n   * Handles click events and maybe closes the menu for the fallback UI.\n   * @param  {!Event} event\n   */\n  onShareMenuClick_(event) {\n    const el = dev().assertElement(event.target);\n\n    if (el === this.closeButton_) {\n      this.close_();\n    }\n\n    // Closes the menu if click happened outside of the menu main container.\n    if (!closest(el, (el) => el === this.innerContainerEl_, this.element_)) {\n      this.close_();\n    }\n  }\n\n  /**\n   * Reacts to UI state updates and triggers the right UI.\n   * @param {!UIType} uiState\n   * @private\n   */\n  onUIStateUpdate_(uiState) {\n    this.vsync_.mutate(() => {\n      uiState !== UIType.MOBILE\n        ? this.element_.setAttribute('desktop', '')\n        : this.element_.removeAttribute('desktop');\n    });\n  }\n\n  /**\n   * Closes the share menu.\n   * @private\n   */\n  close_() {\n    this.storeService_.dispatch(Action.TOGGLE_SHARE_MENU, false);\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {Services} from './services';\n\n/** @const {function()} */\nconst NOOP_CALLBACK_ = function () {};\n\n/** @const {number} */\nconst MIN_VELOCITY_ = 0.02;\n\n/** @const {number} */\nconst FRAME_CONST_ = 16.67;\n\n/** @const {number} */\nconst EXP_FRAME_CONST_ = Math.round(-FRAME_CONST_ / Math.log(0.95));\n\n/**\n * Depreciation factor of 1/100 of a millisecond. This is how much previous\n * velocity is depreciated when calculating the new velocity.\n * @const {number}\n */\nconst VELOCITY_DEPR_FACTOR_ = FRAME_CONST_ * 2;\n\n/**\n * Calculates velocity for an object traveling the distance deltaV in the\n * time deltaTime given the previous velocity prevVelocity. The calculation\n * assumes a basic informational depreciation of previous velocity.\n * @param {number} deltaV\n * @param {time} deltaTime\n * @param {number} prevVelocity\n * @return {number}\n */\nexport function calcVelocity(deltaV, deltaTime, prevVelocity) {\n  if (deltaTime < 1) {\n    deltaTime = 1;\n  }\n\n  // Calculate speed and speed depreciation.\n  const speed = deltaV / deltaTime;\n\n  // Depreciation is simply an informational quality. It basically means:\n  // we can't ignore the velocity we knew recently, but we'd only consider\n  // it proportionally to how long ago we've seen it. Currently, this\n  // depreciation factor is 1/100 of a millisecond. New average velocity is\n  // calculated by weighing toward the new velocity and away from old\n  // velocity based on the depreciation.\n  const depr = 0.5 + Math.min(deltaTime / VELOCITY_DEPR_FACTOR_, 0.5);\n  return speed * depr + prevVelocity * (1 - depr);\n}\n\n/**\n * Returns a motion process that will yield when the velocity has run down to\n * zerp. For each iteration, the velocity is depreciated and the coordinates\n * are advanced from start X/Y to the destination according to velocity\n * vectors. For each such iteration the callback is called with the new x and y.\n * @param {!Node} contextNode\n * @param {number} startX Start X coordinate.\n * @param {number} startY Start Y coordinate.\n * @param {number} veloX Starting X velocity.\n * @param {number} veloY Starting Y velocity.\n * @param {function(number, number):boolean} callback The callback for each\n *   step of the deceleration motion.\n * @param {!./service/vsync-impl.Vsync=} opt_vsync Mostly for testing only.\n * @return {!Motion}\n */\nexport function continueMotion(\n  contextNode,\n  startX,\n  startY,\n  veloX,\n  veloY,\n  callback,\n  opt_vsync\n) {\n  return new Motion(\n    contextNode,\n    startX,\n    startY,\n    veloX,\n    veloY,\n    callback,\n    opt_vsync\n  ).start();\n}\n\n/**\n * Motion process that allows tracking and monitoring of the running motion.\n * Most importantly it exposes methods \"then\" and \"thenAlways\" that have the\n * semantics of a Promise and signal when the motion has completed or failed.\n * Additionally, it exposes the method \"halt\" which allows to stop/reset the\n * motion.\n * @implements {IThenable}\n */\nexport class Motion {\n  /**\n   * @param {!Node} contextNode Context node.\n   * @param {number} startX Start X coordinate.\n   * @param {number} startY Start Y coordinate.\n   * @param {number} veloX Starting X velocity.\n   * @param {number} veloY Starting Y velocity.\n   * @param {function(number, number):boolean} callback The callback for each\n   *   step of the deceleration motion.\n   * @param {!./service/vsync-impl.Vsync=} opt_vsync\n   */\n  constructor(contextNode, startX, startY, veloX, veloY, callback, opt_vsync) {\n    /** @private @const {!./service/vsync-impl.Vsync} */\n    this.vsync_ = opt_vsync || Services.vsyncFor(self);\n\n    /** @private @const {!Node} */\n    this.contextNode_ = contextNode;\n\n    /** @private @const */\n    this.callback_ = callback;\n\n    /** @private {number} */\n    this.lastX_ = startX;\n\n    /** @private {number} */\n    this.lastY_ = startY;\n\n    /** @private {number} */\n    this.maxVelocityX_ = veloX;\n\n    /** @private {number} */\n    this.maxVelocityY_ = veloY;\n\n    /** @private {number} */\n    this.velocityX_ = 0;\n\n    /** @private {number} */\n    this.velocityY_ = 0;\n\n    const deferred = new Deferred();\n\n    /** @private {!Promise} */\n    this.promise_ = deferred.promise;\n\n    /** @private {!Function} */\n    this.resolve_ = deferred.resolve;\n\n    /** @private {!Function} */\n    this.reject_ = deferred.reject;\n\n    /** @private {boolean} */\n    this.continuing_ = false;\n  }\n\n  /** */\n  start() {\n    this.continuing_ = true;\n    if (\n      Math.abs(this.maxVelocityX_) <= MIN_VELOCITY_ &&\n      Math.abs(this.maxVelocityY_) <= MIN_VELOCITY_\n    ) {\n      this.fireMove_();\n      this.completeContinue_(true);\n    } else {\n      this.runContinuing_();\n    }\n    return this;\n  }\n\n  /**\n   * Halts the motion. The motion promise will be rejected since the motion\n   * has been interrupted.\n   */\n  halt() {\n    if (this.continuing_) {\n      this.completeContinue_(false);\n    }\n  }\n\n  /**\n   * Chains to the motion's promise that will resolve when the motion has\n   * completed or will reject if motion has failed or was interrupted.\n   * @override\n   */\n  then(opt_resolve, opt_reject) {\n    if (!opt_resolve && !opt_reject) {\n      return this.promise_;\n    }\n    return this.promise_.then(opt_resolve, opt_reject);\n  }\n\n  /**\n   * Callback for regardless whether the motion succeeds or fails.\n   * @param {function()=} opt_callback\n   * @return {!Promise}\n   */\n  thenAlways(opt_callback) {\n    const callback = opt_callback || NOOP_CALLBACK_;\n    return /** @type {!Promise} */ (this.then(callback, callback));\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  runContinuing_() {\n    this.velocityX_ = this.maxVelocityX_;\n    this.velocityY_ = this.maxVelocityY_;\n    const boundStep = this.stepContinue_.bind(this);\n    const boundComplete = this.completeContinue_.bind(this, true);\n    return this.vsync_\n      .runAnimMutateSeries(this.contextNode_, boundStep, 5000)\n      .then(boundComplete, boundComplete);\n  }\n\n  /**\n   * Returns \"true\" to continue and \"false\" to stop motion process.\n   * @param {time} timeSinceStart\n   * @param {time} timeSincePrev\n   * @return {boolean}\n   * @private\n   */\n  stepContinue_(timeSinceStart, timeSincePrev) {\n    if (!this.continuing_) {\n      return false;\n    }\n\n    this.lastX_ += timeSincePrev * this.velocityX_;\n    this.lastY_ += timeSincePrev * this.velocityY_;\n    if (!this.fireMove_()) {\n      return false;\n    }\n\n    const decel = Math.exp(-timeSinceStart / EXP_FRAME_CONST_);\n    this.velocityX_ = this.maxVelocityX_ * decel;\n    this.velocityY_ = this.maxVelocityY_ * decel;\n    return (\n      Math.abs(this.velocityX_) > MIN_VELOCITY_ ||\n      Math.abs(this.velocityY_) > MIN_VELOCITY_\n    );\n  }\n\n  /**\n   * @param {boolean} success\n   * @private\n   */\n  completeContinue_(success) {\n    if (!this.continuing_) {\n      return;\n    }\n    this.continuing_ = false;\n    this.fireMove_();\n    if (success) {\n      this.resolve_();\n    } else {\n      this.reject_();\n    }\n  }\n\n  /** @private */\n  fireMove_() {\n    return this.callback_(this.lastX_, this.lastY_);\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {GestureRecognizer} from './gesture';\nimport {calcVelocity} from './motion';\n\nconst DOUBLETAP_DELAY = 200;\n\n/**\n * A \"tap\" gesture.\n * @typedef {{\n *   clientX: number,\n *   clientY: number\n * }}\n */\nexport let TapDef;\n\n/**\n * Recognizes \"tap\" gestures.\n * @extends {GestureRecognizer<TapDef>}\n */\nexport class TapRecognizer extends GestureRecognizer {\n  /**\n   * @param {!./gesture.Gestures} manager\n   */\n  constructor(manager) {\n    super('tap', manager);\n\n    /** @private {number} */\n    this.startX_ = 0;\n\n    /** @private {number} */\n    this.startY_ = 0;\n\n    /** @private {number} */\n    this.lastX_ = 0;\n\n    /** @private {number} */\n    this.lastY_ = 0;\n\n    /** @private {?EventTarget} */\n    this.target_ = null;\n  }\n\n  /** @override */\n  onTouchStart(e) {\n    const {touches} = e;\n    this.target_ = e.target;\n    if (touches && touches.length == 1) {\n      this.startX_ = touches[0].clientX;\n      this.startY_ = touches[0].clientY;\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /** @override */\n  onTouchMove(e) {\n    const touches = e.changedTouches || e.touches;\n    if (touches && touches.length == 1) {\n      this.lastX_ = touches[0].clientX;\n      this.lastY_ = touches[0].clientY;\n      const dx = Math.abs(this.lastX_ - this.startX_) >= 8;\n      const dy = Math.abs(this.lastY_ - this.startY_) >= 8;\n      if (dx || dy) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  /** @override */\n  onTouchEnd(unusedE) {\n    this.signalReady(0);\n  }\n\n  /** @override */\n  acceptStart() {\n    this.signalEmit(\n      {\n        clientX: this.lastX_,\n        clientY: this.lastY_,\n        target: this.target_,\n      },\n      null\n    );\n    this.signalEnd();\n  }\n}\n\n/**\n * A \"doubletap\" gesture.\n * @typedef {{\n *   clientX: number,\n *   clientY: number\n * }}\n */\nexport let DoubletapDef;\n\n/**\n * Recognizes a \"doubletap\" gesture. This gesture will block a single \"tap\"\n * for about 200ms while it's expecting the second \"tap\".\n * @extends {GestureRecognizer<DoubletapDef>}\n */\nexport class DoubletapRecognizer extends GestureRecognizer {\n  /**\n   * @param {!./gesture.Gestures} manager\n   */\n  constructor(manager) {\n    super('doubletap', manager);\n\n    /** @private {number} */\n    this.startX_ = 0;\n\n    /** @private {number} */\n    this.startY_ = 0;\n\n    /** @private {number} */\n    this.lastX_ = 0;\n\n    /** @private {number} */\n    this.lastY_ = 0;\n\n    /** @private {number} */\n    this.tapCount_ = 0;\n\n    /** @private {?Event} */\n    this.event_ = null;\n  }\n\n  /** @override */\n  onTouchStart(e) {\n    if (this.tapCount_ > 1) {\n      return false;\n    }\n    const {touches} = e;\n    if (touches && touches.length == 1) {\n      this.startX_ = touches[0].clientX;\n      this.startY_ = touches[0].clientY;\n      this.lastX_ = touches[0].clientX;\n      this.lastY_ = touches[0].clientY;\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /** @override */\n  onTouchMove(e) {\n    const {touches} = e;\n    if (touches && touches.length == 1) {\n      this.lastX_ = touches[0].clientX;\n      this.lastY_ = touches[0].clientY;\n      const dx = Math.abs(this.lastX_ - this.startX_) >= 8;\n      const dy = Math.abs(this.lastY_ - this.startY_) >= 8;\n      if (dx || dy) {\n        this.acceptCancel();\n        return false;\n      }\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /** @override */\n  onTouchEnd(e) {\n    this.tapCount_++;\n    if (this.tapCount_ < 2) {\n      this.signalPending(DOUBLETAP_DELAY);\n    } else {\n      this.event_ = e;\n      this.signalReady(0);\n    }\n  }\n\n  /** @override */\n  acceptStart() {\n    this.tapCount_ = 0;\n    this.signalEmit({clientX: this.lastX_, clientY: this.lastY_}, this.event_);\n    this.signalEnd();\n  }\n\n  /** @override */\n  acceptCancel() {\n    this.tapCount_ = 0;\n  }\n}\n\n/**\n * A \"swipe-xy\", \"swipe-x\" or \"swipe-y\" gesture. A number of these gestures\n * may be emitted for a single touch series.\n * @typedef {{\n *   first: boolean,\n *   last: boolean,\n *   deltaX: number,\n *   deltaY: number,\n *   velocityX: number,\n *   velocityY: number\n * }}\n */\nexport let SwipeDef;\n\n/**\n * Recognizes swipe gestures. This gesture will yield about 10ms to other\n * gestures.\n * @extends {GestureRecognizer<SwipeDef>}\n */\nclass SwipeRecognizer extends GestureRecognizer {\n  /**\n   * @param {string} type\n   * @param {!./gesture.Gestures} manager\n   * @param {boolean} horiz\n   * @param {boolean} vert\n   */\n  constructor(type, manager, horiz, vert) {\n    super(type, manager);\n\n    /** @private {boolean} */\n    this.horiz_ = horiz;\n\n    /** @private {boolean} */\n    this.vert_ = vert;\n\n    /** @private {boolean} */\n    this.eventing_ = false;\n\n    /** @private {number} */\n    this.startX_ = 0;\n\n    /** @private {number} */\n    this.startY_ = 0;\n\n    /** @private {number} */\n    this.lastX_ = 0;\n\n    /** @private {number} */\n    this.lastY_ = 0;\n\n    /** @private {number} */\n    this.prevX_ = 0;\n\n    /** @private {number} */\n    this.prevY_ = 0;\n\n    /** @private {time} */\n    this.startTime_ = 0;\n\n    /** @private {time} */\n    this.lastTime_ = 0;\n\n    /** @private {time} */\n    this.prevTime_ = 0;\n\n    /** @private {number} */\n    this.velocityX_ = 0;\n\n    /** @private {number} */\n    this.velocityY_ = 0;\n  }\n\n  /** @override */\n  onTouchStart(e) {\n    const {touches} = e;\n    // If already eventing, ignore additional touches\n    if (this.eventing_ && touches && touches.length > 1) {\n      return true;\n    }\n    if (touches && touches.length == 1) {\n      this.startTime_ = Date.now();\n      this.startX_ = touches[0].clientX;\n      this.startY_ = touches[0].clientY;\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /** @override */\n  onTouchMove(e) {\n    const {touches} = e;\n    if (touches && touches.length >= 1) {\n      const {clientX: x, clientY: y} = touches[0];\n      this.lastX_ = x;\n      this.lastY_ = y;\n      if (this.eventing_) {\n        // If already eventing, always emit new coordinates\n        this.emit_(false, false, e);\n      } else {\n        // Figure out whether or not we should start eventing\n        const dx = Math.abs(x - this.startX_);\n        const dy = Math.abs(y - this.startY_);\n        // Swipe is penalized slightly since it's one of the least demanding\n        // gesture, thus -10 in signalReady.\n        if (this.horiz_ && this.vert_) {\n          if (dx >= 8 || dy >= 8) {\n            this.signalReady(-10);\n          }\n        } else if (this.horiz_) {\n          if (dx >= 8 && dx > dy) {\n            this.signalReady(-10);\n          } else if (dy >= 8) {\n            return false;\n          }\n        } else if (this.vert_) {\n          if (dy >= 8 && dy > dx) {\n            this.signalReady(-10);\n          } else if (dx >= 8) {\n            return false;\n          }\n        } else {\n          return false;\n        }\n      }\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /** @override */\n  onTouchEnd(e) {\n    const {touches} = e;\n    // Number of current touches on the page\n    if (touches && touches.length == 0) {\n      this.end_(e);\n    }\n  }\n\n  /** @override */\n  acceptStart() {\n    this.eventing_ = true;\n    // Reset start coordinates to where the gesture began to avoid visible\n    // jump, but preserve them as \"prev\" coordinates to calculate the right\n    // velocity.\n    this.prevX_ = this.startX_;\n    this.prevY_ = this.startY_;\n    this.prevTime_ = this.startTime_;\n    this.startX_ = this.lastX_;\n    this.startY_ = this.lastY_;\n    this.emit_(true, false, null);\n  }\n\n  /** @override */\n  acceptCancel() {\n    this.eventing_ = false;\n  }\n\n  /**\n   * @param {boolean} first\n   * @param {boolean} last\n   * @param {?Event} event\n   * @private\n   */\n  emit_(first, last, event) {\n    this.lastTime_ = Date.now();\n    const deltaTime = this.lastTime_ - this.prevTime_;\n    // It's often that `touchend` arrives on the next frame. These should\n    // be ignored to avoid a significant velocity downgrade.\n    if ((!last && deltaTime > 4) || (last && deltaTime > 16)) {\n      const velocityX = calcVelocity(\n        this.lastX_ - this.prevX_,\n        deltaTime,\n        this.velocityX_\n      );\n      const velocityY = calcVelocity(\n        this.lastY_ - this.prevY_,\n        deltaTime,\n        this.velocityY_\n      );\n\n      // On iOS, the touchend will always have the same x/y position as the\n      // last touchmove, so we want to make sure we do not remove the velocity.\n      // The touchend event with zero velocity can occur within a couple of\n      // frames of the last touchmove.\n      if (!last || deltaTime > 32 || velocityX != 0 || velocityY != 0) {\n        this.velocityX_ = Math.abs(velocityX) > 1e-4 ? velocityX : 0;\n        this.velocityY_ = Math.abs(velocityY) > 1e-4 ? velocityY : 0;\n      }\n\n      this.prevX_ = this.lastX_;\n      this.prevY_ = this.lastY_;\n      this.prevTime_ = this.lastTime_;\n    }\n\n    this.signalEmit(\n      {\n        first,\n        last,\n        time: this.lastTime_,\n        deltaX: this.lastX_ - this.startX_,\n        deltaY: this.lastY_ - this.startY_,\n        startX: this.startX_,\n        startY: this.startY_,\n        lastX: this.lastX_,\n        lastY: this.lastY_,\n        velocityX: this.velocityX_,\n        velocityY: this.velocityY_,\n      },\n      event\n    );\n  }\n\n  /**\n   * @param {?Event} event\n   * @private\n   */\n  end_(event) {\n    if (this.eventing_) {\n      this.eventing_ = false;\n      this.emit_(false, true, event);\n      this.signalEnd();\n    }\n  }\n}\n\n/**\n * Recognizes \"swipe-xy\" gesture. Yields about 10ms to other gestures.\n */\nexport class SwipeXYRecognizer extends SwipeRecognizer {\n  /**\n   * @param {!./gesture.Gestures} manager\n   */\n  constructor(manager) {\n    super('swipe-xy', manager, true, true);\n  }\n}\n\n/**\n * Recognizes \"swipe-x\" gesture. Yields about 10ms to other gestures.\n */\nexport class SwipeXRecognizer extends SwipeRecognizer {\n  /**\n   * @param {!./gesture.Gestures} manager\n   */\n  constructor(manager) {\n    super('swipe-x', manager, true, false);\n  }\n}\n\n/**\n * Recognizes \"swipe-y\" gesture. Yields about 10ms to other gestures.\n */\nexport class SwipeYRecognizer extends SwipeRecognizer {\n  /**\n   * @param {!./gesture.Gestures} manager\n   */\n  constructor(manager) {\n    super('swipe-y', manager, false, true);\n  }\n}\n\n/**\n * A \"tapzoom\" gesture. It has a center, delta off the center center and\n * the velocity of moving away from the center.\n * @typedef {{\n *   first: boolean,\n *   last: boolean,\n *   centerClientX: number,\n *   centerClientY: number,\n *   deltaX: number,\n *   deltaY: number,\n *   velocityX: number,\n *   velocityY: number\n * }}\n */\nlet TapzoomDef;\n\n/**\n * Recognizes a \"tapzoom\" gesture. This gesture will block other gestures\n * for about 400ms after first \"tap\" while it's expecting swipe.\n * @extends {GestureRecognizer<TapzoomDef>}\n */\nexport class TapzoomRecognizer extends GestureRecognizer {\n  /**\n   * @param {!./gesture.Gestures} manager\n   */\n  constructor(manager) {\n    super('tapzoom', manager);\n\n    /** @private {boolean} */\n    this.eventing_ = false;\n\n    /** @private {number} */\n    this.startX_ = 0;\n\n    /** @private {number} */\n    this.startY_ = 0;\n\n    /** @private {number} */\n    this.lastX_ = 0;\n\n    /** @private {number} */\n    this.lastY_ = 0;\n\n    /** @private {number} */\n    this.tapCount_ = 0;\n\n    /** @private {number} */\n    this.prevX_ = 0;\n\n    /** @private {number} */\n    this.prevY_ = 0;\n\n    /** @private {time} */\n    this.lastTime_ = 0;\n\n    /** @private {time} */\n    this.prevTime_ = 0;\n\n    /** @private {number} */\n    this.velocityX_ = 0;\n\n    /** @private {number} */\n    this.velocityY_ = 0;\n  }\n\n  /** @override */\n  onTouchStart(e) {\n    if (this.eventing_) {\n      return false;\n    }\n    const {touches} = e;\n    if (touches && touches.length == 1) {\n      this.startX_ = touches[0].clientX;\n      this.startY_ = touches[0].clientY;\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /** @override */\n  onTouchMove(e) {\n    const {touches} = e;\n    if (touches && touches.length == 1) {\n      this.lastX_ = touches[0].clientX;\n      this.lastY_ = touches[0].clientY;\n      if (this.eventing_) {\n        this.emit_(false, false, e);\n      } else {\n        const dx = Math.abs(this.lastX_ - this.startX_) >= 8;\n        const dy = Math.abs(this.lastY_ - this.startY_) >= 8;\n        if (dx || dy) {\n          if (this.tapCount_ == 0) {\n            this.acceptCancel();\n            return false;\n          } else {\n            this.signalReady(0);\n          }\n        }\n      }\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /** @override */\n  onTouchEnd(e) {\n    if (this.eventing_) {\n      this.end_(e);\n      return;\n    }\n\n    this.tapCount_++;\n    if (this.tapCount_ == 1) {\n      this.signalPending(400);\n      return;\n    }\n\n    this.acceptCancel();\n  }\n\n  /** @override */\n  acceptStart() {\n    this.tapCount_ = 0;\n    this.eventing_ = true;\n    this.emit_(true, false, null);\n  }\n\n  /** @override */\n  acceptCancel() {\n    this.tapCount_ = 0;\n    this.eventing_ = false;\n  }\n\n  /**\n   * @param {boolean} first\n   * @param {boolean} last\n   * @param {?Event} event\n   * @private\n   */\n  emit_(first, last, event) {\n    this.lastTime_ = Date.now();\n    if (first) {\n      this.velocityX_ = this.velocityY_ = 0;\n    } else if (this.lastTime_ - this.prevTime_ > 2) {\n      this.velocityX_ = calcVelocity(\n        this.lastX_ - this.prevX_,\n        this.lastTime_ - this.prevTime_,\n        this.velocityX_\n      );\n      this.velocityY_ = calcVelocity(\n        this.lastY_ - this.prevY_,\n        this.lastTime_ - this.prevTime_,\n        this.velocityY_\n      );\n    }\n    this.prevX_ = this.lastX_;\n    this.prevY_ = this.lastY_;\n    this.prevTime_ = this.lastTime_;\n\n    this.signalEmit(\n      {\n        first,\n        last,\n        centerClientX: this.startX_,\n        centerClientY: this.startY_,\n        deltaX: this.lastX_ - this.startX_,\n        deltaY: this.lastY_ - this.startY_,\n        velocityX: this.velocityX_,\n        velocityY: this.velocityY_,\n      },\n      event\n    );\n  }\n\n  /**\n   * @param {?Event} event\n   * @private\n   */\n  end_(event) {\n    if (this.eventing_) {\n      this.eventing_ = false;\n      this.emit_(false, true, event);\n      this.signalEnd();\n    }\n  }\n}\n\n/**\n * A \"pinch\" gesture. It has a center, delta off the center center and\n * the velocity of moving away from the center. \"dir\" component of `1`\n * indicates that it's a expand motion and `-1` indicates pinch motion.\n * @typedef {{\n *   first: boolean,\n *   last: boolean,\n *   centerClientX: number,\n *   centerClientY: number,\n *   dir: number,\n *   deltaX: number,\n *   deltaY: number,\n *   velocityX: number,\n *   velocityY: number\n * }}\n */\nexport let PinchDef;\n\n/**\n * Threshold in pixels for how much two touches move away from\n * each other before we recognize the gesture as a pinch.\n */\nconst PINCH_ACCEPT_THRESHOLD = 4;\n\n/**\n * Threshold in pixels for how much two touches move in the same\n * direction before we reject the gesture as a pinch.\n */\nconst PINCH_REJECT_THRESHOLD = 10;\n\n/**\n * Recognizes a \"pinch\" gesture.\n * @extends {GestureRecognizer<PinchDef>}\n */\nexport class PinchRecognizer extends GestureRecognizer {\n  /**\n   * @param {!./gesture.Gestures} manager\n   */\n  constructor(manager) {\n    super('pinch', manager);\n\n    /** @private {boolean} */\n    this.eventing_ = false;\n\n    /** @private {number} */\n    this.startX1_ = 0;\n    /** @private {number} */\n    this.startY1_ = 0;\n\n    /** @private {number} */\n    this.startX2_ = 0;\n    /** @private {number} */\n    this.startY2_ = 0;\n\n    /** @private {number} */\n    this.lastX1_ = 0;\n    /** @private {number} */\n    this.lastY1_ = 0;\n\n    /** @private {number} */\n    this.lastX2_ = 0;\n    /** @private {number} */\n    this.lastY2_ = 0;\n\n    /** @private {number} */\n    this.prevDeltaX_ = 0;\n    /** @private {number} */\n    this.prevDeltaY_ = 0;\n\n    /** @private {number} */\n    this.centerClientX_ = 0;\n    /** @private {number} */\n    this.centerClientY_ = 0;\n\n    /** @private {time} */\n    this.startTime_ = 0;\n    /** @private {time} */\n    this.lastTime_ = 0;\n    /** @private {time} */\n    this.prevTime_ = 0;\n\n    /** @private {number} */\n    this.velocityX_ = 0;\n    /** @private {number} */\n    this.velocityY_ = 0;\n  }\n\n  /** @override */\n  onTouchStart(e) {\n    const {touches} = e;\n    if (!touches) {\n      return false;\n    }\n    // Pinch touches are not always simultaneous, continue to listen\n    // for second touch.\n    if (touches.length == 1) {\n      return true;\n    }\n    // If already in the middle of a pinch event, ignore additional touches.\n    if (this.eventing_ && touches.length > 2) {\n      return true;\n    }\n    if (touches.length == 2) {\n      this.startTime_ = Date.now();\n      this.startX1_ = touches[0].clientX;\n      this.startY1_ = touches[0].clientY;\n      this.startX2_ = touches[1].clientX;\n      this.startY2_ = touches[1].clientY;\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /** @override */\n  onTouchMove(e) {\n    const {touches} = e;\n    if (!touches || touches.length == 0) {\n      return false;\n    }\n    // Pinch touches are not always simultaneous, continue to listen\n    // for second touch.\n    if (touches.length == 1) {\n      return true;\n    }\n\n    // Have 2+ touches\n    this.lastX1_ = touches[0].clientX;\n    this.lastY1_ = touches[0].clientY;\n    this.lastX2_ = touches[1].clientX;\n    this.lastY2_ = touches[1].clientY;\n\n    // If eventing, always emit gesture with new coordinates\n    if (this.eventing_) {\n      this.emit_(false, false, e);\n      return true;\n    }\n\n    // Gesture is 2+ touch but direction indicates not a pinch\n    if (this.isPinchRejected_()) {\n      return false;\n    }\n\n    if (this.isPinchReady_()) {\n      this.signalReady(0);\n    }\n    // Pinch gesture detected but threshold not reached, continue listening\n    return true;\n  }\n\n  /**\n   * @return {boolean}\n   * @private\n   */\n  isPinchReady_() {\n    const dx1 = this.lastX1_ - this.startX1_;\n    const dy1 = this.lastY1_ - this.startY1_;\n    const dx2 = this.lastX2_ - this.startX2_;\n    const dy2 = this.lastY2_ - this.startY2_;\n\n    const pinchDirectionCorrect = dx1 * dx2 <= 0 && dy1 * dy2 <= 0;\n    const xPinchRecognized = Math.abs(dx1 - dx2) >= PINCH_ACCEPT_THRESHOLD;\n    const yPinchRecognized = Math.abs(dy1 - dy2) >= PINCH_ACCEPT_THRESHOLD;\n    return pinchDirectionCorrect && (xPinchRecognized || yPinchRecognized);\n  }\n\n  /**\n   * @return {boolean}\n   * @private\n   */\n  isPinchRejected_() {\n    const dx1 = this.lastX1_ - this.startX1_;\n    const dy1 = this.lastY1_ - this.startY1_;\n    const dx2 = this.lastX2_ - this.startX2_;\n    const dy2 = this.lastY2_ - this.startY2_;\n\n    const pinchDirectionIncorrect = dx1 * dx2 > 0 || dy1 * dy2 > 0;\n    const xPinchRejected = Math.abs(dx1 + dx2) >= PINCH_REJECT_THRESHOLD;\n    const yPinchRejected = Math.abs(dy1 + dy2) >= PINCH_REJECT_THRESHOLD;\n    return pinchDirectionIncorrect && (xPinchRejected || yPinchRejected);\n  }\n\n  /** @override */\n  onTouchEnd(e) {\n    // Pinch requires at least two touches on the page\n    const {touches} = e;\n    if (touches && touches.length < 2) {\n      this.end_(e);\n    }\n  }\n\n  /** @override */\n  acceptStart() {\n    this.eventing_ = true;\n    this.prevTime_ = this.startTime_;\n    this.prevDeltaX_ = 0;\n    this.prevDeltaY_ = 0;\n    this.centerClientX_ = (this.startX1_ + this.startX2_) * 0.5;\n    this.centerClientY_ = (this.startY1_ + this.startY2_) * 0.5;\n    this.emit_(true, false, null);\n  }\n\n  /** @override */\n  acceptCancel() {\n    this.eventing_ = false;\n  }\n\n  /**\n   * @param {boolean} first\n   * @param {boolean} last\n   * @param {?Event} event\n   * @private\n   */\n  emit_(first, last, event) {\n    this.lastTime_ = Date.now();\n    const deltaTime = this.lastTime_ - this.prevTime_;\n    const deltaX = this.deltaX_();\n    const deltaY = this.deltaY_();\n    // It's often that `touchend` arrives on the next frame. These should\n    // be ignored to avoid a significant velocity downgrade.\n    if ((!last && deltaTime > 4) || (last && deltaTime > 16)) {\n      this.velocityX_ = calcVelocity(\n        deltaX - this.prevDeltaX_,\n        deltaTime,\n        this.velocityX_\n      );\n      this.velocityY_ = calcVelocity(\n        deltaY - this.prevDeltaY_,\n        deltaTime,\n        this.velocityY_\n      );\n      this.velocityX_ = Math.abs(this.velocityX_) > 1e-4 ? this.velocityX_ : 0;\n      this.velocityY_ = Math.abs(this.velocityY_) > 1e-4 ? this.velocityY_ : 0;\n      this.prevDeltaX_ = deltaX;\n      this.prevDeltaY_ = deltaY;\n      this.prevTime_ = this.lastTime_;\n    }\n\n    const startSq = this.sqDist_(\n      this.startX1_,\n      this.startX2_,\n      this.startY1_,\n      this.startY2_\n    );\n    const lastSq = this.sqDist_(\n      this.lastX1_,\n      this.lastX2_,\n      this.lastY1_,\n      this.lastY2_\n    );\n    this.signalEmit(\n      {\n        first,\n        last,\n        time: this.lastTime_,\n        centerClientX: this.centerClientX_,\n        centerClientY: this.centerClientY_,\n        dir: Math.sign(lastSq - startSq),\n        deltaX: deltaX * 0.5,\n        deltaY: deltaY * 0.5,\n        velocityX: this.velocityX_ * 0.5,\n        velocityY: this.velocityY_ * 0.5,\n      },\n      event\n    );\n  }\n\n  /**\n   * @param {?Event} event\n   * @private\n   */\n  end_(event) {\n    if (this.eventing_) {\n      this.eventing_ = false;\n      this.emit_(false, true, event);\n      this.signalEnd();\n    }\n  }\n\n  /**\n   * @param {number} x1\n   * @param {number} x2\n   * @param {number} y1\n   * @param {number} y2\n   * @return {number}\n   * @private\n   */\n  sqDist_(x1, x2, y1, y2) {\n    return (x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2);\n  }\n\n  /**\n   * @return {number}\n   * @private\n   */\n  deltaX_() {\n    return Math.abs(\n      this.lastX1_ - this.startX1_ - (this.lastX2_ - this.startX2_)\n    );\n  }\n\n  /**\n   * @return {number}\n   * @private\n   */\n  deltaY_() {\n    return Math.abs(\n      this.lastY1_ - this.startY1_ - (this.lastY2_ - this.startY2_)\n    );\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as ampToolboxCacheUrl from '@ampproject/toolbox-cache-url';\nimport {AmpStoryPlayerViewportObserver} from './amp-story-player-viewport-observer';\nimport {Deferred} from '../core/data-structures/promise';\nimport {Messaging} from '@ampproject/viewer-messaging';\nimport {PageScroller} from './page-scroller';\nimport {VisibilityState} from '../core/constants/visibility-state';\nimport {\n  addParamsToUrl,\n  getFragment,\n  isProxyOrigin,\n  parseUrlWithA,\n  removeFragment,\n  removeSearch,\n  serializeQueryString,\n} from '../url';\nimport {applySandbox} from '../3p-frame';\nimport {createCustomEvent, listenOnce} from '../event-helper';\nimport {dict} from '../core/types/object';\nimport {isJsonScriptTag, tryFocus} from '../dom';\nimport {parseQueryString} from '../core/types/string/url';\n// Source for this constant is css/amp-story-player-iframe.css\nimport {cssText} from '../../build/amp-story-player-iframe.css';\nimport {devAssertElement} from '../core/assert';\nimport {findIndex, toArray} from '../core/types/array';\nimport {getMode} from '../../src/mode';\nimport {parseJson} from '../core/types/object/json';\nimport {resetStyles, setStyle, setStyles} from '../style';\nimport {urls} from '../config';\n\n/** @enum {string} */\nconst LoadStateClass = {\n  LOADING: 'i-amphtml-story-player-loading',\n  LOADED: 'i-amphtml-story-player-loaded',\n  ERROR: 'i-amphtml-story-player-error',\n};\n\n/** @enum {number} */\nconst StoryPosition = {\n  PREVIOUS: -1,\n  CURRENT: 0,\n  NEXT: 1,\n};\n\n/** @const @type {!Array<string>} */\nconst SUPPORTED_CACHES = ['cdn.ampproject.org', 'www.bing-amp.com'];\n\n/** @const @type {!Array<string>} */\nconst SANDBOX_MIN_LIST = ['allow-top-navigation'];\n\n/** @enum {number} */\nconst SwipingState = {\n  NOT_SWIPING: 0,\n  SWIPING_TO_LEFT: 1,\n  SWIPING_TO_RIGHT: 2,\n};\n\n/** @const {number} */\nconst TOGGLE_THRESHOLD_PX = 50;\n\n/**\n * Fetches more stories when reaching the threshold.\n * @const {number}\n */\nconst FETCH_STORIES_THRESHOLD = 2;\n\n/** @enum {string} */\nconst DEPRECATED_BUTTON_TYPES = {\n  BACK: 'back-button',\n  CLOSE: 'close-button',\n};\n\n/** @enum {string} */\nconst DEPRECATED_BUTTON_CLASSES = {\n  BASE: 'amp-story-player-exit-control-button',\n  HIDDEN: 'amp-story-player-hide-button',\n  [DEPRECATED_BUTTON_TYPES.BACK]: 'amp-story-player-back-button',\n  [DEPRECATED_BUTTON_TYPES.CLOSE]: 'amp-story-player-close-button',\n};\n\n/** @enum {string} */\nconst DEPRECATED_EVENT_NAMES = {\n  [DEPRECATED_BUTTON_TYPES.BACK]: 'amp-story-player-back',\n  [DEPRECATED_BUTTON_TYPES.CLOSE]: 'amp-story-player-close',\n};\n\n/** @enum {string} */\nconst STORY_STATE_TYPE = {\n  PAGE_ATTACHMENT_STATE: 'page-attachment',\n};\n\n/** @enum {string} */\nconst STORY_MESSAGE_STATE_TYPE = {\n  PAGE_ATTACHMENT_STATE: 'PAGE_ATTACHMENT_STATE',\n  MUTED_STATE: 'MUTED_STATE',\n  CURRENT_PAGE_ID: 'CURRENT_PAGE_ID',\n  STORY_PROGRESS: 'STORY_PROGRESS',\n};\n\n/** @const {string} */\nexport const AMP_STORY_PLAYER_EVENT = 'AMP_STORY_PLAYER_EVENT';\n\n/** @const {string} */\nconst CLASS_NO_NAVIGATION_TRANSITION =\n  'i-amphtml-story-player-no-navigation-transition';\n\n/** @typedef {{ state:string, value:(boolean|string) }} */\nlet DocumentStateTypeDef;\n\n/**\n * @typedef {{\n *   href: string,\n *   idx: number,\n *   distance: number,\n *   iframe: ?Element,\n *   messagingPromise: ?Promise,\n *   title: (?string),\n *   posterImage: (?string),\n *   storyContentLoaded: ?boolean,\n *   connectedDeferred: !Deferred\n * }}\n */\nlet StoryDef;\n\n/**\n * @typedef {{\n *   on: ?string,\n *   action: ?string,\n *   endpoint: ?string,\n *   pageScroll: ?boolean,\n *   autoplay: ?boolean,\n * }}\n */\nlet BehaviorDef;\n\n/**\n * @typedef {{\n *   attribution: ?string,\n * }}\n */\nlet DisplayDef;\n\n/**\n * @typedef {{\n *   controls: ?Array<!ViewerControlDef>,\n *   behavior: ?BehaviorDef,\n *   display: ?DisplayDef,\n * }}\n */\nlet ConfigDef;\n\n/**\n * @typedef {{\n *   name: string,\n *   state: (?string),\n *   event: (?string),\n *   visibility: (?string),\n *   position: (?string),\n *   backgroundImageUrl: (?string)\n * }}\n */\nexport let ViewerControlDef;\n\n/** @type {string} */\nconst TAG = 'amp-story-player';\n\n/** @enum {string} */\nconst LOG_TYPE = {\n  DEV: 'amp-story-player-dev',\n};\n\n/**\n * Note that this is a vanilla JavaScript class and should not depend on AMP\n * services, as v0.js is not expected to be loaded in this context.\n */\nexport class AmpStoryPlayer {\n  /**\n   * @param {!Window} win\n   * @param {!Element} element\n   */\n  constructor(win, element) {\n    /** @private {!Window} */\n    this.win_ = win;\n\n    /** @private {!Element} */\n    this.element_ = element;\n\n    /** @private {!Document} */\n    this.doc_ = win.document;\n\n    /** @private {!Element} */\n    this.cachedA_ = this.doc_.createElement('a');\n\n    /** @private {!Array<!StoryDef>} */\n    this.stories_ = [];\n\n    /** @private {?Element} */\n    this.rootEl_ = null;\n\n    /** @private {number} */\n    this.currentIdx_ = 0;\n\n    /** @private {!SwipingState} */\n    this.swipingState_ = SwipingState.NOT_SWIPING;\n\n    /** @private {?ConfigDef} */\n    this.playerConfig_ = null;\n\n    /** @private {?boolean} */\n    this.isFetchingStoriesEnabled_ = null;\n\n    /** @private {?boolean} */\n    this.isCircularWrappingEnabled_ = null;\n\n    /** @private {!Object} */\n    this.touchEventState_ = {\n      startX: 0,\n      startY: 0,\n      lastX: 0,\n      isSwipeX: null,\n    };\n\n    /** @private {?Deferred} */\n    this.currentStoryLoadDeferred_ = null;\n\n    /** @private {!Deferred} */\n    this.visibleDeferred_ = new Deferred();\n\n    this.attachCallbacksToElement_();\n\n    /** @private {?PageScroller} */\n    this.pageScroller_ = new PageScroller(win);\n\n    /** @private {boolean} */\n    this.playing_ = true;\n\n    /** @private {?string} */\n    this.attribution_ = null;\n\n    return this.element_;\n  }\n\n  /**\n   * Attaches callbacks to the DOM element for them to be used by publishers.\n   * @private\n   */\n  attachCallbacksToElement_() {\n    this.element_.buildPlayer = this.buildPlayer.bind(this);\n    this.element_.layoutPlayer = this.layoutPlayer.bind(this);\n    this.element_.getElement = this.getElement.bind(this);\n    this.element_.getStories = this.getStories.bind(this);\n    this.element_.load = this.load.bind(this);\n    this.element_.show = this.show.bind(this);\n    this.element_.add = this.add.bind(this);\n    this.element_.play = this.play.bind(this);\n    this.element_.pause = this.pause.bind(this);\n    this.element_.go = this.go.bind(this);\n    this.element_.mute = this.mute.bind(this);\n    this.element_.unmute = this.unmute.bind(this);\n    this.element_.getStoryState = this.getStoryState.bind(this);\n    this.element_.rewind = this.rewind.bind(this);\n  }\n\n  /**\n   * External callback for manually loading the player.\n   * @public\n   */\n  load() {\n    if (!this.element_.isConnected) {\n      throw new Error(\n        `[${TAG}] element must be connected to the DOM before calling load().`\n      );\n    }\n    if (!!this.element_.isBuilt_) {\n      throw new Error(`[${TAG}] calling load() on an already loaded element.`);\n    }\n    this.buildPlayer();\n    this.layoutPlayer();\n  }\n\n  /**\n   * Initializes story with properties used in this class and adds it to the\n   * stories array.\n   * @param {!StoryDef} story\n   * @private\n   */\n  initializeAndAddStory_(story) {\n    story.idx = this.stories_.length;\n    story.distance = story.idx - this.currentIdx_;\n    story.connectedDeferred = new Deferred();\n    this.stories_.push(story);\n  }\n\n  /**\n   * Adds stories to the player. Additionally, creates or assigns\n   * iframes to those that are close to the current playing story.\n   * @param {!Array<!{href: string, title: ?string, posterImage: ?string}>} newStories\n   * @public\n   */\n  add(newStories) {\n    if (newStories.length <= 0) {\n      return;\n    }\n\n    const isStoryDef = (story) => story && story.href;\n    if (!Array.isArray(newStories) || !newStories.every(isStoryDef)) {\n      throw new Error('\"stories\" parameter has the wrong structure');\n    }\n\n    const renderStartingIdx = this.stories_.length;\n\n    for (let i = 0; i < newStories.length; i++) {\n      const story = newStories[i];\n      this.initializeAndAddStory_(story);\n      this.buildIframeFor_(story);\n    }\n\n    this.render_(renderStartingIdx);\n  }\n\n  /**\n   * Makes the current story play its content/auto-advance\n   * @public\n   */\n  play() {\n    if (!this.element_.isLaidOut_) {\n      this.layoutPlayer();\n    }\n    this.togglePaused_(false);\n  }\n\n  /**\n   * Makes the current story pause its content/auto-advance\n   * @public\n   */\n  pause() {\n    this.togglePaused_(true);\n  }\n\n  /**\n   * Makes the current story play or pause its content/auto-advance\n   * @param {boolean} paused If true, the story will be paused, and it will be played otherwise\n   * @private\n   */\n  togglePaused_(paused) {\n    this.playing_ = !paused;\n    const currentStory = this.stories_[this.currentIdx_];\n\n    this.updateVisibilityState_(\n      currentStory,\n      paused ? VisibilityState.PAUSED : VisibilityState.VISIBLE\n    );\n  }\n\n  /**\n   *\n   * @public\n   * @return {!Element}\n   */\n  getElement() {\n    return this.element_;\n  }\n\n  /**\n   * @return {!Array<!StoryDef>}\n   * @public\n   */\n  getStories() {\n    return this.stories_;\n  }\n\n  /** @public */\n  buildPlayer() {\n    if (!!this.element_.isBuilt_) {\n      return;\n    }\n\n    this.initializeAnchorElStories_();\n    this.initializeShadowRoot_();\n    this.buildStories_();\n    this.initializeButton_();\n    this.readPlayerConfig_();\n    this.maybeFetchMoreStories_(this.stories_.length - this.currentIdx_ - 1);\n    this.initializeAutoplay_();\n    this.initializeAttribution_();\n    this.initializePageScroll_();\n    this.initializeCircularWrapping_();\n    this.signalReady_();\n    this.element_.isBuilt_ = true;\n  }\n\n  /**\n   * Initializes stories declared inline as <a> elements.\n   * @private\n   */\n  initializeAnchorElStories_() {\n    const anchorEls = toArray(this.element_.querySelectorAll('a'));\n    anchorEls.forEach((element) => {\n      const posterImgEl = element.querySelector(\n        'img[data-amp-story-player-poster-img]'\n      );\n      const posterImgSrc = posterImgEl && posterImgEl.getAttribute('src');\n\n      const story = /** @type {!StoryDef} */ ({\n        href: element.href,\n        title: (element.textContent && element.textContent.trim()) || null,\n        posterImage:\n          element.getAttribute('data-poster-portrait-src') || posterImgSrc,\n      });\n\n      this.initializeAndAddStory_(story);\n    });\n  }\n\n  /** @private */\n  signalReady_() {\n    this.element_.dispatchEvent(\n      createCustomEvent(this.win_, 'ready', dict({}))\n    );\n    this.element_.isReady = true;\n  }\n\n  /** @private */\n  buildStories_() {\n    this.stories_.forEach((story) => {\n      this.buildIframeFor_(story);\n    });\n  }\n\n  /** @private */\n  initializeShadowRoot_() {\n    this.rootEl_ = this.doc_.createElement('div');\n    this.rootEl_.classList.add('i-amphtml-story-player-main-container');\n\n    const shadowContainer = this.doc_.createElement('div');\n\n    // For AMP version.\n    shadowContainer.classList.add(\n      'i-amphtml-fill-content',\n      'i-amphtml-story-player-shadow-root-intermediary'\n    );\n\n    this.element_.appendChild(shadowContainer);\n\n    const containerToUse =\n      getMode().test || !this.element_.attachShadow\n        ? shadowContainer\n        : shadowContainer.attachShadow({mode: 'open'});\n\n    // Inject default styles\n    const styleEl = this.doc_.createElement('style');\n    styleEl.textContent = cssText;\n    containerToUse.appendChild(styleEl);\n    containerToUse.insertBefore(this.rootEl_, containerToUse.firstElementChild);\n  }\n\n  /**\n   * Helper to create a button.\n   * TODO(#30031): delete this once new custom UI API is ready.\n   * @private\n   */\n  initializeButton_() {\n    const option = this.element_.getAttribute('exit-control');\n    if (!Object.values(DEPRECATED_BUTTON_TYPES).includes(option)) {\n      return;\n    }\n\n    const button = this.doc_.createElement('button');\n    this.rootEl_.appendChild(button);\n\n    button.classList.add(DEPRECATED_BUTTON_CLASSES[option]);\n    button.classList.add(DEPRECATED_BUTTON_CLASSES.BASE);\n\n    button.addEventListener('click', () => {\n      this.element_.dispatchEvent(\n        createCustomEvent(this.win_, DEPRECATED_EVENT_NAMES[option], dict({}))\n      );\n    });\n  }\n\n  /**\n   * Gets publisher configuration for the player\n   * @private\n   * @return {?ConfigDef}\n   */\n  readPlayerConfig_() {\n    if (this.playerConfig_) {\n      return this.playerConfig_;\n    }\n\n    const ampCache = this.element_.getAttribute('amp-cache');\n    if (ampCache && !SUPPORTED_CACHES.includes(ampCache)) {\n      console /*OK*/\n        .error(\n          `[${TAG}]`,\n          `Unsupported cache specified, use one of following: ${SUPPORTED_CACHES}`\n        );\n    }\n\n    const scriptTag = this.element_.querySelector('script');\n    if (!scriptTag) {\n      return null;\n    }\n\n    if (!isJsonScriptTag(scriptTag)) {\n      throw new Error('<script> child must have type=\"application/json\"');\n    }\n\n    try {\n      this.playerConfig_ = /** @type {!ConfigDef} */ (\n        parseJson(scriptTag.textContent)\n      );\n    } catch (reason) {\n      console /*OK*/\n        .error(`[${TAG}] `, reason);\n    }\n\n    return this.playerConfig_;\n  }\n\n  /**\n   * @param {!StoryDef} story\n   * @private\n   */\n  buildIframeFor_(story) {\n    const iframeEl = this.doc_.createElement('iframe');\n    if (story.posterImage) {\n      setStyle(iframeEl, 'backgroundImage', story.posterImage);\n    }\n    iframeEl.classList.add('story-player-iframe');\n    iframeEl.setAttribute('allow', 'autoplay');\n\n    applySandbox(iframeEl);\n    this.addSandboxFlags_(iframeEl);\n    this.initializeLoadingListeners_(iframeEl);\n\n    story.iframe = iframeEl;\n  }\n\n  /**\n   * @param {!Element} iframe\n   * @private\n   */\n  addSandboxFlags_(iframe) {\n    if (\n      !iframe.sandbox ||\n      !iframe.sandbox.supports ||\n      iframe.sandbox.length <= 0\n    ) {\n      return; // Can't feature detect support.\n    }\n\n    for (let i = 0; i < SANDBOX_MIN_LIST.length; i++) {\n      const flag = SANDBOX_MIN_LIST[i];\n\n      if (!iframe.sandbox.supports(flag)) {\n        throw new Error(`Iframe doesn't support: ${flag}`);\n      }\n\n      iframe.sandbox.add(flag);\n    }\n  }\n\n  /**\n   * Sets up messaging for a story inside an iframe.\n   * @param {!StoryDef} story\n   * @private\n   */\n  setUpMessagingForStory_(story) {\n    const {iframe} = story;\n\n    story.messagingPromise = new Promise((resolve) => {\n      this.initializeHandshake_(story, iframe).then(\n        (messaging) => {\n          messaging.setDefaultHandler(() => Promise.resolve());\n          messaging.registerHandler('touchstart', (event, data) => {\n            this.onTouchStart_(/** @type {!Event} */ (data));\n          });\n\n          messaging.registerHandler('touchmove', (event, data) => {\n            this.onTouchMove_(/** @type {!Event} */ (data));\n          });\n\n          messaging.registerHandler('touchend', (event, data) => {\n            this.onTouchEnd_(/** @type {!Event} */ (data));\n          });\n\n          messaging.registerHandler('selectDocument', (event, data) => {\n            this.onSelectDocument_(/** @type {!Object} */ (data));\n          });\n\n          messaging.sendRequest(\n            'onDocumentState',\n            dict({'state': STORY_MESSAGE_STATE_TYPE.PAGE_ATTACHMENT_STATE}),\n            false\n          );\n\n          messaging.sendRequest(\n            'onDocumentState',\n            dict({'state': STORY_MESSAGE_STATE_TYPE.CURRENT_PAGE_ID}),\n            false\n          );\n\n          messaging.sendRequest(\n            'onDocumentState',\n            dict({'state': STORY_MESSAGE_STATE_TYPE.MUTED_STATE})\n          );\n\n          messaging.registerHandler('documentStateUpdate', (event, data) => {\n            this.onDocumentStateUpdate_(\n              /** @type {!DocumentStateTypeDef} */ (data),\n              messaging\n            );\n          });\n\n          if (this.playerConfig_ && this.playerConfig_.controls) {\n            this.updateControlsStateForAllStories_(story.idx);\n\n            messaging.sendRequest(\n              'customDocumentUI',\n              dict({'controls': this.playerConfig_.controls}),\n              false\n            );\n          }\n\n          resolve(messaging);\n        },\n        (err) => {\n          console /*OK*/\n            .error(`[${TAG}]`, err);\n        }\n      );\n    });\n  }\n\n  /**\n   * Updates the controls config for a given story.\n   * @param {number} storyIdx\n   * @private\n   */\n  updateControlsStateForAllStories_(storyIdx) {\n    // Disables skip-to-next button when story is the last one in the player.\n    if (storyIdx === this.stories_.length - 1) {\n      const skipButtonIdx = findIndex(\n        this.playerConfig_.controls,\n        (control) =>\n          control.name === 'skip-next' || control.name === 'skip-to-next'\n      );\n\n      if (skipButtonIdx >= 0) {\n        this.playerConfig_.controls[skipButtonIdx].state = 'disabled';\n      }\n    }\n  }\n\n  /**\n   * @param {!StoryDef} story\n   * @param {!Element} iframeEl\n   * @return {!Promise<!Messaging>}\n   * @private\n   */\n  initializeHandshake_(story, iframeEl) {\n    return this.maybeGetCacheUrl_(story.href).then((url) =>\n      Messaging.waitForHandshakeFromDocument(\n        this.win_,\n        iframeEl.contentWindow,\n        this.getEncodedLocation_(url).origin,\n        /*opt_token*/ null,\n        urls.cdnProxyRegex\n      )\n    );\n  }\n\n  /**\n   * @param {!Element} iframeEl\n   * @private\n   */\n  initializeLoadingListeners_(iframeEl) {\n    this.rootEl_.classList.add(LoadStateClass.LOADING);\n\n    iframeEl.onload = () => {\n      this.rootEl_.classList.remove(LoadStateClass.LOADING);\n      this.rootEl_.classList.add(LoadStateClass.LOADED);\n      this.element_.classList.add(LoadStateClass.LOADED);\n    };\n    iframeEl.onerror = () => {\n      this.rootEl_.classList.remove(LoadStateClass.LOADING);\n      this.rootEl_.classList.add(LoadStateClass.ERROR);\n      this.element_.classList.add(LoadStateClass.ERROR);\n    };\n  }\n\n  /**\n   * @public\n   */\n  layoutPlayer() {\n    if (!!this.element_.isLaidOut_) {\n      return;\n    }\n\n    new AmpStoryPlayerViewportObserver(this.win_, this.element_, () =>\n      this.visibleDeferred_.resolve()\n    );\n\n    this.render_();\n\n    this.element_.isLaidOut_ = true;\n  }\n\n  /**\n   * Fetches more stories from the publisher's endpoint.\n   * @return {!Promise}\n   * @private\n   */\n  fetchStories_() {\n    let {endpoint} = this.playerConfig_.behavior;\n    if (!endpoint) {\n      this.isFetchingStoriesEnabled_ = false;\n      return Promise.resolve();\n    }\n\n    const init = {\n      method: 'GET',\n      headers: {\n        Accept: 'application/json',\n      },\n    };\n\n    endpoint = endpoint.replace(/\\${offset}/, this.stories_.length.toString());\n\n    return fetch(endpoint, init)\n      .then((response) => response.json())\n      .catch((reason) => {\n        console /*OK*/\n          .error(`[${TAG}]`, reason);\n      });\n  }\n\n  /**\n   * Resolves currentStoryLoadDeferred_ when given story's content is finished\n   * loading.\n   * @param {!StoryDef} story\n   * @private\n   */\n  initStoryContentLoadedPromise_(story) {\n    this.currentStoryLoadDeferred_ = new Deferred();\n\n    story.messagingPromise.then((messaging) =>\n      messaging.registerHandler('storyContentLoaded', () => {\n        // Stories that already loaded won't dispatch a `storyContentLoaded`\n        // event anymore, which is why we need this sync property.\n        story.storyContentLoaded = true;\n        this.currentStoryLoadDeferred_.resolve();\n      })\n    );\n  }\n\n  /**\n   * Shows the story provided by the URL in the player and go to the page if provided.\n   * @param {?string} storyUrl\n   * @param {string=} pageId\n   * @param {{animate: boolean?}} options\n   * @return {!Promise}\n   */\n  show(storyUrl, pageId = null, options = {}) {\n    const story = this.getStoryFromUrl_(storyUrl);\n\n    let renderPromise = Promise.resolve();\n    if (story.idx !== this.currentIdx_) {\n      this.currentIdx_ = story.idx;\n\n      renderPromise = this.render_();\n\n      if (options.animate === false) {\n        this.rootEl_.classList.toggle(CLASS_NO_NAVIGATION_TRANSITION, true);\n        listenOnce(story.iframe, 'transitionend', () => {\n          this.rootEl_.classList.remove(CLASS_NO_NAVIGATION_TRANSITION);\n        });\n      }\n      this.onNavigation_();\n    }\n\n    if (pageId != null) {\n      return renderPromise.then(() => this.goToPageId_(pageId));\n    }\n\n    return renderPromise;\n  }\n\n  /** Sends a message muting the current story. */\n  mute() {\n    const story = this.stories_[this.currentIdx_];\n    this.updateMutedState_(story, true);\n  }\n\n  /** Sends a message unmuting the current story. */\n  unmute() {\n    const story = this.stories_[this.currentIdx_];\n    this.updateMutedState_(story, false);\n  }\n\n  /**\n   * Sends a message asking for the current story's state and dispatches the appropriate event.\n   * @param {string} storyStateType\n   * @public\n   */\n  getStoryState(storyStateType) {\n    switch (storyStateType) {\n      case STORY_STATE_TYPE.PAGE_ATTACHMENT_STATE:\n        this.getPageAttachmentState_();\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * Indicates the player changed story.\n   * @param {!Object} data\n   * @private\n   */\n  signalNavigation_(data) {\n    const event = createCustomEvent(\n      this.win_,\n      'navigation',\n      /** @type {!JsonObject} */ (data)\n    );\n    this.element_.dispatchEvent(event);\n  }\n\n  /**\n   * Triggers when swithing from one story to another.\n   * @private\n   */\n  onNavigation_() {\n    const index = this.currentIdx_;\n    const remaining = this.stories_.length - this.currentIdx_ - 1;\n    const navigation = {\n      'index': index,\n      'remaining': remaining,\n    };\n\n    this.signalNavigation_(navigation);\n    this.maybeFetchMoreStories_(remaining);\n  }\n\n  /**\n   * Fetches more stories if appropiate.\n   * @param {number} remaining Number of stories remaining in the player.\n   * @private\n   */\n  maybeFetchMoreStories_(remaining) {\n    if (\n      this.playerConfig_ &&\n      this.playerConfig_.behavior &&\n      this.shouldFetchMoreStories_() &&\n      remaining <= FETCH_STORIES_THRESHOLD\n    ) {\n      this.fetchStories_()\n        .then((stories) => {\n          if (!stories) {\n            return;\n          }\n          this.add(stories);\n        })\n        .catch((reason) => {\n          console /*OK*/\n            .error(`[${TAG}]`, reason);\n        });\n    }\n  }\n\n  /**\n   * @param {!Object} behavior\n   * @return {boolean}\n   * @private\n   */\n  validateBehaviorDef_(behavior) {\n    return behavior && behavior.on && behavior.action;\n  }\n\n  /**\n   * Checks if fetching more stories is enabled and validates the configuration.\n   * @return {boolean}\n   * @private\n   */\n  shouldFetchMoreStories_() {\n    if (this.isFetchingStoriesEnabled_ !== null) {\n      return this.isFetchingStoriesEnabled_;\n    }\n\n    const {behavior} = this.playerConfig_;\n\n    const hasEndFetchBehavior = (behavior) =>\n      behavior.on === 'end' && behavior.action === 'fetch' && behavior.endpoint;\n\n    this.isFetchingStoriesEnabled_ =\n      this.validateBehaviorDef_(behavior) && hasEndFetchBehavior(behavior);\n\n    return this.isFetchingStoriesEnabled_;\n  }\n\n  /**\n   * Navigates to the next story in the player.\n   * @private\n   */\n  next_() {\n    if (\n      !this.isCircularWrappingEnabled_ &&\n      this.isIndexOutofBounds_(this.currentIdx_ + 1)\n    ) {\n      return;\n    }\n\n    if (\n      this.isCircularWrappingEnabled_ &&\n      this.isIndexOutofBounds_(this.currentIdx_ + 1)\n    ) {\n      this.go(1);\n      return;\n    }\n\n    this.currentIdx_++;\n    this.render_();\n\n    this.onNavigation_();\n  }\n\n  /**\n   * Navigates to the previous story in the player.\n   * @private\n   */\n  previous_() {\n    if (\n      !this.isCircularWrappingEnabled_ &&\n      this.isIndexOutofBounds_(this.currentIdx_ - 1)\n    ) {\n      return;\n    }\n\n    if (\n      this.isCircularWrappingEnabled_ &&\n      this.isIndexOutofBounds_(this.currentIdx_ - 1)\n    ) {\n      this.go(-1);\n      return;\n    }\n\n    this.currentIdx_--;\n    this.render_();\n\n    this.onNavigation_();\n  }\n\n  /**\n   * Navigates stories given a number.\n   * @param {number} storyDelta\n   * @param {number=} pageDelta\n   * @param {{animate: boolean?}} options\n   */\n  go(storyDelta, pageDelta = 0, options = {}) {\n    if (storyDelta === 0 && pageDelta === 0) {\n      return;\n    }\n\n    if (\n      !this.isCircularWrappingEnabled_ &&\n      this.isIndexOutofBounds_(this.currentIdx_ + storyDelta)\n    ) {\n      throw new Error('Out of Story range.');\n    }\n\n    const newStoryIdx = this.currentIdx_ + storyDelta;\n    const newStory =\n      storyDelta > 0\n        ? this.stories_[newStoryIdx % this.stories_.length]\n        : this.stories_[\n            ((newStoryIdx % this.stories_.length) + this.stories_.length) %\n              this.stories_.length\n          ];\n\n    let showPromise = Promise.resolve();\n    if (this.currentIdx_ !== newStory.idx) {\n      showPromise = this.show(newStory.href, /* pageId */ null, options);\n    }\n\n    showPromise.then(() => {\n      this.selectPage_(pageDelta);\n    });\n  }\n\n  /**\n   * Updates story position.\n   * @param {!StoryDef} story\n   * @return {!Promise}\n   * @private\n   */\n  updatePosition_(story) {\n    const position =\n      story.distance === 0\n        ? StoryPosition.CURRENT\n        : story.idx > this.currentIdx_\n        ? StoryPosition.NEXT\n        : StoryPosition.PREVIOUS;\n\n    requestAnimationFrame(() => {\n      const {iframe} = story;\n      resetStyles(iframe, ['transform', 'transition']);\n      iframe.setAttribute('i-amphtml-iframe-position', position);\n    });\n  }\n\n  /**\n   * Returns a promise that makes sure current story gets loaded first before\n   * others.\n   * @param {!StoryDef} story\n   * @return {!Promise}\n   * @private\n   */\n  currentStoryPromise_(story) {\n    if (this.stories_[this.currentIdx_].storyContentLoaded) {\n      return Promise.resolve();\n    }\n\n    if (story.distance !== 0) {\n      return this.currentStoryLoadDeferred_.promise;\n    }\n\n    if (this.currentStoryLoadDeferred_) {\n      // Cancel previous story load promise.\n      this.currentStoryLoadDeferred_.reject(\n        `[${LOG_TYPE.DEV}] Cancelling previous story load promise.`\n      );\n    }\n\n    this.initStoryContentLoadedPromise_(story);\n    return Promise.resolve();\n  }\n\n  /**\n   * - Updates distances of the stories.\n   * - Appends / removes from the DOM depending on distances.\n   * - Sets visibility state.\n   * - Loads story N+1 when N is ready.\n   * - Positions iframes depending on distance.\n   * @param {number=} startingIdx\n   * @return {!Promise}\n   * @private\n   */\n  render_(startingIdx = this.currentIdx_) {\n    const renderPromises = [];\n\n    for (let i = 0; i < this.stories_.length; i++) {\n      const story = this.stories_[(i + startingIdx) % this.stories_.length];\n\n      const oldDistance = story.distance;\n      story.distance = Math.abs(this.currentIdx_ - story.idx);\n\n      // 1. Determine whether iframe should be in DOM tree or not.\n      if (oldDistance <= 1 && story.distance > 1) {\n        this.removeFromDom_(story);\n      }\n\n      if (story.distance <= 1 && !story.iframe.isConnected) {\n        this.appendToDom_(story);\n      }\n\n      // Only create renderPromises for neighbor stories.\n      if (story.distance > 1) {\n        continue;\n      }\n\n      renderPromises.push(\n        // 1. Wait for current story to load before evaluating neighbor stories.\n        this.currentStoryPromise_(story)\n          .then(() => this.maybeGetCacheUrl_(story.href))\n          // 2. Set iframe src when appropiate\n          .then((storyUrl) => {\n            if (!this.sanitizedUrlsAreEquals_(storyUrl, story.iframe.src)) {\n              this.setSrc_(story, storyUrl);\n            }\n          })\n          // 3. Waits for player to be visible before updating visibility\n          // state.\n          .then(() => this.visibleDeferred_.promise)\n          // 4. Update the visibility state of the story.\n          .then(() => {\n            if (story.distance === 0 && this.playing_) {\n              this.updateVisibilityState_(story, VisibilityState.VISIBLE);\n            }\n\n            if (oldDistance === 0 && story.distance === 1) {\n              this.updateVisibilityState_(story, VisibilityState.INACTIVE);\n            }\n          })\n          // 5. Finally update the story position.\n          .then(() => {\n            this.updatePosition_(story);\n\n            if (story.distance === 0) {\n              tryFocus(story.iframe);\n            }\n          })\n          .catch((err) => {\n            if (err.includes(LOG_TYPE.DEV)) {\n              return;\n            }\n            console /*OK*/\n              .error(`[${TAG}]`, err);\n          })\n      );\n    }\n\n    return Promise.all(renderPromises);\n  }\n\n  /**\n   * @param {!StoryDef} story\n   * @private\n   */\n  appendToDom_(story) {\n    this.rootEl_.appendChild(story.iframe);\n    this.setUpMessagingForStory_(story);\n    story.connectedDeferred.resolve();\n  }\n\n  /**\n   * @param {!StoryDef} story\n   * @private\n   */\n  removeFromDom_(story) {\n    story.storyContentLoaded = false;\n    story.connectedDeferred = new Deferred();\n    story.iframe.setAttribute('src', '');\n    story.iframe.remove();\n  }\n\n  /**\n   * Sets the story src to the iframe.\n   * @param {!StoryDef} story\n   * @param {string} url\n   * @return {!Promise}\n   * @private\n   */\n  setSrc_(story, url) {\n    const {iframe} = story;\n    const {href} = this.getEncodedLocation_(url, VisibilityState.PRERENDER);\n\n    iframe.setAttribute('src', href);\n    if (story.title) {\n      iframe.setAttribute('title', story.title);\n    }\n  }\n\n  /**\n   * Compares href from the story with the href in the iframe.\n   * @param {string} storyHref\n   * @param {string} iframeHref\n   * @return {boolean}\n   * @private\n   */\n  sanitizedUrlsAreEquals_(storyHref, iframeHref) {\n    if (iframeHref.length <= 0) {\n      return false;\n    }\n\n    const sanitizedIframeHref = removeFragment(removeSearch(iframeHref));\n    const sanitizedStoryHref = removeFragment(removeSearch(storyHref));\n\n    return sanitizedIframeHref === sanitizedStoryHref;\n  }\n\n  /**\n   * Gets cache url, unless amp-cache is not defined.\n   * @param {string} url\n   * @return {!Promise<string>}\n   * @private\n   */\n  maybeGetCacheUrl_(url) {\n    const ampCache = this.element_.getAttribute('amp-cache');\n\n    if (\n      !ampCache ||\n      isProxyOrigin(url) ||\n      !SUPPORTED_CACHES.includes(ampCache)\n    ) {\n      return Promise.resolve(url);\n    }\n\n    return ampToolboxCacheUrl\n      .createCacheUrl(ampCache, url, 'viewer' /** servingType */)\n      .then((cacheUrl) => {\n        return cacheUrl;\n      });\n  }\n\n  /**\n   * Gets encoded url for player usage.\n   * @param {string} href\n   * @param {VisibilityState=} visibilityState\n   * @return {!Location}\n   * @private\n   */\n  getEncodedLocation_(href, visibilityState = VisibilityState.INACTIVE) {\n    const playerFragmentParams = {\n      'visibilityState': visibilityState,\n      'origin': this.win_.origin,\n      'showStoryUrlInfo': '0',\n      'storyPlayer': 'v0',\n      'cap': 'swipe',\n    };\n\n    if (this.attribution_ === 'auto') {\n      playerFragmentParams['attribution'] = 'auto';\n    }\n\n    const originalFragmentString = getFragment(href);\n    const originalFragments = parseQueryString(originalFragmentString);\n\n    const fragmentParams = /** @type {!JsonObject} */ ({\n      ...originalFragments,\n      ...playerFragmentParams,\n    });\n\n    let noFragmentUrl = removeFragment(href);\n    if (isProxyOrigin(href)) {\n      const ampJsQueryParam = dict({\n        'amp_js_v': '0.1',\n      });\n      noFragmentUrl = addParamsToUrl(noFragmentUrl, ampJsQueryParam);\n    }\n    const inputUrl = noFragmentUrl + '#' + serializeQueryString(fragmentParams);\n\n    return parseUrlWithA(\n      /** @type {!HTMLAnchorElement} */ (this.cachedA_),\n      inputUrl\n    );\n  }\n\n  /**\n   * Updates the visibility state of the story inside the iframe.\n   * @param {!StoryDef} story\n   * @param {!VisibilityState} visibilityState\n   * @private\n   */\n  updateVisibilityState_(story, visibilityState) {\n    story.messagingPromise.then((messaging) =>\n      messaging.sendRequest('visibilitychange', {state: visibilityState}, true)\n    );\n  }\n\n  /**\n   * Updates the specified iframe's story state with given value.\n   * @param {!StoryDef} story\n   * @param {string} state\n   * @param {boolean} value\n   * @private\n   */\n  updateStoryState_(story, state, value) {\n    story.messagingPromise.then((messaging) => {\n      messaging.sendRequest('setDocumentState', {state, value});\n    });\n  }\n\n  /**\n   * Update the muted state of the story inside the iframe.\n   * @param {!StoryDef} story\n   * @param {boolean} mutedValue\n   * @private\n   */\n  updateMutedState_(story, mutedValue) {\n    this.updateStoryState_(\n      story,\n      STORY_MESSAGE_STATE_TYPE.MUTED_STATE,\n      mutedValue\n    );\n  }\n\n  /**\n   * Send message to story asking for page attachment state.\n   * @private\n   */\n  getPageAttachmentState_() {\n    const story = this.stories_[this.currentIdx_];\n\n    story.messagingPromise.then((messaging) => {\n      messaging\n        .sendRequest(\n          'getDocumentState',\n          {state: STORY_MESSAGE_STATE_TYPE.PAGE_ATTACHMENT_STATE},\n          true\n        )\n        .then((event) => this.dispatchPageAttachmentEvent_(event.value));\n    });\n  }\n\n  /**\n   * @param {string} pageId\n   * @private\n   */\n  goToPageId_(pageId) {\n    const story = this.stories_[this.currentIdx_];\n\n    story.messagingPromise.then((messaging) =>\n      messaging.sendRequest('selectPage', {'id': pageId})\n    );\n  }\n\n  /**\n   * Returns the story given a URL.\n   * @param {string} storyUrl\n   * @return {!StoryDef}\n   * @private\n   */\n  getStoryFromUrl_(storyUrl) {\n    // TODO(enriqe): sanitize URLs for matching.\n    const storyIdx = storyUrl\n      ? findIndex(this.stories_, ({href}) => href === storyUrl)\n      : this.currentIdx_;\n\n    if (!this.stories_[storyIdx]) {\n      throw new Error(`Story URL not found in the player: ${storyUrl}`);\n    }\n\n    return this.stories_[storyIdx];\n  }\n\n  /**\n   * Rewinds the given story.\n   * @param {string} storyUrl\n   */\n  rewind(storyUrl) {\n    const story = this.getStoryFromUrl_(storyUrl);\n\n    this.whenConnected_(story)\n      .then(() => story.messagingPromise)\n      .then((messaging) => messaging.sendRequest('rewind', {}));\n  }\n\n  /**\n   * Returns a promise that resolves when the story is connected to the DOM.\n   * @param {!StoryDef} story\n   * @return {!Promise}\n   * @private\n   */\n  whenConnected_(story) {\n    if (story.iframe.isConnected) {\n      return Promise.resolve();\n    }\n    return story.connectedDeferred.promise;\n  }\n\n  /**\n   * Sends a message to the current story to navigate delta pages.\n   * @param {number} delta\n   * @private\n   */\n  selectPage_(delta) {\n    if (delta === 0) {\n      return;\n    }\n\n    this.sendSelectPageDelta_(delta);\n  }\n\n  /**\n   * @param {number} delta\n   * @private\n   */\n  sendSelectPageDelta_(delta) {\n    const story = this.stories_[this.currentIdx_];\n\n    story.messagingPromise.then((messaging) =>\n      messaging.sendRequest('selectPage', {delta})\n    );\n  }\n\n  /**\n   * React to documentStateUpdate events.\n   * @param {!DocumentStateTypeDef} data\n   * @param {Messaging} messaging\n   * @private\n   */\n  onDocumentStateUpdate_(data, messaging) {\n    switch (data.state) {\n      case STORY_MESSAGE_STATE_TYPE.PAGE_ATTACHMENT_STATE:\n        this.onPageAttachmentStateUpdate_(/** @type {boolean} */ (data.value));\n        break;\n      case STORY_MESSAGE_STATE_TYPE.CURRENT_PAGE_ID:\n        this.onCurrentPageIdUpdate_(\n          /** @type {string} */ (data.value),\n          messaging\n        );\n        break;\n      case STORY_MESSAGE_STATE_TYPE.MUTED_STATE:\n        this.onMutedStateUpdate_(/** @type {string} */ (data.value));\n        break;\n      case AMP_STORY_PLAYER_EVENT:\n        this.onPlayerEvent_(/** @type {string} */ (data.value));\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * Reacts to events coming from the story.\n   * @private\n   * @param {string} value\n   */\n  onPlayerEvent_(value) {\n    switch (value) {\n      case 'amp-story-player-skip-next':\n      case 'amp-story-player-skip-to-next':\n        this.next_();\n        break;\n      default:\n        this.element_.dispatchEvent(\n          createCustomEvent(this.win_, value, dict({}))\n        );\n        break;\n    }\n  }\n\n  /**\n   * Reacts to mute/unmute events coming from the story.\n   * @param {string} muted\n   * @private\n   */\n  onMutedStateUpdate_(muted) {\n    this.element_.dispatchEvent(\n      createCustomEvent(this.win_, 'amp-story-muted-state', {muted})\n    );\n  }\n\n  /**\n   * Reacts to page id update events inside the story.\n   * @param {string} pageId\n   * @param {Messaging} messaging\n   * @private\n   */\n  onCurrentPageIdUpdate_(pageId, messaging) {\n    messaging\n      .sendRequest(\n        'getDocumentState',\n        dict({'state': STORY_MESSAGE_STATE_TYPE.STORY_PROGRESS}),\n        true\n      )\n      .then((progress) => {\n        this.element_.dispatchEvent(\n          createCustomEvent(\n            this.win_,\n            'storyNavigation',\n            dict({\n              'pageId': pageId,\n              'progress': progress.value,\n            })\n          )\n        );\n      });\n  }\n\n  /**\n   * React to page attachment update events.\n   * @param {boolean} pageAttachmentOpen\n   * @private\n   */\n  onPageAttachmentStateUpdate_(pageAttachmentOpen) {\n    this.updateButtonVisibility_(!pageAttachmentOpen);\n    this.dispatchPageAttachmentEvent_(pageAttachmentOpen);\n  }\n\n  /**\n   * Updates the visbility state of the exit control button.\n   * TODO(#30031): delete this once new custom UI API is ready.\n   * @param {boolean} isVisible\n   * @private\n   */\n  updateButtonVisibility_(isVisible) {\n    const button = this.rootEl_.querySelector(\n      'button.amp-story-player-exit-control-button'\n    );\n    if (!button) {\n      return;\n    }\n\n    isVisible\n      ? button.classList.remove(DEPRECATED_BUTTON_CLASSES.HIDDEN)\n      : button.classList.add(DEPRECATED_BUTTON_CLASSES.HIDDEN);\n  }\n\n  /**\n   * Dispatch a page attachment event.\n   * @param {boolean} isPageAttachmentOpen\n   * @private\n   */\n  dispatchPageAttachmentEvent_(isPageAttachmentOpen) {\n    this.element_.dispatchEvent(\n      createCustomEvent(\n        this.win_,\n        isPageAttachmentOpen ? 'page-attachment-open' : 'page-attachment-close',\n        dict({})\n      )\n    );\n  }\n\n  /**\n   * React to selectDocument events.\n   * @param {!Object} data\n   * @private\n   */\n  onSelectDocument_(data) {\n    this.dispatchEndOfStoriesEvent_(data);\n    if (data.next) {\n      this.next_();\n    } else if (data.previous) {\n      this.previous_();\n    }\n  }\n\n  /**\n   * Dispatches end of stories event when appropiate.\n   * @param {!Object} data\n   * @private\n   */\n  dispatchEndOfStoriesEvent_(data) {\n    if (this.isCircularWrappingEnabled_ || (!data.next && !data.previous)) {\n      return;\n    }\n\n    let endOfStories, name;\n    if (data.next) {\n      endOfStories = this.currentIdx_ + 1 === this.stories_.length;\n      name = 'noNextStory';\n    } else {\n      endOfStories = this.currentIdx_ === 0;\n      name = 'noPreviousStory';\n    }\n\n    if (endOfStories) {\n      this.element_.dispatchEvent(createCustomEvent(this.win_, name, dict({})));\n    }\n  }\n\n  /**\n   * Reacts to touchstart events and caches its coordinates.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchStart_(event) {\n    const coordinates = this.getClientTouchCoordinates_(event);\n    if (!coordinates) {\n      return;\n    }\n\n    this.touchEventState_.startX = coordinates.screenX;\n    this.touchEventState_.startY = coordinates.screenY;\n\n    this.pageScroller_ &&\n      this.pageScroller_.onTouchStart(event.timeStamp, coordinates.clientY);\n\n    this.element_.dispatchEvent(\n      createCustomEvent(\n        this.win_,\n        'amp-story-player-touchstart',\n        dict({\n          'touches': event.touches,\n        })\n      )\n    );\n  }\n\n  /**\n   * Reacts to touchmove events.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchMove_(event) {\n    const coordinates = this.getClientTouchCoordinates_(event);\n    if (!coordinates) {\n      return;\n    }\n\n    this.element_.dispatchEvent(\n      createCustomEvent(\n        this.win_,\n        'amp-story-player-touchmove',\n        dict({\n          'touches': event.touches,\n          'isNavigationalSwipe': this.touchEventState_.isSwipeX,\n        })\n      )\n    );\n\n    if (this.touchEventState_.isSwipeX === false) {\n      this.pageScroller_ &&\n        this.pageScroller_.onTouchMove(event.timeStamp, coordinates.clientY);\n      return;\n    }\n\n    const {screenX, screenY} = coordinates;\n    this.touchEventState_.lastX = screenX;\n\n    if (this.touchEventState_.isSwipeX === null) {\n      this.touchEventState_.isSwipeX =\n        Math.abs(this.touchEventState_.startX - screenX) >\n        Math.abs(this.touchEventState_.startY - screenY);\n      if (!this.touchEventState_.isSwipeX) {\n        return;\n      }\n    }\n\n    this.onSwipeX_({\n      deltaX: screenX - this.touchEventState_.startX,\n      last: false,\n    });\n  }\n\n  /**\n   * Reacts to touchend events. Resets cached touch event states.\n   * @param {!Event} event\n   * @private\n   */\n  onTouchEnd_(event) {\n    this.element_.dispatchEvent(\n      createCustomEvent(\n        this.win_,\n        'amp-story-player-touchend',\n        dict({\n          'touches': event.touches,\n          'isNavigationalSwipe': this.touchEventState_.isSwipeX,\n        })\n      )\n    );\n\n    if (this.touchEventState_.isSwipeX === true) {\n      this.onSwipeX_({\n        deltaX: this.touchEventState_.lastX - this.touchEventState_.startX,\n        last: true,\n      });\n    } else {\n      this.pageScroller_ && this.pageScroller_.onTouchEnd(event.timeStamp);\n    }\n\n    this.touchEventState_.startX = 0;\n    this.touchEventState_.startY = 0;\n    this.touchEventState_.lastX = 0;\n    this.touchEventState_.isSwipeX = null;\n    this.swipingState_ = SwipingState.NOT_SWIPING;\n  }\n\n  /**\n   * Reacts to horizontal swipe events.\n   * @param {!Object} gesture\n   */\n  onSwipeX_(gesture) {\n    if (this.stories_.length <= 1) {\n      return;\n    }\n\n    const {deltaX} = gesture;\n\n    if (gesture.last === true) {\n      const delta = Math.abs(deltaX);\n\n      if (this.swipingState_ === SwipingState.SWIPING_TO_LEFT) {\n        delta > TOGGLE_THRESHOLD_PX &&\n        (this.getSecondaryStory_() || this.isCircularWrappingEnabled_)\n          ? this.next_()\n          : this.resetStoryStyles_();\n      }\n\n      if (this.swipingState_ === SwipingState.SWIPING_TO_RIGHT) {\n        delta > TOGGLE_THRESHOLD_PX &&\n        (this.getSecondaryStory_() || this.isCircularWrappingEnabled_)\n          ? this.previous_()\n          : this.resetStoryStyles_();\n      }\n\n      return;\n    }\n\n    this.drag_(deltaX);\n  }\n\n  /**\n   * Resets styles for the currently swiped story.\n   * @private\n   */\n  resetStoryStyles_() {\n    const currentIframe = this.stories_[this.currentIdx_].iframe;\n\n    requestAnimationFrame(() => {\n      resetStyles(devAssertElement(currentIframe), ['transform', 'transition']);\n    });\n\n    const secondaryStory = this.getSecondaryStory_();\n    if (secondaryStory) {\n      requestAnimationFrame(() => {\n        resetStyles(devAssertElement(secondaryStory.iframe), [\n          'transform',\n          'transition',\n        ]);\n      });\n    }\n  }\n\n  /**\n   * Gets accompanying story for the currently swiped story if any.\n   * @private\n   * @return {?StoryDef}\n   */\n  getSecondaryStory_() {\n    const nextStoryIdx =\n      this.swipingState_ === SwipingState.SWIPING_TO_LEFT\n        ? this.currentIdx_ + 1\n        : this.currentIdx_ - 1;\n\n    if (this.isIndexOutofBounds_(nextStoryIdx)) {\n      return null;\n    }\n\n    return this.stories_[nextStoryIdx];\n  }\n\n  /**\n   * Checks if index is out of bounds.\n   * @private\n   * @param {number} index\n   * @return {boolean}\n   */\n  isIndexOutofBounds_(index) {\n    return index >= this.stories_.length || index < 0;\n  }\n\n  /** @private */\n  initializeAutoplay_() {\n    if (!this.playerConfig_) {\n      return;\n    }\n\n    const {behavior} = this.playerConfig_;\n\n    if (behavior && typeof behavior.autoplay === 'boolean') {\n      this.playing_ = behavior.autoplay;\n    }\n  }\n\n  /** @private */\n  initializeAttribution_() {\n    if (!this.playerConfig_) {\n      return;\n    }\n\n    const {display} = this.playerConfig_;\n\n    if (display && display.attribution === 'auto') {\n      this.attribution_ = 'auto';\n    }\n  }\n\n  /** @private */\n  initializePageScroll_() {\n    if (!this.playerConfig_) {\n      return;\n    }\n\n    const {behavior} = this.playerConfig_;\n\n    if (behavior && behavior.pageScroll === false) {\n      this.pageScroller_ = null;\n    }\n  }\n\n  /**\n   * @private\n   * @return {boolean}\n   */\n  initializeCircularWrapping_() {\n    if (this.isCircularWrappingEnabled_ !== null) {\n      return this.isCircularWrappingEnabled_;\n    }\n\n    if (!this.playerConfig_) {\n      this.isCircularWrappingEnabled_ = false;\n      return false;\n    }\n\n    const {behavior} = this.playerConfig_;\n\n    const hasCircularWrappingEnabled = (behavior) =>\n      behavior.on === 'end' && behavior.action === 'circular-wrapping';\n\n    this.isCircularWrappingEnabled_ =\n      this.validateBehaviorDef_(behavior) &&\n      hasCircularWrappingEnabled(behavior);\n\n    return this.isCircularWrappingEnabled_;\n  }\n\n  /**\n   * Drags stories following the swiping gesture.\n   * @param {number} deltaX\n   * @private\n   */\n  drag_(deltaX) {\n    let secondaryTranslate;\n\n    if (deltaX < 0) {\n      this.swipingState_ = SwipingState.SWIPING_TO_LEFT;\n      secondaryTranslate = `translate3d(calc(100% + ${deltaX}px), 0, 0)`;\n    } else {\n      this.swipingState_ = SwipingState.SWIPING_TO_RIGHT;\n      secondaryTranslate = `translate3d(calc(${deltaX}px - 100%), 0, 0)`;\n    }\n\n    const story = this.stories_[this.currentIdx_];\n    const {iframe} = story;\n    const translate = `translate3d(${deltaX}px, 0, 0)`;\n\n    requestAnimationFrame(() => {\n      setStyles(devAssertElement(iframe), {\n        transform: translate,\n        transition: 'none',\n      });\n    });\n\n    const secondaryStory = this.getSecondaryStory_();\n    if (!secondaryStory) {\n      return;\n    }\n\n    requestAnimationFrame(() => {\n      setStyles(devAssertElement(secondaryStory.iframe), {\n        transform: secondaryTranslate,\n        transition: 'none',\n      });\n    });\n  }\n\n  /**\n   * Helper to retrieve the touch coordinates from a TouchEvent.\n   * @param {!Event} event\n   * @return {?{x: number, y: number}}\n   * @private\n   */\n  getClientTouchCoordinates_(event) {\n    const {touches} = event;\n    if (!touches || touches.length < 1) {\n      return null;\n    }\n\n    const {clientX, clientY, screenX, screenY} = touches[0];\n    return {screenX, screenY, clientX, clientY};\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Visibility state of the AMP document.\n * @enum {string}\n */\nexport const VisibilityState = {\n  /**\n   * The AMP document is being pre-rendered before being shown.\n   */\n  PRERENDER: 'prerender',\n\n  /**\n   * The AMP document is currently active and visible.\n   */\n  VISIBLE: 'visible',\n\n  /**\n   * The AMP document is active but the browser tab or AMP app is not.\n   */\n  HIDDEN: 'hidden',\n\n  /**\n   * The AMP document is visible, but the user has started swiping away from\n   * it. The runtime may stop active playback.\n   */\n  PAUSED: 'paused',\n\n  /**\n   * The AMP document is no longer active because the user swiped away or\n   * closed the viewer. The document may become visible again later.\n   */\n  INACTIVE: 'inactive',\n};\n", "export const CSS = \".amp-social-share-facebook{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M211.9 197.4h-36.7v59.9h36.7v175.8h70.5V256.5h49.2l5.2-59.1h-54.4v-33.7c0-13.9 2.8-19.5 16.3-19.5h38.2V82.9h-48.8c-52.5 0-76.1 23.1-76.1 67.3-.1 38.6-.1 47.2-.1 47.2z'/%3E%3C/svg%3E\\\")}.amp-social-share-pinterest{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M266.6 76.5c-100.2 0-150.7 71.8-150.7 131.7 0 36.3 13.7 68.5 43.2 80.6 4.8 2 9.2.1 10.6-5.3 1-3.7 3.3-13 4.3-16.9 1.4-5.3.9-7.1-3-11.8-8.5-10-13.9-23-13.9-41.3 0-53.3 39.9-101 103.8-101 56.6 0 87.7 34.6 87.7 80.8 0 60.8-26.9 112.1-66.8 112.1-22.1 0-38.6-18.2-33.3-40.6 6.3-26.7 18.6-55.5 18.6-74.8 0-17.3-9.3-31.7-28.4-31.7-22.5 0-40.7 23.3-40.7 54.6 0 19.9 6.7 33.4 6.7 33.4s-23.1 97.8-27.1 114.9c-8.1 34.1-1.2 75.9-.6 80.1.3 2.5 3.6 3.1 5 1.2 2.1-2.7 28.9-35.9 38.1-69 2.6-9.4 14.8-58 14.8-58 7.3 14 28.7 26.3 51.5 26.3 67.8 0 113.8-61.8 113.8-144.5-.1-62.6-53.1-120.8-133.6-120.8z'/%3E%3C/svg%3E\\\")}.amp-social-share-linkedin{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M186.4 142.4c0 19-15.3 34.5-34.2 34.5-18.9 0-34.2-15.4-34.2-34.5 0-19 15.3-34.5 34.2-34.5 18.9 0 34.2 15.5 34.2 34.5zm-5 58.9h-57.8v186.8h57.8V201.3zm92.4 0h-55.4v186.8h55.4v-98c0-26.3 12.1-41.9 35.2-41.9 21.3 0 31.5 15 31.5 41.9v98H398V269.8c0-50-28.3-74.2-68-74.2-39.6 0-56.3 30.9-56.3 30.9v-25.2h.1z'/%3E%3C/svg%3E\\\")}.amp-social-share-gplus{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M179.7 237.6v46.6h77c-3.1 20-23.3 58.7-77 58.7-46.3 0-84.1-38.5-84.1-85.9 0-47.4 37.8-85.9 84.1-85.9 26.4 0 44 11.3 54.1 21l36.8-35.5C247 134.4 216.4 121 179.7 121 104.7 121 44 181.8 44 257s60.7 136 135.7 136C258 393 310 337.8 310 260.1c0-8.9-1-15.7-2.1-22.5H179.7zm288.3-.9h-38.7V198h-38.6v38.7H352v38.6h38.7V314h38.6v-38.7H468'/%3E%3C/svg%3E\\\")}.amp-social-share-email{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M101.3 141.6v228.9h309.5V141.6H101.3zm274.4 26.2L256 259.3l-119.6-91.5h239.3zm-248.1 26.3 64.1 49.1-64.1 64.1V194.1zm.2 150.1 84.9-84.9 43.2 33.1 43-32.9 84.7 84.7H127.8zm256.6-36.4L320 243.4l64.4-49.3v113.7z'/%3E%3C/svg%3E\\\")}.amp-social-share-twitter{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath d='M0 0h400v400H0z'/%3E%3Cpath fill='%23FFF' fill-rule='nonzero' d='M153.62 301.59c94.34 0 145.94-78.16 145.94-145.94 0-2.22 0-4.43-.15-6.63A104.36 104.36 0 0 0 325 122.47a102.38 102.38 0 0 1-29.46 8.07 51.47 51.47 0 0 0 22.55-28.37 102.79 102.79 0 0 1-32.57 12.45c-15.9-16.906-41.163-21.044-61.625-10.093-20.461 10.95-31.032 34.266-25.785 56.873A145.62 145.62 0 0 1 92.4 107.81c-13.614 23.436-6.66 53.419 15.88 68.47A50.91 50.91 0 0 1 85 169.86v.65c.007 24.416 17.218 45.445 41.15 50.28a51.21 51.21 0 0 1-23.16.88c6.72 20.894 25.976 35.208 47.92 35.62a102.92 102.92 0 0 1-63.7 22 104.41 104.41 0 0 1-12.21-.74 145.21 145.21 0 0 0 78.62 23'/%3E%3C/g%3E%3C/svg%3E\\\")}.amp-social-share-tumblr{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23fff' d='M210.8 80.3c-2.3 18.3-6.4 33.4-12.4 45.2-6 11.9-13.9 22-23.9 30.5-9.9 8.5-21.8 14.9-35.7 19.5v50.6h38.9v124.5c0 16.2 1.7 28.6 5.1 37.1 3.4 8.5 9.5 16.6 18.3 24.2 8.8 7.6 19.4 13.4 31.9 17.5s26.8 6.1 43 6.1c14.3 0 27.6-1.4 39.9-4.3 12.3-2.9 26-7.9 41.2-15v-55.9c-17.8 11.7-35.7 17.5-53.7 17.5-10.1 0-19.1-2.4-27-7.1-5.9-3.5-10-8.2-12.2-14-2.2-5.8-3.3-19.1-3.3-39.7v-91.1h84.6v-55.8h-84.4v-90h-50.3z'/%3E%3C/svg%3E\\\")}.amp-social-share-whatsapp{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='46' height='46'%3E%3Cpath fill='%23FFF' d='M35.4 10.4C32 6.9 27.3 5 22.5 5 12.3 5 4.1 13.3 4.2 23.4c0 3.2.9 6.3 2.4 9.1L4 42l9.7-2.5c2.7 1.5 5.7 2.2 8.7 2.2 10.1 0 18.3-8.3 18.3-18.4 0-4.9-1.9-9.5-5.3-12.9zM22.5 38.6c-2.7 0-5.4-.7-7.7-2.1l-.6-.3-5.8 1.5L9.9 32l-.4-.6c-4.4-7.1-2.3-16.5 4.9-20.9 7.2-4.4 16.5-2.3 20.9 4.9 4.4 7.2 2.3 16.5-4.9 20.9-2.3 1.5-5.1 2.3-7.9 2.3zm8.8-11.1-1.1-.5s-1.6-.7-2.6-1.2c-.1 0-.2-.1-.3-.1-.3 0-.5.1-.7.2 0 0-.1.1-1.5 1.7-.1.2-.3.3-.5.3h-.1c-.1 0-.3-.1-.4-.2l-.5-.2c-1.1-.5-2.1-1.1-2.9-1.9-.2-.2-.5-.4-.7-.6-.7-.7-1.4-1.5-1.9-2.4l-.1-.2c-.1-.1-.1-.2-.2-.4 0-.2 0-.4.1-.5 0 0 .4-.5.7-.8.2-.2.3-.5.5-.7.2-.3.3-.7.2-1-.1-.5-1.3-3.2-1.6-3.8-.2-.3-.4-.4-.7-.5h-1.1c-.2 0-.4.1-.6.1l-.1.1c-.2.1-.4.3-.6.4-.2.2-.3.4-.5.6-.7.9-1.1 2-1.1 3.1 0 .8.2 1.6.5 2.3l.1.3c.9 1.9 2.1 3.6 3.7 5.1l.4.4c.3.3.6.5.8.8 2.1 1.8 4.5 3.1 7.2 3.8.3.1.7.1 1 .2h1c.5 0 1.1-.2 1.5-.4.3-.2.5-.2.7-.4l.2-.2c.2-.2.4-.3.6-.5.2-.2.4-.4.5-.6.2-.4.3-.9.4-1.4v-.7s-.1-.1-.3-.2z'/%3E%3C/svg%3E\\\")}.amp-social-share-line{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 511.99'%3E%3Cpath d='M443.2 233.29c0-84.14-84.35-152.6-188-152.6s-188 68.46-188 152.6c0 75.43 66.9 138.61 157.26 150.55 6.13 1.32 14.46 4 16.57 9.27 1.89 4.76 1.24 12.2.61 17 0 0-2.21 13.26-2.69 16.09-.82 4.75-3.78 18.6 16.29 10.14s108.21-63.76 147.66-109.16c27.25-29.89 40.3-60.18 40.3-93.89zm-254.38 44.92a3.67 3.67 0 0 1-3.66 3.67h-52.69a3.6 3.6 0 0 1-2.53-1l-.06-.05v-.05a3.65 3.65 0 0 1-1-2.53v-81.96a3.66 3.66 0 0 1 3.66-3.66h13.19a3.66 3.66 0 0 1 3.66 3.66v65.07h35.84a3.66 3.66 0 0 1 3.66 3.66zm31.8 0a3.65 3.65 0 0 1-3.66 3.65h-13.2a3.65 3.65 0 0 1-3.66-3.65v-81.92a3.66 3.66 0 0 1 3.66-3.66H217a3.66 3.66 0 0 1 3.66 3.66zm90.78 0a3.65 3.65 0 0 1-3.66 3.65h-13.19a3.67 3.67 0 0 1-.94-.12h-.05l-.25-.08h-.11l-.18-.08-.17-.08-.11-.06-.22-.14a3.45 3.45 0 0 1-.93-.9L254 229.56v48.66a3.66 3.66 0 0 1-3.67 3.65H237.1a3.65 3.65 0 0 1-3.66-3.65v-81.93a3.66 3.66 0 0 1 3.66-3.66h13.86l.21.05h.13l.21.07h.12a1.31 1.31 0 0 1 .21.08l.12.06.19.11a.41.41 0 0 1 .11.07l.19.13.1.07.19.16.07.07a2.28 2.28 0 0 1 .22.22 3.58 3.58 0 0 1 .28.37L290.89 245v-48.71a3.66 3.66 0 0 1 3.66-3.66h13.19a3.66 3.66 0 0 1 3.66 3.66zm72.83-68.74a3.66 3.66 0 0 1-3.65 3.67h-35.84V227h35.84a3.66 3.66 0 0 1 3.65 3.67v13.19a3.65 3.65 0 0 1-3.65 3.66h-35.84v13.85h35.84a3.65 3.65 0 0 1 3.65 3.66v13.19a3.66 3.66 0 0 1-3.65 3.67h-52.7a3.66 3.66 0 0 1-2.53-1l-.05-.05a.12.12 0 0 1-.05-.05 3.65 3.65 0 0 1-1-2.53V196.3a3.6 3.6 0 0 1 1-2.52l.06-.07a3.63 3.63 0 0 1 2.54-1h52.7a3.66 3.66 0 0 1 3.65 3.67z' style='fill:%23fff' data-name='\u30EC\u30A4\u30E4\u30FC 1'/%3E%3C/svg%3E\\\")}.amp-social-share-sms{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='30' height='29' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke='%23FFF' stroke-width='3' d='M8.73 26v-5.658H2V2h25.97L28 20.355l-12.062.042z' fill='none' fill-rule='evenodd'/%3E%3C/svg%3E\\\")}.amp-social-share-system{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg fill='%23fff' height='24' width='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z'/%3E%3C/svg%3E\\\")}amp-social-share{background-repeat:no-repeat;background-position:50%;background-size:contain;text-decoration:none;cursor:pointer;position:relative}amp-social-share:focus{outline:2px solid #0389ff;outline-offset:2px}.amp-social-share-twitter{background-color:#1da1f2}.amp-social-share-facebook{background-color:#32529f}.amp-social-share-pinterest{background-color:#e60023}.amp-social-share-linkedin{background-color:#0077b5}.amp-social-share-gplus{background-color:#dc4e41}.amp-social-share-tumblr{background-color:#3c5a77}.amp-social-share-email{background-color:#000}.amp-social-share-whatsapp{background-color:#25d366}.amp-social-share-line{background-color:#52b448}.amp-social-share-sms{background-color:#ca2b63}.amp-social-share-system{background-color:#000}.i-amphtml-story-share-widget{display:block!important;margin:16px 8px!important}.i-amphtml-story-no-sharing .i-amphtml-story-share-widget{display:none!important}.i-amphtml-story-share-widget-scrollable{padding:16px 0!important;overflow:auto!important}.i-amphtml-story-share-widget::-webkit-scrollbar{width:0px!important;background:transparent!important}.i-amphtml-story-share-list{list-style:none!important;padding:0 8px!important;margin:0!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-wrap:wrap!important;flex-wrap:wrap!important;width:100%!important}.i-amphtml-story-share-item{width:48px!important;height:66px!important;padding:0 16px!important;margin-bottom:12px!important}@media (max-width:410px){.i-amphtml-story-share-item{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;padding:0!important;min-width:60px!important;width:25%!important}}@media (min-width:410px) and (max-width:500px){.i-amphtml-story-share-item{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;padding:0!important;width:20%!important}}@media (min-width:500px) and (max-width:720px){.i-amphtml-story-share-item{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important;padding:0!important;width:16.66%!important}}.i-amphtml-story-share-widget-scrollable .i-amphtml-story-share-list{-ms-flex-wrap:nowrap!important;flex-wrap:nowrap!important}.i-amphtml-story-share-widget-scrollable>*>.i-amphtml-story-share-item{display:block!important;margin:0!important;padding:0 16px!important;min-width:auto!important}.i-amphtml-story-share-item:empty{display:none!important}.i-amphtml-story-share-icon{box-sizing:border-box!important;position:relative!important;width:48px!important;height:48px!important;display:block!important;cursor:pointer!important;border-radius:4px!important;overflow:visible!important;background-position:8px 8px!important;background-size:32px 32px!important;background-repeat:no-repeat!important}.i-amphtml-story-share-icon.amp-social-share-facebook{background-size:38px 38px!important;background-position:5px 5px!important}.i-amphtml-story-share-icon:focus{outline:2px solid #0389ff!important;outline-offset:2px!important}.i-amphtml-story-share-icon[type=email]{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important;background-color:#9aa0a6!important}.i-amphtml-story-share-icon[type=system]{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23fff'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z'/%3E%3C/svg%3E\\\")!important;background-color:#9aa0a6!important}.i-amphtml-story-share-icon-link{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z'/%3E%3C/svg%3E\\\")!important;background-color:#9aa0a6!important}.i-amphtml-story-share-icon .i-amphtml-story-share-label{position:absolute!important;top:48px!important;left:0!important;width:100%!important;color:rgba(0,0,0,0.87)!important;padding-top:5px!important;text-transform:capitalize!important;font-family:Roboto,sans-serif!important;font-weight:400!important;line-height:13px!important;font-size:11px!important;text-align:center!important}.i-amphtml-story-system-layer{background:linear-gradient(180deg,rgba(0,0,0,0.32),transparent)!important;position:absolute!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:justify!important;justify-content:space-between!important;top:0!important;left:0!important;right:0!important;height:54px!important;z-index:100000!important;transition:opacity 0.3s cubic-bezier(0.0,0.0,0.2,1)!important;pointer-events:none!important;font-family:Roboto,sans-serif!important}[desktop] .i-amphtml-story-system-layer{height:96px!important}.i-amphtml-story-hidden.i-amphtml-story-system-layer{opacity:0!important;transition:opacity 0.15s cubic-bezier(0.4,0.0,1,1)!important}.i-amphtml-story-hidden.i-amphtml-story-system-layer *{pointer-events:none!important}.i-amphtml-story-attribution{top:0!important;border:none!important;pointer-events:auto!important;cursor:pointer!important;padding:6px 8px 0!important;height:48px!important;place-items:center!important;display:-ms-flexbox!important;display:flex!important;text-decoration:none!important;overflow:hidden!important;visibility:hidden!important}.i-amphtml-story-attribution-visible{visibility:visible!important}[desktop] .i-amphtml-story-attribution{padding:6px 6px 0!important;left:0!important;right:0!important}.i-amphtml-story-attribution>*{margin:0px 4px!important}.i-amphtml-story-attribution-logo-container{display:grid!important;place-items:center!important}.i-amphtml-story-attribution-logo{border-radius:100%!important;border:1px solid #d4d4d4!important;width:28px!important;height:28px!important;-o-object-fit:cover!important;object-fit:cover!important;box-shadow:0px 0px 6px rgba(0,0,0,0.12)!important}.i-amphtml-story-attribution-text{white-space:nowrap!important;overflow:hidden!important;text-overflow:ellipsis!important;font-size:13px!important;font-weight:500!important;text-shadow:0px 0px 6px rgba(0,0,0,0.16)!important;color:#fff!important}.i-amphtml-story-system-layer-buttons,.i-amphtml-story-system-layer-buttons-start-position{display:-ms-flexbox!important;display:flex!important;-ms-flex-direction:row!important;flex-direction:row!important;-ms-flex-pack:end!important;justify-content:flex-end!important;padding-top:6px!important;box-sizing:border-box!important}.i-amphtml-story-system-layer-buttons-start-position{position:absolute!important;top:0!important;-ms-flex-pack:start!important;justify-content:flex-start!important}[desktop] .i-amphtml-story-system-layer-buttons{padding:8px 4px 0!important}.i-amphtml-story-system-layer-buttons .i-amphtml-story-ui-hide-button.i-amphtml-story-button{display:none!important}.i-amphtml-story-button{background-repeat:no-repeat!important;background-position:50%!important;height:48px!important;width:48px!important;cursor:pointer!important;border:none!important;pointer-events:auto!important;background:50% no-repeat!important;background-size:24px 24px!important}[desktop] .i-amphtml-story-button{margin:0 4px!important;background-size:32px 32px!important;padding:8px!important}.i-amphtml-story-button:active{background-color:rgba(0,0,0,0.2)!important}.i-amphtml-story-progress-bar{border:0!important;display:-ms-flexbox!important;display:flex!important;height:2px!important;left:0!important;margin:4px 0 0!important;padding:0 2px!important;position:absolute!important;right:0!important;top:0!important;visibility:visible!important;z-index:100001!important}[ad-showing] .i-amphtml-story-attribution,[ad-showing] .i-amphtml-story-progress-bar{visibility:hidden!important}[ad-showing] .i-amphtml-story-share-control{display:none!important}[ad-showing]:not([i-amphtml-current-page-has-audio])\\n.i-amphtml-story-mute-audio-control,[ad-showing]:not([i-amphtml-current-page-has-audio])\\n.i-amphtml-story-unmute-audio-control{visibility:hidden!important}.i-amphtml-story-page-progress-bar{background:hsla(0,0%,100%,0.4)!important;border-radius:1px!important;height:100%!important;list-style-type:none!important;margin:0 2px!important;overflow:hidden!important;width:100%!important}.i-amphtml-story-page-progress-value{background:#fff!important;height:100%!important;width:100%!important;transform:translateZ(0) scaleX(0)!important;transform-origin:left!important}[dir=rtl] .i-amphtml-story-page-progress-value{transform-origin:right!important}.i-amphtml-first-page-active[info] .i-amphtml-message-container{padding-right:48px!important}.i-amphtml-first-page-active[info][dir=rtl] .i-amphtml-message-container{padding-right:auto!important;padding-left:48px!important}.i-amphtml-message-container{display:-ms-flexbox!important;display:flex!important;-ms-flex-align:center!important;align-items:center!important;width:-webkit-max-content!important;width:max-content!important;transition-property:opacity,transform!important;position:absolute!important;top:0!important;right:48px!important;height:100%!important;color:#fff!important;font-size:16px!important;text-shadow:0px 0px 6px rgba(0,0,0,0.36)!important}[dir=rtl] .i-amphtml-message-container{right:auto!important;left:48px!important}[i-amphtml-story-messagedisplay=noshow] .i-amphtml-message-container{transition:opacity 0.2s cubic-bezier(0.4,0.0,1,1),visibility 0.2s,transform 0.0s 0.2s!important;opacity:0!important;visibility:hidden!important;transform:translateX(10px)!important}[i-amphtml-story-has-new-page=noshow] .i-amphtml-story-has-new-page-notification-container{transition:opacity 1.5s,visibility 1.5s!important;opacity:0!important;visibility:hidden!important}.i-amphtml-last-page-active[i-amphtml-story-has-new-page=show] .i-amphtml-story-has-new-page-notification-container{transition:opacity 1.5s,visibility 1.5s!important;opacity:1!important;visibility:visible!important}[dir=rtl][i-amphtml-story-messagedisplay=noshow] .i-amphtml-message-container{transform:translateX(-10px)!important}[i-amphtml-story-messagedisplay=show] .i-amphtml-message-container{transition:opacity 0.2s cubic-bezier(0.0,0.0,0.2,1),visibility 0.2s,transform 0.2s cubic-bezier(0.4,0.0,0.2,1)!important;opacity:1!important;visibility:visible!important;transform:translateX(0px)!important}.i-amphtml-story-mute-text,.i-amphtml-story-unmute-no-sound-text,.i-amphtml-story-unmute-sound-text{width:-webkit-max-content!important;width:max-content!important;color:#fff!important}.i-amphtml-story-sound-display{display:inline-block!important;height:46px!important;position:relative!important}.i-amphtml-paused-display,.i-amphtml-story-mute-audio-control,.i-amphtml-story-mute-text,.i-amphtml-story-no-audio-ui .i-amphtml-story-sound-display,.i-amphtml-story-pause-control,.i-amphtml-story-play-control,.i-amphtml-story-sidebar-control,.i-amphtml-story-skip-to-next,.i-amphtml-story-unmute-audio-control,.i-amphtml-story-unmute-no-sound-text,.i-amphtml-story-unmute-sound-text{display:none!important}.i-amphtml-story-has-audio:not([muted]) .i-amphtml-story-mute-audio-control,.i-amphtml-story-has-audio[muted] .i-amphtml-story-unmute-audio-control,[desktop] .i-amphtml-paused-display,[i-amphtml-story-has-sidebar] .i-amphtml-story-sidebar-control{display:block!important}.i-amphtml-story-system-layer-buttons button[disabled]{opacity:0.3!important;cursor:initial!important}.amp-mode-keyboard-active:not([desktop]) .i-amphtml-paused-display,.i-amphtml-story-has-audio[muted] .i-amphtml-story-mute-text,.i-amphtml-story-has-playback-ui:not([paused]) .i-amphtml-story-pause-control,.i-amphtml-story-has-playback-ui[paused] .i-amphtml-story-play-control,:not([i-amphtml-current-page-has-audio]).i-amphtml-story-has-audio:not([muted]) .i-amphtml-story-unmute-no-sound-text,[i-amphtml-current-page-has-audio].i-amphtml-story-has-audio:not([muted]) .i-amphtml-story-unmute-sound-text{display:block!important}.i-amphtml-story-ui-no-buttons .i-amphtml-story-button,.i-amphtml-story-ui-no-buttons .i-amphtml-story-system-layer-buttons{visibility:hidden!important}.i-amphtml-story-unmute-audio-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23FFF'%3E%3Cpath d='M5.2 4 4 5.2l4.467 4.467H4v5.666h3.778l4.722 4.723v-6.357l4.014 4.014a6.54 6.54 0 0 1-2.125 1.115v1.945a8.49 8.49 0 0 0 3.485-1.71L19.8 21 21 19.8l-8.5-8.5L5.2 4zM18.6 14.993c.321-.774.51-1.605.51-2.493a6.616 6.616 0 0 0-4.722-6.337V4.217C18.176 5.077 21 8.457 21 12.5c0 1.417-.35 2.748-.973 3.92l-1.426-1.427zm-4.212-6.3A4.25 4.25 0 0 1 16.75 12.5c0 .208-.019.406-.047.595l-2.314-2.314V8.694zm-3.863-1.775L12.5 4.944v3.948l-1.974-1.974z'/%3E%3C/svg%3E\\\")!important}[desktop] .i-amphtml-story-unmute-audio-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%23FFF'%3E%3Cpath d='M7.4 6 6 7.4l5.3 5.3H6v6.7h4.4L16 25v-7.5l4.7 4.7c-.7.6-1.6 1-2.5 1.3v2.3c1.5-.3 2.9-1.1 4.1-2l2.3 2.3 1.4-1.4-10-10L7.4 6zm15.8 12.9c.4-.9.6-1.9.6-2.9 0-3.5-2.3-6.5-5.6-7.5V6.3c4.5 1 7.8 5 7.8 9.7 0 1.7-.4 3.2-1.1 4.6l-1.7-1.7zm-5-7.4c1.7.8 2.8 2.5 2.8 4.5 0 .2 0 .5-.1.7L18.2 14v-2.5zm-4.5-2.1L16 7.1v4.6l-2.3-2.3z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-mute-audio-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23FFF'%3E%3Cpath d='M4 9.592v5.816h3.778l4.722 4.846V4.746L7.778 9.592H4zM16.75 12.5a4.374 4.374 0 0 0-2.361-3.906v7.802a4.348 4.348 0 0 0 2.36-3.896z'/%3E%3Cpath d='M14.389 4v1.997c2.73.833 4.722 3.43 4.722 6.503 0 3.072-1.993 5.67-4.722 6.503V21c3.787-.882 6.61-4.352 6.61-8.5S18.177 4.882 14.39 4z'/%3E%3C/svg%3E\\\")!important}[desktop] .i-amphtml-story-mute-audio-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%23FFF'%3E%3Cpath d='M10.4 12.6 16 6.9v18.2l-5.6-5.7H6v-6.8h4.4zM21 16c0-2-1.1-3.8-2.8-4.6v9.2C19.9 19.8 21 18 21 16zM18.2 6v2.3c3.2 1 5.6 4 5.6 7.7 0 3.6-2.3 6.7-5.6 7.7V26c4.5-1 7.8-5.1 7.8-10s-3.3-9-7.8-10z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-pause-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%23FFF'%3E%3Cpath d='M13.3 25.3H8V6.7h5.3v18.6zm5.4 0V6.7H24v18.7h-5.3z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-play-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%23FFF'%3E%3Cpath d='M23.521 16.335 9 25.67V7l14.521 9.335z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-sidebar-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23FFF'%3E%3Cpath d='M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-share-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23FFF'%3E%3Cpath d='M15.64 16.41a2.698 2.698 0 0 1 1.86-.743 2.746 2.746 0 0 1 2.75 2.75 2.746 2.746 0 0 1-2.75 2.75 2.746 2.746 0 0 1-2.75-2.75c0-.22.037-.431.082-.633L8.37 14.008a2.738 2.738 0 0 1-1.87.742A2.746 2.746 0 0 1 3.75 12 2.746 2.746 0 0 1 6.5 9.25c.724 0 1.375.284 1.87.743l6.463-3.768a2.93 2.93 0 0 1-.083-.642 2.746 2.746 0 0 1 2.75-2.75 2.746 2.746 0 0 1 2.75 2.75 2.746 2.746 0 0 1-2.75 2.75 2.72 2.72 0 0 1-1.87-.742l-6.463 3.767A3 3 0 0 1 9.25 12c0 .22-.037.43-.082.642l6.471 3.767zm2.777-10.827a.92.92 0 0 0-.917-.916.92.92 0 0 0-.917.916.92.92 0 0 0 .917.917.92.92 0 0 0 .917-.917zM6.5 12.917A.92.92 0 0 1 5.583 12a.92.92 0 0 1 .917-.917.92.92 0 0 1 .917.917.92.92 0 0 1-.917.917zm10.083 5.5a.92.92 0 0 0 .917.916.92.92 0 0 0 .917-.916.92.92 0 0 0-.917-.917.92.92 0 0 0-.917.917z' fill-rule='evenodd'/%3E%3C/svg%3E\\\")!important}[desktop] .i-amphtml-story-share-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%23FFF'%3E%3Cpath d='M20 20.8c.5-.5 1.2-.8 2-.8 1.7 0 3 1.3 3 3s-1.3 3-3 3-3-1.3-3-3c0-.2 0-.5.1-.7l-7-4.1c-.5.5-1.2.8-2 .8-1.7 0-3-1.3-3-3s1.3-3 3-3c.8 0 1.5.3 2 .8l7-4.1c-.1-.2-.1-.5-.1-.7 0-1.7 1.3-3 3-3s3 1.3 3 3-1.3 3-3 3c-.8 0-1.5-.3-2-.8l-7 4.1c0 .2.1.5.1.7s0 .5-.1.7l7 4.1zM23 9c0-.5-.5-1-1-1s-1 .5-1 1 .5 1 1 1 1-.5 1-1zm-13 8c-.5 0-1-.5-1-1s.5-1 1-1 1 .5 1 1-.5 1-1 1zm11 6c0 .5.5 1 1 1s1-.5 1-1-.5-1-1-1-1 .5-1 1z' fill-rule='evenodd'/%3E%3C/svg%3E\\\")!important}[ios] .i-amphtml-story-share-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23FFF'%3E%3Cpath fill='%23fff' d='m15.666 4.583-1.301 1.302-1.458-1.458v10.24h-1.815V4.427L9.635 5.885 8.333 4.583 12 .917l3.666 3.666zm3.667 4.584V19.25a1.839 1.839 0 0 1-1.833 1.833h-11a1.833 1.833 0 0 1-1.833-1.833V9.167c0-1.018.815-1.834 1.833-1.834h2.75v1.834H6.5V19.25h11V9.167h-2.75V7.333h2.75c1.008 0 1.833.816 1.833 1.834z'/%3E%3C/svg%3E\\\")!important;background-size:auto!important}.i-amphtml-story-info-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23FFF'%3E%3Cpath d='M11.1 7.3H13v1.9h-1.9V7.3zm0 3.8H13v5.7h-1.9v-5.7zm.9-8.6c-5.2 0-9.5 4.3-9.5 9.5s4.3 9.5 9.5 9.5 9.5-4.3 9.5-9.5-4.3-9.5-9.5-9.5zm0 17.1c-4.2 0-7.6-3.4-7.6-7.6S7.8 4.4 12 4.4s7.6 3.4 7.6 7.6-3.4 7.6-7.6 7.6z'/%3E%3C/svg%3E\\\")!important;display:none!important;background-size:auto!important}.i-amphtml-story-close-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23FFF'%3E%3Cpath d='M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z'/%3E%3C/svg%3E\\\")!important}[desktop] .i-amphtml-story-close-control{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%23FFF'%3E%3Cpath d='m25.333 8.547-1.88-1.88L16 14.12 8.546 6.667l-1.88 1.88L14.12 16l-7.453 7.453 1.88 1.88L16 17.88l7.453 7.453 1.88-1.88L17.88 16l7.453-7.453z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-story-skip-to-next{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%23FFF'%3E%3Cpath d='M19.333 16 8 24V8l11.333 8zM24 24h-2.667V8H24v16z'/%3E%3C/svg%3E\\\")!important}[desktop] .i-amphtml-story-skip-to-next{display:block!important}.i-amphtml-story-has-new-page-notification-container{position:absolute!important;z-index:100002!important;top:32px!important;right:0!important;left:0!important;opacity:0!important}.i-amphtml-story-has-new-page-notification-container,.i-amphtml-story-has-new-page-text-wrapper{display:-ms-flexbox!important;display:flex!important;-ms-flex-pack:center!important;justify-content:center!important}.i-amphtml-story-has-new-page-text-wrapper{background-color:rgba(32,33,37,0.8)!important;-ms-flex-align:center!important;align-items:center!important;padding:4px 10px 4px 0!important;border-radius:5px!important}[dir=rtl] .i-amphtml-story-has-new-page-text-wrapper{padding-right:0!important;padding-left:10px!important}.i-amphtml-story-has-new-page-text{color:#fff!important;font-size:16px!important;text-shadow:0px 0px 6px rgba(0,0,0,0.36)!important;font-weight:700!important}.i-amphtml-story-has-new-page-circle-icon{background:#03ffa0!important;border-radius:50%!important;height:6px!important;width:6px!important;position:relative!important;box-shadow:0 0 0 2px rgba(3,255,160,0.5)!important;margin:0px 10px!important}.i-amphtml-story-desktop-panels .i-amphtml-story-has-new-page-notification-container{top:0!important}.i-amphtml-embedded.i-amphtml-first-page-active .i-amphtml-story-info-control{display:block!important}.i-amphtml-story-no-sharing .i-amphtml-story-info-control,.i-amphtml-story-no-sharing .i-amphtml-story-share-control{display:none!important}.i-amphtml-story-desktop-panels.i-amphtml-story-system-layer{background:transparent!important;top:auto!important;bottom:0!important;height:96px!important;display:-ms-flexbox!important;display:flex!important;-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important;-ms-flex-direction:row-reverse!important;flex-direction:row-reverse!important}.i-amphtml-animate-progress li{transition:transform 0.8s cubic-bezier(0.4,0.0,0.2,1)!important}.i-amphtml-progress-bar-overflow.i-amphtml-story-progress-bar{width:calc(100% - 4px)!important;margin:4px 2px 0!important;overflow:hidden!important;padding:0!important}.i-amphtml-story-desktop-panels .i-amphtml-story-progress-bar{position:relative!important;height:3px!important;width:33.33333vw!important;margin:0 24px!important}.i-amphtml-story-desktop-fullbleed .i-amphtml-story-progress-bar{height:3px!important}.i-amphtml-story-desktop-panels .i-amphtml-story-page-progress-bar{border-radius:100px!important}.i-amphtml-progress-bar-overflow .i-amphtml-story-page-progress-bar{border-radius:0px!important;list-style:none!important;margin:0 2px!important;width:2px!important;position:absolute!important;transform-origin:left!important}[dir=rtl].i-amphtml-progress-bar-overflow .i-amphtml-story-page-progress-bar{transform-origin:right!important}[desktop] .i-amphtml-progress-bar-overflow .i-amphtml-story-page-progress-bar{width:3px!important}.i-amphtml-story-desktop-panels.i-amphtml-story-system-layer .i-amphtml-story-attribution,.i-amphtml-story-desktop-panels.i-amphtml-story-system-layer .i-amphtml-story-system-layer-buttons,.i-amphtml-story-desktop-panels.i-amphtml-story-system-layer .i-amphtml-story-system-layer-buttons-start-position{position:fixed!important;top:0!important;width:100vw!important}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story-system-layer.css*/\";\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {LogLevel, dev} from '../../../src/log';\nimport {Services} from '../../../src/services';\nimport {isArray} from '../../../src/core/types';\nimport {removeChildren} from '../../../src/dom';\nimport {toggle} from '../../../src/style';\n\n/**\n * @param {!../../../src/service/vsync-impl.Vsync} vsync\n * @param {!Element} el\n * @param {boolean} isHidden\n */\nfunction toggleHiddenAttribute(vsync, el, isHidden) {\n  vsync.mutate(() => {\n    toggle(el, !isHidden);\n  });\n}\n\n/**\n * @param {!Window} win\n * @param {string|!Array<string>} classNameOrList\n * @param {function(Event)} handler\n * @return {!Element}\n */\nfunction createButton(win, classNameOrList, handler) {\n  const button = win.document.createElement('div');\n  button.setAttribute('role', 'button');\n\n  if (isArray(classNameOrList)) {\n    classNameOrList.forEach((className) => button.classList.add(className));\n  } else {\n    button.classList.add(/** @type {string} */ (classNameOrList));\n  }\n  button.classList.add('i-amphtml-story-button');\n  button.addEventListener('click', handler);\n  return button;\n}\n\n/**\n * Development mode logs buttons.\n */\nexport class DevelopmentModeLogButtonSet {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {?Element} */\n    this.root_ = null;\n\n    /** @private {?Element} */\n    this.errorButton_ = null;\n\n    /** @private {?Element} */\n    this.warningButton_ = null;\n\n    /** @private {?Element} */\n    this.successButton_ = null;\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {!DevelopmentModeLogButtonSet}\n   */\n  static create(win) {\n    return new DevelopmentModeLogButtonSet(win);\n  }\n\n  /**\n   * Builds the developer log button set element.\n   * @param {function()} logButtonActionFn A callback function to be invoked when\n   *     the log buttons are clicked.\n   * @return {?Element}\n   */\n  build(logButtonActionFn) {\n    this.errorButton_ = createButton(\n      this.win_,\n      ['i-amphtml-story-error-button', 'i-amphtml-story-dev-logs-button'],\n      () => logButtonActionFn()\n    );\n\n    this.warningButton_ = createButton(\n      this.win_,\n      ['i-amphtml-story-warning-button', 'i-amphtml-story-dev-logs-button'],\n      () => logButtonActionFn()\n    );\n\n    this.successButton_ = createButton(\n      this.win_,\n      ['i-amphtml-story-success-button', 'i-amphtml-story-dev-logs-button'],\n      () => logButtonActionFn()\n    );\n\n    this.root_ = this.win_.document.createElement('div');\n    this.root_.appendChild(this.errorButton_);\n    this.root_.appendChild(this.warningButton_);\n    this.root_.appendChild(this.successButton_);\n\n    return this.root_;\n  }\n\n  /**\n   * Gets the button associated to a given log entry.\n   * @param {!./logging.AmpStoryLogEntryDef} logEntry The log entry for which\n   *     the associated button shouldbe retrieved.\n   * @return {?Element} The button associated to the specified log entry, if one\n   *     exists.\n   * @private\n   */\n  getButtonForLogEntry_(logEntry) {\n    if (logEntry.conforms) {\n      return this.successButton_;\n    }\n\n    switch (logEntry.level) {\n      case LogLevel.ERROR:\n        return this.errorButton_;\n      case LogLevel.WARN:\n        return this.warningButton_;\n      default:\n        return null;\n    }\n  }\n\n  /**\n   * Logs an individual entry into the developer log.\n   * @param {!./logging.AmpStoryLogEntryDef} logEntry The entry to log.\n   */\n  log(logEntry) {\n    const button = this.getButtonForLogEntry_(logEntry);\n    if (!button) {\n      return;\n    }\n\n    const oldCount = parseInt(button.getAttribute('data-count') || 0, 10);\n    button.setAttribute('data-count', oldCount + 1);\n  }\n\n  /**\n   * Clears any error state held by the buttons.\n   */\n  clear() {\n    this.errorButton_.setAttribute('data-count', 0);\n    this.warningButton_.setAttribute('data-count', 0);\n    this.successButton_.setAttribute('data-count', 0);\n  }\n}\n\n/**\n * Development mode log for <amp-story>.\n */\nexport class DevelopmentModeLog {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {?Element} */\n    this.root_ = null;\n\n    /** @private {?Element} */\n    this.entriesEl_ = null;\n\n    /** @private {?Element} */\n    this.contextStringEl_ = null;\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {!DevelopmentModeLog}\n   */\n  static create(win) {\n    return new DevelopmentModeLog(win);\n  }\n\n  /**\n   * Builds the developer log element.\n   * @return {?Element}\n   */\n  build() {\n    this.contextStringEl_ = this.win_.document.createElement('span');\n    this.contextStringEl_.classList.add(\n      'i-amphtml-story-developer-log-context'\n    );\n    const titleEl = this.win_.document.createElement('div');\n    titleEl.textContent = 'Developer logs for page ';\n    titleEl.appendChild(this.contextStringEl_);\n\n    const closeDeveloperLogEl = createButton(\n      this.win_,\n      'i-amphtml-story-developer-log-close',\n      () => this.hide()\n    );\n\n    const headerEl = this.win_.document.createElement('div');\n    headerEl.classList.add('i-amphtml-story-developer-log-header');\n    headerEl.appendChild(titleEl);\n    headerEl.appendChild(closeDeveloperLogEl);\n\n    this.entriesEl_ = this.win_.document.createElement('ul');\n    this.entriesEl_.classList.add('i-amphtml-story-developer-log-entries');\n\n    this.root_ = this.win_.document.createElement('div');\n    this.root_.classList.add('i-amphtml-story-developer-log');\n    toggle(this.root_, false);\n    this.root_.appendChild(headerEl);\n    this.root_.appendChild(this.entriesEl_);\n\n    this.clear();\n    return this.root_;\n  }\n\n  /**\n   * @param {!LogLevel} logLevel\n   * @return {?string} The CSS class to be applied to the log entry, given the\n   *     specified log level, or null if no class should be added.\n   * @private\n   */\n  getCssLogLevelClass_(logLevel) {\n    switch (logLevel) {\n      case LogLevel.WARN:\n        return 'i-amphtml-story-developer-log-entry-warning';\n      case LogLevel.ERROR:\n        return 'i-amphtml-story-developer-log-entry-error';\n      default:\n        return null;\n    }\n  }\n\n  /**\n   * @param {boolean} conforms Whether the log entry is for an element that\n   *     conforms to a best practice.\n   * @return {?string} The CSS class to be applied to the log entry, given the\n   *     element's conformance to a best practice, or null if no class should be\n   *     added.\n   * @private\n   */\n  getCssConformanceClass_(conforms) {\n    if (conforms) {\n      return 'i-amphtml-story-developer-log-entry-success';\n    }\n\n    return null;\n  }\n\n  /**\n   * @param {!./logging.AmpStoryLogEntryDef} logEntry The entry to be logged.\n   */\n  log(logEntry) {\n    const logLevelClass = this.getCssLogLevelClass_(logEntry.level);\n    const conformanceClass = this.getCssConformanceClass_(logEntry.conforms);\n\n    const logEntryUi = this.win_.document.createElement('li');\n    logEntryUi.classList.add('i-amphtml-story-developer-log-entry');\n\n    if (logLevelClass) {\n      logEntryUi.classList.add(logLevelClass);\n    }\n\n    if (conformanceClass) {\n      logEntryUi.classList.add(conformanceClass);\n    }\n\n    logEntryUi.textContent = logEntry.message;\n    this.entriesEl_.appendChild(logEntryUi);\n  }\n\n  /**\n   * Clears all entries from the developer logs.\n   */\n  clear() {\n    Services.vsyncFor(this.win_).mutate(() => {\n      removeChildren(dev().assertElement(this.entriesEl_));\n    });\n  }\n\n  /**\n   * Sets the string providing context for the developer logs window.  This is\n   * often the name or ID of the element that all logs are for (e.g. the page).\n   * @param {string} contextString\n   */\n  setContextString(contextString) {\n    this.contextStringEl_.textContent = contextString;\n  }\n\n  /**\n   * Toggles the visibility of the developer log.\n   */\n  toggle() {\n    const newHiddenState = !this.root_.hasAttribute('hidden');\n    toggleHiddenAttribute(\n      Services.vsyncFor(this.win_),\n      dev().assertElement(this.root_),\n      newHiddenState\n    );\n  }\n\n  /**\n   * Hides the developer log in the UI.\n   */\n  hide() {\n    toggleHiddenAttribute(\n      Services.vsyncFor(this.win_),\n      dev().assertElement(this.root_),\n      /* isHidden */ true\n    );\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {EventType} from './events';\nimport {POLL_INTERVAL_MS} from './page-advancement';\nimport {Services} from '../../../src/services';\nimport {\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {debounce} from '../../../src/core/types/function';\nimport {dev, devAssert} from '../../../src/log';\nimport {escapeCssSelectorNth} from '../../../src/core/dom/css-selectors';\nimport {hasOwn, map} from '../../../src/core/types/object';\nimport {removeChildren} from '../../../src/dom';\nimport {scale, setImportantStyles} from '../../../src/style';\nimport {scopedQuerySelector} from '../../../src/core/dom/query';\n\n/**\n * Transition used to show the progress of a media. Has to be linear so the\n * animation is smooth and constant.\n * @const {string}\n */\nconst TRANSITION_LINEAR = `transform ${POLL_INTERVAL_MS}ms linear`;\n\n/**\n * Transition used to fully fill or unfill a progress bar item.\n * @const {string}\n */\nconst TRANSITION_EASE = 'transform 200ms ease';\n\n/**\n * Size in pixels of a segment ellipse.\n * @type {number}\n */\nlet ELLIPSE_WIDTH_PX = 2;\n\n/**\n * Size in pixels of the total side margins of a segment.\n * @const {number}\n */\nconst SEGMENTS_MARGIN_PX = 4;\n\n/**\n * Maximum number of segments that can be shown at a time before collapsing\n * into ellipsis.\n * @type {number}\n */\nlet MAX_SEGMENTS = 20;\n\n/**\n * Number of segments we introduce to the bar as we pass an overflow point\n * (when user reaches ellipsis).\n * @const {number}\n */\nconst SEGMENT_INCREMENT = 5;\n\n/**\n * Progress bar for <amp-story>.\n */\nexport class ProgressBar {\n  /**\n   * @param {!Window} win\n   * @param {!Element} storyEl\n   */\n  constructor(win, storyEl) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {boolean} */\n    this.isBuilt_ = false;\n\n    /** @private {?Element} */\n    this.root_ = null;\n\n    /** @private {number} */\n    this.segmentCount_ = 0;\n\n    /** @private {number} */\n    this.activeSegmentIndex_ = 0;\n\n    /** @private {number} */\n    this.activeSegmentProgress_ = 1;\n\n    /** @private {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = Services.ampdocServiceFor(this.win_).getSingleDoc();\n\n    /** @private @const {!../../../src/service/mutator-interface.MutatorInterface} */\n    this.mutator_ = Services.mutatorForDoc(this.ampdoc_);\n\n    /** @private {!Object<string, number>} */\n    this.segmentIdMap_ = map();\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win_);\n\n    /** @private {string} */\n    this.activeSegmentId_ = '';\n\n    /** @private {!Array<!Element>} */\n    this.segments_ = [];\n\n    /** @private {!Promise} */\n    this.segmentsAddedPromise_ = Promise.resolve();\n\n    /**\n     * First expanded segment after ellipsis (if any) for stories with segments\n     * > MAX_SEGMENTS.\n     * @private {number}\n     */\n    this.firstExpandedSegmentIndex_ = 0;\n\n    /** @private {!Element} */\n    this.storyEl_ = storyEl;\n  }\n\n  /**\n   * @param {!Window} win\n   * @param {!Element} storyEl\n   * @return {!ProgressBar}\n   */\n  static create(win, storyEl) {\n    return new ProgressBar(win, storyEl);\n  }\n\n  /**\n   * Builds the progress bar.\n   * @param {string} initialSegmentId\n   * @return {!Element}\n   */\n  build(initialSegmentId) {\n    if (this.isBuilt_) {\n      return this.getRoot();\n    }\n\n    this.root_ = this.win_.document.createElement('ol');\n    this.root_.setAttribute('aria-hidden', true);\n    this.root_.classList.add('i-amphtml-story-progress-bar');\n    this.storyEl_.addEventListener(EventType.REPLAY, () => {\n      this.replay_();\n    });\n\n    this.storeService_.subscribe(\n      StateProperty.PAGE_IDS,\n      (pageIds) => {\n        if (this.isBuilt_) {\n          this.clear_();\n        }\n\n        this.segmentsAddedPromise_ = this.mutator_.mutateElement(\n          this.getRoot(),\n          () => {\n            /** @type {!Array} */ (pageIds).forEach((id) => {\n              if (!(id in this.segmentIdMap_)) {\n                this.addSegment_(id);\n              }\n            });\n          }\n        );\n\n        if (this.isBuilt_) {\n          this.updateProgress(\n            this.activeSegmentId_,\n            this.activeSegmentProgress_,\n            true /** updateAllSegments */\n          );\n        }\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.RTL_STATE,\n      (rtlState) => {\n        this.onRtlStateUpdate_(rtlState);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.UI_STATE,\n      (uiState) => {\n        this.onUIStateUpdate_(uiState);\n      },\n      true /** callToInitialize */\n    );\n\n    Services.viewportForDoc(this.ampdoc_).onResize(\n      debounce(this.win_, () => this.onResize_(), 300)\n    );\n\n    this.segmentsAddedPromise_.then(() => {\n      if (this.segmentCount_ > MAX_SEGMENTS) {\n        this.getInitialFirstExpandedSegmentIndex_(\n          this.segmentIdMap_[initialSegmentId]\n        );\n\n        this.render_(false /** shouldAnimate */);\n      }\n      this.getRoot().classList.toggle(\n        'i-amphtml-progress-bar-overflow',\n        this.segmentCount_ > MAX_SEGMENTS\n      );\n    });\n\n    this.isBuilt_ = true;\n    return this.getRoot();\n  }\n\n  /**\n   * Reacts to story replay.\n   * @private\n   */\n  replay_() {\n    if (this.segmentCount_ > MAX_SEGMENTS) {\n      this.firstExpandedSegmentIndex_ = 0;\n      this.render_(false /** shouldAnimate */);\n    }\n  }\n\n  /**\n   * Renders the segments by setting their corresponding scaleX and translate.\n   * @param {boolean} shouldAnimate\n   * @private\n   */\n  render_(shouldAnimate = true) {\n    this.getSegmentWidth_().then((segmentWidth) => {\n      let translateX =\n        -(this.firstExpandedSegmentIndex_ - this.getPrevEllipsisCount_()) *\n        (ELLIPSE_WIDTH_PX + SEGMENTS_MARGIN_PX);\n\n      this.mutator_.mutateElement(this.getRoot(), () => {\n        this.getRoot().classList.toggle(\n          'i-amphtml-animate-progress',\n          shouldAnimate\n        );\n\n        for (let index = 0; index < this.segmentCount_; index++) {\n          const width =\n            index >= this.firstExpandedSegmentIndex_ &&\n            index < this.firstExpandedSegmentIndex_ + MAX_SEGMENTS\n              ? segmentWidth\n              : ELLIPSE_WIDTH_PX;\n          this.transform_(this.segments_[index], translateX, width);\n          translateX += width + SEGMENTS_MARGIN_PX;\n        }\n      });\n    });\n  }\n\n  /**\n   * Applies transform to a segment.\n   * @param {!Element} segment\n   * @param {number} translateX\n   * @param {number} width\n   * @private\n   */\n  transform_(segment, translateX, width) {\n    if (this.storeService_.get(StateProperty.RTL_STATE)) {\n      translateX *= -1;\n    }\n\n    // Do not remove translateZ(0.00001px) as it prevents an iOS repaint issue.\n    // http://mir.aculo.us/2011/12/07/the-case-of-the-disappearing-element/\n    segment.setAttribute(\n      'style',\n      `transform: translate3d(${translateX}px, 0px, 0.00001px) scaleX(${\n        width / ELLIPSE_WIDTH_PX\n      });`\n    );\n  }\n\n  /**\n   * Gets the individual segment width.\n   * @return {!Promise<number>}\n   * @private\n   */\n  getSegmentWidth_() {\n    const nextEllipsisCount = this.getNextEllipsisCount_();\n    const prevEllipsisCount = this.getPrevEllipsisCount_();\n    const totalEllipsisWidth =\n      (nextEllipsisCount + prevEllipsisCount) *\n      (ELLIPSE_WIDTH_PX + SEGMENTS_MARGIN_PX);\n    return this.getBarWidth_().then((barWidth) => {\n      const totalSegmentsWidth = barWidth - totalEllipsisWidth;\n\n      return (\n        totalSegmentsWidth / Math.min(this.segmentCount_, MAX_SEGMENTS) -\n        SEGMENTS_MARGIN_PX\n      );\n    });\n  }\n\n  /**\n   * Gets width of the progress bar.\n   * @return {!Promise<number>}\n   * @private\n   */\n  getBarWidth_() {\n    return this.mutator_.measureElement(() => {\n      return this.getRoot()./*OK*/ getBoundingClientRect().width;\n    });\n  }\n\n  /**\n   * Gets the number of ellipsis that should appear to the \"next\" position of\n   * the expanded segments.\n   * @return {number}\n   * @private\n   */\n  getNextEllipsisCount_() {\n    const nextPagesCount =\n      this.segmentCount_ - (this.firstExpandedSegmentIndex_ + MAX_SEGMENTS);\n    return nextPagesCount > 3 ? 3 : Math.max(nextPagesCount, 0);\n  }\n\n  /**\n   * Gets the number of ellipsis that should appear to the \"previous\" position\n   * of the expanded segments.\n   * @return {number}\n   * @private\n   */\n  getPrevEllipsisCount_() {\n    return Math.min(3, this.firstExpandedSegmentIndex_);\n  }\n\n  /**\n   * Checks if an index is past the MAX_SEGMENTS limit and updates the progress\n   * bar accordingly.\n   * @private\n   */\n  checkIndexForOverflow_() {\n    // Touching an ellipse on the \"next\" position of the expanded segments.\n    if (\n      this.activeSegmentIndex_ >=\n      this.firstExpandedSegmentIndex_ + MAX_SEGMENTS\n    ) {\n      const nextLimit =\n        this.firstExpandedSegmentIndex_ + MAX_SEGMENTS + SEGMENT_INCREMENT - 1;\n\n      this.firstExpandedSegmentIndex_ +=\n        nextLimit < this.segmentCount_\n          ? SEGMENT_INCREMENT\n          : this.segmentCount_ -\n            (this.firstExpandedSegmentIndex_ + MAX_SEGMENTS);\n\n      this.render_();\n    }\n    // Touching an ellipse on the \"previous\" position of the expanded segments.\n    else if (this.activeSegmentIndex_ < this.firstExpandedSegmentIndex_) {\n      this.firstExpandedSegmentIndex_ -=\n        this.firstExpandedSegmentIndex_ - SEGMENT_INCREMENT < 0\n          ? this.firstExpandedSegmentIndex_\n          : SEGMENT_INCREMENT;\n\n      this.render_();\n    }\n  }\n\n  /**\n   * Reacts to RTL state updates and triggers the UI for RTL.\n   * @param {boolean} rtlState\n   * @private\n   */\n  onRtlStateUpdate_(rtlState) {\n    this.mutator_.mutateElement(this.getRoot(), () => {\n      rtlState\n        ? this.getRoot().setAttribute('dir', 'rtl')\n        : this.getRoot().removeAttribute('dir');\n    });\n  }\n\n  /**\n   * Handles resize events.\n   * @private\n   */\n  onResize_() {\n    // We need to take into account both conditionals since we could've switched\n    // from a screen that had an overflow to one that doesn't and viceversa.\n    if (\n      this.getRoot().classList.contains('i-amphtml-progress-bar-overflow') ||\n      this.segmentCount_ > MAX_SEGMENTS\n    ) {\n      this.getInitialFirstExpandedSegmentIndex_(this.activeSegmentIndex_);\n      this.render_(false /** shouldAnimate */);\n    }\n  }\n\n  /**\n   * Reacts to UI state updates.\n   * @param {!UIType} uiState\n   * @private\n   */\n  onUIStateUpdate_(uiState) {\n    switch (uiState) {\n      case UIType.DESKTOP_FULLBLEED:\n        MAX_SEGMENTS = 70;\n        ELLIPSE_WIDTH_PX = 3;\n        break;\n      case UIType.MOBILE:\n        MAX_SEGMENTS = 20;\n        ELLIPSE_WIDTH_PX = 2;\n        break;\n      case UIType.DESKTOP_PANELS:\n        MAX_SEGMENTS = 20;\n        ELLIPSE_WIDTH_PX = 3;\n        break;\n      default:\n        MAX_SEGMENTS = 20;\n    }\n  }\n\n  /**\n   * Builds a new segment element and appends it to the progress bar.\n   *\n   * @private\n   */\n  buildSegmentEl_() {\n    const segmentProgressBar = this.win_.document.createElement('li');\n    segmentProgressBar.classList.add('i-amphtml-story-page-progress-bar');\n    const segmentProgressValue = this.win_.document.createElement('div');\n    segmentProgressValue.classList.add('i-amphtml-story-page-progress-value');\n    segmentProgressBar.appendChild(segmentProgressValue);\n    this.getRoot().appendChild(segmentProgressBar);\n    this.segments_.push(segmentProgressBar);\n  }\n\n  /**\n   * Clears the progress bar.\n   */\n  clear_() {\n    removeChildren(devAssert(this.root_));\n    this.segmentIdMap_ = map();\n    this.segmentCount_ = 0;\n  }\n\n  /**\n   * Adds a segment to the progress bar.\n   *\n   * @param {string} id The id of the segment.\n   * @private\n   */\n  addSegment_(id) {\n    this.segmentIdMap_[id] = this.segmentCount_++;\n    this.buildSegmentEl_();\n  }\n\n  /**\n   * Gets the root element of the progress bar.\n   *\n   * @return {!Element}\n   */\n  getRoot() {\n    return dev().assertElement(this.root_);\n  }\n\n  /**\n   * Validates that segment id exists.\n   *\n   * @param {string} segmentId The index to assert validity\n   * @private\n   */\n  assertValidSegmentId_(segmentId) {\n    devAssert(\n      hasOwn(this.segmentIdMap_, segmentId),\n      'Invalid segment-id passed to progress-bar'\n    );\n  }\n\n  /**\n   * Updates a segment with its corresponding progress.\n   *\n   * @param {string} segmentId the id of the segment whos progress to change.\n   * @param {number} progress A number from 0.0 to 1.0, representing the\n   *     progress of the current segment.\n   * @param {boolean} updateAllSegments Updates all of the segments.\n   */\n  updateProgress(segmentId, progress, updateAllSegments = false) {\n    this.segmentsAddedPromise_.then(() => {\n      this.assertValidSegmentId_(segmentId);\n      const segmentIndex = this.segmentIdMap_[segmentId];\n\n      this.updateProgressByIndex_(segmentIndex, progress);\n\n      // If updating progress for a new segment, update all the other progress\n      // bar segments.\n      if (this.activeSegmentIndex_ !== segmentIndex || updateAllSegments) {\n        this.updateSegments_(\n          segmentIndex,\n          progress,\n          this.activeSegmentIndex_,\n          this.activeSegmentProgress_\n        );\n      }\n\n      this.activeSegmentProgress_ = progress;\n      this.activeSegmentIndex_ = segmentIndex;\n      this.activeSegmentId_ = segmentId;\n\n      if (this.segmentCount_ > MAX_SEGMENTS) {\n        this.checkIndexForOverflow_();\n      }\n    });\n  }\n\n  /**\n   * Snap the firstExpandedSegmentIndex_ to its most appropiate place, depending\n   * where on the story the user is (could be in the middle of the story).\n   * @param {number} segmentIndex\n   * @private\n   */\n  getInitialFirstExpandedSegmentIndex_(segmentIndex) {\n    if (\n      segmentIndex > MAX_SEGMENTS &&\n      segmentIndex + MAX_SEGMENTS < this.segmentCount_\n    ) {\n      this.firstExpandedSegmentIndex_ =\n        segmentIndex - (segmentIndex % MAX_SEGMENTS);\n    } else if (segmentIndex > MAX_SEGMENTS) {\n      this.firstExpandedSegmentIndex_ = this.segmentCount_ - MAX_SEGMENTS;\n    } else {\n      this.firstExpandedSegmentIndex_ = 0;\n    }\n  }\n\n  /**\n   * Updates all the progress bar segments, and decides whether the update has\n   * to be animated.\n   *\n   * @param {number} activeSegmentIndex\n   * @param {number} activeSegmentProgress\n   * @param {number} prevSegmentIndex\n   * @param {number} prevSegmentProgress\n   * @private\n   */\n  updateSegments_(\n    activeSegmentIndex,\n    activeSegmentProgress,\n    prevSegmentIndex,\n    prevSegmentProgress\n  ) {\n    let shouldAnimatePreviousSegment = false;\n\n    // Animating the transition from one full segment to another, which is the\n    // most common case.\n    if (prevSegmentProgress === 1 && activeSegmentProgress === 1) {\n      shouldAnimatePreviousSegment = true;\n    }\n\n    // When navigating forward, animate the previous segment only if the\n    // following one does not get fully filled.\n    if (activeSegmentIndex > prevSegmentIndex && activeSegmentProgress !== 1) {\n      shouldAnimatePreviousSegment = true;\n    }\n\n    // When navigating backward, animate the previous segment only if the\n    // following one gets fully filled.\n    if (prevSegmentIndex > activeSegmentIndex && activeSegmentProgress === 1) {\n      shouldAnimatePreviousSegment = true;\n    }\n\n    for (let i = 0; i < this.segmentCount_; i++) {\n      // Active segment already gets updated through update progress events\n      // dispatched by its amp-story-page.\n      if (i === activeSegmentIndex) {\n        continue;\n      }\n\n      const progress = i < activeSegmentIndex ? 1 : 0;\n\n      // Only animate the segment corresponding to the previous page, if needed.\n      const withTransition = shouldAnimatePreviousSegment\n        ? i === prevSegmentIndex\n        : false;\n\n      this.updateProgressByIndex_(i, progress, withTransition);\n    }\n  }\n\n  /**\n   * Updates styles to show progress to a corresponding segment.\n   *\n   * @param {number} segmentIndex The index of the progress bar segment whose progress should be\n   *     changed.\n   * @param {number} progress A number from 0.0 to 1.0, representing the\n   *     progress of the current segment.\n   * @param {boolean=} withTransition\n   * @public\n   */\n  updateProgressByIndex_(segmentIndex, progress, withTransition = true) {\n    // Offset the index by 1, since nth-child indices start at 1 while\n    // JavaScript indices start at 0.\n    const nthChildIndex = segmentIndex + 1;\n    const progressEl = scopedQuerySelector(\n      this.getRoot(),\n      `.i-amphtml-story-page-progress-bar:nth-child(${escapeCssSelectorNth(\n        nthChildIndex\n      )}) .i-amphtml-story-page-progress-value`\n    );\n    this.mutator_.mutateElement(devAssert(progressEl), () => {\n      let transition = 'none';\n      if (withTransition) {\n        // Using an eased transition only if filling the bar to 0 or 1.\n        transition =\n          progress === 1 || progress === 0\n            ? TRANSITION_EASE\n            : TRANSITION_LINEAR;\n      }\n      setImportantStyles(devAssert(progressEl), {\n        'transform': scale(`${progress},1`),\n        'transition': transition,\n      });\n    });\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {AMP_STORY_PLAYER_EVENT} from '../../../src/amp-story-player/amp-story-player-impl';\nimport {\n  Action,\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {AmpStoryViewerMessagingHandler} from './amp-story-viewer-messaging-handler';\nimport {CSS} from '../../../build/amp-story-system-layer-1.0.css';\nimport {\n  DevelopmentModeLog,\n  DevelopmentModeLogButtonSet,\n} from './development-ui';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {ProgressBar} from './progress-bar';\nimport {Services} from '../../../src/services';\nimport {\n  closest,\n  matches,\n  scopedQuerySelector,\n} from '../../../src/core/dom/query';\nimport {\n  createShadowRootWithStyle,\n  getStoryAttributeSrc,\n  shouldShowStoryUrlInfo,\n  triggerClickFromLightDom,\n} from './utils';\nimport {dev} from '../../../src/log';\nimport {dict} from '../../../src/core/types/object';\nimport {escapeCssSelectorIdent} from '../../../src/core/dom/css-selectors';\nimport {getMode} from '../../../src/mode';\nimport {getSourceOrigin} from '../../../src/url';\n\nimport {renderAsElement} from './simple-template';\n\nimport {setImportantStyles} from '../../../src/style';\nimport {toArray} from '../../../src/core/types/array';\n\n/** @private @const {string} */\nconst AD_SHOWING_ATTRIBUTE = 'ad-showing';\n\n/** @private @const {string} */\nconst AUDIO_MUTED_ATTRIBUTE = 'muted';\n\n/** @private @const {string} */\nconst PAUSED_ATTRIBUTE = 'paused';\n\n/** @private @const {string} */\nconst HAS_INFO_BUTTON_ATTRIBUTE = 'info';\n\n/** @private @const {string} */\nconst MUTE_CLASS = 'i-amphtml-story-mute-audio-control';\n\n/** @private @const {string} */\nconst CLOSE_CLASS = 'i-amphtml-story-close-control';\n\n/** @private @const {string} */\nconst SKIP_TO_NEXT_CLASS = 'i-amphtml-story-skip-to-next';\n\n/** @private @const {string} */\nconst VIEWER_CUSTOM_CONTROL_CLASS = 'i-amphtml-story-viewer-custom-control';\n\n/** @private @const {string} */\nconst UNMUTE_CLASS = 'i-amphtml-story-unmute-audio-control';\n\n/** @private @const {string} */\nconst PAUSE_CLASS = 'i-amphtml-story-pause-control';\n\n/** @private @const {string} */\nconst PLAY_CLASS = 'i-amphtml-story-play-control';\n\n/** @private @const {string} */\nconst MESSAGE_DISPLAY_CLASS = 'i-amphtml-story-messagedisplay';\n\n/** @private @const {string} */\nconst CURRENT_PAGE_HAS_AUDIO_ATTRIBUTE = 'i-amphtml-current-page-has-audio';\n\n/** @private @const {string} */\nconst HAS_SIDEBAR_ATTRIBUTE = 'i-amphtml-story-has-sidebar';\n\n/** @private @const {string} */\nconst SHARE_CLASS = 'i-amphtml-story-share-control';\n\n/** @private @const {string} */\nconst INFO_CLASS = 'i-amphtml-story-info-control';\n\n/** @private @const {string} */\nconst SIDEBAR_CLASS = 'i-amphtml-story-sidebar-control';\n\n/** @private @const {string} */\nconst HAS_NEW_PAGE_ATTRIBUTE = 'i-amphtml-story-has-new-page';\n\n/** @private @const {string} */\nconst ATTRIBUTION_CLASS = 'i-amphtml-story-attribution';\n\n/** @private @const {number} */\nconst HIDE_MESSAGE_TIMEOUT_MS = 1500;\n\n/** @private @const {!./simple-template.ElementDef} */\nconst TEMPLATE = {\n  tag: 'aside',\n  attrs: dict({\n    'class': 'i-amphtml-story-system-layer i-amphtml-story-system-reset',\n  }),\n  children: [\n    {\n      tag: 'a',\n      attrs: dict({\n        'class': ATTRIBUTION_CLASS,\n        'target': '_blank',\n      }),\n      children: [\n        {\n          tag: 'div',\n          attrs: dict({\n            'class': 'i-amphtml-story-attribution-logo-container',\n          }),\n          children: [\n            {\n              tag: 'img',\n              attrs: dict({\n                'alt': '',\n                'class': 'i-amphtml-story-attribution-logo',\n              }),\n            },\n          ],\n        },\n        {\n          tag: 'div',\n          attrs: dict({\n            'class': 'i-amphtml-story-attribution-text',\n          }),\n        },\n      ],\n    },\n    {\n      tag: 'div',\n      attrs: dict({\n        'class': 'i-amphtml-story-has-new-page-notification-container',\n      }),\n      children: [\n        {\n          tag: 'div',\n          attrs: dict({\n            'class': 'i-amphtml-story-has-new-page-text-wrapper',\n          }),\n          children: [\n            {\n              tag: 'span',\n              attrs: dict({\n                'class': 'i-amphtml-story-has-new-page-circle-icon',\n              }),\n            },\n            {\n              tag: 'div',\n              attrs: dict({\n                'class': 'i-amphtml-story-has-new-page-text',\n              }),\n              localizedStringId: LocalizedStringId.AMP_STORY_HAS_NEW_PAGE_TEXT,\n            },\n          ],\n        },\n      ],\n    },\n    {\n      tag: 'div',\n      attrs: dict({'class': 'i-amphtml-story-system-layer-buttons'}),\n      children: [\n        {\n          tag: 'div',\n          attrs: dict({\n            'role': 'button',\n            'class': INFO_CLASS + ' i-amphtml-story-button',\n          }),\n          localizedLabelId: LocalizedStringId.AMP_STORY_INFO_BUTTON_LABEL,\n        },\n        {\n          tag: 'div',\n          attrs: dict({\n            'class': 'i-amphtml-story-sound-display',\n          }),\n          children: [\n            {\n              tag: 'div',\n              attrs: dict({\n                'role': 'alert',\n                'class': 'i-amphtml-message-container',\n              }),\n              children: [\n                {\n                  tag: 'div',\n                  attrs: dict({\n                    'class': 'i-amphtml-story-mute-text',\n                  }),\n                  localizedStringId:\n                    LocalizedStringId.AMP_STORY_AUDIO_MUTE_BUTTON_TEXT,\n                },\n                {\n                  tag: 'div',\n                  attrs: dict({\n                    'class': 'i-amphtml-story-unmute-sound-text',\n                  }),\n                  localizedStringId:\n                    LocalizedStringId.AMP_STORY_AUDIO_UNMUTE_SOUND_TEXT,\n                },\n                {\n                  tag: 'div',\n                  attrs: dict({\n                    'class': 'i-amphtml-story-unmute-no-sound-text',\n                  }),\n                  localizedStringId:\n                    LocalizedStringId.AMP_STORY_AUDIO_UNMUTE_NO_SOUND_TEXT,\n                },\n              ],\n            },\n            {\n              tag: 'button',\n              attrs: dict({\n                'class': UNMUTE_CLASS + ' i-amphtml-story-button',\n              }),\n              localizedLabelId:\n                LocalizedStringId.AMP_STORY_AUDIO_UNMUTE_BUTTON_LABEL,\n            },\n            {\n              tag: 'button',\n              attrs: dict({\n                'class': MUTE_CLASS + ' i-amphtml-story-button',\n              }),\n              localizedLabelId:\n                LocalizedStringId.AMP_STORY_AUDIO_MUTE_BUTTON_LABEL,\n            },\n          ],\n        },\n        {\n          tag: 'div',\n          attrs: dict({\n            'class': 'i-amphtml-paused-display',\n          }),\n          children: [\n            {\n              tag: 'button',\n              attrs: dict({\n                'class': PAUSE_CLASS + ' i-amphtml-story-button',\n              }),\n              localizedLabelId: LocalizedStringId.AMP_STORY_PAUSE_BUTTON_LABEL,\n            },\n            {\n              tag: 'button',\n              attrs: dict({\n                'class': PLAY_CLASS + ' i-amphtml-story-button',\n              }),\n              localizedLabelId: LocalizedStringId.AMP_STORY_PLAY_BUTTON_LABEL,\n            },\n          ],\n        },\n        {\n          tag: 'button',\n          attrs: dict({\n            'class':\n              SKIP_TO_NEXT_CLASS +\n              ' i-amphtml-story-ui-hide-button i-amphtml-story-button',\n          }),\n          localizedLabelId:\n            LocalizedStringId.AMP_STORY_SKIP_TO_NEXT_BUTTON_LABEL,\n        },\n        {\n          tag: 'button',\n          attrs: dict({\n            'class': SHARE_CLASS + ' i-amphtml-story-button',\n          }),\n          localizedLabelId: LocalizedStringId.AMP_STORY_SHARE_BUTTON_LABEL,\n        },\n        {\n          tag: 'button',\n          attrs: dict({\n            'class': SIDEBAR_CLASS + ' i-amphtml-story-button',\n          }),\n          localizedLabelId: LocalizedStringId.AMP_STORY_SIDEBAR_BUTTON_LABEL,\n        },\n        {\n          tag: 'button',\n          attrs: dict({\n            'class':\n              CLOSE_CLASS +\n              ' i-amphtml-story-ui-hide-button i-amphtml-story-button',\n          }),\n          localizedLabelId: LocalizedStringId.AMP_STORY_CLOSE_BUTTON_LABEL,\n        },\n      ],\n    },\n    {\n      tag: 'div',\n      attrs: dict({\n        'class': 'i-amphtml-story-system-layer-buttons-start-position',\n      }),\n    },\n  ],\n};\n\n/**\n * Contains the event name belonging to the viewer control.\n * @const {string}\n */\nconst VIEWER_CONTROL_EVENT_NAME = '__AMP_VIEWER_CONTROL_EVENT_NAME__';\n\n/** @enum {string} */\nconst VIEWER_CONTROL_TYPES = {\n  CLOSE: 'close',\n  SHARE: 'share',\n  DEPRECATED_SKIP_NEXT: 'skip-next', // Deprecated in favor of SKIP_TO_NEXT.\n  SKIP_TO_NEXT: 'skip-to-next',\n};\n\nconst VIEWER_CONTROL_DEFAULTS = {\n  [VIEWER_CONTROL_TYPES.SHARE]: {\n    'selector': `.${SHARE_CLASS}`,\n  },\n  [VIEWER_CONTROL_TYPES.CLOSE]: {\n    'selector': `.${CLOSE_CLASS}`,\n  },\n  [VIEWER_CONTROL_TYPES.DEPRECATED_SKIP_NEXT]: {\n    'selector': `.${SKIP_TO_NEXT_CLASS}`,\n  },\n  [VIEWER_CONTROL_TYPES.SKIP_TO_NEXT]: {\n    'selector': `.${SKIP_TO_NEXT_CLASS}`,\n  },\n};\n\n/**\n * System Layer (i.e. UI Chrome) for <amp-story>.\n * Chrome contains:\n *   - mute/unmute button\n *   - story progress bar\n *   - share button\n *   - domain info button\n *   - sidebar\n *   - story updated label (for live stories)\n *   - close (for players)\n *   - skip (for players)\n */\nexport class SystemLayer {\n  /**\n   * @param {!Window} win\n   * @param {!Element} parentEl\n   */\n  constructor(win, parentEl) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @protected @const {!Element} */\n    this.parentEl_ = parentEl;\n\n    /** @private {boolean} */\n    this.isBuilt_ = false;\n\n    /**\n     * Root element containing a shadow DOM root.\n     * @private {?Element}\n     */\n    this.root_ = null;\n\n    /**\n     * Actual system layer.\n     * @private {?Element}\n     */\n    this.systemLayerEl_ = null;\n\n    /** @private {?Element} */\n    this.buttonsContainer_ = null;\n\n    /** @private @const {!ProgressBar} */\n    this.progressBar_ = ProgressBar.create(win, this.parentEl_);\n\n    /** @private {!DevelopmentModeLog} */\n    this.developerLog_ = DevelopmentModeLog.create(win);\n\n    /** @private {!DevelopmentModeLogButtonSet} */\n    this.developerButtons_ = DevelopmentModeLogButtonSet.create(win);\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win_);\n\n    /** @const @private {!../../../src/service/vsync-impl.Vsync} */\n    this.vsync_ = Services.vsyncFor(this.win_);\n\n    /** @const @private {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(this.win_);\n\n    /** @private {?number|?string} */\n    this.timeoutId_ = null;\n\n    /** @private {?../../../src/service/viewer-interface.ViewerInterface} */\n    this.viewer_ = null;\n\n    /** @private {?AmpStoryViewerMessagingHandler} */\n    this.viewerMessagingHandler_ = null;\n  }\n\n  /**\n   * @return {!Element}\n   * @param {string} initialPageId\n   */\n  build(initialPageId) {\n    if (this.isBuilt_) {\n      return this.getRoot();\n    }\n\n    this.isBuilt_ = true;\n\n    this.root_ = this.win_.document.createElement('div');\n    this.root_.classList.add('i-amphtml-system-layer-host');\n    this.systemLayerEl_ = renderAsElement(this.win_.document, TEMPLATE);\n    // Make the share button link to the current document to make sure\n    // embedded STAMPs always have a back-link to themselves, and to make\n    // gestures like right-clicks work.\n    this.systemLayerEl_.querySelector('.i-amphtml-story-share-control').href =\n      Services.documentInfoForDoc(this.parentEl_).canonicalUrl;\n\n    createShadowRootWithStyle(this.root_, this.systemLayerEl_, CSS);\n\n    this.systemLayerEl_.insertBefore(\n      this.progressBar_.build(initialPageId),\n      this.systemLayerEl_.firstChild\n    );\n\n    this.buttonsContainer_ = this.systemLayerEl_.querySelector(\n      '.i-amphtml-story-system-layer-buttons'\n    );\n\n    this.buildForDevelopmentMode_();\n\n    this.initializeListeners_();\n\n    this.storeService_.subscribe(\n      StateProperty.CAN_SHOW_SYSTEM_LAYER_BUTTONS,\n      (canShowButtons) => {\n        this.systemLayerEl_.classList.toggle(\n          'i-amphtml-story-ui-no-buttons',\n          !canShowButtons\n        );\n      },\n      true /* callToInitialize */\n    );\n\n    if (Services.platformFor(this.win_).isIos()) {\n      this.systemLayerEl_.setAttribute('ios', '');\n    }\n\n    this.viewer_ = Services.viewerForDoc(this.win_.document.documentElement);\n    this.viewerMessagingHandler_ = this.viewer_.isEmbedded()\n      ? new AmpStoryViewerMessagingHandler(this.win_, this.viewer_)\n      : null;\n\n    if (shouldShowStoryUrlInfo(this.viewer_)) {\n      this.systemLayerEl_.classList.add('i-amphtml-embedded');\n      this.getShadowRoot().setAttribute(HAS_INFO_BUTTON_ATTRIBUTE, '');\n    } else {\n      this.getShadowRoot().removeAttribute(HAS_INFO_BUTTON_ATTRIBUTE);\n    }\n\n    this.maybeBuildAttribution_();\n\n    this.getShadowRoot().setAttribute(MESSAGE_DISPLAY_CLASS, 'noshow');\n    this.getShadowRoot().setAttribute(HAS_NEW_PAGE_ATTRIBUTE, 'noshow');\n    return this.getRoot();\n  }\n\n  /** @private */\n  maybeBuildAttribution_() {\n    if (!this.viewer_ || this.viewer_.getParam('attribution') !== 'auto') {\n      return;\n    }\n\n    this.systemLayerEl_.querySelector('.i-amphtml-story-attribution-logo').src =\n      getStoryAttributeSrc(this.parentEl_, 'entity-logo-src') ||\n      getStoryAttributeSrc(this.parentEl_, 'publisher-logo-src');\n\n    const anchorEl = this.systemLayerEl_.querySelector(\n      `.${escapeCssSelectorIdent(ATTRIBUTION_CLASS)}`\n    );\n\n    anchorEl.href =\n      getStoryAttributeSrc(this.parentEl_, 'entity-url') ||\n      getSourceOrigin(Services.documentInfoForDoc(this.parentEl_).sourceUrl);\n\n    this.systemLayerEl_.querySelector(\n      '.i-amphtml-story-attribution-text'\n    ).textContent =\n      this.parentEl_.getAttribute('entity') ||\n      this.parentEl_.getAttribute('publisher');\n\n    anchorEl.classList.add('i-amphtml-story-attribution-visible');\n  }\n\n  /**\n   * @private\n   */\n  buildForDevelopmentMode_() {\n    if (!getMode().development) {\n      return;\n    }\n\n    this.buttonsContainer_.appendChild(\n      this.developerButtons_.build(\n        this.developerLog_.toggle.bind(this.developerLog_)\n      )\n    );\n    this.getShadowRoot().appendChild(this.developerLog_.build());\n  }\n\n  /**\n   * @private\n   */\n  initializeListeners_() {\n    // TODO(alanorozco): Listen to tap event properly (i.e. fastclick)\n    this.getShadowRoot().addEventListener('click', (event) => {\n      const target = dev().assertElement(event.target);\n\n      if (matches(target, `.${MUTE_CLASS}, .${MUTE_CLASS} *`)) {\n        this.onAudioIconClick_(true);\n      } else if (matches(target, `.${UNMUTE_CLASS}, .${UNMUTE_CLASS} *`)) {\n        this.onAudioIconClick_(false);\n      } else if (matches(target, `.${PAUSE_CLASS}, .${PAUSE_CLASS} *`)) {\n        this.onPausedClick_(true);\n      } else if (matches(target, `.${PLAY_CLASS}, .${PLAY_CLASS} *`)) {\n        this.onPausedClick_(false);\n      } else if (matches(target, `.${SHARE_CLASS}, .${SHARE_CLASS} *`)) {\n        this.onShareClick_(event);\n      } else if (matches(target, `.${INFO_CLASS}, .${INFO_CLASS} *`)) {\n        this.onInfoClick_();\n      } else if (matches(target, `.${SIDEBAR_CLASS}, .${SIDEBAR_CLASS} *`)) {\n        this.onSidebarClick_();\n      } else if (\n        matches(\n          target,\n          `.${VIEWER_CUSTOM_CONTROL_CLASS}, .${VIEWER_CUSTOM_CONTROL_CLASS} *`\n        )\n      ) {\n        this.onViewerControlClick_(dev().assertElement(event.target));\n      } else if (\n        matches(target, `.${ATTRIBUTION_CLASS}, .${ATTRIBUTION_CLASS} *`)\n      ) {\n        const anchorClicked = closest(target, (e) => matches(e, 'a[href]'));\n        triggerClickFromLightDom(anchorClicked, this.parentEl_);\n      }\n    });\n\n    this.storeService_.subscribe(StateProperty.AD_STATE, (isAd) => {\n      this.onAdStateUpdate_(isAd);\n    });\n\n    this.storeService_.subscribe(\n      StateProperty.CAN_SHOW_AUDIO_UI,\n      (show) => {\n        this.onCanShowAudioUiUpdate_(show);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.CAN_SHOW_SHARING_UIS,\n      (show) => {\n        this.onCanShowSharingUisUpdate_(show);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.STORY_HAS_AUDIO_STATE,\n      (hasAudio) => {\n        this.onStoryHasAudioStateUpdate_(hasAudio);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.STORY_HAS_PLAYBACK_UI_STATE,\n      (hasPlaybackUi) => {\n        this.onStoryHasPlaybackUiStateUpdate_(hasPlaybackUi);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.MUTED_STATE,\n      (isMuted) => {\n        this.onMutedStateUpdate_(isMuted);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.UI_STATE,\n      (uiState) => {\n        this.onUIStateUpdate_(uiState);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.PAUSED_STATE,\n      (isPaused) => {\n        this.onPausedStateUpdate_(isPaused);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.CURRENT_PAGE_INDEX,\n      (index) => {\n        this.onPageIndexUpdate_(index);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.RTL_STATE,\n      (rtlState) => {\n        this.onRtlStateUpdate_(rtlState);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.KEYBOARD_ACTIVE_STATE,\n      (keyboardState) => {\n        this.onKeyboardActiveUpdate_(keyboardState);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.PAGE_HAS_AUDIO_STATE,\n      (audio) => {\n        this.onPageHasAudioStateUpdate_(audio);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.PAGE_HAS_ELEMENTS_WITH_PLAYBACK_STATE,\n      (hasPlaybackUi) => {\n        this.onPageHasElementsWithPlaybackStateUpdate_(hasPlaybackUi);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.HAS_SIDEBAR_STATE,\n      (hasSidebar) => {\n        this.onHasSidebarStateUpdate_(hasSidebar);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.SYSTEM_UI_IS_VISIBLE_STATE,\n      (isVisible) => {\n        this.onSystemUiIsVisibleStateUpdate_(isVisible);\n      }\n    );\n\n    this.storeService_.subscribe(StateProperty.NEW_PAGE_AVAILABLE_ID, () => {\n      this.onNewPageAvailable_();\n    });\n\n    this.storeService_.subscribe(\n      StateProperty.VIEWER_CUSTOM_CONTROLS,\n      (config) => this.onViewerCustomControls_(config),\n      true /* callToInitialize */\n    );\n  }\n\n  /**\n   * @return {!Element}\n   */\n  getRoot() {\n    return dev().assertElement(this.root_);\n  }\n\n  /**\n   * @return {!Element}\n   */\n  getShadowRoot() {\n    return dev().assertElement(this.systemLayerEl_);\n  }\n\n  /**\n   * Reacts to the ad state updates and updates the UI accordingly.\n   * @param {boolean} isAd\n   * @private\n   */\n  onAdStateUpdate_(isAd) {\n    // This is not in vsync as we are showing/hiding items in the system layer\n    // based upon this attribute, and when wrapped in vsync there is a visual\n    // lag after the page change before the icons are updated.\n    isAd\n      ? this.getShadowRoot().setAttribute(AD_SHOWING_ATTRIBUTE, '')\n      : this.getShadowRoot().removeAttribute(AD_SHOWING_ATTRIBUTE);\n  }\n\n  /**\n   * Checks if the story has a sidebar in order to display the icon representing\n   * the opening of the sidebar.\n   * @param {boolean} hasSidebar\n   * @private\n   */\n  onHasSidebarStateUpdate_(hasSidebar) {\n    if (hasSidebar) {\n      this.getShadowRoot().setAttribute(HAS_SIDEBAR_ATTRIBUTE, '');\n    } else {\n      this.getShadowRoot().removeAttribute(HAS_SIDEBAR_ATTRIBUTE);\n    }\n  }\n\n  /**\n   * Reacts to updates to whether audio UI may be shown, and updates the UI\n   * accordingly.\n   * @param {boolean} canShowAudioUi\n   * @private\n   */\n  onCanShowAudioUiUpdate_(canShowAudioUi) {\n    this.vsync_.mutate(() => {\n      this.getShadowRoot().classList.toggle(\n        'i-amphtml-story-no-audio-ui',\n        !canShowAudioUi\n      );\n    });\n  }\n\n  /**\n   * Reacts to updates to whether sharing UIs may be shown, and updates the UI\n   * accordingly.\n   * @param {boolean} canShowSharingUis\n   * @private\n   */\n  onCanShowSharingUisUpdate_(canShowSharingUis) {\n    this.vsync_.mutate(() => {\n      this.getShadowRoot().classList.toggle(\n        'i-amphtml-story-no-sharing',\n        !canShowSharingUis\n      );\n    });\n  }\n\n  /**\n   * Reacts to has audio state updates, determining if the story has a global\n   * audio track playing, or if any page has audio.\n   * @param {boolean} hasAudio\n   * @private\n   */\n  onStoryHasAudioStateUpdate_(hasAudio) {\n    this.vsync_.mutate(() => {\n      this.getShadowRoot().classList.toggle(\n        'i-amphtml-story-has-audio',\n        hasAudio\n      );\n    });\n  }\n\n  /**\n   * Reacts to story having elements with playback.\n   * @param {boolean} hasPlaybackUi\n   * @private\n   */\n  onStoryHasPlaybackUiStateUpdate_(hasPlaybackUi) {\n    this.vsync_.mutate(() => {\n      this.getShadowRoot().classList.toggle(\n        'i-amphtml-story-has-playback-ui',\n        hasPlaybackUi\n      );\n    });\n  }\n\n  /**\n   * Reacts to the presence of audio on a page to determine which audio messages\n   * to display.\n   * @param {boolean} pageHasAudio\n   * @private\n   */\n  onPageHasAudioStateUpdate_(pageHasAudio) {\n    pageHasAudio =\n      pageHasAudio ||\n      !!this.storeService_.get(StateProperty.STORY_HAS_BACKGROUND_AUDIO_STATE);\n    this.vsync_.mutate(() => {\n      pageHasAudio\n        ? this.getShadowRoot().setAttribute(\n            CURRENT_PAGE_HAS_AUDIO_ATTRIBUTE,\n            ''\n          )\n        : this.getShadowRoot().removeAttribute(\n            CURRENT_PAGE_HAS_AUDIO_ATTRIBUTE\n          );\n    });\n  }\n\n  /**\n   * Reacts to the presence of elements with playback on the page.\n   * @param {boolean} pageHasElementsWithPlayback\n   * @private\n   */\n  onPageHasElementsWithPlaybackStateUpdate_(pageHasElementsWithPlayback) {\n    this.vsync_.mutate(() => {\n      toArray(\n        this.getShadowRoot().querySelectorAll(\n          '.i-amphtml-paused-display button'\n        )\n      ).forEach((button) => {\n        button.disabled = !pageHasElementsWithPlayback;\n      });\n    });\n  }\n\n  /**\n   * Reacts to muted state updates.\n   * @param {boolean} isMuted\n   * @private\n   */\n  onMutedStateUpdate_(isMuted) {\n    this.vsync_.mutate(() => {\n      isMuted\n        ? this.getShadowRoot().setAttribute(AUDIO_MUTED_ATTRIBUTE, '')\n        : this.getShadowRoot().removeAttribute(AUDIO_MUTED_ATTRIBUTE);\n    });\n  }\n\n  /**\n   * Reacts to paused state updates.\n   * @param {boolean} isPaused\n   * @private\n   */\n  onPausedStateUpdate_(isPaused) {\n    this.vsync_.mutate(() => {\n      isPaused\n        ? this.getShadowRoot().setAttribute(PAUSED_ATTRIBUTE, '')\n        : this.getShadowRoot().removeAttribute(PAUSED_ATTRIBUTE);\n    });\n  }\n\n  /**\n   * Hides message after elapsed time.\n   * @param {string} message\n   * @private\n   */\n  hideMessageAfterTimeout_(message) {\n    if (this.timeoutId_) {\n      this.timer_.cancel(this.timeoutId_);\n    }\n    this.timeoutId_ = this.timer_.delay(\n      () => this.hideMessageInternal_(message),\n      HIDE_MESSAGE_TIMEOUT_MS\n    );\n  }\n\n  /**\n   * Hides message.\n   * @param {string} message\n   * @private\n   */\n  hideMessageInternal_(message) {\n    if (!this.isBuilt_) {\n      return;\n    }\n    this.vsync_.mutate(() => {\n      this.getShadowRoot().setAttribute(message, 'noshow');\n    });\n  }\n\n  /**\n   * Reacts to UI state updates and triggers the expected UI.\n   * @param {!UIType} uiState\n   * @private\n   */\n  onUIStateUpdate_(uiState) {\n    this.vsync_.mutate(() => {\n      const shadowRoot = this.getShadowRoot();\n\n      shadowRoot.classList.remove('i-amphtml-story-desktop-fullbleed');\n      shadowRoot.classList.remove('i-amphtml-story-desktop-panels');\n      shadowRoot.removeAttribute('desktop');\n\n      switch (uiState) {\n        case UIType.DESKTOP_PANELS:\n          shadowRoot.setAttribute('desktop', '');\n          shadowRoot.classList.add('i-amphtml-story-desktop-panels');\n          break;\n        case UIType.DESKTOP_FULLBLEED:\n          shadowRoot.setAttribute('desktop', '');\n          shadowRoot.classList.add('i-amphtml-story-desktop-fullbleed');\n          break;\n      }\n    });\n  }\n\n  /**\n   * Reacts to system UI visibility state updates.\n   * @param {boolean} isVisible\n   * @private\n   */\n  onSystemUiIsVisibleStateUpdate_(isVisible) {\n    this.vsync_.mutate(() => {\n      this.getShadowRoot().classList.toggle(\n        'i-amphtml-story-hidden',\n        !isVisible\n      );\n    });\n  }\n\n  /**\n   * Reacts to the active page index changing.\n   * @param {number} index\n   */\n  onPageIndexUpdate_(index) {\n    this.vsync_.mutate(() => {\n      const lastIndex =\n        this.storeService_.get(StateProperty.PAGE_IDS).length - 1;\n      this.getShadowRoot().classList.toggle(\n        'i-amphtml-first-page-active',\n        index === 0\n      );\n      this.getShadowRoot().classList.toggle(\n        'i-amphtml-last-page-active',\n        index === lastIndex\n      );\n    });\n  }\n\n  /**\n   * Reacts to RTL state updates and triggers the UI for RTL.\n   * @param {boolean} rtlState\n   * @private\n   */\n  onRtlStateUpdate_(rtlState) {\n    this.vsync_.mutate(() => {\n      rtlState\n        ? this.getShadowRoot().setAttribute('dir', 'rtl')\n        : this.getShadowRoot().removeAttribute('dir');\n    });\n  }\n\n  /**\n   * Reacts to keyboard updates and updates the UI.\n   * @param {boolean} keyboardActive\n   * @private\n   */\n  onKeyboardActiveUpdate_(keyboardActive) {\n    this.vsync_.mutate(() => {\n      this.getShadowRoot().classList.toggle(\n        'amp-mode-keyboard-active',\n        keyboardActive\n      );\n    });\n  }\n\n  /**\n   * Handles click events on the mute and unmute buttons.\n   * @param {boolean} mute Specifies if the audio is being muted or unmuted.\n   * @private\n   */\n  onAudioIconClick_(mute) {\n    this.storeService_.dispatch(Action.TOGGLE_MUTED, mute);\n    this.vsync_.mutate(() => {\n      this.getShadowRoot().setAttribute(MESSAGE_DISPLAY_CLASS, 'show');\n      this.hideMessageAfterTimeout_(MESSAGE_DISPLAY_CLASS);\n    });\n  }\n\n  /**\n   * Handles click events on the paused and play buttons.\n   * @param {boolean} paused Specifies if the story is being paused or not.\n   * @private\n   */\n  onPausedClick_(paused) {\n    this.storeService_.dispatch(Action.TOGGLE_PAUSED, paused);\n  }\n\n  /**\n   * Handles click events on the share button and toggles the share menu.\n   * @param {!Event} event\n   * @private\n   */\n  onShareClick_(event) {\n    event.preventDefault();\n    if (event.target[VIEWER_CONTROL_EVENT_NAME]) {\n      this.onViewerControlClick_(dev().assertElement(event.target));\n      return;\n    }\n\n    const isOpen = this.storeService_.get(StateProperty.SHARE_MENU_STATE);\n    this.storeService_.dispatch(Action.TOGGLE_SHARE_MENU, !isOpen);\n  }\n\n  /**\n   * Sends message back to the viewer with the corresponding event.\n   * @param {!Element} element\n   * @private\n   */\n  onViewerControlClick_(element) {\n    const eventName = element[VIEWER_CONTROL_EVENT_NAME];\n\n    this.viewerMessagingHandler_ &&\n      this.viewerMessagingHandler_.send(\n        'documentStateUpdate',\n        dict({\n          'state': AMP_STORY_PLAYER_EVENT,\n          'value': eventName,\n        })\n      );\n  }\n\n  /**\n   * Handles click events on the info button and toggles the info dialog.\n   * @private\n   */\n  onInfoClick_() {\n    const isOpen = this.storeService_.get(StateProperty.INFO_DIALOG_STATE);\n    this.storeService_.dispatch(Action.TOGGLE_INFO_DIALOG, !isOpen);\n  }\n\n  /**\n   * Handles click events on the sidebar button and toggles the sidebar.\n   * @private\n   */\n  onSidebarClick_() {\n    this.storeService_.dispatch(Action.TOGGLE_SIDEBAR, true);\n  }\n\n  /**\n   * Shows the \"story updated\" label when a new page was added to the story.\n   * @private\n   */\n  onNewPageAvailable_() {\n    this.vsync_.mutate(() => {\n      this.getShadowRoot().setAttribute(HAS_NEW_PAGE_ATTRIBUTE, 'show');\n      this.hideMessageAfterTimeout_(HAS_NEW_PAGE_ATTRIBUTE);\n    });\n  }\n\n  /**\n   * Reacts to a custom configuration change coming from the player level.\n   * Updates UI to match configuration described by publisher.\n   * @param {!Array<!../../../src/amp-story-player/amp-story-player-impl.ViewerControlDef>} controls\n   * @private\n   */\n  onViewerCustomControls_(controls) {\n    if (controls.length <= 0) {\n      return;\n    }\n\n    controls.forEach((control) => {\n      if (!control.name) {\n        return;\n      }\n\n      const defaultConfig = VIEWER_CONTROL_DEFAULTS[control.name];\n\n      let element;\n      if (defaultConfig && defaultConfig.selector) {\n        element = scopedQuerySelector(\n          this.getShadowRoot(),\n          defaultConfig.selector\n        );\n      } else {\n        element = this.win_.document.createElement('button');\n        this.vsync_.mutate(() => {\n          element.classList.add('i-amphtml-story-button');\n          this.buttonsContainer_.appendChild(element);\n        });\n      }\n\n      this.vsync_.mutate(() => {\n        element.classList.add(VIEWER_CUSTOM_CONTROL_CLASS);\n      });\n\n      if (control.visibility === 'hidden') {\n        this.vsync_.mutate(() => {\n          element.classList.add('i-amphtml-story-ui-hide-button');\n        });\n      }\n\n      if (!control.visibility || control.visibility === 'visible') {\n        this.vsync_.mutate(() => {\n          dev()\n            .assertElement(element)\n            .classList.remove('i-amphtml-story-ui-hide-button');\n        });\n      }\n\n      if (control.state === 'disabled') {\n        this.vsync_.mutate(() => {\n          element.disabled = true;\n        });\n      }\n\n      if (control.position === 'start') {\n        const startButtonContainer = this.systemLayerEl_.querySelector(\n          '.i-amphtml-story-system-layer-buttons-start-position'\n        );\n\n        this.vsync_.mutate(() => {\n          this.buttonsContainer_.removeChild(element);\n          startButtonContainer.appendChild(element);\n        });\n      }\n\n      if (control.backgroundImageUrl) {\n        setImportantStyles(dev().assertElement(element), {\n          'background-image': `url('${control.backgroundImageUrl}')`,\n        });\n      }\n\n      element[VIEWER_CONTROL_EVENT_NAME] = `amp-story-player-${control.name}`;\n    });\n  }\n\n  /**\n   * @param {string} pageId The id of the page whose progress should be\n   *     changed.\n   * @param {number} progress A number from 0.0 to 1.0, representing the\n   *     progress of the current page.\n   * @public\n   */\n  updateProgress(pageId, progress) {\n    // TODO(newmuis) avoid passing progress logic through system-layer\n    this.progressBar_.updateProgress(pageId, progress);\n  }\n\n  /**\n   * @param {!./logging.AmpStoryLogEntryDef} logEntry\n   * @private\n   */\n  logInternal_(logEntry) {\n    this.developerButtons_.log(logEntry);\n    this.developerLog_.log(logEntry);\n  }\n\n  /**\n   * Logs an array of entries to the developer logs.\n   * @param {!Array<!./logging.AmpStoryLogEntryDef>} logEntries\n   */\n  logAll(logEntries) {\n    if (!getMode().development) {\n      return;\n    }\n\n    this.vsync_.mutate(() => {\n      logEntries.forEach((logEntry) => this.logInternal_(logEntry));\n    });\n  }\n\n  /**\n   * Logs a single entry to the developer logs.\n   * @param {!./logging.AmpStoryLogEntryDef} logEntry\n   */\n  log(logEntry) {\n    if (!getMode().development) {\n      return;\n    }\n\n    this.logInternal_(logEntry);\n  }\n\n  /**\n   * Clears any state held by the developer log or buttons.\n   */\n  resetDeveloperLogs() {\n    if (!getMode().development) {\n      return;\n    }\n\n    this.developerButtons_.clear();\n    this.developerLog_.clear();\n  }\n\n  /**\n   * Sets the string providing context for the developer logs window.  This is\n   * often the name or ID of the element that all logs are for (e.g. the page).\n   * @param {string} contextString\n   */\n  setDeveloperLogContextString(contextString) {\n    if (!getMode().development) {\n      return;\n    }\n\n    this.developerLog_.setContextString(contextString);\n  }\n\n  /**\n   * Hides the developer log in the UI.\n   */\n  hideDeveloperLog() {\n    if (!getMode().development) {\n      return;\n    }\n\n    this.developerLog_.hide();\n  }\n}\n", "export const CSS = \".i-amphtml-story-unsupported-browser-overlay{position:absolute!important;z-index:20000001!important;font-family:Roboto,sans-serif;font-weight:700!important;line-height:1.5;padding:32px;background-color:#000!important;color:#fff!important;top:0!important;left:0!important;right:0!important;bottom:0!important;-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important;text-align:center!important;display:none!important}.i-amphtml-story-unsupported-browser-overlay .i-amphtml-story-overlay-text{color:#fff!important}.i-amphtml-story-unsupported-browser-overlay{display:-ms-flexbox!important;display:flex!important}.i-amphtml-gear-icon{background-repeat:no-repeat!important;background-position:50%!important;border-radius:50%!important;background-color:#fff!important;padding:16px!important;height:24px!important;width:24px!important;margin:16px auto!important;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 20 20'%3E%3Cpath fill='none' d='M0 0h20v20H0V0z'/%3E%3Cpath d='M15.95 10.78c.03-.25.05-.51.05-.78s-.02-.53-.06-.78l1.69-1.32c.15-.12.19-.34.1-.51l-1.6-2.77c-.1-.18-.31-.24-.49-.18l-1.99.8c-.42-.32-.86-.58-1.35-.78L12 2.34a.4.4 0 0 0-.4-.34H8.4c-.2 0-.36.14-.39.34l-.3 2.12c-.49.2-.94.47-1.35.78l-1.99-.8c-.18-.07-.39 0-.49.18l-1.6 2.77c-.1.18-.06.39.1.51l1.69 1.32c-.04.25-.07.52-.07.78s.02.53.06.78L2.37 12.1c-.15.12-.19.34-.1.51l1.6 2.77c.1.18.31.24.49.18l1.99-.8c.42.32.86.58 1.35.78l.3 2.12c.04.2.2.34.4.34h3.2c.2 0 .37-.14.39-.34l.3-2.12c.49-.2.94-.47 1.35-.78l1.99.8c.18.07.39 0 .49-.18l1.6-2.77c.1-.18.06-.39-.1-.51l-1.67-1.32zM10 13c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-continue-button{border-radius:20px;font-family:Roboto,sans-serif;color:#000;font-weight:400!important;font-size:16px;background:#fff;padding:10px 20px;border:2px solid #aaa;text-decoration:none;display:block;margin-top:25px;margin-right:auto;margin-left:auto;-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important;text-align:center!important}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story-unsupported-browser-layer.css*/\";\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Action, getStoreService} from './amp-story-store-service';\nimport {CSS} from '../../../build/amp-story-unsupported-browser-layer-1.0.css';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {createShadowRootWithStyle} from './utils';\nimport {dict} from './../../../src/core/types/object';\nimport {removeElement} from '../../../src/dom';\nimport {renderAsElement} from './simple-template';\n\n/** @const {string} Class for the continue anyway button */\nconst CONTINUE_ANYWAY_BUTTON_CLASS = 'i-amphtml-continue-button';\n/**\n * Full viewport black layer indicating browser is not supported.\n * @private @const {!./simple-template.ElementDef}\n */\nconst UNSUPPORTED_BROWSER_LAYER_TEMPLATE = {\n  tag: 'div',\n  attrs: dict({'class': 'i-amphtml-story-unsupported-browser-overlay'}),\n  children: [\n    {\n      tag: 'div',\n      attrs: dict({'class': 'i-amphtml-overlay-container'}),\n      children: [\n        {\n          tag: 'div',\n          attrs: dict({'class': 'i-amphtml-gear-icon'}),\n        },\n        {\n          tag: 'div',\n          attrs: dict({'class': 'i-amphtml-story-overlay-text'}),\n          localizedStringId:\n            LocalizedStringId.AMP_STORY_WARNING_UNSUPPORTED_BROWSER_TEXT,\n        },\n        // The continue button functionality will only be present in the default\n        // layer. Publisher provided fallbacks will not provide users with the\n        // ability to continue with an unsupported browser\n        {\n          tag: 'button',\n          attrs: dict({'class': 'i-amphtml-continue-button'}),\n          localizedStringId:\n            LocalizedStringId.AMP_STORY_CONTINUE_ANYWAY_BUTTON_LABEL,\n        },\n      ],\n    },\n  ],\n};\n\n/**\n * Unsupported browser layer UI.\n */\nexport class UnsupportedBrowserLayer {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {?Element} */\n    this.root_ = null;\n\n    /** @private {?Element} */\n    this.element_ = null;\n\n    /** @private {?Element} */\n    this.continueButton_ = null;\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win_);\n  }\n\n  /**\n   * Builds and appends the component in the story.\n   * @return {*} TODO(#23582): Specify return type\n   */\n  build() {\n    if (this.root_) {\n      return this.root_;\n    }\n    this.root_ = this.win_.document.createElement('div');\n    this.element_ = renderAsElement(\n      this.win_.document,\n      UNSUPPORTED_BROWSER_LAYER_TEMPLATE\n    );\n    createShadowRootWithStyle(this.root_, this.element_, CSS);\n    this.continueButton_ = this.element_./*OK*/ querySelector(\n      `.${CONTINUE_ANYWAY_BUTTON_CLASS}`\n    );\n    this.continueButton_.addEventListener('click', () => {\n      this.storeService_.dispatch(Action.TOGGLE_SUPPORTED_BROWSER, true);\n    });\n    return this.root_;\n  }\n\n  /**\n   * Returns the unsupported browser componenet\n   * @return {?Element} The root element of the componenet\n   */\n  get() {\n    if (!this.root_) {\n      this.build();\n    }\n    return this.root_;\n  }\n\n  /**\n   * Removes the entire layer\n   */\n  removeLayer() {\n    if (this.root_) {\n      removeElement(this.root_);\n    }\n  }\n}\n", "export const CSS = \":host{all:initial!important;color:initial!important}.i-amphtml-story-no-rotation-overlay{position:absolute!important;z-index:20000000!important;font-family:Roboto,sans-serif!important;font-size:20px!important;font-weight:700!important;line-height:1.5!important;padding:32px!important;background-color:#000!important;color:#fff!important;top:0!important;left:0!important;right:0!important;bottom:0!important;-ms-flex-align:center!important;align-items:center!important;-ms-flex-pack:center!important;justify-content:center!important;text-align:center!important;display:none!important}.i-amphtml-story-no-rotation-overlay .i-amphtml-story-overlay-text{color:#fff!important}.i-amphtml-story-landscape.i-amphtml-story-no-rotation-overlay{display:-ms-flexbox!important;display:flex!important}.i-amphtml-desktop-size-icon,.i-amphtml-rotate-icon{background-repeat:no-repeat!important;background-position:50%!important;border-radius:50%!important;background-color:#fff!important;padding:16px!important;height:24px!important;width:24px!important;margin:16px auto!important}.i-amphtml-rotate-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M16.48 2.52c3.27 1.55 5.61 4.72 5.97 8.48h1.5C23.44 4.84 18.29 0 12 0l-.66.03 3.81 3.81 1.33-1.32zm-6.25-.77a1.49 1.49 0 0 0-2.12 0L1.75 8.11a1.49 1.49 0 0 0 0 2.12l12.02 12.02c.59.59 1.54.59 2.12 0l6.36-6.36c.59-.59.59-1.54 0-2.12L10.23 1.75zm4.6 19.44L2.81 9.17l6.36-6.36 12.02 12.02-6.36 6.36zm-7.31.29A10.487 10.487 0 0 1 1.55 13H.05C.56 19.16 5.71 24 12 24l.66-.03-3.81-3.81-1.33 1.32z'/%3E%3C/svg%3E\\\")!important}.i-amphtml-desktop-size-icon{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M12.01 5.5 10 8h4l-1.99-2.5zM18 10v4l2.5-1.99L18 10zM6 10l-2.5 2.01L6 14v-4zm8 6h-4l2.01 2.5L14 16zm7-13H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16.01H3V4.99h18v14.02z'/%3E%3C/svg%3E\\\")!important}\\n/*# sourceURL=/extensions/amp-story/1.0/amp-story-viewport-warning-layer.css*/\";\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CSS} from '../../../build/amp-story-viewport-warning-layer-1.0.css';\nimport {LocalizedStringId} from '../../../src/localized-strings';\nimport {Services} from '../../../src/services';\nimport {\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {createShadowRootWithStyle} from './utils';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {htmlFor} from '../../../src/static-template';\nimport {listen} from '../../../src/event-helper';\nimport {throttle} from '../../../src/core/types/function';\n\n/**\n * CSS class indicating the format is landscape.\n * @const {string}\n */\nconst LANDSCAPE_OVERLAY_CLASS = 'i-amphtml-story-landscape';\n\n/** @const {number} */\nconst RESIZE_THROTTLE_MS = 300;\n\n/**\n * Viewport warning layer template.\n * @param {!Element} element\n * @return {!Element}\n */\nconst getTemplate = (element) => {\n  return htmlFor(element)`\n    <div class=\"\n        i-amphtml-story-no-rotation-overlay i-amphtml-story-system-reset\">\n      <div class=\"i-amphtml-overlay-container\">\n        <div class=\"i-amphtml-story-overlay-icon\"></div>\n        <div class=\"i-amphtml-story-overlay-text\"></div>\n      </div>\n    </div>\n  `;\n};\n\n/**\n * Viewport warning layer UI.\n */\nexport class ViewportWarningLayer {\n  /**\n   * @param {!Window} win\n   * @param {!Element} storyElement Element where to append the component\n   * @param {number} desktopWidthThreshold Threshold in px.\n   * @param {number} desktopHeightThreshold Threshold in px.\n   */\n  constructor(\n    win,\n    storyElement,\n    desktopWidthThreshold,\n    desktopHeightThreshold\n  ) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {number} */\n    this.desktopHeightThreshold_ = desktopHeightThreshold;\n\n    /** @private {number} */\n    this.desktopWidthThreshold_ = desktopWidthThreshold;\n\n    /** @private {boolean} */\n    this.isBuilt_ = false;\n\n    /** @private {?../../../src/service/localization.LocalizationService} */\n    this.localizationService_ = null;\n\n    /** @private {?Element} */\n    this.overlayEl_ = null;\n\n    /** @private @const {!../../../src/service/platform-impl.Platform} */\n    this.platform_ = Services.platformFor(this.win_);\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win_);\n\n    /** @private @const {!Element} */\n    this.storyElement_ = storyElement;\n\n    /** @private {?Function} */\n    this.unlistenResizeEvents_ = null;\n\n    /** @const @private {!../../../src/service/vsync-impl.Vsync} */\n    this.vsync_ = Services.vsyncFor(this.win_);\n\n    this.initializeListeners_();\n  }\n\n  /**\n   * Builds and appends the component in the story.\n   */\n  build() {\n    if (this.isBuilt()) {\n      return;\n    }\n\n    this.overlayEl_ = this.getViewportWarningOverlayTemplate_();\n    this.localizationService_ = getLocalizationService(this.storyElement_);\n\n    this.isBuilt_ = true;\n    const root = this.win_.document.createElement('div');\n\n    createShadowRootWithStyle(root, this.overlayEl_, CSS);\n\n    // Initializes the UI state now that the component is built.\n    this.onUIStateUpdate_(\n      /** @type {!UIType} */\n      (this.storeService_.get(StateProperty.UI_STATE))\n    );\n\n    this.vsync_.mutate(() => {\n      this.storyElement_.insertBefore(root, this.storyElement_.firstChild);\n    });\n  }\n\n  /**\n   * Whether the element has been built.\n   * @return {boolean}\n   */\n  isBuilt() {\n    return this.isBuilt_;\n  }\n\n  /**\n   * @private\n   */\n  initializeListeners_() {\n    this.storeService_.subscribe(\n      StateProperty.UI_STATE,\n      (uiState) => {\n        this.onUIStateUpdate_(uiState);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.VIEWPORT_WARNING_STATE,\n      (viewportWarningState) => {\n        this.onViewportWarningStateUpdate_(viewportWarningState);\n      },\n      true /** callToInitialize */\n    );\n  }\n\n  /**\n   * Reacts to the viewport warning state update, only on mobile.\n   * @param {boolean} viewportWarningState\n   * @private\n   */\n  onViewportWarningStateUpdate_(viewportWarningState) {\n    const isMobile =\n      this.storeService_.get(StateProperty.UI_STATE) === UIType.MOBILE;\n\n    // Adds the landscape class if we are mobile landscape.\n    const shouldShowLandscapeOverlay = isMobile && viewportWarningState;\n\n    // Don't build the layer until we need to display it.\n    if (!shouldShowLandscapeOverlay && !this.isBuilt()) {\n      return;\n    }\n\n    this.build();\n\n    // Listen to resize events to update the UI message.\n    if (viewportWarningState) {\n      const resizeThrottle = throttle(\n        this.win_,\n        () => this.onResize_(),\n        RESIZE_THROTTLE_MS\n      );\n      this.unlistenResizeEvents_ = listen(this.win_, 'resize', resizeThrottle);\n    } else if (this.unlistenResizeEvents_) {\n      this.unlistenResizeEvents_();\n      this.unlistenResizeEvents_ = null;\n    }\n\n    this.updateTextContent_();\n\n    this.vsync_.mutate(() => {\n      this.overlayEl_.classList.toggle(\n        LANDSCAPE_OVERLAY_CLASS,\n        shouldShowLandscapeOverlay\n      );\n    });\n  }\n\n  /**\n   * Reacts to UI state updates.\n   * @param {!UIType} uiState\n   * @private\n   */\n  onUIStateUpdate_(uiState) {\n    if (!this.isBuilt()) {\n      return;\n    }\n\n    this.vsync_.mutate(() => {\n      uiState === UIType.DESKTOP_PANELS\n        ? this.overlayEl_.setAttribute('desktop', '')\n        : this.overlayEl_.removeAttribute('desktop');\n    });\n  }\n\n  /**\n   * @private\n   */\n  onResize_() {\n    this.updateTextContent_();\n  }\n\n  /**\n   * Returns the overlay corresponding to the device currently used.\n   * @return {!Element} template\n   * @private\n   */\n  getViewportWarningOverlayTemplate_() {\n    const template = getTemplate(this.storyElement_);\n    const iconEl = template.querySelector('.i-amphtml-story-overlay-icon');\n\n    if (this.platform_.isIos() || this.platform_.isAndroid()) {\n      iconEl.classList.add('i-amphtml-rotate-icon');\n      return template;\n    }\n\n    iconEl.classList.add('i-amphtml-desktop-size-icon');\n    return template;\n  }\n\n  /**\n   * Updates the UI message displayed to the user.\n   * @private\n   */\n  updateTextContent_() {\n    const textEl = this.overlayEl_.querySelector(\n      '.i-amphtml-story-overlay-text'\n    );\n    let textContent;\n\n    this.vsync_.run({\n      measure: () => {\n        textContent = this.getTextContent_();\n      },\n      mutate: () => {\n        if (!textContent) {\n          return;\n        }\n\n        textEl.textContent = textContent;\n      },\n    });\n  }\n\n  /**\n   * Gets the localized message to display, depending on the viewport size. Has\n   * to run during a measure phase.\n   * @return {?string}\n   * @private\n   */\n  getTextContent_() {\n    if (this.platform_.isIos() || this.platform_.isAndroid()) {\n      return this.localizationService_.getLocalizedString(\n        LocalizedStringId.AMP_STORY_WARNING_LANDSCAPE_ORIENTATION_TEXT\n      );\n    }\n\n    const viewportHeight = this.win_./*OK*/ innerHeight;\n    const viewportWidth = this.win_./*OK*/ innerWidth;\n\n    if (\n      viewportHeight < this.desktopHeightThreshold_ &&\n      viewportWidth < this.desktopWidthThreshold_\n    ) {\n      return this.localizationService_.getLocalizedString(\n        LocalizedStringId.AMP_STORY_WARNING_DESKTOP_SIZE_TEXT\n      );\n    }\n\n    if (viewportWidth < this.desktopWidthThreshold_) {\n      return this.localizationService_.getLocalizedString(\n        LocalizedStringId.AMP_STORY_WARNING_DESKTOP_WIDTH_SIZE_TEXT\n      );\n    }\n\n    if (viewportHeight < this.desktopHeightThreshold_) {\n      return this.localizationService_.getLocalizedString(\n        LocalizedStringId.AMP_STORY_WARNING_DESKTOP_HEIGHT_SIZE_TEXT\n      );\n    }\n\n    return null;\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  CONSENT_POLICY_STATE, // eslint-disable-line no-unused-vars\n} from './core/constants/consent-state';\nimport {Services} from './services';\nimport {dict} from './core/types/object';\n\n/**\n * Returns a promise that resolve when all consent state the policy wait\n * for resolve. Or if consent service is not available.\n * @param {!Element|!ShadowRoot} element\n * @param {string=} policyId\n * @return {!Promise<?CONSENT_POLICY_STATE>}\n */\nexport function getConsentPolicyState(element, policyId = 'default') {\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    (consentPolicy) => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.whenPolicyResolved(/** @type {string} */ (policyId));\n    }\n  );\n}\n\n/**\n * Returns a promise that resolves to a sharedData retrieved from consent\n * remote endpoint.\n * @param {!Element|!ShadowRoot} element\n * @param {string} policyId\n * @return {!Promise<?Object>}\n */\nexport function getConsentPolicySharedData(element, policyId) {\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    (consentPolicy) => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.getMergedSharedData(\n        /** @type {string} */ (policyId)\n      );\n    }\n  );\n}\n\n/**\n * @param {!Element|!ShadowRoot} element\n * @param {string=} policyId\n * @return {!Promise<string>}\n */\nexport function getConsentPolicyInfo(element, policyId = 'default') {\n  // Return the stored consent string.\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    (consentPolicy) => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.getConsentStringInfo(\n        /** @type {string} */ (policyId)\n      );\n    }\n  );\n}\n\n/**\n * @param {!Element|!ShadowRoot} element\n * @param {string=} policyId\n * @return {!Promise<?Object|undefined>}\n */\nexport function getConsentMetadata(element, policyId = 'default') {\n  // Return the stored consent metadata.\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    (consentPolicy) => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.getConsentMetadataInfo(\n        /** @type {string} */ (policyId)\n      );\n    }\n  );\n}\n\n/**\n * Returns a set of consent values to forward to a 3rd party (like an iframe).\n * @param {!Element} element\n * @param {?string=} opt_policyId\n * @return {!Promise<!JsonObject>}\n *   See extensions/amp-consent/customizing-extension-behaviors-on-consent.md:\n *    - consentMetadata\n *    - consentString\n *    - consentPolicyState\n *    - consentPolicySharedData\n */\nexport function getConsentDataToForward(element, opt_policyId) {\n  return Services.consentPolicyServiceForDocOrNull(element).then((policy) => {\n    const gettersOrNull = dict({\n      'consentMetadata': policy && policy.getConsentMetadataInfo,\n      'consentString': policy && policy.getConsentStringInfo,\n      'consentPolicyState': policy && policy.whenPolicyResolved,\n      'consentPolicySharedData': policy && policy.getMergedSharedData,\n    });\n    if (!policy) {\n      return gettersOrNull;\n    }\n    return /** @type {!JsonObject} */ (\n      Promise.all(\n        Object.keys(gettersOrNull).map((key) =>\n          gettersOrNull[key]\n            .call(policy, opt_policyId || 'default')\n            .then((value) => ({[key]: value}))\n        )\n      ).then((objs) => Object.assign.apply({}, objs))\n    );\n  });\n}\n\n/**\n * Determine if an element needs to be blocked by consent based on meta tags.\n * @param {*} element\n * @return {boolean}\n */\nexport function shouldBlockOnConsentByMeta(element) {\n  const ampdoc = element.getAmpDoc();\n  let content = ampdoc.getMetaByName('amp-consent-blocking');\n  if (!content) {\n    return false;\n  }\n\n  // Handles whitespace\n  content = content.toUpperCase().replace(/\\s+/g, '');\n\n  const contents = /** @type {Array<string>} */ (content.split(','));\n  return contents.includes(element.tagName);\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {dev} from '../../../src/log';\nimport {registerServiceBuilder} from '../../../src/service';\n\n/**\n * Util function to retrieve the media query service. Ensures we can retrieve\n * the service synchronously from the amp-story codebase without running into\n * race conditions.\n * @param  {!Window} win\n * @return {!AmpStoryMediaQueryService}\n */\nexport const getMediaQueryService = (win) => {\n  let service = Services.storyMediaQueryService(win);\n\n  if (!service) {\n    service = new AmpStoryMediaQueryService(win);\n    registerServiceBuilder(win, 'story-media-query', function () {\n      return service;\n    });\n  }\n\n  return service;\n};\n\n/**\n * Media query service.\n */\nexport class AmpStoryMediaQueryService {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {?Promise} */\n    this.initializePromise_ = null;\n\n    /** @private {?Element} Iframe matcher. */\n    this.matcher_ = null;\n\n    /** @private @const {!Element} */\n    this.storyEl_ = dev().assertElement(\n      this.win_.document.querySelector('amp-story')\n    );\n  }\n\n  /**\n   * Registers the media query and triggering the provided callback on match.\n   * @param {string} media The media query, ie: '(orientation: portrait)'\n   * @param {function(boolean)} callback Called when the media query matches.\n   * @return {!Promise<!MediaQueryList>}\n   */\n  onMediaQueryMatch(media, callback) {\n    return this.initialize_().then(() => {\n      const mediaQueryList = this.matcher_.contentWindow.matchMedia(media);\n      mediaQueryList.addListener((event) => callback(event.matches));\n      callback(mediaQueryList.matches);\n      return mediaQueryList;\n    });\n  }\n\n  /**\n   * Creates an iframe that is positioned like an amp-story-page, used to match\n   * media queries.\n   * @return {!Promise} Resolves when the iframe is ready.\n   * @private\n   */\n  initialize_() {\n    if (this.initializePromise_) {\n      return this.initializePromise_;\n    }\n\n    this.initializePromise_ = new Promise((resolve) => {\n      this.matcher_ = this.win_.document.createElement('iframe');\n      this.matcher_.classList.add('i-amphtml-story-media-query-matcher');\n      this.matcher_.onload = resolve;\n      this.storyEl_.appendChild(this.matcher_);\n    });\n\n    return this.initializePromise_;\n  }\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Embeds a story\n *\n * Example:\n * <code>\n * <amp-story standalone>\n *   [...]\n * </amp-story>\n * </code>\n */\nimport './amp-story-cta-layer';\nimport './amp-story-grid-layer';\nimport './amp-story-page';\nimport {\n  Action,\n  EmbeddedComponentState,\n  InteractiveComponentDef,\n  StateProperty,\n  UIType,\n  getStoreService,\n} from './amp-story-store-service';\nimport {ActionTrust} from '../../../src/core/constants/action-constants';\nimport {AdvancementConfig, TapNavigationDirection} from './page-advancement';\nimport {\n  AdvancementMode,\n  StoryAnalyticsEvent,\n  getAnalyticsService,\n} from './story-analytics';\nimport {AmpEvents} from '../../../src/core/constants/amp-events';\nimport {AmpStoryAccess} from './amp-story-access';\nimport {AmpStoryConsent} from './amp-story-consent';\nimport {AmpStoryCtaLayer} from './amp-story-cta-layer';\nimport {AmpStoryEmbeddedComponent} from './amp-story-embedded-component';\nimport {AmpStoryGridLayer} from './amp-story-grid-layer';\nimport {AmpStoryHint} from './amp-story-hint';\nimport {AmpStoryPage, NavigationDirection, PageState} from './amp-story-page';\nimport {AmpStoryPageAttachment} from './amp-story-page-attachment';\nimport {AmpStoryRenderService} from './amp-story-render-service';\nimport {AmpStoryViewerMessagingHandler} from './amp-story-viewer-messaging-handler';\nimport {AnalyticsVariable, getVariableService} from './variable-service';\nimport {CSS} from '../../../build/amp-story-1.0.css';\nimport {CommonSignals} from '../../../src/core/constants/common-signals';\nimport {EventType, dispatch} from './events';\nimport {Gestures} from '../../../src/gesture';\nimport {HistoryState, getHistoryState, setHistoryState} from './history';\nimport {InfoDialog} from './amp-story-info-dialog';\nimport {Keys} from '../../../src/core/constants/key-codes';\nimport {Layout} from '../../../src/layout';\nimport {LiveStoryManager} from './live-story-manager';\nimport {MediaPool, MediaType} from './media-pool';\nimport {PaginationButtons} from './pagination-buttons';\nimport {Services} from '../../../src/services';\nimport {ShareMenu} from './amp-story-share-menu';\nimport {SwipeXYRecognizer} from '../../../src/gesture-recognizers';\nimport {SystemLayer} from './amp-story-system-layer';\nimport {UnsupportedBrowserLayer} from './amp-story-unsupported-browser-layer';\nimport {ViewportWarningLayer} from './amp-story-viewport-warning-layer';\nimport {VisibilityState} from '../../../src/core/constants/visibility-state';\nimport {\n  childElement,\n  childElementByTag,\n  childElements,\n  childNodes,\n  closest,\n  matches,\n  scopedQuerySelector,\n  scopedQuerySelectorAll,\n} from '../../../src/core/dom/query';\nimport {computedStyle, setImportantStyles, toggle} from '../../../src/style';\nimport {createPseudoLocale} from '../../../src/localized-strings';\nimport {debounce} from '../../../src/core/types/function';\nimport {dev, devAssert, user} from '../../../src/log';\nimport {dict, map} from '../../../src/core/types/object';\nimport {endsWith} from '../../../src/core/types/string';\nimport {escapeCssSelectorIdent} from '../../../src/core/dom/css-selectors';\nimport {findIndex, lastItem, toArray} from '../../../src/core/types/array';\nimport {getConsentPolicyState} from '../../../src/consent';\nimport {getDetail} from '../../../src/event-helper';\nimport {getLocalizationService} from './amp-story-localization-service';\nimport {getMediaQueryService} from './amp-story-media-query-service';\nimport {getMode, isModeDevelopment} from '../../../src/mode';\nimport {getState} from '../../../src/core/window/history';\nimport {isExperimentOn} from '../../../src/experiments';\nimport {isPageAttachmentUiV2ExperimentOn} from './amp-story-page-attachment-ui-v2';\nimport {isRTL, whenUpgradedToCustomElement} from '../../../src/dom';\n\nimport {parseQueryString} from '../../../src/core/types/string/url';\nimport {\n  removeAttributeInMutate,\n  setAttributeInMutate,\n  shouldShowStoryUrlInfo,\n} from './utils';\n\nimport {upgradeBackgroundAudio} from './audio';\nimport LocalizedStringsAr from './_locales/ar.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsDe from './_locales/de.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsDefault from './_locales/default.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsEn from './_locales/en.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsEnGb from './_locales/en-GB.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsEs from './_locales/es.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsEs419 from './_locales/es-419.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsFr from './_locales/fr.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsHi from './_locales/hi.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsId from './_locales/id.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsIt from './_locales/it.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsJa from './_locales/ja.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsKo from './_locales/ko.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsNl from './_locales/nl.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsNo from './_locales/no.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsPtBr from './_locales/pt-BR.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsPtPt from './_locales/pt-PT.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsRu from './_locales/ru.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsTr from './_locales/tr.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsVi from './_locales/vi.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsZhCn from './_locales/zh-CN.json' assert {type: 'json'}; // lgtm[js/syntax-error]\nimport LocalizedStringsZhTw from './_locales/zh-TW.json' assert {type: 'json'}; // lgtm[js/syntax-error]\n\n/** @private @const {number} */\nconst DESKTOP_WIDTH_THRESHOLD = 1024;\n\n/** @private @const {number} */\nconst DESKTOP_HEIGHT_THRESHOLD = 550;\n\n/** @private @const {number} */\nconst MIN_SWIPE_FOR_HINT_OVERLAY_PX = 50;\n\n/** @enum {string} */\nconst Attributes = {\n  AD_SHOWING: 'ad-showing',\n  ADVANCE_TO: 'i-amphtml-advance-to',\n  AUTO_ADVANCE_AFTER: 'auto-advance-after',\n  AUTO_ADVANCE_TO: 'auto-advance-to',\n  DESKTOP_POSITION: 'i-amphtml-desktop-position',\n  MUTED: 'muted',\n  ORIENTATION: 'orientation',\n  PUBLIC_ADVANCE_TO: 'advance-to',\n  RETURN_TO: 'i-amphtml-return-to',\n  STANDALONE: 'standalone',\n  SUPPORTS_LANDSCAPE: 'supports-landscape',\n  // Attributes that desktop css looks for to decide where pages will be placed\n  VISITED: 'i-amphtml-visited', // stacked offscreen to left\n};\n\n/**\n * The duration of time (in milliseconds) to wait for the Story initial content\n * to be loaded before marking the story as loaded.\n * @const {number}\n */\nconst INITIAL_CONTENT_LOAD_TIMEOUT_MS = 8000;\n\n/**\n * Single page ads may be injected later. If the original story contains 0 media\n * elements the mediaPool will not be able to handle the injected audio/video\n * Therefore we preallocate a minimum here.\n * @const {number}\n */\nconst MINIMUM_AD_MEDIA_ELEMENTS = 2;\n\n/**\n * CSS class for an amp-story that indicates the initial load for the story has\n * completed.\n * @const {string}\n */\nconst STORY_LOADED_CLASS_NAME = 'i-amphtml-story-loaded';\n\n/**\n * CSS class for the opacity layer that separates the amp-sidebar and the rest\n * of the story when the amp-sidebar is entering the screen.\n * @const {string}\n */\nconst OPACITY_MASK_CLASS_NAME = 'i-amphtml-story-opacity-mask';\n\n/**\n * CSS class for sidebars in stories.\n * @const {string}\n */\nconst SIDEBAR_CLASS_NAME = 'i-amphtml-story-sidebar';\n\n/** @const {!Object<string, number>} */\nconst MAX_MEDIA_ELEMENT_COUNTS = {\n  [MediaType.AUDIO]: 4,\n  [MediaType.VIDEO]: 8,\n};\n\n/** @type {string} */\nconst TAG = 'amp-story';\n\n/**\n * The default dark gray for chrome supported theme color.\n * @const {string}\n */\nconst DEFAULT_THEME_COLOR = '#202125';\n\n/**\n * MutationObserverInit options to listen for changes to the `open` attribute.\n */\nconst SIDEBAR_OBSERVER_OPTIONS = {\n  attributes: true,\n  attributeFilter: ['open'],\n};\n\n/**\n * @implements {./media-pool.MediaPoolRoot}\n */\nexport class AmpStory extends AMP.BaseElement {\n  /** @override @nocollapse */\n  static prerenderAllowed() {\n    return true;\n  }\n\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n\n    /** @private @const {!./amp-story-store-service.AmpStoryStoreService} */\n    this.storeService_ = getStoreService(this.win);\n\n    // Check if story is RTL.\n    if (isRTL(this.win.document)) {\n      this.storeService_.dispatch(Action.TOGGLE_RTL, true);\n    }\n\n    /** @private {!./story-analytics.StoryAnalyticsService} */\n    this.analyticsService_ = getAnalyticsService(this.win, this.element);\n\n    /** @private @const {!AdvancementConfig} */\n    this.advancement_ = AdvancementConfig.forElement(this.win, this.element);\n    this.advancement_.start();\n\n    /** @const @private {!../../../src/service/vsync-impl.Vsync} */\n    this.vsync_ = this.getVsync();\n\n    /** @private @const {!ShareMenu} Preloads and prerenders the share menu. */\n    this.shareMenu_ = new ShareMenu(this.win, this.element);\n\n    /** @private @const {!SystemLayer} */\n    this.systemLayer_ = new SystemLayer(this.win, this.element);\n\n    /** Instantiate in case there are embedded components. */\n    new AmpStoryEmbeddedComponent(this.win, this.element);\n\n    /** @private @const {!UnsupportedBrowserLayer} */\n    this.unsupportedBrowserLayer_ = new UnsupportedBrowserLayer(this.win);\n\n    /** Instantiates the viewport warning layer. */\n    new ViewportWarningLayer(\n      this.win,\n      this.element,\n      DESKTOP_WIDTH_THRESHOLD,\n      DESKTOP_HEIGHT_THRESHOLD\n    );\n\n    /** @private {!Array<!./amp-story-page.AmpStoryPage>} */\n    this.pages_ = [];\n\n    /** @private @const {!Array<!./amp-story-page.AmpStoryPage>} */\n    this.adPages_ = [];\n\n    /** @const @private {!./variable-service.AmpStoryVariableService} */\n    this.variableService_ = getVariableService(this.win);\n\n    /** @private {?./amp-story-page.AmpStoryPage} */\n    this.activePage_ = null;\n\n    /** @private @const */\n    this.desktopMedia_ = this.win.matchMedia(\n      `(min-width: ${DESKTOP_WIDTH_THRESHOLD}px) and ` +\n        `(min-height: ${DESKTOP_HEIGHT_THRESHOLD}px)`\n    );\n\n    /** @private @const */\n    this.canRotateToDesktopMedia_ = this.win.matchMedia(\n      `(min-width: ${DESKTOP_HEIGHT_THRESHOLD}px) and ` +\n        `(min-height: ${DESKTOP_WIDTH_THRESHOLD}px)`\n    );\n\n    /** @private @const */\n    this.landscapeOrientationMedia_ = this.win.matchMedia(\n      '(orientation: landscape)'\n    );\n\n    /** @private {?HTMLMediaElement} */\n    this.backgroundAudioEl_ = null;\n\n    /** @private {!AmpStoryHint} */\n    this.ampStoryHint_ = new AmpStoryHint(this.win, this.element);\n\n    /** @private {!MediaPool} */\n    this.mediaPool_ = MediaPool.for(this);\n\n    /** @private {boolean} */\n    this.areAccessAuthorizationsCompleted_ = false;\n\n    /** @private */\n    this.navigateToPageAfterAccess_ = null;\n\n    /** @private @const {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(this.win);\n\n    /** @private @const {!../../../src/service/platform-impl.Platform} */\n    this.platform_ = Services.platformFor(this.win);\n\n    /** @private {?../../../src/service/viewer-interface.ViewerInterface} */\n    this.viewer_ = null;\n\n    /** @private {?AmpStoryViewerMessagingHandler} */\n    this.viewerMessagingHandler_ = null;\n\n    /** @private {?../../../src/service/localization.LocalizationService} */\n    this.localizationService_ = null;\n\n    /**\n     * Store the current paused state, to make sure the story does not play on\n     * resume if it was previously paused. null when nothing to restore.\n     * @private {?boolean}\n     */\n    this.pausedStateToRestore_ = null;\n\n    /** @private {?Element} */\n    this.sidebar_ = null;\n\n    /** @private {?MutationObserver} */\n    this.sidebarObserver_ = null;\n\n    /** @private {?Element} */\n    this.maskElement_ = null;\n\n    /** @private {?LiveStoryManager} */\n    this.liveStoryManager_ = null;\n  }\n\n  /** @override */\n  buildCallback() {\n    this.viewer_ = Services.viewerForDoc(this.element);\n\n    this.viewerMessagingHandler_ = this.viewer_.isEmbedded()\n      ? new AmpStoryViewerMessagingHandler(this.win, this.viewer_)\n      : null;\n\n    this.localizationService_ = getLocalizationService(this.element);\n\n    this.localizationService_\n      .registerLocalizedStringBundle('default', LocalizedStringsDefault)\n      .registerLocalizedStringBundle('ar', LocalizedStringsAr)\n      .registerLocalizedStringBundle('de', LocalizedStringsDe)\n      .registerLocalizedStringBundle('en', LocalizedStringsEn)\n      .registerLocalizedStringBundle('en-GB', LocalizedStringsEnGb)\n      .registerLocalizedStringBundle('es', LocalizedStringsEs)\n      .registerLocalizedStringBundle('es-419', LocalizedStringsEs419)\n      .registerLocalizedStringBundle('fr', LocalizedStringsFr)\n      .registerLocalizedStringBundle('hi', LocalizedStringsHi)\n      .registerLocalizedStringBundle('id', LocalizedStringsId)\n      .registerLocalizedStringBundle('it', LocalizedStringsIt)\n      .registerLocalizedStringBundle('ja', LocalizedStringsJa)\n      .registerLocalizedStringBundle('ko', LocalizedStringsKo)\n      .registerLocalizedStringBundle('nl', LocalizedStringsNl)\n      .registerLocalizedStringBundle('no', LocalizedStringsNo)\n      .registerLocalizedStringBundle('pt-PT', LocalizedStringsPtPt)\n      .registerLocalizedStringBundle('pt-BR', LocalizedStringsPtBr)\n      .registerLocalizedStringBundle('ru', LocalizedStringsRu)\n      .registerLocalizedStringBundle('tr', LocalizedStringsTr)\n      .registerLocalizedStringBundle('vi', LocalizedStringsVi)\n      .registerLocalizedStringBundle('zh-CN', LocalizedStringsZhCn)\n      .registerLocalizedStringBundle('zh-TW', LocalizedStringsZhTw);\n\n    const enXaPseudoLocaleBundle = createPseudoLocale(\n      LocalizedStringsEn,\n      (s) => `[${s} one two]`\n    );\n    this.localizationService_.registerLocalizedStringBundle(\n      'en-xa',\n      enXaPseudoLocaleBundle\n    );\n\n    if (this.isStandalone_()) {\n      this.initializeStandaloneStory_();\n    }\n\n    // buildCallback already runs in a mutate context. Calling another\n    // mutateElement explicitly will force the runtime to remeasure the\n    // amp-story element, fixing rendering bugs where the story is inactive\n    // (layoutCallback not called) when accessed from any viewer using\n    // prerendering, because of a height incorrectly set to 0.\n    this.mutateElement(() => {});\n\n    const pageId = this.getInitialPageId_();\n    if (pageId) {\n      const page = this.element.querySelector(\n        `amp-story-page#${escapeCssSelectorIdent(pageId)}`\n      );\n      page.setAttribute('active', '');\n    }\n\n    this.initializeStyles_();\n    this.initializeListeners_();\n    this.initializeListenersForDev_();\n    this.initializePageIds_();\n    this.initializeStoryPlayer_();\n\n    this.storeService_.dispatch(Action.TOGGLE_UI, this.getUIType_());\n\n    // Removes title in order to prevent incorrect titles appearing on link\n    // hover. (See 17654)\n    if (!this.platform_.isBot()) {\n      this.element.removeAttribute('title');\n    }\n\n    // Remove text nodes which would be shown outside of the amp-story\n    const textNodes = childNodes(\n      this.element,\n      (node) => node.nodeType === Node.TEXT_NODE\n    );\n    textNodes.forEach((node) => {\n      this.element.removeChild(node);\n    });\n\n    if (isExperimentOn(this.win, 'amp-story-branching')) {\n      this.registerAction('goToPage', (invocation) => {\n        const {args} = invocation;\n        if (!args) {\n          return;\n        }\n        this.storeService_.dispatch(\n          Action.SET_ADVANCEMENT_MODE,\n          AdvancementMode.GO_TO_PAGE\n        );\n        // If open, closes the sidebar before navigating.\n        const promise = this.storeService_.get(StateProperty.SIDEBAR_STATE)\n          ? Services.historyForDoc(this.getAmpDoc()).goBack()\n          : Promise.resolve();\n        promise.then(() =>\n          this.switchTo_(args['id'], NavigationDirection.NEXT)\n        );\n      });\n    }\n\n    if (this.maybeLoadStoryDevTools_()) {\n      return;\n    }\n  }\n\n  /**\n   * Pauses the whole story on viewer visibilityState updates, or tab visibility\n   * updates.\n   * @private\n   */\n  pause_() {\n    // Preserve if previously set. This method can be called several times when\n    // setting the visibilitystate to paused and then inactive.\n    if (this.pausedStateToRestore_ === null) {\n      this.pausedStateToRestore_ = !!this.storeService_.get(\n        StateProperty.PAUSED_STATE\n      );\n    }\n    this.storeService_.dispatch(Action.TOGGLE_PAUSED, true);\n    if (!this.storeService_.get(StateProperty.MUTED_STATE)) {\n      this.pauseBackgroundAudio_();\n    }\n    // If viewer has navigated to the next document, reset the active page.\n    if (this.getAmpDoc().getVisibilityState() === VisibilityState.INACTIVE) {\n      this.activePage_.setState(PageState.NOT_ACTIVE);\n      this.activePage_.element.setAttribute('active', '');\n    }\n  }\n\n  /**\n   * Resumes the whole story on viewer visibilityState updates, or tab\n   * visibility updates.\n   * @private\n   */\n  resume_() {\n    this.storeService_.dispatch(\n      Action.TOGGLE_PAUSED,\n      this.pausedStateToRestore_\n    );\n    this.pausedStateToRestore_ = null;\n    if (!this.storeService_.get(StateProperty.MUTED_STATE)) {\n      this.playBackgroundAudio_();\n    }\n  }\n\n  /**\n   * Note: runs in the buildCallback vsync mutate context.\n   * @private\n   */\n  initializeStandaloneStory_() {\n    const html = this.win.document.documentElement;\n    html.classList.add('i-amphtml-story-standalone');\n    // Lock body to prevent overflow.\n    this.lockBody_();\n    // Standalone CSS affects sizing of the entire page.\n    this.onResize();\n  }\n\n  /** @private */\n  initializeStyles_() {\n    const mediaQueryEls = this.element.querySelectorAll('media-query');\n\n    if (mediaQueryEls.length) {\n      this.initializeMediaQueries_(mediaQueryEls);\n    }\n\n    const styleEl = this.win.document.querySelector('style[amp-custom]');\n\n    if (styleEl) {\n      this.rewriteStyles_(styleEl);\n    }\n  }\n\n  /**\n   * Registers the media queries\n   * @param {!NodeList<!Element>} mediaQueryEls\n   * @private\n   */\n  initializeMediaQueries_(mediaQueryEls) {\n    const service = getMediaQueryService(this.win);\n\n    const onMediaQueryMatch = (matches, className) => {\n      this.mutateElement(() => {\n        this.element.classList.toggle(className, matches);\n      });\n    };\n\n    toArray(mediaQueryEls).forEach((el) => {\n      const className = el.getAttribute('class-name');\n      const media = el.getAttribute('media');\n\n      if (className && media) {\n        service.onMediaQueryMatch(media, (matches) =>\n          onMediaQueryMatch(matches, className)\n        );\n      }\n    });\n  }\n\n  /**\n   * Initializes page ids by deduplicating them.\n   * @private\n   */\n  initializePageIds_() {\n    const pageEls = this.element.querySelectorAll('amp-story-page');\n    const pageIds = toArray(pageEls).map((el) => el.id || 'default-page');\n    const idsMap = map();\n    for (let i = 0; i < pageIds.length; i++) {\n      if (idsMap[pageIds[i]] === undefined) {\n        idsMap[pageIds[i]] = 0;\n        continue;\n      }\n      user().error(TAG, `Duplicate amp-story-page ID ${pageIds[i]}`);\n      const newId = `${pageIds[i]}__${++idsMap[pageIds[i]]}`;\n      pageEls[i].id = newId;\n      pageIds[i] = newId;\n    }\n    this.storeService_.dispatch(Action.SET_PAGE_IDS, pageIds);\n  }\n\n  /**\n   * @param {!Element} styleEl\n   * @private\n   */\n  rewriteStyles_(styleEl) {\n    // TODO(#15955): Update this to use CssContext from\n    // ../../../extensions/amp-animation/0.1/web-animations.js\n    this.mutateElement(() => {\n      styleEl.textContent = styleEl.textContent\n        .replace(/(-?[\\d.]+)vh/gim, 'calc($1 * var(--story-page-vh))')\n        .replace(/(-?[\\d.]+)vw/gim, 'calc($1 * var(--story-page-vw))')\n        .replace(/(-?[\\d.]+)vmin/gim, 'calc($1 * var(--story-page-vmin))')\n        .replace(/(-?[\\d.]+)vmax/gim, 'calc($1 * var(--story-page-vmax))');\n    });\n  }\n\n  /**\n   * @private\n   */\n  setThemeColor_() {\n    // Don't override the publisher's tag.\n    if (this.win.document.querySelector('meta[name=theme-color]')) {\n      return;\n    }\n    // The theme color should be copied from the story's primary accent color\n    // if possible, with the fall back being default dark gray.\n    const meta = this.win.document.createElement('meta');\n    const ampStoryPageEl = this.element.querySelector('amp-story-page');\n    meta.name = 'theme-color';\n    meta.content =\n      computedStyle(this.win, this.element).getPropertyValue(\n        '--primary-color'\n      ) ||\n      computedStyle(\n        this.win,\n        dev().assertElement(ampStoryPageEl)\n      ).getPropertyValue('background-color') ||\n      DEFAULT_THEME_COLOR;\n    this.win.document.head.appendChild(meta);\n  }\n\n  /**\n   * Builds the system layer DOM.\n   * @param {string} initialPageId\n   * @private\n   */\n  buildSystemLayer_(initialPageId) {\n    this.updateAudioIcon_();\n    this.updatePausedIcon_();\n    this.element.appendChild(this.systemLayer_.build(initialPageId));\n  }\n\n  /** @private */\n  initializeListeners_() {\n    this.element.addEventListener(EventType.NEXT_PAGE, () => {\n      this.next_();\n    });\n\n    this.element.addEventListener(EventType.PREVIOUS_PAGE, () => {\n      this.previous_();\n    });\n\n    this.storeService_.subscribe(\n      StateProperty.MUTED_STATE,\n      (isMuted) => {\n        this.onMutedStateUpdate_(isMuted);\n        this.variableService_.onVariableUpdate(\n          AnalyticsVariable.STORY_IS_MUTED,\n          isMuted\n        );\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.MUTED_STATE,\n      (isMuted) => {\n        // We do not want to trigger an analytics event for the initialization of\n        // the muted state.\n        this.analyticsService_.triggerEvent(\n          isMuted\n            ? StoryAnalyticsEvent.STORY_MUTED\n            : StoryAnalyticsEvent.STORY_UNMUTED\n        );\n      },\n      false /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.SUPPORTED_BROWSER_STATE,\n      (isBrowserSupported) => {\n        this.onSupportedBrowserStateUpdate_(isBrowserSupported);\n      }\n    );\n\n    this.storeService_.subscribe(StateProperty.ADVANCEMENT_MODE, (mode) => {\n      this.variableService_.onVariableUpdate(\n        AnalyticsVariable.STORY_ADVANCEMENT_MODE,\n        mode\n      );\n    });\n\n    this.storeService_.subscribe(\n      StateProperty.CAN_SHOW_AUDIO_UI,\n      (show) => {\n        this.element.classList.toggle('i-amphtml-story-no-audio-ui', !show);\n      },\n      true /** callToInitialize */\n    );\n\n    this.element.addEventListener(EventType.SWITCH_PAGE, (e) => {\n      this.switchTo_(getDetail(e)['targetPageId'], getDetail(e)['direction']);\n      this.ampStoryHint_.hideAllNavigationHint();\n    });\n\n    this.element.addEventListener(EventType.PAGE_PROGRESS, (e) => {\n      const detail = getDetail(e);\n      const pageId = detail['pageId'];\n      const progress = detail['progress'];\n\n      if (pageId !== this.activePage_.element.id) {\n        // Ignore progress update events from inactive pages.\n        return;\n      }\n\n      if (!this.activePage_.isAd()) {\n        this.systemLayer_.updateProgress(pageId, progress);\n      }\n    });\n\n    this.element.addEventListener(EventType.REPLAY, () => {\n      this.replay_();\n    });\n\n    this.element.addEventListener(EventType.NO_NEXT_PAGE, () => {\n      this.onNoNextPage_();\n    });\n\n    this.element.addEventListener(EventType.NO_PREVIOUS_PAGE, () => {\n      this.onNoPreviousPage_();\n    });\n\n    this.advancement_.addOnTapNavigationListener((direction) => {\n      this.performTapNavigation_(direction);\n    });\n\n    this.element.addEventListener(EventType.DISPATCH_ACTION, (e) => {\n      if (!getMode().test) {\n        return;\n      }\n\n      const action = getDetail(e)['action'];\n      const data = getDetail(e)['data'];\n      this.storeService_.dispatch(action, data);\n    });\n\n    // Actions allowlist could be initialized empty, or with some actions some\n    // other components registered.\n    this.storeService_.subscribe(\n      StateProperty.ACTIONS_ALLOWLIST,\n      (actionsAllowlist) => {\n        const actions = Services.actionServiceForDoc(this.element);\n        actions.setAllowlist(actionsAllowlist);\n      },\n      true /** callToInitialize */\n    );\n\n    this.storeService_.subscribe(StateProperty.AD_STATE, (isAd) => {\n      this.onAdStateUpdate_(isAd);\n    });\n\n    if (isPageAttachmentUiV2ExperimentOn(this.win)) {\n      this.storeService_.subscribe(\n        StateProperty.PAGE_ATTACHMENT_STATE,\n        (isActive) => {\n          this.onAttachmentStateUpdate_(isActive);\n        }\n      );\n    }\n\n    this.storeService_.subscribe(StateProperty.PAUSED_STATE, (isPaused) => {\n      this.onPausedStateUpdate_(isPaused);\n    });\n\n    this.storeService_.subscribe(\n      StateProperty.SIDEBAR_STATE,\n      (sidebarState) => {\n        this.onSidebarStateUpdate_(sidebarState);\n      }\n    );\n\n    this.storeService_.subscribe(\n      StateProperty.UI_STATE,\n      (uiState) => {\n        this.onUIStateUpdate_(uiState);\n      },\n      true /** callToInitialize */\n    );\n\n    this.win.document.addEventListener(\n      'keydown',\n      (e) => {\n        this.onKeyDown_(e);\n      },\n      true\n    );\n\n    this.win.document.addEventListener('contextmenu', (e) => {\n      const uiState = this.storeService_.get(StateProperty.UI_STATE);\n      if (uiState === UIType.MOBILE) {\n        if (!this.allowContextMenuOnMobile_(e.target)) {\n          e.preventDefault();\n        }\n        e.stopPropagation();\n      }\n    });\n\n    this.getAmpDoc().onVisibilityChanged(() => this.onVisibilityChanged_());\n\n    this.win.addEventListener('hashchange', () => {\n      const maybePageId = parseQueryString(this.win.location.hash)['page'];\n      if (!maybePageId || !this.isActualPage_(maybePageId)) {\n        return;\n      }\n      this.switchTo_(maybePageId, NavigationDirection.NEXT);\n      // Removes the page 'hash' parameter from the URL.\n      let href = this.win.location.href.replace(\n        new RegExp(`page=${maybePageId}&?`),\n        ''\n      );\n      if (endsWith(href, '#')) {\n        href = href.slice(0, -1);\n      }\n      this.win.history.replaceState(\n        (this.win.history && getState(this.win.history)) || {} /** data */,\n        this.win.document.title /** title */,\n        href /** URL */\n      );\n    });\n\n    // Listen for class mutations on the <body> element.\n    const bodyElObserver = new this.win.MutationObserver((mutations) =>\n      this.onBodyElMutation_(mutations)\n    );\n    bodyElObserver.observe(this.win.document.body, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n\n    this.getViewport().onResize(debounce(this.win, () => this.onResize(), 300));\n    this.installGestureRecognizers_();\n\n    // TODO(gmajoulet): migrate this to amp-story-viewer-messaging-handler once\n    // there is a way to navigate to pages that does not involve using private\n    // amp-story methods.\n    this.viewer_.onMessage('selectPage', (data) => this.onSelectPage_(data));\n    this.viewer_.onMessage('rewind', () => this.onRewind_());\n\n    if (this.viewerMessagingHandler_) {\n      this.viewerMessagingHandler_.startListening();\n    }\n  }\n\n  /** @private */\n  onBodyElMutation_(mutations) {\n    mutations.forEach((mutation) => {\n      const bodyEl = dev().assertElement(mutation.target);\n\n      // Updates presence of the `amp-mode-keyboard-active` class on the store.\n      this.storeService_.dispatch(\n        Action.TOGGLE_KEYBOARD_ACTIVE_STATE,\n        bodyEl.classList.contains('amp-mode-keyboard-active')\n      );\n    });\n  }\n\n  /** @private */\n  installGestureRecognizers_() {\n    // If the story is within a viewer that enabled the swipe capability, this\n    // disables the navigation education overlay to enable:\n    //   - horizontal swipe events to the next story\n    //   - vertical swipe events to close the viewer, or open a page attachment\n    if (this.viewer_.hasCapability('swipe')) {\n      return;\n    }\n\n    const {element} = this;\n    const gestures = Gestures.get(element, /* shouldNotPreventDefault */ true);\n\n    // Shows \"tap to navigate\" hint when swiping.\n    gestures.onGesture(SwipeXYRecognizer, (gesture) => {\n      const {deltaX, deltaY} = gesture.data;\n      const embedComponent = /** @type {InteractiveComponentDef} */ (\n        this.storeService_.get(StateProperty.INTERACTIVE_COMPONENT_STATE)\n      );\n      // TODO(enriqe): Move to a separate file if this keeps growing.\n      if (\n        embedComponent.state !== EmbeddedComponentState.HIDDEN ||\n        this.storeService_.get(StateProperty.ACCESS_STATE) ||\n        this.storeService_.get(StateProperty.SIDEBAR_STATE) ||\n        !this.storeService_.get(StateProperty.SYSTEM_UI_IS_VISIBLE_STATE) ||\n        !this.storeService_.get(StateProperty.CAN_SHOW_NAVIGATION_OVERLAY_HINT)\n      ) {\n        // Cancels the event for this gesture entirely, ensuring the hint won't\n        // show even if the user keeps swiping without releasing the touch.\n        if (gesture.event && gesture.event.cancelable !== false) {\n          gesture.event.preventDefault();\n        }\n        return;\n      }\n      if (\n        (gesture.event && gesture.event.defaultPrevented) ||\n        !this.isSwipeLargeEnoughForHint_(deltaX, deltaY)\n      ) {\n        return;\n      }\n\n      this.ampStoryHint_.showNavigationOverlay();\n    });\n  }\n\n  /**\n   * @param {number} deltaX\n   * @param {number} deltaY\n   * @return {boolean}\n   * @private\n   */\n  isSwipeLargeEnoughForHint_(deltaX, deltaY) {\n    const sideSwipe = Math.abs(deltaX) >= MIN_SWIPE_FOR_HINT_OVERLAY_PX;\n    const upSwipe = -1 * deltaY >= MIN_SWIPE_FOR_HINT_OVERLAY_PX;\n    return sideSwipe || upSwipe;\n  }\n\n  /** @private */\n  initializeListenersForDev_() {\n    if (!getMode().development) {\n      return;\n    }\n\n    this.element.addEventListener(EventType.DEV_LOG_ENTRIES_AVAILABLE, (e) => {\n      this.systemLayer_.logAll(/** @type {?} */ (getDetail(e)));\n    });\n  }\n\n  /** @private */\n  lockBody_() {\n    const {document} = this.win;\n    setImportantStyles(document.documentElement, {\n      'overflow': 'hidden',\n    });\n    setImportantStyles(document.body, {\n      'overflow': 'hidden',\n    });\n\n    this.getViewport().resetTouchZoom();\n    this.getViewport().disableTouchZoom();\n    this.maybeLockScreenOrientation_();\n  }\n\n  /** @private */\n  maybeLockScreenOrientation_() {\n    const {screen} = this.win;\n    if (!screen || !this.canRotateToDesktopMedia_.matches) {\n      return;\n    }\n\n    const lockOrientation =\n      screen.lockOrientation ||\n      screen.mozLockOrientation ||\n      screen.msLockOrientation ||\n      ((unusedOrientation) => {});\n\n    try {\n      lockOrientation('portrait');\n    } catch (e) {\n      dev().warn(TAG, 'Failed to lock screen orientation:', e.message);\n    }\n  }\n\n  /** @override */\n  layoutCallback() {\n    if (!AmpStory.isBrowserSupported(this.win) && !this.platform_.isBot()) {\n      this.storeService_.dispatch(Action.TOGGLE_SUPPORTED_BROWSER, false);\n      return Promise.resolve();\n    }\n    return this.layoutStory_();\n  }\n\n  /**\n   * Renders the layout for the story.\n   * @return {!Promise} A promise that is resolved when the story layout is\n   *       loaded\n   * @private\n   */\n  layoutStory_() {\n    const initialPageId = this.getInitialPageId_();\n\n    this.buildSystemLayer_(initialPageId);\n    this.initializeSidebar_();\n    this.setThemeColor_();\n\n    const storyLayoutPromise = Promise.all([\n      this.getAmpDoc().whenFirstVisible(), // Pauses execution during prerender.\n      this.initializePages_(),\n    ])\n      .then(() => {\n        this.handleConsentExtension_();\n        this.initializeStoryAccess_();\n\n        this.pages_.forEach((page, index) => {\n          page.setState(PageState.NOT_ACTIVE);\n          this.upgradeCtaAnchorTagsForTracking_(page, index);\n        });\n        this.initializeStoryNavigationPath_();\n\n        // Build pagination buttons if they can be displayed.\n        if (this.storeService_.get(StateProperty.CAN_SHOW_PAGINATION_BUTTONS)) {\n          new PaginationButtons(this);\n        }\n      })\n      .then(() =>\n        // We need to call this.getInitialPageId_() again because the initial\n        // page could've changed between the start of layoutStory_ and here.\n        this.switchTo_(this.getInitialPageId_(), NavigationDirection.NEXT)\n      )\n      .then(() => {\n        const shouldReOpenAttachmentForPageId = getHistoryState(\n          this.win,\n          HistoryState.ATTACHMENT_PAGE_ID\n        );\n\n        if (shouldReOpenAttachmentForPageId === this.activePage_.element.id) {\n          this.activePage_.openAttachment(false /** shouldAnimate */);\n        }\n\n        // Preloads and prerenders the share menu.\n        this.shareMenu_.build();\n\n        const infoDialog = shouldShowStoryUrlInfo(devAssert(this.viewer_))\n          ? new InfoDialog(this.win, this.element)\n          : null;\n        if (infoDialog) {\n          infoDialog.build();\n        }\n      });\n\n    // Do not block the layout callback on the completion of these promises, as\n    // that prevents descendents from being laid out (and therefore loaded).\n    storyLayoutPromise\n      .then(() =>\n        this.whenInitialContentLoaded_(INITIAL_CONTENT_LOAD_TIMEOUT_MS)\n      )\n      .then(() => {\n        this.markStoryAsLoaded_();\n        this.initializeLiveStory_();\n      });\n\n    this.maybeLoadStoryEducation_();\n\n    // Story is being prerendered: resolve the layoutCallback when the active\n    // page is built. Other pages will only build if the document becomes\n    // visible.\n    const initialPageEl = this.element.querySelector(\n      `amp-story-page#${escapeCssSelectorIdent(initialPageId)}`\n    );\n    if (!this.getAmpDoc().hasBeenVisible()) {\n      return whenUpgradedToCustomElement(initialPageEl).then(() => {\n        return initialPageEl.build();\n      });\n    }\n\n    // Will resolve when all pages are built.\n    return storyLayoutPromise;\n  }\n\n  /**\n   * Initialize LiveStoryManager if this is a live story.\n   * @private\n   */\n  initializeLiveStory_() {\n    if (this.element.hasAttribute('live-story')) {\n      this.liveStoryManager_ = new LiveStoryManager(this);\n      this.liveStoryManager_.build();\n\n      this.storeService_.dispatch(Action.ADD_TO_ACTIONS_ALLOWLIST, [\n        {tagOrTarget: 'AMP-LIVE-LIST', method: 'update'},\n      ]);\n\n      this.element.addEventListener(AmpEvents.DOM_UPDATE, () => {\n        this.liveStoryManager_.update();\n        this.initializePages_().then(() => {\n          this.preloadPagesByDistance_();\n          if (\n            this.storeService_.get(StateProperty.UI_STATE) ===\n            UIType.DESKTOP_PANELS\n          ) {\n            this.setDesktopPositionAttributes_(this.activePage_);\n          }\n        });\n      });\n    }\n  }\n\n  /**\n   * Retrieves the initial pageId to begin the story with. In order, the\n   * initial page for a story should be either a valid page ID in the URL\n   * fragment, the page ID in the history, or the first page of the story.\n   * @return {?string}\n   * @private\n   */\n  getInitialPageId_() {\n    const maybePageId = parseQueryString(this.win.location.hash)['page'];\n    if (maybePageId && this.isActualPage_(maybePageId)) {\n      return maybePageId;\n    }\n\n    const pages = /**  @type {!Array} */ (\n      getHistoryState(this.win, HistoryState.NAVIGATION_PATH) || []\n    );\n    const historyPage = lastItem(pages);\n    if (historyPage && this.isActualPage_(historyPage)) {\n      return historyPage;\n    }\n\n    const firstPageEl = this.element.querySelector('amp-story-page');\n    return firstPageEl ? firstPageEl.id : null;\n  }\n\n  /**\n   * Checks if the amp-story-page for a given ID exists.\n   * Note: the `this.pages_` array might not be defined yet.\n   * @param {string} pageId\n   * @return {boolean}\n   * @private\n   */\n  isActualPage_(pageId) {\n    if (this.pages_.length > 0) {\n      return this.pages_.some((page) => page.element.id === pageId);\n    }\n    return !!this.element.querySelector(`#${escapeCssSelectorIdent(pageId)}`);\n  }\n\n  /**\n   * @param {number} timeoutMs The maximum amount of time to wait, in\n   *     milliseconds.\n   * @return {!Promise} A promise that is resolved when the initial content is\n   *     loaded or the timeout has been exceeded, whichever happens first.\n   * @private\n   */\n  whenInitialContentLoaded_(timeoutMs = 0) {\n    const pagesToWaitFor =\n      this.storeService_.get(StateProperty.UI_STATE) === UIType.DESKTOP_PANELS\n        ? [this.pages_[0], this.pages_[1]]\n        : [this.pages_[0]];\n\n    const storyLoadPromise = Promise.all(\n      pagesToWaitFor\n        .filter(Boolean)\n        .map((page) =>\n          page.element.signals().whenSignal(CommonSignals.LOAD_END)\n        )\n    );\n\n    return this.timer_\n      .timeoutPromise(timeoutMs, storyLoadPromise)\n      .catch(() => {});\n  }\n\n  /** @private */\n  markStoryAsLoaded_() {\n    dispatch(\n      this.win,\n      this.element,\n      EventType.STORY_LOADED,\n      /* payload */ undefined,\n      {bubbles: true}\n    );\n    this.viewerMessagingHandler_ &&\n      this.viewerMessagingHandler_.send('storyContentLoaded', dict({}));\n    this.analyticsService_.triggerEvent(\n      StoryAnalyticsEvent.STORY_CONTENT_LOADED\n    );\n    this.signals().signal(CommonSignals.INI_LOAD);\n    this.mutateElement(() => {\n      this.element.classList.add(STORY_LOADED_CLASS_NAME);\n    });\n  }\n\n  /**\n   * Handles the story consent extension.\n   * @private\n   */\n  handleConsentExtension_() {\n    const consentEl = this.element.querySelector('amp-consent');\n    if (!consentEl) {\n      return;\n    }\n\n    this.pauseStoryUntilConsentIsResolved_();\n    this.validateConsent_(consentEl);\n  }\n\n  /**\n   * Pauses the story until the consent is resolved (accepted or rejected).\n   * @private\n   */\n  pauseStoryUntilConsentIsResolved_() {\n    const policyId = this.getConsentPolicy() || 'default';\n    const consentPromise = getConsentPolicyState(this.element, policyId);\n\n    if (!consentPromise) {\n      return;\n    }\n\n    this.storeService_.dispatch(Action.TOGGLE_PAUSED, true);\n\n    consentPromise.then(() => {\n      this.storeService_.dispatch(Action.TOGGLE_PAUSED, false);\n    });\n  }\n\n  /**\n   * Ensures publishers using amp-consent use amp-story-consent.\n   * @param {!Element} consentEl\n   * @private\n   */\n  validateConsent_(consentEl) {\n    if (!childElementByTag(consentEl, 'amp-story-consent')) {\n      user().error(TAG, 'amp-consent must have an amp-story-consent child');\n    }\n\n    const allowedTags = ['SCRIPT', 'AMP-STORY-CONSENT'];\n    const toRemoveChildren = childElements(\n      consentEl,\n      (el) => allowedTags.indexOf(el.tagName) === -1\n    );\n\n    if (toRemoveChildren.length === 0) {\n      return;\n    }\n    user().error(TAG, 'amp-consent only allows tags: %s', allowedTags);\n    toRemoveChildren.forEach((el) => consentEl.removeChild(el));\n  }\n\n  /**\n   * @private\n   */\n  initializeStoryAccess_() {\n    Services.accessServiceForDocOrNull(this.element).then((accessService) => {\n      if (!accessService) {\n        return;\n      }\n\n      this.areAccessAuthorizationsCompleted_ =\n        accessService.areFirstAuthorizationsCompleted();\n      accessService.onApplyAuthorizations(() =>\n        this.onAccessApplyAuthorizations_()\n      );\n\n      const firstPage = this.pages_[0].element;\n\n      // First amp-story-page can't be paywall protected.\n      // Removes the access attributes, and throws an error during development.\n      if (\n        firstPage.hasAttribute('amp-access') ||\n        firstPage.hasAttribute('amp-access-hide')\n      ) {\n        firstPage.removeAttribute('amp-access');\n        firstPage.removeAttribute('amp-access-hide');\n        user().error(\n          TAG,\n          'First amp-story-page cannot have amp-access ' +\n            'or amp-access-hide attributes'\n        );\n      }\n    });\n  }\n\n  /**\n   * On amp-access document reauthorization, maybe hide the access UI, and maybe\n   * perform navigation.\n   * @private\n   */\n  onAccessApplyAuthorizations_() {\n    this.areAccessAuthorizationsCompleted_ = true;\n\n    const nextPage = this.navigateToPageAfterAccess_;\n\n    // Step out if the next page is still hidden by the access extension.\n    if (nextPage && nextPage.element.hasAttribute('amp-access-hide')) {\n      return;\n    }\n\n    if (nextPage) {\n      this.navigateToPageAfterAccess_ = null;\n      this.switchTo_(nextPage.element.id, NavigationDirection.NEXT);\n    }\n\n    this.storeService_.dispatch(Action.TOGGLE_ACCESS, false);\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return layout == Layout.CONTAINER;\n  }\n\n  /** @private */\n  initializePages_() {\n    const pageImplPromises = Array.prototype.map.call(\n      this.element.querySelectorAll('amp-story-page'),\n      (pageEl) => pageEl.getImpl()\n    );\n\n    return Promise.all(pageImplPromises).then((pages) => {\n      this.pages_ = pages;\n      if (isExperimentOn(this.win, 'amp-story-branching')) {\n        this.storeService_.dispatch(Action.ADD_TO_ACTIONS_ALLOWLIST, [\n          {tagOrTarget: 'AMP-STORY', method: 'goToPage'},\n        ]);\n      }\n    });\n  }\n\n  /**\n   * Advance to the next screen in the story, if there is one.\n   * @param {boolean=} opt_isAutomaticAdvance Whether this navigation was caused\n   *     by an automatic advancement after a timeout.\n   * @private\n   */\n  next_(opt_isAutomaticAdvance) {\n    const activePage = devAssert(\n      this.activePage_,\n      'No active page set when navigating to next page.'\n    );\n    activePage.next(opt_isAutomaticAdvance);\n  }\n\n  /**\n   * Installs amp-viewer-integration script in case story is inside an\n   * amp-story-player.\n   * @private\n   */\n  initializeStoryPlayer_() {\n    if (this.viewer_.getParam('storyPlayer') !== 'v0') {\n      return;\n    }\n    Services.extensionsFor(this.win).installExtensionForDoc(\n      this.getAmpDoc(),\n      'amp-viewer-integration'\n    );\n  }\n\n  /**\n   * Handles EventType.NO_NEXT_PAGE events.\n   * @private\n   */\n  onNoNextPage_() {\n    if (this.viewer_.hasCapability('swipe') && this.viewerMessagingHandler_) {\n      const advancementMode = this.storeService_.get(\n        StateProperty.ADVANCEMENT_MODE\n      );\n      this.viewerMessagingHandler_.send(\n        'selectDocument',\n        dict({'next': true, 'advancementMode': advancementMode})\n      );\n      return;\n    }\n  }\n\n  /**\n   * Go back to the previous screen in the story, if there is one.\n   * @private\n   */\n  previous_() {\n    const activePage = devAssert(\n      this.activePage_,\n      'No active page set when navigating to previous page.'\n    );\n    activePage.previous();\n  }\n\n  /**\n   * Handles EventType.NO_PREVIOUS_PAGE events.\n   * @private\n   */\n  onNoPreviousPage_() {\n    if (this.viewer_.hasCapability('swipe') && this.viewerMessagingHandler_) {\n      const advancementMode = this.storeService_.get(\n        StateProperty.ADVANCEMENT_MODE\n      );\n      this.viewerMessagingHandler_.send(\n        'selectDocument',\n        dict({'previous': true, 'advancementMode': advancementMode})\n      );\n      return;\n    }\n\n    if (this.storeService_.get(StateProperty.CAN_SHOW_PREVIOUS_PAGE_HELP)) {\n      this.ampStoryHint_.showFirstPageHintOverlay();\n    }\n  }\n\n  /**\n   * @param {number} direction The direction to navigate.\n   * @private\n   */\n  performTapNavigation_(direction) {\n    this.storeService_.dispatch(\n      Action.SET_ADVANCEMENT_MODE,\n      AdvancementMode.MANUAL_ADVANCE\n    );\n\n    if (\n      this.storeService_.get(StateProperty.UI_STATE) === UIType.DESKTOP_PANELS\n    ) {\n      this.next_();\n      return;\n    }\n\n    if (direction === TapNavigationDirection.NEXT) {\n      this.next_();\n    } else if (direction === TapNavigationDirection.PREVIOUS) {\n      this.previous_();\n    }\n  }\n\n  /**\n   * Switches to a particular page.\n   * @param {string} targetPageId\n   * @param {!NavigationDirection} direction\n   * @return {!Promise}\n   * @private\n   */\n  switchTo_(targetPageId, direction) {\n    const targetPage = this.getPageById(targetPageId);\n    const pageIndex = this.getPageIndex(targetPage);\n\n    // Step out if trying to navigate to the currently active page.\n    if (this.activePage_ && this.activePage_.element.id === targetPageId) {\n      return Promise.resolve();\n    }\n\n    // If the next page might be paywall protected, and the access\n    // authorizations did not resolve yet, wait before navigating.\n    // TODO(gmajoulet): implement a loading state.\n    if (\n      targetPage.element.hasAttribute('amp-access') &&\n      !this.areAccessAuthorizationsCompleted_\n    ) {\n      this.navigateToPageAfterAccess_ = targetPage;\n      return Promise.resolve();\n    }\n\n    // If the next page is paywall protected, display the access UI and wait for\n    // the document to be reauthorized.\n    if (targetPage.element.hasAttribute('amp-access-hide')) {\n      this.storeService_.dispatch(Action.TOGGLE_ACCESS, true);\n      this.navigateToPageAfterAccess_ = targetPage;\n      return Promise.resolve();\n    }\n\n    const oldPage = this.activePage_;\n    this.activePage_ = targetPage;\n    if (!targetPage.isAd()) {\n      this.updateNavigationPath_(targetPageId, direction);\n    }\n\n    // Each step will run in a requestAnimationFrame, and wait for the next\n    // frame before executing the following step.\n    const steps = [\n      // First step contains the minimum amount of code to display and play the\n      // target page as fast as possible.\n      () => {\n        oldPage && oldPage.element.removeAttribute('active');\n\n        if (\n          this.storeService_.get(StateProperty.UI_STATE) ===\n          UIType.DESKTOP_PANELS\n        ) {\n          this.setDesktopPositionAttributes_(targetPage);\n        }\n\n        // Starts playing the page, if the story is not paused.\n        // Note: navigation is prevented when the story is paused, this test\n        // covers the case where the story is rendered paused (eg: consent).\n        if (!this.storeService_.get(StateProperty.PAUSED_STATE)) {\n          targetPage.setState(PageState.PLAYING);\n        } else {\n          // Even if the page won't be playing, setting the active attribute\n          // ensures it gets visible.\n          targetPage.element.setAttribute('active', '');\n        }\n\n        this.forceRepaintForSafari_();\n      },\n      // Second step does all the operations that impact the UI/UX: media sound,\n      // progress bar, ...\n      () => {\n        if (oldPage) {\n          oldPage.setState(PageState.NOT_ACTIVE);\n\n          // Indication to know where to display the page on the desktop\n          // ribbon-like animation.\n          this.getPageIndex(oldPage) < pageIndex\n            ? setAttributeInMutate(oldPage, Attributes.VISITED)\n            : removeAttributeInMutate(oldPage, Attributes.VISITED);\n\n          if (oldPage.isAd()) {\n            this.storeService_.dispatch(\n              Action.SET_ADVANCEMENT_MODE,\n              AdvancementMode.ADVANCE_TO_ADS\n            );\n          }\n        }\n\n        let storePageIndex = pageIndex;\n        if (targetPage.isAd()) {\n          this.storeService_.dispatch(Action.TOGGLE_AD, true);\n          setAttributeInMutate(this, Attributes.AD_SHOWING);\n\n          // Keep current page index when an ad is shown. Otherwise it messes\n          // up with the progress variable in the VariableService.\n          storePageIndex = this.storeService_.get(\n            StateProperty.CURRENT_PAGE_INDEX\n          );\n        } else {\n          this.storeService_.dispatch(Action.TOGGLE_AD, false);\n          removeAttributeInMutate(this, Attributes.AD_SHOWING);\n\n          // Start progress bar update for pages that are not ads or auto-\n          // advance.\n          if (!targetPage.isAutoAdvance()) {\n            this.systemLayer_.updateProgress(\n              targetPageId,\n              this.advancement_.getProgress()\n            );\n          }\n        }\n\n        this.storeService_.dispatch(Action.CHANGE_PAGE, {\n          id: targetPageId,\n          index: storePageIndex,\n        });\n\n        // If first navigation.\n        if (!oldPage) {\n          this.registerAndPreloadBackgroundAudio_();\n        }\n      },\n      // Third and last step contains all the actions that can be delayed after\n      // the navigation happened, like preloading the following pages, or\n      // sending analytics events.\n      () => {\n        this.preloadPagesByDistance_();\n        this.triggerActiveEventForPage_();\n\n        this.systemLayer_.resetDeveloperLogs();\n        this.systemLayer_.setDeveloperLogContextString(\n          this.activePage_.element.id\n        );\n      },\n    ];\n\n    return new Promise((resolve) => {\n      targetPage.beforeVisible().then(() => {\n        // Recursively executes one step per frame.\n        const unqueueStepInRAF = () => {\n          steps.shift().call(this);\n          if (!steps.length) {\n            return resolve();\n          }\n          this.win.requestAnimationFrame(() => unqueueStepInRAF());\n        };\n\n        unqueueStepInRAF();\n      });\n    });\n  }\n\n  /**\n   * Updates the story navigation stack and checks for navigation adherence to\n   * the path a user takes.\n   * @param {string} targetPageId\n   * @param {!NavigationDirection} direction\n   * @private\n   */\n  updateNavigationPath_(targetPageId, direction) {\n    const navigationPath = /** @type {!Array<string>} */ (\n      this.storeService_.get(StateProperty.NAVIGATION_PATH)\n    );\n\n    if (direction === NavigationDirection.PREVIOUS) {\n      navigationPath.pop();\n    }\n\n    // Ensures the pageId is not at the top of the stack already, which can\n    // happen on initial page load (e.g. reloading a page).\n    if (\n      direction === NavigationDirection.NEXT &&\n      navigationPath[navigationPath.length - 1] !== targetPageId\n    ) {\n      navigationPath.push(targetPageId);\n    }\n\n    this.storeService_.dispatch(Action.SET_NAVIGATION_PATH, navigationPath);\n    setHistoryState(this.win, HistoryState.NAVIGATION_PATH, navigationPath);\n  }\n\n  /**\n   * Clear existing preview attributes, Check to see if there is a next or\n   * previous page, set new attributes.\n   * @param {?./amp-story-page.AmpStoryPage} targetPage\n   * @private\n   */\n  setDesktopPositionAttributes_(targetPage) {\n    if (!targetPage) {\n      return;\n    }\n\n    const list = [{page: targetPage, position: 0}];\n\n    const minusOneId = targetPage.getPreviousPageId();\n    if (minusOneId) {\n      const minusOnePage = this.getPageById(minusOneId);\n      list.push({page: minusOnePage, position: -1});\n\n      const minusTwoId = minusOnePage.getPreviousPageId();\n      if (minusTwoId) {\n        list.push({page: this.getPageById(minusTwoId), position: -2});\n      }\n    }\n\n    const plusOneId = targetPage.getNextPageId();\n    if (plusOneId) {\n      const plusOnePage = this.getPageById(plusOneId);\n      list.push({page: plusOnePage, position: 1});\n\n      const plusTwoId = plusOnePage.getNextPageId();\n      if (plusTwoId) {\n        list.push({page: this.getPageById(plusTwoId), position: 2});\n      }\n    }\n\n    let desktopPositionsToReset;\n\n    this.measureMutateElement(\n      /** measurer */\n      () => {\n        desktopPositionsToReset = scopedQuerySelectorAll(\n          this.element,\n          `amp-story-page[\n                      ${escapeCssSelectorIdent(Attributes.DESKTOP_POSITION)}]`\n        );\n      },\n      /** mutator */\n      () => {\n        Array.prototype.forEach.call(desktopPositionsToReset, (el) => {\n          el.removeAttribute(Attributes.DESKTOP_POSITION);\n        });\n\n        list.forEach((entry) => {\n          const {page, position} = entry;\n          page.element.setAttribute(Attributes.DESKTOP_POSITION, position);\n        });\n      }\n    );\n  }\n\n  /** @private */\n  triggerActiveEventForPage_() {\n    // TODO(alanorozco): pass event priority once amphtml-story repo is merged\n    // with upstream.\n    Services.actionServiceForDoc(this.element).trigger(\n      this.activePage_.element,\n      'active',\n      /* event */ null,\n      ActionTrust.HIGH\n    );\n  }\n\n  /**\n   * For some reason, Safari has an issue where sometimes when pages become\n   * visible, some descendants are not painted.  This is a hack, where we detect\n   * that the browser is Safari and force it to repaint, to avoid this case.\n   * See newmuis/amphtml-story#106 for details.\n   * @private\n   */\n  forceRepaintForSafari_() {\n    if (!this.platform_.isSafari() && !this.platform_.isIos()) {\n      return;\n    }\n    if (\n      this.storeService_.get(StateProperty.UI_STATE) === UIType.DESKTOP_PANELS\n    ) {\n      // Force repaint is only needed when transitioning from invisible to\n      // visible\n      return;\n    }\n\n    this.mutateElement(() => {\n      toggle(this.element, false);\n\n      // Reading the height is what forces the repaint.  The conditional exists\n      // only to workaround the fact that the closure compiler would otherwise\n      // think that only reading the height has no effect.  Since the height is\n      // always >= 0, this conditional will always be executed.\n      const height = this.element./*OK*/ offsetHeight;\n      if (height >= 0) {\n        toggle(this.element, true);\n      }\n    });\n  }\n\n  /**\n   * Handles all key presses within the story.\n   * @param {!Event} e The keydown event.\n   * @private\n   */\n  onKeyDown_(e) {\n    this.storeService_.dispatch(\n      Action.SET_ADVANCEMENT_MODE,\n      AdvancementMode.MANUAL_ADVANCE\n    );\n\n    const rtlState = this.storeService_.get(StateProperty.RTL_STATE);\n\n    switch (e.key) {\n      case Keys.LEFT_ARROW:\n        rtlState ? this.next_() : this.previous_();\n        break;\n      case Keys.RIGHT_ARROW:\n        rtlState ? this.previous_() : this.next_();\n        break;\n    }\n  }\n\n  /**\n   * Handle resize events and set the story's desktop state.\n   * @visibleForTesting\n   */\n  onResize() {\n    const uiState = this.getUIType_();\n    this.storeService_.dispatch(Action.TOGGLE_UI, uiState);\n\n    const isLandscape = this.isLandscape_();\n    const isLandscapeSupported = this.isLandscapeSupported_();\n\n    this.setOrientationAttribute_(isLandscape, isLandscapeSupported);\n\n    if (uiState !== UIType.MOBILE || isLandscapeSupported) {\n      // Hides the UI that prevents users from using the LANDSCAPE orientation.\n      this.storeService_.dispatch(Action.TOGGLE_VIEWPORT_WARNING, false);\n      return;\n    }\n\n    // Only called when the desktop media query is not matched and the landscape\n    // mode is not enabled.\n    this.maybeTriggerViewportWarning_(isLandscape);\n  }\n\n  /**\n   * Adds an orientation=landscape|portrait attribute.\n   * If the story doesn't explicitly support landscape via the opt-in attribute,\n   * it is always in a portrait orientation.\n   * @param {boolean} isLandscape Whether the viewport is landscape or portrait\n   * @param {boolean} isLandscapeSupported Whether the story supports landscape\n   * @private\n   */\n  setOrientationAttribute_(isLandscape, isLandscapeSupported) {\n    // TODO(#20832) base this check on the size of the amp-story-page, once it\n    // is stored as a store state.\n    this.mutateElement(() => {\n      this.element.setAttribute(\n        Attributes.ORIENTATION,\n        isLandscapeSupported && isLandscape ? 'landscape' : 'portrait'\n      );\n    });\n  }\n\n  /**\n   * Maybe triggers the viewport warning overlay.\n   * @param {boolean} isLandscape\n   * @private\n   */\n  maybeTriggerViewportWarning_(isLandscape) {\n    if (\n      isLandscape ===\n      this.storeService_.get(StateProperty.VIEWPORT_WARNING_STATE)\n    ) {\n      return;\n    }\n\n    this.mutateElement(() => {\n      if (isLandscape) {\n        this.pausedStateToRestore_ = !!this.storeService_.get(\n          StateProperty.PAUSED_STATE\n        );\n        this.storeService_.dispatch(Action.TOGGLE_PAUSED, true);\n        this.storeService_.dispatch(Action.TOGGLE_VIEWPORT_WARNING, true);\n      } else {\n        this.storeService_.dispatch(\n          Action.TOGGLE_PAUSED,\n          this.pausedStateToRestore_\n        );\n        this.pausedStateToRestore_ = null;\n        this.storeService_.dispatch(Action.TOGGLE_VIEWPORT_WARNING, false);\n      }\n    });\n  }\n\n  /**\n   * Reacts to the browser tab becoming active/inactive.\n   * @private\n   */\n  onVisibilityChanged_() {\n    this.getAmpDoc().isVisible() ? this.resume_() : this.pause_();\n  }\n\n  /**\n   * Reacts to the ad state updates, and pauses the background-audio when an ad\n   * is displayed.\n   * @param {boolean} isAd\n   * @private\n   */\n  onAdStateUpdate_(isAd) {\n    if (this.storeService_.get(StateProperty.MUTED_STATE)) {\n      return;\n    }\n\n    isAd ? this.pauseBackgroundAudio_() : this.playBackgroundAudio_();\n  }\n\n  /**\n   * Reacts to UI state updates.\n   * @param {!UIType} uiState\n   * @private\n   */\n  onUIStateUpdate_(uiState) {\n    switch (uiState) {\n      case UIType.MOBILE:\n        this.vsync_.mutate(() => {\n          this.element.removeAttribute('desktop');\n          this.element.classList.remove('i-amphtml-story-desktop-panels');\n          this.element.classList.remove('i-amphtml-story-desktop-fullbleed');\n        });\n        break;\n      case UIType.DESKTOP_PANELS:\n        this.setDesktopPositionAttributes_(this.activePage_);\n        this.vsync_.mutate(() => {\n          this.element.setAttribute('desktop', '');\n          this.element.classList.add('i-amphtml-story-desktop-panels');\n          this.element.classList.remove('i-amphtml-story-desktop-fullbleed');\n        });\n        break;\n      case UIType.DESKTOP_FULLBLEED:\n        this.vsync_.mutate(() => {\n          this.element.setAttribute('desktop', '');\n          this.element.classList.add('i-amphtml-story-desktop-fullbleed');\n          this.element.classList.remove('i-amphtml-story-desktop-panels');\n        });\n        break;\n      // Because of the DOM mutations, switching from this mode to another is\n      // not allowed, and prevented within the store service.\n      case UIType.VERTICAL:\n        const pageAttachments = scopedQuerySelectorAll(\n          this.element,\n          'amp-story-page amp-story-page-attachment'\n        );\n\n        this.vsync_.mutate(() => {\n          this.element.setAttribute('i-amphtml-vertical', '');\n          setImportantStyles(this.win.document.body, {height: 'auto'});\n          this.element.removeAttribute('desktop');\n          this.element.classList.remove('i-amphtml-story-desktop-fullbleed');\n          this.element.classList.remove('i-amphtml-story-desktop-panels');\n          for (let i = 0; i < pageAttachments.length; i++) {\n            this.element.insertBefore(\n              pageAttachments[i],\n              // Attachments that are just links are rendered in-line with their\n              // story page.\n              pageAttachments[i].getAttribute('href')\n                ? pageAttachments[i].parentElement.nextElementSibling\n                : // Other attachments are rendered at the end.\n                  null\n            );\n          }\n        });\n\n        this.signals()\n          .whenSignal(CommonSignals.LOAD_END)\n          .then(() => {\n            this.vsync_.mutate(() => {\n              this.pages_.forEach((page) =>\n                page.element.setAttribute('active', '')\n              );\n            });\n          });\n        break;\n    }\n  }\n\n  /**\n   * Retrieves the UI type that should be used to view the story.\n   * @return {!UIType}\n   * @private\n   */\n  getUIType_() {\n    if (this.platform_.isBot()) {\n      return UIType.VERTICAL;\n    }\n\n    if (!this.isDesktop_()) {\n      return UIType.MOBILE;\n    }\n\n    if (this.isLandscapeSupported_()) {\n      return UIType.DESKTOP_FULLBLEED;\n    }\n\n    // Three panels desktop UI (default).\n    return UIType.DESKTOP_PANELS;\n  }\n\n  /**\n   * @return {boolean} True if the screen size matches the desktop media query.\n   * @private\n   */\n  isDesktop_() {\n    return this.desktopMedia_.matches && !this.platform_.isBot();\n  }\n\n  /**\n   * @return {boolean} True if the screen orientation is landscape.\n   * @private\n   */\n  isLandscape_() {\n    return this.landscapeOrientationMedia_.matches;\n  }\n\n  /**\n   * @return {boolean} true if this is a standalone story (i.e. this story is\n   *     the only content of the document).\n   * @private\n   */\n  isStandalone_() {\n    return this.element.hasAttribute(Attributes.STANDALONE);\n  }\n\n  /**\n   * Whether the story should support landscape orientation: landscape mobile,\n   * or full bleed desktop UI.\n   * @return {boolean}\n   * @private\n   */\n  isLandscapeSupported_() {\n    return this.element.hasAttribute(Attributes.SUPPORTS_LANDSCAPE);\n  }\n\n  /**\n   * Reacts to paused state updates.\n   * @param {boolean} isPaused\n   * @private\n   */\n  onPausedStateUpdate_(isPaused) {\n    if (!this.activePage_) {\n      return;\n    }\n\n    const pageState = isPaused ? PageState.PAUSED : PageState.PLAYING;\n\n    this.activePage_.setState(pageState);\n  }\n\n  /**\n   * Reacts to sidebar state updates.\n   * @param {boolean} sidebarState\n   * @private\n   */\n  onSidebarStateUpdate_(sidebarState) {\n    this.analyticsService_.triggerEvent(\n      sidebarState ? StoryAnalyticsEvent.OPEN : StoryAnalyticsEvent.CLOSE,\n      this.sidebar_\n    );\n\n    const actions = Services.actionServiceForDoc(this.element);\n    if (this.win.MutationObserver) {\n      if (!this.sidebarObserver_) {\n        this.sidebarObserver_ = new this.win.MutationObserver(() => {\n          this.storeService_.dispatch(\n            Action.TOGGLE_SIDEBAR,\n            this.sidebar_.hasAttribute('open')\n          );\n        });\n      }\n      if (this.sidebar_ && sidebarState) {\n        this.sidebarObserver_.observe(this.sidebar_, SIDEBAR_OBSERVER_OPTIONS);\n        this.openOpacityMask_();\n        actions.execute(\n          this.sidebar_,\n          'open',\n          /* args */ null,\n          /* source */ null,\n          /* caller */ null,\n          /* event */ null,\n          ActionTrust.HIGH\n        );\n      } else {\n        this.closeOpacityMask_();\n        this.sidebarObserver_.disconnect();\n      }\n    } else if (this.sidebar_ && sidebarState) {\n      this.openOpacityMask_();\n      actions.execute(\n        this.sidebar_,\n        'open',\n        /* args */ null,\n        /* source */ null,\n        /* caller */ null,\n        /* event */ null,\n        ActionTrust.HIGH\n      );\n      this.storeService_.dispatch(Action.TOGGLE_SIDEBAR, false);\n    }\n  }\n\n  /**\n   * @private\n   */\n  initializeOpacityMask_() {\n    if (!this.maskElement_) {\n      const maskEl = this.win.document.createElement('div');\n      maskEl.classList.add(OPACITY_MASK_CLASS_NAME);\n      maskEl.addEventListener('click', () => {\n        const actions = Services.actionServiceForDoc(this.element);\n        if (this.sidebar_) {\n          this.closeOpacityMask_();\n          actions.execute(\n            this.sidebar_,\n            'close',\n            /* args */ null,\n            /* source */ null,\n            /* caller */ null,\n            /* event */ null,\n            ActionTrust.HIGH\n          );\n        }\n      });\n      this.maskElement_ = maskEl;\n      this.mutateElement(() => {\n        this.element.appendChild(this.maskElement_);\n        toggle(dev().assertElement(this.maskElement_), /* display */ false);\n      });\n    }\n  }\n\n  /**\n   * @private\n   */\n  openOpacityMask_() {\n    this.mutateElement(() => {\n      toggle(dev().assertElement(this.maskElement_), /* display */ true);\n    });\n  }\n\n  /**\n   * @private\n   */\n  closeOpacityMask_() {\n    if (this.maskElement_) {\n      this.mutateElement(() => {\n        toggle(dev().assertElement(this.maskElement_), /* display */ false);\n      });\n    }\n  }\n\n  /**\n   * If browser is supported, displays the story. Otherwise, shows either the\n   * default unsupported browser layer or the publisher fallback (if provided).\n   * @param {boolean} isBrowserSupported\n   * @private\n   */\n  onSupportedBrowserStateUpdate_(isBrowserSupported) {\n    const fallbackEl = this.getFallback();\n    if (isBrowserSupported) {\n      // Removes the default unsupported browser layer or throws an error\n      // if the publisher has provided their own fallback\n      if (fallbackEl) {\n        dev().error(\n          TAG,\n          'No handler to exit unsupported browser state on ' +\n            'publisher provided fallback.'\n        );\n      } else {\n        this.layoutStory_().then(() => {\n          this.storeService_.dispatch(\n            Action.TOGGLE_PAUSED,\n            this.pausedStateToRestore_\n          );\n          this.pausedStateToRestore_ = null;\n          this.mutateElement(() => {\n            this.unsupportedBrowserLayer_.removeLayer();\n          });\n        });\n      }\n    } else {\n      this.pausedStateToRestore_ = !!this.storeService_.get(\n        StateProperty.PAUSED_STATE\n      );\n      this.storeService_.dispatch(Action.TOGGLE_PAUSED, true);\n      // Displays the publisher provided fallback or fallbacks to the default\n      // unsupported browser layer.\n      if (fallbackEl) {\n        this.toggleFallback(true);\n      } else {\n        this.unsupportedBrowserLayer_.build();\n        this.mutateElement(() => {\n          this.element.appendChild(this.unsupportedBrowserLayer_.get());\n        });\n      }\n    }\n  }\n\n  /**\n   * @param {boolean} isActive\n   * @private\n   */\n  onAttachmentStateUpdate_(isActive) {\n    this.element.classList.toggle(\n      'i-amphtml-story-attachment-active',\n      isActive\n    );\n  }\n\n  /**\n   * @return {!Array<!Array<string>>} A 2D array representing lists of pages by\n   *     distance.  The outer array index represents the distance from the\n   *     active page; the inner array is a list of page IDs at the specified\n   *     distance.\n   */\n  getPagesByDistance_() {\n    const distanceMap = this.getPageDistanceMapHelper_(\n      /* distance */ 0,\n      /* map */ {},\n      this.activePage_.element.id\n    );\n\n    // Transpose the map into a 2D array.\n    const pagesByDistance = [];\n    Object.keys(distanceMap).forEach((pageId) => {\n      let distance = distanceMap[pageId];\n      // If on last page, mark first page with distance 1.\n      if (\n        pageId === this.pages_[0].element.id &&\n        this.activePage_ === this.pages_[this.pages_.length - 1] &&\n        this.pages_.length > 1 &&\n        !this.viewer_.hasCapability('swipe')\n      ) {\n        distance = 1;\n      }\n      if (!pagesByDistance[distance]) {\n        pagesByDistance[distance] = [];\n      }\n      // There may be other 1 skip away pages due to branching.\n      if (isExperimentOn(this.win, 'amp-story-branching')) {\n        const navigationPath = this.storeService_.get(\n          StateProperty.NAVIGATION_PATH\n        );\n        const indexInStack = navigationPath.indexOf(\n          this.activePage_.element.id\n        );\n        const maybePrev = navigationPath[indexInStack - 1];\n        if (indexInStack > 0 && pageId === this.activePage_.element.id) {\n          if (!pagesByDistance[1]) {\n            pagesByDistance[1] = [];\n          }\n          pagesByDistance[1].push(maybePrev);\n        }\n        // Do not overwrite, branching distance always takes precedence.\n        if (pageId !== maybePrev) {\n          pagesByDistance[distance].push(pageId);\n        }\n      } else {\n        pagesByDistance[distance].push(pageId);\n      }\n    });\n\n    return pagesByDistance;\n  }\n\n  /**\n   * Creates a map of a page and all of the pages reachable from that page, by\n   * distance.\n   *\n   * @param {number} distance The distance that the page with the specified\n   *     pageId is from the active page.\n   * @param {!Object<string, number>} map A mapping from pageId to its distance\n   *     from the active page.\n   * @param {string} pageId The page to be added to the map.\n   * @return {!Object<string, number>} A mapping from page ID to the priority of\n   *     that page.\n   * @private\n   */\n  getPageDistanceMapHelper_(distance, map, pageId) {\n    if (map[pageId] !== undefined && map[pageId] <= distance) {\n      return map;\n    }\n\n    map[pageId] = distance;\n    const page = this.getPageById(pageId);\n    page.getAdjacentPageIds().forEach((adjacentPageId) => {\n      if (\n        map[adjacentPageId] !== undefined &&\n        map[adjacentPageId] <= distance\n      ) {\n        return;\n      }\n\n      // TODO(newmuis): Remove the assignment and return, as they're\n      // unnecessary.\n      map = this.getPageDistanceMapHelper_(distance + 1, map, adjacentPageId);\n    });\n\n    return map;\n  }\n\n  /** @private */\n  preloadPagesByDistance_() {\n    if (this.platform_.isBot()) {\n      this.pages_.forEach((page) => {\n        page.setDistance(0);\n      });\n      return;\n    }\n\n    const pagesByDistance = this.getPagesByDistance_();\n\n    this.mutateElement(() => {\n      pagesByDistance.forEach((pageIds, distance) => {\n        pageIds.forEach((pageId) => {\n          const page = this.getPageById(pageId);\n          page.setDistance(distance);\n        });\n      });\n    });\n  }\n\n  /**\n   * Handles a background-audio attribute set on an <amp-story> tag.\n   * @private\n   */\n  registerAndPreloadBackgroundAudio_() {\n    let backgroundAudioEl = upgradeBackgroundAudio(this.element);\n\n    if (!backgroundAudioEl) {\n      return;\n    }\n\n    // Once the media pool is ready, registers and preloads the background\n    // audio, and then gets the swapped element from the DOM to mute/unmute/play\n    // it programmatically later.\n    this.activePage_.element\n      .signals()\n      .whenSignal(CommonSignals.LOAD_END)\n      .then(() => {\n        backgroundAudioEl = /** @type {!HTMLMediaElement} */ (\n          backgroundAudioEl\n        );\n        this.mediaPool_.register(backgroundAudioEl);\n        return this.mediaPool_.preload(backgroundAudioEl);\n      })\n      .then(() => {\n        this.backgroundAudioEl_ = /** @type {!HTMLMediaElement} */ (\n          childElement(this.element, (el) => {\n            return el.tagName.toLowerCase() === 'audio';\n          })\n        );\n      });\n  }\n\n  /**\n   * Loads amp-story-education if the viewer capability is provided.\n   * @private\n   */\n  maybeLoadStoryEducation_() {\n    if (!this.viewer_.hasCapability('education')) {\n      return;\n    }\n\n    this.mutateElement(() => {\n      this.element.appendChild(\n        this.win.document.createElement('amp-story-education')\n      );\n    });\n\n    Services.extensionsFor(this.win).installExtensionForDoc(\n      this.getAmpDoc(),\n      'amp-story-education'\n    );\n  }\n\n  /**\n   * @param {string} id The ID of the page whose index should be retrieved.\n   * @return {number} The index of the page.\n   */\n  getPageIndexById(id) {\n    const pageIndex = findIndex(this.pages_, (page) => page.element.id === id);\n    if (pageIndex < 0) {\n      user().error(\n        TAG,\n        'Story refers to page \"%s\", but no such page exists.',\n        id\n      );\n    }\n\n    return pageIndex;\n  }\n\n  /**\n   * @param {string} id The ID of the page to be retrieved.\n   * @return {!./amp-story-page.AmpStoryPage} Retrieves the page with the\n   *     specified ID.\n   */\n  getPageById(id) {\n    const pageIndex = this.getPageIndexById(id);\n    return devAssert(\n      this.pages_[pageIndex],\n      'Page at index %s exists, but is missing from the array.',\n      pageIndex\n    );\n  }\n\n  /**\n   * @return {number}\n   */\n  getPageCount() {\n    return this.pages_.length - this.adPages_.length;\n  }\n\n  /**\n   * @param {!./amp-story-page.AmpStoryPage} desiredPage\n   * @return {number} The index of the page.\n   */\n  getPageIndex(desiredPage) {\n    return findIndex(this.pages_, (page) => page === desiredPage);\n  }\n\n  /**\n   * Retrieves the page containing the element, or null. A background audio\n   * set on the <amp-story> tag would not be contained in a page.\n   * @param {!Element} element The element whose containing AmpStoryPage should\n   *     be retrieved\n   * @return {?./amp-story-page.AmpStoryPage} The AmpStoryPage containing the\n   *     specified element, if any.\n   */\n  getPageContainingElement_(element) {\n    let startingElement = element;\n    // If the element is inside an iframe (most likely an ad), start from the\n    // containing iframe element.\n    if (element.ownerDocument !== this.win.document) {\n      startingElement = element.ownerDocument.defaultView.frameElement;\n    }\n\n    const pageIndex = findIndex(this.pages_, (page) => {\n      const pageEl = closest(startingElement, (el) => {\n        return el === page.element;\n      });\n\n      return !!pageEl;\n    });\n\n    return this.pages_[pageIndex] || null;\n  }\n\n  /** @override */\n  getElementDistance(element) {\n    const page = this.getPageContainingElement_(element);\n\n    // An element not contained in a page is likely to be global to the story,\n    // like a background audio. Setting the distance to -1 ensures it will not\n    // get evicted from the media pool.\n    if (!page) {\n      return -1;\n    }\n\n    return page.getDistance();\n  }\n\n  /** @override */\n  getMaxMediaElementCounts() {\n    let audioMediaElementsCount = this.element.querySelectorAll(\n      'amp-audio, [background-audio]'\n    ).length;\n    const videoMediaElementsCount =\n      this.element.querySelectorAll('amp-video').length;\n\n    // The root element (amp-story) might have a background-audio as well.\n    if (this.element.hasAttribute('background-audio')) {\n      audioMediaElementsCount++;\n    }\n\n    return {\n      [MediaType.AUDIO]: Math.min(\n        audioMediaElementsCount + MINIMUM_AD_MEDIA_ELEMENTS,\n        MAX_MEDIA_ELEMENT_COUNTS[MediaType.AUDIO]\n      ),\n      [MediaType.VIDEO]: Math.min(\n        videoMediaElementsCount + MINIMUM_AD_MEDIA_ELEMENTS,\n        MAX_MEDIA_ELEMENT_COUNTS[MediaType.VIDEO]\n      ),\n    };\n  }\n\n  /** @override */\n  getElement() {\n    return this.element;\n  }\n\n  /**\n   * Reacts to muted state updates.\n   * @param  {boolean} isMuted Whether the story just got muted.\n   * @private\n   */\n  onMutedStateUpdate_(isMuted) {\n    isMuted ? this.mute_() : this.unmute_();\n    isMuted\n      ? this.element.setAttribute(Attributes.MUTED, '')\n      : this.element.removeAttribute(Attributes.MUTED);\n  }\n\n  /**\n   * Mutes the audio for the story.\n   * @private\n   */\n  mute_() {\n    this.pauseBackgroundAudio_();\n    if (this.activePage_) {\n      this.activePage_.muteAllMedia();\n    }\n  }\n\n  /**\n   * Pauses the background audio.\n   * @private\n   */\n  pauseBackgroundAudio_() {\n    if (!this.backgroundAudioEl_) {\n      return;\n    }\n    this.mediaPool_.pause(this.backgroundAudioEl_);\n  }\n\n  /**\n   * Unmutes the audio for the story.\n   * @private\n   */\n  unmute_() {\n    const unmuteAllMedia = () => {\n      this.playBackgroundAudio_();\n      if (this.activePage_) {\n        this.activePage_.unmuteAllMedia();\n      }\n    };\n\n    this.mediaPool_.blessAll().then(unmuteAllMedia, unmuteAllMedia);\n  }\n\n  /**\n   * Unmutes and plays the background audio.\n   * @private\n   */\n  playBackgroundAudio_() {\n    if (!this.backgroundAudioEl_) {\n      return;\n    }\n    this.mediaPool_.unmute(this.backgroundAudioEl_);\n    this.mediaPool_.play(this.backgroundAudioEl_);\n  }\n\n  /**\n   * Shows the audio icon if the story has any media elements containing audio,\n   * or background audio at the story or page level.\n   * @private\n   */\n  updateAudioIcon_() {\n    const containsMediaElementWithAudio = !!this.element.querySelector(\n      'amp-audio, amp-video:not([noaudio]), [background-audio]'\n    );\n    const storyHasBackgroundAudio =\n      this.element.hasAttribute('background-audio');\n\n    this.storeService_.dispatch(\n      Action.TOGGLE_STORY_HAS_AUDIO,\n      containsMediaElementWithAudio || storyHasBackgroundAudio\n    );\n    this.storeService_.dispatch(\n      Action.TOGGLE_STORY_HAS_BACKGROUND_AUDIO,\n      storyHasBackgroundAudio\n    );\n  }\n\n  /**\n   * Shows the play/pause icon if there is an element with playback on the story.\n   * @private\n   */\n  updatePausedIcon_() {\n    const containsElementsWithPlayback = !!scopedQuerySelector(\n      this.element,\n      'amp-story-grid-layer amp-audio, amp-story-grid-layer amp-video, amp-story-page[background-audio], amp-story-page[auto-advance-after]'\n    );\n\n    const storyHasBackgroundAudio =\n      this.element.hasAttribute('background-audio');\n\n    this.storeService_.dispatch(\n      Action.TOGGLE_STORY_HAS_PLAYBACK_UI,\n      containsElementsWithPlayback || storyHasBackgroundAudio\n    );\n  }\n\n  /**\n   * Handles the rewind viewer event.\n   * @private\n   */\n  onRewind_() {\n    this.signals()\n      .whenSignal(CommonSignals.LOAD_END)\n      .then(() => this.replay_());\n  }\n\n  /**\n   * Handles the selectPage viewer event.\n   * @param {!JsonObject} data\n   * @private\n   */\n  onSelectPage_(data) {\n    if (!data) {\n      return;\n    }\n\n    this.storeService_.dispatch(\n      Action.SET_ADVANCEMENT_MODE,\n      AdvancementMode.VIEWER_SELECT_PAGE\n    );\n\n    if (data['next']) {\n      this.next_();\n    } else if (data['previous']) {\n      this.previous_();\n    } else if (data['delta']) {\n      this.switchDelta_(data['delta']);\n    } else if (data['id']) {\n      this.switchTo_(\n        data['id'],\n        this.getPageIndexById(data['id']) > this.getPageIndex(this.activePage_)\n          ? NavigationDirection.NEXT\n          : NavigationDirection.PREVIOUS\n      );\n    }\n  }\n\n  /**\n   * Switches to a page in the story given a delta. If new index is out of\n   * bounds, it will go to the last or first page (depending on direction).\n   * @param {number} delta\n   * @private\n   */\n  switchDelta_(delta) {\n    const currentPageIdx = this.storeService_.get(\n      StateProperty.CURRENT_PAGE_INDEX\n    );\n\n    const newPageIdx =\n      delta > 0\n        ? Math.min(this.pages_.length - 1, currentPageIdx + delta)\n        : Math.max(0, currentPageIdx + delta);\n    const targetPage = this.pages_[newPageIdx];\n\n    if (\n      !this.isActualPage_(targetPage && targetPage.element.id) ||\n      newPageIdx === currentPageIdx\n    ) {\n      return;\n    }\n\n    const direction =\n      newPageIdx > currentPageIdx\n        ? NavigationDirection.NEXT\n        : NavigationDirection.PREVIOUS;\n\n    this.switchTo_(targetPage.element.id, direction);\n  }\n\n  /**\n   * Checks for the presence of a sidebar. If a sidebar does exist, then an icon\n   * permitting for the opening/closing of the sidebar is shown.\n   * @private\n   */\n  initializeSidebar_() {\n    this.sidebar_ = this.element.querySelector('amp-sidebar');\n    if (!this.sidebar_) {\n      return;\n    }\n\n    this.mutateElement(() => {\n      this.sidebar_.classList.add(SIDEBAR_CLASS_NAME);\n    });\n\n    this.initializeOpacityMask_();\n    this.storeService_.dispatch(Action.TOGGLE_HAS_SIDEBAR, !!this.sidebar_);\n\n    const actions = [\n      {tagOrTarget: 'AMP-SIDEBAR', method: 'open'},\n      {tagOrTarget: 'AMP-SIDEBAR', method: 'close'},\n      {tagOrTarget: 'AMP-SIDEBAR', method: 'toggle'},\n    ];\n    this.storeService_.dispatch(Action.ADD_TO_ACTIONS_ALLOWLIST, actions);\n  }\n\n  /**\n   * Checks for the the storyNavigationPath stack in the history.\n   * @private\n   */\n  initializeStoryNavigationPath_() {\n    let navigationPath = getHistoryState(\n      this.win,\n      HistoryState.NAVIGATION_PATH\n    );\n    if (\n      !navigationPath ||\n      !navigationPath.every((pageId) => this.isActualPage_(pageId))\n    ) {\n      navigationPath = [];\n    }\n    this.storeService_.dispatch(Action.SET_NAVIGATION_PATH, navigationPath);\n  }\n\n  /** @private */\n  replay_() {\n    this.storeService_.dispatch(Action.SET_NAVIGATION_PATH, []);\n    const switchPromise = this.switchTo_(\n      dev().assertElement(this.pages_[0].element).id,\n      NavigationDirection.NEXT\n    );\n    // Restart page media, advancements, etc (#27742).\n    if (this.pages_.length === 1) {\n      this.pages_[0].setState(PageState.NOT_ACTIVE);\n      this.pages_[0].setState(PageState.PLAYING);\n    }\n\n    // Reset all pages so that they are offscreen to right instead of left in\n    // desktop view.\n    switchPromise.then(() => {\n      this.pages_.forEach((page) =>\n        removeAttributeInMutate(page, Attributes.VISITED)\n      );\n    });\n  }\n\n  /**\n   * @param {!AmpStoryPage} page The page whose CTA anchor tags should be\n   *     upgraded.\n   * @param {number} pageIndex The index of the page.\n   * @private\n   */\n  upgradeCtaAnchorTagsForTracking_(page, pageIndex) {\n    this.mutateElement(() => {\n      const pageId = page.element.id;\n      const ctaAnchorEls = scopedQuerySelectorAll(\n        page.element,\n        'amp-story-cta-layer a'\n      );\n\n      Array.prototype.forEach.call(ctaAnchorEls, (ctaAnchorEl) => {\n        ctaAnchorEl.setAttribute('data-vars-story-page-id', pageId);\n        ctaAnchorEl.setAttribute('data-vars-story-page-index', pageIndex);\n      });\n    });\n  }\n\n  /**\n   * Add page to back of pages_ array\n   * @param {!./amp-story-page.AmpStoryPage} page\n   */\n  addPage(page) {\n    this.pages_.push(page);\n\n    if (page.isAd()) {\n      this.adPages_.push(page);\n    }\n  }\n\n  /**\n   * Insert a new page in navigation flow by changing the attr pointers\n   * on amp-story-page elements\n   * @param {string} pageBeforeId\n   * @param {string} pageToBeInsertedId\n   * @return {boolean} was page inserted\n   */\n  insertPage(pageBeforeId, pageToBeInsertedId) {\n    // TODO(ccordry): make sure this method moves to PageManager when\n    // implemented\n    const pageToBeInserted = this.getPageById(pageToBeInsertedId);\n    const pageToBeInsertedEl = pageToBeInserted.element;\n\n    if (\n      pageToBeInserted.isAd() &&\n      !this.storeService_.get(StateProperty.CAN_INSERT_AUTOMATIC_AD)\n    ) {\n      dev().expectedError(TAG, 'Inserting ads automatically is disallowed.');\n      return false;\n    }\n\n    const pageBefore = this.getPageById(pageBeforeId);\n    const pageBeforeEl = pageBefore.element;\n\n    const nextPage = this.getNextPage(pageBefore);\n\n    if (!nextPage) {\n      return false;\n    }\n\n    const advanceAttr = isExperimentOn(this.win, 'amp-story-branching')\n      ? Attributes.PUBLIC_ADVANCE_TO\n      : Attributes.ADVANCE_TO;\n\n    pageBeforeEl.setAttribute(advanceAttr, pageToBeInsertedId);\n    pageBeforeEl.setAttribute(Attributes.AUTO_ADVANCE_TO, pageToBeInsertedId);\n    pageToBeInsertedEl.setAttribute(Attributes.RETURN_TO, pageBeforeId);\n\n    const nextPageEl = nextPage.element;\n    const nextPageId = nextPageEl.id;\n    // For a live story, nextPage is the same as pageToBeInserted. But not for\n    // ads since it's inserted between two pages.\n    if (nextPageId !== pageToBeInsertedId) {\n      pageToBeInsertedEl.setAttribute(advanceAttr, nextPageId);\n      pageToBeInsertedEl.setAttribute(Attributes.AUTO_ADVANCE_TO, nextPageId);\n      nextPageEl.setAttribute(Attributes.RETURN_TO, pageToBeInsertedId);\n    }\n\n    return true;\n  }\n\n  /**\n   * Get next page object\n   * @param {!./amp-story-page.AmpStoryPage} page\n   * @return {?./amp-story-page.AmpStoryPage}\n   */\n  getNextPage(page) {\n    const nextPageId = page.getNextPageId(true /*opt_isAutomaticAdvance */);\n    if (!nextPageId) {\n      return null;\n    }\n    return this.getPageById(nextPageId);\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {boolean} true if the user's browser supports the features needed\n   *     for amp-story.\n   */\n  static isBrowserSupported(win) {\n    return Boolean(\n      win.CSS &&\n        win.CSS.supports &&\n        win.CSS.supports('display', 'grid') &&\n        win.CSS.supports('color', 'var(--test)')\n    );\n  }\n\n  /**\n   * Loads amp-story-dev-tools if it is enabled.\n   * @private\n   */\n  maybeLoadStoryDevTools_() {\n    if (\n      !isModeDevelopment(this.win) ||\n      this.element.getAttribute('mode') === 'inspect'\n    ) {\n      return false;\n    }\n\n    this.element.setAttribute('mode', 'inspect');\n\n    const devToolsEl = this.win.document.createElement('amp-story-dev-tools');\n    this.win.document.body.appendChild(devToolsEl);\n    this.element.setAttribute('hide', '');\n\n    Services.extensionsFor(this.win).installExtensionForDoc(\n      this.getAmpDoc(),\n      'amp-story-dev-tools'\n    );\n    return true;\n  }\n\n  /**\n   * Should enable the context menu (long press) on the element passed.\n   * @private\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  allowContextMenuOnMobile_(element) {\n    // Match page attachments with links.\n    return !!closest(\n      element,\n      (e) => matches(e, 'a.i-amphtml-story-page-open-attachment[href]'),\n      this.element\n    );\n  }\n}\n\nAMP.extension('amp-story', '1.0', (AMP) => {\n  AMP.registerElement('amp-story', AmpStory, CSS);\n  AMP.registerElement('amp-story-access', AmpStoryAccess);\n  AMP.registerElement('amp-story-consent', AmpStoryConsent);\n  AMP.registerElement('amp-story-cta-layer', AmpStoryCtaLayer);\n  AMP.registerElement('amp-story-grid-layer', AmpStoryGridLayer);\n  AMP.registerElement('amp-story-page', AmpStoryPage);\n  AMP.registerElement('amp-story-page-attachment', AmpStoryPageAttachment);\n  AMP.registerElement('amp-story-page-outlink', AmpStoryPageAttachment); // Shares codepath with amp-story-page-attachment.\n  AMP.registerServiceForDoc('amp-story-render', AmpStoryRenderService);\n});\n"],
  "mappings": "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",
  "names": []
}
