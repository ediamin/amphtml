{
  "version": 3,
  "sources": ["../../src/core/data-structures/promise.js", "../../src/core/types/object/index.js", "../../src/core/types/array.js", "../../src/core/types/string/index.js", "../../src/core/types/index.js", "../../src/core/error/message-helpers.js", "../../src/core/assert/base.js", "../../src/internal-version.js", "../../src/core/types/string/url.js", "../../src/mode.js", "../../src/config.js", "../../src/log.js", "../../src/core/window/index.js", "../../src/service.js", "../../src/core/minified-mode.js", "../../src/core/assert/dev.js", "../../third_party/css-escape/css-escape.js", "../../src/core/dom/css-selectors.js", "../../src/core/dom/query.js", "../../src/dom.js", "../../src/service/extension-script.js", "../../src/element-service.js", "../../src/services.js", "../../src/analytics.js", "../../extensions/amp-subscriptions/0.1/analytics.js", "../../build/amp-subscriptions-0.1.css.js", "../../third_party/subscriptions-project/aes_gcm.js", "../../src/core/types/object/json.js", "../../src/core/types/string/bytes.js", "../../extensions/amp-subscriptions/0.1/crypto-handler.js", "../../src/style.js", "../../extensions/amp-subscriptions/0.1/dialog.js", "../../third_party/subscriptions-project/config.js", "../../extensions/amp-subscriptions/0.1/doc-impl.js", "../../extensions/amp-subscriptions/0.1/constants.js", "../../extensions/amp-subscriptions/0.1/entitlement.js", "../../extensions/amp-subscriptions/0.1/metering.js", "../../src/core/data-structures/observable.js", "../../extensions/amp-subscriptions/0.1/platform-store.js", "../../extensions/amp-subscriptions/0.1/renderer.js", "../../extensions/amp-subscriptions/0.1/service-adapter.js", "../../src/core/types/string/base64.js", "../../extensions/amp-access/0.1/jwt.js", "../../src/core/data-structures/lru-cache.js", "../../src/url.js", "../../src/core/dom/event-helper-listen.js", "../../src/event-helper.js", "../../extensions/amp-access/0.1/login-dialog.js", "../../extensions/amp-subscriptions/0.1/actions.js", "../../build/parsers/access-expr-impl.js", "../../extensions/amp-access/0.1/access-expr.js", "../../extensions/amp-subscriptions/0.1/expr.js", "../../extensions/amp-subscriptions/0.1/local-subscription-platform-renderer.js", "../../extensions/amp-subscriptions/0.1/url-builder.js", "../../extensions/amp-subscriptions/0.1/local-subscription-platform-base.js", "../../extensions/amp-access/0.1/iframe-api/messenger.js", "../../extensions/amp-subscriptions/0.1/local-subscription-platform-iframe.js", "../../extensions/amp-subscriptions/0.1/local-subscription-platform-remote.js", "../../extensions/amp-subscriptions/0.1/local-subscription-platform.js", "../../extensions/amp-subscriptions/0.1/viewer-subscription-platform.js", "../../src/style-installer.js", "../../src/error-reporting.js", "../../extensions/amp-subscriptions/0.1/viewer-tracker.js", "../../src/utils/story.js", "../../extensions/amp-subscriptions/0.1/amp-subscriptions.js"],
  "sourcesContent": ["/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nlet resolved;\n\n/**\n * Returns a cached resolved promise.\n * Babel converts direct calls to Promise.resolve() (with no arguments) into\n * calls to this.\n *\n * @return {!Promise<undefined>}\n */\nexport function resolvedPromise() {\n  if (resolved) {\n    return resolved;\n  }\n\n  // It's important that we call with `undefined` here, to prevent a transform\n  // recursion. If we didn't pass an arg, then the transformer would replace\n  // this callsite with a call to `resolvedPromise()`.\n  resolved = Promise.resolve(undefined);\n  return resolved;\n}\n\n/**\n * Returns a Deferred struct, which holds a pending promise and its associated\n * resolve and reject functions.\n *\n * This is preferred instead of creating a Promise instance to extract the\n * resolve/reject functions yourself:\n *\n * ```\n * // Avoid doing\n * let resolve;\n * const promise = new Promise(res => {\n *   resolve = res;\n * });\n *\n * // Good\n * const deferred = new Deferred();\n * const { promise, resolve } = deferred;\n * ```\n *\n * @template T\n */\nexport class Deferred {\n  /** Constructor. */\n  constructor() {\n    /** @const {!Promise<T>} */\n    this.promise = new /*OK*/ Promise((res, rej) => {\n      /** @const {function(T=)} */\n      this.resolve = res;\n      /** @const {function(*=)} */\n      this.reject = rej;\n    });\n  }\n}\n\n/**\n * Creates a promise resolved to the return value of fn.\n * If fn sync throws, it will cause the promise to reject.\n *\n * @param {function():T} fn\n * @return {!Promise<T>}\n * @template T\n */\nexport function tryResolve(fn) {\n  return new Promise((resolve) => {\n    resolve(fn());\n  });\n}\n\n/**\n * Resolves with the result of the last promise added.\n * @implements {IThenable}\n */\nexport class LastAddedResolver {\n  /**\n   * @param {!Array<!IThenable>=} opt_promises\n   */\n  constructor(opt_promises) {\n    /** @private @const {!Deferred} */\n    this.deferred_ = new Deferred();\n\n    /** @private */\n    this.count_ = 0;\n\n    if (opt_promises) {\n      for (const promise of opt_promises) {\n        this.add(promise);\n      }\n    }\n  }\n\n  /**\n   * Add a promise to possibly be resolved.\n   * @param {!IThenable} promise\n   * @return {!Promise}\n   */\n  add(promise) {\n    const countAtAdd = ++this.count_;\n    promise.then(\n      (result) => {\n        if (this.count_ === countAtAdd) {\n          this.deferred_.resolve(result);\n        }\n      },\n      (error) => {\n        // Don't follow behavior of Promise.all and Promise.race error so that\n        // this will only reject when most recently added promise fails.\n        if (this.count_ === countAtAdd) {\n          this.deferred_.reject(error);\n        }\n      }\n    );\n    return this.deferred_.promise;\n  }\n\n  /** @override */\n  then(opt_resolve, opt_reject) {\n    return this.deferred_.promise.then(opt_resolve, opt_reject);\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* @const */\nconst {hasOwnProperty: hasOwn_, toString: toString_} = Object.prototype;\n\n/**\n * Determines if value is actually an Object.\n * @param {*} value\n * @return {boolean}\n */\nexport function isObject(value) {\n  return toString_.call(value) === '[object Object]';\n}\n\n/**\n * Returns a map-like object.\n * If opt_initial is provided, copies its own properties into the\n * newly created object.\n * @param {T=} opt_initial This should typically be an object literal.\n * @return {T}\n * @template T\n */\nexport function map(opt_initial) {\n  const obj = Object.create(null);\n  if (opt_initial) {\n    Object.assign(obj, opt_initial);\n  }\n  return obj;\n}\n\n/**\n * Return an empty JsonObject or makes the passed in object literal\n * an JsonObject.\n * The JsonObject type is just a simple object that is at-dict.\n * See\n * https://github.com/google/closure-compiler/wiki/@struct-and-@dict-Annotations\n * for what a dict is type-wise.\n * The linter enforces that the argument is, in fact, at-dict like.\n * @param {!Object=} opt_initial\n * @return {!JsonObject}\n */\nexport function dict(opt_initial) {\n  // We do not copy. The linter enforces that the passed in object is a literal\n  // and thus the caller cannot have a reference to it.\n  return /** @type {!JsonObject} */ (opt_initial || {});\n}\n\n/**\n * Checks if the given key is a property in the map.\n *\n * @param {T}  obj a map like property.\n * @param {string}  key\n * @return {boolean}\n * @template T\n */\nexport function hasOwn(obj, key) {\n  return hasOwn_.call(obj, key);\n}\n\n/**\n * Returns obj[key] iff key is obj's own property (is not inherited).\n * Otherwise, returns undefined.\n *\n * @param {Object} obj\n * @param {string} key\n * @return {*}\n */\nexport function ownProperty(obj, key) {\n  if (hasOwn(obj, key)) {\n    return obj[key];\n  } else {\n    return undefined;\n  }\n}\n\n/**\n * Deep merges source into target.\n *\n * @param {!Object} target\n * @param {!Object} source\n * @param {number} depth The maximum merge depth. If exceeded, Object.assign\n *                       will be used instead.\n * @return {!Object}\n * @throws {Error} If source contains a circular reference.\n * Note: Only nested objects are deep-merged, primitives and arrays are not.\n */\nexport function deepMerge(target, source, depth = 10) {\n  // Keep track of seen objects to detect recursive references.\n  const seen = [];\n\n  /** @type {!Array<{t: !Object, s: !Object, d: number}>} */\n  const queue = [];\n  queue.push({t: target, s: source, d: 0});\n\n  // BFS to ensure objects don't have recursive references at shallower depths.\n  while (queue.length > 0) {\n    const {d, s, t} = queue.shift();\n    if (seen.includes(s)) {\n      throw new Error('Source object has a circular reference.');\n    }\n    seen.push(s);\n    if (t === s) {\n      continue;\n    }\n    if (d > depth) {\n      Object.assign(t, s);\n      continue;\n    }\n    for (const key of Object.keys(s)) {\n      const newValue = s[key];\n      // Perform a deep merge IFF both target and source have the same key\n      // whose corresponding values are objects.\n      if (hasOwn(t, key)) {\n        const oldValue = t[key];\n        if (isObject(newValue) && isObject(oldValue)) {\n          queue.push({t: oldValue, s: newValue, d: d + 1});\n          continue;\n        }\n      }\n      t[key] = newValue;\n    }\n  }\n  return target;\n}\n\n/**\n * @param {!Object} o An object to remove properties from\n * @param {!Array<string>} props A list of properties to remove from the Object\n * @return {!Object} An object with the given properties removed\n */\nexport function omit(o, props) {\n  return Object.keys(o).reduce((acc, key) => {\n    if (!props.includes(key)) {\n      acc[key] = o[key];\n    }\n    return acc;\n  }, {});\n}\n\n/**\n * @param {!Object|null|undefined} o1\n * @param {!Object|null|undefined} o2\n * @return {boolean}\n */\nexport function objectsEqualShallow(o1, o2) {\n  if (o1 == null || o2 == null) {\n    // Null is only equal to null, and undefined to undefined.\n    return o1 === o2;\n  }\n\n  for (const k in o1) {\n    if (o1[k] !== o2[k]) {\n      return false;\n    }\n  }\n  for (const k in o2) {\n    if (o2[k] !== o1[k]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\n/**\n * @param {T} obj\n * @param {string} prop\n * @param {function(T, string):R} factory\n * @return {R}\n * @template T,R\n */\nexport function memo(obj, prop, factory) {\n  let result = /** @type {?R} */ (obj[prop]);\n  if (result === undefined) {\n    result = factory(obj, prop);\n    obj[prop] = result;\n  }\n  return result;\n}\n\n/**\n * Recreates objects with prototype-less copies.\n * @param {!JsonObject} obj\n * @return {!JsonObject}\n */\nexport function recreateNonProtoObject(obj) {\n  const copy = map();\n  for (const k in obj) {\n    if (!hasOwn(obj, k)) {\n      continue;\n    }\n    const v = obj[k];\n    copy[k] = isObject(v) ? recreateNonProtoObject(v) : v;\n  }\n  return /** @type {!JsonObject} */ (copy);\n}\n\n/**\n * Returns a value from an object for a field-based expression. The expression\n * is a simple nested dot-notation of fields, such as `field1.field2`. If any\n * field in a chain does not exist or is not an object or array, the returned\n * value will be `undefined`.\n *\n * @param {!JsonObject} obj\n * @param {string} expr\n * @return {*}\n */\nexport function getValueForExpr(obj, expr) {\n  // The `.` indicates \"the object itself\".\n  if (expr == '.') {\n    return obj;\n  }\n  // Otherwise, navigate via properties.\n  const parts = expr.split('.');\n  let value = obj;\n  for (const part of parts) {\n    if (\n      part &&\n      value &&\n      value[part] !== undefined &&\n      typeof value == 'object' &&\n      hasOwn(value, part)\n    ) {\n      value = value[part];\n      continue;\n    }\n    value = undefined;\n    break;\n  }\n  return value;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Converts an array-like object to an array.\n * @param {?IArrayLike<T>|string} arrayLike\n * @return {!Array<T>}\n * @template T\n */\nexport function toArray(arrayLike) {\n  return arrayLike ? Array.prototype.slice.call(arrayLike) : [];\n}\n\n/**\n * Determines if value is actually an Array.\n * @param {*} value\n * @return {boolean}\n */\nexport const {isArray} = Array;\n\n/**\n * If the specified argument is an array, it's returned as is. If it's a\n * single item, the array containing this item is created and returned.\n *\n * The double-template pattern here solves a bug where CC can be passed a value\n * with declared type {string|!Array<string>} and return a value with a type of\n * {!Array<string|Array<string>>}.\n *\n * @param {!Array<T>|S} arrayOrSingleItem\n * @return {!Array<T>|!Array<S>}\n * @template S\n * @template T\n */\nexport function arrayOrSingleItemToArray(arrayOrSingleItem) {\n  return isArray(arrayOrSingleItem)\n    ? /** @type {!Array<T>} */ (arrayOrSingleItem)\n    : [/** @type {!S} */ (arrayOrSingleItem)];\n}\n\n/**\n * Compares if two arrays contains exactly same elements of same number\n * of same order. Note that it does NOT handle NaN case as expected.\n *\n * @param {!Array<T>} arr1\n * @param {!Array<T>} arr2\n * @return {boolean}\n * @template T\n */\nexport function areEqualOrdered(arr1, arr2) {\n  if (arr1.length !== arr2.length) {\n    return false;\n  }\n  for (let i = 0; i < arr1.length; i++) {\n    if (arr1[i] !== arr2[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Removes elements that shouldRemove returns true for from the array.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} shouldRemove\n * @return {!Array<T>}\n * @template T\n */\nexport function remove(array, shouldRemove) {\n  const removed = [];\n  let index = 0;\n  for (let i = 0; i < array.length; i++) {\n    const item = array[i];\n    if (shouldRemove(item, i, array)) {\n      removed.push(item);\n    } else {\n      if (index < i) {\n        array[index] = item;\n      }\n      index++;\n    }\n  }\n  if (index < array.length) {\n    array.length = index;\n  }\n  return removed;\n}\n\n/**\n * Returns the index of the first element matching the predicate.\n * Like Array#findIndex.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} predicate\n * @return {number}\n * @template T\n */\nexport function findIndex(array, predicate) {\n  for (let i = 0; i < array.length; i++) {\n    if (predicate(array[i], i, array)) {\n      return i;\n    }\n  }\n  return -1;\n}\n\n/**\n * Converts the given iterator to an array.\n *\n * @param {!Iterator<T>} iterator\n * @return {Array<T>}\n * @template T\n */\nexport function fromIterator(iterator) {\n  const array = [];\n  for (let e = iterator.next(); !e.done; e = iterator.next()) {\n    array.push(e.value);\n  }\n  return array;\n}\n\n/**\n * Adds item to array if it is not already present.\n *\n * @param {Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function pushIfNotExist(array, item) {\n  if (array.indexOf(item) < 0) {\n    array.push(item);\n    return true;\n  }\n  return false;\n}\n\n/**\n * Removes the first matching item in the array. Returns `true` if the array\n * has changed.\n *\n * @param {!Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function removeItem(array, item) {\n  const index = array.indexOf(item);\n  if (index == -1) {\n    return false;\n  }\n  array.splice(index, 1);\n  return true;\n}\n\n/**\n * Returns the last item in an array.\n *\n * @param {Array<T>} array\n * @template T\n * @return {?T}\n */\nexport function lastItem(array) {\n  return array[array.length - 1];\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {string} _match\n * @param {string} character\n * @return {string}\n */\nfunction toUpperCase(_match, character) {\n  return character.toUpperCase();\n}\n\n/**\n * @param {string} match\n * @return {string}\n */\nfunction prependDashAndToLowerCase(match) {\n  return '-' + match.toLowerCase();\n}\n\n/**\n * @param {string} name Attribute name containing dashes.\n * @return {string} Dashes removed and successive character sent to upper case.\n * visibleForTesting\n */\nexport function dashToCamelCase(name) {\n  return name.replace(/-([a-z])/g, toUpperCase);\n}\n\n/**\n * Converts a string that is in camelCase to one that is in dash-case.\n *\n * @param {string} string The string to convert.\n * @return {string} The string in dash-case.\n */\nexport function camelCaseToDash(string) {\n  return string.replace(/(?!^)[A-Z]/g, prependDashAndToLowerCase);\n}\n\n/**\n * @param {string} name Attribute name with dashes\n * @return {string} Dashes replaced by underlines.\n */\nexport function dashToUnderline(name) {\n  return name.replace('-', '_');\n}\n\n/**\n * Polyfill for String.prototype.endsWith.\n * @param {string} string\n * @param {string} suffix\n * @return {boolean}\n */\nexport function endsWith(string, suffix) {\n  const index = string.length - suffix.length;\n  return index >= 0 && string.indexOf(suffix, index) == index;\n}\n\n/**\n * Polyfill for String.prototype.includes.\n * @param {string} string\n * @param {string} substring\n * @param {number=} start\n * @return {boolean}\n */\nexport function includes(string, substring, start) {\n  if (typeof start !== 'number') {\n    start = 0;\n  }\n  if (start + substring.length > string.length) {\n    return false;\n  }\n  return string.indexOf(substring, start) !== -1;\n}\n\n/**\n * Expands placeholders in a given template string with values.\n *\n * Placeholders use ${key-name} syntax and are replaced with the value\n * returned from the given getter function.\n *\n * @param {string} template The template string to expand.\n * @param {function(string):*} getter Function used to retrieve a value for a\n *   placeholder. Returns values will be coerced into strings.\n * @param {number=} opt_maxIterations Number of times to expand the template.\n *   Defaults to 1, but should be set to a larger value your placeholder tokens\n *   can be expanded to other placeholder tokens. Take caution with large values\n *   as recursively expanding a string can be exponentially expensive.\n * @return {string}\n */\nexport function expandTemplate(template, getter, opt_maxIterations) {\n  const maxIterations = opt_maxIterations || 1;\n  for (let i = 0; i < maxIterations; i++) {\n    let matches = 0;\n    template = template.replace(/\\${([^}]*)}/g, (_a, b) => {\n      matches++;\n      return getter(b);\n    });\n    if (!matches) {\n      break;\n    }\n  }\n  return template;\n}\n\n/**\n * Hash function djb2a\n * This is intended to be a simple, fast hashing function using minimal code.\n * It does *not* have good cryptographic properties.\n * @param {string} str\n * @return {string} 32-bit unsigned hash of the string\n */\nexport function stringHash32(str) {\n  const {length} = str;\n  let hash = 5381;\n  for (let i = 0; i < length; i++) {\n    hash = (hash * 33) ^ str.charCodeAt(i);\n  }\n  // Convert from 32-bit signed to unsigned.\n  return String(hash >>> 0);\n}\n\n/**\n * Trims a string on the end, removing whitespace characters.\n * @param {string} str  A string to trim.\n * @return {string} The string, with trailing whitespace removed.\n */\nexport function trimEnd(str) {\n  // TODO(sparhami) Does this get inlined for an ES2019 build?\n  if (str.trimEnd) {\n    return str.trimEnd();\n  }\n\n  return ('_' + str).trim().slice(1);\n}\n\n/**\n * Trims any leading whitespace from a string.\n * @param {string} str  A string to trim.\n * @return {string} The string, with leading whitespace removed.\n */\nexport function trimStart(str) {\n  if (str.trimStart) {\n    return str.trimStart();\n  }\n\n  return (str + '_').trim().slice(0, -1);\n}\n\n/**\n * Wrapper around String.replace that handles asynchronous resolution.\n * @param {string} str\n * @param {RegExp} regex\n * @param {Function|string} replacer\n * @return {!Promise<string>}\n */\nexport function asyncStringReplace(str, regex, replacer) {\n  if (isString(replacer)) {\n    return Promise.resolve(str.replace(regex, replacer));\n  }\n  const stringBuilder = [];\n  let lastIndex = 0;\n\n  str.replace(regex, function (match) {\n    // String.prototype.replace will pass 3 to n number of arguments to the\n    // callback function based on how many capture groups the regex may or may\n    // not contain. We know that the match will always be first, and the\n    // index will always be second to last.\n    const matchIndex = arguments[arguments.length - 2];\n    stringBuilder.push(str.slice(lastIndex, matchIndex));\n    lastIndex = matchIndex + match.length;\n\n    // Store the promise in it's eventual string position.\n    const replacementPromise = replacer.apply(null, arguments);\n    stringBuilder.push(replacementPromise);\n  });\n  stringBuilder.push(str.slice(lastIndex));\n\n  return Promise.all(stringBuilder).then((resolved) => resolved.join(''));\n}\n\n/**\n * Pads the beginning of a string with a substring to a target length.\n * @param {string} s\n * @param {number} targetLength\n * @param {string} padString\n * @return {string}\n */\nexport function padStart(s, targetLength, padString) {\n  if (s.length >= targetLength) {\n    return s;\n  }\n  targetLength = targetLength - s.length;\n  let padding = padString;\n  while (targetLength > padding.length) {\n    padding += padString;\n  }\n  return padding.slice(0, targetLength) + s;\n}\n\n/**\n * Tests if a value is a string.\n * @param {?} s\n * @return {boolean}\n */\nexport function isString(s) {\n  return typeof s == 'string';\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Export all type-checking helpers for convenience\nexport {isArray} from './array';\nexport {isEnumValue} from './enum';\nexport {isString} from './string';\nexport {isObject} from './object';\n\n/**\n * Determines if value is an ELement\n * @param {*} value\n * @return {boolean}\n */\nexport function isElement(value) {\n  return value?.nodeType == /* Node.ELEMENT_NODE */ 1;\n}\n\n/**\n * Determines if value is of number type and finite.\n * NaN and Infinity are not considered a finite number.\n * String numbers are not considered numbers.\n * @param {*} value\n * @return {boolean}\n */\nexport function isFiniteNumber(value) {\n  return typeof value === 'number' && isFinite(value);\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isElement} from '../types';\n\n/**\n * Triple zero width space.\n *\n * This is added to user error messages, so that we can later identify\n * them, when the only thing that we have is the message. This is the\n * case in many browsers when the global exception handler is invoked.\n *\n * @const {string}\n */\nexport const USER_ERROR_SENTINEL = '\\u200B\\u200B\\u200B';\n\n/**\n * Converts an element to a readable string; all other types are unchanged.\n * TODO(rcebulko): Unify with log.js\n * @param {*} val\n * @return {*}\n */\nexport function elementStringOrPassThru(val) {\n  // Do check equivalent to `val instanceof Element` without cross-window bug\n  if (isElement(val)) {\n    val = /** @type {Element} */ (val);\n    return val.tagName.toLowerCase() + (val.id ? `#${val.id}` : '');\n  }\n  return val;\n}\n\n/**\n * Tests if an error message contains the user sentinel.\n * @param {string} message\n * @return {boolean} Whether this message was a user error.\n */\nexport function isUserErrorMessage(message) {\n  return message.indexOf(USER_ERROR_SENTINEL) >= 0;\n}\n\n/**\n * Strips the user error sentinel from an error message.\n * @param {string} message\n * @return {string} The new message without USER_ERROR_SENTINEL\n */\nexport function stripUserError(message) {\n  return message.replace(USER_ERROR_SENTINEL, '');\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {elementStringOrPassThru} from '../error/message-helpers';\nimport {includes} from '../types/string';\nimport {isArray, isElement, isString} from '../types';\nimport {remove} from '../types/array';\n\n/**\n * @fileoverview This file provides the base implementation for assertion\n * functions. Most files should never import from this; instead, import from\n * `dev` or `user`. It is also used by the Log class for its assertions.\n */\n\n/**\n * A base assertion function, provided to various assertion helpers.\n * @typedef {function(?, string=, ...*):?|function(?, !Array<*>)}\n */\nexport let AssertionFunctionDef;\n\n/**\n * Throws an error if the second argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n * @param {?string} sentinel\n * @param {T} shouldBeTruthy\n * @param {string} opt_message\n * @param {...*} var_args Arguments substituted into %s in the message\n * @return {T}\n * @template T\n * @throws {Error} when shouldBeTruthy is not truthy.\n */\nexport function assert(\n  sentinel,\n  shouldBeTruthy,\n  opt_message = 'Assertion failed',\n  var_args\n) {\n  if (shouldBeTruthy) {\n    return shouldBeTruthy;\n  }\n\n  // Include the sentinel string if provided and not already present\n  if (sentinel && !includes(opt_message, sentinel)) {\n    opt_message += sentinel;\n  }\n\n  // Skip the first 3 arguments to isolate format params\n  // const messageArgs = Array.prototype.slice.call(arguments, 3);\n  // Index at which message args start\n  let i = 3;\n\n  // Substitute provided values into format string in message\n  const splitMessage = opt_message.split('%s');\n  let message = splitMessage.shift();\n  const messageArray = [message];\n\n  while (splitMessage.length) {\n    const subValue = arguments[i++];\n    const nextConstant = splitMessage.shift();\n\n    message += elementStringOrPassThru(subValue) + nextConstant;\n    messageArray.push(subValue, nextConstant.trim());\n  }\n\n  const error = new Error(message);\n  error.messageArray = remove(messageArray, (x) => x !== '');\n  // __AMP_REPORT_ERROR is installed globally per window in the entry point in\n  // AMP documents. It may not be present for Bento/Preact elements on non-AMP\n  // pages.\n  self.__AMP_REPORT_ERROR?.(error);\n  throw error;\n}\n\n/**\n * Asserts types, backbone of `assertNumber`, `assertString`, etc.\n *\n * It understands array-based \"id\"-contracted messages.\n *\n * Otherwise creates a sprintf syntax string containing the optional message or the\n * default. The `subject` of the assertion is added at the end.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {T} subject\n * @param {*} shouldBeTruthy\n * @param {string} defaultMessage\n * @param {!Array<*>|string=} opt_message\n * @return {T}\n * @template T\n * @private\n */\nfunction assertType_(\n  assertFn,\n  subject,\n  shouldBeTruthy,\n  defaultMessage,\n  opt_message\n) {\n  if (isArray(opt_message)) {\n    assertFn(\n      shouldBeTruthy,\n      /** @type {!Array} */ (opt_message).concat([subject])\n    );\n  } else {\n    assertFn(shouldBeTruthy, `${opt_message || defaultMessage}: %s`, subject);\n  }\n\n  return subject;\n}\n\n/**\n * Throws an error if the first argument isn't an Element.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeElement\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Element} The value of shouldBeTrueish.\n * @throws {Error} when shouldBeElement is not an Element\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertElement(assertFn, shouldBeElement, opt_message) {\n  return /** @type {!Element} */ (\n    assertType_(\n      assertFn,\n      shouldBeElement,\n      isElement(shouldBeElement),\n      'Element expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a string. The string can\n * be empty.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeString\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {string} The string value. Can be an empty string.\n * @throws {Error} when shouldBeString is not an String\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertString(assertFn, shouldBeString, opt_message) {\n  return /** @type {string} */ (\n    assertType_(\n      assertFn,\n      shouldBeString,\n      isString(shouldBeString),\n      'String expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a number. The allowed values\n * include `0` and `NaN`.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeNumber\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {number} The number value. The allowed values include `0`\n *   and `NaN`.\n * @throws {Error} when shouldBeNumber is not an Number\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertNumber(assertFn, shouldBeNumber, opt_message) {\n  return /** @type {number} */ (\n    assertType_(\n      assertFn,\n      shouldBeNumber,\n      typeof shouldBeNumber == 'number',\n      'Number expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument is not an array.\n * The array can be empty.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeArray\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Array} The array value\n * @throws {Error} when shouldBeArray is not an Array\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertArray(assertFn, shouldBeArray, opt_message) {\n  return /** @type {!Array} */ (\n    assertType_(\n      assertFn,\n      shouldBeArray,\n      isArray(shouldBeArray),\n      'Array expected',\n      opt_message\n    )\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a boolean.\n *\n * For more details see `assert`.\n *\n * @param {!AssertionFunctionDef} assertFn underlying assertion function to call\n * @param {*} shouldBeBoolean\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {boolean} The boolean value.\n * @throws {Error} when shouldBeBoolean is not an Boolean\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertBoolean(assertFn, shouldBeBoolean, opt_message) {\n  return /** @type {boolean} */ (\n    assertType_(\n      assertFn,\n      shouldBeBoolean,\n      !!shouldBeBoolean === shouldBeBoolean,\n      'Boolean expected',\n      opt_message\n    )\n  );\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns the internal AMP runtime version. Note that this is not the RTV,\n * which is a prefix and the runtime version.\n *\n * The call sites for this function are replaced with a compile time constant\n * string.\n *\n * @return {string}\n */\nexport function internalRuntimeVersion() {\n  return '$internalRuntimeVersion$';\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {map} from '../object';\n\nconst QUERY_STRING_REGEX = /(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;\n\n/**\n * Tries to decode a URI component, falling back to opt_fallback (or an empty\n * string)\n *\n * @param {string} component\n * @param {string=} fallback\n * @return {string}\n */\nexport function tryDecodeUriComponent(component, fallback = '') {\n  try {\n    return decodeURIComponent(component);\n  } catch (e) {\n    return fallback;\n  }\n}\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\nexport function parseQueryString(queryString) {\n  const params = map();\n  if (!queryString) {\n    return params;\n  }\n\n  let match;\n  while ((match = QUERY_STRING_REGEX.exec(queryString))) {\n    const name = tryDecodeUriComponent(match[1], match[1]);\n    const value = match[2]\n      ? tryDecodeUriComponent(match[2].replace(/\\+/g, ' '), match[2])\n      : '';\n    params[name] = value;\n  }\n  return params;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalRuntimeVersion} from './internal-version';\nimport {parseQueryString} from './core/types/string/url';\n\n/**\n * @typedef {{\n *   localDev: boolean,\n *   development: boolean,\n *   minified: boolean,\n *   test: boolean,\n *   examiner: boolean,\n *   log: (string|undefined),\n *   version: string,\n *   rtvVersion: string,\n *   runtime: (null|string|undefined),\n *   a4aId: (null|string|undefined),\n *   esm: (boolean|undefined),\n * }}\n */\nexport let ModeDef;\n\n/**\n * `rtvVersion` is the prefixed version we serve off of the cdn.\n * The prefix denotes canary(00) or prod(01) or an experiment version ( > 01).\n * @type {string}\n */\nlet rtvVersion = '';\n\n/**\n * Provides info about the current app.\n * @param {?Window=} opt_win\n * @return {!ModeDef}\n */\nexport function getMode(opt_win) {\n  const win = opt_win || self;\n  if (win.__AMP_MODE) {\n    return win.__AMP_MODE;\n  }\n  return (win.__AMP_MODE = getMode_(win));\n}\n\n/**\n * Provides info about the current app.\n * @param {!Window} win\n * @return {!ModeDef}\n */\nfunction getMode_(win) {\n  // TODO(erwinmombay): simplify the logic here\n  const AMP_CONFIG = self.AMP_CONFIG || {};\n\n  // Magic constants that are replaced by closure compiler.\n  // IS_MINIFIED is always replaced with true when closure compiler is used\n  // while IS_FORTESTING is only replaced when `amp dist` is called without the\n  // --fortesting flag.\n  const IS_FORTESTING = true;\n  const IS_MINIFIED = false;\n\n  const runningTests =\n    IS_FORTESTING && !!(AMP_CONFIG.test || win.__AMP_TEST || win['__karma__']);\n  const isLocalDev = IS_FORTESTING && (!!AMP_CONFIG.localDev || runningTests);\n  const hashQuery = parseQueryString(\n    // location.originalHash is set by the viewer when it removes the fragment\n    // from the URL.\n    win.location['originalHash'] || win.location.hash\n  );\n\n  if (!rtvVersion) {\n    rtvVersion = getRtvVersion(win);\n  }\n\n  // The `minified`, `test` and `localDev` properties are replaced\n  // as boolean literals when we run `amp dist` without the `--fortesting`\n  // flags. This improved DCE on the production file we deploy as the code\n  // paths for localhost/testing/development are eliminated.\n  return {\n    localDev: isLocalDev,\n    development: isModeDevelopment(win),\n    examiner: hashQuery['development'] == '2',\n    esm: IS_ESM,\n    // amp-geo override\n    geoOverride: hashQuery['amp-geo'],\n    minified: IS_MINIFIED,\n    test: runningTests,\n    log: hashQuery['log'],\n    version: internalRuntimeVersion(),\n    rtvVersion,\n  };\n}\n\n/**\n * Retrieve the `rtvVersion` which will have a numeric prefix\n * denoting canary/prod/experiment (unless `isLocalDev` is true).\n *\n * @param {!Window} win\n * @return {string}\n */\nfunction getRtvVersion(win) {\n  if (win.AMP_CONFIG && win.AMP_CONFIG.v) {\n    return win.AMP_CONFIG.v;\n  }\n\n  // Currently `internalRuntimeVersion` and thus `mode.version` contain only\n  // major version. The full version however must also carry the minor version.\n  // We will default to production default `01` minor version for now.\n  // TODO(erwinmombay): decide whether internalRuntimeVersion should contain\n  // minor version.\n  return `01${internalRuntimeVersion()}`;\n}\n\n/**\n * Triggers validation or enable pub level logging. Validation can be\n * bypassed via #validate=0.\n * Note that AMP_DEV_MODE flag is used for testing purposes.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isModeDevelopment(win) {\n  const hashQuery = parseQueryString(\n    win.location['originalHash'] || win.location.hash\n  );\n  return !!(\n    ['1', 'actions', 'amp', 'amp4ads', 'amp4email'].includes(\n      hashQuery['development']\n    ) || win.AMP_DEV_MODE\n  );\n}\n\n/**\n * @param {!Window} win\n * @return {string}\n * @visibleForTesting\n */\nexport function getRtvVersionForTesting(win) {\n  return getRtvVersion(win);\n}\n\n/** @visibleForTesting */\nexport function resetRtvVersionForTesting() {\n  rtvVersion = '';\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Allows for runtime configuration. Internally, the runtime should\n * use the src/config.js module for various constants. We can use the\n * AMP_CONFIG global to translate user-defined configurations to this\n * module.\n * @type {!Object<string, string>}\n */\nconst env = self.AMP_CONFIG || {};\n\nconst thirdPartyFrameRegex =\n  (typeof env['thirdPartyFrameRegex'] == 'string'\n    ? new RegExp(env['thirdPartyFrameRegex'])\n    : env['thirdPartyFrameRegex']) || /^d-\\d+\\.ampproject\\.net$/;\n\nconst cdnProxyRegex =\n  (typeof env['cdnProxyRegex'] == 'string'\n    ? new RegExp(env['cdnProxyRegex'])\n    : env['cdnProxyRegex']) ||\n  /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org$/;\n\n/**\n * Check for a custom URL definition in special <meta> tags. Note that this does\n * not allow for distinct custom URLs in AmpDocShadow instances. The shell is\n * allowed to define one set of custom URLs via AMP_CONFIG (recommended) or by\n * including <meta> tags in the shell <head>. Those custom URLs then apply to\n * all AMP documents loaded in the shell.\n * @param {string} name\n * @return {?string}\n * @private\n */\nfunction getMetaUrl(name) {\n  // Avoid exceptions in unit tests\n  if (!self.document || !self.document.head) {\n    return null;\n  }\n\n  // Disallow on proxy origins\n  if (self.location && cdnProxyRegex.test(self.location.origin)) {\n    return null;\n  }\n\n  const metaEl = self.document.head./*OK*/ querySelector(\n    `meta[name=\"${name}\"]`\n  );\n  return (metaEl && metaEl.getAttribute('content')) || null;\n}\n\n/**\n * @typedef {{\n *   thirdParty: string,\n *   thirdPartyFrameHost: string,\n *   thirdPartyFrameRegex: !RegExp,\n *   cdn: string,\n *   cdnProxyRegex: !RegExp,\n *   localhostRegex: !RegExp,\n *   errorReporting: string,\n *   betaErrorReporting: string,\n *   localDev: boolean,\n *   trustedViewerHosts: !Array<!RegExp>,\n *   geoApi: ?string,\n * }}\n */\nexport const urls = {\n  thirdParty: env['thirdPartyUrl'] || 'https://3p.ampproject.net',\n  thirdPartyFrameHost: env['thirdPartyFrameHost'] || 'ampproject.net',\n  thirdPartyFrameRegex,\n  cdn:\n    env['cdnUrl'] || getMetaUrl('runtime-host') || 'https://cdn.ampproject.org',\n  /* Note that cdnProxyRegex is only ever checked against origins\n   * (proto://host[:port]) so does not need to consider path\n   */\n  cdnProxyRegex,\n  localhostRegex: /^https?:\\/\\/localhost(:\\d+)?$/,\n  errorReporting:\n    env['errorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r',\n  betaErrorReporting:\n    env['betaErrorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r-beta',\n  localDev: env['localDev'] || false,\n  /**\n   * These domains are trusted with more sensitive viewer operations such as\n   * propagating the referrer. If you believe your domain should be here,\n   * file the issue on GitHub to discuss. The process will be similar\n   * (but somewhat more stringent) to the one described in the [3p/README.md](\n   * https://github.com/ampproject/amphtml/blob/main/3p/README.md)\n   *\n   * {!Array<!RegExp>}\n   */\n  trustedViewerHosts: [\n    /(^|\\.)google\\.(com?|[a-z]{2}|com?\\.[a-z]{2}|cat)$/,\n    /(^|\\.)gmail\\.(com|dev)$/,\n  ],\n  // Optional fallback API if amp-geo is left unpatched\n  geoApi: env['geoApiUrl'] || getMetaUrl('amp-geo-api'),\n};\n\nexport const config = {\n  urls,\n};\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assertions from './core/assert/base';\nimport {\n  USER_ERROR_SENTINEL,\n  elementStringOrPassThru,\n  isUserErrorMessage,\n  stripUserError,\n} from './core/error/message-helpers';\nimport {createErrorVargs, duplicateErrorIfNecessary} from './core/error';\nimport {getMode} from './mode';\nimport {internalRuntimeVersion} from './internal-version';\nimport {isArray} from './core/types';\nimport {once} from './core/types/function';\nimport {urls} from './config';\n\nconst noop = () => {};\n\n// These are exported here despite being defined in core to avoid updating\n// imports for now.\nexport {USER_ERROR_SENTINEL, isUserErrorMessage, stripUserError};\n\n/**\n * Four zero width space.\n *\n * @const {string}\n */\nexport const USER_ERROR_EMBED_SENTINEL = '\\u200B\\u200B\\u200B\\u200B';\n\n/**\n * @param {string} message\n * @return {boolean} Whether this message was a a user error from an iframe embed.\n */\nexport function isUserErrorEmbed(message) {\n  return message.indexOf(USER_ERROR_EMBED_SENTINEL) >= 0;\n}\n\n/**\n * @enum {number}\n */\nexport const LogLevel = {\n  OFF: 0,\n  ERROR: 1,\n  WARN: 2,\n  INFO: 3,\n  FINE: 4,\n};\n\n/**\n * Sets reportError function. Called from error-reporting.js to break cyclic\n * dependency.\n * @param {function(this:Window, Error, (?Element)=): ?|undefined} fn\n */\nexport function setReportError(fn) {\n  self.__AMP_REPORT_ERROR = fn;\n}\n\n/**\n * @type {!LogLevel|undefined}\n * @private\n */\nlet levelOverride_ = undefined;\n\n/**\n * @param {!LogLevel} level\n */\nexport function overrideLogLevel(level) {\n  levelOverride_ = level;\n}\n\n/**\n * Prefixes `internalRuntimeVersion` with the `01` channel signifier (for prod.) for\n * extracted message URLs.\n * (Specific channel is irrelevant: message tables are invariant on internal version.)\n * @return {string}\n */\nconst messageUrlRtv = () => `01${internalRuntimeVersion()}`;\n\n/**\n * Gets a URL to display a message on amp.dev.\n * @param {string} id\n * @param {!Array} interpolatedParts\n * @return {string}\n */\nconst externalMessageUrl = (id, interpolatedParts) =>\n  interpolatedParts.reduce(\n    (prefix, arg) => `${prefix}&s[]=${messageArgToEncodedComponent(arg)}`,\n    `https://log.amp.dev/?v=${messageUrlRtv()}&id=${encodeURIComponent(id)}`\n  );\n\n/**\n * URL to simple log messages table JSON file, which contains an Object<string, string>\n * which maps message id to full message template.\n * @return {string}\n */\nconst externalMessagesSimpleTableUrl = () =>\n  `${urls.cdn}/rtv/${messageUrlRtv()}/log-messages.simple.json`;\n\n/**\n * @param {*} arg\n * @return {string}\n */\nconst messageArgToEncodedComponent = (arg) =>\n  encodeURIComponent(String(elementStringOrPassThru(arg)));\n\n/**\n * Logging class. Use of sentinel string instead of a boolean to check user/dev\n * errors because errors could be rethrown by some native code as a new error,\n * and only a message would survive. Also, some browser don\u2019t support a 5th\n * error object argument in window.onerror. List of supporting browser can be\n * found here:\n * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n * @final\n * @private Visible for testing only.\n */\nexport class Log {\n  /**\n   * opt_suffix will be appended to error message to identify the type of the\n   * error message. We can't rely on the error object to pass along the type\n   * because some browsers do not have this param in its window.onerror API.\n   * See:\n   * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n   *\n   * @param {!Window} win\n   * @param {function(number, boolean):!LogLevel} levelFunc\n   * @param {string=} opt_suffix\n   */\n  constructor(win, levelFunc, opt_suffix = '') {\n    /**\n     * In tests we use the main test window instead of the iframe where\n     * the tests runs because only the former is relayed to the console.\n     * @const {!Window}\n     */\n    this.win = getMode().test && win.__AMP_TEST_IFRAME ? win.parent : win;\n\n    /** @private @const {function(number, boolean):!LogLevel} */\n    this.levelFunc_ = levelFunc;\n\n    /** @private @const {!LogLevel} */\n    this.level_ = this.defaultLevel_();\n\n    /** @private @const {string} */\n    this.suffix_ = opt_suffix;\n\n    /** @private {?JsonObject} */\n    this.messages_ = null;\n\n    this.fetchExternalMessagesOnce_ = once(() => {\n      win\n        .fetch(externalMessagesSimpleTableUrl())\n        .then((response) => response.json(), noop)\n        .then((opt_messages) => {\n          if (opt_messages) {\n            this.messages_ = /** @type {!JsonObject} */ (opt_messages);\n          }\n        });\n    });\n\n    // This bound assertion function is capable of handling the format used when\n    // error/assertion messages are extracted. This logic hasn't yet been\n    // migrated to an AMP-independent form for use in core. This binding allows\n    // Log assertion helpers to maintain message-extraction capabilities until\n    // that logic can be moved to core.\n    this.boundAssertFn_ = /** @type {!assertions.AssertionFunctionDef} */ (\n      this.assert.bind(this)\n    );\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  getLevel_() {\n    return levelOverride_ !== undefined ? levelOverride_ : this.level_;\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevel_() {\n    // No console - can't enable logging.\n    if (!this.win.console || !this.win.console.log) {\n      return LogLevel.OFF;\n    }\n\n    // Logging has been explicitly disabled.\n    if (getMode().log == '0') {\n      return LogLevel.OFF;\n    }\n\n    // Logging is enabled for tests directly.\n    if (getMode().test && this.win.ENABLE_LOG) {\n      return LogLevel.FINE;\n    }\n\n    // LocalDev by default allows INFO level, unless overriden by `#log`.\n    if (getMode().localDev && !getMode().log) {\n      return LogLevel.INFO;\n    }\n\n    return this.defaultLevelWithFunc_();\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevelWithFunc_() {\n    // Delegate to the specific resolver.\n    return this.levelFunc_(parseInt(getMode().log, 10), getMode().development);\n  }\n\n  /**\n   * @param {string} tag\n   * @param {!LogLevel} level\n   * @param {!Array} messages\n   * @return {boolean} true if a message was logged\n   */\n  msg_(tag, level, messages) {\n    if (this.getLevel_() < level) {\n      return false;\n    }\n    let fn = this.win.console.log;\n    if (level == LogLevel.ERROR) {\n      fn = this.win.console.error || fn;\n    } else if (level == LogLevel.INFO) {\n      fn = this.win.console.info || fn;\n    } else if (level == LogLevel.WARN) {\n      fn = this.win.console.warn || fn;\n    }\n    const args = this.maybeExpandMessageArgs_(messages);\n    // Prefix console message with \"[tag]\".\n    const prefix = `[${tag}]`;\n    if (typeof args[0] === 'string') {\n      // Prepend string to avoid breaking string substitutions e.g. %s.\n      args[0] = prefix + ' ' + args[0];\n    } else {\n      args.unshift(prefix);\n    }\n    fn.apply(this.win.console, args);\n    return true;\n  }\n\n  /**\n   * Whether the logging is enabled.\n   * @return {boolean}\n   */\n  isEnabled() {\n    return this.getLevel_() != LogLevel.OFF;\n  }\n\n  /**\n   * Reports a fine-grained message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  fine(tag, ...args) {\n    this.msg_(tag, LogLevel.FINE, args);\n  }\n\n  /**\n   * Reports a informational message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  info(tag, ...args) {\n    this.msg_(tag, LogLevel.INFO, args);\n  }\n\n  /**\n   * Reports a warning message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  warn(tag, ...args) {\n    this.msg_(tag, LogLevel.WARN, args);\n  }\n\n  /**\n   * Reports an error message. If the logging is disabled, the error is rethrown\n   * asynchronously.\n   * @param {string} tag\n   * @param {...*} args\n   * @return {!Error|undefined}\n   * @private\n   */\n  error_(tag, ...args) {\n    if (!this.msg_(tag, LogLevel.ERROR, args)) {\n      return this.createError.apply(this, args);\n    }\n  }\n\n  /**\n   * Reports an error message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  error(tag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      // TODO(rcebulko): Determine if/how this Error#name property is used.\n      error.name = tag || error.name;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Reports an error message and marks with an expected property. If the\n   * logging is disabled, the error is rethrown asynchronously.\n   * @param {string} unusedTag\n   * @param {...*} var_args\n   */\n  expectedError(unusedTag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      error.expected = true;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Creates an error object.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    return error;\n  }\n\n  /**\n   * Creates an error object with its expected property set to true.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createExpectedError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    error.expected = true;\n    return error;\n  }\n\n  /**\n   * Throws an error if the first argument isn't trueish.\n   *\n   * Supports argument substitution into the message via %s placeholders.\n   *\n   * Throws an error object that has two extra properties:\n   * - associatedElement: This is the first element provided in the var args.\n   *   It can be used for improved display of error messages.\n   * - messageArray: The elements of the substituted message as non-stringified\n   *   elements in an array. When e.g. passed to console.error this yields\n   *   native displays of things like HTML elements.\n   *\n   * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n   *     not evaluate to true.\n   * @param {!Array|string=} opt_message The assertion message\n   * @param {...*} var_args Arguments substituted into %s in the message.\n   * @return {T} The value of shouldBeTrueish.\n   * @throws {!Error} When `value` is falsey.\n   * @template T\n   * @closurePrimitive {asserts.truthy}\n   */\n  assert(shouldBeTrueish, opt_message, var_args) {\n    if (isArray(opt_message)) {\n      return this.assert.apply(\n        this,\n        [shouldBeTrueish].concat(\n          this.expandMessageArgs_(/** @type {!Array} */ (opt_message))\n        )\n      );\n    }\n\n    return assertions.assert.apply(\n      null,\n      [this.suffix_].concat(Array.prototype.slice.call(arguments))\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't an Element\n   *\n   * Otherwise see `assert` for usage\n   *\n   * @param {*} shouldBeElement\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Element} The value of shouldBeTrueish.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertElement(shouldBeElement, opt_message) {\n    return assertions.assertElement(\n      this.boundAssertFn_,\n      shouldBeElement,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a string. The string can\n   * be empty.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeString\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {string} The string value. Can be an empty string.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertString(shouldBeString, opt_message) {\n    return assertions.assertString(\n      this.boundAssertFn_,\n      shouldBeString,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a number. The allowed values\n   * include `0` and `NaN`.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeNumber\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {number} The number value. The allowed values include `0`\n   *   and `NaN`.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertNumber(shouldBeNumber, opt_message) {\n    return assertions.assertNumber(\n      this.boundAssertFn_,\n      shouldBeNumber,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument is not an array.\n   * The array can be empty.\n   *\n   * @param {*} shouldBeArray\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Array} The array value\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertArray(shouldBeArray, opt_message) {\n    return assertions.assertArray(\n      this.boundAssertFn_,\n      shouldBeArray,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a boolean.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeBoolean\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {boolean} The boolean value.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertBoolean(shouldBeBoolean, opt_message) {\n    return assertions.assertBoolean(\n      this.boundAssertFn_,\n      shouldBeBoolean,\n      opt_message\n    );\n  }\n\n  /**\n   * @param {!Error} error\n   * @private\n   */\n  prepareError_(error) {\n    error = duplicateErrorIfNecessary(error);\n\n    if (this.suffix_) {\n      if (!error.message) {\n        error.message = this.suffix_;\n      } else if (error.message.indexOf(this.suffix_) == -1) {\n        error.message += this.suffix_;\n      }\n    } else if (isUserErrorMessage(error.message)) {\n      error.message = error.message.replace(USER_ERROR_SENTINEL, '');\n    }\n  }\n\n  /**\n   * @param {!Array} args\n   * @return {!Array}\n   * @private\n   */\n  maybeExpandMessageArgs_(args) {\n    if (isArray(args[0])) {\n      return this.expandMessageArgs_(/** @type {!Array} */ (args[0]));\n    }\n    return args;\n  }\n\n  /**\n   * Either redirects a pair of (errorId, ...args) to a URL where the full\n   * message is displayed, or displays it from a fetched table.\n   *\n   * This method is used by the output of the `transform-log-methods` babel\n   * plugin. It should not be used directly. Use the (*error|assert*|info|warn)\n   * methods instead.\n   *\n   * @param {!Array} parts\n   * @return {!Array}\n   * @private\n   */\n  expandMessageArgs_(parts) {\n    // First value should exist.\n    const id = parts.shift();\n    // Best effort fetch of message template table.\n    // Since this is async, the first few logs might be indirected to a URL even\n    // if in development mode. Message table is ~small so this should be a short\n    // gap.\n    if (getMode(this.win).development) {\n      this.fetchExternalMessagesOnce_();\n    }\n    if (this.messages_ && id in this.messages_) {\n      return [this.messages_[id]].concat(parts);\n    }\n    return [`More info at ${externalMessageUrl(id, parts)}`];\n  }\n}\n\n/**\n * Cache for logs. We do not use a Service since the service module depends\n * on Log and closure literally can't even.\n * @type {{user: ?Log, dev: ?Log, userForEmbed: ?Log}}\n */\nself.__AMP_LOG = self.__AMP_LOG || {\n  user: null,\n  dev: null,\n  userForEmbed: null,\n};\n\nconst logs = self.__AMP_LOG;\n\n/**\n * Eventually holds a constructor for Log objects. Lazily initialized, so we\n * can avoid ever referencing the real constructor except in JS binaries\n * that actually want to include the implementation.\n * @type {?typeof Log}\n */\nlet logConstructor = null;\n\n/**\n * Initializes log constructor.\n */\nexport function initLogConstructor() {\n  logConstructor = Log;\n  // Initialize instances for use. If a binary (an extension for example) that\n  // does not call `initLogConstructor` invokes `dev()` or `user()` earlier than\n  // the binary that does call `initLogConstructor` (amp.js), the extension will\n  // throw an error as that extension will never be able to initialize the log\n  // instances and we also don't want it to call `initLogConstructor` either\n  // (since that will cause the Log implementation to be bundled into that\n  // binary). So we must initialize the instances eagerly so that they are ready\n  // for use (stored globally) after the main binary calls `initLogConstructor`.\n  dev();\n  user();\n}\n\n/**\n * Resets log constructor for testing.\n */\nexport function resetLogConstructorForTesting() {\n  logConstructor = null;\n}\n\n/**\n * Publisher level log.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Development mode is enabled via `#development=1` or logging is explicitly\n *     enabled via `#log=D` where D >= 1.\n *  3. AMP.setLogLevel(D) is called, where D >= 1.\n *\n * @param {!Element=} opt_element\n * @return {!Log}\n */\nexport function user(opt_element) {\n  if (!logs.user) {\n    logs.user = getUserLogger(USER_ERROR_SENTINEL);\n  }\n  if (!isFromEmbed(logs.user.win, opt_element)) {\n    return logs.user;\n  } else {\n    if (logs.userForEmbed) {\n      return logs.userForEmbed;\n    }\n    return (logs.userForEmbed = getUserLogger(USER_ERROR_EMBED_SENTINEL));\n  }\n}\n\n/**\n * Getter for user logger\n * @param {string=} suffix\n * @return {!Log}\n */\nfunction getUserLogger(suffix) {\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return new logConstructor(\n    self,\n    (logNum, development) => {\n      if (development || logNum >= 1) {\n        return LogLevel.FINE;\n      }\n      return LogLevel.WARN;\n    },\n    suffix\n  );\n}\n\n/**\n * AMP development log. Calls to `devLog().assert` and `dev.fine` are stripped\n * in the PROD binary. However, `devLog().assert` result is preserved in either\n * case.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Logging is explicitly enabled via `#log=D`, where D >= 2.\n *  3. AMP.setLogLevel(D) is called, where D >= 2.\n *\n * @return {!Log}\n */\nexport function dev() {\n  if (logs.dev) {\n    return logs.dev;\n  }\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return (logs.dev = new logConstructor(self, (logNum) => {\n    if (logNum >= 3) {\n      return LogLevel.FINE;\n    }\n    if (logNum >= 2) {\n      return LogLevel.INFO;\n    }\n    return LogLevel.OFF;\n  }));\n}\n\n/**\n * @param {!Window} win\n * @param {!Element=} opt_element\n * @return {boolean} isEmbed\n */\nexport function isFromEmbed(win, opt_element) {\n  if (!opt_element) {\n    return false;\n  }\n  return opt_element.ownerDocument.defaultView != win;\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function devAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (getMode().minified) {\n    return shouldBeTrueish;\n  }\n  if (self.__AMP_ASSERTION_CHECK) {\n    // This will never execute regardless, but will be included on unminified\n    // builds. It will be DCE'd away from minified builds, and so can be used to\n    // validate that Babel is properly removing dev assertions in minified\n    // builds.\n    console /*OK*/\n      .log('__devAssert_sentinel__');\n  }\n\n  return dev()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function userAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  return user()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Externs declare that access `defaultView` from `document` or\n * `ownerDocument` is of type `(Window|null)` but most of our parameter types\n * assume that it is never null. This is OK in practice as we ever only get\n * null on disconnected documents or old IE.\n * This helper function casts it into just a simple Window return type.\n *\n * @param {?Window} winOrNull\n * @return {!Window}\n */\nexport function toWin(winOrNull) {\n  return /** @type {!Window} */ (winOrNull);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Registration and getter functions for AMP services.\n *\n * Invariant: Service getters never return null for registered services.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {dev, devAssert} from './log';\nimport {toWin} from './core/window';\n\n/**\n * Holds info about a service.\n * - obj: Actual service implementation when available.\n * - promise: Promise for the obj.\n * - resolve: Function to resolve the promise with the object.\n * - context: Argument for ctor, either a window or an ampdoc.\n * - ctor: Function that constructs and returns the service.\n * @typedef {{\n *   obj: (?Object),\n *   promise: (?Promise),\n *   resolve: (?function(!Object)),\n *   reject: (?function((*))),\n *   context: (?Window|?./service/ampdoc-impl.AmpDoc),\n *   ctor: (function(new:Object, !Window)|\n *          function(new:Object, !./service/ampdoc-impl.AmpDoc)),\n * }}\n */\nlet ServiceHolderDef;\n\n/**\n * This interface provides a `dispose` method that will be called by\n * runtime when a service needs to be disposed of.\n * @interface\n */\nexport class Disposable {\n  /**\n   * Instructs the service to release any resources it might be holding. Can\n   * be called only once in the lifecycle of a service.\n   */\n  dispose() {}\n}\n\n/**\n * Installs a service override on amp-doc level.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n * @param {!Object} service The service.\n */\nexport function installServiceInEmbedDoc(ampdoc, id, service) {\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    function () {\n      return service;\n    },\n    /* override */ true\n  );\n}\n\n/**\n * Installs a service override in the scope of an embedded window.\n * @param {!Window} embedWin\n * @param {string} id\n * @param {function(new:Object, !Window)} constructor\n */\nexport function registerServiceBuilderInEmbedWin(embedWin, id, constructor) {\n  registerServiceInternal(\n    embedWin,\n    embedWin,\n    id,\n    constructor,\n    /* override */ true\n  );\n}\n\n/**\n * Registers a service given a class to be used as implementation.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {function(new:Object, !Window)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilder(win, id, constructor, opt_instantiate) {\n  win = getTopWindow(win);\n  registerServiceInternal(win, win, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(win, id);\n  }\n}\n\n/**\n * Returns a service and registers it given a class to be used as\n * implementation.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id of the service.\n * @param {function(new:Object, !./service/ampdoc-impl.AmpDoc)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilderForDoc(\n  nodeOrDoc,\n  id,\n  constructor,\n  opt_instantiate\n) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  registerServiceInternal(holder, ampdoc, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * Reject a service promise.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id\n * @param {*} error\n */\nexport function rejectServicePromiseForDoc(nodeOrDoc, id, error) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  rejectServicePromiseInternal(holder, id, error);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). Users\n * should typically wrap this as a special purpose function (e.g.\n * `Services.vsyncFor(win)`) for type safety and because the factory should not\n * be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getService(win, id) {\n  win = getTopWindow(win);\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). But\n * it looks in the immediate window scope, not the top-level window.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getServiceInEmbedWin(win, id) {\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. `Services.vsyncFor(win)`) for type safety and because the\n * factory should not be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nexport function getServicePromise(win, id) {\n  return getServicePromiseInternal(win, id);\n}\n\n/**\n * Returns a service or null with the given id.\n * @param {!Window} win\n * @param {string} id\n * @return {?Object} The service.\n */\nexport function getExistingServiceOrNull(win, id) {\n  win = getTopWindow(win);\n  if (isServiceRegistered(win, id)) {\n    return getServiceInternal(win, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Like getServicePromise but returns null if the service was never registered.\n * @param {!Window} win\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNull(win, id) {\n  return getServicePromiseOrNullInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * Expects service `id` to be registered.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {T}\n * @template T\n */\nexport function getServiceForDoc(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  return getServiceInternal(holder, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * If service `id` is not registered, returns null.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Object}\n */\nexport function getServiceForDocOrNull(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  if (isServiceRegistered(holder, id)) {\n    return getServiceInternal(holder, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Returns a promise for a service for the given id and ampdoc. Also expects\n * a service that has the actual implementation. The promise resolves when\n * the implementation loaded.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {!Promise<!Object>}\n */\nexport function getServicePromiseForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseInternal(getAmpdocServiceHolder(elementOrAmpDoc), id);\n}\n\n/**\n * Like getServicePromiseForDoc but returns null if the service was never\n * registered for this ampdoc.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNullForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseOrNullInternal(\n    getAmpdocServiceHolder(elementOrAmpDoc),\n    id\n  );\n}\n\n/**\n * Set the parent and top windows on a child window (friendly iframe).\n * @param {!Window} win\n * @param {!Window} parentWin\n */\nexport function setParentWindow(win, parentWin) {\n  win.__AMP_PARENT = parentWin;\n  win.__AMP_TOP = getTopWindow(parentWin);\n}\n\n/**\n * Returns the parent window for a child window (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getParentWindow(win) {\n  return win.__AMP_PARENT || win;\n}\n\n/**\n * Returns the top window where AMP Runtime is installed for a child window\n * (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getTopWindow(win) {\n  return win.__AMP_TOP || (win.__AMP_TOP = win);\n}\n\n/**\n * Returns the parent \"friendly\" iframe if the node belongs to a child window.\n * @param {!Node} node\n * @param {!Window=} opt_topWin\n * @return {?HTMLIFrameElement}\n */\nexport function getParentWindowFrameElement(node, opt_topWin) {\n  const childWin = (node.ownerDocument || node).defaultView;\n  const topWin = opt_topWin || getTopWindow(childWin);\n  if (childWin && childWin != topWin && getTopWindow(childWin) == topWin) {\n    try {\n      return /** @type {?HTMLIFrameElement} */ (childWin.frameElement);\n    } catch (e) {\n      // Ignore the error.\n    }\n  }\n  return null;\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc}\n */\nexport function getAmpdoc(nodeOrDoc) {\n  if (nodeOrDoc.nodeType) {\n    const win = toWin(\n      /** @type {!Document} */ (nodeOrDoc.ownerDocument || nodeOrDoc)\n        .defaultView\n    );\n    return getAmpdocService(win).getAmpDoc(/** @type {!Node} */ (nodeOrDoc));\n  }\n  return /** @type {!./service/ampdoc-impl.AmpDoc} */ (nodeOrDoc);\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc|!Window}\n */\nfunction getAmpdocServiceHolder(nodeOrDoc) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  return ampdoc.isSingleDoc() ? ampdoc.win : ampdoc;\n}\n\n/**\n * This is essentially a duplicate of `ampdoc.js`, but necessary to avoid\n * circular dependencies.\n * @param {!Window} win\n * @return {!./service/ampdoc-impl.AmpDocService}\n */\nfunction getAmpdocService(win) {\n  return /** @type {!./service/ampdoc-impl.AmpDocService} */ (\n    getService(win, 'ampdoc')\n  );\n}\n\n/**\n * Get service `id` from `holder`. Assumes the service\n * has already been registered.\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {Object}\n */\nfunction getServiceInternal(holder, id) {\n  devAssert(\n    isServiceRegistered(holder, id),\n    `Expected service ${id} to be registered`\n  );\n  const services = getServices(holder);\n  const s = services[id];\n  if (!s.obj) {\n    devAssert(s.ctor, `Service ${id} registered without ctor nor impl.`);\n    devAssert(s.context, `Service ${id} registered without context.`);\n    s.obj = new s.ctor(s.context);\n    devAssert(s.obj, `Service ${id} constructed to null.`);\n    s.context = null;\n    // The service may have been requested already, in which case we have a\n    // pending promise we need to fulfill.\n    if (s.resolve) {\n      s.resolve(s.obj);\n    }\n  }\n  return s.obj;\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {!Window|!./service/ampdoc-impl.AmpDoc} context Win or AmpDoc.\n * @param {string} id of the service.\n * @param {?function(new:Object, !Window)|?function(new:Object, !./service/ampdoc-impl.AmpDoc)} ctor Constructor function to new the service. Called with context.\n * @param {boolean=} opt_override\n * @param {boolean=} opt_sharedInstance\n */\nfunction registerServiceInternal(\n  holder,\n  context,\n  id,\n  ctor,\n  opt_override,\n  opt_sharedInstance\n) {\n  const services = getServices(holder);\n  let s = services[id];\n\n  if (!s) {\n    s = services[id] = {\n      obj: null,\n      promise: null,\n      resolve: null,\n      reject: null,\n      context: null,\n      ctor: null,\n      sharedInstance: opt_sharedInstance || false,\n    };\n  }\n\n  if (!opt_override && s.ctor) {\n    // Service already registered.\n    return;\n  }\n\n  s.ctor = ctor;\n  s.context = context;\n  s.sharedInstance = opt_sharedInstance || false;\n\n  // The service may have been requested already, in which case there is a\n  // pending promise that needs to fulfilled.\n  if (s.resolve) {\n    // getServiceInternal will resolve the promise.\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nfunction getServicePromiseInternal(holder, id) {\n  const cached = getServicePromiseOrNullInternal(holder, id);\n  if (cached) {\n    return cached;\n  }\n  // Service is not registered.\n\n  // TODO(@cramforce): Add a check that if the element is eventually registered\n  // that the service is actually provided and this promise resolves.\n  const services = getServices(holder);\n  services[id] = emptyServiceHolderWithPromise();\n  return /** @type {!Promise<!Object>} */ (services[id].promise);\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @param {*} error\n */\nfunction rejectServicePromiseInternal(holder, id, error) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.reject) {\n      s.reject(error);\n    }\n    return;\n  }\n\n  services[id] = emptyServiceHolderWithPromise();\n  services[id].reject(error);\n}\n\n/**\n * Returns a promise for service `id` if the service has been registered\n * on `holder`.\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {?Promise<!Object>}\n */\nfunction getServicePromiseOrNullInternal(holder, id) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.promise) {\n      return s.promise;\n    } else {\n      // Instantiate service if not already instantiated.\n      getServiceInternal(holder, id);\n      return (s.promise = Promise.resolve(/** @type {!Object} */ (s.obj)));\n    }\n  }\n  return null;\n}\n\n/**\n * Returns the object that holds the services registered in a holder.\n * @param {!Object} holder\n * @return {!Object<string,!ServiceHolderDef>}\n */\nfunction getServices(holder) {\n  let services = holder.__AMP_SERVICES;\n  if (!services) {\n    services = holder.__AMP_SERVICES = {};\n  }\n  return services;\n}\n\n/**\n * Whether the specified service implements `Disposable` interface.\n * @param {!Object} service\n * @return {boolean}\n */\nexport function isDisposable(service) {\n  return typeof service.dispose == 'function';\n}\n\n/**\n * Asserts that the specified service implements `Disposable` interface and\n * typecasts the instance to `Disposable`.\n * @param {!Object} service\n * @return {!Disposable}\n */\nexport function assertDisposable(service) {\n  devAssert(isDisposable(service), 'required to implement Disposable');\n  return /** @type {!Disposable} */ (service);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * ampdoc scope.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function disposeServicesForDoc(ampdoc) {\n  disposeServicesInternal(ampdoc);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * embed scope.\n * @param {!Window} embedWin\n */\nexport function disposeServicesForEmbed(embedWin) {\n  disposeServicesInternal(embedWin);\n}\n\n/**\n * @param {!Object} holder Object holding the service instances.\n */\nfunction disposeServicesInternal(holder) {\n  const services = getServices(holder);\n  for (const id in services) {\n    if (!Object.prototype.hasOwnProperty.call(services, id)) {\n      continue;\n    }\n    const serviceHolder = services[id];\n    if (serviceHolder.sharedInstance) {\n      continue;\n    }\n    if (serviceHolder.obj) {\n      disposeServiceInternal(id, serviceHolder.obj);\n    } else if (serviceHolder.promise) {\n      serviceHolder.promise.then((instance) =>\n        disposeServiceInternal(id, instance)\n      );\n    }\n  }\n}\n\n/**\n * @param {string} id\n * @param {!Object} service\n */\nfunction disposeServiceInternal(id, service) {\n  if (!isDisposable(service)) {\n    return;\n  }\n  try {\n    assertDisposable(service).dispose();\n  } catch (e) {\n    // Ensure that a failure to dispose a service does not disrupt other\n    // services.\n    dev().error('SERVICE', 'failed to dispose service', id, e);\n  }\n}\n\n/**\n * This adopts the service **instance** from the parent.\n *\n * This function is dangerous! Sharing an instance means data can leak to and\n * from a child ampdoc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceForEmbedDoc(ampdoc, id) {\n  const service = getServiceInternal(\n    getAmpdocServiceHolder(devAssert(ampdoc.getParent())),\n    id\n  );\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    function () {\n      return service;\n    },\n    /* override */ false,\n    /* sharedInstance */ true\n  );\n}\n\n/**\n * This adopts the service **factory** from the parent.\n *\n * This function is safer than sharing the service instance, since each ampdoc\n * will create its own instance of the factory (and each instance will have its\n * own instance data). Note that static data is still shared, so it's not 100%\n * foolproof.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceFactoryForEmbedDoc(ampdoc, id) {\n  const parentHolder = getAmpdocServiceHolder(devAssert(ampdoc.getParent()));\n  devAssert(\n    isServiceRegistered(parentHolder, id),\n    `Expected service ${id} to be registered`\n  );\n  const service = getServices(parentHolder)[id];\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    devAssert(service.ctor)\n  );\n}\n\n/**\n * Resets a single service, so it gets recreated on next getService invocation.\n * @param {!Object} holder\n * @param {string} id of the service.\n */\nexport function resetServiceForTesting(holder, id) {\n  if (holder.__AMP_SERVICES) {\n    holder.__AMP_SERVICES[id] = null;\n  }\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {boolean}\n */\nfunction isServiceRegistered(holder, id) {\n  const service = holder.__AMP_SERVICES && holder.__AMP_SERVICES[id];\n  // All registered services must have a constructor.\n  return !!(service && service.ctor);\n}\n\n/** @return {!ServiceHolderDef} */\nfunction emptyServiceHolderWithPromise() {\n  const deferred = new Deferred();\n  const {promise, reject, resolve} = deferred;\n  promise.catch(() => {}); // avoid uncaught exception when service gets rejected\n  return {\n    obj: null,\n    promise,\n    resolve,\n    reject,\n    context: null,\n    ctor: null,\n  };\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Magic constant that is replaced by babel.\n// IS_MINIFIED is always replaced with true when closure compiler is used\nconst IS_MINIFIED = false;\n\n/**\n * Returns true whenever closure compiler is used.\n * @return {boolean}\n */\nexport function isMinifiedMode() {\n  return IS_MINIFIED;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assertions from './base';\nimport {isMinifiedMode} from '../minified-mode';\n\n/**\n * @fileoverview This file provides the entrypoint for dev assertions. It's\n * designed so all functions are pure function calls to improve inlining. All\n * functions in this file get DCE'd away during compilation.\n */\n\n/**\n * This will never execute regardless, but will be included on unminified builds\n * builds. It will be DCE'd away from minified builds, and so can be used to\n * validate that Babel is properly removing dev assertions in minified builds.\n */\nfunction devAssertDceCheck() {\n  if (self.__AMP_ASSERTION_CHECK) {\n    console /*OK*/\n      .log('__devAssert_sentinel__');\n  }\n}\n\n/**\n * Throws an error if the first argument isn't trueish. Mirrors devAssert in\n * src/log.js.\n * @param {T} shouldBeTruthy\n * @param {string=} opt_message\n * @param {*=} opt_1 Optional argument (var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T}\n * @template T\n * @throws {Error} when shouldBeTruthy is not truthy.\n * @closurePrimitive {asserts.truthy}\n */\nexport function devAssert(\n  shouldBeTruthy,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (isMinifiedMode()) {\n    return shouldBeTruthy;\n  }\n  devAssertDceCheck();\n\n  return assertions.assert(\n    '',\n    shouldBeTruthy,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't an Element.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeElement\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Element} The value of shouldBeTrueish.\n * @throws {Error} when shouldBeElement is not an Element\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertElement(shouldBeElement, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {!Element} */ (shouldBeElement);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertElement(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeElement,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a string. The string can\n * be empty.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeString\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {string} The string value. Can be an empty string.\n * @throws {Error} when shouldBeString is not an String\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertString(shouldBeString, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {string} */ (shouldBeString);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertString(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeString,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a number. The allowed values\n * include `0` and `NaN`.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeNumber\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {number} The number value. The allowed values include `0`\n *   and `NaN`.\n * @throws {Error} when shouldBeNumber is not an Number\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertNumber(shouldBeNumber, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {number} */ (shouldBeNumber);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertNumber(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeNumber,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument is not an array.\n * The array can be empty.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeArray\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {!Array} The array value\n * @throws {Error} when shouldBeArray is not an Array\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertArray(shouldBeArray, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {!Array} */ (shouldBeArray);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertArray(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeArray,\n    opt_message\n  );\n}\n\n/**\n * Throws an error if the first argument isn't a boolean.\n *\n * For more details see `assert`.\n *\n * @param {*} shouldBeBoolean\n * @param {!Array<*>|string=} opt_message The assertion message\n * @return {boolean} The boolean value.\n * @throws {Error} when shouldBeBoolean is not an Boolean\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssertBoolean(shouldBeBoolean, opt_message) {\n  if (isMinifiedMode()) {\n    return /** @type {boolean} */ (shouldBeBoolean);\n  }\n  devAssertDceCheck();\n\n  return assertions.assertBoolean(\n    /** @type {!assertions.AssertionFunctionDef} */ (devAssert),\n    shouldBeBoolean,\n    opt_message\n  );\n}\n", "/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */\n\n\n/**\n * This regex consists of 4 matching capture groups and one (non-matching) fallback:\n *\n * - (\\0), catch the null terminator character so it may be replaced by UTF\n *   Replacement Char\n * - ^(-)$, catch a solitary dash char, so that it may be backslash escaped.\n *   This is a separate capture group so that the legal-chars (group 4) doesn't\n *   capture it first, since that group doesn't need to escape its dash.\n * - ([\\x01-\\x1f\\x7f]|^-?[0-9]), catch a UTF control char, or any leading\n *   number (with an optional leading dash). The control or the number (but not\n *   the leading dash) must be hex-escaped,.\n * - ([\\x80-\\uffff0-9a-zA-Z_-]+), catch legal-chars, with the exception of a\n *   solitary dash, which will already have matched in group 1.\n * - [^], finally, a catch-all that allows us to backslash escape the char.\n *\n * Together, this matches everything necessary for CSS.escape.\n */\nvar regex = /(\\0)|^(-)$|([\\x01-\\x1f\\x7f]|^-?[0-9])|([\\x80-\\uffff0-9a-zA-Z_-]+)|[^]/g;\n\nfunction escaper(match, nil, dash, hexEscape, chars) {\n  // Chars is the legal-chars (group 4) capture\n  if (chars) {\n    return chars;\n  }\n  // Nil is the null terminator (group 1) capture\n  if (nil) {\n    return '\\uFFFD';\n  }\n  // Both UTF control chars, and leading numbers (with optional leading dash)\n  // (group 3) must be backslash escaped with a trailing space.  Funnily, the\n  // leading dash must not be escaped, but the number. :shrug:\n  if (hexEscape) {\n    return match.slice(0, -1) + '\\\\' + match.slice(-1).charCodeAt(0).toString(16) + ' '\n  }\n  // Finally, the solitary dash and the catch-all chars require backslash\n  // escaping.\n  return '\\\\' + match;\n}\n\n/**\n * https://drafts.csswg.org/cssom/#serialize-an-identifier\n * @param {string} value\n * @return {string}\n */\nexport function cssEscape(value) {\n  return String(value).replace(regex, escaper);\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {cssEscape} from '../../../third_party/css-escape/css-escape';\nimport {devAssert} from '../assert';\n\n/**\n * @type {boolean|undefined}\n */\nlet scopeSelectorSupported;\n\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\nexport function setScopeSelectorSupportedForTesting(val) {\n  scopeSelectorSupported = val;\n}\n\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element|!ShadowRoot} el\n * @return {boolean}\n */\nexport function isScopeSelectorSupported(el) {\n  if (scopeSelectorSupported !== undefined) {\n    return scopeSelectorSupported;\n  }\n\n  return (scopeSelectorSupported = testScopeSelector(el));\n}\n\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element|!ShadowRoot} el\n * @return {boolean}\n */\nfunction testScopeSelector(el) {\n  try {\n    const doc = el.ownerDocument;\n    const testElement = doc.createElement('div');\n    const testChild = doc.createElement('div');\n    testElement.appendChild(testChild);\n    // NOTE(cvializ, #12383): Firefox's implementation is incomplete,\n    // therefore we test actual functionality of`:scope` as well.\n    return testElement./*OK*/ querySelector(':scope div') === testChild;\n  } catch (e) {\n    return false;\n  }\n}\n\n/**\n * Prefixes a selector for ancestor selection. Splits in subselectors and\n * applies prefix to each.\n *\n * e.g.\n * ```\n *   prependSelectorsWith('div', '.i-amphtml-scoped');\n *   // => '.i-amphtml-scoped div'\n *   prependSelectorsWith('div, ul', ':scope');\n *   // => ':scope div, :scope ul'\n *   prependSelectorsWith('div, ul', 'article >');\n *   // => 'article > div, article > ul'\n * ```\n *\n * @param {string} selector\n * @param {string} distribute\n * @return {string}\n */\nexport function prependSelectorsWith(selector, distribute) {\n  return selector.replace(/^|,/g, `$&${distribute} `);\n}\n\n/**\n * Escapes an ident (ID or a class name) to be used as a CSS selector.\n *\n * See https://drafts.csswg.org/cssom/#serialize-an-identifier.\n *\n * @param {string} ident\n * @return {string}\n * @suppress {uselessCode}\n */\nexport function escapeCssSelectorIdent(ident) {\n  // This gets rewritten to true/false during compilation. It will trigger an\n  // JSC_UNREACHABLE_CODE warning, but that's intentional for DCE.\n  if (IS_ESM) {\n    return CSS.escape(ident);\n  }\n  return cssEscape(ident);\n}\n\n/**\n * Escapes an ident in a way that can be used by :nth-child() psuedo-class.\n *\n * See https://github.com/w3c/csswg-drafts/issues/2306.\n *\n * @param {string|number} ident\n * @return {string}\n */\nexport function escapeCssSelectorNth(ident) {\n  const escaped = String(ident);\n  // Ensure it doesn't close the nth-child psuedo class.\n  devAssert(escaped.indexOf(')') === -1);\n  return escaped;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../assert';\nimport {isScopeSelectorSupported, prependSelectorsWith} from './css-selectors';\n\n/** @fileoverview Helper functions for DOM queries. */\n\n/**\n * Asserts that name is just an alphanumeric word, and does not contain\n * advanced CSS selector features like attributes, psuedo-classes, class names,\n * nor ids.\n * @param {string} name\n */\nfunction assertIsName(name) {\n  devAssert(\n    /^[\\w-]+$/.test(name),\n    `Expected \"${name}\" to be a CSS name composed of alphanumerics and hyphens.`\n  );\n}\n\n/**\n * Finds all elements that matche `selector`, scoped inside `root`\n * for user-agents that do not support native scoping.\n *\n * This method isn't required for modern builds, can be removed.\n *\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n */\nfunction scopedQuerySelectionFallback(root, selector) {\n  const unique = 'i-amphtml-scoped';\n  root.classList.add(unique);\n  const scopedSelector = prependSelectorsWith(selector, `.${unique}`);\n  const elements = root./*OK*/ querySelectorAll(scopedSelector);\n  root.classList.remove(unique);\n  return elements;\n}\n\n/**\n * Finds the first element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {?Element}\n *\n * @suppress {suspiciousCode}\n */\nexport function scopedQuerySelector(root, selector) {\n  if (IS_ESM || isScopeSelectorSupported(root)) {\n    return root./*OK*/ querySelector(prependSelectorsWith(selector, ':scope'));\n  }\n\n  // Only IE.\n  const fallbackResult = scopedQuerySelectionFallback(root, selector);\n  return fallbackResult[0] === undefined ? null : fallbackResult[0];\n}\n\n/**\n * Finds every element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n *\n * @suppress {suspiciousCode}\n */\nexport function scopedQuerySelectorAll(root, selector) {\n  if (IS_ESM || isScopeSelectorSupported(root)) {\n    return root./*OK*/ querySelectorAll(\n      prependSelectorsWith(selector, ':scope')\n    );\n  }\n\n  // Only IE.\n  return scopedQuerySelectionFallback(root, selector);\n}\n\n/**\n * Checks if the given element matches the selector\n * @param  {!Element} el The element to verify\n * @param  {string} selector The selector to check against\n * @return {boolean} True if the element matched the selector. False otherwise.\n */\nexport function matches(el, selector) {\n  const matcher =\n    el.matches ||\n    el.webkitMatchesSelector ||\n    el.mozMatchesSelector ||\n    el.msMatchesSelector ||\n    el.oMatchesSelector;\n  if (matcher) {\n    return matcher.call(el, selector);\n  }\n  return false; // IE8 always returns false.\n}\n\n/**\n * Finds the closest element that satisfies the callback from this element\n * up the DOM subtree.\n * @param {!Element} element\n * @param {function(!Element):boolean} callback\n * @param {Element=} opt_stopAt optional elemnt to stop the search at.\n * @return {?Element}\n */\nexport function closest(element, callback, opt_stopAt) {\n  for (let el = element; el && el !== opt_stopAt; el = el.parentElement) {\n    if (callback(el)) {\n      return el;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the closest node that satisfies the callback from this node\n * up the DOM subtree.\n * @param {!Node} node\n * @param {function(!Node):boolean} callback\n * @return {?Node}\n */\nexport function closestNode(node, callback) {\n  for (let n = node; n; n = n.parentNode) {\n    if (callback(n)) {\n      return n;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the closest ancestor element with the specified selector from this\n * element.\n * @param {!Element} element\n * @param {string} selector\n * @return {?Element} closest ancestor if found.\n */\nexport function closestAncestorElementBySelector(element, selector) {\n  return element.closest\n    ? element.closest(selector)\n    : closest(element, (el) => matches(el, selector));\n}\n\n/**\n * Finds all ancestor elements that satisfy predicate.\n * @param {!Element} child\n * @param {function(!Element):boolean} predicate\n * @return {!Array<!Element>}\n */\nexport function ancestorElements(child, predicate) {\n  const ancestors = [];\n  for (\n    let ancestor = child.parentElement;\n    ancestor;\n    ancestor = ancestor.parentElement\n  ) {\n    if (predicate(ancestor)) {\n      ancestors.push(ancestor);\n    }\n  }\n  return ancestors;\n}\n\n/**\n * Finds all ancestor elements that has the specified tag name.\n * @param {!Element} child\n * @param {string} tagName\n * @return {!Array<!Element>}\n */\nexport function ancestorElementsByTag(child, tagName) {\n  assertIsName(tagName);\n  tagName = tagName.toUpperCase();\n  return ancestorElements(child, (el) => el.tagName == tagName);\n}\n\n/**\n * Finds the first child element that satisfies the callback.\n * TODO(rcebulko): Can we start using generators in childElements and defer to\n * that here?\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function childElement(parent, callback) {\n  for (\n    let child = parent.firstElementChild;\n    child;\n    child = child.nextElementSibling\n  ) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the last child element that satisfies the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function lastChildElement(parent, callback) {\n  for (\n    let child = parent.lastElementChild;\n    child;\n    child = child.previousElementSibling\n  ) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds all child elements that satisfy the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {!Array<!Element>}\n */\nexport function childElements(parent, callback) {\n  const children = [];\n  for (\n    let child = parent.firstElementChild;\n    child;\n    child = child.nextElementSibling\n  ) {\n    if (callback(child)) {\n      children.push(child);\n    }\n  }\n  return children;\n}\n\n/**\n * Finds all child nodes that satisfy the callback.\n * These nodes can include Text, Comment and other child nodes.\n * @param {!Node} parent\n * @param {function(!Node):boolean} callback\n * @return {!Array<!Node>}\n */\nexport function childNodes(parent, callback) {\n  const nodes = [];\n  for (let child = parent.firstChild; child; child = child.nextSibling) {\n    if (callback(child)) {\n      nodes.push(child);\n    }\n  }\n  return nodes;\n}\n\n/**\n * Finds the first child element that has the specified attribute.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} attr\n * @return {?Element}\n */\nexport function childElementByAttr(parent, attr) {\n  assertIsName(attr);\n  return /*OK*/ scopedQuerySelector(parent, `> [${attr}]`);\n}\n\n/**\n * Finds the last child element that has the specified attribute.\n * @param {!Element} parent\n * @param {string} attr\n * @return {?Element}\n */\nexport function lastChildElementByAttr(parent, attr) {\n  assertIsName(attr);\n  return lastChildElement(parent, (el) => {\n    return el.hasAttribute(attr);\n  });\n}\n\n/**\n * Finds all child elements that has the specified attribute.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} attr\n * @return {!NodeList<!Element>}\n */\nexport function childElementsByAttr(parent, attr) {\n  assertIsName(attr);\n  return /*OK*/ scopedQuerySelectorAll(parent, `> [${attr}]`);\n}\n\n/**\n * Finds the first child element that has the specified tag name.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} tagName\n * @return {?Element}\n */\nexport function childElementByTag(parent, tagName) {\n  assertIsName(tagName);\n  return /*OK*/ scopedQuerySelector(parent, `> ${tagName}`);\n}\n\n/**\n * Finds all child elements with the specified tag name.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} tagName\n * @return {!NodeList<!Element>}\n */\nexport function childElementsByTag(parent, tagName) {\n  assertIsName(tagName);\n  return /*OK*/ scopedQuerySelectorAll(parent, `> ${tagName}`);\n}\n\n/**\n * Finds the first descendant element with the specified name.\n * @param {!Element|!Document|!ShadowRoot} element\n * @param {string} tagName\n * @return {?Element}\n */\nexport function elementByTag(element, tagName) {\n  assertIsName(tagName);\n  return element./*OK*/ querySelector(tagName);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {dev, devAssert} from './log';\nimport {dict} from './core/types/object';\nimport {includes} from './core/types/string';\nimport {matches} from './core/dom/query';\nimport {toWin} from './core/window';\n\nconst HTML_ESCAPE_CHARS = {\n  '&': '&amp;',\n  '<': '&lt;',\n  '>': '&gt;',\n  '\"': '&quot;',\n  \"'\": '&#x27;',\n  '`': '&#x60;',\n};\nconst HTML_ESCAPE_REGEX = /(&|<|>|\"|'|`)/g;\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_PROMISE = '__AMP_UPG_PRM';\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_RESOLVER = '__AMP_UPG_RES';\n\n/**\n * @typedef {{\n *   bubbles: (boolean|undefined),\n *   cancelable: (boolean|undefined),\n * }}\n */\nexport let CustomEventOptionsDef;\n\n/** @const {!CustomEventOptionsDef} */\nconst DEFAULT_CUSTOM_EVENT_OPTIONS = {bubbles: true, cancelable: true};\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * callback is executed.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @param {function()} callback\n * @suppress {suspiciousCode}\n */\nexport function waitForChild(parent, checkFunc, callback) {\n  if (checkFunc(parent)) {\n    callback();\n    return;\n  }\n  /** @const {!Window} */\n  const win = toWin(parent.ownerDocument.defaultView);\n  if (IS_ESM || win.MutationObserver) {\n    /** @const {MutationObserver} */\n    const observer = new win.MutationObserver(() => {\n      if (checkFunc(parent)) {\n        observer.disconnect();\n        callback();\n      }\n    });\n    observer.observe(parent, {childList: true});\n  } else {\n    /** @const {number} */\n    const interval = win.setInterval(() => {\n      if (checkFunc(parent)) {\n        win.clearInterval(interval);\n        callback();\n      }\n    }, /* milliseconds */ 5);\n  }\n}\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * promise is resolved.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @return {!Promise}\n */\nexport function waitForChildPromise(parent, checkFunc) {\n  return new Promise((resolve) => {\n    waitForChild(parent, checkFunc, resolve);\n  });\n}\n\n/**\n * Waits for document's body to be available and ready.\n * @param {!Document} doc\n * @param {function()} callback\n */\nexport function waitForBodyOpen(doc, callback) {\n  waitForChild(doc.documentElement, () => !!doc.body, callback);\n}\n\n/**\n * Waits for document's body to be available.\n * @param {!Document} doc\n * @return {!Promise}\n */\nexport function waitForBodyOpenPromise(doc) {\n  return new Promise((resolve) => waitForBodyOpen(doc, resolve));\n}\n\n/**\n * Removes the element.\n * @param {!Element} element\n */\nexport function removeElement(element) {\n  if (element.parentElement) {\n    element.parentElement.removeChild(element);\n  }\n}\n\n/**\n * Removes all child nodes of the specified element.\n * @param {!Element|!DocumentFragment} parent\n */\nexport function removeChildren(parent) {\n  while (parent.firstChild) {\n    parent.removeChild(parent.firstChild);\n  }\n}\n\n/**\n * Copies all children nodes of element \"from\" to element \"to\". Child nodes\n * are deeply cloned. Notice, that this method should be used with care and\n * preferably on smaller subtrees.\n * @param {!Element} from\n * @param {!Element|!DocumentFragment} to\n */\nexport function copyChildren(from, to) {\n  const frag = to.ownerDocument.createDocumentFragment();\n  for (let n = from.firstChild; n; n = n.nextSibling) {\n    frag.appendChild(n.cloneNode(true));\n  }\n  to.appendChild(frag);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n * @param {?Node=} after\n */\nexport function insertAfterOrAtStart(root, element, after = null) {\n  if (!after) {\n    insertAtStart(root, element);\n    return;\n  }\n  const before = after.nextSibling;\n  root.insertBefore(element, before);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n */\nexport function insertAtStart(root, element) {\n  root.insertBefore(element, root.firstChild);\n}\n\n/**\n * Add attributes to an element.\n * @param {!Element} element\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function addAttributesToElement(element, attributes) {\n  for (const attr in attributes) {\n    element.setAttribute(attr, attributes[attr]);\n  }\n  return element;\n}\n\n/**\n * Create a new element on document with specified tagName and attributes.\n * @param {!Document} doc\n * @param {string} tagName\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function createElementWithAttributes(doc, tagName, attributes) {\n  const element = doc.createElement(tagName);\n  return addAttributesToElement(element, attributes);\n}\n\n/**\n * Returns true if node is connected (attached).\n * @param {!Node} node\n * @return {boolean}\n * @see https://dom.spec.whatwg.org/#connected\n */\nexport function isConnectedNode(node) {\n  const connected = node.isConnected;\n  if (connected !== undefined) {\n    return connected;\n  }\n\n  // \"An element is connected if its shadow-including root is a document.\"\n  let n = node;\n  do {\n    n = rootNodeFor(n);\n    if (n.host) {\n      n = n.host;\n    } else {\n      break;\n    }\n  } while (true);\n  return n.nodeType === Node.DOCUMENT_NODE;\n}\n\n/**\n * Returns the root for a given node. Does not cross shadow DOM boundary.\n * @param {!Node} node\n * @return {!Node}\n */\nexport function rootNodeFor(node) {\n  if (Node.prototype.getRootNode) {\n    // Type checker says `getRootNode` may return null.\n    return node.getRootNode() || node;\n  }\n  let n;\n  // Check isShadowRoot() is only needed for the polyfill case.\n  for (\n    n = node;\n    !!n.parentNode && !isShadowRoot(/** @type {HTMLElement} */ (n));\n    n = n.parentNode\n  ) {}\n  return n;\n}\n\n/**\n * Determines if value is actually a `ShadowRoot` node.\n * @param {HTMLElement} value\n * @return {boolean}\n */\nexport function isShadowRoot(value) {\n  if (!value) {\n    return false;\n  }\n  // Node.nodeType == DOCUMENT_FRAGMENT to speed up the tests. Unfortunately,\n  // nodeType of DOCUMENT_FRAGMENT is used currently for ShadowRoot nodes.\n  if (value.tagName == 'I-AMPHTML-SHADOW-ROOT') {\n    return true;\n  }\n  return (\n    value.nodeType == /* DOCUMENT_FRAGMENT */ 11 &&\n    Object.prototype.toString.call(value) === '[object ShadowRoot]'\n  );\n}\n\n/**\n * Returns element data-param- attributes as url parameters key-value pairs.\n * e.g. data-param-some-attr=value -> {someAttr: value}.\n * @param {!HTMLElement} element\n * @param {function(string):string=} opt_computeParamNameFunc to compute the\n *    parameter name, get passed the camel-case parameter name.\n * @param {!RegExp=} opt_paramPattern Regex pattern to match data attributes.\n * @return {!JsonObject}\n */\nexport function getDataParamsFromAttributes(\n  element,\n  opt_computeParamNameFunc,\n  opt_paramPattern\n) {\n  const computeParamNameFunc = opt_computeParamNameFunc || ((key) => key);\n  const {dataset} = element;\n  const params = dict();\n  const paramPattern = opt_paramPattern ? opt_paramPattern : /^param(.+)/;\n  for (const key in dataset) {\n    const matches = key.match(paramPattern);\n    if (matches) {\n      const param = matches[1][0].toLowerCase() + matches[1].substr(1);\n      params[computeParamNameFunc(param)] = dataset[key];\n    }\n  }\n  return params;\n}\n\n/**\n * Whether the element have a next node in the document order.\n * This means either:\n *  a. The element itself has a nextSibling.\n *  b. Any of the element ancestors has a nextSibling.\n * @param {!Element} element\n * @param {?Node} opt_stopNode\n * @return {boolean}\n */\nexport function hasNextNodeInDocumentOrder(element, opt_stopNode) {\n  let currentElement = element;\n  do {\n    if (currentElement.nextSibling) {\n      return true;\n    }\n  } while (\n    (currentElement = currentElement.parentNode) &&\n    currentElement != opt_stopNode\n  );\n  return false;\n}\n\n/**\n * Returns a clone of the content of a template element.\n *\n * Polyfill to replace .content access for browsers that do not support\n * HTMLTemplateElements natively.\n *\n * @param {!HTMLTemplateElement|!Element} template\n * @return {!DocumentFragment}\n */\nexport function templateContentClone(template) {\n  if ('content' in template) {\n    return template.content.cloneNode(true);\n  } else {\n    const content = template.ownerDocument.createDocumentFragment();\n    copyChildren(template, content);\n    return content;\n  }\n}\n\n/**\n * Iterate over an array-like.\n * Test cases: https://jsbench.github.io/#f638cacc866a1b2d6e517e6cfa900d6b\n * @param {!IArrayLike<T>} iterable\n * @param {function(T, number)} cb\n * @template T\n */\nexport function iterateCursor(iterable, cb) {\n  const {length} = iterable;\n  for (let i = 0; i < length; i++) {\n    cb(iterable[i], i);\n  }\n}\n\n/**\n * This method wraps around window's open method. It first tries to execute\n * `open` call with the provided target and if it fails, it retries the call\n * with the `_top` target. This is necessary given that in some embedding\n * scenarios, such as iOS' WKWebView, navigation to `_blank` and other targets\n * is blocked by default.\n *\n * @param {!Window} win\n * @param {string} url\n * @param {string} target\n * @param {string=} opt_features\n * @return {?Window}\n */\nexport function openWindowDialog(win, url, target, opt_features) {\n  // Try first with the specified target. If we're inside the WKWebView or\n  // a similar environments, this method is expected to fail by default for\n  // all targets except `_top`.\n  let res;\n  try {\n    res = win.open(url, target, opt_features);\n  } catch (e) {\n    dev().error('DOM', 'Failed to open url on target: ', target, e);\n  }\n\n  // Then try with `_top` target.\n  if (!res && target != '_top' && !includes(opt_features || '', 'noopener')) {\n    res = win.open(url, '_top');\n  }\n  return res;\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.hasAttribute('type') &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/JSON'\n  );\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonLdScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/LD+JSON'\n  );\n}\n\n/**\n * Whether the page's direction is right to left or not.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isRTL(doc) {\n  const dir =\n    doc.body.getAttribute('dir') ||\n    doc.documentElement.getAttribute('dir') ||\n    'ltr';\n  return dir == 'rtl';\n}\n\n/**\n * Escapes `<`, `>` and other HTML charcaters with their escaped forms.\n * @param {string} text\n * @return {string}\n */\nexport function escapeHtml(text) {\n  if (!text) {\n    return text;\n  }\n  return text.replace(HTML_ESCAPE_REGEX, escapeHtmlChar);\n}\n\n/**\n * @param {string} c\n * @return {string}\n */\nfunction escapeHtmlChar(c) {\n  return HTML_ESCAPE_CHARS[c];\n}\n\n/**\n * Tries to focus on the given element; fails silently if browser throws an\n * exception.\n * @param {!Element} element\n */\nexport function tryFocus(element) {\n  try {\n    element./*OK*/ focus();\n  } catch (e) {\n    // IE <= 7 may throw exceptions when focusing on hidden items.\n  }\n}\n\n/**\n * Whether the given window is in an iframe or not.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isIframed(win) {\n  return win.parent && win.parent != win;\n}\n\n/**\n * Determines if this element is an AMP element\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isAmpElement(element) {\n  const tag = element.tagName;\n  // Use prefix to recognize AMP element. This is necessary because stub\n  // may not be attached yet.\n  return (\n    tag.startsWith('AMP-') &&\n    // Some \"amp-*\" elements are not really AMP elements. :smh:\n    !(tag == 'AMP-STICKY-AD-TOP-PADDING' || tag == 'AMP-BODY')\n  );\n}\n\n/**\n * Return a promise that resolve when an AMP element upgrade from HTMLElement\n * to CustomElement\n * @param {!HTMLElement} element\n * @return {!Promise<!AmpElement>}\n */\nexport function whenUpgradedToCustomElement(element) {\n  devAssert(isAmpElement(element), 'element is not AmpElement');\n  if (element.createdCallback) {\n    // Element already is CustomElement;\n    return Promise.resolve(/**@type {!AmpElement} */ (element));\n  }\n  // If Element is still HTMLElement, wait for it to upgrade to customElement\n  // Note: use pure string to avoid obfuscation between versions.\n  if (!element[UPGRADE_TO_CUSTOMELEMENT_PROMISE]) {\n    const deferred = new Deferred();\n    element[UPGRADE_TO_CUSTOMELEMENT_PROMISE] = deferred.promise;\n    element[UPGRADE_TO_CUSTOMELEMENT_RESOLVER] = deferred.resolve;\n  }\n\n  return element[UPGRADE_TO_CUSTOMELEMENT_PROMISE];\n}\n\n/**\n * Returns true if node is not disabled.\n *\n * IE8 can return false positives, see {@link matches}.\n * @param {!HTMLInputElement} element\n * @return {boolean}\n * @see https://www.w3.org/TR/html5/forms.html#concept-fe-disabled\n */\nexport function isEnabled(element) {\n  return !(element.disabled || matches(element, ':disabled'));\n}\n\n/**\n * A sorting comparator that sorts elements in DOM tree order.\n * A first sibling is sorted to be before its nextSibling.\n * A parent node is sorted to be before a child.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/compareDocumentPosition\n *\n * @param {!Element} element1\n * @param {!Element} element2\n * @return {number}\n */\nexport function domOrderComparator(element1, element2) {\n  if (element1 === element2) {\n    return 0;\n  }\n\n  const pos = element1.compareDocumentPosition(element2);\n  const precedingOrContains =\n    Node.DOCUMENT_POSITION_PRECEDING | Node.DOCUMENT_POSITION_CONTAINS;\n\n  // if fe2 is preceding or contains fe1 then, fe1 is after fe2\n  if (pos & precedingOrContains) {\n    return 1;\n  }\n\n  // if fe2 is following or contained by fe1, then fe1 is before fe2\n  return -1;\n}\n\n/**\n * Like `Element.prototype.toggleAttribute`. This either toggles an attribute\n * on by adding an attribute with an empty value, or toggles it off by removing\n * the attribute. This does not mutate the element if the new state matches\n * the existing state.\n * @param {!Element} element An element to toggle the attribute for.\n * @param {string} name The name of the attribute.\n * @param {boolean=} forced Whether the attribute should be forced on/off. If\n *    not specified, it will be toggled from the current state.\n * @return {boolean} Whether or not the element now has the attribute.\n */\nexport function toggleAttribute(element, name, forced) {\n  const hasAttribute = element.hasAttribute(name);\n  const enabled = forced !== undefined ? forced : !hasAttribute;\n\n  if (enabled !== hasAttribute) {\n    if (enabled) {\n      element.setAttribute(name, '');\n    } else {\n      element.removeAttribute(name);\n    }\n  }\n\n  return enabled;\n}\n\n/**\n * Parses a string as a boolean value using the expanded rules for DOM boolean\n * attributes:\n * - a `null` or `undefined` returns `null`;\n * - an empty string returns `true`;\n * - a \"false\" string returns `false`;\n * - otherwise, `true` is returned.\n *\n * @param {?string|undefined} s\n * @return {boolean|undefined}\n */\nexport function parseBooleanAttribute(s) {\n  return s == null ? undefined : s !== 'false';\n}\n\n/**\n * @param {!Window} win\n * @return {number} The width of the vertical scrollbar, in pixels.\n */\nexport function getVerticalScrollbarWidth(win) {\n  const {documentElement} = win.document;\n  const windowWidth = win./*OK*/ innerWidth;\n  const documentWidth = documentElement./*OK*/ clientWidth;\n  return windowWidth - documentWidth;\n}\n\n/**\n * Dispatches a custom event.\n *\n * @param {!Node} node\n * @param {string} name\n * @param {!Object=} opt_data Event data.\n * @param {!CustomEventOptionsDef=} opt_options\n */\nexport function dispatchCustomEvent(node, name, opt_data, opt_options) {\n  const data = opt_data || {};\n  // Constructors of events need to come from the correct window. Sigh.\n  const event = node.ownerDocument.createEvent('Event');\n\n  // Technically .data is not a property of Event.\n  /**@type {?}*/ (event).data = data;\n\n  const {bubbles, cancelable} = opt_options || DEFAULT_CUSTOM_EVENT_OPTIONS;\n  event.initEvent(name, bubbles, cancelable);\n  node.dispatchEvent(event);\n}\n\n/**\n * Ensures the child is contained by the parent, but not the parent itself.\n *\n * @param {!Node} parent\n * @param {!Node} child\n * @return {boolean}\n */\nexport function containsNotSelf(parent, child) {\n  return child !== parent && parent.contains(child);\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from '../mode';\nimport {urls} from '../config';\n\nconst CUSTOM_TEMPLATES = ['amp-mustache'];\nconst LATEST_VERSION = 'latest';\n\n/**\n * Calculate the base url for any scripts.\n * @param {!Location} location The window's location\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateScriptBaseUrl(location, opt_isLocalDev) {\n  if (opt_isLocalDev) {\n    let prefix = `${location.protocol}//${location.host}`;\n    if (\n      location.protocol == 'about:' ||\n      location.protocol == 'blob:' ||\n      location.protocol == 'data:'\n    ) {\n      prefix = '';\n    }\n    return `${prefix}/dist`;\n  }\n  return urls.cdn;\n}\n\n/**\n * Calculate script url for an extension.\n * @param {!Location} location The window's location\n * @param {string} extensionId\n * @param {string} version\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateExtensionScriptUrl(\n  location,\n  extensionId,\n  version,\n  opt_isLocalDev\n) {\n  const fileExtension = getMode().esm ? '.mjs' : '.js';\n  const base = calculateScriptBaseUrl(location, opt_isLocalDev);\n  const rtv = getMode().rtvVersion;\n  const extensionVersion = version ? '-' + version : '';\n  return `${base}/rtv/${rtv}/v0/${extensionId}${extensionVersion}${fileExtension}`;\n}\n\n/**\n * Calculate script url for an entry point.\n * If `opt_rtv` is true, returns the URL matching the current RTV.\n * @param {!Location} location The window's location\n * @param {string} entryPoint\n * @param {boolean=} isLocalDev\n * @param {boolean=} opt_rtv\n * @return {string}\n */\nexport function calculateEntryPointScriptUrl(\n  location,\n  entryPoint,\n  isLocalDev,\n  opt_rtv\n) {\n  const fileExtension = getMode().esm ? '.mjs' : '.js';\n  const base = calculateScriptBaseUrl(location, isLocalDev);\n  if (isLocalDev) {\n    return `${base}/${entryPoint}${fileExtension}`;\n  }\n  if (opt_rtv) {\n    return `${base}/rtv/${getMode().rtvVersion}/${entryPoint}${fileExtension}`;\n  }\n  return `${base}/${entryPoint}${fileExtension}`;\n}\n\n/**\n * Parse the extension version from a given script URL.\n * @param {string} scriptUrl\n * @return {?{extensionId: string, extensionVersion: string}}\n */\nexport function parseExtensionUrl(scriptUrl) {\n  if (!scriptUrl) {\n    return null;\n  }\n  // Note that the \"(\\.max)?\" group only applies to local dev.\n  const matches = scriptUrl.match(\n    /^(.*)\\/(.*)-([0-9.]+|latest)(\\.max)?\\.(?:js|mjs)$/i\n  );\n  const extensionId = matches ? matches[2] : undefined;\n  const extensionVersion = matches ? matches[3] : undefined;\n  if (!extensionId || !extensionVersion) {\n    return null;\n  }\n  return {extensionId, extensionVersion};\n}\n\n/**\n * Create the missing amp extension HTML script element.\n * @param {!Window} win\n * @param {string} extensionId\n * @param {string} version\n * @return {!Element} Script object\n */\nexport function createExtensionScript(win, extensionId, version) {\n  const scriptElement = win.document.createElement('script');\n  scriptElement.async = true;\n  if (isIntermediateExtension(extensionId)) {\n    version = '';\n  } else {\n    scriptElement.setAttribute(\n      CUSTOM_TEMPLATES.indexOf(extensionId) >= 0\n        ? 'custom-template'\n        : 'custom-element',\n      extensionId\n    );\n  }\n  scriptElement.setAttribute('data-script', extensionId);\n  scriptElement.setAttribute('i-amphtml-inserted', '');\n  if (getMode().esm) {\n    scriptElement.setAttribute('type', 'module');\n  }\n\n  // Propagate nonce to all generated script tags.\n  const currentScript = win.document.head.querySelector('script[nonce]');\n  if (currentScript) {\n    scriptElement.setAttribute('nonce', currentScript.getAttribute('nonce'));\n  }\n\n  // Allow error information to be collected\n  // https://github.com/ampproject/amphtml/issues/7353\n  scriptElement.setAttribute('crossorigin', 'anonymous');\n  let loc = win.location;\n  if (getMode(win).test && win.testLocation) {\n    loc = win.testLocation;\n  }\n  const scriptSrc = calculateExtensionScriptUrl(\n    loc,\n    extensionId,\n    version,\n    getMode(win).localDev\n  );\n  scriptElement.src = scriptSrc;\n  return scriptElement;\n}\n\n/**\n * Returns the extension <script> element and attribute for the given\n * extension ID, if it exists. Otherwise, returns null.\n * @param {!Window} win\n * @param {string} extensionId\n * @param {string} version\n * @param {boolean} latest\n * @param {boolean=} includeInserted If true, includes script elements that\n *   are inserted by the runtime dynamically. Default is true.\n * @return {!Array<!Element>}\n */\nexport function getExtensionScripts(\n  win,\n  extensionId,\n  version,\n  latest,\n  includeInserted = true\n) {\n  // Always ignore <script> elements that have a mismatched RTV.\n  const modifier =\n    ':not([i-amphtml-loaded-new-version])' +\n    (includeInserted ? '' : ':not([i-amphtml-inserted])');\n  // We have to match against \"src\" because a few extensions, such as\n  // \"amp-viewer-integration\", do not have \"custom-element\" attribute.\n  const matches = win.document.head./*OK*/ querySelectorAll(\n    `script[src*=\"/${extensionId}-\"]${modifier}`\n  );\n  const filtered = [];\n  for (let i = 0; i < matches.length; i++) {\n    const match = matches[i];\n    const urlParts = parseExtensionUrl(match.src);\n    if (!urlParts) {\n      continue;\n    }\n    const {\n      extensionId: scriptExtensionId,\n      extensionVersion: scriptExtensionVersion,\n    } = urlParts;\n    if (\n      scriptExtensionId == extensionId &&\n      (isIntermediateExtension(extensionId) ||\n        scriptExtensionVersion == version ||\n        (scriptExtensionVersion == LATEST_VERSION && latest))\n    ) {\n      filtered.push(match);\n    }\n  }\n  return filtered;\n}\n\n/**\n * Get list of all the extension JS files.\n * @param {HTMLHeadElement|Element|ShadowRoot|Document} head\n * @return {!Array<{extensionId: string, extensionVersion: string}>}\n */\nexport function extensionScriptsInNode(head) {\n  // ampdoc.getHeadNode() can return null.\n  if (!head) {\n    return [];\n  }\n  // Note: Some extensions don't have [custom-element] or [custom-template]\n  // e.g. amp-viewer-integration.\n  const list = head.querySelectorAll(\n    'script[custom-element],script[custom-template]'\n  );\n  const scripts = [];\n  for (let i = 0; i < list.length; i++) {\n    const script = list[i];\n    const extensionId =\n      script.getAttribute('custom-element') ||\n      script.getAttribute('custom-template');\n    const urlParts = parseExtensionUrl(script.src);\n    if (extensionId && urlParts) {\n      scripts.push({extensionId, extensionVersion: urlParts.extensionVersion});\n    }\n  }\n  return scripts;\n}\n\n/**\n * Verifies that an extension script is present in head for\n * installation.\n * @param {!Window} win\n * @param {string} id\n * @param {string} version\n * @return {boolean}\n */\nexport function extensionScriptInNode(win, id, version) {\n  return extensionScriptsInNode(win.document.head).some(\n    ({extensionId, extensionVersion}) =>\n      id == extensionId && version == extensionVersion\n  );\n}\n\n/**\n * @param {string} extensionId\n * @return {boolean}\n */\nfunction isIntermediateExtension(extensionId) {\n  return extensionId.startsWith('_');\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dom from './dom';\nimport {extensionScriptInNode} from './service/extension-script';\nimport {\n  getAmpdoc,\n  getService,\n  getServiceForDocOrNull,\n  getServicePromise,\n  getServicePromiseForDoc,\n  getServicePromiseOrNull,\n  getServicePromiseOrNullForDoc,\n} from './service';\nimport {userAssert} from './log';\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {string} version The extension version.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailable(\n  win,\n  id,\n  extension,\n  version,\n  opt_element\n) {\n  const s = getServicePromiseOrNull(win, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  return getElementServicePromiseOrNull(\n    win,\n    id,\n    extension,\n    version,\n    opt_element\n  );\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. Services.viewportForDoc(...)) for type safety and because the\n * factory should not be passed around.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an element,\n *     not the extension.\n * @return {!Promise<*>}\n */\nexport function getElementServiceForDoc(element, id, extension, opt_element) {\n  return getElementServiceIfAvailableForDoc(\n    element,\n    id,\n    extension,\n    opt_element\n  ).then((service) => assertService(service, id, extension));\n}\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDoc(\n  element,\n  id,\n  extension,\n  opt_element\n) {\n  const s = getServicePromiseOrNullForDoc(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  const ampdoc = getAmpdoc(element);\n  return ampdoc\n    .whenExtensionsKnown()\n    .then(() => {\n      const version = ampdoc.getExtensionVersion(extension);\n      if (!version) {\n        return null;\n      }\n      const extensions = getService(ampdoc.win, 'extensions');\n      return extensions.waitForExtension(extension, version);\n    })\n    .then((ext) => {\n      if (!ext) {\n        return null;\n      }\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNullForDoc(element, id);\n      }\n      return getServicePromiseForDoc(element, id);\n    });\n}\n\n/**\n * Returns a promise for service for the given id in the embed scope of\n * a given element, if it exists. Falls back to ampdoc scope if the element\n * is not embedded.\n *\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDocInEmbedScope(\n  element,\n  id,\n  extension\n) {\n  const s = getServiceForDocOrNull(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (Promise.resolve(s));\n  }\n  return getElementServiceIfAvailableForDoc(element, id, extension);\n}\n\n/**\n * Throws user error if `service` is null.\n * @param {Object} service\n * @param {string} id\n * @param {string} extension\n * @return {!Object}\n * @private\n * @closurePrimitive {asserts.matchesReturn}\n */\nfunction assertService(service, id, extension) {\n  return /** @type {!Object} */ (\n    userAssert(\n      service,\n      'Service %s was requested to be provided through %s, ' +\n        'but %s is not loaded in the current page. To fix this ' +\n        'problem load the JavaScript file for %s in this page.',\n      id,\n      extension,\n      extension,\n      extension\n    )\n  );\n}\n\n/**\n * Returns the promise for service with `id` on the given window if available.\n * Otherwise, resolves with null (service was not registered).\n * @param {!Window} win\n * @param {string} id\n * @param {string} extension\n * @param {string} version\n * @param {boolean=} opt_element\n * @return {!Promise<Object>}\n * @private\n */\nfunction getElementServicePromiseOrNull(\n  win,\n  id,\n  extension,\n  version,\n  opt_element\n) {\n  return dom\n    .waitForBodyOpenPromise(win.document)\n    .then(() => {\n      // If there is an extension script wait for it to load before trying\n      // to get the service. Prevents a race condition when everything but\n      // the extensions is in cache. If there is no script then it's either\n      // not present, or the service was defined by a test. In those cases\n      // we don't wait around for an extension that does not exist.\n      const extensions = getService(win, 'extensions');\n\n      // TODO(jpettitt) investigate registerExtension to short circuit\n      // the dom call in extensionScriptsInNode()\n      if (!extensionScriptInNode(extensions.win, extension, version)) {\n        return null;\n      }\n      return extensions.waitForExtension(extension, version);\n    })\n    .then((ext) => {\n      if (!ext) {\n        return null;\n      }\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNull(win, id);\n      }\n      return getServicePromise(win, id);\n    });\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  getAmpdoc,\n  getExistingServiceOrNull,\n  getService,\n  getServiceForDoc,\n  getServiceForDocOrNull,\n  getServiceInEmbedWin,\n  getServicePromiseForDoc,\n} from './service';\nimport {\n  getElementServiceForDoc,\n  getElementServiceIfAvailable,\n  getElementServiceIfAvailableForDoc,\n  getElementServiceIfAvailableForDocInEmbedScope,\n} from './element-service';\n\n/** @typedef {!../extensions/amp-subscriptions/0.1/amp-subscriptions.SubscriptionService} */\nexport let SubscriptionService;\n\nexport class Services {\n  /**\n   * Hint: Add extensions folder path to compile.js with\n   * warnings cannot find modules.\n   */\n\n  /**\n   * Returns a promise for the Access service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>} */ (\n      getElementServiceForDoc(element, 'access', 'amp-access')\n    );\n  }\n\n  /**\n   * Returns a promise for the Access service or a promise for null if the\n   * service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>} */ (\n      getElementServiceIfAvailableForDoc(element, 'access', 'amp-access')\n    );\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!SubscriptionService>}\n   */\n  static subscriptionsServiceForDoc(element) {\n    return /** @type {!Promise<!SubscriptionService>} */ (\n      getElementServiceForDoc(element, 'subscriptions', 'amp-subscriptions')\n    );\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?SubscriptionService>}\n   */\n  static subscriptionsServiceForDocOrNull(element) {\n    return /** @type {!Promise<?SubscriptionService>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'subscriptions',\n        'amp-subscriptions'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/action-impl.ActionService}\n   */\n  static actionServiceForDoc(element) {\n    return /** @type {!./service/action-impl.ActionService} */ (\n      getServiceForDocOrNull(element, 'action')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/standard-actions-impl.StandardActions}\n   */\n  static standardActionsForDoc(element) {\n    return /** @type {!./service/standard-actions-impl.StandardActions} */ (\n      getServiceForDocOrNull(element, 'standard-actions')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>}\n   */\n  static activityForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>} */ (\n      getElementServiceForDoc(element, 'activity', 'amp-analytics')\n    );\n  }\n\n  /**\n   * Returns the global instance of the `AmpDocService` service that can be\n   * used to resolve an ampdoc for any node: either in the single-doc or\n   * shadow-doc environment.\n   * @param {!Window} window\n   * @return {!./service/ampdoc-impl.AmpDocService}\n   */\n  static ampdocServiceFor(window) {\n    return /** @type {!./service/ampdoc-impl.AmpDocService} */ (\n      getService(window, 'ampdoc')\n    );\n  }\n\n  /**\n   * Returns the AmpDoc for the specified context node.\n   * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrAmpDoc\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   */\n  static ampdoc(nodeOrAmpDoc) {\n    return getAmpdoc(nodeOrAmpDoc);\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @param {boolean=} loadAnalytics\n   * @return {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDoc(element, loadAnalytics = false) {\n    if (loadAnalytics) {\n      // Get Extensions service and force load analytics extension.\n      const ampdoc = getAmpdoc(element);\n      Services.extensionsFor(ampdoc.win)./*OK*/ installExtensionForDoc(\n        ampdoc,\n        'amp-analytics'\n      );\n    }\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (\n      getElementServiceForDoc(\n        element,\n        'amp-analytics-instrumentation',\n        'amp-analytics'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'amp-analytics-instrumentation',\n        'amp-analytics'\n      )\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/batched-xhr-impl.BatchedXhr}\n   */\n  static batchedXhrFor(window) {\n    return /** @type {!./service/batched-xhr-impl.BatchedXhr} */ (\n      getService(window, 'batched-xhr')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>}\n   */\n  static bindForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>} */ (\n      getElementServiceIfAvailableForDocInEmbedScope(\n        element,\n        'bind',\n        'amp-bind'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-script/0.1/amp-script.AmpScriptService>}\n   */\n  static scriptForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-script/0.1/amp-script.AmpScriptService>} */ (\n      getElementServiceIfAvailableForDocInEmbedScope(\n        element,\n        'amp-script',\n        'amp-script'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/cid-impl.CidDef>}\n   */\n  static cidForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/cid-impl.CidDef>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'cid')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/navigation.Navigation}\n   */\n  static navigationForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/navigation.Navigation} */ (\n      getServiceForDoc(elementOrAmpDoc, 'navigation')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>}\n   */\n  static loaderServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>} */ (\n      getElementServiceForDoc(element, 'loader', 'amp-loader')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>}\n   */\n  static standaloneServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>} */ (\n      getElementServiceForDoc(element, 'standalone', 'amp-standalone')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/crypto-impl.Crypto}\n   */\n  static cryptoFor(window) {\n    return /** @type {!./service/crypto-impl.Crypto} */ (\n      getService(window, 'crypto')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/document-info-impl.DocumentInfoDef} Info about the doc\n   */\n  static documentInfoForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/document-info-impl.DocInfo} */ (\n      getServiceForDoc(elementOrAmpDoc, 'documentInfo')\n    ).get();\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/extensions-impl.Extensions}\n   */\n  static extensionsFor(window) {\n    return /** @type {!./service/extensions-impl.Extensions} */ (\n      getService(window, 'extensions')\n    );\n  }\n\n  /**\n   * Returns a service to register callbacks we wish to execute when an\n   * amp-form is submitted.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>}\n   */\n  static formSubmitForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'form-submit-service')\n    );\n  }\n\n  /**\n   * Returns service to listen for `hidden` attribute mutations.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/hidden-observer-impl.HiddenObserver}\n   */\n  static hiddenObserverForDoc(element) {\n    return /** @type {!./service/hidden-observer-impl.HiddenObserver} */ (\n      getServiceForDocOrNull(element, 'hidden-observer')\n    );\n  }\n\n  /**\n   * Returns service implemented in service/history-impl.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/history-impl.History}\n   */\n  static historyForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/history-impl.History} */ (\n      getServiceForDoc(elementOrAmpDoc, 'history')\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {!./input.Input}\n   */\n  static inputFor(win) {\n    return getService(win, 'input');\n  }\n\n  /**s\n   * Returns a promise for the Inputmask service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>}\n   */\n  static inputmaskServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>} */ (\n      getElementServiceIfAvailableForDoc(element, 'inputmask', 'amp-inputmask')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {?./service/loading-indicator.LoadingIndicatorImpl}\n   */\n  static loadingIndicatorOrNull(elementOrAmpDoc) {\n    return /** @type {?./service/loading-indicator.LoadingIndicatorImpl} */ (\n      getServiceForDocOrNull(elementOrAmpDoc, 'loadingIndicator')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-next-page/1.0/service.NextPageService}\n   */\n  static nextPageServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-next-page/1.0/service.NextPageService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'next-page')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/mutator-interface.MutatorInterface}\n   */\n  static mutatorForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/mutator-interface.MutatorInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'mutator')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/owners-interface.OwnersInterface}\n   */\n  static ownersForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/owners-interface.OwnersInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'owners')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceFor(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (\n      getService(window, 'performance')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceForOrNull(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (\n      getExistingServiceOrNull(window, 'performance')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/platform-impl.Platform}\n   */\n  static platformFor(window) {\n    return /** @type {!./service/platform-impl.Platform} */ (\n      getService(window, 'platform')\n    );\n  }\n\n  /**\n   * Not installed by default; must be installed in extension code before use.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/position-observer/position-observer-impl.PositionObserver}\n   * @throws If the service is not installed.\n   */\n  static positionObserverForDoc(element) {\n    return /** @type {!./service/position-observer/position-observer-impl.PositionObserver} */ (\n      getServiceForDoc(element, 'position-observer')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./preconnect.PreconnectService}\n   */\n  static preconnectFor(window) {\n    return getService(window, 'preconnect');\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/resources-interface.ResourcesInterface}\n   */\n  static resourcesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/resources-interface.ResourcesInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'resources')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/resources-interface.ResourcesInterface>}\n   */\n  static resourcesPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/resources-interface.ResourcesInterface>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'resources')\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService>}\n   */\n  static storyVariableServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService>} */\n      (getElementServiceIfAvailable(win, 'story-variable', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService}\n   */\n  static storyVariableService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService} */\n      (getExistingServiceOrNull(win, 'story-variable'))\n    );\n  }\n\n  /**\n   * Version of the story store service depends on which version of amp-story\n   * the publisher is loading. They all have the same implementation.\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService>}\n   */\n  static storyStoreServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService>} */\n      (getElementServiceIfAvailable(win, 'story-store', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService}\n   */\n  static storyStoreService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService} */\n      (getExistingServiceOrNull(win, 'story-store'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService}\n   */\n  static storyMediaQueryService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService} */\n      (getExistingServiceOrNull(win, 'story-media-query'))\n    );\n  }\n\n  /**\n   * Get promise with story request service\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService>}\n   */\n  static storyRequestServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService>} */\n      (getElementServiceIfAvailable(win, 'story-request', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService}\n   */\n  static storyRequestService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService} */\n      (getExistingServiceOrNull(win, 'story-request'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService}\n   */\n  static mediaPerformanceMetricsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService} */\n      (getExistingServiceOrNull(win, 'media-performance-metrics'))\n    );\n  }\n\n  /**\n   * @param {!Element} el\n   * @return {!Promise<./service/localization.LocalizationService>}\n   */\n  static localizationServiceForOrNull(el) {\n    return /** @type {!Promise<?./service/localization.LocalizationService>} */ (\n      getServicePromiseForDoc(el, 'localization')\n    );\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {?./service/localization.LocalizationService}\n   */\n  static localizationForDoc(element) {\n    return /** @type {?./service/localization.LocalizationService} */ (\n      getServiceForDocOrNull(element, 'localization')\n    );\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>}\n   */\n  static storyAnalyticsServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>} */\n      (\n        getElementServiceIfAvailable(\n          win,\n          'story-analytics',\n          'amp-story',\n          '1.0',\n          true\n        )\n      )\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService}\n   */\n  static storyAnalyticsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService} */\n      (getExistingServiceOrNull(win, 'story-analytics'))\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>}\n   */\n  static webAnimationServiceFor(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>} */\n      (getElementServiceForDoc(element, 'web-animation', 'amp-animation'))\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/real-time-config/real-time-config-impl.RealTimeConfigManager>}\n   */\n  static realTimeConfigForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/real-time-config/real-time-config-impl.RealTimeConfigManager>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'real-time-config')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   */\n  static storageForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'storage')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   * TODO(dmanek): Add tests for this method.\n   */\n  static storageForTopLevelDoc(elementOrAmpDoc) {\n    const thisAmpdoc = Services.ampdoc(elementOrAmpDoc);\n    const ampdocService = Services.ampdocServiceFor(thisAmpdoc.win);\n    const topAmpdoc = ampdocService.isSingleDoc()\n      ? ampdocService.getSingleDoc()\n      : null;\n    // We need to verify that ampdocs are on the same origin, therefore\n    // we compare the windows of both.\n    const ampdoc =\n      topAmpdoc && topAmpdoc.win == thisAmpdoc.win ? topAmpdoc : thisAmpdoc;\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (\n      getServicePromiseForDoc(ampdoc, 'storage')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/template-impl.Templates}\n   */\n  static templatesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/template-impl.Templates} */ (\n      getServiceForDoc(elementOrAmpDoc, 'templates')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/timer-impl.Timer}\n   */\n  static timerFor(window) {\n    // TODO(alabiaga): This will always return the top window's Timer service.\n    return /** @type {!./service/timer-impl.Timer} */ (\n      getServiceInEmbedWin(window, 'timer')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-replacements-impl.UrlReplacements}\n   */\n  static urlReplacementsForDoc(element) {\n    return /** @type {!./service/url-replacements-impl.UrlReplacements} */ (\n      getServiceForDocOrNull(element, 'url-replace')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>}\n   */\n  static userNotificationManagerForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>} */\n      (\n        getElementServiceForDoc(\n          element,\n          'userNotificationManager',\n          'amp-user-notification'\n        )\n      )\n    );\n  }\n\n  /**\n   * Returns a promise for the consentPolicy Service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>}\n   */\n  static consentPolicyServiceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>} */\n      (\n        getElementServiceIfAvailableForDoc(\n          element,\n          'consentPolicyManager',\n          'amp-consent'\n        )\n      )\n    );\n  }\n\n  /**\n   * Returns a promise for the geo service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>}\n   */\n  static geoForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>} */ (\n      getElementServiceIfAvailableForDoc(element, 'geo', 'amp-geo', true)\n    );\n  }\n\n  /**\n   * Unlike most service getters, passing `Node` is necessary for some FIE-scope\n   * services since sometimes we only have the FIE Document for context.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-impl.Url}\n   */\n  static urlForDoc(element) {\n    return /** @type {!./service/url-impl.Url} */ (\n      getServiceForDocOrNull(element, 'url')\n    );\n  }\n\n  /**\n   * Returns a promise for the experiment variants or a promise for null if it\n   * is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>}\n   */\n  static variantsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'variant',\n        'amp-experiment',\n        true\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/video-manager-impl.VideoManager}\n   */\n  static videoManagerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/video-manager-impl.VideoManager} */ (\n      getServiceForDoc(elementOrAmpDoc, 'video-manager')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewer-interface.ViewerInterface}\n   */\n  static viewerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewer-interface.ViewerInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'viewer')\n    );\n  }\n\n  /**\n   * Returns promise for the viewer. This is an unusual case and necessary only\n   * for services that need reference to the viewer before it has been\n   * initialized. Most of the code, however, just should use `viewerForDoc`.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/viewer-interface.ViewerInterface>}\n   */\n  static viewerPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/viewer-interface.ViewerInterface>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'viewer')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/vsync-impl.Vsync}\n   */\n  static vsyncFor(window) {\n    return /** @type {!./service/vsync-impl.Vsync} */ (\n      getService(window, 'vsync')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewport/viewport-interface.ViewportInterface}\n   */\n  static viewportForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewport/viewport-interface.ViewportInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'viewport')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/xhr-impl.Xhr}\n   */\n  static xhrFor(window) {\n    return /** @type {!./service/xhr-impl.Xhr} */ (getService(window, 'xhr'));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-frame-service.AssistjsFrameService}\n   */\n  static assistjsFrameServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-frame-service.AssistjsFrameService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'assistjs-frame-service')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-config-service.AssistjsConfigService}\n   */\n  static assistjsConfigServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-config-service.AssistjsConfigService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'assistjs-config-service')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../amp-cache-url/amp-cache-url.AmpCacheUrlService>}\n   */\n  static cacheUrlServicePromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<?../amp-cache-url/amp-cache-url.AmpCacheUrlService>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'cache-url')\n    );\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {dict} from './core/types/object';\n\n/**\n * Helper method to trigger analytics event if amp-analytics is available.\n * TODO: Do not expose this function\n * @param {!Element} target\n * @param {string} eventType\n * @param {!JsonObject} vars A map of vars and their values.\n * @param {boolean} enableDataVars A boolean to indicate if data-vars-*\n * attribute value from target element should be included.\n */\nexport function triggerAnalyticsEvent(\n  target,\n  eventType,\n  vars = dict(),\n  enableDataVars = true\n) {\n  Services.analyticsForDocOrNull(target).then((analytics) => {\n    if (!analytics) {\n      return;\n    }\n    analytics.triggerEventForTarget(target, eventType, vars, enableDataVars);\n  });\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {dict} from '../../../src/core/types/object';\nimport {triggerAnalyticsEvent} from '../../../src/analytics';\nimport {user} from '../../../src/log';\n\nconst TAG = 'amp-subscriptions';\n\n/**\n * subscriptions-platform-* event names are deprecated in favor\n * of subscription-service-*  The DEPRECATED events are still triggered\n * for backward compatibility with existing publisher code.\n * @enum {string}\n */\nexport const SubscriptionAnalyticsEvents = {\n  PLATFORM_ACTIVATED: 'subscriptions-service-activated',\n  PLATFORM_ACTIVATED_DEPRECATED: 'subscriptions-platform-activated',\n  PAYWALL_ACTIVATED: 'subscriptions-paywall-activated',\n  PLATFORM_REGISTERED: 'subscriptions-service-registered',\n  PLATFORM_REGISTERED_DEPRECATED: 'subscriptions-platform-registered',\n  PLATFORM_REAUTHORIZED: 'subscriptions-service-re-authorized',\n  PLATFORM_REAUTHORIZED_DEPRECATED: 'subscriptions-platform-re-authorized',\n  ACTION_DELEGATED: 'subscriptions-action-delegated',\n  ENTITLEMENT_RESOLVED: 'subscriptions-entitlement-resolved',\n  STARTED: 'subscriptions-started',\n  ACCESS_GRANTED: 'subscriptions-access-granted',\n  ACCESS_DENIED: 'subscriptions-access-denied',\n  // common service adapter events\n  LINK_REQUESTED: 'subscriptions-link-requested',\n  LINK_COMPLETE: 'subscriptions-link-complete',\n  LINK_CANCELED: 'subscriptions-link-canceled',\n  SUBSCRIPTIONS_ACTION: 'subscriptions-action',\n};\n\n/** @enum {string} */\nexport const Action = {\n  LOGIN: 'login',\n  LOGOUT: 'logout',\n  LINK: 'link',\n  SUBSCRIBE: 'subscribe',\n  CONTRIBUTE: 'contribute',\n  SHOW_CONTRIBUTION_OPTIONS: 'showContributionOptions',\n  SHOW_OFFERS: 'showOffers',\n};\n\n/** @enum {string} */\nexport const ActionStatus = {\n  STARTED: 'started',\n  REJECTED: 'rejected',\n  FAILED: 'failed',\n  SUCCESS: 'success',\n};\n\nexport class SubscriptionAnalytics {\n  /**\n   * Creates an instance of SubscriptionAnalytics.\n   * @param {!Element} element\n   */\n  constructor(element) {\n    this.element_ = element;\n\n    /** @private @const {Array<function((!SubscriptionAnalyticsEvents|string),!JsonObject,!JsonObject)>} */\n    this.listeners_ = [];\n  }\n\n  /**\n   * Notified of any event sent to SubscriptionAnalytics.  The parameters\n   * passed to the listener are:\n   *  1) The type of event.  This should eventually always be an enum value but\n   *     may not be in some circumstances for historic reasons.\n   *  2) The optional parameters passed into the framework by the publisher\n   *  3) An internal variables object which be populated for the\n   *     SUBSCRIPTIONS_ACTION event type: {\n   *       action: (Action|undefined),\n   *       status: (ActionStatus|undefined),\n   *     }\n   * @param {function((!SubscriptionAnalyticsEvents|string),!JsonObject,!JsonObject)} listener\n   */\n  registerEventListener(listener) {\n    this.listeners_.push(listener);\n  }\n\n  /**\n   * @param {!SubscriptionAnalyticsEvents|string} eventType\n   * @param {string} platformKey\n   * @param {!JsonObject=} opt_vars\n   * @param {!JsonObject=} internalVars\n   */\n  serviceEvent(eventType, platformKey, opt_vars, internalVars) {\n    this.event(\n      eventType,\n      /** @type {!JsonObject} */ (\n        Object.assign(\n          dict({\n            'serviceId': platformKey,\n          }),\n          opt_vars\n        )\n      ),\n      internalVars\n    );\n  }\n\n  /**\n   * @param {!SubscriptionAnalyticsEvents|string} eventType\n   * @param {!JsonObject=} opt_vars\n   * @param {!JsonObject=} internalVars\n   */\n  event(eventType, opt_vars, internalVars) {\n    internalVars = internalVars || dict({});\n\n    const loggedString =\n      eventType !== SubscriptionAnalyticsEvents.SUBSCRIPTIONS_ACTION\n        ? eventType\n        : eventType + `-${internalVars['action']}-${internalVars['status']}`;\n\n    user().info(TAG, loggedString, opt_vars || '');\n\n    opt_vars = opt_vars || dict({});\n    triggerAnalyticsEvent(\n      this.element_,\n      loggedString,\n      opt_vars,\n      /** enableDataVars */ false\n    );\n\n    for (let l = 0; l < this.listeners_.length; l++) {\n      this.listeners_[l](eventType, opt_vars, internalVars);\n    }\n  }\n\n  /**\n   * @param {string} platformKey\n   * @param {!Action|string} action\n   * @param {!ActionStatus|string} status\n   * @param {!JsonObject=} opt_vars\n   */\n  actionEvent(platformKey, action, status, opt_vars) {\n    this.serviceEvent(\n      SubscriptionAnalyticsEvents.SUBSCRIPTIONS_ACTION,\n      platformKey,\n      opt_vars,\n      dict({\n        'action': action,\n        'status': status,\n      })\n    );\n  }\n}\n", "export const CSS = \"[subscriptions-action]:not(.i-amphtml-subs-display),[subscriptions-actions]:not(.i-amphtml-subs-display),[subscriptions-section=actions]:not(.i-amphtml-subs-display),body.i-amphtml-subs-delegated [subscriptions-section=actions],body.i-amphtml-subs-grant-unk [subscriptions-action],body.i-amphtml-subs-grant-unk [subscriptions-section=actions],body:not(.i-amphtml-subs-grant-no) [subscriptions-section=content-not-granted],body:not(.i-amphtml-subs-grant-yes) [subscriptions-section=content],body:not(.i-amphtml-subs-loading) [subscriptions-section=loading]{display:none!important}amp-subscriptions-dialog{display:block!important;position:fixed!important;bottom:0!important;left:0!important;margin-left:0!important;width:100%!important;z-index:2147483641!important;max-height:90vh;box-sizing:border-box;opacity:1;background-image:none;background-color:#fff;box-shadow:0 0 5px 0 rgba(0,0,0,0.2);margin-bottom:0;transition:transform 0.3s ease-in}.i-amphtml-subs-dialog-close-button{position:absolute;width:28px;height:28px;top:-28px;right:0;background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='13' height='13' viewBox='341 8 13 13' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%234F4F4F' d='M354 9.31 352.69 8l-5.19 5.19L342.31 8 341 9.31l5.19 5.19-5.19 5.19 1.31 1.31 5.19-5.19 5.19 5.19 1.31-1.31-5.19-5.19z' fill-rule='evenodd'/%3E%3C/svg%3E\\\");background-size:13px 13px;background-position:9px;background-color:#fff;background-repeat:no-repeat;box-shadow:0 -1px 1px 0 rgba(0,0,0,0.2);border:none;border-radius:12px 0 0 0;cursor:pointer}body:not(.i-amphtml-subs-grant-yes) .i-amphtml-subs-dialog-close-button{display:none}.i-amphtml-subs-progress{height:2px;background-color:#ccc;position:relative;margin:8px;overflow:hidden}.i-amphtml-subs-progress:after{content:\\\"\\\";background-color:#2196f3;height:2px;position:absolute;left:0;top:0;width:20%;animation:i-amphtml-subs-loading-progress 1500ms ease-in-out infinite}@keyframes i-amphtml-subs-loading-progress{0%{transform:translateX(-100%)}to{transform:translateX(500%)}}@media (min-width:480px){amp-subscriptions-dialog{width:480px!important;left:-240px!important;margin-left:50vw!important}}\\n/*# sourceURL=/extensions/amp-subscriptions/0.1/amp-subscriptions.css*/\";\n", "/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Subtle-based AES-GCM decryption supported on all browser types.\n * Decrypts the input text using AES-GCM with the input base64 encoded key\n * and importing the key using subtle.importKey.\n * @param {string} key\n * @param {string} text\n * @return {!Promise}\n */\nexport function decryptAesGcm(key, text) {\n  const keybytes = base64Decode(key);\n  return safeAesGcmImportKey(keybytes.buffer).then((formattedkey) => {\n    text = text.replace(/\\s+/g, '');\n    const contentBuffer = base64Decode(text).buffer;\n    const iv = contentBuffer.slice(0, 12);\n    const bytesToDecrypt = contentBuffer.slice(12);\n    return decryptAesGcmImpl(formattedkey, iv, bytesToDecrypt)\n  });\n  }\n    \n/**\n * Subtle-based AES-GCM decryption supported on all browser types.\n * Decrypts the input text using AES-GCM with the input key and IV.\n * @param {!CryptoKey} key\n * @param {!ArrayBuffer} iv\n * @param {!ArrayBuffer} text\n * @return {!Promise}\n */\nexport function decryptAesGcmImpl(key, iv, text) {\n  const isIE = !!self.msCrypto;\n  const subtle = isIE ? self.msCrypto.subtle : self.crypto.subtle;\n  return wrapCryptoOp(subtle\n    .decrypt(\n      {\n        name: 'AES-GCM',\n        iv: iv,\n        // IE requires \"tag\" of length 16.\n        tag: isIE ? text.slice(text.byteLength - 16) : undefined,\n        // Edge requires \"tagLength\".\n        tagLength: 128 // block size (16): 1-128\n      },\n      key,\n      // IE requires \"tag\" to be removed from the bytes.\n      isIE ? text.slice(0, text.byteLength - 16) : text\n    ))\n    .then((buffer) => {\n      // 5. Decryption gives us raw bytes and we need to turn them into text.\n      return utf8Decode(new Uint8Array(buffer));\n    });\n}\n\n/**\n * Subtle import key for AES-GCM key types that is supported\n * on all browser types.\n * @param {!ArrayBuffer} key\n * @return {!Promise}\n */\nexport function safeAesGcmImportKey(key) {\n  const isIE = !!self.msCrypto;\n  const subtle = isIE ? self.msCrypto.subtle : self.crypto.subtle;\n  return wrapCryptoOp(subtle.importKey('raw', key,\n    'AES-GCM',\n    true, ['decrypt']));\n}\n\n/** \n * Converts IE11 CryptoOperation type to a Promise.\n * @param {Object} op\n * @return {!Promise}\n */\nfunction wrapCryptoOp(op) {\n  if (typeof op.then == 'function') {\n    return op;\n  }\n  return new Promise((resolve, reject) => {\n    op.oncomplete = (e) => {\n      resolve(op.result);\n    };\n    op.onerror = reject;\n  });\n}\n\n/**\n * Interpret a byte array as a UTF-8 string.\n * @param {!BufferSource} bytes\n * @return {string}\n */\nfunction utf8Decode(bytes) {\n  if (typeof TextDecoder !== 'undefined') {\n    return new TextDecoder('utf-8').decode(bytes);\n  }\n  const bytesBuffer = new Uint8Array(bytes.buffer || bytes);\n  const array = new Array(bytesBuffer.length);\n  for (let i = 0; i < bytesBuffer.length; i++) {\n    array[i] = String.fromCharCode(bytesBuffer[i]);\n  }\n  const asciiString = array.join('');\n  return decodeURIComponent(escape(asciiString));\n}\n\n/**\n * Converts a base64 string into a Uint8Array with the corresponding bytes.\n * @param {string} str\n * @return {!Uint8Array}\n */\nexport function base64Decode(str) {\n  const bytes = atob(str);\n  const len = bytes.length;\n  const array = new Uint8Array(len);\n  for (let i = 0; i < len; i++) {\n    array[i] = bytes.charCodeAt(i);\n  }\n  return array;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isArray} from '../array';\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n\n// NOTE Type are changed to {*} because of\n// https://github.com/google/closure-compiler/issues/1999\n\n/**\n * JSON scalar. It's either string, number or boolean.\n * @typedef {string|number|boolean|null}\n */\nlet JSONScalarDef;\n\n/**\n * JSON object. It's a map with string keys and JSON values.\n * @typedef {!Object<string, ?*>} (* should be JSONValueDef)\n */\nlet JSONObjectDef;\n\n/**\n * JSON array. It's an array with JSON values.\n * @typedef {!Array<?*>} (* should be JSONValueDef)\n */\nlet JSONArrayDef;\n\n/**\n * JSON value. It's either a scalar, an object or an array.\n * @typedef {!JSONScalarDef|!JSONObjectDef|!JSONArrayDef}\n */\nlet JSONValueDef;\n\n/**\n * @typedef {{\n *   YOU_MUST_USE: string,\n *   jsonLiteral: function(),\n *   TO_MAKE_THIS_TYPE: string,\n * }}\n */\nlet InternalJsonLiteralTypeDef;\n\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {string} json JSON string to parse\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function parseJson(json) {\n  return /** @type {?JsonObject} */ (JSON.parse(json));\n}\n\n/**\n * Parses the given `json` string without throwing an exception if not valid.\n * Returns `undefined` if parsing fails.\n * Returns the `Object` corresponding to the JSON string when parsing succeeds.\n * @param {string} json JSON string to parse\n * @param {function(!Error)=} opt_onFailed Optional function that will be called\n *     with the error if parsing fails.\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function tryParseJson(json, opt_onFailed) {\n  try {\n    return parseJson(json);\n  } catch (e) {\n    opt_onFailed?.(e);\n    return null;\n  }\n}\n\n/**\n * Deeply checks strict equality of items in nested arrays and objects.\n *\n * @param {JSONValueDef} a\n * @param {JSONValueDef} b\n * @param {number} depth The maximum depth. Must be finite.\n * @return {boolean}\n * @throws {Error} If depth argument is not finite.\n */\nexport function deepEquals(a, b, depth = 5) {\n  if (!isFinite(depth) || depth < 0) {\n    throw new Error('Invalid depth: ' + depth);\n  }\n  if (a === b) {\n    return true;\n  }\n  /** @type {!Array<{a: JSONValueDef, b: JSONValueDef, depth: number}>} */\n  const queue = [{a, b, depth}];\n  while (queue.length > 0) {\n    const {a, b, depth} = queue.shift();\n    // Only check deep equality if depth > 0.\n    if (depth > 0) {\n      if (typeof a !== typeof b) {\n        return false;\n      } else if (isArray(a) && isArray(b)) {\n        if (a.length !== b.length) {\n          return false;\n        }\n        for (let i = 0; i < a.length; i++) {\n          queue.push({a: a[i], b: b[i], depth: depth - 1});\n        }\n        continue;\n      } else if (a && b && typeof a === 'object' && typeof b === 'object') {\n        const keysA = Object.keys(a);\n        const keysB = Object.keys(b);\n        if (keysA.length !== keysB.length) {\n          return false;\n        }\n        for (const k of keysA) {\n          queue.push({a: a[k], b: b[k], depth: depth - 1});\n        }\n        continue;\n      }\n    }\n    // If we get here, then depth == 0 or (a, b) are primitives.\n    if (a !== b) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * This helper function handles configurations specified in a JSON format.\n *\n * It allows the configuration is to be written in plain JS (which has better\n * dev ergonomics like comments and trailing commas), and allows the\n * configuration to be transformed into an efficient JSON-parsed representation\n * in the dist build. See https://v8.dev/blog/cost-of-javascript-2019#json\n *\n * @param {!Object} obj\n * @return {!JsonObject}\n */\nexport function jsonConfiguration(obj) {\n  return /** @type {!JsonObject} */ (obj);\n}\n\n/**\n * This converts an Object into a suitable type to be used in `includeJsonLiteral`.\n * This doesn't actually do any conversion, it only changes the closure type.\n *\n * @param {?JSONValueDef} value\n * @return {!InternalJsonLiteralTypeDef}\n */\nexport function jsonLiteral(value) {\n  return /** @type {!InternalJsonLiteralTypeDef} */ (value);\n}\n\n/**\n * Allows inclusion of a variable (that's wrapped in a jsonLiteral\n * call) to be included inside a jsonConfiguration.\n *\n * @param {!InternalJsonLiteralTypeDef} value\n * @return {*}\n */\nexport function includeJsonLiteral(value) {\n  return value;\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../../assert';\n\n/**\n * Interpret a byte array as a UTF-8 string.\n * @param {!BufferSource} bytes\n * @return {string}\n */\nexport function utf8Decode(bytes) {\n  if (typeof TextDecoder !== 'undefined') {\n    return new TextDecoder('utf-8').decode(bytes);\n  }\n  const asciiString = bytesToString(new Uint8Array(bytes.buffer || bytes));\n  return decodeURIComponent(escape(asciiString));\n}\n\n/**\n * Turn a string into UTF-8 bytes.\n * @param {string} string\n * @return {!Uint8Array}\n */\nexport function utf8Encode(string) {\n  if (typeof TextEncoder !== 'undefined') {\n    return new TextEncoder('utf-8').encode(string);\n  }\n  return stringToBytes(unescape(encodeURIComponent(string)));\n}\n\n/**\n * Converts a string which holds 8-bit code points, such as the result of atob,\n * into a Uint8Array with the corresponding bytes.\n * If you have a string of characters, you probably want to be using utf8Encode.\n * @param {string} str\n * @return {!Uint8Array}\n */\nexport function stringToBytes(str) {\n  const bytes = new Uint8Array(str.length);\n  for (let i = 0; i < str.length; i++) {\n    const charCode = str.charCodeAt(i);\n    devAssert(charCode <= 255, 'Characters must be in range [0,255]');\n    bytes[i] = charCode;\n  }\n  return bytes;\n}\n\n/**\n * Converts a 8-bit bytes array into a string\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nexport function bytesToString(bytes) {\n  // Intentionally avoids String.fromCharCode.apply so we don't suffer a\n  // stack overflow. #10495, https://jsperf.com/bytesToString-2\n  const array = new Array(bytes.length);\n  for (let i = 0; i < bytes.length; i++) {\n    array[i] = String.fromCharCode(bytes[i]);\n  }\n  return array.join('');\n}\n\n/**\n * Converts a 4-item byte array to an unsigned integer.\n * Assumes bytes are big endian.\n * @param {!Uint8Array} bytes\n * @return {number}\n */\nexport function bytesToUInt32(bytes) {\n  if (bytes.length != 4) {\n    throw new Error('Received byte array with length != 4');\n  }\n  const val =\n    ((bytes[0] & 0xff) << 24) |\n    ((bytes[1] & 0xff) << 16) |\n    ((bytes[2] & 0xff) << 8) |\n    (bytes[3] & 0xff);\n  // Convert to unsigned.\n  return val >>> 0;\n}\n\n/**\n * Generate a random bytes array with specific length using\n * win.crypto.getRandomValues. Return null if it is not available.\n * @param {!Window} win\n * @param {number} length\n * @return {?Uint8Array}\n */\nexport function getCryptoRandomBytesArray(win, length) {\n  let {crypto} = win;\n\n  // Support IE 11\n  if (!IS_ESM) {\n    crypto = /** @type {!webCrypto.Crypto|undefined} */ (\n      crypto || win.msCrypto\n    );\n    if (!crypto || !crypto.getRandomValues) {\n      return null;\n    }\n  }\n\n  // Widely available in browsers we support:\n  // http://caniuse.com/#search=getRandomValues\n  const uint8array = new Uint8Array(length);\n  crypto.getRandomValues(uint8array);\n  return uint8array;\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  base64Decode,\n  decryptAesGcmImpl,\n  safeAesGcmImportKey,\n} from '../../../third_party/subscriptions-project/aes_gcm';\nimport {iterateCursor} from '../../../src/dom';\nimport {padStart} from '../../../src/core/types/string';\nimport {toArray} from '../../../src/core/types/array';\nimport {tryParseJson} from '../../../src/core/types/object/json';\nimport {utf8Encode} from '../../../src/core/types/string/bytes';\n\nexport class CryptoHandler {\n  /**\n   * Creates an instance of CryptoHandler.\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @private @const {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @private {?Promise} */\n    this.decryptionPromise_ = null;\n\n    const parsedEncryptedKeys = this.ampdoc_\n      .getRootNode()\n      .querySelector('script[cryptokeys]');\n\n    /** @private {?string} */\n    this.shaKeyHash_ = null;\n    if (\n      parsedEncryptedKeys &&\n      parsedEncryptedKeys.hasAttribute('sha-256-hash')\n    ) {\n      this.shaKeyHash_ = parsedEncryptedKeys.getAttribute('sha-256-hash');\n    }\n\n    /** @type {?JsonObject} */\n    this.encryptedKeys_ =\n      (parsedEncryptedKeys && tryParseJson(parsedEncryptedKeys.textContent)) ||\n      null;\n  }\n\n  /**\n   * Checks if the document is encrypted by looking at the parsed keys.\n   * @return {boolean}\n   */\n  isDocumentEncrypted() {\n    return !!this.encryptedKeys_ && Object.keys(this.encryptedKeys_).length > 0;\n  }\n\n  /**\n   * This method is used for testing.\n   * @return {?JsonObject}\n   */\n  getEncryptedKeys() {\n    return this.encryptedKeys_;\n  }\n\n  /**\n   * Returns encrypted document key if it exists.\n   * This key is needed for requesting a different key\n   * that decrypts locked content on the page.\n   * @param {string} platformKey Who you want to decrypt the key.\n   *                             For example: 'google.com'\n   * @return {?string}\n   */\n  getEncryptedDocumentKey(platformKey) {\n    // Doing this for testing.\n    const encryptedKeys = this.getEncryptedKeys();\n    if (!encryptedKeys) {\n      return null;\n    }\n    return encryptedKeys[platformKey] || null;\n  }\n\n  /**\n   * @param {string} decryptedDocumentKey\n   * @return {!Promise}\n   */\n  tryToDecryptDocument(decryptedDocumentKey) {\n    if (!this.shaKeyHash_) {\n      return this.tryToDecryptDocumentImpl_(decryptedDocumentKey);\n    }\n    const docKeyUint8 = utf8Encode(decryptedDocumentKey);\n    return crypto.subtle.digest('SHA-256', docKeyUint8).then((val) => {\n      const hashArray = toArray(new Uint8Array(val));\n      const hashHex = hashArray\n        .map((b) => padStart(b.toString(16), 2, '0'))\n        .join('');\n      if (hashHex != this.shaKeyHash_) {\n        return Promise.reject(new Error('Invalid Document Key'));\n      }\n      return this.tryToDecryptDocumentImpl_(decryptedDocumentKey);\n    });\n  }\n\n  /**\n   * @private\n   * @param {string} decryptedDocumentKey\n   * @return {!Promise}\n   */\n  tryToDecryptDocumentImpl_(decryptedDocumentKey) {\n    if (this.decryptionPromise_) {\n      return this.decryptionPromise_;\n    }\n    this.decryptionPromise_ = this.ampdoc_.whenReady().then(() => {\n      const keybytes = base64Decode(decryptedDocumentKey);\n      return safeAesGcmImportKey(keybytes.buffer).then((formattedkey) => {\n        const encryptedSections = this.ampdoc_\n          .getRootNode()\n          .querySelectorAll('script[ciphertext]');\n        const promises = [];\n        iterateCursor(encryptedSections, (encryptedSection) => {\n          const text = encryptedSection.textContent.replace(/\\s+/g, '');\n          const contentBuffer = base64Decode(text).buffer;\n          const iv = contentBuffer.slice(0, 12);\n          const bytesToDecrypt = contentBuffer.slice(12);\n          promises.push(\n            decryptAesGcmImpl(formattedkey, iv, bytesToDecrypt).then(\n              (decryptedContent) => {\n                encryptedSection./*OK*/ outerHTML = decryptedContent;\n              }\n            )\n          );\n        });\n        return Promise.all(promises);\n      });\n    });\n    return this.decryptionPromise_;\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Note: loaded by 3p system. Cannot rely on babel polyfills.\nimport {dev, devAssert} from './log';\nimport {map} from './core/types/object';\n\n/** @type {Object<string, string>} */\nlet propertyNameCache;\n\n/** @const {!Array<string>} */\nconst vendorPrefixes = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n\nconst EMPTY_CSS_DECLARATION = /** @type {!CSSStyleDeclaration} */ ({\n  'getPropertyPriority': () => '',\n  'getPropertyValue': () => '',\n});\n\n/**\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\nexport function camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n\n/**\n  Checks the style if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} style\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\nfunction getVendorJsPropertyName_(style, titleCase) {\n  for (let i = 0; i < vendorPrefixes.length; i++) {\n    const propertyName = vendorPrefixes[i] + titleCase;\n    if (style[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n  return '';\n}\n\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @param {!Object} style\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} opt_bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\nexport function getVendorJsPropertyName(style, camelCase, opt_bypassCache) {\n  if (isVar(camelCase)) {\n    // CSS vars are returned as is.\n    return camelCase;\n  }\n  if (!propertyNameCache) {\n    propertyNameCache = map();\n  }\n  let propertyName = propertyNameCache[camelCase];\n  if (!propertyName || opt_bypassCache) {\n    propertyName = camelCase;\n    if (style[camelCase] === undefined) {\n      const titleCase = camelCaseToTitleCase(camelCase);\n      const prefixedPropertyName = getVendorJsPropertyName_(style, titleCase);\n\n      if (style[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n    if (!opt_bypassCache) {\n      propertyNameCache[camelCase] = propertyName;\n    }\n  }\n  return propertyName;\n}\n\n/**\n * Sets the CSS styles of the specified element with !important. The styles\n * are specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setImportantStyles(element, styles) {\n  const {style} = element;\n  for (const k in styles) {\n    style.setProperty(\n      getVendorJsPropertyName(style, k),\n      String(styles[k]),\n      'important'\n    );\n  }\n}\n\n/**\n * Sets the CSS style of the specified element with optional units, e.g. \"px\".\n * @param {?Element} element\n * @param {string} property\n * @param {*} value\n * @param {string=} opt_units\n * @param {boolean=} opt_bypassCache\n */\nexport function setStyle(element, property, value, opt_units, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return;\n  }\n  const styleValue = /** @type {string} */ (\n    opt_units ? value + opt_units : value\n  );\n  if (isVar(propertyName)) {\n    element.style.setProperty(propertyName, styleValue);\n  } else {\n    element.style[propertyName] = styleValue;\n  }\n}\n\n/**\n * Returns the value of the CSS style of the specified element.\n * @param {!Element} element\n * @param {string} property\n * @param {boolean=} opt_bypassCache\n * @return {*}\n */\nexport function getStyle(element, property, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return undefined;\n  }\n  if (isVar(propertyName)) {\n    return element.style.getPropertyValue(propertyName);\n  }\n  return element.style[propertyName];\n}\n\n/**\n * Sets the CSS styles of the specified element. The styles\n * a specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setStyles(element, styles) {\n  for (const k in styles) {\n    setStyle(element, k, styles[k]);\n  }\n}\n\n/**\n * Asserts that the style is not the `display` style.\n * This is the only possible way to pass a dynamic style to setStyle.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {string} style\n * @return {string}\n */\nexport function assertNotDisplay(style) {\n  if (style === 'display') {\n    dev().error(\n      'STYLE',\n      '`display` style detected. You must use toggle instead.'\n    );\n  }\n  return style;\n}\n\n/**\n * Asserts that the styles does not contain the `display` style.\n * This is the only possible way to pass a dynamic styles object to setStyles\n * and setImportantStyles.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {!Object<string, *>} styles\n * @return {!Object<string, *>}\n */\nexport function assertDoesNotContainDisplay(styles) {\n  if ('display' in styles) {\n    dev().error(\n      'STYLE',\n      '`display` style detected in styles. You must use toggle instead.'\n    );\n  }\n  return styles;\n}\n\n/**\n * Sets the initial display style of an element. This is a last resort. If you\n * can set the initial display using CSS, YOU MUST.\n * DO NOT USE THIS TO ARBITRARILY SET THE DISPLAY STYLE AFTER INITIAL SETUP.\n *\n * @param {!Element} el\n * @param {string} value\n */\nexport function setInitialDisplay(el, value) {\n  const {style} = el;\n  devAssert(\n    value !== '' && value !== 'none',\n    'Initial display value must not be \"none\". Use toggle instead.'\n  );\n  devAssert(\n    !style['display'],\n    'setInitialDisplay MUST NOT be used for ' +\n      'resetting the display style. If you are looking for display:none ' +\n      'toggling, use toggle instead.'\n  );\n  style['display'] = value;\n}\n\n/**\n * Shows or hides the specified element.\n * @param {!Element} element\n * @param {boolean=} opt_display\n */\nexport function toggle(element, opt_display) {\n  if (opt_display === undefined) {\n    opt_display = element.hasAttribute('hidden');\n  }\n  if (opt_display) {\n    element.removeAttribute('hidden');\n  } else {\n    element.setAttribute('hidden', '');\n  }\n}\n\n/**\n * Returns a pixel value.\n * @param {number} value\n * @return {string}\n */\nexport function px(value) {\n  return `${value}px`;\n}\n\n/**\n * Returns a degree value.\n * @param {number} value\n * @return {string}\n */\nexport function deg(value) {\n  return `${value}deg`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function translateX(value) {\n  if (typeof value == 'string') {\n    return `translateX(${value})`;\n  }\n  return `translateX(${px(value)})`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} x\n * @param {(number|string)=} opt_y\n * @return {string}\n */\nexport function translate(x, opt_y) {\n  if (typeof x == 'number') {\n    x = px(x);\n  }\n  if (opt_y === undefined) {\n    return `translate(${x})`;\n  }\n  if (typeof opt_y == 'number') {\n    opt_y = px(opt_y);\n  }\n  return `translate(${x}, ${opt_y})`;\n}\n\n/**\n * Returns a \"scale\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function scale(value) {\n  return `scale(${value})`;\n}\n\n/**\n * Returns a \"rotate\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function rotate(value) {\n  if (typeof value == 'number') {\n    value = deg(value);\n  }\n  return `rotate(${value})`;\n}\n\n/**\n * Remove alpha value from a rgba color value.\n * Return the new color property with alpha equals if has the alpha value.\n * Caller needs to make sure the input color value is a valid rgba/rgb value\n * @param {string} rgbaColor\n * @return {string}\n */\nexport function removeAlphaFromColor(rgbaColor) {\n  return rgbaColor.replace(\n    /\\(([^,]+),([^,]+),([^,)]+),[^)]+\\)/g,\n    '($1,$2,$3, 1)'\n  );\n}\n\n/**\n * Gets the computed style of the element. The helper is necessary to enforce\n * the possible `null` value returned by a buggy Firefox.\n *\n * @param {!Window} win\n * @param {!Element} el\n * @return {!CSSStyleDeclaration}\n */\nexport function computedStyle(win, el) {\n  const style = /** @type {?CSSStyleDeclaration} */ (win.getComputedStyle(el));\n  return style || EMPTY_CSS_DECLARATION;\n}\n\n/**\n * Resets styles that were set dynamically (i.e. inline)\n * @param {!Element} element\n * @param {!Array<string>} properties\n */\nexport function resetStyles(element, properties) {\n  for (let i = 0; i < properties.length; i++) {\n    setStyle(element, properties[i], null);\n  }\n}\n\n/**\n * Propagates the object-fit/position element attributes as styles.\n * @param {!Element} fromEl ie: amp-img\n * @param {!Element} toEl ie: the img within amp-img\n */\nexport function propagateObjectFitStyles(fromEl, toEl) {\n  if (fromEl.hasAttribute('object-fit')) {\n    setStyle(toEl, 'object-fit', fromEl.getAttribute('object-fit'));\n  }\n\n  if (fromEl.hasAttribute('object-position')) {\n    setStyle(toEl, 'object-position', fromEl.getAttribute('object-position'));\n  }\n}\n\n/**\n * @param {string} property\n * @return {boolean}\n */\nfunction isVar(property) {\n  return property.startsWith('--');\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {createElementWithAttributes} from '../../../src/dom';\nimport {setImportantStyles, toggle} from '../../../src/style';\n\nexport class Dialog {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @private @const {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @private @const {!../../../src/service/vsync-impl.Vsync} */\n    this.vsync_ = Services.vsyncFor(ampdoc.win);\n\n    /** @private @const {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(ampdoc.win);\n\n    /**\n     * @private @const {!../../../src/service/viewport/viewport-interface.ViewportInterface}\n     */\n    this.viewport_ = Services.viewportForDoc(ampdoc);\n\n    /** @private {boolean} */\n    this.visible_ = false;\n\n    /** @private {?Element} */\n    this.content_ = null;\n\n    /** @private {!Promise} */\n    this.lastAction_ = Promise.resolve();\n\n    const doc = this.ampdoc_.win.document;\n\n    /** @private @const {!Element} */\n    this.wrapper_ = createElementWithAttributes(\n      doc,\n      'amp-subscriptions-dialog',\n      /** @type {!JsonObject} */ ({\n        'role': 'dialog',\n      })\n    );\n    toggle(this.wrapper_, false);\n\n    /** @private @const {!Element} */\n    this.closeButton_ = createElementWithAttributes(\n      doc,\n      'button',\n      /** @type {!JsonObject} */ ({\n        'class': 'i-amphtml-subs-dialog-close-button',\n      })\n    );\n    this.showCloseAction(false);\n    this.wrapper_.appendChild(this.closeButton_);\n    this.closeButton_.addEventListener('click', () => {\n      this.close();\n    });\n\n    // Start hidden.\n    this.ampdoc_.getBody().appendChild(this.wrapper_);\n    setImportantStyles(this.wrapper_, {\n      transform: 'translateY(100%)',\n    });\n  }\n\n  /**\n   * @return {!Element}\n   */\n  getRoot() {\n    return this.wrapper_;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isVisible() {\n    return this.visible_;\n  }\n\n  /**\n   * Opens the dialog with the specified content.\n   * @param {!Element} content\n   * @param {boolean=} showCloseAction\n   * @return {!Promise}\n   */\n  open(content, showCloseAction = true) {\n    return this.action_(() => this.open_(content, showCloseAction));\n  }\n\n  /**\n   * Closes the dialog.\n   * @return {!Promise}\n   */\n  close() {\n    return this.action_(() => this.close_());\n  }\n\n  /**\n   * @param {!Function} action\n   * @return {!Promise}\n   * @private\n   */\n  action_(action) {\n    return (this.lastAction_ = this.lastAction_.then(action));\n  }\n\n  /**\n   * Opens the dialog with the specified content.\n   * @param {!Element} content\n   * @param {boolean=} showCloseAction\n   * @return {!Promise}\n   * @private\n   */\n  open_(content, showCloseAction = true) {\n    if (this.content_) {\n      this.wrapper_.replaceChild(content, this.content_);\n    } else {\n      this.wrapper_.appendChild(content);\n    }\n    this.content_ = content;\n    if (this.visible_) {\n      return Promise.resolve();\n    }\n    this.visible_ = true;\n    return this.vsync_\n      .mutatePromise(() => {\n        toggle(this.wrapper_, true);\n        this.showCloseAction(/** @type {boolean} */ (showCloseAction));\n      })\n      .then(() => {\n        // Animate to display.\n        return this.vsync_\n          .mutatePromise(() => {\n            setImportantStyles(this.wrapper_, {\n              transform: 'translateY(0)',\n            });\n          })\n          .then(() => this.timer_.promise(300));\n      })\n      .then(() => {\n        // Update page layout.\n        let offsetHeight;\n        return this.vsync_.runPromise({\n          measure: () => {\n            offsetHeight = this.wrapper_./*OK*/ offsetHeight;\n          },\n          mutate: () => {\n            this.viewport_.updatePaddingBottom(offsetHeight);\n            this.viewport_.addToFixedLayer(this.wrapper_, true);\n          },\n        });\n      });\n  }\n\n  /**\n   * Closes the dialog.\n   * @return {!Promise}\n   * @private\n   */\n  close_() {\n    if (!this.visible_) {\n      return Promise.resolve();\n    }\n    return this.vsync_\n      .mutatePromise(() => {\n        setImportantStyles(this.wrapper_, {\n          transform: 'translateY(100%)',\n        });\n      })\n      .then(() => {\n        return this.timer_.promise(300);\n      })\n      .then(() => {\n        return this.vsync_.mutatePromise(() => {\n          toggle(this.wrapper_, false);\n          this.viewport_.updatePaddingBottom(0);\n          this.visible_ = false;\n        });\n      });\n  }\n\n  /**\n   * Renders or hides the \"Close\" action button. For some flows, this button\n   * should be hidden.\n   * @param {boolean} show\n   */\n  showCloseAction(show) {\n    toggle(this.closeButton_, show);\n  }\n}\n", "/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/** Version: 0.1.22.168 */\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {!Document} doc\n * @return {string}\n */\nfunction getReadyState(doc) {\n  return /** @type {string} */ (doc['readyState']);\n}\n\n/**\n * Whether the document is ready.\n * @param {!Document} doc\n * @return {boolean}\n */\nfunction isDocumentReady(doc) {\n  const readyState = getReadyState(doc);\n  return readyState != 'loading' && readyState != 'uninitialized';\n}\n\n/**\n * Calls the callback when document is ready.\n * @param {!Document} doc\n * @param {function(!Document)} callback\n */\nfunction onDocumentReady(doc, callback) {\n  onDocumentState(doc, isDocumentReady, callback);\n}\n\n/**\n * Calls the callback once when document's state satisfies the condition.\n * @param {!Document} doc\n * @param {function(!Document):boolean} condition\n * @param {function(!Document)} callback\n */\nfunction onDocumentState(doc, condition, callback) {\n  if (condition(doc)) {\n    // Execute callback right now.\n    callback(doc);\n    return;\n  }\n\n  // Execute callback (once!) after condition is satisfied.\n  let callbackHasExecuted = false;\n  const readyListener = () => {\n    if (condition(doc) && !callbackHasExecuted) {\n      callback(doc);\n      callbackHasExecuted = true;\n      doc.removeEventListener('readystatechange', readyListener);\n    }\n  };\n  doc.addEventListener('readystatechange', readyListener);\n}\n\n/**\n * Returns a promise that is resolved when document is ready.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\nfunction whenDocumentReady(doc) {\n  return new Promise((resolve) => {\n    onDocumentReady(doc, resolve);\n  });\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @interface\n */\nclass Doc {\n  /**\n   * @return {!Window}\n   */\n  getWin() {}\n\n  /**\n   * The `Document` node or analog.\n   * @return {!Node}\n   */\n  getRootNode() {}\n\n  /**\n   * The `Document.documentElement` element or analog.\n   * @return {!Element}\n   */\n  getRootElement() {}\n\n  /**\n   * The `Document.head` element or analog. Returns `null` if not available\n   * yet.\n   * @return {!Element}\n   */\n  getHead() {}\n\n  /**\n   * The `Document.body` element or analog. Returns `null` if not available\n   * yet.\n   * @return {?Element}\n   */\n  getBody() {}\n\n  /**\n   * Whether the document has been fully constructed.\n   * @return {boolean}\n   */\n  isReady() {}\n\n  /**\n   * Resolved when document has been fully constructed.\n   * @return {!Promise}\n   */\n  whenReady() {}\n\n  /**\n   * Adds the element to the fixed layer.\n   * @param {!Element} unusedElement\n   * @return {!Promise}\n   *\n   * This is a no-op for except in AMP on iOS < 13.0.\n   */\n  addToFixedLayer(unusedElement) {}\n}\n\n/** @implements {Doc} */\nclass GlobalDoc {\n  /**\n   * @param {!Window|!Document} winOrDoc\n   */\n  constructor(winOrDoc) {\n    const isWin = !!winOrDoc.document;\n    /** @private @const {!Window} */\n    this.win_ = /** @type {!Window} */ (\n      isWin\n        ? /** @type {!Window} */ (winOrDoc)\n        : /** @type {!Document} */ (winOrDoc).defaultView\n    );\n    /** @private @const {!Document} */\n    this.doc_ = isWin\n      ? /** @type {!Window} */ (winOrDoc).document\n      : /** @type {!Document} */ (winOrDoc);\n  }\n\n  /** @override */\n  getWin() {\n    return this.win_;\n  }\n\n  /** @override */\n  getRootNode() {\n    return this.doc_;\n  }\n\n  /** @override */\n  getRootElement() {\n    return this.doc_.documentElement;\n  }\n\n  /** @override */\n  getHead() {\n    // `document.head` always has a chance to be parsed, at least partially.\n    return /** @type {!Element} */ (this.doc_.head);\n  }\n\n  /** @override */\n  getBody() {\n    return this.doc_.body;\n  }\n\n  /** @override */\n  isReady() {\n    return isDocumentReady(this.doc_);\n  }\n\n  /** @override */\n  whenReady() {\n    return whenDocumentReady(this.doc_);\n  }\n\n  /** @override */\n  addToFixedLayer(unusedElement) {\n    return Promise.resolve();\n  }\n}\n\n/**\n * @param {!Document|!Window|!Doc} input\n * @return {!Doc}\n */\nfunction resolveDoc(input) {\n  // Is it a `Document`\n  if (/** @type {!Document} */ (input).nodeType === /* DOCUMENT */ 9) {\n    return new GlobalDoc(/** @type {!Document} */ (input));\n  }\n  // Is it a `Window`?\n  if (/** @type {!Window} */ (input).document) {\n    return new GlobalDoc(/** @type {!Window} */ (input));\n  }\n  return /** @type {!Doc} */ (input);\n}\n\n/**\n * Copyright 2020 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Triple zero width space.\n *\n * This is added to user error messages, so that we can later identify\n * them, when the only thing that we have is the message. This is the\n * case in many browsers when the global exception handler is invoked.\n *\n * @const {string}\n */\nconst AMP_USER_ERROR_SENTINEL = '\\u200B\\u200B\\u200B';\n\n/**\n * Some exceptions (DOMException, namely) have read-only message.\n * @param {!Error} error\n * @return {!Error}\n */\nfunction duplicateErrorIfNecessary(error) {\n  const messageProperty = Object.getOwnPropertyDescriptor(error, 'message');\n  if (messageProperty && messageProperty.writable) {\n    return error;\n  }\n\n  const {message, stack} = error;\n  const e = new Error(message);\n  // Copy all the extraneous things we attach.\n  for (const prop in error) {\n    e[prop] = error[prop];\n  }\n  // Ensure these are copied.\n  e.stack = stack;\n  return e;\n}\n\n/**\n * @param {...*} var_args\n * @return {!Error}\n */\nfunction createErrorVargs(var_args) {\n  let error = null;\n  let message = '';\n  for (let i = 0; i < arguments.length; i++) {\n    const arg = arguments[i];\n    if (arg instanceof Error && !error) {\n      error = duplicateErrorIfNecessary(arg);\n    } else {\n      if (message) {\n        message += ' ';\n      }\n      message += arg;\n    }\n  }\n\n  if (!error) {\n    error = new Error(message);\n  } else if (message) {\n    error.message = message + ': ' + error.message;\n  }\n  return error;\n}\n\n/** Helper class for throwing standardized errors. */\nclass ErrorLogger {\n  /**\n   * Constructor.\n   *\n   * opt_suffix will be appended to error message to identify the type of the\n   * error message. We can't rely on the error object to pass along the type\n   * because some browsers do not have this param in its window.onerror API.\n   * See:\n   * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n   *\n   * @param {string=} opt_suffix\n   */\n  constructor(opt_suffix = '') {\n    /** @private @const {string} */\n    this.suffix_ = opt_suffix;\n  }\n\n  /**\n   * Modifies an error before reporting, such as to add metadata.\n   * @param {!Error} error\n   * @private\n   */\n  prepareError_(error) {\n    if (this.suffix_) {\n      if (!error.message) {\n        error.message = this.suffix_;\n      } else if (error.message.indexOf(this.suffix_) === -1) {\n        error.message = this.suffix_;\n      }\n    }\n  }\n\n  /**\n   * Creates an error.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createError(var_args) {\n    const error = createErrorVargs.apply(\n      null,\n      Array.prototype.slice.call(arguments)\n    );\n    this.prepareError_(error);\n    return error;\n  }\n\n  /**\n   * Creates an error object with its expected property set to true. Used for\n   * expected failure states (ex. incorrect configuration, localStorage\n   * unavailable due to browser settings, etc.) as opposed to unexpected\n   * breakages/failures.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createExpectedError(var_args) {\n    const error = createErrorVargs.apply(\n      null,\n      Array.prototype.slice.call(arguments)\n    );\n    this.prepareError_(error);\n    error.expected = true;\n    return error;\n  }\n\n  /**\n   * Throws an error.\n   * @param {...*} var_args\n   * @throws {!Error}\n   */\n  error(var_args) {\n    throw this.createError.apply(this, arguments);\n  }\n\n  /**\n   * Throws an error and marks with an expected property.\n   * @param {...*} var_args\n   * @throws {!Error}\n   */\n  expectedError(var_args) {\n    throw this.createExpectedError.apply(this, arguments);\n  }\n}\n\nconst userLogger = new ErrorLogger(\n  self.__AMP_TOP ? AMP_USER_ERROR_SENTINEL : ''\n);\nnew ErrorLogger();\n\nconst user = () => userLogger;\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n */\nclass PageConfig {\n  /**\n   * @param {string} productOrPublicationId\n   * @param {boolean} locked\n   */\n  constructor(productOrPublicationId, locked) {\n    let publicationId, productId, label;\n    const div = productOrPublicationId.indexOf(':');\n    if (div != -1) {\n      // The argument is a product id.\n      productId = productOrPublicationId;\n      publicationId = productId.substring(0, div);\n      label = productId.substring(div + 1);\n      if (label == '*') {\n        user().expectedError('wildcard disallowed');\n      }\n    } else {\n      // The argument is a publication id.\n      publicationId = productOrPublicationId;\n      productId = null;\n      label = null;\n    }\n\n    /** @private @const {string} */\n    this.publicationId_ = publicationId;\n    /** @private @const {?string} */\n    this.productId_ = productId;\n    /** @private @const {?string} */\n    this.label_ = label;\n    /** @private @const {boolean} */\n    this.locked_ = locked;\n  }\n\n  /**\n   * @return {string}\n   */\n  getPublicationId() {\n    return this.publicationId_;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getProductId() {\n    return this.productId_;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getLabel() {\n    return this.label_;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isLocked() {\n    return this.locked_;\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Debug logger, only log message if #swg.log=1\n * @param {...*} var_args [decription]\n */\n\n/* eslint-disable */\n\nfunction debugLog(var_args) {\n  if (/swg.debug=1/.test(self.location.hash)) {\n    const logArgs = Array.prototype.slice.call(arguments, 0);\n    logArgs.unshift('[Subscriptions]');\n    log.apply(log, logArgs);\n  }\n}\n\n/**\n * @param  {...*} var_args [description]\n */\nfunction log(var_args) {\n  console.log.apply(console, arguments);\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether the element have a next node in the document order.\n * This means either:\n *  a. The element itself has a nextSibling.\n *  b. Any of the element ancestors has a nextSibling.\n * @param {!Element} element\n * @param {?Node=} stopNode\n * @return {boolean}\n */\nfunction hasNextNodeInDocumentOrder(element, stopNode) {\n  let currentElement = element;\n  do {\n    if (currentElement.nextSibling) {\n      return true;\n    }\n  } while (\n    (currentElement = currentElement.parentNode) &&\n    currentElement != stopNode\n  );\n  return false;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {*} json JSON string to parse\n * @return {?JsonObject|undefined} May be extend to parse arrays.\n */\nfunction parseJson(json) {\n  return /** @type {?JsonObject} */ (JSON.parse(/** @type {string} */ (json)));\n}\n\n/**\n * Parses the given `json` string without throwing an exception if not valid.\n * Returns `undefined` if parsing fails.\n * Returns the `Object` corresponding to the JSON string when parsing succeeds.\n * @param {*} json JSON string to parse\n * @param {function(!Error)=} onFailed Optional function that will be called\n *     with the error if parsing fails.\n * @return {?JsonObject|undefined} May be extend to parse arrays.\n */\nfunction tryParseJson(json, onFailed) {\n  try {\n    return parseJson(json);\n  } catch (e) {\n    if (onFailed) {\n      onFailed(e);\n    }\n    return undefined;\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst ALREADY_SEEN = '__SWG-SEEN__';\n\nconst ALLOWED_TYPES = [\n  'CreativeWork',\n  'Article',\n  'NewsArticle',\n  'Blog',\n  'Comment',\n  'Course',\n  'HowTo',\n  'Message',\n  'Review',\n  'WebPage',\n];\n\n// RegExp for quickly scanning LD+JSON for allowed types\nconst RE_ALLOWED_TYPES = new RegExp(ALLOWED_TYPES.join('|'));\n\n/**\n */\nclass PageConfigResolver {\n  /**\n   * @param {!Window|!Document|!Doc} winOrDoc\n   */\n  constructor(winOrDoc) {\n    /** @private @const {!Doc} */\n    this.doc_ = resolveDoc(winOrDoc);\n\n    /** @private {?function((!PageConfig|!Promise))} */\n    this.configResolver_ = null;\n\n    /** @private @const {!Promise<!PageConfig>} */\n    this.configPromise_ = new Promise((resolve) => {\n      this.configResolver_ = resolve;\n    });\n\n    /** @private @const {!MetaParser} */\n    this.metaParser_ = new MetaParser(this.doc_);\n    /** @private @const {!JsonLdParser} */\n    this.ldParser_ = new JsonLdParser(this.doc_);\n    /** @private @const {!MicrodataParser} */\n    this.microdataParser_ = new MicrodataParser(this.doc_);\n  }\n\n  /**\n   * @return {!Promise<!PageConfig>}\n   */\n  resolveConfig() {\n    // Try resolve the config at different times.\n    Promise.resolve().then(this.check.bind(this));\n    this.doc_.whenReady().then(this.check.bind(this));\n    return this.configPromise_;\n  }\n\n  /**\n   * @return {?PageConfig}\n   */\n  check() {\n    // Already resolved.\n    if (!this.configResolver_) {\n      return null;\n    }\n    let config = this.metaParser_.check();\n    if (!config) {\n      config = this.ldParser_.check();\n    }\n    if (!config) {\n      config = this.microdataParser_.check();\n    }\n    if (config) {\n      // Product ID has been found: initialize the rest of the config.\n      this.configResolver_(config);\n      this.configResolver_ = null;\n    } else if (this.doc_.isReady()) {\n      this.configResolver_(\n        Promise.reject(\n          user().createError('No config could be discovered in the page')\n        )\n      );\n      this.configResolver_ = null;\n    }\n    debugLog(config);\n    return config;\n  }\n}\n\nclass TypeChecker {\n  constructor() {}\n\n  /**\n   * Check value from json\n   * @param {?Array|string} value\n   * @param {Array<string>} expectedTypes\n   * @return {boolean}\n   */\n  checkValue(value, expectedTypes) {\n    if (!value) {\n      return false;\n    }\n    return this.checkArray(this.toArray_(value), expectedTypes);\n  }\n\n  /**\n   * Checks space delimited list of types\n   * @param {?string} itemtype\n   * @param {Array<string>} expectedTypes\n   * @return {boolean}\n   */\n  checkString(itemtype, expectedTypes) {\n    if (!itemtype) {\n      return false;\n    }\n    return this.checkArray(itemtype.split(/\\s+/), expectedTypes);\n  }\n\n  /**\n   * @param {Array<?string>} typeArray\n   * @param {Array<string>} expectedTypes\n   * @return {boolean}\n   */\n  checkArray(typeArray, expectedTypes) {\n    let found = false;\n    typeArray.forEach((candidateType) => {\n      found =\n        found ||\n        expectedTypes.includes(\n          candidateType.replace(/^http:\\/\\/schema.org\\//i, '')\n        );\n    });\n    return found;\n  }\n\n  /*\n   * @param {?Array|string} value\n   * @return {Array}\n   * @private\n   */\n  toArray_(value) {\n    return Array.isArray(value) ? value : [value];\n  }\n}\n\nclass MetaParser {\n  /**\n   * @param {!Doc} doc\n   */\n  constructor(doc) {\n    /** @private @const {!Doc} */\n    this.doc_ = doc;\n  }\n\n  /**\n   * @return {?PageConfig}\n   */\n  check() {\n    if (!this.doc_.getBody()) {\n      // Wait until the whole `<head>` is parsed.\n      return null;\n    }\n\n    // Try to find product id.\n    const productId = getMetaTag(\n      this.doc_.getRootNode(),\n      'subscriptions-product-id'\n    );\n    if (!productId) {\n      return null;\n    }\n\n    // Is locked?\n    const accessibleForFree = getMetaTag(\n      this.doc_.getRootNode(),\n      'subscriptions-accessible-for-free'\n    );\n    const locked = !!(\n      accessibleForFree && accessibleForFree.toLowerCase() === 'false'\n    );\n\n    return new PageConfig(productId, locked);\n  }\n}\n\nclass JsonLdParser {\n  /**\n   * @param {!Doc} doc\n   */\n  constructor(doc) {\n    /** @private @const {!Doc} */\n    this.doc_ = doc;\n    /** @private @const @function */\n    this.checkType_ = new TypeChecker();\n  }\n\n  /**\n   * @return {?PageConfig}\n   */\n  check() {\n    if (!this.doc_.getBody()) {\n      // Wait until the whole `<head>` is parsed.\n      return null;\n    }\n\n    const domReady = this.doc_.isReady();\n\n    // type: 'application/ld+json'\n    const elements = this.doc_\n      .getRootNode()\n      .querySelectorAll('script[type=\"application/ld+json\"]');\n    for (let i = 0; i < elements.length; i++) {\n      const element = elements[i];\n      if (\n        element[ALREADY_SEEN] ||\n        !element.textContent ||\n        (!domReady && !hasNextNodeInDocumentOrder(element))\n      ) {\n        continue;\n      }\n      element[ALREADY_SEEN] = true;\n      if (!RE_ALLOWED_TYPES.test(element.textContent)) {\n        continue;\n      }\n      const possibleConfig = this.tryExtractConfig_(element);\n      if (possibleConfig) {\n        return possibleConfig;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {?PageConfig}\n   */\n  tryExtractConfig_(element) {\n    let possibleConfigs = tryParseJson(element.textContent);\n    if (!possibleConfigs) {\n      return null;\n    }\n\n    // Support arrays of JSON objects.\n    if (!Array.isArray(possibleConfigs)) {\n      possibleConfigs = [possibleConfigs];\n    }\n\n    const configs = /** @type {!Array<!JsonObject>} */ (possibleConfigs);\n    for (let i = 0; i < configs.length; i++) {\n      const config = configs[i];\n\n      // Must be an ALLOWED_TYPE\n      if (!this.checkType_.checkValue(config['@type'], ALLOWED_TYPES)) {\n        continue;\n      }\n\n      // Must have a isPartOf[@type=Product].\n      let productId = null;\n      const partOfArray = this.valueArray_(config, 'isPartOf');\n      if (partOfArray) {\n        for (let j = 0; j < partOfArray.length; j++) {\n          productId = this.discoverProductId_(partOfArray[j]);\n          if (productId) {\n            break;\n          }\n        }\n      }\n      if (!productId) {\n        continue;\n      }\n\n      // Found product id, just check for the access flag.\n      const isAccessibleForFree = this.bool_(\n        this.singleValue_(config, 'isAccessibleForFree'),\n        /* default */ true\n      );\n\n      return new PageConfig(productId, !isAccessibleForFree);\n    }\n\n    return null;\n  }\n\n  /**\n   * @param {*} value\n   * @param {boolean} def\n   * @return {boolean}\n   */\n  bool_(value, def) {\n    if (value == null || value === '') {\n      return def;\n    }\n    if (typeof value == 'boolean') {\n      return value;\n    }\n    if (typeof value == 'string') {\n      const lowercase = value.toLowerCase();\n      if (lowercase == 'false') {\n        return false;\n      }\n      if (lowercase == 'true') {\n        return true;\n      }\n    }\n    return def;\n  }\n\n  /**\n   * @param {!Object} json\n   * @return {?string}\n   */\n  discoverProductId_(json) {\n    // Must have type `Product`.\n    if (!this.checkType_.checkValue(json['@type'], ['Product'])) {\n      return null;\n    }\n    return /** @type {?string} */ (this.singleValue_(json, 'productID'));\n  }\n\n  /**\n   * @param {!Object} json\n   * @param {string} name\n   * @return {?Array}\n   */\n  valueArray_(json, name) {\n    const value = json[name];\n    if (value == null || value === '') {\n      return null;\n    }\n    return Array.isArray(value) ? value : [value];\n  }\n\n  /**\n   * @param {!Object} json\n   * @param {string} name\n   * @return {*}\n   */\n  singleValue_(json, name) {\n    const valueArray = this.valueArray_(json, name);\n    const value = valueArray && valueArray[0];\n    return value == null || value === '' ? null : value;\n  }\n}\n\nclass MicrodataParser {\n  /**\n   * @param {!Doc} doc\n   */\n  constructor(doc) {\n    /** @private @const {!Doc} */\n    this.doc_ = doc;\n    /** @private {?boolean} */\n    this.access_ = null;\n    /** @private {?string} */\n    this.productId_ = null;\n    /** @private @const @function */\n    this.checkType_ = new TypeChecker();\n  }\n\n  /**\n   * Returns false if access is restricted, otherwise true\n   * @param {!Element} root An element that is an item of type in ALLOWED_TYPES list\n   * @return {?boolean} locked access\n   * @private\n   */\n  discoverAccess_(root) {\n    const ALREADY_SEEN = 'alreadySeenForAccessInfo';\n    const nodeList = root.querySelectorAll(\"[itemprop='isAccessibleForFree']\");\n    for (let i = 0; nodeList[i]; i++) {\n      const element = nodeList[i];\n      const content = element.getAttribute('content') || element.textContent;\n      if (!content) {\n        continue;\n      }\n      if (this.isValidElement_(element, root, ALREADY_SEEN)) {\n        let accessForFree = null;\n        if (content.toLowerCase() == 'true') {\n          accessForFree = true;\n        } else if (content.toLowerCase() == 'false') {\n          accessForFree = false;\n        }\n        return accessForFree;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Verifies if an element is valid based on the following\n   * - child of an item of one the the ALLOWED_TYPES\n   * - not a child of an item of any other type\n   * - not seen before, marked using the alreadySeen tag\n   * @param {?Element} current the element to be verified\n   * @param {!Element} root the parent to track up to\n   * @param {!string} alreadySeen used to tag already visited nodes\n   * @return {!boolean} valid node\n   * @private\n   */\n  isValidElement_(current, root, alreadySeen) {\n    for (\n      let node = current;\n      node && !node[alreadySeen];\n      node = node.parentNode\n    ) {\n      node[alreadySeen] = true;\n      // document nodes don't have hasAttribute\n      if (node.hasAttribute && node.hasAttribute('itemscope')) {\n        /**{?string} */\n        const type = node.getAttribute('itemtype');\n        return this.checkType_.checkString(type, ALLOWED_TYPES);\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Obtains the product ID that meets the requirements\n   * - child of an item of one of ALLOWED_TYPES\n   * - Not a child of an item of type 'Section'\n   * - child of an item of type 'productID'\n   * @param {!Element} root An element that is an item of an ALLOWED_TYPES\n   * @return {?string} product ID, if found\n   * @private\n   */\n  discoverProductId_(root) {\n    const ALREADY_SEEN = 'alreadySeenForProductInfo';\n    const nodeList = root.querySelectorAll('[itemprop=\"productID\"]');\n    for (let i = 0; nodeList[i]; i++) {\n      const element = nodeList[i];\n      const content = element.getAttribute('content') || element.textContent;\n      const item = element.closest('[itemtype][itemscope]');\n      const type = item.getAttribute('itemtype');\n      if (type.indexOf('http://schema.org/Product') <= -1) {\n        continue;\n      }\n      if (this.isValidElement_(item.parentElement, root, ALREADY_SEEN)) {\n        return content;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Returns PageConfig if available\n   * @return {?PageConfig} PageConfig found so far\n   */\n  getPageConfig_() {\n    let locked = null;\n    if (this.access_ != null) {\n      locked = !this.access_;\n    } else if (this.doc_.isReady()) {\n      // Default to unlocked\n      locked = false;\n    }\n    if (this.productId_ != null && locked != null) {\n      return new PageConfig(this.productId_, locked);\n    }\n    return null;\n  }\n\n  /**\n   * Extracts page config from Microdata in the DOM\n   * @return {?PageConfig} PageConfig found\n   */\n  tryExtractConfig_() {\n    let config = this.getPageConfig_();\n    if (config) {\n      return config;\n    }\n\n    // Grab all the nodes with an itemtype and filter for our allowed types\n    const nodeList = Array.prototype.slice\n      .call(this.doc_.getRootNode().querySelectorAll('[itemscope][itemtype]'))\n      .filter((node) =>\n        this.checkType_.checkString(\n          node.getAttribute('itemtype'),\n          ALLOWED_TYPES\n        )\n      );\n\n    for (let i = 0; nodeList[i] && config == null; i++) {\n      const element = nodeList[i];\n      if (this.access_ == null) {\n        this.access_ = this.discoverAccess_(element);\n      }\n      if (!this.productId_) {\n        this.productId_ = this.discoverProductId_(element);\n      }\n      config = this.getPageConfig_();\n    }\n    return config;\n  }\n\n  /**\n   * @return {?PageConfig}\n   */\n  check() {\n    if (!this.doc_.getBody()) {\n      // Wait until the whole `<head>` is parsed.\n      return null;\n    }\n    return this.tryExtractConfig_();\n  }\n}\n\n/**\n * Returns the value from content attribute of a meta tag with given name.\n *\n * If multiple tags are found, the first value is returned.\n *\n * @param {!Node} rootNode\n * @param {string} name The tag name to look for.\n * @return {?string} attribute value or empty string.\n * @private\n */\nfunction getMetaTag(rootNode, name) {\n  const el = rootNode.querySelector(`meta[name=\"${name}\"]`);\n  if (el) {\n    return el.getAttribute('content');\n  }\n  return null;\n}\n\nexport { Doc, PageConfig, PageConfigResolver };\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Doc} from '../../../third_party/subscriptions-project/config';\nimport {Services} from '../../../src/services';\nimport {dev} from '../../../src/log';\n\n/**\n * Adopts config document to ampdoc.\n * @implements {Doc}\n */\nexport class DocImpl {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @private @const {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @private {!../../../src/service/viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(this.ampdoc_);\n  }\n\n  /** @override */\n  getWin() {\n    return this.ampdoc_.win;\n  }\n\n  /** @override */\n  getRootNode() {\n    return this.ampdoc_.getRootNode();\n  }\n\n  /** @override */\n  getRootElement() {\n    const root = this.ampdoc_.getRootNode();\n    return dev().assertElement(root.documentElement || root.body || root);\n  }\n\n  /** @override */\n  getHead() {\n    return dev().assertElement(this.ampdoc_.getHeadNode());\n  }\n\n  /** @override */\n  getBody() {\n    return this.ampdoc_.isBodyAvailable() ? this.ampdoc_.getBody() : null;\n  }\n\n  /** @override */\n  isReady() {\n    return this.ampdoc_.isReady();\n  }\n\n  /** @override */\n  whenReady() {\n    return this.ampdoc_.whenReady();\n  }\n\n  /** @override */\n  addToFixedLayer(element) {\n    return this.viewport_.addToFixedLayer(element, /* Force Transfer */ true);\n  }\n}\n\n/**\n * @package Visible for testing only.\n * @return {typeof Doc}\n */\nexport function getDocClassForTesting() {\n  return Doc;\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @fileoverview Shared constants. */\n\n/**\n * How long to wait before giving up on an entitlements request.\n * @const\n */\nexport const ENTITLEMENTS_REQUEST_TIMEOUT = 3000;\n\n/**\n * Possible score factors.\n * @const @enum {string}\n */\nexport const SubscriptionsScoreFactor = {\n  // User is known to platform and has a form of payment registered\n  IS_READY_TO_PAY: 'isReadyToPay',\n  // Platform supports the current viewer environment\n  SUPPORTS_VIEWER: 'supportsViewer',\n};\n\n/**\n * All other score factors are ignored if not specified in the publisher\n * config so adding a default here would be meaningless.\n */\nexport const DEFAULT_SCORE_CONFIG = {};\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {dict} from '../../../src/core/types/object';\n\n/** @enum {string} */\nexport const GrantReason = {\n  'SUBSCRIBER': 'SUBSCRIBER',\n  'METERING': 'METERING',\n  'FREE': 'UNLOCKED',\n  'LAA': 'LAA',\n};\n\n/**\n * The constructor arg for an {@link Entitlement}\n *\n * @typedef {{\n *   source: string,\n *   raw: string,\n *   service: string,\n *   granted: boolean,\n *   grantReason: ?GrantReason,\n *   dataObject: ?JsonObject,\n *   decryptedDocumentKey: ?string\n * }} EntitlementConstructorInputDef\n */\n\n/**\n * The single entitlement object.\n */\nexport class Entitlement {\n  /**\n   * @param {string} service\n   * @return {!Entitlement}\n   */\n  static empty(service) {\n    return new Entitlement({\n      source: '',\n      raw: '',\n      service,\n      granted: false,\n    });\n  }\n\n  /**\n   * @param {!EntitlementConstructorInputDef} input\n   */\n  constructor(input) {\n    const {\n      dataObject,\n      decryptedDocumentKey,\n      grantReason = '',\n      granted = false,\n      raw = '',\n      service,\n      source,\n    } = input;\n    /** @const {string} */\n    this.raw = raw;\n    /** @const {string} */\n    this.source = source;\n    /** @type {string} */\n    this.service = service;\n    /** @const {boolean} */\n    this.granted = granted;\n    /** @const {?string} */\n    this.grantReason = grantReason;\n    /** @const {?JsonObject} */\n    this.data = dataObject;\n    /** @const {?string} */\n    this.decryptedDocumentKey = decryptedDocumentKey;\n  }\n\n  /**\n   * Returns json format of entitlements\n   * @return {!JsonObject}\n   */\n  json() {\n    const entitlementJson = dict({\n      'source': this.source,\n      'service': this.service,\n      'granted': this.granted,\n      'grantReason': this.grantReason,\n      'data': this.data,\n    });\n    return entitlementJson;\n  }\n\n  /**\n   * Returns json to be used for pingback.\n   *\n   * @return {!JsonObject}\n   */\n  jsonForPingback() {\n    return /** @type {!JsonObject} */ ({'raw': this.raw, ...this.json()});\n  }\n\n  /**\n   * @param {?JsonObject} json\n   * @param {?string} rawData\n   * @return {!Entitlement}\n   */\n  static parseFromJson(json, rawData = null) {\n    if (!json) {\n      json = dict();\n    }\n    const raw = rawData || JSON.stringify(json);\n    const source = json['source'] || '';\n    const granted = json['granted'] || false;\n    const grantReason = json['grantReason'];\n    const dataObject = json['data'] || null;\n    const decryptedDocumentKey = json['decryptedDocumentKey'] || null;\n    return new Entitlement({\n      source,\n      raw,\n      service: '',\n      granted,\n      grantReason,\n      dataObject,\n      decryptedDocumentKey,\n    });\n  }\n\n  /**\n   * Returns true if the user is a subscriber.\n   * @return {boolean}\n   */\n  isSubscriber() {\n    return this.granted && this.grantReason === GrantReason.SUBSCRIBER;\n  }\n\n  /**\n   * Returns true if the article is free.\n   * @return {boolean}\n   */\n  isFree() {\n    return this.granted && this.grantReason === GrantReason.FREE;\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {user} from '../../../src/log';\n\n/** @const */\nconst TAG = 'amp-subscriptions';\n\n/**\n * Describes metering state for a single publication.\n * @typedef {{\n *   id: string,\n *   attributes: !Array<{\n *     name: string,\n *     timestamp: string,\n *   }>,\n * }}\n */\nlet MeteringStateDef;\n\n/** Handles metering functionality. */\nexport class Metering {\n  /**\n   *\n   * @param {{\n   *   platformKey: string,\n   * }} params\n   */\n  constructor({platformKey}) {\n    /**\n     * Remembers if metering entitlements were fetched\n     * with the current metering state.\n     *\n     * This helps avoid redundant fetches.\n     * @type {boolean}\n     */\n    this.entitlementsWereFetchedWithCurrentMeteringState = false;\n\n    /**\n     * Key for the subscription platform with metering enabled.\n     * @const\n     */\n    this.platformKey = platformKey;\n\n    /**\n     * Metering state for user.\n     * Currently this isn't persisted. It's just saved in memory.\n     * @private\n     */\n    this.meteringStateString_ = '';\n  }\n\n  /**\n   * Saves metering state for a given publication ID.\n   *\n   * @param {!MeteringStateDef} meteringState\n   * @return {!Promise}\n   */\n  saveMeteringState(meteringState) {\n    const meteringStateString = JSON.stringify(meteringState);\n\n    const meteringStateChangedPromise = Promise.resolve(\n      this.meteringStateString_\n    ).then((existingMeteringStateString) => {\n      const changed = meteringStateString !== existingMeteringStateString;\n\n      // Log when an existing metering state is updated.\n      if (existingMeteringStateString && changed) {\n        user().info(\n          TAG,\n          `Meter state changed from ${existingMeteringStateString} to ${meteringStateString}`\n        );\n      }\n\n      return changed;\n    });\n\n    return meteringStateChangedPromise.then((meteringStateChanged) => {\n      if (!meteringStateChanged) {\n        // Bail. Fetching metering entitlements again is redundant,\n        // until the metering state changes.\n        return;\n      }\n\n      this.meteringStateString_ = meteringStateString;\n      this.entitlementsWereFetchedWithCurrentMeteringState = false;\n    });\n  }\n\n  /**\n   * Loads metering state for a given publication ID.\n   *\n   * @return {!Promise<?MeteringStateDef>}\n   */\n  loadMeteringState() {\n    if (!this.meteringStateString_) {\n      return Promise.resolve(null);\n    }\n\n    return Promise.resolve(JSON.parse(this.meteringStateString_));\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {removeItem} from '../types/array';\n\n/**\n * This class helps to manage observers. Observers can be added, removed or\n * fired through and instance of this class.\n * @template TYPE\n */\nexport class Observable {\n  /**\n   * Creates an instance of Observable.\n   */\n  constructor() {\n    /** @type {?Array<function(TYPE)>} */\n    this.handlers_ = null;\n  }\n\n  /**\n   * Adds the observer to this instance.\n   * @param {function(TYPE)} handler Observer's handler.\n   * @return {!UnlistenDef}\n   */\n  add(handler) {\n    if (!this.handlers_) {\n      this.handlers_ = [];\n    }\n    this.handlers_.push(handler);\n    return () => {\n      this.remove(handler);\n    };\n  }\n\n  /**\n   * Removes the observer from this instance.\n   * @param {function(TYPE)} handler Observer's instance.\n   */\n  remove(handler) {\n    if (!this.handlers_) {\n      return;\n    }\n    removeItem(this.handlers_, handler);\n  }\n\n  /**\n   * Removes all observers.\n   */\n  removeAll() {\n    if (!this.handlers_) {\n      return;\n    }\n    this.handlers_.length = 0;\n  }\n\n  /**\n   * Fires an event. All observers are called.\n   * @param {TYPE=} opt_event\n   */\n  fire(opt_event) {\n    if (!this.handlers_) {\n      return;\n    }\n    for (const handler of this.handlers_) {\n      handler(opt_event);\n    }\n  }\n\n  /**\n   * Returns number of handlers. Mostly needed for tests.\n   * @return {number}\n   */\n  getHandlerCount() {\n    return this.handlers_?.length ?? 0;\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {DEFAULT_SCORE_CONFIG, SubscriptionsScoreFactor} from './constants.js';\nimport {Deferred} from '../../../src/core/data-structures/promise';\nimport {Entitlement} from './entitlement';\nimport {Observable} from '../../../src/core/data-structures/observable';\nimport {devAssert, user} from '../../../src/log';\nimport {dict, hasOwn} from '../../../src/core/types/object';\n\n/** @typedef {{platformKey: string, entitlement: (!./entitlement.Entitlement|undefined)}} */\nexport let EntitlementChangeEventDef;\n\n/** @const */\nconst TAG = 'amp-subscriptions';\n\n/**\n * @typedef {{\n *   platform: !./subscription-platform.SubscriptionPlatform,\n *   weight: number,\n * }}\n */\nlet PlatformWeightDef;\n\n/**\n * Manages subscription platforms.\n */\nexport class PlatformStore {\n  /**\n   * @param {!Array<string>} platformKeys\n   * @param {!JsonObject|Object<string, number>} scoreConfig\n   * @param {!./entitlement.Entitlement} fallbackEntitlement\n   * @param {Object<string, !./subscription-platform.SubscriptionPlatform>=} opt_Platforms\n   */\n  constructor(platformKeys, scoreConfig, fallbackEntitlement, opt_Platforms) {\n    /** @private @const {!Object<string, !./subscription-platform.SubscriptionPlatform>} */\n    this.subscriptionPlatforms_ = opt_Platforms || dict();\n\n    /** @private @const {!Array<string>} */\n    this.platformKeys_ = platformKeys;\n\n    /** @private @const {!Object<string, !./entitlement.Entitlement>} */\n    this.entitlements_ = {};\n\n    /**\n     * @private @const\n     * {!Object<string, !Deferred<!./entitlement.Entitlement>>}\n     */\n    this.entitlementDeferredMap_ = {};\n    platformKeys.forEach((platformKey) => {\n      this.entitlementDeferredMap_[platformKey] = new Deferred();\n    });\n\n    /** @private @const {!Observable<!EntitlementChangeEventDef>} */\n    this.onEntitlementResolvedCallbacks_ = new Observable();\n\n    /** @private @const {!Observable<{platformKey: string}>} */\n    this.onPlatformResolvedCallbacks_ = new Observable();\n\n    /** @private {?Deferred} */\n    this.grantStatusPromise_ = null;\n\n    /** @private {?Entitlement} */\n    this.grantStatusEntitlement_ = null;\n\n    /** @private {?Deferred<?Entitlement>} */\n    this.grantStatusEntitlementDeferred_ = null;\n\n    /** @private {?Deferred<!Array<!./entitlement.Entitlement>>} */\n    this.allResolvedDeferred_ = null;\n\n    /** @private {!Array<string>} */\n    this.failedPlatforms_ = [];\n\n    /** @private @const {!./entitlement.Entitlement} */\n    this.fallbackEntitlement_ = fallbackEntitlement;\n\n    /** @private @const {!Object<string, number>} */\n    this.scoreConfig_ = Object.assign(DEFAULT_SCORE_CONFIG, scoreConfig);\n  }\n\n  /**\n   * Resolves a platform in the store\n   * @param {string} platformKey\n   * @param {!./subscription-platform.SubscriptionPlatform} platform\n   */\n  resolvePlatform(platformKey, platform) {\n    this.subscriptionPlatforms_[platformKey] = platform;\n    this.onPlatformResolvedCallbacks_.fire({\n      platformKey,\n    });\n  }\n\n  /**\n   * Reset the platformStore via a factory that returns a\n   * new PlatformStore with the same platforms as this one.\n   * @return {PlatformStore}\n   */\n  resetPlatformStore() {\n    // Reset individual platforms to ensure their UX clears.\n    for (const platformKey in this.subscriptionPlatforms_) {\n      this.subscriptionPlatforms_[platformKey].reset();\n    }\n\n    // Then create new platform store with the newly reset platforms in it.\n    return new PlatformStore(\n      this.platformKeys_,\n      this.scoreConfig_,\n      this.fallbackEntitlement_,\n      this.subscriptionPlatforms_\n    );\n  }\n\n  /**\n   * Resets a given platform.\n   * @param {string} platformKey\n   */\n  resetPlatform(platformKey) {\n    // Remove platform's entitlement.\n    delete this.entitlements_[platformKey];\n\n    // Reset platform's deferred entitlement map entry.\n    this.entitlementDeferredMap_[platformKey] = new Deferred();\n\n    // Reset platform's UX.\n    this.subscriptionPlatforms_[platformKey].reset();\n\n    // Reset summary promises.\n    this.grantStatusPromise_ = null;\n    this.grantStatusEntitlement_ = null;\n    this.grantStatusEntitlementDeferred_ = null;\n    this.allResolvedDeferred_ = null;\n  }\n\n  /**\n   * Calls a callback for when a platform is resolved.\n   * @param {string} platformKey\n   * @param {!Function} callback\n   */\n  onPlatformResolves(platformKey, callback) {\n    const platform = this.subscriptionPlatforms_[platformKey];\n    if (platform) {\n      callback(platform);\n    } else {\n      this.onPlatformResolvedCallbacks_.add((e) => {\n        if (e.platformKey === platformKey) {\n          callback(this.getPlatform(platformKey));\n        }\n      });\n    }\n  }\n\n  /**\n   * Returns the platform for the given id\n   * @param {string} platformKey\n   * @return {!./subscription-platform.SubscriptionPlatform}\n   */\n  getPlatform(platformKey) {\n    const platform = this.subscriptionPlatforms_[platformKey];\n    devAssert(platform, `Platform for id ${platformKey} is not resolved`);\n    return platform;\n  }\n\n  /**\n   * Returns the local platform\n   * @private\n   * @return {!./subscription-platform.SubscriptionPlatform}\n   */\n  getLocalPlatform_() {\n    const localPlatform =\n      /** @type {!./subscription-platform.SubscriptionPlatform} */\n      (this.getPlatform('local'));\n    return localPlatform;\n  }\n\n  /**\n   * Returns all available platforms.\n   *\n   * @return {!Array<!./subscription-platform.SubscriptionPlatform>}\n   */\n  getAvailablePlatforms() {\n    const platforms = [];\n    for (const platformKey in this.subscriptionPlatforms_) {\n      const subscriptionPlatform = this.subscriptionPlatforms_[platformKey];\n      platforms.push(subscriptionPlatform);\n    }\n    return platforms;\n  }\n\n  /**\n   * This registers a callback which is called whenever a platform key is resolved\n   * with an entitlement.\n   * @param {function(!EntitlementChangeEventDef):void} callback\n   */\n  onChange(callback) {\n    this.onEntitlementResolvedCallbacks_.add(callback);\n  }\n\n  /**\n   * This resolves the entitlement to a platformKey\n   * @param {string} platformKey\n   * @param {!./entitlement.Entitlement} entitlement\n   */\n  resolveEntitlement(platformKey, entitlement) {\n    if (entitlement) {\n      entitlement.service = platformKey;\n    }\n    this.entitlements_[platformKey] = entitlement;\n    const deferred = this.entitlementDeferredMap_[platformKey];\n    if (deferred) {\n      deferred.resolve(entitlement);\n    }\n    // Remove this platformKey from the failed platforms list\n    if (this.failedPlatforms_.indexOf(platformKey) !== -1) {\n      this.failedPlatforms_.splice(\n        this.failedPlatforms_.indexOf(platformKey),\n        1\n      );\n    }\n    // Call all onChange callbacks.\n    if (entitlement.granted) {\n      this.saveGrantEntitlement_(entitlement);\n    }\n    this.onEntitlementResolvedCallbacks_.fire({\n      platformKey,\n      entitlement,\n    });\n  }\n\n  /**\n   * Returns entitlement for a platform.\n   * @param {string} platformKey\n   * @return {!./entitlement.Entitlement} entitlement\n   */\n  getResolvedEntitlementFor(platformKey) {\n    devAssert(\n      this.entitlements_[platformKey],\n      `Platform ${platformKey} has not yet resolved with entitlements`\n    );\n    return this.entitlements_[platformKey];\n  }\n\n  /**\n   * Returns entitlement for a platform once it's resolved.\n   * @param {string} platformKey\n   * @return {!Promise<!./entitlement.Entitlement>} entitlement\n   */\n  getEntitlementPromiseFor(platformKey) {\n    devAssert(\n      this.entitlementDeferredMap_[platformKey],\n      `Platform ${platformKey} is not declared`\n    );\n    return this.entitlementDeferredMap_[platformKey].promise;\n  }\n\n  /**\n   * Get scoreFactor states for each platform\n   * @return {!Promise<!JsonObject>}\n   *\n   * return value looks somethinglike this\n   * {\n   *   'subscribe.google.com': {\n   *     isReadyToPay: 1,\n   *     supportsViewer: 1,\n   *   },\n   *   local: {\n   *     isReadyToPay: 0,\n   *     supportsViewer: 0,\n   *   },\n   * }\n   */\n  getScoreFactorStates() {\n    const states = dict({});\n    return Promise.all(\n      this.platformKeys_.map((platformId) => {\n        states[platformId] = dict();\n        return Promise.all(\n          Object.values(SubscriptionsScoreFactor).map((scoreFactor) =>\n            this.getScoreFactorPromiseFor_(platformId, scoreFactor).then(\n              (factorValue) => {\n                states[platformId][scoreFactor] = factorValue;\n              }\n            )\n          )\n        );\n      })\n    ).then(() => states);\n  }\n\n  /**\n   * Return a score factor for a platform once it's resolved\n   * @param {string} platformKey\n   * @param {string} scoreFactor\n   * @return {!Promise<number>}\n   * @private\n   */\n  getScoreFactorPromiseFor_(platformKey, scoreFactor) {\n    // Make sure the platform is ready\n    return this.getEntitlementPromiseFor(platformKey).then(() => {\n      return this.subscriptionPlatforms_[platformKey].getSupportedScoreFactor(\n        scoreFactor\n      );\n    });\n  }\n\n  /**\n   * @return {!Promise<boolean>}\n   */\n  getGrantStatus() {\n    if (this.grantStatusPromise_ !== null) {\n      return this.grantStatusPromise_.promise;\n    }\n\n    this.grantStatusPromise_ = new Deferred();\n\n    // Check if current entitlements unblock the reader\n    for (const key in this.entitlements_) {\n      const entitlement = this.entitlements_[key];\n      if (entitlement.granted) {\n        this.saveGrantEntitlement_(entitlement);\n        this.grantStatusPromise_.resolve(true);\n      }\n    }\n\n    if (this.areAllPlatformsResolved_()) {\n      // Resolve with null if none of the entitlements unblock the reader\n      this.grantStatusPromise_.resolve(false);\n    } else {\n      // Listen if any upcoming entitlements unblock the reader\n      this.onChange((e) => {\n        const {entitlement} = e;\n        if (entitlement.granted) {\n          this.grantStatusPromise_.resolve(true);\n        } else if (this.areAllPlatformsResolved_()) {\n          this.grantStatusPromise_.resolve(false);\n        }\n      });\n    }\n\n    return this.grantStatusPromise_.promise;\n  }\n\n  /**\n   * Checks and saves the entitlement for grant status\n   * @param {!Entitlement} entitlement\n   * @private\n   */\n  saveGrantEntitlement_(entitlement) {\n    // The entitlement will be stored if either it is the first one to grant\n    // or the new one has full subscription but the last one didn't.\n    if (\n      (!this.grantStatusEntitlement_ && entitlement.granted) ||\n      (this.grantStatusEntitlement_ &&\n        !this.grantStatusEntitlement_.isSubscriber() &&\n        entitlement.isSubscriber())\n    ) {\n      this.grantStatusEntitlement_ = entitlement;\n    }\n  }\n\n  /**\n   * Returns the entitlement which unlocked the document\n   * @return {!Promise<?Entitlement>}\n   */\n  getGrantEntitlement() {\n    // Define when grant entitlement promise can resolve.\n    const canResolveImmediately = () =>\n      this.grantStatusEntitlement_ &&\n      (this.grantStatusEntitlement_.isSubscriber() ||\n        this.grantStatusEntitlement_.isFree());\n    const canResolve = () =>\n      canResolveImmediately() || this.areAllPlatformsResolved_();\n\n    // Cache deferred.\n    if (this.grantStatusEntitlementDeferred_) {\n      return this.grantStatusEntitlementDeferred_.promise;\n    }\n    this.grantStatusEntitlementDeferred_ = new Deferred();\n\n    // Resolve when possible.\n    if (canResolve()) {\n      this.grantStatusEntitlementDeferred_.resolve(\n        this.grantStatusEntitlement_\n      );\n    } else {\n      this.onEntitlementResolvedCallbacks_.add(() => {\n        // Grant entitlement only if subscriber\n        if (canResolve()) {\n          this.grantStatusEntitlementDeferred_.resolve(\n            this.grantStatusEntitlement_\n          );\n        }\n      });\n    }\n\n    return this.grantStatusEntitlementDeferred_.promise;\n  }\n\n  /**\n   * Clears the grant status\n   */\n  reset() {\n    this.grantStatusPromise_ = null;\n  }\n\n  /**\n   * Returns entitlements when all platforms are done fetching them.\n   * @return {!Promise<!Array<!./entitlement.Entitlement>>}\n   */\n  getAllPlatformsEntitlements() {\n    // Cache deferred.\n    if (this.allResolvedDeferred_) {\n      return this.allResolvedDeferred_.promise;\n    }\n    this.allResolvedDeferred_ = new Deferred();\n\n    // Resolve when possible.\n    if (this.areAllPlatformsResolved_()) {\n      // Resolve with null if none of the entitlements unblock the reader\n      this.allResolvedDeferred_.resolve(\n        this.getAvailablePlatformsEntitlements_()\n      );\n    } else {\n      // Listen if any upcoming entitlements unblock the reader\n      this.onChange(() => {\n        if (this.areAllPlatformsResolved_()) {\n          this.allResolvedDeferred_.resolve(\n            this.getAvailablePlatformsEntitlements_()\n          );\n        }\n      });\n    }\n\n    return this.allResolvedDeferred_.promise;\n  }\n\n  /**\n   * Returns entitlements for resolved platforms.\n   * @private\n   * @return {!Array<!./entitlement.Entitlement>}\n   */\n  getAvailablePlatformsEntitlements_() {\n    const entitlements = [];\n    for (const platform in this.entitlements_) {\n      if (hasOwn(this.entitlements_, platform)) {\n        entitlements.push(this.entitlements_[platform]);\n      }\n    }\n    return entitlements;\n  }\n\n  /**\n   * Returns platform after all platforms fetch entitlements.\n   * @return {!Promise<!./subscription-platform.SubscriptionPlatform>}\n   */\n  selectPlatform() {\n    return this.getAllPlatformsEntitlements().then(() => {\n      // TODO(@prateekbh): explain why sometimes a quick resolve is possible vs\n      // waiting for all entitlement.\n      return this.selectApplicablePlatform_();\n    });\n  }\n\n  /**\n   * Returns the number of entitlements resolved\n   * @return {boolean}\n   * @private\n   */\n  areAllPlatformsResolved_() {\n    const entitlementsResolved = Object.keys(this.entitlements_).length;\n    return entitlementsResolved === this.platformKeys_.length;\n  }\n\n  /**\n   * Calculates weight to add/remove based on getSupportedScoreFactor()\n   * @param {string} factorName\n   * @param {!./subscription-platform.SubscriptionPlatform} platform\n   * @return {number}\n   * @private\n   */\n  getSupportedFactorWeight_(factorName, platform) {\n    const factorValue = platform.getSupportedScoreFactor(factorName);\n    if (typeof factorValue !== 'number') {\n      return 0;\n    }\n    return (\n      this.scoreConfig_[factorName] * Math.min(1, Math.max(-1, factorValue))\n    );\n  }\n\n  /**\n   * Returns most qualified platform. Qualification of a platform is based on\n   * weight. Every platform starts with weight 0 and evaluated against\n   * the following parameters,\n   * - base weight\n   * - weight factors the platform supports multiplied by score in the config\n   *\n   * In the end candidate with max weight is selected. However if candidate's\n   * weight is equal to local platform, then local platform is selected.\n   * @return {!./subscription-platform.SubscriptionPlatform}\n   * @private\n   */\n  selectApplicablePlatform_() {\n    devAssert(\n      this.areAllPlatformsResolved_(),\n      'All platforms are not resolved yet'\n    );\n\n    // Prefer platforms that granted with subscriptions or free articles.\n    const availablePlatforms = this.getAvailablePlatforms();\n    while (availablePlatforms.length) {\n      const platform = availablePlatforms.pop();\n      const entitlement = this.getResolvedEntitlementFor(\n        platform.getPlatformKey()\n      );\n      if (entitlement.isSubscriber() || entitlement.isFree()) {\n        return platform;\n      }\n    }\n\n    return this.rankPlatformsByWeight_(this.getAllPlatformWeights_());\n  }\n\n  /**\n   * Calculate and return weights for all platforms\n   * @return {!Array<!PlatformWeightDef>}\n   * @private\n   */\n  getAllPlatformWeights_() {\n    // Get weights for all of the platforms.\n    return this.getAvailablePlatforms().map((platform) => {\n      return {\n        platform,\n        weight: this.calculatePlatformWeight_(platform),\n      };\n    });\n  }\n\n  /**\n   * Calculate platform weight\n   * @param {!./subscription-platform.SubscriptionPlatform} platform\n   * @return {number}\n   * @private\n   */\n  calculatePlatformWeight_(platform) {\n    const factorWeights = [0]; // reduce always needs something to work with\n\n    // Start with base score\n    const weight = platform.getBaseScore();\n\n    // Iterate score factors checking platform support\n    for (const factor in this.scoreConfig_) {\n      if (hasOwn(this.scoreConfig_, factor)) {\n        factorWeights.push(this.getSupportedFactorWeight_(factor, platform));\n      }\n    }\n\n    return (\n      weight +\n      factorWeights.reduce((a, b) => {\n        return a + b;\n      })\n    );\n  }\n\n  /**\n   * @param {!Array<!PlatformWeightDef>} platformWeights\n   * @return {!./subscription-platform.SubscriptionPlatform}\n   * @private\n   */\n  rankPlatformsByWeight_(platformWeights) {\n    const localPlatform = this.getLocalPlatform_();\n    platformWeights.sort((platform1, platform2) => {\n      // Force local platform to win ties\n      if (\n        platform2.weight === platform1.weight &&\n        platform1.platform === localPlatform\n      ) {\n        return -1;\n      }\n      return platform2.weight - platform1.weight;\n    });\n    return platformWeights[0].platform;\n  }\n\n  /**\n   * Returns most qualified platform for the specified factor.\n   *\n   * In the end candidate with max weight is selected. However if candidate's\n   * weight is equal to local platform, then local platform is selected.\n   *\n   * @param {string} factor\n   * @return {!./subscription-platform.SubscriptionPlatform}\n   * @private\n   */\n  selectApplicablePlatformForFactor_(factor) {\n    const platformWeights = this.getAvailablePlatforms().map((platform) => {\n      const factorValue = platform.getSupportedScoreFactor(factor);\n      const weight = typeof factorValue === 'number' ? factorValue : 0;\n      return {platform, weight};\n    });\n    return this.rankPlatformsByWeight_(platformWeights);\n  }\n\n  /**\n   * Records a platform failure\n   * logs error if all platforms have failed\n   * uses fallback if there is one.\n   * @param {string} platformKey\n   */\n  reportPlatformFailureAndFallback(platformKey) {\n    if (\n      platformKey === this.getLocalPlatform_().getPlatformKey() &&\n      this.fallbackEntitlement_\n    ) {\n      this.resolveEntitlement(\n        this.getLocalPlatform_().getPlatformKey(),\n        this.fallbackEntitlement_\n      );\n      user().warn(\n        TAG,\n        'Local platform has failed to resolve,  ' +\n          'using fallback entitlement.'\n      );\n    } else if (this.failedPlatforms_.indexOf(platformKey) === -1) {\n      const entitlement = Entitlement.empty(platformKey);\n      this.resolveEntitlement(platformKey, entitlement);\n      this.failedPlatforms_.push(platformKey);\n    }\n  }\n\n  /**\n   * Evaluates platforms and select the one to be selected for login.\n   * @return {!./subscription-platform.SubscriptionPlatform}\n   */\n  selectPlatformForLogin() {\n    return this.selectApplicablePlatformForFactor_(\n      SubscriptionsScoreFactor.SUPPORTS_VIEWER\n    );\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {childElementByTag} from '../../../src/core/dom/query';\nimport {createElementWithAttributes} from '../../../src/dom';\nimport {dict} from '../../../src/core/types/object';\n\nconst CSS_PREFIX = 'i-amphtml-subs';\n\nexport class Renderer {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const @private */\n    this.ampdoc_ = ampdoc;\n\n    /** @const @private {!../../../src/service/mutator-interface.MutatorInterface} */\n    this.mutator_ = Services.mutatorForDoc(ampdoc);\n\n    // Initial state is \"unknown\".\n    this.setGrantState(null);\n    this.getBodyElement_().classList.add(`${CSS_PREFIX}-ready`);\n\n    // Check and add progress bar.\n    this.addLoadingBar();\n  }\n\n  /**\n   * @return {!Element}\n   * @private\n   */\n  getBodyElement_() {\n    return this.ampdoc_.getBody();\n  }\n\n  /**\n   * @param {string} type\n   * @param {?boolean} state\n   * @private\n   */\n  setState_(type, state) {\n    this.mutator_.mutateElement(this.ampdoc_.getBody(), () => {\n      this.getBodyElement_().classList.toggle(\n        `${CSS_PREFIX}-${type}-unk`,\n        state === null\n      );\n      this.getBodyElement_().classList.toggle(\n        `${CSS_PREFIX}-${type}-yes`,\n        state === true\n      );\n      this.getBodyElement_().classList.toggle(\n        `${CSS_PREFIX}-${type}-no`,\n        state === false\n      );\n    });\n  }\n\n  /**\n   * Adds a loading bar.\n   *\n   * @return {!Promise}\n   */\n  addLoadingBar() {\n    return this.ampdoc_.whenReady().then(() => {\n      const body = this.ampdoc_.getBody();\n      if (!body.querySelector('[subscriptions-section=loading]')) {\n        const element = createElementWithAttributes(\n          this.ampdoc_.win.document,\n          'div',\n          dict({\n            'class': 'i-amphtml-subs-progress',\n            'subscriptions-section': 'loading',\n          })\n        );\n        // The loading indicator will be either inserted right before the\n        // `<footer>` node or appended as the last child.\n        body.insertBefore(element, childElementByTag(body, 'footer'));\n      }\n    });\n  }\n\n  /**\n   * @param {string} type\n   * @param {boolean} state\n   * @private\n   */\n  toggleState_(type, state) {\n    this.mutator_.mutateElement(this.ampdoc_.getBody(), () => {\n      this.getBodyElement_().classList.toggle(`${CSS_PREFIX}-${type}`, state);\n    });\n  }\n\n  /**\n   * @param {?boolean} state\n   */\n  setGrantState(state) {\n    this.setState_('grant', state);\n  }\n\n  /**\n   * @param {boolean} loading\n   */\n  toggleLoading(loading) {\n    this.toggleState_('loading', loading);\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {PageConfig as PageConfigInterface} from '../../../third_party/subscriptions-project/config';\n\nexport class ServiceAdapter {\n  /**\n   * @param {./amp-subscriptions.SubscriptionService} subscriptionService\n   */\n  constructor(subscriptionService) {\n    this.subscriptionService_ = subscriptionService;\n  }\n\n  /**\n   * Returns the analytics service for subscriptions.\n   * @return {!./analytics.SubscriptionAnalytics}\n   */\n  getAnalytics() {\n    return this.subscriptionService_.getAnalytics();\n  }\n\n  /**\n   * Returns the singleton Dialog instance\n   * @return {!./dialog.Dialog}\n   */\n  getDialog() {\n    return this.subscriptionService_.getDialog();\n  }\n\n  /**\n   * Returns the encrypted document key for the specified service.\n   * @param {string} platformKey\n   * @return {?string}\n   */\n  getEncryptedDocumentKey(platformKey) {\n    return this.subscriptionService_.getEncryptedDocumentKey(platformKey);\n  }\n\n  /**\n   * Returns the page config.\n   * @return {!PageConfigInterface}\n   */\n  getPageConfig() {\n    return this.subscriptionService_.getPageConfig();\n  }\n\n  /**\n   * Returns the reader ID for the specified service.\n   * @param {string} platformKey\n   * @return {!Promise<string>}\n   */\n  getReaderId(platformKey) {\n    return this.subscriptionService_.getReaderId(platformKey);\n  }\n\n  /**\n   * gets Score factors for all platforms\n   * @return {!Promise<!JsonObject>}\n   */\n  getScoreFactorStates() {\n    return this.subscriptionService_.getScoreFactorStates();\n  }\n\n  /**\n   * Delegates actions to local platform.\n   * @param {string} action\n   * @param {?string} sourceId\n   * @return {!Promise<boolean>}\n   */\n  delegateActionToLocal(action, sourceId) {\n    return this.delegateActionToService(action, 'local', sourceId);\n  }\n\n  /**\n   * Delegates actions to a given service.\n   * @param {string} action\n   * @param {string} platformKey\n   * @param {?string} sourceId\n   * @return {!Promise<boolean>}\n   */\n  delegateActionToService(action, platformKey, sourceId) {\n    return this.subscriptionService_.delegateActionToService(\n      action,\n      platformKey,\n      sourceId\n    );\n  }\n\n  /**\n   * Delegate UI decoration to another service.\n   * @param {!Element} element\n   * @param {string} platformKey\n   * @param {string} action\n   * @param {?JsonObject} options\n   */\n  decorateServiceAction(element, platformKey, action, options) {\n    this.subscriptionService_.decorateServiceAction(\n      element,\n      platformKey,\n      action,\n      options\n    );\n  }\n\n  /**\n   * Reauthorize platforms\n   */\n  resetPlatforms() {\n    this.subscriptionService_.resetPlatforms();\n  }\n\n  /**\n   * Returns login platform based on platform selection\n   *\n   * @return {!./subscription-platform.SubscriptionPlatform}\n   */\n  selectPlatformForLogin() {\n    return this.subscriptionService_.selectPlatformForLogin();\n  }\n\n  /**\n   * Loads metering state.\n   * @return {!Promise<?./metering-store.MeteringStateDef>}\n   */\n  loadMeteringState() {\n    if (!this.subscriptionService_.metering_) {\n      return Promise.resolve(null);\n    }\n\n    return this.subscriptionService_.metering_.loadMeteringState();\n  }\n\n  /**\n   * Saves metering state.\n   * @param {!./metering-store.MeteringStateDef} meteringState\n   * @return {!Promise}\n   */\n  saveMeteringState(meteringState) {\n    if (!this.subscriptionService_.metering_) {\n      return Promise.resolve();\n    }\n\n    return this.subscriptionService_.metering_.saveMeteringState(meteringState);\n  }\n\n  /**\n   * Remembers metering entitlements were fetched\n   * with the current metering state.\n   *\n   * This helps avoid redundant fetches.\n   */\n  rememberMeteringEntitlementsWereFetched() {\n    if (!this.subscriptionService_.metering_) {\n      return;\n    }\n\n    this.subscriptionService_.metering_.entitlementsWereFetchedWithCurrentMeteringState = true;\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {bytesToString, stringToBytes, utf8Decode, utf8Encode} from './bytes';\n\n/**\n * Character mapping from base64url to base64.\n * @const {!Object<string, string>}\n */\nconst base64UrlDecodeSubs = {'-': '+', '_': '/', '.': '='};\n\n/**\n * Character mapping from base64 to base64url.\n * @const {!Object<string, string>}\n */\nconst base64UrlEncodeSubs = {'+': '-', '/': '_', '=': '.'};\n\n/**\n * Converts a string which is in base64url encoding into a Uint8Array\n * containing the decoded value.\n * @param {string} str\n * @return {!Uint8Array}\n */\nexport function base64UrlDecodeToBytes(str) {\n  const encoded = atob(str.replace(/[-_.]/g, (ch) => base64UrlDecodeSubs[ch]));\n  return stringToBytes(encoded);\n}\n\n/**\n * Converts a string which is in base64 encoding into a Uint8Array\n * containing the decoded value.\n * @param {string} str\n * @return {!Uint8Array}\n */\nexport function base64DecodeToBytes(str) {\n  return stringToBytes(atob(str));\n}\n\n/**\n * Converts a bytes array into base64url encoded string.\n * base64url is defined in RFC 4648. It is sometimes referred to as \"web safe\".\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nexport function base64UrlEncodeFromBytes(bytes) {\n  const str = bytesToString(bytes);\n  return btoa(str).replace(/[+/=]/g, (ch) => base64UrlEncodeSubs[ch]);\n}\n\n/**\n * Converts a string into base64url encoded string.\n * base64url is defined in RFC 4648. It is sometimes referred to as \"web safe\".\n * @param {string} str\n * @return {string}\n */\nexport function base64UrlEncodeFromString(str) {\n  const bytes = utf8Encode(str);\n  return base64UrlEncodeFromBytes(bytes);\n}\n\n/**\n * Decode a base64url encoded string by `base64UrlEncodeFromString`\n * @param {string} str\n * @return {string}\n */\nexport function base64UrlDecodeFromString(str) {\n  const bytes = base64UrlDecodeToBytes(str);\n  return utf8Decode(bytes);\n}\n\n/**\n * Converts a bytes array into base64 encoded string.\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nexport function base64EncodeFromBytes(bytes) {\n  return btoa(bytesToString(bytes));\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  base64DecodeToBytes,\n  base64UrlDecodeToBytes,\n} from '../../../src/core/types/string/base64';\nimport {stringToBytes, utf8Decode} from '../../../src/core/types/string/bytes';\nimport {tryParseJson} from '../../../src/core/types/object/json';\n\n/**\n * @typedef {{\n *   header: (?JsonObject|undefined),\n *   payload: (?JsonObject|undefined),\n *   verifiable: string,\n *   sig: string,\n * }}\n */\nlet JwtTokenInternalDef;\n\n/**\n * Converts a text in PEM format into a binary array buffer.\n * @param {string} pem\n * @return {!Uint8Array}\n * @visibleForTesting\n */\nexport function pemToBytes(pem) {\n  const key = pem\n    .trim()\n    // Remove pem prefix, e.g. \"----BEGIN PUBLIC KEY----\".\n    .replace(/^-+BEGIN[^-]*-+/, '')\n    // Remove pem suffix, e.g. \"----END PUBLIC KEY----\".\n    .replace(/-+END[^-]*-+$/, '')\n    // Remove line breaks.\n    .replace(/[\\r\\n]/g, '')\n    // Remove surrounding whitespace.\n    .trim();\n  return base64DecodeToBytes(key);\n}\n\n/**\n * Provides helper methods to decode and verify JWT tokens.\n */\nexport class JwtHelper {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /**\n     * Might be `null` if the platform does not support Crypto Subtle.\n     * @const @private {?webCrypto.SubtleCrypto}\n     */\n    this.subtle_ =\n      (win.crypto && (win.crypto.subtle || win.crypto.webkitSubtle)) || null;\n  }\n\n  /**\n   * Decodes JWT token and returns its payload.\n   * @param {string} encodedToken\n   * @return {?JsonObject|undefined}\n   */\n  decode(encodedToken) {\n    return this.decodeInternal_(encodedToken).payload;\n  }\n\n  /**\n   * Whether the signature-verification supported on this platform.\n   * @return {boolean}\n   */\n  isVerificationSupported() {\n    return !!this.subtle_;\n  }\n\n  /**\n   * Decodes HWT token and verifies its signature.\n   * @param {string} encodedToken\n   * @param {!Promise<string>} pemPromise\n   * @return {!Promise<!JsonObject>}\n   */\n  decodeAndVerify(encodedToken, pemPromise) {\n    if (!this.subtle_) {\n      throw new Error('Crypto is not supported on this platform');\n    }\n    const decodedPromise = new Promise((resolve) =>\n      resolve(this.decodeInternal_(encodedToken))\n    );\n    return decodedPromise.then((decoded) => {\n      const alg = decoded.header['alg'];\n      if (!alg || alg != 'RS256') {\n        // TODO(dvoytenko@): Support other RS* algos.\n        throw new Error('Only alg=RS256 is supported');\n      }\n      return this.importKey_(pemPromise)\n        .then((key) => {\n          const sig = base64UrlDecodeToBytes(decoded.sig);\n          return this.subtle_.verify(\n            /* options */ {name: 'RSASSA-PKCS1-v1_5'},\n            key,\n            sig,\n            stringToBytes(decoded.verifiable)\n          );\n        })\n        .then((isValid) => {\n          if (isValid) {\n            return decoded.payload;\n          }\n          throw new Error('Signature verification failed');\n        });\n    });\n  }\n\n  /**\n   * @param {string} encodedToken\n   * @return {!JwtTokenInternalDef}\n   * @private\n   */\n  decodeInternal_(encodedToken) {\n    /**\n     * See https://jwt.io/introduction/\n     */\n    function invalidToken() {\n      throw new Error(`Invalid token: \"${encodedToken}\"`);\n    }\n\n    // Encoded token has three parts: header.payload.sig\n    // Note! The padding is not allowed by JWT spec:\n    // http://self-issued.info/docs/draft-goland-json-web-token-00.html#rfc.section.5\n    const parts = encodedToken.split('.');\n    if (parts.length != 3) {\n      invalidToken();\n    }\n    const headerUtf8Bytes = base64UrlDecodeToBytes(parts[0]);\n    const payloadUtf8Bytes = base64UrlDecodeToBytes(parts[1]);\n    return {\n      header: tryParseJson(utf8Decode(headerUtf8Bytes), invalidToken),\n      payload: tryParseJson(utf8Decode(payloadUtf8Bytes), invalidToken),\n      verifiable: `${parts[0]}.${parts[1]}`,\n      sig: parts[2],\n    };\n  }\n\n  /**\n   * @param {!Promise<string>} pemPromise\n   * @return {!Promise<!webCrypto.CryptoKey>}\n   */\n  importKey_(pemPromise) {\n    return pemPromise.then((pem) => {\n      return this.subtle_.importKey(\n        /* format */ 'spki',\n        pemToBytes(pem),\n        /* algo options */ {\n          name: 'RSASSA-PKCS1-v1_5',\n          hash: {name: 'SHA-256'},\n        },\n        /* extractable */ false,\n        /* uses */ ['verify']\n      );\n    });\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {map} from '../types/object';\n\n/**\n * @template T\n */\nexport class LruCache {\n  /**\n   * @param {number} capacity\n   */\n  constructor(capacity) {\n    /** @private @const {number} */\n    this.capacity_ = capacity;\n\n    /** @private {number} */\n    this.size_ = 0;\n\n    /**\n     * An incrementing counter to define the last access.\n     * @private {number}\n     */\n    this.access_ = 0;\n\n    /** @private {!Object<(number|string), {payload: T, access: number}>} */\n    this.cache_ = map();\n  }\n\n  /**\n   * Returns whether key is cached.\n   *\n   * @param {number|string} key\n   * @return {boolean}\n   */\n  has(key) {\n    return !!this.cache_[key];\n  }\n\n  /**\n   * @param {number|string} key\n   * @return {T} The cached payload.\n   */\n  get(key) {\n    const cacheable = this.cache_[key];\n    if (cacheable) {\n      cacheable.access = ++this.access_;\n      return cacheable.payload;\n    }\n    return undefined;\n  }\n\n  /**\n   * @param {number|string} key\n   * @param {T} payload The payload to cache.\n   */\n  put(key, payload) {\n    if (!this.has(key)) {\n      this.size_++;\n    }\n    this.cache_[key] = {payload, access: this.access_};\n    this.evict_();\n  }\n\n  /**\n   * Evicts the oldest cache entry, if we've exceeded capacity.\n   */\n  evict_() {\n    if (this.size_ <= this.capacity_) {\n      return;\n    }\n\n    const cache = this.cache_;\n    let oldest = this.access_ + 1;\n    let oldestKey;\n    for (const key in cache) {\n      const {access} = cache[key];\n      if (access < oldest) {\n        oldest = access;\n        oldestKey = key;\n      }\n    }\n\n    if (oldestKey !== undefined) {\n      delete cache[oldestKey];\n      this.size_--;\n    }\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {LruCache} from './core/data-structures/lru-cache';\nimport {dict, hasOwn} from './core/types/object';\nimport {endsWith} from './core/types/string';\nimport {getMode} from './mode';\nimport {isArray} from './core/types';\nimport {parseQueryString} from './core/types/string/url';\nimport {urls} from './config';\nimport {userAssert} from './log';\n\n/**\n * @type {!JsonObject}\n */\nconst SERVING_TYPE_PREFIX = dict({\n  // No viewer\n  'c': true,\n  // In viewer\n  'v': true,\n  // Ad landing page\n  'a': true,\n  // Ad\n  'ad': true,\n});\n\n/**\n * Cached a-tag to avoid memory allocation during URL parsing.\n * @type {HTMLAnchorElement}\n */\nlet a;\n\n/**\n * We cached all parsed URLs. As of now there are no use cases\n * of AMP docs that would ever parse an actual large number of URLs,\n * but we often parse the same one over and over again.\n * @type {LruCache}\n */\nlet cache;\n\n/** @private @const Matches amp_js_* parameters in query string. */\nconst AMP_JS_PARAMS_REGEX = /[?&]amp_js[^&]*/;\n\n/** @private @const Matches amp_gsa parameters in query string. */\nconst AMP_GSA_PARAMS_REGEX = /[?&]amp_gsa[^&]*/;\n\n/** @private @const Matches amp_r parameters in query string. */\nconst AMP_R_PARAMS_REGEX = /[?&]amp_r[^&]*/;\n\n/** @private @const Matches amp_kit parameters in query string. */\nconst AMP_KIT_PARAMS_REGEX = /[?&]amp_kit[^&]*/;\n\n/** @private @const Matches usqp parameters from goog experiment in query string. */\nconst GOOGLE_EXPERIMENT_PARAMS_REGEX = /[?&]usqp[^&]*/;\n\nconst INVALID_PROTOCOLS = [\n  /*eslint no-script-url: 0*/ 'javascript:',\n  /*eslint no-script-url: 0*/ 'data:',\n  /*eslint no-script-url: 0*/ 'vbscript:',\n];\n\n/** @const {string} */\nexport const SOURCE_ORIGIN_PARAM = '__amp_source_origin';\n\n/**\n * Returns the correct origin for a given window.\n * @param {!Window} win\n * @return {string} origin\n */\nexport function getWinOrigin(win) {\n  return win.origin || parseUrlDeprecated(win.location.href).origin;\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {string} url\n * @param {boolean=} opt_nocache\n *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n * @return {!Location}\n */\nexport function parseUrlDeprecated(url, opt_nocache) {\n  if (!a) {\n    a = /** @type {!HTMLAnchorElement} */ (self.document.createElement('a'));\n    cache = IS_ESM\n      ? null\n      : self.__AMP_URL_CACHE || (self.__AMP_URL_CACHE = new LruCache(100));\n  }\n\n  return parseUrlWithA(a, url, IS_ESM || opt_nocache ? null : cache);\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {!HTMLAnchorElement} a\n * @param {string} url\n * @param {LruCache=} opt_cache\n *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n * @return {!Location}\n * @restricted\n */\nexport function parseUrlWithA(a, url, opt_cache) {\n  if (IS_ESM) {\n    a.href = '';\n    return /** @type {?} */ (new URL(url, a.href));\n  }\n\n  if (opt_cache && opt_cache.has(url)) {\n    return opt_cache.get(url);\n  }\n\n  a.href = url;\n\n  // IE11 doesn't provide full URL components when parsing relative URLs.\n  // Assigning to itself again does the trick #3449.\n  if (!a.protocol) {\n    a.href = a.href;\n  }\n\n  const info = /** @type {!Location} */ ({\n    href: a.href,\n    protocol: a.protocol,\n    host: a.host,\n    hostname: a.hostname,\n    port: a.port == '0' ? '' : a.port,\n    pathname: a.pathname,\n    search: a.search,\n    hash: a.hash,\n    origin: null, // Set below.\n  });\n\n  // Some IE11 specific polyfills.\n  // 1) IE11 strips out the leading '/' in the pathname.\n  if (info.pathname[0] !== '/') {\n    info.pathname = '/' + info.pathname;\n  }\n\n  // 2) For URLs with implicit ports, IE11 parses to default ports while\n  // other browsers leave the port field empty.\n  if (\n    (info.protocol == 'http:' && info.port == 80) ||\n    (info.protocol == 'https:' && info.port == 443)\n  ) {\n    info.port = '';\n    info.host = info.hostname;\n  }\n\n  // For data URI a.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n  let origin;\n  if (a.origin && a.origin != 'null') {\n    origin = a.origin;\n  } else if (info.protocol == 'data:' || !info.host) {\n    origin = info.href;\n  } else {\n    origin = info.protocol + '//' + info.host;\n  }\n  info.origin = origin;\n\n  // Freeze during testing to avoid accidental mutation.\n  const frozen = getMode().test && Object.freeze ? Object.freeze(info) : info;\n\n  if (opt_cache) {\n    opt_cache.put(url, frozen);\n  }\n\n  return frozen;\n}\n\n/**\n * Appends the string just before the fragment part (or optionally\n * to the front of the query string) of the URL.\n * @param {string} url\n * @param {string} paramString\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function appendEncodedParamStringToUrl(\n  url,\n  paramString,\n  opt_addToFront\n) {\n  if (!paramString) {\n    return url;\n  }\n  const mainAndFragment = url.split('#', 2);\n  const mainAndQuery = mainAndFragment[0].split('?', 2);\n\n  let newUrl =\n    mainAndQuery[0] +\n    (mainAndQuery[1]\n      ? opt_addToFront\n        ? `?${paramString}&${mainAndQuery[1]}`\n        : `?${mainAndQuery[1]}&${paramString}`\n      : `?${paramString}`);\n  newUrl += mainAndFragment[1] ? `#${mainAndFragment[1]}` : '';\n  return newUrl;\n}\n/**\n * Appends a query string field and value to a url. `key` and `value`\n * will be ran through `encodeURIComponent` before appending.\n * @param {string} url\n * @param {string} key\n * @param {string} value\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function addParamToUrl(url, key, value, opt_addToFront) {\n  const field = `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;\n  return appendEncodedParamStringToUrl(url, field, opt_addToFront);\n}\n\n/**\n * Appends query string fields and values to a url. The `params` objects'\n * `key`s and `value`s will be transformed into query string keys/values.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addParamsToUrl(url, params) {\n  return appendEncodedParamStringToUrl(url, serializeQueryString(params));\n}\n\n/**\n * Append query string fields and values to a url, only if the key does not\n * exist in current query string.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addMissingParamsToUrl(url, params) {\n  const location = parseUrlDeprecated(url);\n  const existingParams = parseQueryString(location.search);\n  const paramsToAdd = dict({});\n  const keys = Object.keys(params);\n  for (let i = 0; i < keys.length; i++) {\n    if (!hasOwn(existingParams, keys[i])) {\n      paramsToAdd[keys[i]] = params[keys[i]];\n    }\n  }\n  return addParamsToUrl(url, paramsToAdd);\n}\n\n/**\n * Serializes the passed parameter map into a query string with both keys\n * and values encoded.\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function serializeQueryString(params) {\n  const s = [];\n  for (const k in params) {\n    const v = params[k];\n    if (v == null) {\n      continue;\n    } else if (isArray(v)) {\n      for (let i = 0; i < v.length; i++) {\n        const sv = /** @type {string} */ (v[i]);\n        s.push(`${encodeURIComponent(k)}=${encodeURIComponent(sv)}`);\n      }\n    } else {\n      const sv = /** @type {string} */ (v);\n      s.push(`${encodeURIComponent(k)}=${encodeURIComponent(sv)}`);\n    }\n  }\n  return s.join('&');\n}\n\n/**\n * Returns `true` if the URL is secure: either HTTPS or localhost (for testing).\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isSecureUrlDeprecated(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return (\n    url.protocol == 'https:' ||\n    url.hostname == 'localhost' ||\n    url.hostname == '127.0.0.1' ||\n    endsWith(url.hostname, '.localhost')\n  );\n}\n\n/**\n * Asserts that a given url is HTTPS or protocol relative. It's a user-level\n * assert.\n *\n * Provides an exception for localhost.\n *\n * @param {?string|undefined} urlString\n * @param {!Element|string} elementContext Element where the url was found.\n * @param {string=} sourceName Used for error messages.\n * @return {string}\n */\nexport function assertHttpsUrl(\n  urlString,\n  elementContext,\n  sourceName = 'source'\n) {\n  userAssert(\n    urlString != null,\n    '%s %s must be available',\n    elementContext,\n    sourceName\n  );\n  // (erwinm, #4560): type cast necessary until #4560 is fixed.\n  const theUrlString = /** @type {string} */ (urlString);\n  userAssert(\n    isSecureUrlDeprecated(theUrlString) || /^(\\/\\/)/.test(theUrlString),\n    '%s %s must start with ' +\n      '\"https://\" or \"//\" or be relative and served from ' +\n      'either https or from localhost. Invalid value: %s',\n    elementContext,\n    sourceName,\n    theUrlString\n  );\n  return theUrlString;\n}\n\n/**\n * Asserts that a given url is an absolute HTTP or HTTPS URL.\n * @param {string} urlString\n * @return {string}\n */\nexport function assertAbsoluteHttpOrHttpsUrl(urlString) {\n  userAssert(\n    /^https?\\:/i.test(urlString),\n    'URL must start with \"http://\" or \"https://\". Invalid value: %s',\n    urlString\n  );\n  return parseUrlDeprecated(urlString).href;\n}\n\n/**\n * Returns the URL without fragment. If URL doesn't contain fragment, the same\n * string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function removeFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return url;\n  }\n  return url.substring(0, index);\n}\n\n/**\n * Returns the fragment from the URL. If the URL doesn't contain fragment,\n * the empty string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function getFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return '';\n  }\n  return url.substring(index);\n}\n\n/**\n * Returns whether the URL has the origin of a proxy.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isProxyOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return urls.cdnProxyRegex.test(url.origin);\n}\n\n/**\n * @param {string} uri\n * @return {boolean}\n */\nexport function isAmpScriptUri(uri) {\n  return uri.startsWith('amp-script:');\n}\n\n/**\n * For proxy-origin URLs, returns the serving type. Otherwise, returns null.\n * E.g., 'https://amp-com.cdn.ampproject.org/a/s/amp.com/amp_document.html'\n * returns 'a'.\n * @param {string|!Location} url URL of an AMP document.\n * @return {?string}\n */\nexport function getProxyServingType(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  if (!isProxyOrigin(url)) {\n    return null;\n  }\n  const path = url.pathname.split('/', 2);\n  return path[1];\n}\n\n/**\n * Returns whether the URL origin is localhost.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isLocalhostOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return urls.localhostRegex.test(url.origin);\n}\n\n/**\n * Returns whether the URL has valid protocol.\n * Deep link protocol is valid, but not javascript etc.\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isProtocolValid(url) {\n  if (!url) {\n    return true;\n  }\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return !INVALID_PROTOCOLS.includes(url.protocol);\n}\n\n/**\n * Returns a URL without AMP JS parameters.\n * @param {string} url\n * @return {string}\n */\nexport function removeAmpJsParamsFromUrl(url) {\n  const parsed = parseUrlDeprecated(url);\n  const search = removeAmpJsParamsFromSearch(parsed.search);\n  return parsed.origin + parsed.pathname + search + parsed.hash;\n}\n\n/**\n * Returns a URL without a query string.\n * @param {string} url\n * @return {string}\n */\nexport function removeSearch(url) {\n  const index = url.indexOf('?');\n  if (index == -1) {\n    return url;\n  }\n  const fragment = getFragment(url);\n  return url.substring(0, index) + fragment;\n}\n\n/**\n * Removes parameters that start with amp js parameter pattern and returns the\n * new search string.\n * @param {string} urlSearch\n * @return {string}\n */\nfunction removeAmpJsParamsFromSearch(urlSearch) {\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const search = urlSearch\n    .replace(AMP_JS_PARAMS_REGEX, '')\n    .replace(AMP_GSA_PARAMS_REGEX, '')\n    .replace(AMP_R_PARAMS_REGEX, '')\n    .replace(AMP_KIT_PARAMS_REGEX, '')\n    .replace(GOOGLE_EXPERIMENT_PARAMS_REGEX, '')\n    .replace(/^[?&]/, ''); // Removes first ? or &.\n  return search ? '?' + search : '';\n}\n\n/**\n * Removes parameters with param name and returns the new search string.\n * @param {string} urlSearch\n * @param {string} paramName\n * @return {string}\n */\nexport function removeParamsFromSearch(urlSearch, paramName) {\n  // TODO: reuse the function in removeAmpJsParamsFromSearch. Accept paramNames\n  // as an array.\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const paramRegex = new RegExp(`[?&]${paramName}=[^&]*`, 'g');\n  const search = urlSearch.replace(paramRegex, '').replace(/^[?&]/, '');\n  return search ? '?' + search : '';\n}\n\n/**\n * Returns the source URL of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string}\n */\nexport function getSourceUrl(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n\n  // Not a proxy URL - return the URL itself.\n  if (!isProxyOrigin(url)) {\n    return url.href;\n  }\n\n  // A proxy URL.\n  // Example path that is being matched here.\n  // https://cdn.ampproject.org/c/s/www.origin.com/foo/\n  // The /s/ is optional and signals a secure origin.\n  const path = url.pathname.split('/');\n  const prefix = path[1];\n  userAssert(\n    SERVING_TYPE_PREFIX[prefix],\n    'Unknown path prefix in url %s',\n    url.href\n  );\n  const domainOrHttpsSignal = path[2];\n  const origin =\n    domainOrHttpsSignal == 's'\n      ? 'https://' + decodeURIComponent(path[3])\n      : 'http://' + decodeURIComponent(domainOrHttpsSignal);\n  // Sanity test that what we found looks like a domain.\n  userAssert(origin.indexOf('.') > 0, 'Expected a . in origin %s', origin);\n  path.splice(1, domainOrHttpsSignal == 's' ? 3 : 2);\n  return (\n    origin +\n    path.join('/') +\n    removeAmpJsParamsFromSearch(url.search) +\n    (url.hash || '')\n  );\n}\n\n/**\n * Returns the source origin of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string} The source origin of the URL.\n */\nexport function getSourceOrigin(url) {\n  return parseUrlDeprecated(getSourceUrl(url)).origin;\n}\n\n/**\n * Returns absolute URL resolved based on the relative URL and the base.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n */\nexport function resolveRelativeUrl(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n  if (IS_ESM || typeof URL == 'function') {\n    return new URL(relativeUrlString, baseUrl.href).toString();\n  }\n  return resolveRelativeUrlFallback_(relativeUrlString, baseUrl);\n}\n\n/**\n * Fallback for URL resolver when URL class is not available.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n * @private @visibleForTesting\n */\nexport function resolveRelativeUrlFallback_(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n  relativeUrlString = relativeUrlString.replace(/\\\\/g, '/');\n  const relativeUrl = parseUrlDeprecated(relativeUrlString);\n\n  // Absolute URL.\n  if (relativeUrlString.toLowerCase().startsWith(relativeUrl.protocol)) {\n    return relativeUrl.href;\n  }\n\n  // Protocol-relative URL.\n  if (relativeUrlString.startsWith('//')) {\n    return baseUrl.protocol + relativeUrlString;\n  }\n\n  // Absolute path.\n  if (relativeUrlString.startsWith('/')) {\n    return baseUrl.origin + relativeUrlString;\n  }\n\n  // Relative path.\n  return (\n    baseUrl.origin +\n    baseUrl.pathname.replace(/\\/[^/]*$/, '/') +\n    relativeUrlString\n  );\n}\n\n/**\n * Add \"__amp_source_origin\" query parameter to the URL.\n * @param {!Window} win\n * @param {string} url\n * @return {string}\n */\nexport function getCorsUrl(win, url) {\n  checkCorsUrl(url);\n  const sourceOrigin = getSourceOrigin(win.location.href);\n  return addParamToUrl(url, SOURCE_ORIGIN_PARAM, sourceOrigin);\n}\n\n/**\n * Checks if the url has __amp_source_origin and throws if it does.\n * @param {string} url\n */\nexport function checkCorsUrl(url) {\n  const parsedUrl = parseUrlDeprecated(url);\n  const query = parseQueryString(parsedUrl.search);\n  userAssert(\n    !(SOURCE_ORIGIN_PARAM in query),\n    'Source origin is not allowed in %s',\n    url\n  );\n}\n\n/**\n * Adds the path to the given url.\n *\n * @param {!Location} url\n * @param {string} path\n * @return {string}\n */\nexport function appendPathToUrl(url, path) {\n  const pathname = url.pathname.replace(/\\/?$/, '/') + path.replace(/^\\//, '');\n  return url.origin + pathname + url.search + url.hash;\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether addEventListener supports options or only takes capture as a boolean\n * @type {boolean|undefined}\n * @visibleForTesting\n */\nlet optsSupported;\n\n/**\n * Whether addEventListener supports options or only takes passive as a boolean\n * @type {boolean|undefined}\n */\nlet passiveSupported;\n\n/**\n * Options supported by addEventListener\n * @typedef AddEventListenerOptsDef\n * @property {undefined|boolean} [capture]\n * @property {undefined|boolean} [once]\n * @property {undefined|boolean} [passive]\n * @property {undefined|!AbortSignal} [signal]\n * }}\n */\nlet AddEventListenerOptsDef;\n\n/**\n * Listens for the specified event on the element.\n *\n * Do not use this directly. This method is implemented as a shared\n * dependency. Use `listen()` in either `event-helper` or `3p-frame-messaging`,\n * depending on your use case.\n *\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {!AddEventListenerOptsDef=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function internalListenImplementation(\n  element,\n  eventType,\n  listener,\n  opt_evtListenerOpts\n) {\n  let localElement = element;\n  let localListener = listener;\n  /** @type {?function(!Event)} */\n  let wrapped = (event) => {\n    try {\n      return localListener(event);\n    } catch (e) {\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR?.(e);\n      throw e;\n    }\n  };\n  const optsSupported = detectEvtListenerOptsSupport();\n  const capture = !!opt_evtListenerOpts?.capture;\n\n  localElement.addEventListener(\n    eventType,\n    wrapped,\n    optsSupported ? opt_evtListenerOpts : capture\n  );\n  return () => {\n    localElement?.removeEventListener(\n      eventType,\n      wrapped,\n      optsSupported ? opt_evtListenerOpts : capture\n    );\n    // Ensure these are GC'd\n    localListener = null;\n    localElement = null;\n    wrapped = null;\n  };\n}\n\n/**\n * Tests whether the browser supports options as an argument of addEventListener\n * or not.\n *\n * @return {boolean}\n */\nexport function detectEvtListenerOptsSupport() {\n  // Only run the test once\n  if (optsSupported !== undefined) {\n    return optsSupported;\n  }\n\n  optsSupported = false;\n  try {\n    // Test whether browser supports EventListenerOptions or not\n    const options = {\n      get capture() {\n        optsSupported = true;\n      },\n    };\n    self.addEventListener('test-options', null, options);\n    self.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return optsSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports options or not.\n */\nexport function resetEvtListenerOptsSupportForTesting() {\n  optsSupported = undefined;\n}\n\n/**\n * Return boolean. if listener option is supported, return `true`.\n * if not supported, return `false`\n * @param {!Window} win\n * @return {boolean}\n */\nexport function supportsPassiveEventListener(win) {\n  if (passiveSupported !== undefined) {\n    return passiveSupported;\n  }\n\n  passiveSupported = false;\n  try {\n    const options = {\n      get passive() {\n        // This function will be called when the browser\n        // attempts to access the passive property.\n        passiveSupported = true;\n        return false;\n      },\n    };\n\n    win.addEventListener('test-options', null, options);\n    win.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return passiveSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports passive options or not.\n */\nexport function resetPassiveSupportedForTesting() {\n  passiveSupported = undefined;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalListenImplementation} from './core/dom/event-helper-listen';\nimport {lastChildElement} from './core/dom/query';\nimport {user} from './log';\n\n/** @const {string}  */\nconst LOAD_FAILURE_PREFIX = 'Failed to load:';\n\n/** @const {string} */\nexport const MEDIA_LOAD_FAILURE_SRC_PROPERTY = '__AMP_MEDIA_LOAD_FAILURE_SRC';\n\n/**\n * Returns a CustomEvent with a given type and detail; supports fallback for IE.\n * @param {!Window} win\n * @param {string} type\n * @param {!JsonObject|string|undefined|null} detail\n * @param {EventInit=} opt_eventInit\n * @return {!Event}\n */\nexport function createCustomEvent(win, type, detail, opt_eventInit) {\n  const eventInit = /** @type {!CustomEventInit} */ ({detail});\n  Object.assign(eventInit, opt_eventInit);\n  // win.CustomEvent is a function on Edge, Chrome, FF, Safari but\n  // is an object on IE 11.\n  if (IS_ESM || typeof win.CustomEvent == 'function') {\n    return new win.CustomEvent(type, eventInit);\n  } else {\n    // Deprecated fallback for IE.\n    const e = win.document.createEvent('CustomEvent');\n    e.initCustomEvent(\n      type,\n      !!eventInit.bubbles,\n      !!eventInit.cancelable,\n      detail\n    );\n    return e;\n  }\n}\n\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listen(element, eventType, listener, opt_evtListenerOpts) {\n  return internalListenImplementation(\n    element,\n    eventType,\n    listener,\n    opt_evtListenerOpts\n  );\n}\n\n/**\n * Returns the data property of an event with the correct type.\n * @param {!Event|{data: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getData(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.data);\n}\n\n/**\n * Returns the detail property of an event with the correct type.\n * @param {!Event|{detail: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getDetail(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.detail);\n}\n\n/**\n * Listens for the specified event on the element and removes the listener\n * as soon as event has been received.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listenOnce(element, eventType, listener, opt_evtListenerOpts) {\n  let localListener = listener;\n  const unlisten = internalListenImplementation(\n    element,\n    eventType,\n    (event) => {\n      try {\n        localListener(event);\n      } finally {\n        // Ensure listener is GC'd\n        localListener = null;\n        unlisten();\n      }\n    },\n    opt_evtListenerOpts\n  );\n  return unlisten;\n}\n\n/**\n * Returns  a promise that will resolve as soon as the specified event has\n * fired on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {Object=} opt_evtListenerOpts\n * @param {function(!UnlistenDef)=} opt_cancel An optional function that, when\n *     provided, will be called with the unlistener. This gives the caller\n *     access to the unlistener, so it may be called manually when necessary.\n * @return {!Promise<!Event>}\n */\nexport function listenOncePromise(\n  element,\n  eventType,\n  opt_evtListenerOpts,\n  opt_cancel\n) {\n  let unlisten;\n  const eventPromise = new Promise((resolve) => {\n    unlisten = listenOnce(element, eventType, resolve, opt_evtListenerOpts);\n  });\n  eventPromise.then(unlisten, unlisten);\n  if (opt_cancel) {\n    opt_cancel(unlisten);\n  }\n  return eventPromise;\n}\n\n/**\n * Whether the specified element/window has been loaded already.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nexport function isLoaded(eleOrWindow) {\n  return !!(\n    eleOrWindow.complete ||\n    eleOrWindow.readyState == 'complete' ||\n    (isHTMLMediaElement(eleOrWindow) && eleOrWindow.readyState > 0) ||\n    // If the passed in thing is a Window, infer loaded state from\n    //\n    (eleOrWindow.document && eleOrWindow.document.readyState == 'complete')\n  );\n}\n\n/**\n * Returns a promise that will resolve or fail based on the eleOrWindow's 'load'\n * and 'error' events. Optionally this method takes a timeout, which will reject\n * the promise if the resource has not loaded by then.\n * @param {T} eleOrWindow Supports both Elements and as a special case Windows.\n * @return {!Promise<T>}\n * @template T\n */\nexport function loadPromise(eleOrWindow) {\n  let unlistenLoad;\n  let unlistenError;\n  if (isLoaded(eleOrWindow)) {\n    return Promise.resolve(eleOrWindow);\n  }\n  const isMediaElement = isHTMLMediaElement(eleOrWindow);\n  if (\n    isMediaElement &&\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] === eleOrWindow.currentSrc\n  ) {\n    return Promise.reject(eleOrWindow);\n  }\n  const loadingPromise = new Promise((resolve, reject) => {\n    // Listen once since IE 5/6/7 fire the onload event continuously for\n    // animated GIFs.\n    if (isMediaElement) {\n      // The following event can be triggered by the media or one of its\n      // sources. Using capture is required as the media events do not bubble.\n      unlistenLoad = listenOnce(eleOrWindow, 'loadedmetadata', resolve, {\n        capture: true,\n      });\n    } else {\n      unlistenLoad = listenOnce(eleOrWindow, 'load', resolve);\n    }\n    // Don't unlisten on error for Windows.\n    if (!eleOrWindow.tagName) {\n      return;\n    }\n    let errorTarget = eleOrWindow;\n    // If the media element has no `src`, it will try to load the sources in\n    // document order. If the last source errors, then the media element\n    // loading errored.\n    if (isMediaElement && !eleOrWindow.hasAttribute('src')) {\n      errorTarget = lastChildElement(\n        eleOrWindow,\n        (child) => child.tagName === 'SOURCE'\n      );\n      if (!errorTarget) {\n        return reject(new Error('Media has no source.'));\n      }\n    }\n    unlistenError = listenOnce(errorTarget, 'error', reject);\n  });\n\n  return loadingPromise.then(\n    () => {\n      if (unlistenError) {\n        unlistenError();\n      }\n      return eleOrWindow;\n    },\n    () => {\n      if (unlistenLoad) {\n        unlistenLoad();\n      }\n      failedToLoad(eleOrWindow);\n    }\n  );\n}\n\n/**\n * Emit error on load failure.\n * @param {!Element|!Window} eleOrWindow Supports both Elements and as a special\n *     case Windows.\n */\nfunction failedToLoad(eleOrWindow) {\n  // Mark the element as errored since some elements - like HTMLMediaElement\n  // using HTMLSourceElement - do not provide any synchronous way to verify if\n  // they already errored, even though the error event was already dispatched.\n  if (isHTMLMediaElement(eleOrWindow)) {\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] =\n      eleOrWindow.currentSrc || true;\n  }\n\n  // Report failed loads as user errors so that they automatically go\n  // into the \"document error\" bucket.\n  let target = eleOrWindow;\n  if (target && target.src) {\n    target = target.src;\n  }\n  throw user().createError(LOAD_FAILURE_PREFIX, target);\n}\n\n/**\n * Returns true if the parameter is a HTMLMediaElement.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nfunction isHTMLMediaElement(eleOrWindow) {\n  return eleOrWindow.tagName === 'AUDIO' || eleOrWindow.tagName === 'VIDEO';\n}\n\n/**\n * Returns true if this error message is was created for a load error.\n * @param {string} message An error message\n * @return {boolean}\n */\nexport function isLoadErrorMessage(message) {\n  return message.indexOf(LOAD_FAILURE_PREFIX) != -1;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {dev, userAssert} from '../../../src/log';\nimport {dict} from '../../../src/core/types/object';\nimport {getData, listen} from '../../../src/event-helper';\nimport {getMode} from '../../../src/mode';\nimport {openWindowDialog} from '../../../src/dom';\nimport {parseUrlDeprecated} from '../../../src/url';\nimport {urls} from '../../../src/config';\n\n/** @const */\nconst TAG = 'amp-access-login';\n\n/** @const {!RegExp} */\nconst RETURN_URL_REGEX = new RegExp('RETURN_URL');\n\n/**\n * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string|!Promise<string>} urlOrPromise\n * @return {!WebLoginDialog|!ViewerLoginDialog}\n */\nexport function createLoginDialog(ampdoc, urlOrPromise) {\n  const viewer = Services.viewerForDoc(ampdoc);\n  const overrideDialog = parseInt(ampdoc.getParam('dialog'), 10);\n  if (overrideDialog) {\n    return new ViewerLoginDialog(viewer, urlOrPromise);\n  }\n  return new WebLoginDialog(ampdoc.win, viewer, urlOrPromise);\n}\n\n/**\n * Opens the login dialog for the specified URL. If the login dialog succeeds,\n * the returned promised is resolved with the dialog's response. Otherwise, the\n * returned promise is rejected.\n * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string|!Promise<string>} urlOrPromise\n * @return {!Promise<string>}\n */\nexport function openLoginDialog(ampdoc, urlOrPromise) {\n  return createLoginDialog(ampdoc, urlOrPromise).open();\n}\n\n/**\n * Gets the final login URL with all the performed replacements.\n * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string|!Promise<string>} urlOrPromise\n * @return {!Promise<string>}\n */\nexport function getLoginUrl(ampdoc, urlOrPromise) {\n  return createLoginDialog(ampdoc, urlOrPromise).getLoginUrl();\n}\n\n/**\n * The implementation of the Login Dialog delegated via Viewer.\n */\nclass ViewerLoginDialog {\n  /**\n   * @param {!../../../src/service/viewer-interface.ViewerInterface} viewer\n   * @param {string|!Promise<string>} urlOrPromise\n   */\n  constructor(viewer, urlOrPromise) {\n    /** @const {!../../../src/service/viewer-interface.ViewerInterface} */\n    this.viewer = viewer;\n\n    /** @const {string|!Promise<string>} */\n    this.urlOrPromise = urlOrPromise;\n  }\n\n  /**\n   * @return {!Promise<string>}\n   */\n  getLoginUrl() {\n    let urlPromise;\n    if (typeof this.urlOrPromise == 'string') {\n      urlPromise = Promise.resolve(this.urlOrPromise);\n    } else {\n      urlPromise = this.urlOrPromise;\n    }\n    return urlPromise.then((url) => {\n      return buildLoginUrl(url, 'RETURN_URL');\n    });\n  }\n\n  /**\n   * Opens the dialog. Returns the promise that will yield with the dialog's\n   * result or will be rejected if dialog fails. The dialog's result is\n   * typically a hash string from the return URL.\n   * @return {!Promise<string>}\n   */\n  open() {\n    return this.getLoginUrl().then((loginUrl) => {\n      dev().fine(TAG, 'Open viewer dialog: ', loginUrl);\n      return this.viewer.sendMessageAwaitResponse(\n        'openDialog',\n        dict({\n          'url': loginUrl,\n        })\n      );\n    });\n  }\n}\n\n/**\n * Web-based implementation of the Login Dialog.\n * @visibleForTesting\n */\nexport class WebLoginDialog {\n  /**\n   * @param {!Window} win\n   * @param {!../../../src/service/viewer-interface.ViewerInterface} viewer\n   * @param {string|!Promise<string>} urlOrPromise\n   */\n  constructor(win, viewer, urlOrPromise) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @const {!../../../src/service/viewer-interface.ViewerInterface} */\n    this.viewer = viewer;\n\n    /** @const {string|!Promise<string>} */\n    this.urlOrPromise = urlOrPromise;\n\n    /** @private {?function(?string)} */\n    this.resolve_ = null;\n\n    /** @private {?function(*)} */\n    this.reject_ = null;\n\n    /** @private {?Window} */\n    this.dialog_ = null;\n\n    /** @private {?Promise} */\n    this.dialogReadyPromise_ = null;\n\n    /** @private {?number} */\n    this.heartbeatInterval_ = null;\n\n    /** @private {?UnlistenDef} */\n    this.messageUnlisten_ = null;\n  }\n\n  /**\n   * Opens the dialog. Returns the promise that will yield with the dialog's\n   * result or will be rejected if dialog fails.\n   * @return {!Promise<string>}\n   */\n  open() {\n    userAssert(!this.resolve_, 'Dialog already opened');\n    return new Promise((resolve, reject) => {\n      this.resolve_ = resolve;\n      this.reject_ = reject;\n      // Must always be called synchronously.\n      this.openInternal_();\n    }).then(\n      (result) => {\n        this.cleanup_();\n        return result;\n      },\n      (error) => {\n        this.cleanup_();\n        throw error;\n      }\n    );\n  }\n\n  /** @private */\n  cleanup_() {\n    this.resolve_ = null;\n    this.reject_ = null;\n\n    if (this.dialog_) {\n      try {\n        this.dialog_.close();\n      } catch (e) {\n        // Ignore.\n      }\n      this.dialog_ = null;\n    }\n\n    if (this.heartbeatInterval_) {\n      this.win.clearInterval(this.heartbeatInterval_);\n      this.heartbeatInterval_ = null;\n    }\n\n    if (this.messageUnlisten_) {\n      this.messageUnlisten_();\n      this.messageUnlisten_ = null;\n    }\n  }\n\n  /**\n   * @return {!Promise<string>}\n   */\n  getLoginUrl() {\n    let urlPromise;\n    if (typeof this.urlOrPromise == 'string') {\n      urlPromise = Promise.resolve(this.urlOrPromise);\n    } else {\n      urlPromise = this.urlOrPromise;\n    }\n    return urlPromise.then((url) => {\n      return buildLoginUrl(url, this.getReturnUrl_());\n    });\n  }\n\n  /** @private */\n  openInternal_() {\n    const {screen} = this.win;\n    const w = Math.floor(Math.min(700, screen.width * 0.9));\n    const h = Math.floor(Math.min(450, screen.height * 0.9));\n    const x = Math.floor((screen.width - w) / 2);\n    const y = Math.floor((screen.height - h) / 2);\n    const sizing = `height=${h},width=${w},left=${x},top=${y}`;\n    const options = `${sizing},resizable=yes,scrollbars=yes`;\n    const returnUrl = this.getReturnUrl_();\n\n    this.dialogReadyPromise_ = null;\n    if (typeof this.urlOrPromise == 'string') {\n      const loginUrl = buildLoginUrl(this.urlOrPromise, returnUrl);\n      dev().fine(TAG, 'Open dialog: ', loginUrl, returnUrl, w, h, x, y);\n      this.dialog_ = openWindowDialog(this.win, loginUrl, '_blank', options);\n      if (this.dialog_) {\n        this.dialogReadyPromise_ = Promise.resolve();\n      }\n    } else {\n      dev().fine(TAG, 'Open dialog: ', 'about:blank', returnUrl, w, h, x, y);\n      this.dialog_ = openWindowDialog(this.win, '', '_blank', options);\n      if (this.dialog_) {\n        this.dialogReadyPromise_ = this.urlOrPromise.then(\n          (url) => {\n            const loginUrl = buildLoginUrl(url, returnUrl);\n            dev().fine(TAG, 'Set dialog url: ', loginUrl);\n            this.dialog_.location.replace(loginUrl);\n          },\n          (error) => {\n            throw new Error('failed to resolve url: ' + error);\n          }\n        );\n      }\n    }\n\n    if (this.dialogReadyPromise_) {\n      this.dialogReadyPromise_.then(\n        () => {\n          this.setupDialog_(returnUrl);\n        },\n        (error) => {\n          this.loginDone_(/* result */ null, error);\n        }\n      );\n    } else {\n      this.loginDone_(/* result */ null, new Error('failed to open dialog'));\n    }\n  }\n\n  /**\n   * @param {string} returnUrl\n   * @private\n   */\n  setupDialog_(returnUrl) {\n    const returnOrigin = parseUrlDeprecated(returnUrl).origin;\n\n    this.heartbeatInterval_ = this.win.setInterval(() => {\n      if (this.dialog_.closed) {\n        this.win.clearInterval(this.heartbeatInterval_);\n        this.heartbeatInterval_ = null;\n        // Give a chance for the result to arrive, but otherwise consider the\n        // responce to be empty.\n        this.win.setTimeout(() => {\n          this.loginDone_('');\n        }, 3000);\n      }\n    }, 500);\n\n    this.messageUnlisten_ = listen(this.win, 'message', (e) => {\n      dev().fine(TAG, 'MESSAGE:', e);\n      if (e.origin != returnOrigin) {\n        return;\n      }\n      if (!getData(e) || getData(e)['sentinel'] != 'amp') {\n        return;\n      }\n      dev().fine(TAG, 'Received message from dialog: ', getData(e));\n      if (getData(e)['type'] == 'result') {\n        if (this.dialog_) {\n          this.dialog_./*OK*/ postMessage(\n            dict({\n              'sentinel': 'amp',\n              'type': 'result-ack',\n            }),\n            returnOrigin\n          );\n        }\n        this.loginDone_(getData(e)['result']);\n      }\n    });\n  }\n\n  /**\n   * @param {?string} result\n   * @param {*=} opt_error\n   * @private\n   */\n  loginDone_(result, opt_error) {\n    if (!this.resolve_) {\n      return;\n    }\n    dev().fine(TAG, 'Login done: ', result, opt_error);\n    if (opt_error) {\n      this.reject_(opt_error);\n    } else {\n      this.resolve_(result);\n    }\n    this.cleanup_();\n  }\n\n  /**\n   * @return {string}\n   * @private\n   */\n  getReturnUrl_() {\n    const currentUrl = this.viewer.getResolvedViewerUrl();\n    let returnUrl;\n    if (getMode().localDev) {\n      const loc = this.win.location;\n      returnUrl =\n        loc.protocol +\n        '//' +\n        loc.host +\n        '/extensions/amp-access/0.1/amp-login-done.html';\n    } else {\n      returnUrl = `${urls.cdn}/v0/amp-login-done-0.1.html`;\n    }\n    return returnUrl + '?url=' + encodeURIComponent(currentUrl);\n  }\n}\n\n/**\n * @param {string} url\n * @param {string} returnUrl\n * @return {string}\n * @private\n */\nfunction buildLoginUrl(url, returnUrl) {\n  // RETURN_URL has to arrive here unreplaced by UrlReplacements for two\n  // reasons: (1) sync replacement and (2) if we need to propagate this\n  // replacement to the viewer.\n  if (RETURN_URL_REGEX.test(url)) {\n    return url.replace(RETURN_URL_REGEX, encodeURIComponent(returnUrl));\n  }\n  return (\n    url +\n    (url.indexOf('?') == -1 ? '?' : '&') +\n    'return=' +\n    encodeURIComponent(returnUrl)\n  );\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ActionStatus} from './analytics';\nimport {assertHttpsUrl} from '../../../src/url';\nimport {dev, userAssert} from '../../../src/log';\nimport {dict} from '../../../src/core/types/object';\nimport {openLoginDialog} from '../../amp-access/0.1/login-dialog';\nimport {parseQueryString} from '../../../src/core/types/string/url';\n\nconst TAG = 'amp-subscriptions';\nconst LOCAL = 'local';\n\n/**\n */\nexport class Actions {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {!./url-builder.UrlBuilder} urlBuilder\n   * @param {!./analytics.SubscriptionAnalytics} analytics\n   * @param {!Object<string, string>} actionMap\n   */\n  constructor(ampdoc, urlBuilder, analytics, actionMap) {\n    // Check that all URLs are valid.\n    for (const k in actionMap) {\n      assertHttpsUrl(actionMap[k], `action ${k}`);\n    }\n\n    /** @private @const {!Object<string, string>} */\n    this.actionsConfig_ = actionMap;\n    /** @private @const {!Object<string, string>} */\n    this.builtActionUrlMap_ = dict();\n    /** @private @const {!./url-builder.UrlBuilder} */\n    this.urlBuilder_ = urlBuilder;\n    /** @private @const {!./analytics.SubscriptionAnalytics} */\n    this.analytics_ = analytics;\n    /** @private {?Promise} */\n    this.actionPromise_ = null;\n    /** @private {number} */\n    this.actionStartTime_ = 0;\n    /** @private @const {function(string):Promise<string>} */\n    this.openPopup_ = openLoginDialog.bind(null, ampdoc);\n\n    // Build all URLs.\n    this.build();\n  }\n\n  /**\n   * @return {?Promise<!Object<string, string>>}\n   */\n  build() {\n    if (Object.keys(this.actionsConfig_).length == 0) {\n      return null;\n    }\n    const promises = [];\n    for (const k in this.actionsConfig_) {\n      promises.push(\n        this.urlBuilder_\n          .buildUrl(this.actionsConfig_[k], /* useAuthData */ true)\n          .then((url) => {\n            this.builtActionUrlMap_[k] = url;\n          })\n      );\n    }\n    return Promise.all(promises).then(() => {\n      return this.builtActionUrlMap_;\n    });\n  }\n\n  /**\n   * @param {string} action\n   * @return {!Promise<string>}\n   */\n  execute(action) {\n    userAssert(\n      this.actionsConfig_[action],\n      'Action URL is not configured: %s',\n      action\n    );\n    // URL should always be available at this time.\n    const url = userAssert(\n      this.builtActionUrlMap_[action],\n      'Action URL is not ready: %s',\n      action\n    );\n    return this.execute_(url, action);\n  }\n\n  /**\n   * @param {string} url\n   * @param {string} action\n   * @return {!Promise}\n   * @private\n   */\n  execute_(url, action) {\n    const now = Date.now();\n\n    // If action is pending, block a new one from starting for 1 second. After\n    // 1 second, however, the new action request will be allowed to proceed,\n    // given that we cannot always determine fully if the previous attempt is\n    // \"stuck\".\n    if (this.actionPromise_ && now - this.actionStartTime_ < 1000) {\n      return this.actionPromise_;\n    }\n\n    dev().fine(TAG, 'Start action: ', url, action);\n\n    this.analytics_.actionEvent(LOCAL, action, ActionStatus.STARTED);\n    const dialogPromise = this.openPopup_(url);\n    const actionPromise = dialogPromise\n      .then((result) => {\n        dev().fine(TAG, 'Action completed: ', action, result);\n        this.actionPromise_ = null;\n        const query = parseQueryString(result);\n        const s = query['success'];\n        const success = s == 'true' || s == 'yes' || s == '1';\n        if (success) {\n          this.analytics_.actionEvent(LOCAL, action, ActionStatus.SUCCESS);\n        } else {\n          this.analytics_.actionEvent(LOCAL, action, ActionStatus.REJECTED);\n        }\n        return success || !s;\n      })\n      .catch((reason) => {\n        dev().fine(TAG, 'Action failed: ', action, reason);\n        this.analytics_.actionEvent(LOCAL, action, ActionStatus.FAILED);\n        if (this.actionPromise_ == actionPromise) {\n          this.actionPromise_ = null;\n        }\n        throw reason;\n      });\n    this.actionPromise_ = actionPromise;\n    this.actionStartTime_ = now;\n    return this.actionPromise_;\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n/** @fileoverview @suppress {checkTypes, suspiciousCode, uselessCode} */\n\n\n\n/* parser generated by jison 0.4.18 */\n/*\n  Returns a Parser object of the following structure:\n\n  Parser: {\n    yy: {}\n  }\n\n  Parser.prototype: {\n    yy: {},\n    trace: function(),\n    symbols_: {associative list: name ==> number},\n    terminals_: {associative list: number ==> name},\n    productions_: [...],\n    performAction: function anonymous(yytext, yyleng, yylineno, yy, yystate, $$, _$),\n    table: [...],\n    defaultActions: {...},\n    parseError: function(str, hash),\n    parse: function(input),\n\n    lexer: {\n        EOF: 1,\n        parseError: function(str, hash),\n        setInput: function(input),\n        input: function(),\n        unput: function(str),\n        more: function(),\n        less: function(n),\n        pastInput: function(),\n        upcomingInput: function(),\n        showPosition: function(),\n        test_match: function(regex_match_array, rule_index),\n        next: function(),\n        lex: function(),\n        begin: function(condition),\n        popState: function(),\n        _currentRules: function(),\n        topState: function(),\n        pushState: function(condition),\n\n        options: {\n            ranges: boolean           (optional: true ==> token location info will include a .range[] member)\n            flex: boolean             (optional: true ==> flex-like lexing behaviour where the rules are tested exhaustively to find the longest match)\n            backtrack_lexer: boolean  (optional: true ==> lexer regexes are tested in order and for each matching regex the action code is invoked; the lexer terminates the scan when a token is returned by the action code)\n        },\n\n        performAction: function(yy, yy_, $avoiding_name_collisions, YY_START),\n        rules: [...],\n        conditions: {associative list: name ==> set},\n    }\n  }\n\n\n  token location info (@$, _$, etc.): {\n    first_line: n,\n    last_line: n,\n    first_column: n,\n    last_column: n,\n    range: [start_number, end_number]       (where the numbers are indexes into the input string, regular zero-based)\n  }\n\n\n  the parseError function receives a 'hash' object with these members for lexer and parser errors: {\n    text:        (matched text)\n    token:       (the produced terminal token, if any)\n    line:        (yylineno)\n  }\n  while parser (grammar) errors will also provide these members, i.e. parser errors deliver a superset of attributes: {\n    loc:         (yylloc)\n    expected:    (string describing the set of expected tokens)\n    recoverable: (boolean: TRUE when the parser has a error recovery rule available for this particular error)\n  }\n*/\nvar parser = (function(){\nvar o=function(k,v,o,l){for(o=o||{},l=k.length;l--;o[k[l]]=v);return o},$V0=[1,3],$V1=[1,4],$V2=[1,18],$V3=[1,19],$V4=[1,14],$V5=[1,15],$V6=[1,16],$V7=[1,17],$V8=[1,21],$V9=[1,22],$Va=[5,6,7,10],$Vb=[5,6,7,10,15,16,17,18,19,20,21],$Vc=[5,6,7,10,15,16,17,18,19,20,21,25,27];\nvar parser = {trace: function trace () { },\nyy: {},\nsymbols_: {\"error\":2,\"result\":3,\"search_condition\":4,\"EOF\":5,\"OR\":6,\"AND\":7,\"NOT\":8,\"(\":9,\")\":10,\"predicate\":11,\"comparison_predicate\":12,\"truthy_predicate\":13,\"scalar_exp\":14,\"EQ\":15,\"DEQ\":16,\"NEQ\":17,\"LT\":18,\"LTE\":19,\"GT\":20,\"GTE\":21,\"atom\":22,\"field_ref\":23,\"literal\":24,\"DOT\":25,\"field_name\":26,\"[\":27,\"string\":28,\"]\":29,\"NAME\":30,\"STRING\":31,\"NUMERIC\":32,\"TRUE\":33,\"FALSE\":34,\"NULL\":35,\"$accept\":0,\"$end\":1},\nterminals_: {2:\"error\",5:\"EOF\",6:\"OR\",7:\"AND\",8:\"NOT\",9:\"(\",10:\")\",15:\"EQ\",16:\"DEQ\",17:\"NEQ\",18:\"LT\",19:\"LTE\",20:\"GT\",21:\"GTE\",25:\"DOT\",27:\"[\",29:\"]\",30:\"NAME\",31:\"STRING\",32:\"NUMERIC\",33:\"TRUE\",34:\"FALSE\",35:\"NULL\"},\nproductions_: [0,[3,2],[4,3],[4,3],[4,2],[4,3],[4,1],[11,1],[11,1],[12,3],[12,3],[12,3],[12,3],[12,3],[12,3],[12,3],[13,1],[14,1],[14,1],[22,1],[23,3],[23,4],[23,1],[26,1],[28,1],[24,1],[24,1],[24,1],[24,1],[24,1]],\nperformAction: function anonymous(yytext, yyleng, yylineno, yy, yystate /* action[1] */, $$ /* vstack */, _$ /* lstack */) {\n/* this == yyval */\n\nvar $0 = $$.length - 1;\nswitch (yystate) {\ncase 1:\nreturn $$[$0-1];\nbreak;\ncase 2:\nthis.$ = $$[$0-2] || $$[$0];\nbreak;\ncase 3:\nthis.$ = $$[$0-2] && $$[$0];\nbreak;\ncase 4:\nthis.$ = !$$[$0];\nbreak;\ncase 5:\nthis.$ = $$[$0-1];\nbreak;\ncase 6: case 7: case 8: case 17: case 18: case 19:\nthis.$ = $$[$0];\nbreak;\ncase 9:\nthis.$ = $$[$0-2] === $$[$0];\nbreak;\ncase 10:\nthrow new Error('\"==\" is not allowed, use \"=\"');\nbreak;\ncase 11:\nthis.$ = $$[$0-2] !== $$[$0];\nbreak;\ncase 12:\nthis.$ = typeof $$[$0-2] == typeof $$[$0] && $$[$0-2] < $$[$0];\nbreak;\ncase 13:\nthis.$ = typeof $$[$0-2] == typeof $$[$0] && $$[$0-2] <= $$[$0];\nbreak;\ncase 14:\nthis.$ = typeof $$[$0-2] == typeof $$[$0] && $$[$0-2] > $$[$0];\nbreak;\ncase 15:\nthis.$ = typeof $$[$0-2] == typeof $$[$0] && $$[$0-2] >= $$[$0];\nbreak;\ncase 16:\nthis.$ = ($$[$0] !== undefined && $$[$0] !== null\n                && $$[$0] !== '' && $$[$0] !== 0 && $$[$0] !== false);\nbreak;\ncase 20:\nthis.$ = Object.prototype.toString.call($$[$0-2]) == '[object Object]' && $$[$0-2].hasOwnProperty($$[$0]) ? $$[$0-2][$$[$0]] : null;\nbreak;\ncase 21:\nthis.$ = Object.prototype.toString.call($$[$0-3]) == '[object Object]' && $$[$0-3].hasOwnProperty($$[$0-1]) ? $$[$0-3][$$[$0-1]] : null;\nbreak;\ncase 22:\nthis.$ = yy[$$[$0]] !== undefined ? yy[$$[$0]] : null;\nbreak;\ncase 23:\nthis.$ = yytext;\nbreak;\ncase 24:\nthis.$ = yytext.substring(1, yytext.length - 1);\nbreak;\ncase 26:\nthis.$ = Number(yytext);\nbreak;\ncase 27:\nthis.$ = true\nbreak;\ncase 28:\nthis.$ = false\nbreak;\ncase 29:\nthis.$ = null\nbreak;\n}\n},\ntable: [{3:1,4:2,8:$V0,9:$V1,11:5,12:6,13:7,14:8,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},{1:[3]},{5:[1,20],6:$V8,7:$V9},{4:23,8:$V0,9:$V1,11:5,12:6,13:7,14:8,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},{4:24,8:$V0,9:$V1,11:5,12:6,13:7,14:8,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},o($Va,[2,6]),o($Va,[2,7]),o($Va,[2,8]),o($Va,[2,16],{15:[1,25],16:[1,26],17:[1,27],18:[1,28],19:[1,29],20:[1,30],21:[1,31]}),o($Vb,[2,17]),o($Vb,[2,18],{25:[1,32],27:[1,33]}),o($Vb,[2,19]),o($Vc,[2,22]),o($Vb,[2,25]),o($Vb,[2,26]),o($Vb,[2,27]),o($Vb,[2,28]),o($Vb,[2,29]),o($Vc,[2,23]),o([5,6,7,10,15,16,17,18,19,20,21,29],[2,24]),{1:[2,1]},{4:34,8:$V0,9:$V1,11:5,12:6,13:7,14:8,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},{4:35,8:$V0,9:$V1,11:5,12:6,13:7,14:8,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},o($Va,[2,4]),{6:$V8,7:$V9,10:[1,36]},{14:37,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},{14:38,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},{14:39,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},{14:40,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},{14:41,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},{14:42,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},{14:43,22:9,23:10,24:11,26:12,28:13,30:$V2,31:$V3,32:$V4,33:$V5,34:$V6,35:$V7},{26:44,30:$V2},{28:45,31:$V3},o([5,6,10],[2,2],{7:$V9}),o($Va,[2,3]),o($Va,[2,5]),o($Va,[2,9]),o($Va,[2,10]),o($Va,[2,11]),o($Va,[2,12]),o($Va,[2,13]),o($Va,[2,14]),o($Va,[2,15]),o($Vc,[2,20]),{29:[1,46]},o($Vc,[2,21])],\ndefaultActions: {20:[2,1]},\nparseError: function parseError (str, hash) {\n    if (hash.recoverable) {\n        this.trace(str);\n    } else {\n        var error = new Error(str);\n        error.hash = hash;\n        throw error;\n    }\n},\nparse: function parse(input) {\n    var self = this, stack = [0], tstack = [], vstack = [null], lstack = [], table = this.table, yytext = '', yylineno = 0, yyleng = 0, recovering = 0, TERROR = 2, EOF = 1;\n    var args = lstack.slice.call(arguments, 1);\n    var lexer = Object.create(this.lexer);\n    var sharedState = { yy: {} };\n    for (var k in this.yy) {\n        if (Object.prototype.hasOwnProperty.call(this.yy, k)) {\n            sharedState.yy[k] = this.yy[k];\n        }\n    }\n    lexer.setInput(input, sharedState.yy);\n    sharedState.yy.lexer = lexer;\n    sharedState.yy.parser = this;\n    if (typeof lexer.yylloc == 'undefined') {\n        lexer.yylloc = {};\n    }\n    var yyloc = lexer.yylloc;\n    lstack.push(yyloc);\n    var ranges = lexer.options && lexer.options.ranges;\n    if (typeof sharedState.yy.parseError === 'function') {\n        this.parseError = sharedState.yy.parseError;\n    } else {\n        this.parseError = Object.getPrototypeOf(this).parseError;\n    }\n    function popStack(n) {\n        stack.length = stack.length - 2 * n;\n        vstack.length = vstack.length - n;\n        lstack.length = lstack.length - n;\n    }\n\n        var lex = function () {\n            var token;\n            token = lexer.lex() || EOF;\n            if (typeof token !== 'number') {\n                token = self.symbols_[token] || token;\n            }\n            return token;\n        };\n    var symbol, preErrorSymbol, state, action, a, r, yyval = {}, p, len, newState, expected;\n    while (true) {\n        state = stack[stack.length - 1];\n        if (this.defaultActions[state]) {\n            action = this.defaultActions[state];\n        } else {\n            if (symbol === null || typeof symbol == 'undefined') {\n                symbol = lex();\n            }\n            action = table[state] && table[state][symbol];\n        }\n                    if (typeof action === 'undefined' || !action.length || !action[0]) {\n                var errStr = '';\n                expected = [];\n                for (p in table[state]) {\n                    if (this.terminals_[p] && p > TERROR) {\n                        expected.push('\\'' + this.terminals_[p] + '\\'');\n                    }\n                }\n                if (lexer.showPosition) {\n                    errStr = 'Parse error on line ' + (yylineno + 1) + ':\\n' + lexer.showPosition() + '\\nExpecting ' + expected.join(', ') + ', got \\'' + (this.terminals_[symbol] || symbol) + '\\'';\n                } else {\n                    errStr = 'Parse error on line ' + (yylineno + 1) + ': Unexpected ' + (symbol == EOF ? 'end of input' : '\\'' + (this.terminals_[symbol] || symbol) + '\\'');\n                }\n                this.parseError(errStr, {\n                    text: lexer.match,\n                    token: this.terminals_[symbol] || symbol,\n                    line: lexer.yylineno,\n                    loc: yyloc,\n                    expected: expected\n                });\n            }\n        if (action[0] instanceof Array && action.length > 1) {\n            throw new Error('Parse Error: multiple actions possible at state: ' + state + ', token: ' + symbol);\n        }\n        switch (action[0]) {\n        case 1:\n            stack.push(symbol);\n            vstack.push(lexer.yytext);\n            lstack.push(lexer.yylloc);\n            stack.push(action[1]);\n            symbol = null;\n            if (!preErrorSymbol) {\n                yyleng = lexer.yyleng;\n                yytext = lexer.yytext;\n                yylineno = lexer.yylineno;\n                yyloc = lexer.yylloc;\n                if (recovering > 0) {\n                    recovering--;\n                }\n            } else {\n                symbol = preErrorSymbol;\n                preErrorSymbol = null;\n            }\n            break;\n        case 2:\n            len = this.productions_[action[1]][1];\n            yyval.$ = vstack[vstack.length - len];\n            yyval._$ = {\n                first_line: lstack[lstack.length - (len || 1)].first_line,\n                last_line: lstack[lstack.length - 1].last_line,\n                first_column: lstack[lstack.length - (len || 1)].first_column,\n                last_column: lstack[lstack.length - 1].last_column\n            };\n            if (ranges) {\n                yyval._$.range = [\n                    lstack[lstack.length - (len || 1)].range[0],\n                    lstack[lstack.length - 1].range[1]\n                ];\n            }\n            r = this.performAction.apply(yyval, [\n                yytext,\n                yyleng,\n                yylineno,\n                sharedState.yy,\n                action[1],\n                vstack,\n                lstack\n            ].concat(args));\n            if (typeof r !== 'undefined') {\n                return r;\n            }\n            if (len) {\n                stack = stack.slice(0, -1 * len * 2);\n                vstack = vstack.slice(0, -1 * len);\n                lstack = lstack.slice(0, -1 * len);\n            }\n            stack.push(this.productions_[action[1]][0]);\n            vstack.push(yyval.$);\n            lstack.push(yyval._$);\n            newState = table[stack[stack.length - 2]][stack[stack.length - 1]];\n            stack.push(newState);\n            break;\n        case 3:\n            return true;\n        }\n    }\n    return true;\n}};\n/* generated by jison-lex 0.3.4 */\nvar lexer = (function(){\nvar lexer = ({\n\nEOF:1,\n\nparseError:function parseError(str, hash) {\n        if (this.yy.parser) {\n            this.yy.parser.parseError(str, hash);\n        } else {\n            throw new Error(str);\n        }\n    },\n\n// resets the lexer, sets new input\nsetInput:function (input, yy) {\n        this.yy = yy || this.yy || {};\n        this._input = input;\n        this._more = this._backtrack = this.done = false;\n        this.yylineno = this.yyleng = 0;\n        this.yytext = this.matched = this.match = '';\n        this.conditionStack = ['INITIAL'];\n        this.yylloc = {\n            first_line: 1,\n            first_column: 0,\n            last_line: 1,\n            last_column: 0\n        };\n        if (this.options.ranges) {\n            this.yylloc.range = [0,0];\n        }\n        this.offset = 0;\n        return this;\n    },\n\n// consumes and returns one char from the input\ninput:function () {\n        var ch = this._input[0];\n        this.yytext += ch;\n        this.yyleng++;\n        this.offset++;\n        this.match += ch;\n        this.matched += ch;\n        var lines = ch.match(/(?:\\r\\n?|\\n).*/g);\n        if (lines) {\n            this.yylineno++;\n            this.yylloc.last_line++;\n        } else {\n            this.yylloc.last_column++;\n        }\n        if (this.options.ranges) {\n            this.yylloc.range[1]++;\n        }\n\n        this._input = this._input.slice(1);\n        return ch;\n    },\n\n// unshifts one char (or a string) into the input\nunput:function (ch) {\n        var len = ch.length;\n        var lines = ch.split(/(?:\\r\\n?|\\n)/g);\n\n        this._input = ch + this._input;\n        this.yytext = this.yytext.substr(0, this.yytext.length - len);\n        //this.yyleng -= len;\n        this.offset -= len;\n        var oldLines = this.match.split(/(?:\\r\\n?|\\n)/g);\n        this.match = this.match.substr(0, this.match.length - 1);\n        this.matched = this.matched.substr(0, this.matched.length - 1);\n\n        if (lines.length - 1) {\n            this.yylineno -= lines.length - 1;\n        }\n        var r = this.yylloc.range;\n\n        this.yylloc = {\n            first_line: this.yylloc.first_line,\n            last_line: this.yylineno + 1,\n            first_column: this.yylloc.first_column,\n            last_column: lines ?\n                (lines.length === oldLines.length ? this.yylloc.first_column : 0)\n                 + oldLines[oldLines.length - lines.length].length - lines[0].length :\n              this.yylloc.first_column - len\n        };\n\n        if (this.options.ranges) {\n            this.yylloc.range = [r[0], r[0] + this.yyleng - len];\n        }\n        this.yyleng = this.yytext.length;\n        return this;\n    },\n\n// When called from action, caches matched text and appends it on next action\nmore:function () {\n        this._more = true;\n        return this;\n    },\n\n// When called from action, signals the lexer that this rule fails to match the input, so the next matching rule (regex) should be tested instead.\nreject:function () {\n        if (this.options.backtrack_lexer) {\n            this._backtrack = true;\n        } else {\n            return this.parseError('Lexical error on line ' + (this.yylineno + 1) + '. You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\\n' + this.showPosition(), {\n                text: \"\",\n                token: null,\n                line: this.yylineno\n            });\n\n        }\n        return this;\n    },\n\n// retain first n characters of the match\nless:function (n) {\n        this.unput(this.match.slice(n));\n    },\n\n// displays already matched input, i.e. for error messages\npastInput:function () {\n        var past = this.matched.substr(0, this.matched.length - this.match.length);\n        return (past.length > 20 ? '...':'') + past.substr(-20).replace(/\\n/g, \"\");\n    },\n\n// displays upcoming input, i.e. for error messages\nupcomingInput:function () {\n        var next = this.match;\n        if (next.length < 20) {\n            next += this._input.substr(0, 20-next.length);\n        }\n        return (next.substr(0,20) + (next.length > 20 ? '...' : '')).replace(/\\n/g, \"\");\n    },\n\n// displays the character position where the lexing error occurred, i.e. for error messages\nshowPosition:function () {\n        var pre = this.pastInput();\n        var c = new Array(pre.length + 1).join(\"-\");\n        return pre + this.upcomingInput() + \"\\n\" + c + \"^\";\n    },\n\n// test the lexed token: return FALSE when not a match, otherwise return token\ntest_match:function(match, indexed_rule) {\n        var token,\n            lines,\n            backup;\n\n        if (this.options.backtrack_lexer) {\n            // save context\n            backup = {\n                yylineno: this.yylineno,\n                yylloc: {\n                    first_line: this.yylloc.first_line,\n                    last_line: this.last_line,\n                    first_column: this.yylloc.first_column,\n                    last_column: this.yylloc.last_column\n                },\n                yytext: this.yytext,\n                match: this.match,\n                matches: this.matches,\n                matched: this.matched,\n                yyleng: this.yyleng,\n                offset: this.offset,\n                _more: this._more,\n                _input: this._input,\n                yy: this.yy,\n                conditionStack: this.conditionStack.slice(0),\n                done: this.done\n            };\n            if (this.options.ranges) {\n                backup.yylloc.range = this.yylloc.range.slice(0);\n            }\n        }\n\n        lines = match[0].match(/(?:\\r\\n?|\\n).*/g);\n        if (lines) {\n            this.yylineno += lines.length;\n        }\n        this.yylloc = {\n            first_line: this.yylloc.last_line,\n            last_line: this.yylineno + 1,\n            first_column: this.yylloc.last_column,\n            last_column: lines ?\n                         lines[lines.length - 1].length - lines[lines.length - 1].match(/\\r?\\n?/)[0].length :\n                         this.yylloc.last_column + match[0].length\n        };\n        this.yytext += match[0];\n        this.match += match[0];\n        this.matches = match;\n        this.yyleng = this.yytext.length;\n        if (this.options.ranges) {\n            this.yylloc.range = [this.offset, this.offset += this.yyleng];\n        }\n        this._more = false;\n        this._backtrack = false;\n        this._input = this._input.slice(match[0].length);\n        this.matched += match[0];\n        token = this.performAction.call(this, this.yy, this, indexed_rule, this.conditionStack[this.conditionStack.length - 1]);\n        if (this.done && this._input) {\n            this.done = false;\n        }\n        if (token) {\n            return token;\n        } else if (this._backtrack) {\n            // recover context\n            for (var k in backup) {\n                this[k] = backup[k];\n            }\n            return false; // rule action called reject() implying the next rule should be tested instead.\n        }\n        return false;\n    },\n\n// return next match in input\nnext:function () {\n        if (this.done) {\n            return this.EOF;\n        }\n        if (!this._input) {\n            this.done = true;\n        }\n\n        var token,\n            match,\n            tempMatch,\n            index;\n        if (!this._more) {\n            this.yytext = '';\n            this.match = '';\n        }\n        var rules = this._currentRules();\n        for (var i = 0; i < rules.length; i++) {\n            tempMatch = this._input.match(this.rules[rules[i]]);\n            if (tempMatch && (!match || tempMatch[0].length > match[0].length)) {\n                match = tempMatch;\n                index = i;\n                if (this.options.backtrack_lexer) {\n                    token = this.test_match(tempMatch, rules[i]);\n                    if (token !== false) {\n                        return token;\n                    } else if (this._backtrack) {\n                        match = false;\n                        continue; // rule action called reject() implying a rule MISmatch.\n                    } else {\n                        // else: this is a lexer rule which consumes input without producing a token (e.g. whitespace)\n                        return false;\n                    }\n                } else if (!this.options.flex) {\n                    break;\n                }\n            }\n        }\n        if (match) {\n            token = this.test_match(match, rules[index]);\n            if (token !== false) {\n                return token;\n            }\n            // else: this is a lexer rule which consumes input without producing a token (e.g. whitespace)\n            return false;\n        }\n        if (this._input === \"\") {\n            return this.EOF;\n        } else {\n            return this.parseError('Lexical error on line ' + (this.yylineno + 1) + '. Unrecognized text.\\n' + this.showPosition(), {\n                text: \"\",\n                token: null,\n                line: this.yylineno\n            });\n        }\n    },\n\n// return next match that has a token\nlex:function lex () {\n        var r = this.next();\n        if (r) {\n            return r;\n        } else {\n            return this.lex();\n        }\n    },\n\n// activates a new lexer condition state (pushes the new lexer condition state onto the condition stack)\nbegin:function begin (condition) {\n        this.conditionStack.push(condition);\n    },\n\n// pop the previously active lexer condition state off the condition stack\npopState:function popState () {\n        var n = this.conditionStack.length - 1;\n        if (n > 0) {\n            return this.conditionStack.pop();\n        } else {\n            return this.conditionStack[0];\n        }\n    },\n\n// produce the lexer rule set which is active for the currently active lexer condition state\n_currentRules:function _currentRules () {\n        if (this.conditionStack.length && this.conditionStack[this.conditionStack.length - 1]) {\n            return this.conditions[this.conditionStack[this.conditionStack.length - 1]].rules;\n        } else {\n            return this.conditions[\"INITIAL\"].rules;\n        }\n    },\n\n// return the currently active lexer condition state; when an index argument is provided it produces the N-th previous condition state, if available\ntopState:function topState (n) {\n        n = this.conditionStack.length - 1 - Math.abs(n || 0);\n        if (n >= 0) {\n            return this.conditionStack[n];\n        } else {\n            return \"INITIAL\";\n        }\n    },\n\n// alias for begin(condition)\npushState:function pushState (condition) {\n        this.begin(condition);\n    },\n\n// return the number of states currently on the stack\nstateStackSize:function stateStackSize() {\n        return this.conditionStack.length;\n    },\noptions: {},\nperformAction: function anonymous(yy,yy_,$avoiding_name_collisions,YY_START) {\nvar YYSTATE=YY_START;\nswitch($avoiding_name_collisions) {\ncase 0:/* skip whitespace */\nbreak;\ncase 1:return 7\nbreak;\ncase 2:return 6\nbreak;\ncase 3:return 8\nbreak;\ncase 4:return 35\nbreak;\ncase 5:return 33\nbreak;\ncase 6:return 33\nbreak;\ncase 7:return 34\nbreak;\ncase 8:return 34\nbreak;\ncase 9:return 9\nbreak;\ncase 10:return 10\nbreak;\ncase 11:return 27\nbreak;\ncase 12:return 29\nbreak;\ncase 13:return '|'\nbreak;\ncase 14:return 19\nbreak;\ncase 15:return 18\nbreak;\ncase 16:return 21\nbreak;\ncase 17:return 20\nbreak;\ncase 18:return 17\nbreak;\ncase 19:return 16\nbreak;\ncase 20:return 15\nbreak;\ncase 21:return 32\nbreak;\ncase 22:return 30\nbreak;\ncase 23:return 31\nbreak;\ncase 24:return 31\nbreak;\ncase 25:return 25\nbreak;\ncase 26:return 'INVALID'\nbreak;\ncase 27:return 5\nbreak;\n}\n},\nrules: [/^(?:\\s+)/,/^(?:AND\\b)/,/^(?:OR\\b)/,/^(?:NOT\\b)/,/^(?:NULL\\b)/,/^(?:TRUE\\b)/,/^(?:true\\b)/,/^(?:FALSE\\b)/,/^(?:false\\b)/,/^(?:\\()/,/^(?:\\))/,/^(?:\\[)/,/^(?:\\])/,/^(?:\\|)/,/^(?:<=)/,/^(?:<)/,/^(?:>=)/,/^(?:>)/,/^(?:!=)/,/^(?:==)/,/^(?:=)/,/^(?:-?[0-9]+(\\.[0-9]+)?\\b)/,/^(?:[a-zA-Z_][a-zA-Z0-9_]*)/,/^(?:'[^\\']*')/,/^(?:\"[^\\\"]*\")/,/^(?:\\.)/,/^(?:.)/,/^(?:$)/],\nconditions: {\"INITIAL\":{\"rules\":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27],\"inclusive\":true}}\n});\nreturn lexer;\n})();\nparser.lexer = lexer;\nfunction Parser () {\n  this.yy = {};\n}\nParser.prototype = parser;parser.Parser = Parser;\nreturn new Parser;\n})();\n\nexport const accessParser = parser;\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {hasOwn, map} from '../../../src/core/types/object';\nimport {accessParser as parser} from '../../../build/parsers/access-expr-impl';\n\n/**\n * Evaluates access expressions.\n *\n * The grammar is defined in the `access-expr-impl.jison` and compiled using\n * (Jison)[https://zaach.github.io/jison/] parser. The compilation steps are\n * built into the `amp build` and `amp dist` tasks.\n *\n * Grammar highlights:\n * - Shorthand truthy expressions are allowed, such as `field`. Truthy value\n *   is defined as `X !== null && X !== '' && X !== 0 && X !== false`.\n * - Basic equality expressions: `X = 1`, `X = true`, `X = \"A\"`. And also,\n *   non-equality: `X != 1` and so on.\n * - Basic comparison expressions only defined for numbers: `X < 1`,\n *   `X >= 10`.\n * - Boolean logic: `X = 1 OR Y = 1`, `X = 1 AND Y = 2`, `NOT X`, `NOT (X = 1)`.\n *\n * @param {string} expr\n * @param {!JsonObject} data\n * @return {boolean}\n */\nexport function evaluateAccessExpr(expr, data) {\n  try {\n    parser.yy = data;\n    return !!parser.parse(expr);\n  } finally {\n    parser.yy = null;\n  }\n}\n\n/**\n * AmpAccessEvaluator evaluates amp-access expressions.\n * It uses a cache to speed up repeated evals for the same expression.\n */\nexport class AmpAccessEvaluator {\n  /** */\n  constructor() {\n    /** @type {Object<string, boolean>} */\n    this.cache = null;\n\n    /** @private @type {JsonObject} */\n    this.lastData_ = null;\n  }\n\n  /**\n   * Evaluate access expressions, but turn to a cache first.\n   * Cache is invalidated when given new data.\n   *\n   * @param {string} expr\n   * @param {!JsonObject} data\n   * @return {boolean}\n   */\n  evaluate(expr, data) {\n    if (this.lastData_ !== data) {\n      this.lastData_ = data;\n      this.cache = map();\n    }\n\n    if (!hasOwn(this.cache, expr)) {\n      this.cache[expr] = evaluateAccessExpr(expr, data);\n    }\n\n    return this.cache[expr];\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {evaluateAccessExpr} from '../../amp-access/0.1/access-expr';\n\n/**\n * @param {string} expr\n * @param {!JsonObject} data\n * @return {boolean}\n */\nexport function evaluateExpr(expr, data) {\n  return evaluateAccessExpr(expr, data);\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {dict} from '../../../src/core/types/object';\nimport {evaluateExpr} from './expr';\n\n/**\n * This implements the rendering methods for local platform.\n *\n */\nexport class LocalSubscriptionPlatformRenderer {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {!./dialog.Dialog} dialog\n   * @param {!./service-adapter.ServiceAdapter} serviceAdapter\n   */\n  constructor(ampdoc, dialog, serviceAdapter) {\n    /** @private @const */\n    this.ampdoc_ = ampdoc;\n\n    /** @private @const */\n    this.rootNode_ = ampdoc.getRootNode();\n\n    /** @private @const {!./dialog.Dialog} */\n    this.dialog_ = dialog;\n\n    /** @private @const {!../../../src/service/template-impl.Templates} */\n    this.templates_ = Services.templatesForDoc(ampdoc);\n\n    /** @private @const {!./service-adapter.ServiceAdapter} */\n    this.serviceAdapter_ = serviceAdapter;\n  }\n\n  /**\n   *\n   * @param {!JsonObject} renderState\n   * @return {!Promise}\n   */\n  render(renderState) {\n    return Promise.all([\n      this.renderActions_(renderState),\n      this.renderDialog_(/** @type {!JsonObject} */ (renderState)),\n    ]);\n  }\n\n  /**\n   * Resets all the rendered content back to normal.\n   * @return {!Promise}\n   */\n  reset() {\n    // Close dialog. Ignored if the dialog is not currently open.\n    this.dialog_.close();\n    // Hide subscriptions sections.\n    return this.renderActionsInNode_(dict(), this.rootNode_, () => false);\n  }\n\n  /**\n   * @param {!JsonObject} renderState\n   */\n  renderActions_(renderState) {\n    this.renderActionsInNode_(renderState, this.rootNode_, evaluateExpr);\n  }\n\n  /**\n   * @param {!JsonObject} authResponse\n   * @return {!Promise<boolean>}\n   */\n  renderDialog_(authResponse) {\n    // Make sure the document is fully parsed.\n    return this.ampdoc_\n      .whenReady()\n      .then(() => {\n        // Find the first matching dialog.\n        const candidates = this.ampdoc_\n          .getRootNode()\n          .querySelectorAll('[subscriptions-dialog][subscriptions-display]');\n        for (let i = 0; i < candidates.length; i++) {\n          const candidate = candidates[i];\n          const expr = candidate.getAttribute('subscriptions-display');\n          if (expr && evaluateExpr(expr, authResponse)) {\n            return candidate;\n          }\n        }\n      })\n      .then((candidate) => {\n        if (!candidate) {\n          return;\n        }\n        if (candidate.tagName == 'TEMPLATE') {\n          return this.templates_\n            .renderTemplate(candidate, authResponse)\n            .then((element) => {\n              const renderState = /** @type {!JsonObject} */ (authResponse);\n              return this.renderActionsInNode_(\n                renderState,\n                element,\n                evaluateExpr\n              );\n            });\n        }\n        const clone = candidate.cloneNode(true);\n        clone.removeAttribute('subscriptions-dialog');\n        clone.removeAttribute('subscriptions-display');\n        return clone;\n      })\n      .then((element) => {\n        if (!element) {\n          return;\n        }\n        return this.dialog_.open(element, /* showCloseButton */ true);\n      });\n  }\n\n  /**\n   * Renders actions inside a given node according to an authResponse\n   * @param {!JsonObject} renderState\n   * @param {!Node} rootNode\n   * @param {function(string, !JsonObject):boolean} evaluateExpr\n   * @return {!Promise<Node>}\n   * @private\n   */\n  renderActionsInNode_(renderState, rootNode, evaluateExpr) {\n    return this.ampdoc_.whenReady().then(() => {\n      // Find the matching actions and sections and make them visible if\n      // evalutes to true.\n      const querySelectors =\n        '[subscriptions-action], [subscriptions-section=\"actions\"],' +\n        ' [subscriptions-actions]';\n      const actionCandidates = rootNode.querySelectorAll(querySelectors);\n      for (let i = 0; i < actionCandidates.length; i++) {\n        const candidate = actionCandidates[i];\n        const expr = candidate.getAttribute('subscriptions-display');\n        if (\n          expr &&\n          evaluateExpr(expr, /** @type {!JsonObject} */ (renderState))\n        ) {\n          candidate.classList.add('i-amphtml-subs-display');\n          if (\n            candidate.getAttribute('subscriptions-service') &&\n            candidate.getAttribute('subscriptions-action') &&\n            candidate.getAttribute('subscriptions-decorate') !== 'false' &&\n            !candidate.hasAttribute('i-amphtml-subs-decorated')\n          ) {\n            this.serviceAdapter_.decorateServiceAction(\n              candidate,\n              candidate.getAttribute('subscriptions-service'),\n              candidate.getAttribute('subscriptions-action'),\n              null\n            );\n            candidate.setAttribute('i-amphtml-subs-decorated', true);\n          }\n        } else {\n          candidate.classList.remove('i-amphtml-subs-display');\n        }\n      }\n      return rootNode;\n    });\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {getValueForExpr} from '../../../src/core/types/object';\n\nexport class UrlBuilder {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Promise<string>} readerIdPromise\n   */\n  constructor(ampdoc, readerIdPromise) {\n    const headNode = ampdoc.getHeadNode();\n\n    /** @private @const {!../../../src/service/url-replacements-impl.UrlReplacements} */\n    this.urlReplacements_ = Services.urlReplacementsForDoc(headNode);\n\n    /** @private @const {!Promise<string>} */\n    this.readerIdPromise_ = readerIdPromise;\n\n    /** @private {?JsonObject} */\n    this.authResponse_ = null;\n  }\n\n  /**\n   * @param {!JsonObject} authResponse\n   */\n  setAuthResponse(authResponse) {\n    this.authResponse_ = authResponse;\n  }\n\n  /**\n   * @param {string} url\n   * @param {boolean} useAuthData Allows `AUTH(field)` URL var substitutions.\n   * @return {!Promise<string>}\n   */\n  buildUrl(url, useAuthData) {\n    return this.prepareUrlVars_(useAuthData).then((vars) => {\n      return this.urlReplacements_.expandUrlAsync(url, vars);\n    });\n  }\n\n  /**\n   * @param {string} url\n   * @param {boolean} useAuthData Allows `AUTH(field)` URL var substitutions.\n   * @return {!Promise<!Object<string, *>>}\n   */\n  collectUrlVars(url, useAuthData) {\n    return this.prepareUrlVars_(useAuthData).then((vars) => {\n      return this.urlReplacements_.collectVars(url, vars);\n    });\n  }\n\n  /**\n   * @param {boolean} useAuthData Allows `AUTH(field)` URL var substitutions.\n   * @return {!Promise<!Object<string, *>>}\n   * @private\n   */\n  prepareUrlVars_(useAuthData) {\n    return this.readerIdPromise_.then((readerId) => {\n      const vars = {\n        'READER_ID': readerId,\n        'ACCESS_READER_ID': readerId, // A synonym.\n      };\n      if (useAuthData) {\n        vars['AUTHDATA'] = (field) => {\n          if (this.authResponse_) {\n            return getValueForExpr(this.authResponse_, field);\n          }\n          return undefined;\n        };\n      }\n      return vars;\n    });\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Action} from './analytics';\nimport {Actions} from './actions';\nimport {LocalSubscriptionPlatformRenderer} from './local-subscription-platform-renderer';\nimport {UrlBuilder} from './url-builder';\nimport {closestAncestorElementBySelector} from '../../../src/core/dom/query';\nimport {dev, userAssert} from '../../../src/log';\n\n/**\n * Surrogate property added to click events marking them as handled by the\n * amp-subscriptions extension.\n */\nconst CLICK_HANDLED_EVENT_PROPERTY = '_AMP_SUBSCRIPTIONS_CLICK_HANDLED';\n\n/**\n * This implements the methods to interact with various subscription platforms.\n *\n * @implements {./subscription-platform.SubscriptionPlatform}\n */\nexport class LocalSubscriptionBasePlatform {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {!JsonObject} platformConfig\n   * @param {!./service-adapter.ServiceAdapter} serviceAdapter\n   */\n  constructor(ampdoc, platformConfig, serviceAdapter) {\n    /** @protected @const */\n    this.ampdoc_ = ampdoc;\n\n    /** @private @const */\n    this.rootNode_ = ampdoc.getRootNode();\n\n    /** @protected {!JsonObject} */\n    this.serviceConfig_ = platformConfig;\n\n    /** @private @const {boolean} */\n    this.pingbackAllEntitlements_ =\n      !!this.serviceConfig_['pingbackAllEntitlements'];\n\n    /** @protected @const {!./service-adapter.ServiceAdapter} */\n    this.serviceAdapter_ = serviceAdapter;\n\n    /** @protected @const {!UrlBuilder} */\n    this.urlBuilder_ = new UrlBuilder(\n      this.ampdoc_,\n      this.serviceAdapter_.getReaderId('local')\n    );\n\n    /** @protected @const {!./analytics.SubscriptionAnalytics} */\n    this.subscriptionAnalytics_ = serviceAdapter.getAnalytics();\n\n    userAssert(\n      this.serviceConfig_['actions'],\n      'Actions have not been defined in the service config'\n    );\n\n    /** @private @const {!Actions} */\n    this.actions_ = new Actions(\n      this.ampdoc_,\n      this.urlBuilder_,\n      this.subscriptionAnalytics_,\n      this.validateActionMap(this.serviceConfig_['actions'])\n    );\n\n    /** @private @const {!LocalSubscriptionPlatformRenderer}*/\n    this.renderer_ = new LocalSubscriptionPlatformRenderer(\n      this.ampdoc_,\n      serviceAdapter.getDialog(),\n      this.serviceAdapter_\n    );\n  }\n\n  /**\n   * @override\n   */\n  getPlatformKey() {\n    return 'local';\n  }\n\n  /**\n   * Validates the action map\n   * @param {!JsonObject<string, string>} actionMap\n   * @return {!JsonObject<string, string>}\n   */\n  validateActionMap(actionMap) {\n    userAssert(\n      actionMap[Action.LOGIN],\n      'Action \"login\" is not present in action map'\n    );\n    userAssert(\n      actionMap[Action.SUBSCRIBE],\n      'Action \"subscribe\" is not present in action map'\n    );\n    return actionMap;\n  }\n\n  /**\n   * Add event listener for the subscriptions action\n   * @protected\n   */\n  initializeListeners_() {\n    const handleClickOncePerEvent = (e) => {\n      if (e[CLICK_HANDLED_EVENT_PROPERTY]) {\n        return;\n      }\n      e[CLICK_HANDLED_EVENT_PROPERTY] = true;\n\n      const element = closestAncestorElementBySelector(\n        dev().assertElement(e.target),\n        '[subscriptions-action]'\n      );\n      this.handleClick_(element);\n    };\n    this.rootNode_.addEventListener('click', handleClickOncePerEvent);\n\n    // If the root node has a `body` property, listen to events on that too,\n    // to fix an iOS shadow DOM bug (https://github.com/ampproject/amphtml/issues/25754).\n    if (this.rootNode_.body) {\n      this.rootNode_.body.addEventListener('click', handleClickOncePerEvent);\n    }\n  }\n\n  /**\n   * Handle click on subscription-action\n   * @private\n   * @param {Node} element\n   */\n  handleClick_(element) {\n    if (element) {\n      const action = element.getAttribute('subscriptions-action');\n      const serviceAttr = element.getAttribute('subscriptions-service');\n      if (serviceAttr == 'local') {\n        this.executeAction(action, element.id);\n      } else if ((serviceAttr || 'auto') == 'auto') {\n        if (action == Action.LOGIN) {\n          // The \"login\" action is somewhat special b/c viewers can\n          // enhance this action, e.g. to provide save/link feature.\n          const platform = this.serviceAdapter_.selectPlatformForLogin();\n          this.serviceAdapter_.delegateActionToService(\n            action,\n            platform.getPlatformKey(),\n            element.id\n          );\n        } else {\n          this.executeAction(action, element.id);\n        }\n      } else if (serviceAttr) {\n        this.serviceAdapter_.delegateActionToService(\n          action,\n          serviceAttr,\n          element.id\n        );\n      }\n    }\n  }\n\n  /** @override */\n  activate(entitlement) {\n    // Note all platforms are resolved at this stage\n    // Get the factor states of each platform and\n    // add them to the renderState object\n    this.createRenderState_(entitlement).then((renderState) => {\n      this.renderer_.render(renderState);\n    });\n  }\n\n  /**\n   * Factored out for testability\n   * @param {./entitlement.Entitlement} entitlement\n   * @return {!Promise<!JsonObject>}\n   * @private\n   */\n  createRenderState_(entitlement) {\n    const renderState = entitlement.json();\n    return this.serviceAdapter_\n      .getScoreFactorStates()\n      .then((scoresValues) => {\n        renderState['factors'] = scoresValues;\n        return this.urlBuilder_.setAuthResponse(renderState);\n      })\n      .then(() => {\n        return this.actions_.build();\n      })\n      .then(() => renderState);\n  }\n\n  /** @override */\n  reset() {\n    this.renderer_.reset();\n  }\n\n  /** @override */\n  executeAction(action) {\n    const actionExecution = this.actions_.execute(action);\n    return actionExecution.then((result) => {\n      if (result) {\n        this.serviceAdapter_.resetPlatforms();\n      }\n      return !!result;\n    });\n  }\n\n  /** @override */\n  isPrerenderSafe() {\n    // Local platform can never be allowed to prerender in a viewer\n    return false;\n  }\n\n  /** @override */\n  getSupportedScoreFactor(unusedFactor) {\n    return 0;\n  }\n\n  /** @override */\n  getBaseScore() {\n    return this.serviceConfig_['baseScore'] || 0;\n  }\n\n  /**\n   * @override\n   * @return {!Promise<?./entitlement.Entitlement>}\n   */\n  getEntitlements() {}\n\n  /**\n   * @override\n   */\n  pingback(unusedEntitlement) {}\n\n  /**\n   * @override\n   * @return {boolean}\n   */\n  pingbackReturnsAllEntitlements() {\n    return this.pingbackAllEntitlements_;\n  }\n\n  /** @override */\n  isPingbackEnabled() {\n    return false;\n  }\n\n  /** @override */\n  decorateUI(unusedNode, unusedAction, unusedOptions) {}\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview The messaging protocol is intentionally kept close to\n * Web Activities (https://github.com/google/web-activities). We may switch\n * the exact WA version at some in the future.\n *\n * Notice! As much as possible, keep this module dependency-free.\n */\n\nconst SENTINEL = '__AMP__';\n\nexport class Messenger {\n  /**\n   * @param {!Window} win\n   * @param {!Window|function():?Window} targetOrCallback\n   * @param {?string} targetOrigin\n   */\n  constructor(win, targetOrCallback, targetOrigin) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n    /** @private @const {!Window|function():?Window} */\n    this.targetOrCallback_ = targetOrCallback;\n\n    /**\n     * May start as unknown (`null`) until received in the first message.\n     * @private {?string}\n     */\n    this.targetOrigin_ = targetOrigin;\n\n    /** @private {?Window} */\n    this.target_ = null;\n\n    /** @private {?function(string, ?Object):*} */\n    this.onCommand_ = null;\n\n    /** @private @const */\n    this.boundHandleEvent_ = this.handleEvent_.bind(this);\n\n    /** @private {number} */\n    this.requestId_ = 0;\n\n    /**\n     * @private\n     * {!Object<string, {resolve: function(*), promise: !Promise<*>}>}\n     */\n    this.waiting_ = {};\n  }\n\n  /**\n   * Connect the port to the host or vice versa.\n   * @param {function(string, ?Object):*} onCommand\n   */\n  connect(onCommand) {\n    if (this.onCommand_) {\n      throw new Error('already connected');\n    }\n    this.onCommand_ = onCommand;\n    this.win_.addEventListener('message', this.boundHandleEvent_);\n  }\n\n  /**\n   * Disconnect messenger.\n   */\n  disconnect() {\n    if (this.onCommand_) {\n      this.onCommand_ = null;\n      this.win_.removeEventListener('message', this.boundHandleEvent_);\n    }\n  }\n\n  /**\n   * Returns whether the messenger has been connected already.\n   * @return {boolean}\n   */\n  isConnected() {\n    return this.targetOrigin_ != null;\n  }\n\n  /**\n   * Returns the messaging target. Only available when connection has been\n   * establihsed.\n   * @return {!Window}\n   */\n  getTarget() {\n    const target = this.getOptionalTarget_();\n    if (!target) {\n      throw new Error('not connected');\n    }\n    return target;\n  }\n\n  /**\n   * @return {?Window}\n   * @private\n   */\n  getOptionalTarget_() {\n    if (this.onCommand_ && !this.target_) {\n      if (typeof this.targetOrCallback_ == 'function') {\n        this.target_ = this.targetOrCallback_();\n      } else {\n        this.target_ = /** @type {!Window} */ (this.targetOrCallback_);\n      }\n    }\n    return this.target_;\n  }\n\n  /**\n   * Returns the messaging origin. Only available when connection has been\n   * establihsed.\n   * @return {string}\n   */\n  getTargetOrigin() {\n    if (this.targetOrigin_ == null) {\n      throw new Error('not connected');\n    }\n    return this.targetOrigin_;\n  }\n\n  /**\n   * Sends the specified command from the port to the host or vice versa.\n   * @param {string} cmd\n   * @param {?Object=} opt_payload\n   */\n  sendCommand(cmd, opt_payload) {\n    this.sendCommand_(/* rsvpId */ undefined, cmd, opt_payload);\n  }\n\n  /**\n   * Sends the specified command from the port to the host or vice versa.\n   * @param {string} cmd\n   * @param {?Object=} opt_payload\n   * @return {!Promise}\n   */\n  sendCommandRsvp(cmd, opt_payload) {\n    const rsvpId = String(++this.requestId_);\n    let resolver = null;\n    const promise = new Promise((resolve) => {\n      resolver = resolve;\n    });\n    this.waiting_[rsvpId] = {\n      promise,\n      resolver,\n    };\n    this.sendCommand_(rsvpId, cmd, opt_payload);\n    return promise;\n  }\n\n  /**\n   * @param {string|undefined} rsvpId\n   * @param {string} cmd\n   * @param {?Object=} opt_payload\n   * @private\n   */\n  sendCommand_(rsvpId, cmd, opt_payload) {\n    const target = this.getTarget();\n    // Only \"connect\" command is allowed to use `targetOrigin == '*'`\n    const targetOrigin =\n      cmd == 'connect'\n        ? this.targetOrigin_ != null\n          ? this.targetOrigin_\n          : '*'\n        : this.getTargetOrigin();\n    target./*OK*/ postMessage(\n      /** @type {!JsonObject} */ ({\n        'sentinel': SENTINEL,\n        '_rsvp': rsvpId,\n        'cmd': cmd,\n        'payload': opt_payload || null,\n      }),\n      targetOrigin\n    );\n  }\n\n  /**\n   * @param {!Event} e\n   * @private\n   */\n  handleEvent_(e) {\n    const event = /** @type {!MessageEvent} */ (e);\n    const {data} = event;\n    if (!data || data['sentinel'] != SENTINEL) {\n      return;\n    }\n    const origin = /** @type {string} */ (event.origin);\n    const cmd = data['cmd'];\n    const payload = data['payload'] || null;\n    if (this.targetOrigin_ == null && cmd == 'start') {\n      this.targetOrigin_ = origin;\n    }\n    if (this.targetOrigin_ == null && event.source) {\n      if (this.getOptionalTarget_() == event.source) {\n        this.targetOrigin_ = origin;\n      }\n    }\n    // Notice that event.source may differ from the target because of\n    // friendly-iframe intermediaries.\n    if (origin != this.targetOrigin_) {\n      return;\n    }\n    const rsvpId = data['_rsvp'];\n    const rsvp = !!rsvpId && cmd != 'rsvp';\n    const result = this.handleCommand_(rsvpId, cmd, payload);\n    if (rsvp) {\n      Promise.resolve(result).then(\n        (result) => {\n          this.sendCommand_(rsvpId, 'rsvp', {\n            'result': result,\n          });\n        },\n        (reason) => {\n          this.sendCommand_(rsvpId, 'rsvp', {\n            'error': String(reason),\n          });\n        }\n      );\n    }\n  }\n\n  /**\n   * @param {string|undefined} rsvpId\n   * @param {string} cmd\n   * @param {?Object} payload\n   * @return {*}\n   * @private\n   */\n  handleCommand_(rsvpId, cmd, payload) {\n    if (cmd == 'rsvp') {\n      const waiting = rsvpId && this.waiting_[rsvpId];\n      if (waiting) {\n        if ('error' in payload) {\n          waiting.resolver(Promise.reject(new Error(payload['error'])));\n        } else {\n          waiting.resolver(payload['result']);\n        }\n        delete this.waiting_[rsvpId];\n      }\n      return;\n    }\n    return this.onCommand_(cmd, payload);\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../../../src/core/data-structures/promise';\nimport {Entitlement} from './entitlement';\nimport {LocalSubscriptionBasePlatform} from './local-subscription-platform-base';\nimport {Messenger} from '../../amp-access/0.1/iframe-api/messenger';\nimport {assertHttpsUrl, parseUrlDeprecated} from '../../../src/url';\nimport {devAssert, userAssert} from '../../../src/log';\nimport {isArray} from '../../../src/core/types';\nimport {parseJson} from '../../../src/core/types/object/json';\nimport {toggle} from '../../../src/style';\n\n/**\n * Implments the iframe local subscriptions platform which provides\n * authorization and pingback via an iframe\n *\n * @implements {./subscription-platform.SubscriptionPlatform}\n */\nexport class LocalSubscriptionIframePlatform extends LocalSubscriptionBasePlatform {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {!JsonObject} platformConfig\n   * @param {!./service-adapter.ServiceAdapter} serviceAdapter\n   */\n  constructor(ampdoc, platformConfig, serviceAdapter) {\n    super(ampdoc, platformConfig, serviceAdapter);\n\n    devAssert(\n      this.serviceConfig_['type'] == 'iframe',\n      'iframe initialized called without iframe config type'\n    );\n\n    /** @const @private {string} */\n    this.iframeSrc_ = userAssert(\n      this.serviceConfig_['iframeSrc'],\n      '\"iframeSrc\" URL must be specified'\n    );\n    assertHttpsUrl(this.iframeSrc_, 'iframe Url');\n\n    /** @const @private {?Array} */\n    this.iframeVars_ = this.serviceConfig_['iframeVars'] || null;\n    if (this.iframeVars_) {\n      userAssert(isArray(this.iframeVars_), '\"iframeVars\" must be an array');\n    }\n\n    /** @private @const {string} */\n    this.targetOrigin_ = parseUrlDeprecated(this.iframeSrc_).origin;\n\n    /** @private {?function()} */\n    this.connectedResolver_ = null;\n\n    /** @private {?Promise} */\n    this.connectedPromise_ = null;\n\n    // TODO(jpettitt) maybe allow the iframe to render UI?\n    /** @private @const {!Element} */\n    this.iframe_ = ampdoc.win.document.createElement('iframe');\n    toggle(this.iframe_, false);\n\n    /** @private @const {!Messenger} */\n    this.messenger_ = new Messenger(\n      this.ampdoc_.win,\n      () => this.iframe_.contentWindow,\n      this.targetOrigin_\n    );\n\n    /** @private {?Promise<!JsonObject>} */\n    this.configPromise_ = null;\n\n    this.initializeListeners_();\n  }\n\n  /** @override */\n  getEntitlements() {\n    return this.connect().then(() => {\n      return this.messenger_\n        .sendCommandRsvp('authorize', {})\n        .then((res) => {\n          res.source = 'local-iframe';\n          return res;\n        })\n        .then((resJson) => Entitlement.parseFromJson(resJson));\n    });\n  }\n\n  /** @override */\n  isPingbackEnabled() {\n    return true;\n  }\n\n  /** @override */\n  pingback(selectedEntitlement) {\n    return this.connect().then(() => {\n      return this.messenger_.sendCommandRsvp('pingback', {\n        entitlement: selectedEntitlement,\n      });\n    });\n  }\n\n  /**\n   * @return {!Promise}\n   * @package Visible for testing only.\n   */\n  connect() {\n    if (!this.connectedPromise_) {\n      const deferred = new Deferred();\n      this.connectedPromise_ = deferred.promise;\n      this.connectedResolver_ = deferred.resolve;\n\n      this.configPromise_ = this.resolveConfig_();\n      // Connect.\n      this.messenger_.connect(this.handleCommand_.bind(this));\n      this.ampdoc_.getBody().appendChild(this.iframe_);\n      this.iframe_.src = this.iframeSrc_;\n    }\n    return this.connectedPromise_;\n  }\n\n  /**\n   * @return {!Promise<!JsonObject>}\n   * @private\n   */\n  resolveConfig_() {\n    return new Promise((resolve) => {\n      const configJson = parseJson(JSON.stringify(this.serviceConfig_));\n      const pageConfig = this.serviceAdapter_.getPageConfig();\n      // Pass id's to the iframe for context.\n      configJson['pageConfig'] = {\n        publicationId: pageConfig.getPublicationId(),\n        productId: pageConfig.getProductId(),\n        encryptedDocumentKey:\n          this.serviceAdapter_.getEncryptedDocumentKey('local') || null,\n      };\n      if (this.iframeVars_) {\n        const varsString = this.iframeVars_.join('&');\n        this.urlBuilder_\n          .collectUrlVars(varsString, /* useAuthData */ false)\n          .then((vars) => {\n            configJson['iframeVars'] = vars;\n            resolve(configJson);\n          });\n      } else {\n        resolve(configJson);\n      }\n    });\n  }\n\n  /**\n   * @param {string} cmd\n   * @param {?Object} unusedPayload\n   * @private\n   */\n  handleCommand_(cmd, unusedPayload) {\n    if (cmd === 'connect') {\n      // First ever message. Indicates that the receiver is listening.\n      this.configPromise_.then((configJson) => {\n        this.messenger_\n          .sendCommandRsvp('start', {\n            'protocol': 'amp-subscriptions',\n            'config': configJson,\n          })\n          .then(() => {\n            // Confirmation that connection has been successful.\n            if (this.connectedResolver_) {\n              this.connectedResolver_();\n              this.connectedResolver_ = null;\n            }\n          });\n      });\n    }\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Entitlement} from './entitlement';\nimport {LocalSubscriptionBasePlatform} from './local-subscription-platform-base';\nimport {Services} from '../../../src/services';\nimport {addParamToUrl, assertHttpsUrl} from '../../../src/url';\nimport {devAssert, userAssert} from '../../../src/log';\nimport {dict} from '../../../src/core/types/object';\nimport {isArray} from '../../../src/core/types';\n\n/**\n * Implments the remotel local subscriptions platform which uses\n * authorization and pingback urls\n *\n * @implements {./subscription-platform.SubscriptionPlatform}\n */\nexport class LocalSubscriptionRemotePlatform extends LocalSubscriptionBasePlatform {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {!JsonObject} platformConfig\n   * @param {!./service-adapter.ServiceAdapter} serviceAdapter\n   */\n  constructor(ampdoc, platformConfig, serviceAdapter) {\n    super(ampdoc, platformConfig, serviceAdapter);\n\n    /** @private @const {string} */\n    this.authorizationUrl_ = assertHttpsUrl(\n      userAssert(\n        this.serviceConfig_['authorizationUrl'],\n        'Service config does not have authorization Url'\n      ),\n      'Authorization Url'\n    );\n\n    /** @const @private {!../../../src/service/xhr-impl.Xhr} */\n    this.xhr_ = Services.xhrFor(this.ampdoc_.win);\n\n    /** @private @const {?string} */\n    this.pingbackUrl_ = this.serviceConfig_['pingbackUrl'] || null;\n\n    this.initializeListeners_();\n  }\n\n  /** @override */\n  getEntitlements() {\n    const fetchUrlPromise = this.urlBuilder_.buildUrl(\n      this.authorizationUrl_,\n      /* useAuthData */ false\n    );\n    const meteringStatePromise = this.serviceAdapter_.loadMeteringState();\n    return Promise.all([fetchUrlPromise, meteringStatePromise]).then(\n      (results) => {\n        let fetchUrl = results[0];\n        const meteringState = results[1];\n\n        // WARNING: If this value is really long, you might run into issues by hitting\n        // the maximum URL length in some browsers when sending the GET fetch URL.\n        if (meteringState) {\n          fetchUrl = addParamToUrl(\n            fetchUrl,\n            'meteringState',\n            btoa(JSON.stringify(meteringState))\n          );\n        }\n\n        // WARNING: If this key is really long, you might run into issues by hitting\n        // the maximum URL length in some browsers when sending the GET fetch URL.\n        const encryptedDocumentKey =\n          this.serviceAdapter_.getEncryptedDocumentKey('local');\n        if (encryptedDocumentKey) {\n          //TODO(chenshay): if crypt, switch to 'post'\n          fetchUrl = addParamToUrl(fetchUrl, 'crypt', encryptedDocumentKey);\n        }\n        return this.xhr_\n          .fetchJson(fetchUrl, {credentials: 'include'})\n          .then((res) => res.json())\n          .then((resJson) => {\n            const promises = [];\n\n            // Save metering state, if present.\n            if (resJson.metering && resJson.metering.state) {\n              promises.push(\n                this.serviceAdapter_.saveMeteringState(resJson.metering.state)\n              );\n            }\n\n            return Promise.all(promises).then(() =>\n              Entitlement.parseFromJson(resJson)\n            );\n          });\n      }\n    );\n  }\n\n  /** @override */\n  isPingbackEnabled() {\n    return !!this.pingbackUrl_;\n  }\n\n  /**\n   * Format data for pingback\n   * @param {./entitlement.Entitlement|Array<./entitlement.Entitlement>} entitlements\n   * @return {string}\n   * @private\n   */\n  stringifyPingbackData_(entitlements) {\n    if (isArray(entitlements)) {\n      const entitlementArray = [];\n      entitlements.forEach((ent) => {\n        entitlementArray.push(ent.jsonForPingback());\n      });\n      return JSON.stringify(entitlementArray);\n    }\n    return JSON.stringify(entitlements.jsonForPingback());\n  }\n\n  /** @override */\n  pingback(selectedEntitlement) {\n    if (!this.isPingbackEnabled) {\n      return;\n    }\n    const pingbackUrl = /** @type {string} */ (\n      devAssert(this.pingbackUrl_, 'pingbackUrl is null')\n    );\n\n    const promise = this.urlBuilder_.buildUrl(\n      pingbackUrl,\n      /* useAuthData */ true\n    );\n    return promise.then((url) => {\n      // Content should be 'text/plain' to avoid CORS preflight.\n      return this.xhr_.sendSignal(url, {\n        method: 'POST',\n        credentials: 'include',\n        headers: dict({\n          'Content-Type': 'text/plain',\n        }),\n        body: this.stringifyPingbackData_(selectedEntitlement),\n      });\n    });\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {LocalSubscriptionIframePlatform} from './local-subscription-platform-iframe';\nimport {LocalSubscriptionRemotePlatform} from './local-subscription-platform-remote';\n\n/**\n * Local subscription platform factory method.\n * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n * @param {!JsonObject} platformConfig\n * @param {!./service-adapter.ServiceAdapter} serviceAdapter\n * @return {!./subscription-platform.SubscriptionPlatform}\n */\nexport function localSubscriptionPlatformFactory(\n  ampdoc,\n  platformConfig,\n  serviceAdapter\n) {\n  /* Return the correxct platform based on the config */\n  if (platformConfig['type'] === 'iframe') {\n    return new LocalSubscriptionIframePlatform(\n      ampdoc,\n      platformConfig,\n      serviceAdapter\n    );\n  }\n  return new LocalSubscriptionRemotePlatform(\n    ampdoc,\n    platformConfig,\n    serviceAdapter\n  );\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ENTITLEMENTS_REQUEST_TIMEOUT} from './constants';\nimport {Entitlement, GrantReason} from './entitlement';\nimport {JwtHelper} from '../../amp-access/0.1/jwt';\nimport {PageConfig as PageConfigInterface} from '../../../third_party/subscriptions-project/config';\nimport {Services} from '../../../src/services';\nimport {devAssert, user, userAssert} from '../../../src/log';\nimport {dict} from '../../../src/core/types/object';\nimport {getSourceOrigin, getWinOrigin} from '../../../src/url';\nimport {localSubscriptionPlatformFactory} from './local-subscription-platform';\n\n/**\n * This implements the methods to interact with viewer subscription platform.\n * @implements {./subscription-platform.SubscriptionPlatform}\n */\nexport class ViewerSubscriptionPlatform {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {!JsonObject} platformConfig\n   * @param {!./service-adapter.ServiceAdapter} serviceAdapter\n   * @param {string} origin\n   */\n  constructor(ampdoc, platformConfig, serviceAdapter, origin) {\n    /** @private @const */\n    this.ampdoc_ = ampdoc;\n\n    /** @private @const */\n    this.serviceAdapter_ = serviceAdapter;\n\n    /** @private @const {!PageConfigInterface} */\n    this.pageConfig_ = serviceAdapter.getPageConfig();\n\n    /** @private @const {!./subscription-platform.SubscriptionPlatform} */\n    this.platform_ = localSubscriptionPlatformFactory(\n      ampdoc,\n      platformConfig,\n      serviceAdapter\n    );\n\n    /** @const @private {!../../../src/service/viewer-interface.ViewerInterface} */\n    this.viewer_ = Services.viewerForDoc(this.ampdoc_);\n    this.viewer_.onMessage(\n      'subscriptionchange',\n      this.subscriptionChange_.bind(this)\n    );\n\n    /** @private @const {!JwtHelper} */\n    this.jwtHelper_ = new JwtHelper(ampdoc.win);\n\n    /** @private @const {string} */\n    this.publicationId_ = this.pageConfig_.getPublicationId();\n\n    /** @private @const {?string} */\n    this.currentProductId_ = this.pageConfig_.getProductId();\n\n    /** @private @const {string} */\n    this.origin_ = origin;\n\n    /** @private @const {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(ampdoc.win);\n  }\n\n  /** @override */\n  isPrerenderSafe() {\n    return true;\n  }\n\n  /** @override */\n  getEntitlements() {\n    devAssert(this.currentProductId_, 'Current product is not set');\n\n    /** @type {JsonObject} */\n    const authRequest = dict({\n      'publicationId': this.publicationId_,\n      'productId': this.currentProductId_,\n      'origin': this.origin_,\n    });\n\n    // Defaulting to google.com for now.\n    // TODO(@elijahsoria): Remove google.com and only rely on what is returned\n    // in the cryptokeys param.\n    let encryptedDocumentKey;\n    const cryptokeysNames = this.viewer_.getParam('cryptokeys') || 'google.com';\n    if (cryptokeysNames) {\n      const keyNames = cryptokeysNames.split(',');\n      for (let i = 0; i != keyNames.length; i++) {\n        encryptedDocumentKey = this.serviceAdapter_.getEncryptedDocumentKey(\n          keyNames[i]\n        );\n        if (encryptedDocumentKey) {\n          break;\n        }\n      }\n    }\n    if (encryptedDocumentKey) {\n      authRequest['encryptedDocumentKey'] = encryptedDocumentKey;\n    }\n\n    return /** @type {!Promise<Entitlement>} */ (\n      this.timer_\n        .timeoutPromise(\n          ENTITLEMENTS_REQUEST_TIMEOUT,\n          this.viewer_.sendMessageAwaitResponse('auth', authRequest)\n        )\n        .then((entitlementData) => {\n          entitlementData = entitlementData || {};\n\n          /** Note to devs: Send error at top level of postMessage instead. */\n          const deprecatedError = entitlementData['error'];\n          const authData = entitlementData['authorization'];\n          const decryptedDocumentKey = entitlementData['decryptedDocumentKey'];\n\n          if (deprecatedError) {\n            throw new Error(deprecatedError.message);\n          }\n\n          if (!authData) {\n            return Entitlement.empty('local');\n          }\n\n          return this.verifyAuthToken_(authData, decryptedDocumentKey).catch(\n            (reason) => {\n              this.sendAuthTokenErrorToViewer_(reason.message);\n              throw reason;\n            }\n          );\n        })\n    );\n  }\n\n  /**\n   * Logs error and sends message to viewer\n   * @param {string} token\n   * @param {?string} decryptedDocumentKey\n   * @return {!Promise<!Entitlement>}\n   * @private\n   */\n  verifyAuthToken_(token, decryptedDocumentKey) {\n    return new Promise((resolve) => {\n      const origin = getWinOrigin(this.ampdoc_.win);\n      const sourceOrigin = getSourceOrigin(this.ampdoc_.win.location);\n      const decodedData = this.jwtHelper_.decode(token);\n      const currentProductId = /** @type {string} */ (\n        userAssert(this.pageConfig_.getProductId(), 'Product id is null')\n      );\n      if (decodedData['aud'] != origin && decodedData['aud'] != sourceOrigin) {\n        throw user().createError(\n          `The mismatching \"aud\" field: ${decodedData['aud']}`\n        );\n      }\n      if (decodedData['exp'] < Math.floor(Date.now() / 1000)) {\n        throw user().createError('Payload is expired');\n      }\n      const entitlements = decodedData['entitlements'];\n      let entitlement = Entitlement.empty('local');\n      let entitlementObject;\n\n      if (entitlements) {\n        // Not null\n        if (Array.isArray(entitlements)) {\n          // Multi entitlement case\n          for (let index = 0; index < entitlements.length; index++) {\n            if (\n              entitlements[index]['products'].indexOf(currentProductId) !== -1\n            ) {\n              entitlementObject = entitlements[index];\n              break;\n            }\n          }\n        } else if (entitlements['products'].indexOf(currentProductId) !== -1) {\n          // Single entitlment case\n          entitlementObject = entitlements;\n        }\n\n        if (entitlementObject) {\n          // Found a match\n          entitlement = new Entitlement({\n            source: 'viewer',\n            raw: token,\n            granted: true,\n            grantReason: entitlementObject.subscriptionToken\n              ? GrantReason.SUBSCRIBER\n              : '',\n            dataObject: entitlementObject,\n            decryptedDocumentKey,\n          });\n        }\n      }\n\n      if (decodedData['metering'] && !entitlement.granted) {\n        // Special case where viewer gives metering but no entitlement\n        entitlement = new Entitlement({\n          source: decodedData['iss'] || '',\n          raw: token,\n          granted: true,\n          grantReason: GrantReason.METERING,\n          dataObject: decodedData['metering'],\n          decryptedDocumentKey,\n        });\n      }\n      entitlement.service = 'local';\n      resolve(entitlement);\n    });\n  }\n\n  /**\n   * Logs error and sends message to viewer\n   * @param {string} errorString\n   * @private\n   */\n  sendAuthTokenErrorToViewer_(errorString) {\n    this.viewer_.sendMessage(\n      'auth-rejected',\n      dict({\n        'reason': errorString,\n      })\n    );\n  }\n\n  /** @override */\n  getPlatformKey() {\n    return this.platform_.getPlatformKey();\n  }\n\n  /** @override */\n  activate() {}\n\n  /** @override */\n  reset() {}\n\n  /** @override */\n  isPingbackEnabled() {\n    return this.platform_.isPingbackEnabled();\n  }\n\n  /** @override */\n  pingbackReturnsAllEntitlements() {\n    return this.platform_.pingbackReturnsAllEntitlements();\n  }\n\n  /** @override */\n  pingback(selectedPlatform) {\n    this.platform_.pingback(selectedPlatform);\n  }\n\n  /** @override */\n  getSupportedScoreFactor(factorName) {\n    return this.platform_.getSupportedScoreFactor(factorName);\n  }\n\n  /** @override */\n  getBaseScore() {\n    return 0;\n  }\n\n  /** @override */\n  executeAction(action, sourceId) {\n    return this.platform_.executeAction(action, sourceId);\n  }\n\n  /** @override */\n  decorateUI(element, action, options) {\n    return this.platform_.decorateUI(element, action, options);\n  }\n\n  /**\n   * Handles a reset message from the viewer which indicates\n   * subscription state changed.  Eventually that will trigger\n   * a new getEntitlements() message exchange.\n   */\n  subscriptionChange_() {\n    this.serviceAdapter_.resetPlatforms();\n  }\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CommonSignals} from './core/constants/common-signals';\nimport {Services} from './services';\nimport {TickLabel} from './core/constants/enums';\nimport {dev, devAssert} from './log';\nimport {getAmpdoc} from './service';\nimport {insertAfterOrAtStart, waitForBodyOpenPromise} from './dom';\nimport {map} from './core/types/object';\nimport {rethrowAsync} from './core/error';\nimport {setStyles} from './style';\nimport {waitForServices} from './render-delaying-services';\n\nconst TRANSFORMER_PROP = '__AMP_CSS_TR';\nconst STYLE_MAP_PROP = '__AMP_CSS_SM';\n\n/**\n * Adds the given css text to the given ampdoc.\n *\n * The style tags will be at the beginning of the head before all author\n * styles. One element can be the main runtime CSS. This is guaranteed\n * to always be the first stylesheet in the doc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc The ampdoc that should get the new styles.\n * @param {string} cssText\n * @param {?function(!Element)|undefined} cb Called when the new styles are available.\n *     Not using a promise, because this is synchronous when possible.\n *     for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n * @param {string=} opt_ext\n * @return {!Element}\n */\nexport function installStylesForDoc(\n  ampdoc,\n  cssText,\n  cb,\n  opt_isRuntimeCss,\n  opt_ext\n) {\n  const cssRoot = ampdoc.getHeadNode();\n  const style = insertStyleElement(\n    cssRoot,\n    maybeTransform(cssRoot, cssText),\n    opt_isRuntimeCss || false,\n    opt_ext || null\n  );\n\n  if (cb) {\n    const rootNode = ampdoc.getRootNode();\n    // Styles aren't always available synchronously. E.g. if there is a\n    // pending style download, it will have to finish before the new\n    // style is visible.\n    // For this reason we poll until the style becomes available.\n    // Sync case.\n    if (styleLoaded(rootNode, style)) {\n      cb(style);\n      return style;\n    }\n    // Poll until styles are available.\n    const interval = setInterval(() => {\n      if (styleLoaded(rootNode, style)) {\n        clearInterval(interval);\n        cb(style);\n      }\n    }, 4);\n  }\n  return style;\n}\n\n/**\n * Creates the properly configured style element.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @param {boolean} isRuntimeCss\n * @param {?string} ext\n * @return {!Element}\n */\nfunction insertStyleElement(cssRoot, cssText, isRuntimeCss, ext) {\n  let styleMap = cssRoot[STYLE_MAP_PROP];\n  if (!styleMap) {\n    styleMap = cssRoot[STYLE_MAP_PROP] = map();\n  }\n\n  const isExtCss =\n    !isRuntimeCss && ext && ext != 'amp-custom' && ext != 'amp-keyframes';\n  const key = isRuntimeCss\n    ? 'amp-runtime'\n    : isExtCss\n    ? `amp-extension=${ext}`\n    : null;\n\n  // Check if it has already been created or discovered.\n  if (key) {\n    const existing = getExistingStyleElement(cssRoot, styleMap, key);\n    if (existing) {\n      if (existing.textContent !== cssText) {\n        existing.textContent = cssText;\n      }\n      return existing;\n    }\n  }\n\n  // Create the new style element and append to cssRoot.\n  const doc = cssRoot.ownerDocument || cssRoot;\n  const style = doc.createElement('style');\n  style./*OK*/ textContent = cssText;\n  let afterElement = null;\n  // Make sure that we place style tags after the main runtime CSS. Otherwise\n  // the order is random.\n  if (isRuntimeCss) {\n    style.setAttribute('amp-runtime', '');\n  } else if (isExtCss) {\n    style.setAttribute('amp-extension', ext || '');\n    afterElement = dev().assertElement(\n      getExistingStyleElement(cssRoot, styleMap, 'amp-runtime')\n    );\n  } else {\n    if (ext) {\n      style.setAttribute(ext, '');\n    }\n    afterElement = cssRoot.lastChild;\n  }\n  insertAfterOrAtStart(cssRoot, style, afterElement);\n  if (key) {\n    styleMap[key] = style;\n  }\n  return style;\n}\n\n/**\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {!Object<string, !Element>} styleMap\n * @param {string} key\n * @return {?Element}\n */\nfunction getExistingStyleElement(cssRoot, styleMap, key) {\n  // Already cached.\n  if (styleMap[key]) {\n    return styleMap[key];\n  }\n  // Check if the style has already been added by the server layout.\n  const existing = cssRoot./*OK*/ querySelector(`style[${key}]`);\n  if (existing) {\n    styleMap[key] = existing;\n    return existing;\n  }\n  // Nothing found.\n  return null;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {function(string):string} transformer\n */\nexport function installCssTransformer(cssRoot, transformer) {\n  cssRoot[TRANSFORMER_PROP] = transformer;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @return {string}\n */\nfunction maybeTransform(cssRoot, cssText) {\n  const transformer = cssRoot[TRANSFORMER_PROP];\n  return transformer ? transformer(cssText) : cssText;\n}\n\n/** @private {boolean} */\nlet bodyMadeVisible = false;\n\n/**\n * @param {boolean} value\n * @visibleForTesting\n */\nexport function setBodyMadeVisibleForTesting(value) {\n  bodyMadeVisible = value;\n}\n\n/**\n * Sets the document's body opacity to 1.\n * If the body is not yet available (because our script was loaded\n * synchronously), polls until it is.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisible(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  const win = /** @type {!Window} */ (doc.defaultView);\n  waitForBodyOpenPromise(doc)\n    .then(() => {\n      return waitForServices(win);\n    })\n    .catch((reason) => {\n      rethrowAsync(reason);\n      return [];\n    })\n    .then((services) => {\n      bodyMadeVisible = true;\n      if (INI_LOAD_INOB) {\n        // Force sync measurement to ensure that style recalc is complete\n        // before showing body, which would trigger FCP. This should reduce\n        // make it less likely that a CLS would be triggered after FCP.\n        doc.body./*OK*/ getBoundingClientRect();\n      }\n      setBodyVisibleStyles(doc);\n      const ampdoc = getAmpdoc(doc);\n      ampdoc.signals().signal(CommonSignals.RENDER_START);\n      if (services.length > 0) {\n        const resources = Services.resourcesForDoc(doc.documentElement);\n        resources./*OK*/ schedulePass(1, /* relayoutAll */ true);\n      }\n      try {\n        const perf = Services.performanceFor(win);\n        perf.tick(TickLabel.MAKE_BODY_VISIBLE);\n        perf.flush();\n      } catch (e) {}\n    });\n}\n\n/**\n * Set the document's body opacity to 1. Called in error cases.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisibleRecovery(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  if (bodyMadeVisible) {\n    return;\n  }\n  bodyMadeVisible = true;\n  setBodyVisibleStyles(doc);\n}\n\n/**\n * Make sure that body exists, and make it visible.\n * @param {!Document} doc\n */\nfunction setBodyVisibleStyles(doc) {\n  setStyles(dev().assertElement(doc.body), {\n    opacity: 1,\n    visibility: 'visible',\n    'animation': 'none',\n  });\n}\n\n/**\n * Indicates that the body is always visible. For instance, in case of PWA.\n * This check is on a module level variable, and could be problematic if you are\n * relying on this function across different binaries.\n * @param {!Window} unusedWin\n */\nexport function bodyAlwaysVisible(unusedWin) {\n  bodyMadeVisible = true;\n}\n\n/**\n * Checks whether a style element was registered in the DOM.\n * @param {!Document|!ShadowRoot} doc\n * @param {!Element} style\n * @return {boolean}\n */\nfunction styleLoaded(doc, style) {\n  const sheets = doc.styleSheets;\n  for (let i = 0; i < sheets.length; i++) {\n    const sheet = sheets[i];\n    if (sheet.ownerNode == style) {\n      return true;\n    }\n  }\n  return false;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {AmpEvents} from './core/constants/amp-events';\nimport {Services} from './services';\nimport {\n  USER_ERROR_SENTINEL,\n  dev,\n  isUserErrorEmbed,\n  isUserErrorMessage,\n} from './log';\nimport {dict} from './core/types/object';\nimport {duplicateErrorIfNecessary} from './core/error';\nimport {experimentTogglesOrNull, getBinaryType, isCanary} from './experiments';\nimport {exponentialBackoff} from './core/types/function/exponential-backoff';\nimport {findIndex} from './core/types/array';\nimport {getMode} from './mode';\nimport {isLoadErrorMessage} from './event-helper';\nimport {isProxyOrigin} from './url';\nimport {makeBodyVisibleRecovery} from './style-installer';\nimport {triggerAnalyticsEvent} from './analytics';\nimport {urls} from './config';\n\n/**\n * @const {string}\n */\nconst CANCELLED = 'CANCELLED';\n\n/**\n * @const {string}\n */\nconst BLOCK_BY_CONSENT = 'BLOCK_BY_CONSENT';\n\n/**\n * @const {string}\n */\nconst ABORTED = 'AbortError';\n\n/**\n * The threshold for errors throttled because nothing can be done about\n * them, but we'd still like to report the rough number.\n * @const {number}\n */\nconst NON_ACTIONABLE_ERROR_THROTTLE_THRESHOLD = 0.001;\n\n/**\n * The threshold for errors throttled because nothing can be done about\n * them, but we'd still like to report the rough number.\n * @const {number}\n */\nconst USER_ERROR_THROTTLE_THRESHOLD = 0.1;\n\n/**\n * Chance to post to the new error reporting endpoint.\n * @const {number}\n */\nconst BETA_ERROR_REPORT_URL_FREQ = 0.1;\n\n/**\n * Collects error messages, so they can be included in subsequent reports.\n * That allows identifying errors that might be caused by previous errors.\n */\nlet accumulatedErrorMessages = self.__AMP_ERRORS || [];\n// Use a true global, to avoid multi-module inclusion issues.\nself.__AMP_ERRORS = accumulatedErrorMessages;\n\n/**\n * Pushes element into array, keeping at most the most recent limit elements\n *\n * @param {!Array<T>} array\n * @param {T} element\n * @param {number} limit\n * @template T\n */\nfunction pushLimit(array, element, limit) {\n  if (array.length >= limit) {\n    array.splice(0, array.length - limit + 1);\n  }\n  array.push(element);\n}\n\n/**\n * A wrapper around our exponentialBackoff, to lazy initialize it to avoid an\n * un-DCE'able side-effect.\n * @param {function()} work the function to execute after backoff\n * @return {number} the setTimeout id\n */\nlet reportingBackoff = function (work) {\n  // Set reportingBackoff as the lazy-created function. JS Vooodoooo.\n  reportingBackoff = exponentialBackoff(1.5);\n  return reportingBackoff(work);\n};\n\n/**\n * Attempts to stringify a value, falling back to String.\n * @param {*} value\n * @return {string}\n */\nfunction tryJsonStringify(value) {\n  try {\n    // Cast is fine, because we really don't care here. Just trying.\n    return JSON.stringify(/** @type {!JsonObject} */ (value));\n  } catch (e) {\n    return String(value);\n  }\n}\n\n/**\n * @param {!Window} win\n * @param {*} error\n * @param {!Element=} opt_associatedElement\n */\nexport function reportErrorForWin(win, error, opt_associatedElement) {\n  reportError(error, opt_associatedElement);\n  if (\n    error &&\n    !!win &&\n    isUserErrorMessage(error.message) &&\n    !isUserErrorEmbed(error.message)\n  ) {\n    reportErrorToAnalytics(/** @type {!Error} */ (error), win);\n  }\n}\n\n/**\n * Reports an error. If the error has an \"associatedElement\" property\n * the element is marked with the `i-amphtml-element-error` and displays\n * the message itself. The message is always send to the console.\n * If the error has a \"messageArray\" property, that array is logged.\n * This way one gets the native fidelity of the console for things like\n * elements instead of stringification.\n * @param {*} error\n * @param {!Element=} opt_associatedElement\n * @return {!Error}\n */\nexport function reportError(error, opt_associatedElement) {\n  try {\n    // Convert error to the expected type.\n    let isValidError;\n    if (error) {\n      if (error.message !== undefined) {\n        error = duplicateErrorIfNecessary(/** @type {!Error} */ (error));\n        isValidError = true;\n      } else {\n        const origError = error;\n        error = new Error(tryJsonStringify(origError));\n        error.origError = origError;\n      }\n    } else {\n      error = new Error('Unknown error');\n    }\n    // Report if error is not an expected type.\n    if (!isValidError && getMode().localDev && !getMode().test) {\n      setTimeout(function () {\n        const rethrow = new Error(\n          '_reported_ Error reported incorrectly: ' + error\n        );\n        throw rethrow;\n      });\n    }\n\n    if (error.reported) {\n      return /** @type {!Error} */ (error);\n    }\n    error.reported = true;\n\n    // `associatedElement` is used to add the i-amphtml-error class; in\n    // `#development=1` mode, it also adds `i-amphtml-element-error` to the\n    // element and sets the `error-message` attribute.\n    if (error.messageArray) {\n      const elIndex = findIndex(error.messageArray, (item) => item?.tagName);\n      if (elIndex > -1) {\n        error.associatedElement = error.messageArray[elIndex];\n      }\n    }\n    // Update element.\n    const element = opt_associatedElement || error.associatedElement;\n    if (element && element.classList) {\n      element.classList.add('i-amphtml-error');\n      if (getMode().development) {\n        element.classList.add('i-amphtml-element-error');\n        element.setAttribute('error-message', error.message);\n      }\n    }\n\n    // Report to console.\n    if (\n      self.console &&\n      (isUserErrorMessage(error.message) ||\n        !error.expected ||\n        getMode().localDev)\n    ) {\n      const output = console.error || console.log;\n      if (error.messageArray) {\n        output.apply(console, error.messageArray);\n      } else {\n        if (element) {\n          output.call(console, error.message, element);\n        } else if (!getMode().minified) {\n          output.call(console, error.stack);\n        } else {\n          output.call(console, error.message);\n        }\n      }\n    }\n    if (element && element.dispatchCustomEventForTesting) {\n      element.dispatchCustomEventForTesting(AmpEvents.ERROR, error.message);\n    }\n\n    // 'call' to make linter happy. And .call to make compiler happy\n    // that expects some @this.\n    onError['call'](self, undefined, undefined, undefined, undefined, error);\n  } catch (errorReportingError) {\n    setTimeout(function () {\n      throw errorReportingError;\n    });\n  }\n  return /** @type {!Error} */ (error);\n}\n\n/**\n * Returns an error for a cancellation of a promise.\n * @return {!Error}\n */\nexport function cancellation() {\n  return new Error(CANCELLED);\n}\n\n/**\n * @param {*} errorOrMessage\n * @return {boolean}\n */\nexport function isCancellation(errorOrMessage) {\n  if (!errorOrMessage) {\n    return false;\n  }\n  if (typeof errorOrMessage == 'string') {\n    return errorOrMessage.startsWith(CANCELLED);\n  }\n  if (typeof errorOrMessage.message == 'string') {\n    return errorOrMessage.message.startsWith(CANCELLED);\n  }\n  return false;\n}\n\n/**\n * Returns an error for component blocked by consent\n * @return {!Error}\n */\nexport function blockedByConsentError() {\n  return new Error(BLOCK_BY_CONSENT);\n}\n\n/**\n * @param {*} errorOrMessage\n * @return {boolean}\n */\nexport function isBlockedByConsent(errorOrMessage) {\n  if (!errorOrMessage) {\n    return false;\n  }\n  if (typeof errorOrMessage == 'string') {\n    return errorOrMessage.startsWith(BLOCK_BY_CONSENT);\n  }\n  if (typeof errorOrMessage.message == 'string') {\n    return errorOrMessage.message.startsWith(BLOCK_BY_CONSENT);\n  }\n  return false;\n}\n\n/**\n * Install handling of global unhandled exceptions.\n * @param {!Window} win\n */\nexport function installErrorReporting(win) {\n  win.onerror = /** @type {!Function} */ (onError);\n  win.addEventListener('unhandledrejection', (event) => {\n    if (\n      event.reason &&\n      (event.reason.message === CANCELLED ||\n        event.reason.message === BLOCK_BY_CONSENT ||\n        event.reason.message === ABORTED)\n    ) {\n      event.preventDefault();\n      return;\n    }\n    reportError(event.reason || new Error('rejected promise ' + event));\n  });\n}\n\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {*|undefined} error\n * @this {!Window|undefined}\n */\nfunction onError(message, filename, line, col, error) {\n  // Make an attempt to unhide the body but don't if the error is actually expected.\n  // eslint-disable-next-line local/no-invalid-this\n  if (this && this.document && (!error || !error.expected)) {\n    // eslint-disable-next-line local/no-invalid-this\n    makeBodyVisibleRecovery(this.document);\n  }\n  if (getMode().localDev || getMode().development || getMode().test) {\n    return;\n  }\n  let hasNonAmpJs = false;\n  try {\n    hasNonAmpJs = detectNonAmpJs(self);\n  } catch (ignore) {\n    // Ignore errors during error report generation.\n  }\n  if (hasNonAmpJs && Math.random() > 0.01) {\n    // Only report 1% of errors on pages with non-AMP JS.\n    // These errors can almost never be acted upon, but spikes such as\n    // due to buggy browser extensions may be helpful to notify authors.\n    return;\n  }\n  const data = getErrorReportData(\n    message,\n    filename,\n    line,\n    col,\n    error,\n    hasNonAmpJs\n  );\n  if (data) {\n    reportingBackoff(() => {\n      try {\n        return reportErrorToServerOrViewer(\n          // eslint-disable-next-line local/no-invalid-this\n          this,\n          /** @type {!JsonObject} */\n          (data)\n        ).catch(() => {\n          // catch async errors to avoid recursive errors.\n        });\n      } catch (e) {\n        // catch async errors to avoid recursive errors.\n      }\n    });\n  }\n}\n\n/**\n * Determines the error reporting endpoint which should be used.\n * If changing this URL, keep `docs/spec/amp-errors.md` in sync.\n * @return {string} error reporting endpoint URL.\n */\nfunction chooseReportingUrl_() {\n  return Math.random() < BETA_ERROR_REPORT_URL_FREQ\n    ? urls.betaErrorReporting\n    : urls.errorReporting;\n}\n\n/**\n * Passes the given error data to either server or viewer.\n * @param {!Window} win\n * @param {!JsonObject} data Data from `getErrorReportData`.\n * @return {Promise<undefined>}\n */\nexport function reportErrorToServerOrViewer(win, data) {\n  // Report the error to viewer if it has the capability. The data passed\n  // to the viewer is exactly the same as the data passed to the server\n  // below.\n\n  // Throttle reports from Stable by 90%.\n  if (data['pt'] && Math.random() < 0.9) {\n    return Promise.resolve();\n  }\n\n  return maybeReportErrorToViewer(win, data).then((reportedErrorToViewer) => {\n    if (!reportedErrorToViewer) {\n      const xhr = new XMLHttpRequest();\n      xhr.open('POST', chooseReportingUrl_(), true);\n      xhr.send(JSON.stringify(data));\n    }\n  });\n}\n\n/**\n * Passes the given error data to the viewer if the following criteria is met:\n * - The viewer is a trusted viewer\n * - The viewer has the `errorReporter` capability\n * - The AMP doc is in single doc mode\n * - The AMP doc is opted-in for error interception (`<html>` tag has the\n *   `report-errors-to-viewer` attribute)\n *\n * @param {!Window} win\n * @param {!JsonObject} data Data from `getErrorReportData`.\n * @return {!Promise<boolean>} `Promise<True>` if the error was sent to the\n *     viewer, `Promise<False>` otherwise.\n * @visibleForTesting\n */\nexport function maybeReportErrorToViewer(win, data) {\n  const ampdocService = Services.ampdocServiceFor(win);\n  if (!ampdocService.isSingleDoc()) {\n    return Promise.resolve(false);\n  }\n  const ampdocSingle = ampdocService.getSingleDoc();\n  const htmlElement = ampdocSingle.getRootNode().documentElement;\n  const docOptedIn = htmlElement.hasAttribute('report-errors-to-viewer');\n  if (!docOptedIn) {\n    return Promise.resolve(false);\n  }\n  const viewer = Services.viewerForDoc(ampdocSingle);\n  if (!viewer.hasCapability('errorReporter')) {\n    return Promise.resolve(false);\n  }\n  return viewer.isTrustedViewer().then((viewerTrusted) => {\n    if (!viewerTrusted) {\n      return false;\n    }\n    viewer.sendMessage('error', errorReportingDataForViewer(data));\n    return true;\n  });\n}\n\n/**\n * Strips down the error reporting data to a minimal set\n * to be sent to the viewer.\n * @param {!JsonObject} errorReportData\n * @return {!JsonObject}\n * @visibleForTesting\n */\nexport function errorReportingDataForViewer(errorReportData) {\n  return dict({\n    'm': errorReportData['m'], // message\n    'a': errorReportData['a'], // isUserError\n    's': errorReportData['s'], // error stack\n    'el': errorReportData['el'], // tagName\n    'ex': errorReportData['ex'], // expected error?\n    'v': errorReportData['v'], // runtime\n    'pt': errorReportData['pt'], // is pre-throttled\n  });\n}\n\n/**\n * @param {string|undefined}  message\n * @param {*|undefined} error\n * @return {string}\n */\nfunction buildErrorMessage_(message, error) {\n  if (error) {\n    if (error.message) {\n      message = error.message;\n    } else {\n      // This should never be a string, but sometimes it is.\n      message = String(error);\n    }\n  }\n  if (!message) {\n    message = 'Unknown error';\n  }\n\n  return message;\n}\n\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {*|undefined} error\n * @param {boolean} hasNonAmpJs\n * @return {!JsonObject|undefined} The data to post\n * visibleForTesting\n */\nexport function getErrorReportData(\n  message,\n  filename,\n  line,\n  col,\n  error,\n  hasNonAmpJs\n) {\n  message = buildErrorMessage_(message, error);\n  // An \"expected\" error is still an error, i.e. some features are disabled\n  // or not functioning fully because of it. However, it's an expected\n  // error. E.g. as is the case with some browser API missing (storage).\n  // Thus, the error can be classified differently by log aggregators.\n  // The main goal is to monitor that an \"expected\" error doesn't deteriorate\n  // over time. It's impossible to completely eliminate it.\n  let expected = !!(error && error.expected);\n  if (/_reported_/.test(message)) {\n    return;\n  }\n  if (message == CANCELLED) {\n    return;\n  }\n\n  const detachedWindow = !(self && self.window);\n  const throttleBase = Math.random();\n\n  // We throttle load errors and generic \"Script error.\" errors\n  // that have no information and thus cannot be acted upon.\n  if (\n    isLoadErrorMessage(message) ||\n    // See https://github.com/ampproject/amphtml/issues/7353\n    // for context.\n    message == 'Script error.' ||\n    // Window has become detached, really anything can happen\n    // at this point.\n    detachedWindow\n  ) {\n    expected = true;\n\n    if (throttleBase > NON_ACTIONABLE_ERROR_THROTTLE_THRESHOLD) {\n      return;\n    }\n  }\n\n  const isUserError = isUserErrorMessage(message);\n\n  // Only report a subset of user errors.\n  if (isUserError && throttleBase > USER_ERROR_THROTTLE_THRESHOLD) {\n    return;\n  }\n\n  // This is the App Engine app in\n  // https://github.com/ampproject/error-tracker\n  // It stores error reports via https://cloud.google.com/error-reporting/\n  // for analyzing production issues.\n  const data = /** @type {!JsonObject} */ (Object.create(null));\n  data['v'] = getMode().rtvVersion;\n  data['noAmp'] = hasNonAmpJs ? '1' : '0';\n  data['m'] = message.replace(USER_ERROR_SENTINEL, '');\n  data['a'] = isUserError ? '1' : '0';\n\n  // Errors are tagged with \"ex\" (\"expected\") label to allow loggers to\n  // classify these errors as benchmarks and not exceptions.\n  data['ex'] = expected ? '1' : '0';\n  data['dw'] = detachedWindow ? '1' : '0';\n\n  let runtime = '1p';\n  if (IS_SXG) {\n    runtime = 'sxg';\n    data['sxg'] = '1';\n  } else if (IS_ESM) {\n    runtime = 'esm';\n    data['esm'] = '1';\n  } else if (self.context && self.context.location) {\n    data['3p'] = '1';\n    runtime = '3p';\n  } else if (getMode().runtime) {\n    runtime = getMode().runtime;\n  }\n\n  data['rt'] = runtime;\n\n  // Add our a4a id if we are inabox\n  if (runtime === 'inabox') {\n    data['adid'] = getMode().a4aId;\n  }\n\n  // TODO(erwinm): Remove ca when all systems read `bt` instead of `ca` to\n  // identify js binary type.\n  data['ca'] = isCanary(self) ? '1' : '0';\n\n  // Pass binary type.\n  data['bt'] = getBinaryType(self);\n\n  if (self.location.ancestorOrigins && self.location.ancestorOrigins[0]) {\n    data['or'] = self.location.ancestorOrigins[0];\n  }\n  if (self.viewerState) {\n    data['vs'] = self.viewerState;\n  }\n  // Is embedded?\n  if (self.parent && self.parent != self) {\n    data['iem'] = '1';\n  }\n\n  if (self.AMP && self.AMP.viewer) {\n    const resolvedViewerUrl = self.AMP.viewer.getResolvedViewerUrl();\n    const messagingOrigin = self.AMP.viewer.maybeGetMessagingOrigin();\n    if (resolvedViewerUrl) {\n      data['rvu'] = resolvedViewerUrl;\n    }\n    if (messagingOrigin) {\n      data['mso'] = messagingOrigin;\n    }\n  }\n\n  const exps = [];\n  const experiments = experimentTogglesOrNull(self);\n  for (const exp in experiments) {\n    const on = experiments[exp];\n    exps.push(`${exp}=${on ? '1' : '0'}`);\n  }\n  data['exps'] = exps.join(',');\n\n  if (error) {\n    data['el'] = error.associatedElement?.tagName || 'u'; // Unknown\n\n    if (error.args) {\n      data['args'] = JSON.stringify(error.args);\n    }\n\n    if (!isUserError && !error.ignoreStack && error.stack) {\n      data['s'] = error.stack;\n    }\n\n    // TODO(jridgewell, #18574); Make sure error is always an object.\n    if (error.message) {\n      error.message += ' _reported_';\n    }\n  } else {\n    data['f'] = filename || '';\n    data['l'] = line || '';\n    data['c'] = col || '';\n  }\n  data['r'] = self.document ? self.document.referrer : '';\n  data['ae'] = accumulatedErrorMessages.join(',');\n  data['fr'] = self.location['originalHash'] || self.location.hash;\n\n  // TODO(https://github.com/ampproject/error-tracker/issues/129): Remove once\n  // all clients are serving a version with pre-throttling.\n  if (data['bt'] === 'production') {\n    // Setting this field allows the error reporting service to know that this\n    // error has already been pre-throttled for Stable, so it doesn't need to\n    // throttle again.\n    data['pt'] = '1';\n  }\n\n  pushLimit(accumulatedErrorMessages, message, 25);\n\n  return data;\n}\n\n/**\n * Returns true if it appears like there is non-AMP JS on the\n * current page.\n * @param {!Window} win\n * @return {boolean}\n * @visibleForTesting\n */\nexport function detectNonAmpJs(win) {\n  if (!win.document) {\n    return false;\n  }\n  const scripts = win.document.querySelectorAll('script[src]');\n  for (let i = 0; i < scripts.length; i++) {\n    if (!isProxyOrigin(scripts[i].src.toLowerCase())) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Resets accumulated error messages for testing\n */\nexport function resetAccumulatedErrorMessagesForTesting() {\n  accumulatedErrorMessages = [];\n}\n\n/**\n * @param {!Error} error\n * @param {!Window} win\n */\nexport function reportErrorToAnalytics(error, win) {\n  // Currently this can only be executed in a single-doc mode. Otherwise,\n  // it's not clear which ampdoc the event would belong too.\n  if (Services.ampdocServiceFor(win).isSingleDoc()) {\n    const vars = dict({\n      'errorName': error.name,\n      'errorMessage': error.message,\n    });\n    triggerAnalyticsEvent(\n      getRootElement_(win),\n      'user-error',\n      vars,\n      /** enableDataVars */ false\n    );\n  }\n}\n\n/**\n * @param {!Window} win\n * @return {!Element}\n * @private\n */\nfunction getRootElement_(win) {\n  const root = Services.ampdocServiceFor(win).getSingleDoc().getRootNode();\n  return dev().assertElement(root.documentElement || root.body || root);\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {cancellation} from '../../../src/error-reporting';\nimport {dev} from '../../../src/log';\nimport {listenOnce} from '../../../src/event-helper';\n\nconst TAG = 'local-viewer';\n\nexport class ViewerTracker {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @private */\n    this.ampdoc_ = ampdoc;\n\n    /** @private {?Promise} */\n    this.reportViewPromise_ = null;\n\n    /** @const @private {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(ampdoc.win);\n\n    /** @private @const {!../../../src/service/viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(ampdoc);\n  }\n\n  /**\n   * @param {time} timeToView\n   * @return {!Promise}\n   */\n  scheduleView(timeToView) {\n    this.reportViewPromise_ = null;\n    return this.ampdoc_.whenReady().then(() => {\n      return new Promise((resolve) => {\n        if (this.ampdoc_.isVisible()) {\n          resolve();\n        }\n        this.ampdoc_.onVisibilityChanged(() => {\n          if (this.ampdoc_.isVisible()) {\n            resolve();\n          }\n        });\n      }).then(() => this.reportWhenViewed_(timeToView));\n    });\n  }\n\n  /**\n   * @param {time} timeToView\n   * @return {!Promise}\n   * @private\n   */\n  reportWhenViewed_(timeToView) {\n    if (this.reportViewPromise_) {\n      return this.reportViewPromise_;\n    }\n    dev().fine(TAG, 'start view monitoring');\n    this.reportViewPromise_ = this.whenViewed_(timeToView).catch((reason) => {\n      // Ignore - view has been canceled.\n      dev().fine(TAG, 'view cancelled:', reason);\n      this.reportViewPromise_ = null;\n      throw reason;\n    });\n\n    return this.reportViewPromise_;\n  }\n\n  /**\n   * The promise will be resolved when a view of this document has occurred. It\n   * will be rejected if the current impression should not be counted as a view.\n   * @param {time} timeToView Pass the value of 0 when this method is called\n   *   as the result of the user action.\n   * @return {!Promise}\n   * @private\n   */\n  whenViewed_(timeToView) {\n    if (timeToView == 0) {\n      // Immediate view has been registered. This will happen when this method\n      // is called as the result of the user action.\n      return Promise.resolve();\n    }\n\n    // Viewing kick off: document is visible.\n    const unlistenSet = [];\n    return new Promise((resolve, reject) => {\n      // 1. Document becomes invisible again: cancel.\n      unlistenSet.push(\n        this.ampdoc_.onVisibilityChanged(() => {\n          if (!this.ampdoc_.isVisible()) {\n            reject(cancellation());\n          }\n        })\n      );\n\n      // 2. After a few seconds: register a view.\n      const timeoutId = this.timer_.delay(resolve, timeToView);\n      unlistenSet.push(() => this.timer_.cancel(timeoutId));\n\n      // 3. If scrolled: register a view.\n      unlistenSet.push(this.viewport_.onScroll(resolve));\n\n      // 4. Tap: register a view.\n      unlistenSet.push(\n        listenOnce(this.ampdoc_.getRootNode(), 'click', resolve)\n      );\n    }).then(\n      () => {\n        unlistenSet.forEach((unlisten) => unlisten());\n      },\n      (reason) => {\n        unlistenSet.forEach((unlisten) => unlisten());\n        throw reason;\n      }\n    );\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {closestAncestorElementBySelector} from '../core/dom/query';\nimport {waitForChildPromise} from '../dom';\n\n/**\n * Checks if an element descends from `amp-story` in order to configure\n * story-specific behavior.\n *\n * This utility has a tree-scanning cost.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function descendsFromStory(element) {\n  return !!closestAncestorElementBySelector(element, 'amp-story');\n}\n\n/**\n * Returns true if the document is an amp-story.\n * Times out after `timeout` ms (default is 2000).\n *\n * @param {!../service/ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<boolean>}\n */\nexport function isStoryDocument(ampdoc) {\n  return ampdoc.waitForBodyOpen().then(() => {\n    const body = ampdoc.getBody();\n    const childPromise = waitForChildPromise(\n      body,\n      () => !!body.firstElementChild\n    );\n    // 2s timeout for edge case where body has no element children.\n    return Services.timerFor(ampdoc.win)\n      .timeoutPromise(2000, childPromise)\n      .then(\n        () => body.firstElementChild.tagName === 'AMP-STORY',\n        () => false\n      );\n  });\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ActionStatus,\n  SubscriptionAnalytics,\n  SubscriptionAnalyticsEvents,\n} from './analytics';\nimport {CSS} from '../../../build/amp-subscriptions-0.1.css';\nimport {CryptoHandler} from './crypto-handler';\nimport {Dialog} from './dialog';\nimport {DocImpl} from './doc-impl';\nimport {ENTITLEMENTS_REQUEST_TIMEOUT} from './constants';\nimport {Entitlement, GrantReason} from './entitlement';\nimport {Metering} from './metering';\nimport {\n  PageConfig as PageConfigInterface,\n  PageConfigResolver,\n} from '../../../third_party/subscriptions-project/config';\nimport {PlatformStore} from './platform-store';\nimport {Renderer} from './renderer';\nimport {ServiceAdapter} from './service-adapter';\nimport {Services} from '../../../src/services';\nimport {SubscriptionPlatform as SubscriptionPlatformInterface} from './subscription-platform';\nimport {ViewerSubscriptionPlatform} from './viewer-subscription-platform';\nimport {ViewerTracker} from './viewer-tracker';\nimport {dev, devAssert, user, userAssert} from '../../../src/log';\nimport {dict, getValueForExpr} from '../../../src/core/types/object';\nimport {getMode} from '../../../src/mode';\nimport {getWinOrigin} from '../../../src/url';\nimport {installStylesForDoc} from '../../../src/style-installer';\nimport {isStoryDocument} from '../../../src/utils/story';\nimport {localSubscriptionPlatformFactory} from './local-subscription-platform';\nimport {tryParseJson} from '../../../src/core/types/object/json';\n\n/** @const */\nconst TAG = 'amp-subscriptions';\n\n/**\n * @implements {../../amp-access/0.1/access-vars.AccessVars}\n */\nexport class SubscriptionService {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    const configElement = ampdoc.getElementById(TAG);\n\n    /** @const @private */\n    this.ampdoc_ = ampdoc;\n\n    // Install styles.\n    installStylesForDoc(ampdoc, CSS, () => {}, false, TAG);\n\n    /**\n     * Resolves when page and platform configs are processed.\n     * @private {?Promise}\n     */\n    this.initialized_ = null;\n\n    /** @private @const {!Renderer} */\n    this.renderer_ = new Renderer(ampdoc);\n\n    /** @private {?PageConfigInterface} */\n    this.pageConfig_ = null;\n\n    /** @private {?JsonObject} */\n    this.platformConfig_ = null;\n\n    /** @private {?PlatformStore} */\n    this.platformStore_ = null;\n\n    /** @const @private {!Element} */\n    this.configElement_ = user().assertElement(configElement);\n\n    /** @private {!SubscriptionAnalytics} */\n    this.subscriptionAnalytics_ = new SubscriptionAnalytics(\n      this.configElement_\n    );\n\n    /** @private {!ServiceAdapter} */\n    this.serviceAdapter_ = new ServiceAdapter(this);\n\n    /** @private {!Dialog} */\n    this.dialog_ = new Dialog(ampdoc);\n\n    /** @private {!ViewerTracker} */\n    this.viewerTracker_ = new ViewerTracker(ampdoc);\n\n    /** @private @const {!../../../src/service/viewer-interface.ViewerInterface} */\n    this.viewer_ = Services.viewerForDoc(ampdoc);\n\n    /** @private {?Promise} */\n    this.viewTrackerPromise_ = null;\n\n    /** @const @private {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(ampdoc.win);\n\n    /**\n     * @private @const {boolean}\n     * View substitutes for other services and handles auth. Usually an app\n     * with a webview.\n     */\n    this.doesViewerProvideAuth_ = this.viewer_.hasCapability('auth');\n\n    /**\n     * @private @const {boolean}\n     * Viewer also does paywall/metering so on page \"local\" paywall is not shown.\n     */\n    this.doesViewerProvidePaywall_ =\n      this.doesViewerProvideAuth_ && this.viewer_.hasCapability('paywall');\n\n    /** @private @const {!Promise<!../../../src/service/cid-impl.CidDef>} */\n    this.cid_ = Services.cidForDoc(ampdoc);\n\n    /** @private {!Object<string, ?Promise<string>>} */\n    this.platformKeyToReaderIdPromiseMap_ = {};\n\n    /** @private {!CryptoHandler} */\n    this.cryptoHandler_ = new CryptoHandler(ampdoc);\n\n    /** @private {?Metering} */\n    this.metering_ = null;\n  }\n\n  /**\n   * Starts the `amp-subscriptions` extension.\n   * @return {SubscriptionService}\n   */\n  start() {\n    this.initialize_().then(() => {\n      this.subscriptionAnalytics_.event(SubscriptionAnalyticsEvents.STARTED);\n      this.renderer_.toggleLoading(true);\n\n      userAssert(this.pageConfig_, 'Page config is null');\n\n      if (this.doesViewerProvideAuth_) {\n        this.delegateAuthToViewer_();\n        this.startAuthorizationFlow_(false /** shouldActivatePlatform */);\n        return;\n      }\n\n      userAssert(\n        this.platformConfig_['services'],\n        'Services not configured in service config'\n      );\n\n      const platformKeys = this.platformConfig_['services'].map(\n        (service) => service['serviceId'] || 'local'\n      );\n\n      this.initializePlatformStore_(platformKeys);\n\n      /** @type {!Array} */ (this.platformConfig_['services']).forEach(\n        (service) => {\n          this.initializeLocalPlatforms_(service);\n        }\n      );\n\n      this.platformStore_\n        .getAvailablePlatforms()\n        .forEach((subscriptionPlatform) => {\n          this.fetchEntitlements_(subscriptionPlatform);\n        });\n\n      isStoryDocument(this.ampdoc_).then((isStory) => {\n        // Delegates the platform selection and activation call if is story.\n        this.startAuthorizationFlow_(!isStory /** shouldActivatePlatform */);\n      });\n    });\n    return this;\n  }\n\n  /** @override from AccessVars */\n  getAccessReaderId() {\n    return this.initialize_().then(() => this.getReaderId('local'));\n  }\n\n  /**\n   * Returns the analytics service for subscriptions.\n   * @return {!./analytics.SubscriptionAnalytics}\n   */\n  getAnalytics() {\n    return this.subscriptionAnalytics_;\n  }\n\n  /** @override from AccessVars */\n  getAuthdataField(field) {\n    return this.initialize_()\n      .then(() => this.platformStore_.getEntitlementPromiseFor('local'))\n      .then((entitlement) => getValueForExpr(entitlement.json(), field));\n  }\n\n  /**\n   * Returns the singleton Dialog instance\n   * @return {!Dialog}\n   */\n  getDialog() {\n    return this.dialog_;\n  }\n\n  /**\n   * Returns encrypted document key if it exists.\n   * This key is needed for requesting a different key\n   * that decrypts locked content on the page.\n   * @param {string} platformKey Who you want to decrypt the key.\n   *                             For example: 'google.com'\n   * @return {?string}\n   */\n  getEncryptedDocumentKey(platformKey) {\n    return this.cryptoHandler_.getEncryptedDocumentKey(platformKey);\n  }\n\n  /**\n   * Returns Page config\n   * @return {!PageConfigInterface}\n   */\n  getPageConfig() {\n    const pageConfig = devAssert(\n      this.pageConfig_,\n      'Page config is not yet fetched'\n    );\n    return /** @type {!PageConfigInterface} */ (pageConfig);\n  }\n\n  /**\n   * @param {string} platformKey\n   * @return {!Promise<string>}\n   */\n  getReaderId(platformKey) {\n    let readerIdPromise = this.platformKeyToReaderIdPromiseMap_[platformKey];\n    if (!readerIdPromise) {\n      const consent = Promise.resolve();\n      // Scope is kept \"amp-access\" by default to avoid unnecessary CID\n      // rotation.\n      const scope =\n        'amp-access' + (platformKey == 'local' ? '' : '-' + platformKey);\n      readerIdPromise = this.cid_.then((cid) =>\n        cid.get({scope, createCookieIfNotPresent: true}, consent)\n      );\n      this.platformKeyToReaderIdPromiseMap_[platformKey] = readerIdPromise;\n    }\n    return readerIdPromise;\n  }\n\n  /**\n   * Gets Score Factors for all platforms\n   * @return {!Promise<!JsonObject>}\n   */\n  getScoreFactorStates() {\n    return this.platformStore_.getScoreFactorStates();\n  }\n\n  /**\n   * This method registers an auto initialized subcription platform with this\n   * service.\n   *\n   * @param {string} platformKey\n   * @param {function(!JsonObject, !ServiceAdapter):!SubscriptionPlatformInterface} subscriptionPlatformFactory\n   * @return {!Promise}\n   */\n  registerPlatform(platformKey, subscriptionPlatformFactory) {\n    return this.initialize_().then(() => {\n      if (this.doesViewerProvideAuth_) {\n        return; // External platforms should not register if viewer provides auth\n      }\n      const matchedServices = this.platformConfig_['services'].filter(\n        (service) => (service.serviceId || 'local') === platformKey\n      );\n\n      const matchedServiceConfig = userAssert(\n        matchedServices[0],\n        'No matching services for the ID found'\n      );\n\n      const subscriptionPlatform = subscriptionPlatformFactory(\n        matchedServiceConfig,\n        this.serviceAdapter_\n      );\n\n      this.platformStore_.resolvePlatform(\n        subscriptionPlatform.getPlatformKey(),\n        subscriptionPlatform\n      );\n      this.subscriptionAnalytics_.serviceEvent(\n        SubscriptionAnalyticsEvents.PLATFORM_REGISTERED,\n        subscriptionPlatform.getPlatformKey()\n      );\n      // Deprecated event fired for backward compatibility\n      this.subscriptionAnalytics_.serviceEvent(\n        SubscriptionAnalyticsEvents.PLATFORM_REGISTERED_DEPRECATED,\n        subscriptionPlatform.getPlatformKey()\n      );\n      this.fetchEntitlements_(subscriptionPlatform);\n    });\n  }\n\n  /**\n   * Evaluates platforms and select the one to be selected for login.\n   * @return {!./subscription-platform.SubscriptionPlatform}\n   */\n  selectPlatformForLogin() {\n    return this.platformStore_.selectPlatformForLogin();\n  }\n\n  /**\n   * Returns promise that resolves when page and platform configs are processed.\n   * @return {!Promise}\n   * @private\n   */\n  initialize_() {\n    if (!this.initialized_) {\n      const doc = new DocImpl(this.ampdoc_);\n      const pageConfigResolver = new PageConfigResolver(doc);\n      this.initialized_ = Promise.all([\n        this.getPlatformConfig_(),\n        pageConfigResolver.resolveConfig(),\n      ])\n        .then((promiseValues) => {\n          /** @type {!JsonObject} */\n          this.platformConfig_ = promiseValues[0];\n          /** @type {!PageConfigInterface} */\n          this.pageConfig_ = promiseValues[1];\n        })\n        .then(() => {\n          this.maybeEnableMetering_();\n        });\n    }\n    return this.initialized_;\n  }\n\n  /**\n   * @param {!JsonObject} serviceConfig\n   * @private\n   */\n  initializeLocalPlatforms_(serviceConfig) {\n    if ((serviceConfig['serviceId'] || 'local') == 'local') {\n      this.platformStore_.resolvePlatform(\n        'local',\n        localSubscriptionPlatformFactory(\n          this.ampdoc_,\n          serviceConfig,\n          this.serviceAdapter_\n        )\n      );\n    }\n  }\n\n  /**\n   * @return {!Promise<!JsonObject>}\n   * @private\n   */\n  getPlatformConfig_() {\n    return new Promise((resolve) => {\n      const rawContent = tryParseJson(this.configElement_.textContent, (e) => {\n        throw user().createError(\n          'Failed to parse \"amp-subscriptions\" JSON: ',\n          e\n        );\n      });\n      resolve(rawContent);\n    });\n  }\n\n  /**\n   * @param {boolean} grantState\n   * @private\n   */\n  processGrantState_(grantState) {\n    // Hide loading animation.\n    this.renderer_.toggleLoading(false);\n\n    // Set Pingback viewer timer\n    this.viewTrackerPromise_ = this.viewerTracker_.scheduleView(2000);\n\n    // If the viewer is providing a paywall we don't want the publisher\n    // paywall to render in the case of no grant so we leave the page\n    // in the original \"unknown\" state.\n    if (this.doesViewerProvidePaywall_ && !grantState) {\n      return;\n    }\n\n    // Update UI.\n    this.renderer_.setGrantState(grantState);\n  }\n\n  /**\n   * @param {string} platformKey\n   * @param {!./entitlement.Entitlement} entitlement\n   * @private\n   */\n  resolveEntitlementsToStore_(platformKey, entitlement) {\n    this.platformStore_.resolveEntitlement(platformKey, entitlement);\n    if (entitlement.decryptedDocumentKey) {\n      this.cryptoHandler_.tryToDecryptDocument(\n        entitlement.decryptedDocumentKey\n      );\n    }\n    this.subscriptionAnalytics_.serviceEvent(\n      SubscriptionAnalyticsEvents.ENTITLEMENT_RESOLVED,\n      platformKey\n    );\n  }\n\n  /**\n   * Internal function to wrap SwG decryption handling\n   * @param {!SubscriptionPlatformInterface} platform\n   * @return {!Promise<?./entitlement.Entitlement>}\n   * @private\n   */\n  getEntitlements_(platform) {\n    return platform.getEntitlements().then((entitlements) => {\n      if (\n        entitlements &&\n        entitlements.granted &&\n        this.cryptoHandler_.isDocumentEncrypted() &&\n        !entitlements.decryptedDocumentKey\n      ) {\n        const logChannel =\n          platform.getPlatformKey() == 'local' ? user() : dev();\n        logChannel.error(\n          TAG,\n          `${platform.getPlatformKey()}: Subscription granted and encryption enabled, ` +\n            'but no decrypted document key returned.'\n        );\n        return null;\n      }\n      return entitlements;\n    });\n  }\n\n  /**\n   * @param {!SubscriptionPlatformInterface} subscriptionPlatform\n   * @return {!Promise}\n   */\n  fetchEntitlements_(subscriptionPlatform) {\n    // Don't fetch entitlements on free pages.\n    if (this.isPageFree_()) {\n      return Promise.resolve();\n    }\n\n    let timeout = ENTITLEMENTS_REQUEST_TIMEOUT;\n    if (getMode().development || getMode().localDev) {\n      timeout = ENTITLEMENTS_REQUEST_TIMEOUT * 2;\n    }\n    // Prerender safe platforms don't have to wait for the\n    // page to become visible, all others wait for whenFirstVisible()\n    const visiblePromise = subscriptionPlatform.isPrerenderSafe()\n      ? Promise.resolve()\n      : this.ampdoc_.whenFirstVisible();\n    return visiblePromise.then(() =>\n      this.timer_\n        .timeoutPromise(timeout, this.getEntitlements_(subscriptionPlatform))\n        .then((entitlement) => {\n          entitlement =\n            entitlement ||\n            Entitlement.empty(subscriptionPlatform.getPlatformKey());\n          this.resolveEntitlementsToStore_(\n            subscriptionPlatform.getPlatformKey(),\n            entitlement\n          );\n          return entitlement;\n        })\n        .catch((reason) => {\n          const platformKey = subscriptionPlatform.getPlatformKey();\n          this.platformStore_.reportPlatformFailureAndFallback(platformKey);\n          throw user().createError(\n            `fetch entitlements failed for ${platformKey}`,\n            reason\n          );\n        })\n    );\n  }\n\n  /**\n   * Initializes the PlatformStore with a list of platform keys.\n   * @param {!Array<string>} platformKeys\n   */\n  initializePlatformStore_(platformKeys) {\n    const fallbackEntitlement = this.platformConfig_['fallbackEntitlement']\n      ? Entitlement.parseFromJson(this.platformConfig_['fallbackEntitlement'])\n      : Entitlement.empty('local');\n    this.platformStore_ = new PlatformStore(\n      platformKeys,\n      this.platformConfig_['score'],\n      fallbackEntitlement\n    );\n    this.maybeAddFreeEntitlement_(this.platformStore_);\n  }\n\n  /**\n   * Delegates authentication to viewer\n   */\n  delegateAuthToViewer_() {\n    const platformKeys = ['local'];\n    const origin = getWinOrigin(this.ampdoc_.win);\n    this.initializePlatformStore_(platformKeys);\n\n    /** @type {!Array} */ (this.platformConfig_['services']).forEach(\n      (service) => {\n        if ((service['serviceId'] || 'local') == 'local') {\n          const viewerPlatform = new ViewerSubscriptionPlatform(\n            this.ampdoc_,\n            service,\n            this.serviceAdapter_,\n            origin\n          );\n          this.platformStore_.resolvePlatform('local', viewerPlatform);\n          this.getEntitlements_(viewerPlatform)\n            .then((entitlement) => {\n              devAssert(entitlement, 'Entitlement is null');\n              // Viewer authorization is redirected to use local platform instead.\n              this.resolveEntitlementsToStore_(\n                'local',\n                /** @type {!./entitlement.Entitlement}*/ (entitlement)\n              );\n            })\n            .catch((reason) => {\n              this.platformStore_.reportPlatformFailureAndFallback('local');\n              dev().error(TAG, 'Viewer auth failed:', reason);\n            });\n        }\n      }\n    );\n  }\n\n  /**\n   * Unblock document based on grant state and selected platform\n   * @param {boolean=} shouldActivatePlatform\n   * @return {!Promise}\n   * @private\n   */\n  startAuthorizationFlow_(shouldActivatePlatform = true) {\n    const grantStatusPromise = this.platformStore_.getGrantStatus();\n    const grantEntitlementPromise = this.platformStore_.getGrantEntitlement();\n    const promises = Promise.all([grantStatusPromise, grantEntitlementPromise]);\n\n    return promises.then((results) => {\n      const granted = results[0];\n      const entitlement = results[1];\n\n      // Create shortcut to continue authorization flow.\n      const continueAuthorizationFlow = () =>\n        this.handleGrantState_({granted, shouldActivatePlatform});\n\n      if (!this.metering_) {\n        // Move along. This article doesn't need AMP metering's logic.\n        continueAuthorizationFlow();\n        return;\n      }\n\n      // AMP metering's logic:\n      // - Granted?\n      //   - Yes.\n      //     - From AMP metering?\n      //       - Yes. Consume entitlements.\n      //       - No. Handle grant state normally.\n      //   - No.\n      //     - Have we fetched AMP metering entitlements before?\n      //       - Yes. Handle grant state normally.\n      //       - No.\n      //         - Do we have AMP metering state?\n      //           - Yes. Fetch metering entitlements.\n      //           - No. Show regwall.\n\n      const meteringPlatform = this.platformStore_.getPlatform(\n        this.metering_.platformKey\n      );\n\n      if (granted) {\n        const grantCameFromAmpMetering =\n          entitlement &&\n          entitlement.grantReason === GrantReason.METERING &&\n          entitlement.service === this.metering_.platformKey;\n\n        if (!grantCameFromAmpMetering) {\n          // Move along. AMP metering isn't responsible for this grant.\n          continueAuthorizationFlow();\n          return;\n        }\n\n        // Consume metering entitlements.\n        const finishAuthorizationFlow = () => {\n          this.handleGrantState_({\n            granted: true,\n            shouldActivatePlatform: false,\n          });\n        };\n        meteringPlatform.activate(\n          entitlement,\n          entitlement,\n          finishAuthorizationFlow\n        );\n        return;\n      }\n\n      if (this.metering_.entitlementsWereFetchedWithCurrentMeteringState) {\n        // Move along.\n        // The current metering state isn't granting.\n        continueAuthorizationFlow();\n        return;\n      }\n\n      // Ask metering platform to either (1) fetch entitlements or (2) show regwall.\n      this.metering_.loadMeteringState().then((meteringState) => {\n        if (meteringState) {\n          // Fetch metering entitlements.\n          this.resetPlatform(this.metering_.platformKey);\n        } else {\n          // Show regwall.\n          const emptyEntitlement = Entitlement.empty('local');\n          const restartAuthorizationFlow = () => this.startAuthorizationFlow_();\n          meteringPlatform.activate(\n            emptyEntitlement,\n            emptyEntitlement,\n            restartAuthorizationFlow\n          );\n        }\n      });\n    });\n  }\n\n  /**\n   * Handles grant status updates.\n   * @param {{\n   *   granted: boolean,\n   *   shouldActivatePlatform: boolean,\n   * }} params\n   * @private\n   */\n  handleGrantState_({granted, shouldActivatePlatform}) {\n    this.processGrantState_(granted);\n    this.performPingback_();\n\n    if (shouldActivatePlatform) {\n      this.selectAndActivatePlatform_();\n    }\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  selectAndActivatePlatform_() {\n    const requireValuesPromise = Promise.all([\n      this.platformStore_.getGrantStatus(),\n      this.platformStore_.selectPlatform(),\n      this.platformStore_.getGrantEntitlement(),\n    ]);\n\n    return requireValuesPromise.then((resolvedValues) => {\n      const selectedPlatform = resolvedValues[1];\n      const grantEntitlement = resolvedValues[2];\n      const selectedEntitlement = this.platformStore_.getResolvedEntitlementFor(\n        selectedPlatform.getPlatformKey()\n      );\n      const bestEntitlement = grantEntitlement || selectedEntitlement;\n\n      selectedPlatform.activate(selectedEntitlement, grantEntitlement);\n\n      this.subscriptionAnalytics_.serviceEvent(\n        SubscriptionAnalyticsEvents.PLATFORM_ACTIVATED,\n        selectedPlatform.getPlatformKey()\n      );\n      // Deprecated events are fire for backwards compatibility\n      this.subscriptionAnalytics_.serviceEvent(\n        SubscriptionAnalyticsEvents.PLATFORM_ACTIVATED_DEPRECATED,\n        selectedPlatform.getPlatformKey()\n      );\n      if (bestEntitlement.granted) {\n        this.subscriptionAnalytics_.serviceEvent(\n          SubscriptionAnalyticsEvents.ACCESS_GRANTED,\n          bestEntitlement.service\n        );\n      } else {\n        this.subscriptionAnalytics_.serviceEvent(\n          SubscriptionAnalyticsEvents.PAYWALL_ACTIVATED,\n          selectedPlatform.getPlatformKey()\n        );\n        this.subscriptionAnalytics_.serviceEvent(\n          SubscriptionAnalyticsEvents.ACCESS_DENIED,\n          selectedPlatform.getPlatformKey()\n        );\n      }\n    });\n  }\n\n  /**\n   * Performs pingback on configured platforms.\n   * @return {?Promise}\n   * @private\n   */\n  performPingback_() {\n    if (this.viewTrackerPromise_) {\n      return this.viewTrackerPromise_.then(() => {\n        this.platformStore_\n          .getAvailablePlatforms()\n          .forEach((subscriptionPlatform) => {\n            // Iterate the platforms and pingback if it's enabled on that platform\n            if (subscriptionPlatform.isPingbackEnabled()) {\n              // Platforms can choose if they want all entitlements\n              // or just the granting entitlement\n              if (subscriptionPlatform.pingbackReturnsAllEntitlements()) {\n                this.platformStore_\n                  .getAllPlatformsEntitlements()\n                  .then((resolvedEntitlments) =>\n                    subscriptionPlatform.pingback(resolvedEntitlments)\n                  );\n              } else {\n                this.platformStore_\n                  .getGrantEntitlement()\n                  .then((grantStateEntitlement) =>\n                    subscriptionPlatform.pingback(\n                      grantStateEntitlement || Entitlement.empty('local')\n                    )\n                  );\n              }\n            }\n          });\n      });\n    }\n    return null;\n  }\n\n  /**\n   * Reset all platforms and re-fetch entitlements after an\n   * external event (for example a login)\n   */\n  resetPlatforms() {\n    this.platformStore_ = this.platformStore_.resetPlatformStore();\n    this.renderer_.toggleLoading(true);\n\n    if (this.metering_) {\n      this.metering_.entitlementsWereFetchedWithCurrentMeteringState = false;\n    }\n\n    this.platformStore_\n      .getAvailablePlatforms()\n      .forEach((subscriptionPlatform) => {\n        this.fetchEntitlements_(subscriptionPlatform);\n      });\n    this.subscriptionAnalytics_.serviceEvent(\n      SubscriptionAnalyticsEvents.PLATFORM_REAUTHORIZED,\n      ''\n    );\n    // deprecated event fired for backward compatibility\n    this.subscriptionAnalytics_.serviceEvent(\n      SubscriptionAnalyticsEvents.PLATFORM_REAUTHORIZED_DEPRECATED,\n      ''\n    );\n    this.startAuthorizationFlow_();\n  }\n\n  /**\n   * Resets a platform and re-fetches its entitlements.\n   * @param {string} platformId\n   */\n  resetPlatform(platformId) {\n    // Show loading UX.\n    this.renderer_.toggleLoading(true);\n    this.platformStore_.resetPlatform(platformId);\n\n    // Re-fetch entitlements.\n    const platform = this.platformStore_.getPlatform(platformId);\n    this.fetchEntitlements_(platform);\n\n    // Start auth flow.\n    this.startAuthorizationFlow_();\n  }\n\n  /**\n   * Delegates an action to local platform.\n   * @param {string} action\n   * @param {?string} sourceId\n   * @return {!Promise<boolean>}\n   */\n  delegateActionToLocal(action, sourceId) {\n    return this.delegateActionToService(action, 'local', sourceId);\n  }\n\n  /**\n   * Delegates an action to specified platform.\n   * @param {string} action\n   * @param {string} platformKey\n   * @param {?string} sourceId\n   * @return {!Promise<boolean>}\n   */\n  delegateActionToService(action, platformKey, sourceId = null) {\n    return new Promise((resolve) => {\n      this.platformStore_.onPlatformResolves(platformKey, (platform) => {\n        devAssert(platform, 'Platform is not registered');\n        this.subscriptionAnalytics_.event(\n          SubscriptionAnalyticsEvents.ACTION_DELEGATED,\n          dict({\n            'action': action,\n            'serviceId': platformKey,\n          }),\n          dict({\n            'action': action,\n            'status': ActionStatus.STARTED,\n          })\n        );\n        resolve(platform.executeAction(action, sourceId));\n      });\n    });\n  }\n\n  /**\n   * Delegate UI decoration to another service.\n   * @param {!Element} element\n   * @param {string} platformKey\n   * @param {string} action\n   * @param {?JsonObject} options\n   */\n  decorateServiceAction(element, platformKey, action, options) {\n    this.platformStore_.onPlatformResolves(platformKey, (platform) => {\n      devAssert(platform, 'Platform is not registered');\n      platform.decorateUI(element, action, options);\n    });\n  }\n\n  /**\n   * Adds entitlement on free pages.\n   * @param {PlatformStore} platformStore\n   * @private\n   */\n  maybeAddFreeEntitlement_(platformStore) {\n    if (!this.isPageFree_()) {\n      return;\n    }\n\n    platformStore.resolveEntitlement(\n      'local',\n      new Entitlement({\n        source: '',\n        raw: '',\n        granted: true,\n        grantReason: GrantReason.FREE,\n        dataObject: {},\n      })\n    );\n  }\n\n  /**\n   * Returns true if page is free.\n   * @return {boolean}\n   * @private\n   */\n  isPageFree_() {\n    return !this.pageConfig_.isLocked() || this.platformConfig_['alwaysGrant'];\n  }\n\n  /**\n   * Enables metering, if a platform needs it.\n   * @private\n   */\n  maybeEnableMetering_() {\n    const {services} = this.platformConfig_;\n    const meteringPlatform = services.find(\n      (service) => service['enableMetering']\n    );\n\n    if (meteringPlatform) {\n      this.metering_ = new Metering({\n        platformKey: meteringPlatform.serviceId,\n      });\n    }\n  }\n}\n\n// Register the `amp-subscriptions` extension.\nAMP.extension(TAG, '0.1', (AMP) => {\n  AMP.registerServiceForDoc('subscriptions', function (ampdoc) {\n    return new SubscriptionService(ampdoc).start();\n  });\n});\n"],
  "mappings": "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",
  "names": []
}
