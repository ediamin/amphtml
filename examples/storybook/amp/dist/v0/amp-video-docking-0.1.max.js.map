{
  "version": 3,
  "sources": ["../../src/core/data-structures/promise.js", "../../src/core/types/array.js", "../../src/core/types/object/index.js", "../../src/core/error/message-helpers.js", "../../src/core/constants/action-constants.js", "../../build/amp-video-docking-0.1.css.js", "../../src/internal-version.js", "../../src/core/types/string/url.js", "../../src/mode.js", "../../src/core/types/function/index.js", "../../src/config.js", "../../src/log.js", "../../third_party/css-escape/css-escape.js", "../../src/core/dom/css-selectors.js", "../../src/core/dom/query.js", "../../src/core/window/index.js", "../../src/dom.js", "../../src/video-interface.js", "../../src/service.js", "../../src/service/extension-script.js", "../../src/element-service.js", "../../src/services.js", "../../extensions/amp-video-docking/0.1/timeout.js", "../../extensions/amp-video-docking/0.1/events.js", "../../extensions/amp-video-docking/0.1/breakpoints.js", "../../src/core/dom/event-helper-listen.js", "../../src/event-helper.js", "../../src/static-template.js", "../../src/core/math/layout-rect.js", "../../src/style.js", "../../extensions/amp-video-docking/0.1/controls.js", "../../extensions/amp-video-docking/0.1/def.js", "../../src/core/math/index.js", "../../extensions/amp-video-docking/0.1/math.js", "../../extensions/amp-video-docking/0.1/viewport-rect.js", "../../src/utils/video.js", "../../src/style-installer.js", "../../extensions/amp-video-docking/0.1/amp-video-docking.js"],
  "sourcesContent": ["/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nlet resolved;\n\n/**\n * Returns a cached resolved promise.\n * Babel converts direct calls to Promise.resolve() (with no arguments) into\n * calls to this.\n *\n * @return {!Promise<undefined>}\n */\nexport function resolvedPromise() {\n  if (resolved) {\n    return resolved;\n  }\n\n  // It's important that we call with `undefined` here, to prevent a transform\n  // recursion. If we didn't pass an arg, then the transformer would replace\n  // this callsite with a call to `resolvedPromise()`.\n  resolved = Promise.resolve(undefined);\n  return resolved;\n}\n\n/**\n * Returns a Deferred struct, which holds a pending promise and its associated\n * resolve and reject functions.\n *\n * This is preferred instead of creating a Promise instance to extract the\n * resolve/reject functions yourself:\n *\n * ```\n * // Avoid doing\n * let resolve;\n * const promise = new Promise(res => {\n *   resolve = res;\n * });\n *\n * // Good\n * const deferred = new Deferred();\n * const { promise, resolve } = deferred;\n * ```\n *\n * @template T\n */\nexport class Deferred {\n  /** Constructor. */\n  constructor() {\n    /** @const {!Promise<T>} */\n    this.promise = new /*OK*/ Promise((res, rej) => {\n      /** @const {function(T=)} */\n      this.resolve = res;\n      /** @const {function(*=)} */\n      this.reject = rej;\n    });\n  }\n}\n\n/**\n * Creates a promise resolved to the return value of fn.\n * If fn sync throws, it will cause the promise to reject.\n *\n * @param {function():T} fn\n * @return {!Promise<T>}\n * @template T\n */\nexport function tryResolve(fn) {\n  return new Promise((resolve) => {\n    resolve(fn());\n  });\n}\n\n/**\n * Resolves with the result of the last promise added.\n * @implements {IThenable}\n */\nexport class LastAddedResolver {\n  /**\n   * @param {!Array<!IThenable>=} opt_promises\n   */\n  constructor(opt_promises) {\n    /** @private @const {!Deferred} */\n    this.deferred_ = new Deferred();\n\n    /** @private */\n    this.count_ = 0;\n\n    if (opt_promises) {\n      for (const promise of opt_promises) {\n        this.add(promise);\n      }\n    }\n  }\n\n  /**\n   * Add a promise to possibly be resolved.\n   * @param {!IThenable} promise\n   * @return {!Promise}\n   */\n  add(promise) {\n    const countAtAdd = ++this.count_;\n    promise.then(\n      (result) => {\n        if (this.count_ === countAtAdd) {\n          this.deferred_.resolve(result);\n        }\n      },\n      (error) => {\n        // Don't follow behavior of Promise.all and Promise.race error so that\n        // this will only reject when most recently added promise fails.\n        if (this.count_ === countAtAdd) {\n          this.deferred_.reject(error);\n        }\n      }\n    );\n    return this.deferred_.promise;\n  }\n\n  /** @override */\n  then(opt_resolve, opt_reject) {\n    return this.deferred_.promise.then(opt_resolve, opt_reject);\n  }\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Converts an array-like object to an array.\n * @param {?IArrayLike<T>|string} arrayLike\n * @return {!Array<T>}\n * @template T\n */\nexport function toArray(arrayLike) {\n  return arrayLike ? Array.prototype.slice.call(arrayLike) : [];\n}\n\n/**\n * Determines if value is actually an Array.\n * @param {*} value\n * @return {boolean}\n */\nexport const {isArray} = Array;\n\n/**\n * If the specified argument is an array, it's returned as is. If it's a\n * single item, the array containing this item is created and returned.\n *\n * The double-template pattern here solves a bug where CC can be passed a value\n * with declared type {string|!Array<string>} and return a value with a type of\n * {!Array<string|Array<string>>}.\n *\n * @param {!Array<T>|S} arrayOrSingleItem\n * @return {!Array<T>|!Array<S>}\n * @template S\n * @template T\n */\nexport function arrayOrSingleItemToArray(arrayOrSingleItem) {\n  return isArray(arrayOrSingleItem)\n    ? /** @type {!Array<T>} */ (arrayOrSingleItem)\n    : [/** @type {!S} */ (arrayOrSingleItem)];\n}\n\n/**\n * Compares if two arrays contains exactly same elements of same number\n * of same order. Note that it does NOT handle NaN case as expected.\n *\n * @param {!Array<T>} arr1\n * @param {!Array<T>} arr2\n * @return {boolean}\n * @template T\n */\nexport function areEqualOrdered(arr1, arr2) {\n  if (arr1.length !== arr2.length) {\n    return false;\n  }\n  for (let i = 0; i < arr1.length; i++) {\n    if (arr1[i] !== arr2[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Removes elements that shouldRemove returns true for from the array.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} shouldRemove\n * @return {!Array<T>}\n * @template T\n */\nexport function remove(array, shouldRemove) {\n  const removed = [];\n  let index = 0;\n  for (let i = 0; i < array.length; i++) {\n    const item = array[i];\n    if (shouldRemove(item, i, array)) {\n      removed.push(item);\n    } else {\n      if (index < i) {\n        array[index] = item;\n      }\n      index++;\n    }\n  }\n  if (index < array.length) {\n    array.length = index;\n  }\n  return removed;\n}\n\n/**\n * Returns the index of the first element matching the predicate.\n * Like Array#findIndex.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} predicate\n * @return {number}\n * @template T\n */\nexport function findIndex(array, predicate) {\n  for (let i = 0; i < array.length; i++) {\n    if (predicate(array[i], i, array)) {\n      return i;\n    }\n  }\n  return -1;\n}\n\n/**\n * Converts the given iterator to an array.\n *\n * @param {!Iterator<T>} iterator\n * @return {Array<T>}\n * @template T\n */\nexport function fromIterator(iterator) {\n  const array = [];\n  for (let e = iterator.next(); !e.done; e = iterator.next()) {\n    array.push(e.value);\n  }\n  return array;\n}\n\n/**\n * Adds item to array if it is not already present.\n *\n * @param {Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function pushIfNotExist(array, item) {\n  if (array.indexOf(item) < 0) {\n    array.push(item);\n    return true;\n  }\n  return false;\n}\n\n/**\n * Removes the first matching item in the array. Returns `true` if the array\n * has changed.\n *\n * @param {!Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function removeItem(array, item) {\n  const index = array.indexOf(item);\n  if (index == -1) {\n    return false;\n  }\n  array.splice(index, 1);\n  return true;\n}\n\n/**\n * Returns the last item in an array.\n *\n * @param {Array<T>} array\n * @template T\n * @return {?T}\n */\nexport function lastItem(array) {\n  return array[array.length - 1];\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* @const */\nconst {hasOwnProperty: hasOwn_, toString: toString_} = Object.prototype;\n\n/**\n * Determines if value is actually an Object.\n * @param {*} value\n * @return {boolean}\n */\nexport function isObject(value) {\n  return toString_.call(value) === '[object Object]';\n}\n\n/**\n * Returns a map-like object.\n * If opt_initial is provided, copies its own properties into the\n * newly created object.\n * @param {T=} opt_initial This should typically be an object literal.\n * @return {T}\n * @template T\n */\nexport function map(opt_initial) {\n  const obj = Object.create(null);\n  if (opt_initial) {\n    Object.assign(obj, opt_initial);\n  }\n  return obj;\n}\n\n/**\n * Return an empty JsonObject or makes the passed in object literal\n * an JsonObject.\n * The JsonObject type is just a simple object that is at-dict.\n * See\n * https://github.com/google/closure-compiler/wiki/@struct-and-@dict-Annotations\n * for what a dict is type-wise.\n * The linter enforces that the argument is, in fact, at-dict like.\n * @param {!Object=} opt_initial\n * @return {!JsonObject}\n */\nexport function dict(opt_initial) {\n  // We do not copy. The linter enforces that the passed in object is a literal\n  // and thus the caller cannot have a reference to it.\n  return /** @type {!JsonObject} */ (opt_initial || {});\n}\n\n/**\n * Checks if the given key is a property in the map.\n *\n * @param {T}  obj a map like property.\n * @param {string}  key\n * @return {boolean}\n * @template T\n */\nexport function hasOwn(obj, key) {\n  return hasOwn_.call(obj, key);\n}\n\n/**\n * Returns obj[key] iff key is obj's own property (is not inherited).\n * Otherwise, returns undefined.\n *\n * @param {Object} obj\n * @param {string} key\n * @return {*}\n */\nexport function ownProperty(obj, key) {\n  if (hasOwn(obj, key)) {\n    return obj[key];\n  } else {\n    return undefined;\n  }\n}\n\n/**\n * Deep merges source into target.\n *\n * @param {!Object} target\n * @param {!Object} source\n * @param {number} depth The maximum merge depth. If exceeded, Object.assign\n *                       will be used instead.\n * @return {!Object}\n * @throws {Error} If source contains a circular reference.\n * Note: Only nested objects are deep-merged, primitives and arrays are not.\n */\nexport function deepMerge(target, source, depth = 10) {\n  // Keep track of seen objects to detect recursive references.\n  const seen = [];\n\n  /** @type {!Array<{t: !Object, s: !Object, d: number}>} */\n  const queue = [];\n  queue.push({t: target, s: source, d: 0});\n\n  // BFS to ensure objects don't have recursive references at shallower depths.\n  while (queue.length > 0) {\n    const {d, s, t} = queue.shift();\n    if (seen.includes(s)) {\n      throw new Error('Source object has a circular reference.');\n    }\n    seen.push(s);\n    if (t === s) {\n      continue;\n    }\n    if (d > depth) {\n      Object.assign(t, s);\n      continue;\n    }\n    for (const key of Object.keys(s)) {\n      const newValue = s[key];\n      // Perform a deep merge IFF both target and source have the same key\n      // whose corresponding values are objects.\n      if (hasOwn(t, key)) {\n        const oldValue = t[key];\n        if (isObject(newValue) && isObject(oldValue)) {\n          queue.push({t: oldValue, s: newValue, d: d + 1});\n          continue;\n        }\n      }\n      t[key] = newValue;\n    }\n  }\n  return target;\n}\n\n/**\n * @param {!Object} o An object to remove properties from\n * @param {!Array<string>} props A list of properties to remove from the Object\n * @return {!Object} An object with the given properties removed\n */\nexport function omit(o, props) {\n  return Object.keys(o).reduce((acc, key) => {\n    if (!props.includes(key)) {\n      acc[key] = o[key];\n    }\n    return acc;\n  }, {});\n}\n\n/**\n * @param {!Object|null|undefined} o1\n * @param {!Object|null|undefined} o2\n * @return {boolean}\n */\nexport function objectsEqualShallow(o1, o2) {\n  if (o1 == null || o2 == null) {\n    // Null is only equal to null, and undefined to undefined.\n    return o1 === o2;\n  }\n\n  for (const k in o1) {\n    if (o1[k] !== o2[k]) {\n      return false;\n    }\n  }\n  for (const k in o2) {\n    if (o2[k] !== o1[k]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\n/**\n * @param {T} obj\n * @param {string} prop\n * @param {function(T, string):R} factory\n * @return {R}\n * @template T,R\n */\nexport function memo(obj, prop, factory) {\n  let result = /** @type {?R} */ (obj[prop]);\n  if (result === undefined) {\n    result = factory(obj, prop);\n    obj[prop] = result;\n  }\n  return result;\n}\n\n/**\n * Recreates objects with prototype-less copies.\n * @param {!JsonObject} obj\n * @return {!JsonObject}\n */\nexport function recreateNonProtoObject(obj) {\n  const copy = map();\n  for (const k in obj) {\n    if (!hasOwn(obj, k)) {\n      continue;\n    }\n    const v = obj[k];\n    copy[k] = isObject(v) ? recreateNonProtoObject(v) : v;\n  }\n  return /** @type {!JsonObject} */ (copy);\n}\n\n/**\n * Returns a value from an object for a field-based expression. The expression\n * is a simple nested dot-notation of fields, such as `field1.field2`. If any\n * field in a chain does not exist or is not an object or array, the returned\n * value will be `undefined`.\n *\n * @param {!JsonObject} obj\n * @param {string} expr\n * @return {*}\n */\nexport function getValueForExpr(obj, expr) {\n  // The `.` indicates \"the object itself\".\n  if (expr == '.') {\n    return obj;\n  }\n  // Otherwise, navigate via properties.\n  const parts = expr.split('.');\n  let value = obj;\n  for (const part of parts) {\n    if (\n      part &&\n      value &&\n      value[part] !== undefined &&\n      typeof value == 'object' &&\n      hasOwn(value, part)\n    ) {\n      value = value[part];\n      continue;\n    }\n    value = undefined;\n    break;\n  }\n  return value;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isElement} from '../types';\n\n/**\n * Triple zero width space.\n *\n * This is added to user error messages, so that we can later identify\n * them, when the only thing that we have is the message. This is the\n * case in many browsers when the global exception handler is invoked.\n *\n * @const {string}\n */\nexport const USER_ERROR_SENTINEL = '\\u200B\\u200B\\u200B';\n\n/**\n * Converts an element to a readable string; all other types are unchanged.\n * TODO(rcebulko): Unify with log.js\n * @param {*} val\n * @return {*}\n */\nexport function elementStringOrPassThru(val) {\n  // Do check equivalent to `val instanceof Element` without cross-window bug\n  if (isElement(val)) {\n    val = /** @type {Element} */ (val);\n    return val.tagName.toLowerCase() + (val.id ? `#${val.id}` : '');\n  }\n  return val;\n}\n\n/**\n * Tests if an error message contains the user sentinel.\n * @param {string} message\n * @return {boolean} Whether this message was a user error.\n */\nexport function isUserErrorMessage(message) {\n  return message.indexOf(USER_ERROR_SENTINEL) >= 0;\n}\n\n/**\n * Strips the user error sentinel from an error message.\n * @param {string} message\n * @return {string} The new message without USER_ERROR_SENTINEL\n */\nexport function stripUserError(message) {\n  return message.replace(USER_ERROR_SENTINEL, '');\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../assert';\n\n/**\n * Key string in an action arguments map for an unparsed object literal string.\n *\n * E.g. for the action in <p on=\"tap:AMP.setState({foo: 'bar'})\",\n * then `args[RAW_OBJECT_ARGS_KEY]` is the string \"{foo: 'bar'}\".\n *\n * The action service delegates parsing of object literals to the corresponding\n * extension (in the example above, amp-bind).\n *\n * @see ./service/action-impl.ActionInfoDef\n * @const {string}\n */\nexport const RAW_OBJECT_ARGS_KEY = '__AMP_OBJECT_STRING__';\n\n/**\n * Identifier for an element's default action.\n *\n * @const {string}\n */\nexport const DEFAULT_ACTION = 'activate';\n\n/**\n * Corresponds to degree of user intent, i.e. events triggered with strong\n * user intent have high trust.\n *\n * @enum {number}\n */\nexport const ActionTrust = {\n  /**\n   * Events that are triggered without a user gesture, or triggered by a user\n   * gesture with weak intent (e.g. scroll) are \"low trust\".\n   *\n   * Actions that have low impact on the page's visual state should require\n   * \"low trust\" (e.g. pausing a video).\n   */\n  LOW: 1,\n  /**\n   * Events that are triggered nearly immediately (up to a few seconds) after\n   * a user gesture with strong intent (e.g. tap or swipe) are \"default trust\".\n   *\n   * Actions that can modify the page's visual state (e.g. content jumping)\n   * should require \"default trust\". This is the default required trust level\n   * for actions.\n   */\n  DEFAULT: 2,\n  /**\n   * Events that are triggered immediately after a user gesture with\n   * strong intent (e.g. tap or swipe) are \"high trust\".\n   *\n   * There are no actions yet that require high trust.\n   */\n  HIGH: 3,\n};\n\n/**\n * @param {!ActionTrust} actionTrust\n * @return {string}\n */\nexport function actionTrustToString(actionTrust) {\n  switch (actionTrust) {\n    case ActionTrust.LOW:\n      return 'low';\n    case ActionTrust.HIGH:\n      return 'high';\n    default:\n      devAssert(actionTrust === ActionTrust.DEFAULT);\n      return 'default';\n  }\n}\n", "export const CSS = \".amp-video-docked-controls{direction:ltr!important;opacity:0;pointer-events:none!important;transition:opacity 0.3s ease;height:120px}.amp-video-docked-main-button-group{height:40px;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;margin:-20px 0 0 -60px}.amp-large>.amp-video-docked-main-button-group{margin-left:-70px}.amp-large>.amp-video-docked-main-button-group>.amp-video-docked-button-group{margin-right:10px}.amp-large>.amp-video-docked-control-set-scroll-back,.amp-small>.amp-video-docked-control-set-scroll-back{margin-left:-32px}.amp-large>.amp-video-docked-control-set-scroll-back>.amp-video-docked-button-group{margin-right:0}.amp-large>.amp-video-docked-button-dismiss-group{margin:6px 0 0 -6px}.amp-small>.amp-video-docked-button-dismiss-group,.amp-small>.amp-video-docked-button-dismiss-group>div[role=button]{min-width:32px;height:32px;border-radius:32px;background-size:20px 20px}.amp-small>.amp-video-docked-button-dismiss-group{margin-left:8px}.amp-video-docked-controls-shown{opacity:1;pointer-events:initial!important}.amp-video-docked-button-group{margin:0}.amp-video-docked-button-dismiss-group,.amp-video-docked-button-dismiss-group>div[role=button],.amp-video-docked-button-group,.amp-video-docked-button-group>div[role=button]{min-width:40px;height:40px;border-radius:40px}.amp-video-docked-button-dismiss-group:active,.amp-video-docked-button-group:active{background-color:hsla(0,0%,100%,0.7)}.amp-video-docked-button-dismiss-group>div[role=button],.amp-video-docked-button-group,.amp-video-docked-button-group>div[role=button],.amp-video-docked-controls,.i-amphtml-video-docked-overlay{-webkit-tap-highlight-color:rgba(0,0,0,0)!important}.amp-video-docked-button-dismiss-group>div[role=button],.amp-video-docked-button-group>div[role=button]{background-repeat:no-repeat;background-position:50%}.amp-video-docked-shadow{box-shadow:0px 0 20px 6px rgba(0,0,0,0.2);transition-property:transform,opacity!important}.amp-video-docked-controls-bg{background:hsla(0,0%,90%,0.6)}.amp-video-docked-mute{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M3 9v6h4l5 5V4L7 9H3zm13.5 3A4.5 4.5 0 0 0 14 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")}.amp-video-docked-unmute{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M16.5 12A4.5 4.5 0 0 0 14 7.97v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51A8.796 8.796 0 0 0 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3 3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06a8.99 8.99 0 0 0 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4 9.91 6.09 12 8.18V4z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")}.amp-video-docked-pause{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M6 19h4V5H6v14zm8-14v14h4V5h-4z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")}.amp-video-docked-play{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M8 5v14l11-7z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")}.amp-video-docked-fullscreen{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z'/%3E%3C/svg%3E\\\")}.amp-video-docked-dismiss{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E\\\")}.amp-video-docked-scroll-back{background-size:50%}.amp-rtl .amp-video-docked-scroll-back,.amp-video-docked-scroll-back{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath d='M-4-4h48v48H-4z'/%3E%3Cpath d='M36 0c2.2 0 4 1.8 4 4v24c0 2.2-1.8 4-4 4H12c-2.2 0-4-1.8-4-4V4c0-2.2 1.8-4 4-4h24zM16 11.868l12.618 12.618 2.829-2.828L18.789 9H27V5H12v15h4v-8.132zM4 8H0v28c0 2.2 1.8 4 4 4h28v-4H4V8z' fill='%23000' fill-rule='nonzero'/%3E%3C/g%3E%3C/svg%3E\\\")}.amp-video-docked-control-set-scroll-back>.amp-video-docked-button-group,.amp-video-docked-control-set-scroll-back>.amp-video-docked-button-group>div[role=button]{min-width:64px;height:64px}.amp-video-docked-shadow,.i-amphtml-video-docked,.i-amphtml-video-docked-overlay{margin:0!important}.i-amphtml-video-docked{transition-property:transform!important}.amp-video-docked-controls,.amp-video-docked-shadow,.i-amphtml-video-docked,.i-amphtml-video-docked-overlay{position:fixed!important;top:0!important;left:0!important;right:auto!important;bottom:auto!important;padding:0!important;min-width:0!important;min-height:0!important;max-width:auto!important;max-height:auto!important;transform-origin:left top!important;will-change:width,height,transition,transform,opacity;transition:transform 0.05s}.i-amphtml-video-docked-overlay{opacity:0;transition:opacity 0.3s ease;contain:strict!important}.amp-video-docked-controls-bg{opacity:1}.i-amphtml-video-docked-overlay.amp-video-docked-almost-dismissed{opacity:1;background:hsla(0,0%,39%,0.1)}.i-amphtml-video-docked-shadow.amp-video-docked-almost-dismissed,.i-amphtml-video-docked.amp-video-docked-almost-dismissed{opacity:0.3}.amp-video-docked-button-dismiss-group{position:absolute;top:-40px}.amp-video-docked-placeholder-background{background:hsla(0,0%,78%,0.5);transition-property:opacity;overflow:hidden;pointer-events:none;z-index:0;opacity:0}.amp-video-docked-placeholder-icon{-webkit-mask-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg viewBox='0 0 48 48' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath d='M0 0h48v48H0z'/%3E%3Cpath d='M40 4H16c-2.2 0-4 1.8-4 4v24c0 2.2 1.8 4 4 4h24c2.2 0 4-1.8 4-4V8c0-2.2-1.8-4-4-4zM8 12H4v28c0 2.2 1.8 4 4 4h28v-4H8V12zm28 3.868L23.382 28.486l-2.828-2.828L33.212 13H25V9h15v15h-4v-8.132z' fill='%23000' fill-rule='nonzero'/%3E%3C/g%3E%3C/svg%3E\\\");mask-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg viewBox='0 0 48 48' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath d='M0 0h48v48H0z'/%3E%3Cpath d='M40 4H16c-2.2 0-4 1.8-4 4v24c0 2.2 1.8 4 4 4h24c2.2 0 4-1.8 4-4V8c0-2.2-1.8-4-4-4zM8 12H4v28c0 2.2 1.8 4 4 4h28v-4H8V12zm28 3.868L23.382 28.486l-2.828-2.828L33.212 13H25V9h15v15h-4v-8.132z' fill='%23000' fill-rule='nonzero'/%3E%3C/g%3E%3C/svg%3E\\\");-webkit-mask-size:48px 48px;mask-size:48px 48px;height:48px;width:48px;-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-position:bottom left;mask-position:bottom left;background:hsla(0,0%,39%,0.8);transition-property:opacity,transform;will-change:opacity,transform;position:absolute;bottom:40px;left:40px}.amp-video-docked-placeholder-icon.amp-rtl{-webkit-mask-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath d='M-4-4h48v48H-4z'/%3E%3Cpath d='M36 0c2.2 0 4 1.8 4 4v24c0 2.2-1.8 4-4 4H12c-2.2 0-4-1.8-4-4V4c0-2.2 1.8-4 4-4h24zM16 11.868l12.618 12.618 2.829-2.828L18.789 9H27V5H12v15h4v-8.132zM4 8H0v28c0 2.2 1.8 4 4 4h28v-4H4V8z' fill='%23000' fill-rule='nonzero'/%3E%3C/g%3E%3C/svg%3E\\\");mask-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath d='M-4-4h48v48H-4z'/%3E%3Cpath d='M36 0c2.2 0 4 1.8 4 4v24c0 2.2-1.8 4-4 4H12c-2.2 0-4-1.8-4-4V4c0-2.2 1.8-4 4-4h24zM16 11.868l12.618 12.618 2.829-2.828L18.789 9H27V5H12v15h4v-8.132zM4 8H0v28c0 2.2 1.8 4 4 4h28v-4H4V8z' fill='%23000' fill-rule='nonzero'/%3E%3C/g%3E%3C/svg%3E\\\");left:auto;right:40px}.amp-video-docked-placeholder-icon.amp-small{-webkit-mask-size:32px 32px;mask-size:32px 32px;width:32px;height:32px;bottom:20px;left:20px}.amp-video-docked-placeholder-icon.amp-rtl.amp-small{left:auto;right:20px}.amp-video-docked-placeholder-background-poster{background-size:cover;background-repeat:no-repeat;filter:blur(20px);transform:scale(1.1);opacity:0.3}.amp-video-docked-controls{z-index:2147483646!important}.i-amphtml-video-docked-overlay{z-index:2147483645!important}.i-amphtml-video-docked{z-index:2147483644!important}.amp-video-docked-shadow{z-index:2147483643!important}\\n/*# sourceURL=/extensions/amp-video-docking/0.1/amp-video-docking.css*/\";\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns the internal AMP runtime version. Note that this is not the RTV,\n * which is a prefix and the runtime version.\n *\n * The call sites for this function are replaced with a compile time constant\n * string.\n *\n * @return {string}\n */\nexport function internalRuntimeVersion() {\n  return '$internalRuntimeVersion$';\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {map} from '../object';\n\nconst QUERY_STRING_REGEX = /(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;\n\n/**\n * Tries to decode a URI component, falling back to opt_fallback (or an empty\n * string)\n *\n * @param {string} component\n * @param {string=} fallback\n * @return {string}\n */\nexport function tryDecodeUriComponent(component, fallback = '') {\n  try {\n    return decodeURIComponent(component);\n  } catch (e) {\n    return fallback;\n  }\n}\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\nexport function parseQueryString(queryString) {\n  const params = map();\n  if (!queryString) {\n    return params;\n  }\n\n  let match;\n  while ((match = QUERY_STRING_REGEX.exec(queryString))) {\n    const name = tryDecodeUriComponent(match[1], match[1]);\n    const value = match[2]\n      ? tryDecodeUriComponent(match[2].replace(/\\+/g, ' '), match[2])\n      : '';\n    params[name] = value;\n  }\n  return params;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalRuntimeVersion} from './internal-version';\nimport {parseQueryString} from './core/types/string/url';\n\n/**\n * @typedef {{\n *   localDev: boolean,\n *   development: boolean,\n *   minified: boolean,\n *   test: boolean,\n *   examiner: boolean,\n *   log: (string|undefined),\n *   version: string,\n *   rtvVersion: string,\n *   runtime: (null|string|undefined),\n *   a4aId: (null|string|undefined),\n *   esm: (boolean|undefined),\n * }}\n */\nexport let ModeDef;\n\n/**\n * `rtvVersion` is the prefixed version we serve off of the cdn.\n * The prefix denotes canary(00) or prod(01) or an experiment version ( > 01).\n * @type {string}\n */\nlet rtvVersion = '';\n\n/**\n * Provides info about the current app.\n * @param {?Window=} opt_win\n * @return {!ModeDef}\n */\nexport function getMode(opt_win) {\n  const win = opt_win || self;\n  if (win.__AMP_MODE) {\n    return win.__AMP_MODE;\n  }\n  return (win.__AMP_MODE = getMode_(win));\n}\n\n/**\n * Provides info about the current app.\n * @param {!Window} win\n * @return {!ModeDef}\n */\nfunction getMode_(win) {\n  // TODO(erwinmombay): simplify the logic here\n  const AMP_CONFIG = self.AMP_CONFIG || {};\n\n  // Magic constants that are replaced by closure compiler.\n  // IS_MINIFIED is always replaced with true when closure compiler is used\n  // while IS_FORTESTING is only replaced when `amp dist` is called without the\n  // --fortesting flag.\n  const IS_FORTESTING = true;\n  const IS_MINIFIED = false;\n\n  const runningTests =\n    IS_FORTESTING && !!(AMP_CONFIG.test || win.__AMP_TEST || win['__karma__']);\n  const isLocalDev = IS_FORTESTING && (!!AMP_CONFIG.localDev || runningTests);\n  const hashQuery = parseQueryString(\n    // location.originalHash is set by the viewer when it removes the fragment\n    // from the URL.\n    win.location['originalHash'] || win.location.hash\n  );\n\n  if (!rtvVersion) {\n    rtvVersion = getRtvVersion(win);\n  }\n\n  // The `minified`, `test` and `localDev` properties are replaced\n  // as boolean literals when we run `amp dist` without the `--fortesting`\n  // flags. This improved DCE on the production file we deploy as the code\n  // paths for localhost/testing/development are eliminated.\n  return {\n    localDev: isLocalDev,\n    development: isModeDevelopment(win),\n    examiner: hashQuery['development'] == '2',\n    esm: IS_ESM,\n    // amp-geo override\n    geoOverride: hashQuery['amp-geo'],\n    minified: IS_MINIFIED,\n    test: runningTests,\n    log: hashQuery['log'],\n    version: internalRuntimeVersion(),\n    rtvVersion,\n  };\n}\n\n/**\n * Retrieve the `rtvVersion` which will have a numeric prefix\n * denoting canary/prod/experiment (unless `isLocalDev` is true).\n *\n * @param {!Window} win\n * @return {string}\n */\nfunction getRtvVersion(win) {\n  if (win.AMP_CONFIG && win.AMP_CONFIG.v) {\n    return win.AMP_CONFIG.v;\n  }\n\n  // Currently `internalRuntimeVersion` and thus `mode.version` contain only\n  // major version. The full version however must also carry the minor version.\n  // We will default to production default `01` minor version for now.\n  // TODO(erwinmombay): decide whether internalRuntimeVersion should contain\n  // minor version.\n  return `01${internalRuntimeVersion()}`;\n}\n\n/**\n * Triggers validation or enable pub level logging. Validation can be\n * bypassed via #validate=0.\n * Note that AMP_DEV_MODE flag is used for testing purposes.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isModeDevelopment(win) {\n  const hashQuery = parseQueryString(\n    win.location['originalHash'] || win.location.hash\n  );\n  return !!(\n    ['1', 'actions', 'amp', 'amp4ads', 'amp4email'].includes(\n      hashQuery['development']\n    ) || win.AMP_DEV_MODE\n  );\n}\n\n/**\n * @param {!Window} win\n * @return {string}\n * @visibleForTesting\n */\nexport function getRtvVersionForTesting(win) {\n  return getRtvVersion(win);\n}\n\n/** @visibleForTesting */\nexport function resetRtvVersionForTesting() {\n  rtvVersion = '';\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @fileoverview Helpers to wrap functions. */\n\n/**\n * Creates a function that is evaluated only once and returns the cached result\n * subsequently.\n *\n * Please note that `once` only takes the function definition into account,\n * so it will return the same cached value even when the arguments are\n * different.\n *\n * @param {function(...):T} fn\n * @return {function(...):T}\n * @template T\n */\nexport function once(fn) {\n  let evaluated = false;\n  let retValue = null;\n  let callback = fn;\n  return (...args) => {\n    if (!evaluated) {\n      retValue = callback.apply(self, args);\n      evaluated = true;\n      callback = null; // GC\n    }\n    return retValue;\n  };\n}\n\n/**\n * Wraps a given callback and applies a rate limit.\n * It throttles the calls so that no consequent calls have time interval\n * smaller than the given minimal interval.\n *\n * @param {!Window} win\n * @param {function(...T):R} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...T)}\n * @template T\n * @template R\n */\nexport function throttle(win, callback, minInterval) {\n  let locker = 0;\n  let nextCallArgs = null;\n\n  /**\n   * @param {!Object} args\n   */\n  function fire(args) {\n    nextCallArgs = null;\n    // Lock the fire for minInterval milliseconds\n    locker = win.setTimeout(waiter, minInterval);\n\n    callback.apply(null, args);\n  }\n\n  /**\n   * Waiter function\n   */\n  function waiter() {\n    locker = 0;\n    // If during the period there're invocations queued up, fire once.\n    if (nextCallArgs) {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function (...args) {\n    if (locker) {\n      nextCallArgs = args;\n    } else {\n      fire(args);\n    }\n  };\n}\n\n/**\n * Wraps a given callback and applies a wait timer, so that minInterval\n * milliseconds must pass since the last call before the callback is actually\n * invoked.\n *\n * @param {!Window} win\n * @param {function(...T):R} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...T)}\n * @template T\n * @template R\n */\nexport function debounce(win, callback, minInterval) {\n  let locker = 0;\n  let timestamp = 0;\n  let nextCallArgs = null;\n\n  /**\n   * @param {?Array} args\n   */\n  function fire(args) {\n    nextCallArgs = null;\n    callback.apply(null, args);\n  }\n\n  /**\n   * Wait function for debounce\n   */\n  function waiter() {\n    locker = 0;\n    const remaining = minInterval - (win.Date.now() - timestamp);\n    if (remaining > 0) {\n      locker = win.setTimeout(waiter, remaining);\n    } else {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function (...args) {\n    timestamp = win.Date.now();\n    nextCallArgs = args;\n    if (!locker) {\n      locker = win.setTimeout(waiter, minInterval);\n    }\n  };\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Allows for runtime configuration. Internally, the runtime should\n * use the src/config.js module for various constants. We can use the\n * AMP_CONFIG global to translate user-defined configurations to this\n * module.\n * @type {!Object<string, string>}\n */\nconst env = self.AMP_CONFIG || {};\n\nconst thirdPartyFrameRegex =\n  (typeof env['thirdPartyFrameRegex'] == 'string'\n    ? new RegExp(env['thirdPartyFrameRegex'])\n    : env['thirdPartyFrameRegex']) || /^d-\\d+\\.ampproject\\.net$/;\n\nconst cdnProxyRegex =\n  (typeof env['cdnProxyRegex'] == 'string'\n    ? new RegExp(env['cdnProxyRegex'])\n    : env['cdnProxyRegex']) ||\n  /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org$/;\n\n/**\n * Check for a custom URL definition in special <meta> tags. Note that this does\n * not allow for distinct custom URLs in AmpDocShadow instances. The shell is\n * allowed to define one set of custom URLs via AMP_CONFIG (recommended) or by\n * including <meta> tags in the shell <head>. Those custom URLs then apply to\n * all AMP documents loaded in the shell.\n * @param {string} name\n * @return {?string}\n * @private\n */\nfunction getMetaUrl(name) {\n  // Avoid exceptions in unit tests\n  if (!self.document || !self.document.head) {\n    return null;\n  }\n\n  // Disallow on proxy origins\n  if (self.location && cdnProxyRegex.test(self.location.origin)) {\n    return null;\n  }\n\n  const metaEl = self.document.head./*OK*/ querySelector(\n    `meta[name=\"${name}\"]`\n  );\n  return (metaEl && metaEl.getAttribute('content')) || null;\n}\n\n/**\n * @typedef {{\n *   thirdParty: string,\n *   thirdPartyFrameHost: string,\n *   thirdPartyFrameRegex: !RegExp,\n *   cdn: string,\n *   cdnProxyRegex: !RegExp,\n *   localhostRegex: !RegExp,\n *   errorReporting: string,\n *   betaErrorReporting: string,\n *   localDev: boolean,\n *   trustedViewerHosts: !Array<!RegExp>,\n *   geoApi: ?string,\n * }}\n */\nexport const urls = {\n  thirdParty: env['thirdPartyUrl'] || 'https://3p.ampproject.net',\n  thirdPartyFrameHost: env['thirdPartyFrameHost'] || 'ampproject.net',\n  thirdPartyFrameRegex,\n  cdn:\n    env['cdnUrl'] || getMetaUrl('runtime-host') || 'https://cdn.ampproject.org',\n  /* Note that cdnProxyRegex is only ever checked against origins\n   * (proto://host[:port]) so does not need to consider path\n   */\n  cdnProxyRegex,\n  localhostRegex: /^https?:\\/\\/localhost(:\\d+)?$/,\n  errorReporting:\n    env['errorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r',\n  betaErrorReporting:\n    env['betaErrorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r-beta',\n  localDev: env['localDev'] || false,\n  /**\n   * These domains are trusted with more sensitive viewer operations such as\n   * propagating the referrer. If you believe your domain should be here,\n   * file the issue on GitHub to discuss. The process will be similar\n   * (but somewhat more stringent) to the one described in the [3p/README.md](\n   * https://github.com/ampproject/amphtml/blob/main/3p/README.md)\n   *\n   * {!Array<!RegExp>}\n   */\n  trustedViewerHosts: [\n    /(^|\\.)google\\.(com?|[a-z]{2}|com?\\.[a-z]{2}|cat)$/,\n    /(^|\\.)gmail\\.(com|dev)$/,\n  ],\n  // Optional fallback API if amp-geo is left unpatched\n  geoApi: env['geoApiUrl'] || getMetaUrl('amp-geo-api'),\n};\n\nexport const config = {\n  urls,\n};\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assertions from './core/assert/base';\nimport {\n  USER_ERROR_SENTINEL,\n  elementStringOrPassThru,\n  isUserErrorMessage,\n  stripUserError,\n} from './core/error/message-helpers';\nimport {createErrorVargs, duplicateErrorIfNecessary} from './core/error';\nimport {getMode} from './mode';\nimport {internalRuntimeVersion} from './internal-version';\nimport {isArray} from './core/types';\nimport {once} from './core/types/function';\nimport {urls} from './config';\n\nconst noop = () => {};\n\n// These are exported here despite being defined in core to avoid updating\n// imports for now.\nexport {USER_ERROR_SENTINEL, isUserErrorMessage, stripUserError};\n\n/**\n * Four zero width space.\n *\n * @const {string}\n */\nexport const USER_ERROR_EMBED_SENTINEL = '\\u200B\\u200B\\u200B\\u200B';\n\n/**\n * @param {string} message\n * @return {boolean} Whether this message was a a user error from an iframe embed.\n */\nexport function isUserErrorEmbed(message) {\n  return message.indexOf(USER_ERROR_EMBED_SENTINEL) >= 0;\n}\n\n/**\n * @enum {number}\n */\nexport const LogLevel = {\n  OFF: 0,\n  ERROR: 1,\n  WARN: 2,\n  INFO: 3,\n  FINE: 4,\n};\n\n/**\n * Sets reportError function. Called from error-reporting.js to break cyclic\n * dependency.\n * @param {function(this:Window, Error, (?Element)=): ?|undefined} fn\n */\nexport function setReportError(fn) {\n  self.__AMP_REPORT_ERROR = fn;\n}\n\n/**\n * @type {!LogLevel|undefined}\n * @private\n */\nlet levelOverride_ = undefined;\n\n/**\n * @param {!LogLevel} level\n */\nexport function overrideLogLevel(level) {\n  levelOverride_ = level;\n}\n\n/**\n * Prefixes `internalRuntimeVersion` with the `01` channel signifier (for prod.) for\n * extracted message URLs.\n * (Specific channel is irrelevant: message tables are invariant on internal version.)\n * @return {string}\n */\nconst messageUrlRtv = () => `01${internalRuntimeVersion()}`;\n\n/**\n * Gets a URL to display a message on amp.dev.\n * @param {string} id\n * @param {!Array} interpolatedParts\n * @return {string}\n */\nconst externalMessageUrl = (id, interpolatedParts) =>\n  interpolatedParts.reduce(\n    (prefix, arg) => `${prefix}&s[]=${messageArgToEncodedComponent(arg)}`,\n    `https://log.amp.dev/?v=${messageUrlRtv()}&id=${encodeURIComponent(id)}`\n  );\n\n/**\n * URL to simple log messages table JSON file, which contains an Object<string, string>\n * which maps message id to full message template.\n * @return {string}\n */\nconst externalMessagesSimpleTableUrl = () =>\n  `${urls.cdn}/rtv/${messageUrlRtv()}/log-messages.simple.json`;\n\n/**\n * @param {*} arg\n * @return {string}\n */\nconst messageArgToEncodedComponent = (arg) =>\n  encodeURIComponent(String(elementStringOrPassThru(arg)));\n\n/**\n * Logging class. Use of sentinel string instead of a boolean to check user/dev\n * errors because errors could be rethrown by some native code as a new error,\n * and only a message would survive. Also, some browser don\u2019t support a 5th\n * error object argument in window.onerror. List of supporting browser can be\n * found here:\n * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n * @final\n * @private Visible for testing only.\n */\nexport class Log {\n  /**\n   * opt_suffix will be appended to error message to identify the type of the\n   * error message. We can't rely on the error object to pass along the type\n   * because some browsers do not have this param in its window.onerror API.\n   * See:\n   * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n   *\n   * @param {!Window} win\n   * @param {function(number, boolean):!LogLevel} levelFunc\n   * @param {string=} opt_suffix\n   */\n  constructor(win, levelFunc, opt_suffix = '') {\n    /**\n     * In tests we use the main test window instead of the iframe where\n     * the tests runs because only the former is relayed to the console.\n     * @const {!Window}\n     */\n    this.win = getMode().test && win.__AMP_TEST_IFRAME ? win.parent : win;\n\n    /** @private @const {function(number, boolean):!LogLevel} */\n    this.levelFunc_ = levelFunc;\n\n    /** @private @const {!LogLevel} */\n    this.level_ = this.defaultLevel_();\n\n    /** @private @const {string} */\n    this.suffix_ = opt_suffix;\n\n    /** @private {?JsonObject} */\n    this.messages_ = null;\n\n    this.fetchExternalMessagesOnce_ = once(() => {\n      win\n        .fetch(externalMessagesSimpleTableUrl())\n        .then((response) => response.json(), noop)\n        .then((opt_messages) => {\n          if (opt_messages) {\n            this.messages_ = /** @type {!JsonObject} */ (opt_messages);\n          }\n        });\n    });\n\n    // This bound assertion function is capable of handling the format used when\n    // error/assertion messages are extracted. This logic hasn't yet been\n    // migrated to an AMP-independent form for use in core. This binding allows\n    // Log assertion helpers to maintain message-extraction capabilities until\n    // that logic can be moved to core.\n    this.boundAssertFn_ = /** @type {!assertions.AssertionFunctionDef} */ (\n      this.assert.bind(this)\n    );\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  getLevel_() {\n    return levelOverride_ !== undefined ? levelOverride_ : this.level_;\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevel_() {\n    // No console - can't enable logging.\n    if (!this.win.console || !this.win.console.log) {\n      return LogLevel.OFF;\n    }\n\n    // Logging has been explicitly disabled.\n    if (getMode().log == '0') {\n      return LogLevel.OFF;\n    }\n\n    // Logging is enabled for tests directly.\n    if (getMode().test && this.win.ENABLE_LOG) {\n      return LogLevel.FINE;\n    }\n\n    // LocalDev by default allows INFO level, unless overriden by `#log`.\n    if (getMode().localDev && !getMode().log) {\n      return LogLevel.INFO;\n    }\n\n    return this.defaultLevelWithFunc_();\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevelWithFunc_() {\n    // Delegate to the specific resolver.\n    return this.levelFunc_(parseInt(getMode().log, 10), getMode().development);\n  }\n\n  /**\n   * @param {string} tag\n   * @param {!LogLevel} level\n   * @param {!Array} messages\n   * @return {boolean} true if a message was logged\n   */\n  msg_(tag, level, messages) {\n    if (this.getLevel_() < level) {\n      return false;\n    }\n    let fn = this.win.console.log;\n    if (level == LogLevel.ERROR) {\n      fn = this.win.console.error || fn;\n    } else if (level == LogLevel.INFO) {\n      fn = this.win.console.info || fn;\n    } else if (level == LogLevel.WARN) {\n      fn = this.win.console.warn || fn;\n    }\n    const args = this.maybeExpandMessageArgs_(messages);\n    // Prefix console message with \"[tag]\".\n    const prefix = `[${tag}]`;\n    if (typeof args[0] === 'string') {\n      // Prepend string to avoid breaking string substitutions e.g. %s.\n      args[0] = prefix + ' ' + args[0];\n    } else {\n      args.unshift(prefix);\n    }\n    fn.apply(this.win.console, args);\n    return true;\n  }\n\n  /**\n   * Whether the logging is enabled.\n   * @return {boolean}\n   */\n  isEnabled() {\n    return this.getLevel_() != LogLevel.OFF;\n  }\n\n  /**\n   * Reports a fine-grained message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  fine(tag, ...args) {\n    this.msg_(tag, LogLevel.FINE, args);\n  }\n\n  /**\n   * Reports a informational message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  info(tag, ...args) {\n    this.msg_(tag, LogLevel.INFO, args);\n  }\n\n  /**\n   * Reports a warning message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  warn(tag, ...args) {\n    this.msg_(tag, LogLevel.WARN, args);\n  }\n\n  /**\n   * Reports an error message. If the logging is disabled, the error is rethrown\n   * asynchronously.\n   * @param {string} tag\n   * @param {...*} args\n   * @return {!Error|undefined}\n   * @private\n   */\n  error_(tag, ...args) {\n    if (!this.msg_(tag, LogLevel.ERROR, args)) {\n      return this.createError.apply(this, args);\n    }\n  }\n\n  /**\n   * Reports an error message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  error(tag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      // TODO(rcebulko): Determine if/how this Error#name property is used.\n      error.name = tag || error.name;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Reports an error message and marks with an expected property. If the\n   * logging is disabled, the error is rethrown asynchronously.\n   * @param {string} unusedTag\n   * @param {...*} var_args\n   */\n  expectedError(unusedTag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      error.expected = true;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Creates an error object.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    return error;\n  }\n\n  /**\n   * Creates an error object with its expected property set to true.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createExpectedError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    error.expected = true;\n    return error;\n  }\n\n  /**\n   * Throws an error if the first argument isn't trueish.\n   *\n   * Supports argument substitution into the message via %s placeholders.\n   *\n   * Throws an error object that has two extra properties:\n   * - associatedElement: This is the first element provided in the var args.\n   *   It can be used for improved display of error messages.\n   * - messageArray: The elements of the substituted message as non-stringified\n   *   elements in an array. When e.g. passed to console.error this yields\n   *   native displays of things like HTML elements.\n   *\n   * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n   *     not evaluate to true.\n   * @param {!Array|string=} opt_message The assertion message\n   * @param {...*} var_args Arguments substituted into %s in the message.\n   * @return {T} The value of shouldBeTrueish.\n   * @throws {!Error} When `value` is falsey.\n   * @template T\n   * @closurePrimitive {asserts.truthy}\n   */\n  assert(shouldBeTrueish, opt_message, var_args) {\n    if (isArray(opt_message)) {\n      return this.assert.apply(\n        this,\n        [shouldBeTrueish].concat(\n          this.expandMessageArgs_(/** @type {!Array} */ (opt_message))\n        )\n      );\n    }\n\n    return assertions.assert.apply(\n      null,\n      [this.suffix_].concat(Array.prototype.slice.call(arguments))\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't an Element\n   *\n   * Otherwise see `assert` for usage\n   *\n   * @param {*} shouldBeElement\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Element} The value of shouldBeTrueish.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertElement(shouldBeElement, opt_message) {\n    return assertions.assertElement(\n      this.boundAssertFn_,\n      shouldBeElement,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a string. The string can\n   * be empty.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeString\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {string} The string value. Can be an empty string.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertString(shouldBeString, opt_message) {\n    return assertions.assertString(\n      this.boundAssertFn_,\n      shouldBeString,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a number. The allowed values\n   * include `0` and `NaN`.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeNumber\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {number} The number value. The allowed values include `0`\n   *   and `NaN`.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertNumber(shouldBeNumber, opt_message) {\n    return assertions.assertNumber(\n      this.boundAssertFn_,\n      shouldBeNumber,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument is not an array.\n   * The array can be empty.\n   *\n   * @param {*} shouldBeArray\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Array} The array value\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertArray(shouldBeArray, opt_message) {\n    return assertions.assertArray(\n      this.boundAssertFn_,\n      shouldBeArray,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a boolean.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeBoolean\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {boolean} The boolean value.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertBoolean(shouldBeBoolean, opt_message) {\n    return assertions.assertBoolean(\n      this.boundAssertFn_,\n      shouldBeBoolean,\n      opt_message\n    );\n  }\n\n  /**\n   * @param {!Error} error\n   * @private\n   */\n  prepareError_(error) {\n    error = duplicateErrorIfNecessary(error);\n\n    if (this.suffix_) {\n      if (!error.message) {\n        error.message = this.suffix_;\n      } else if (error.message.indexOf(this.suffix_) == -1) {\n        error.message += this.suffix_;\n      }\n    } else if (isUserErrorMessage(error.message)) {\n      error.message = error.message.replace(USER_ERROR_SENTINEL, '');\n    }\n  }\n\n  /**\n   * @param {!Array} args\n   * @return {!Array}\n   * @private\n   */\n  maybeExpandMessageArgs_(args) {\n    if (isArray(args[0])) {\n      return this.expandMessageArgs_(/** @type {!Array} */ (args[0]));\n    }\n    return args;\n  }\n\n  /**\n   * Either redirects a pair of (errorId, ...args) to a URL where the full\n   * message is displayed, or displays it from a fetched table.\n   *\n   * This method is used by the output of the `transform-log-methods` babel\n   * plugin. It should not be used directly. Use the (*error|assert*|info|warn)\n   * methods instead.\n   *\n   * @param {!Array} parts\n   * @return {!Array}\n   * @private\n   */\n  expandMessageArgs_(parts) {\n    // First value should exist.\n    const id = parts.shift();\n    // Best effort fetch of message template table.\n    // Since this is async, the first few logs might be indirected to a URL even\n    // if in development mode. Message table is ~small so this should be a short\n    // gap.\n    if (getMode(this.win).development) {\n      this.fetchExternalMessagesOnce_();\n    }\n    if (this.messages_ && id in this.messages_) {\n      return [this.messages_[id]].concat(parts);\n    }\n    return [`More info at ${externalMessageUrl(id, parts)}`];\n  }\n}\n\n/**\n * Cache for logs. We do not use a Service since the service module depends\n * on Log and closure literally can't even.\n * @type {{user: ?Log, dev: ?Log, userForEmbed: ?Log}}\n */\nself.__AMP_LOG = self.__AMP_LOG || {\n  user: null,\n  dev: null,\n  userForEmbed: null,\n};\n\nconst logs = self.__AMP_LOG;\n\n/**\n * Eventually holds a constructor for Log objects. Lazily initialized, so we\n * can avoid ever referencing the real constructor except in JS binaries\n * that actually want to include the implementation.\n * @type {?typeof Log}\n */\nlet logConstructor = null;\n\n/**\n * Initializes log constructor.\n */\nexport function initLogConstructor() {\n  logConstructor = Log;\n  // Initialize instances for use. If a binary (an extension for example) that\n  // does not call `initLogConstructor` invokes `dev()` or `user()` earlier than\n  // the binary that does call `initLogConstructor` (amp.js), the extension will\n  // throw an error as that extension will never be able to initialize the log\n  // instances and we also don't want it to call `initLogConstructor` either\n  // (since that will cause the Log implementation to be bundled into that\n  // binary). So we must initialize the instances eagerly so that they are ready\n  // for use (stored globally) after the main binary calls `initLogConstructor`.\n  dev();\n  user();\n}\n\n/**\n * Resets log constructor for testing.\n */\nexport function resetLogConstructorForTesting() {\n  logConstructor = null;\n}\n\n/**\n * Publisher level log.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Development mode is enabled via `#development=1` or logging is explicitly\n *     enabled via `#log=D` where D >= 1.\n *  3. AMP.setLogLevel(D) is called, where D >= 1.\n *\n * @param {!Element=} opt_element\n * @return {!Log}\n */\nexport function user(opt_element) {\n  if (!logs.user) {\n    logs.user = getUserLogger(USER_ERROR_SENTINEL);\n  }\n  if (!isFromEmbed(logs.user.win, opt_element)) {\n    return logs.user;\n  } else {\n    if (logs.userForEmbed) {\n      return logs.userForEmbed;\n    }\n    return (logs.userForEmbed = getUserLogger(USER_ERROR_EMBED_SENTINEL));\n  }\n}\n\n/**\n * Getter for user logger\n * @param {string=} suffix\n * @return {!Log}\n */\nfunction getUserLogger(suffix) {\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return new logConstructor(\n    self,\n    (logNum, development) => {\n      if (development || logNum >= 1) {\n        return LogLevel.FINE;\n      }\n      return LogLevel.WARN;\n    },\n    suffix\n  );\n}\n\n/**\n * AMP development log. Calls to `devLog().assert` and `dev.fine` are stripped\n * in the PROD binary. However, `devLog().assert` result is preserved in either\n * case.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Logging is explicitly enabled via `#log=D`, where D >= 2.\n *  3. AMP.setLogLevel(D) is called, where D >= 2.\n *\n * @return {!Log}\n */\nexport function dev() {\n  if (logs.dev) {\n    return logs.dev;\n  }\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return (logs.dev = new logConstructor(self, (logNum) => {\n    if (logNum >= 3) {\n      return LogLevel.FINE;\n    }\n    if (logNum >= 2) {\n      return LogLevel.INFO;\n    }\n    return LogLevel.OFF;\n  }));\n}\n\n/**\n * @param {!Window} win\n * @param {!Element=} opt_element\n * @return {boolean} isEmbed\n */\nexport function isFromEmbed(win, opt_element) {\n  if (!opt_element) {\n    return false;\n  }\n  return opt_element.ownerDocument.defaultView != win;\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function devAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (getMode().minified) {\n    return shouldBeTrueish;\n  }\n  if (self.__AMP_ASSERTION_CHECK) {\n    // This will never execute regardless, but will be included on unminified\n    // builds. It will be DCE'd away from minified builds, and so can be used to\n    // validate that Babel is properly removing dev assertions in minified\n    // builds.\n    console /*OK*/\n      .log('__devAssert_sentinel__');\n  }\n\n  return dev()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function userAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  return user()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n", "/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */\n\n\n/**\n * This regex consists of 4 matching capture groups and one (non-matching) fallback:\n *\n * - (\\0), catch the null terminator character so it may be replaced by UTF\n *   Replacement Char\n * - ^(-)$, catch a solitary dash char, so that it may be backslash escaped.\n *   This is a separate capture group so that the legal-chars (group 4) doesn't\n *   capture it first, since that group doesn't need to escape its dash.\n * - ([\\x01-\\x1f\\x7f]|^-?[0-9]), catch a UTF control char, or any leading\n *   number (with an optional leading dash). The control or the number (but not\n *   the leading dash) must be hex-escaped,.\n * - ([\\x80-\\uffff0-9a-zA-Z_-]+), catch legal-chars, with the exception of a\n *   solitary dash, which will already have matched in group 1.\n * - [^], finally, a catch-all that allows us to backslash escape the char.\n *\n * Together, this matches everything necessary for CSS.escape.\n */\nvar regex = /(\\0)|^(-)$|([\\x01-\\x1f\\x7f]|^-?[0-9])|([\\x80-\\uffff0-9a-zA-Z_-]+)|[^]/g;\n\nfunction escaper(match, nil, dash, hexEscape, chars) {\n  // Chars is the legal-chars (group 4) capture\n  if (chars) {\n    return chars;\n  }\n  // Nil is the null terminator (group 1) capture\n  if (nil) {\n    return '\\uFFFD';\n  }\n  // Both UTF control chars, and leading numbers (with optional leading dash)\n  // (group 3) must be backslash escaped with a trailing space.  Funnily, the\n  // leading dash must not be escaped, but the number. :shrug:\n  if (hexEscape) {\n    return match.slice(0, -1) + '\\\\' + match.slice(-1).charCodeAt(0).toString(16) + ' '\n  }\n  // Finally, the solitary dash and the catch-all chars require backslash\n  // escaping.\n  return '\\\\' + match;\n}\n\n/**\n * https://drafts.csswg.org/cssom/#serialize-an-identifier\n * @param {string} value\n * @return {string}\n */\nexport function cssEscape(value) {\n  return String(value).replace(regex, escaper);\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {cssEscape} from '../../../third_party/css-escape/css-escape';\nimport {devAssert} from '../assert';\n\n/**\n * @type {boolean|undefined}\n */\nlet scopeSelectorSupported;\n\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\nexport function setScopeSelectorSupportedForTesting(val) {\n  scopeSelectorSupported = val;\n}\n\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element|!ShadowRoot} el\n * @return {boolean}\n */\nexport function isScopeSelectorSupported(el) {\n  if (scopeSelectorSupported !== undefined) {\n    return scopeSelectorSupported;\n  }\n\n  return (scopeSelectorSupported = testScopeSelector(el));\n}\n\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element|!ShadowRoot} el\n * @return {boolean}\n */\nfunction testScopeSelector(el) {\n  try {\n    const doc = el.ownerDocument;\n    const testElement = doc.createElement('div');\n    const testChild = doc.createElement('div');\n    testElement.appendChild(testChild);\n    // NOTE(cvializ, #12383): Firefox's implementation is incomplete,\n    // therefore we test actual functionality of`:scope` as well.\n    return testElement./*OK*/ querySelector(':scope div') === testChild;\n  } catch (e) {\n    return false;\n  }\n}\n\n/**\n * Prefixes a selector for ancestor selection. Splits in subselectors and\n * applies prefix to each.\n *\n * e.g.\n * ```\n *   prependSelectorsWith('div', '.i-amphtml-scoped');\n *   // => '.i-amphtml-scoped div'\n *   prependSelectorsWith('div, ul', ':scope');\n *   // => ':scope div, :scope ul'\n *   prependSelectorsWith('div, ul', 'article >');\n *   // => 'article > div, article > ul'\n * ```\n *\n * @param {string} selector\n * @param {string} distribute\n * @return {string}\n */\nexport function prependSelectorsWith(selector, distribute) {\n  return selector.replace(/^|,/g, `$&${distribute} `);\n}\n\n/**\n * Escapes an ident (ID or a class name) to be used as a CSS selector.\n *\n * See https://drafts.csswg.org/cssom/#serialize-an-identifier.\n *\n * @param {string} ident\n * @return {string}\n * @suppress {uselessCode}\n */\nexport function escapeCssSelectorIdent(ident) {\n  // This gets rewritten to true/false during compilation. It will trigger an\n  // JSC_UNREACHABLE_CODE warning, but that's intentional for DCE.\n  if (IS_ESM) {\n    return CSS.escape(ident);\n  }\n  return cssEscape(ident);\n}\n\n/**\n * Escapes an ident in a way that can be used by :nth-child() psuedo-class.\n *\n * See https://github.com/w3c/csswg-drafts/issues/2306.\n *\n * @param {string|number} ident\n * @return {string}\n */\nexport function escapeCssSelectorNth(ident) {\n  const escaped = String(ident);\n  // Ensure it doesn't close the nth-child psuedo class.\n  devAssert(escaped.indexOf(')') === -1);\n  return escaped;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../assert';\nimport {isScopeSelectorSupported, prependSelectorsWith} from './css-selectors';\n\n/** @fileoverview Helper functions for DOM queries. */\n\n/**\n * Asserts that name is just an alphanumeric word, and does not contain\n * advanced CSS selector features like attributes, psuedo-classes, class names,\n * nor ids.\n * @param {string} name\n */\nfunction assertIsName(name) {\n  devAssert(\n    /^[\\w-]+$/.test(name),\n    `Expected \"${name}\" to be a CSS name composed of alphanumerics and hyphens.`\n  );\n}\n\n/**\n * Finds all elements that matche `selector`, scoped inside `root`\n * for user-agents that do not support native scoping.\n *\n * This method isn't required for modern builds, can be removed.\n *\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n */\nfunction scopedQuerySelectionFallback(root, selector) {\n  const unique = 'i-amphtml-scoped';\n  root.classList.add(unique);\n  const scopedSelector = prependSelectorsWith(selector, `.${unique}`);\n  const elements = root./*OK*/ querySelectorAll(scopedSelector);\n  root.classList.remove(unique);\n  return elements;\n}\n\n/**\n * Finds the first element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {?Element}\n *\n * @suppress {suspiciousCode}\n */\nexport function scopedQuerySelector(root, selector) {\n  if (IS_ESM || isScopeSelectorSupported(root)) {\n    return root./*OK*/ querySelector(prependSelectorsWith(selector, ':scope'));\n  }\n\n  // Only IE.\n  const fallbackResult = scopedQuerySelectionFallback(root, selector);\n  return fallbackResult[0] === undefined ? null : fallbackResult[0];\n}\n\n/**\n * Finds every element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element|!ShadowRoot} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n *\n * @suppress {suspiciousCode}\n */\nexport function scopedQuerySelectorAll(root, selector) {\n  if (IS_ESM || isScopeSelectorSupported(root)) {\n    return root./*OK*/ querySelectorAll(\n      prependSelectorsWith(selector, ':scope')\n    );\n  }\n\n  // Only IE.\n  return scopedQuerySelectionFallback(root, selector);\n}\n\n/**\n * Checks if the given element matches the selector\n * @param  {!Element} el The element to verify\n * @param  {string} selector The selector to check against\n * @return {boolean} True if the element matched the selector. False otherwise.\n */\nexport function matches(el, selector) {\n  const matcher =\n    el.matches ||\n    el.webkitMatchesSelector ||\n    el.mozMatchesSelector ||\n    el.msMatchesSelector ||\n    el.oMatchesSelector;\n  if (matcher) {\n    return matcher.call(el, selector);\n  }\n  return false; // IE8 always returns false.\n}\n\n/**\n * Finds the closest element that satisfies the callback from this element\n * up the DOM subtree.\n * @param {!Element} element\n * @param {function(!Element):boolean} callback\n * @param {Element=} opt_stopAt optional elemnt to stop the search at.\n * @return {?Element}\n */\nexport function closest(element, callback, opt_stopAt) {\n  for (let el = element; el && el !== opt_stopAt; el = el.parentElement) {\n    if (callback(el)) {\n      return el;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the closest node that satisfies the callback from this node\n * up the DOM subtree.\n * @param {!Node} node\n * @param {function(!Node):boolean} callback\n * @return {?Node}\n */\nexport function closestNode(node, callback) {\n  for (let n = node; n; n = n.parentNode) {\n    if (callback(n)) {\n      return n;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the closest ancestor element with the specified selector from this\n * element.\n * @param {!Element} element\n * @param {string} selector\n * @return {?Element} closest ancestor if found.\n */\nexport function closestAncestorElementBySelector(element, selector) {\n  return element.closest\n    ? element.closest(selector)\n    : closest(element, (el) => matches(el, selector));\n}\n\n/**\n * Finds all ancestor elements that satisfy predicate.\n * @param {!Element} child\n * @param {function(!Element):boolean} predicate\n * @return {!Array<!Element>}\n */\nexport function ancestorElements(child, predicate) {\n  const ancestors = [];\n  for (\n    let ancestor = child.parentElement;\n    ancestor;\n    ancestor = ancestor.parentElement\n  ) {\n    if (predicate(ancestor)) {\n      ancestors.push(ancestor);\n    }\n  }\n  return ancestors;\n}\n\n/**\n * Finds all ancestor elements that has the specified tag name.\n * @param {!Element} child\n * @param {string} tagName\n * @return {!Array<!Element>}\n */\nexport function ancestorElementsByTag(child, tagName) {\n  assertIsName(tagName);\n  tagName = tagName.toUpperCase();\n  return ancestorElements(child, (el) => el.tagName == tagName);\n}\n\n/**\n * Finds the first child element that satisfies the callback.\n * TODO(rcebulko): Can we start using generators in childElements and defer to\n * that here?\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function childElement(parent, callback) {\n  for (\n    let child = parent.firstElementChild;\n    child;\n    child = child.nextElementSibling\n  ) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the last child element that satisfies the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function lastChildElement(parent, callback) {\n  for (\n    let child = parent.lastElementChild;\n    child;\n    child = child.previousElementSibling\n  ) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds all child elements that satisfy the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {!Array<!Element>}\n */\nexport function childElements(parent, callback) {\n  const children = [];\n  for (\n    let child = parent.firstElementChild;\n    child;\n    child = child.nextElementSibling\n  ) {\n    if (callback(child)) {\n      children.push(child);\n    }\n  }\n  return children;\n}\n\n/**\n * Finds all child nodes that satisfy the callback.\n * These nodes can include Text, Comment and other child nodes.\n * @param {!Node} parent\n * @param {function(!Node):boolean} callback\n * @return {!Array<!Node>}\n */\nexport function childNodes(parent, callback) {\n  const nodes = [];\n  for (let child = parent.firstChild; child; child = child.nextSibling) {\n    if (callback(child)) {\n      nodes.push(child);\n    }\n  }\n  return nodes;\n}\n\n/**\n * Finds the first child element that has the specified attribute.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} attr\n * @return {?Element}\n */\nexport function childElementByAttr(parent, attr) {\n  assertIsName(attr);\n  return /*OK*/ scopedQuerySelector(parent, `> [${attr}]`);\n}\n\n/**\n * Finds the last child element that has the specified attribute.\n * @param {!Element} parent\n * @param {string} attr\n * @return {?Element}\n */\nexport function lastChildElementByAttr(parent, attr) {\n  assertIsName(attr);\n  return lastChildElement(parent, (el) => {\n    return el.hasAttribute(attr);\n  });\n}\n\n/**\n * Finds all child elements that has the specified attribute.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} attr\n * @return {!NodeList<!Element>}\n */\nexport function childElementsByAttr(parent, attr) {\n  assertIsName(attr);\n  return /*OK*/ scopedQuerySelectorAll(parent, `> [${attr}]`);\n}\n\n/**\n * Finds the first child element that has the specified tag name.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} tagName\n * @return {?Element}\n */\nexport function childElementByTag(parent, tagName) {\n  assertIsName(tagName);\n  return /*OK*/ scopedQuerySelector(parent, `> ${tagName}`);\n}\n\n/**\n * Finds all child elements with the specified tag name.\n * @param {!Element|!ShadowRoot} parent\n * @param {string} tagName\n * @return {!NodeList<!Element>}\n */\nexport function childElementsByTag(parent, tagName) {\n  assertIsName(tagName);\n  return /*OK*/ scopedQuerySelectorAll(parent, `> ${tagName}`);\n}\n\n/**\n * Finds the first descendant element with the specified name.\n * @param {!Element|!Document|!ShadowRoot} element\n * @param {string} tagName\n * @return {?Element}\n */\nexport function elementByTag(element, tagName) {\n  assertIsName(tagName);\n  return element./*OK*/ querySelector(tagName);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Externs declare that access `defaultView` from `document` or\n * `ownerDocument` is of type `(Window|null)` but most of our parameter types\n * assume that it is never null. This is OK in practice as we ever only get\n * null on disconnected documents or old IE.\n * This helper function casts it into just a simple Window return type.\n *\n * @param {?Window} winOrNull\n * @return {!Window}\n */\nexport function toWin(winOrNull) {\n  return /** @type {!Window} */ (winOrNull);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {dev, devAssert} from './log';\nimport {dict} from './core/types/object';\nimport {includes} from './core/types/string';\nimport {matches} from './core/dom/query';\nimport {toWin} from './core/window';\n\nconst HTML_ESCAPE_CHARS = {\n  '&': '&amp;',\n  '<': '&lt;',\n  '>': '&gt;',\n  '\"': '&quot;',\n  \"'\": '&#x27;',\n  '`': '&#x60;',\n};\nconst HTML_ESCAPE_REGEX = /(&|<|>|\"|'|`)/g;\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_PROMISE = '__AMP_UPG_PRM';\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_RESOLVER = '__AMP_UPG_RES';\n\n/**\n * @typedef {{\n *   bubbles: (boolean|undefined),\n *   cancelable: (boolean|undefined),\n * }}\n */\nexport let CustomEventOptionsDef;\n\n/** @const {!CustomEventOptionsDef} */\nconst DEFAULT_CUSTOM_EVENT_OPTIONS = {bubbles: true, cancelable: true};\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * callback is executed.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @param {function()} callback\n * @suppress {suspiciousCode}\n */\nexport function waitForChild(parent, checkFunc, callback) {\n  if (checkFunc(parent)) {\n    callback();\n    return;\n  }\n  /** @const {!Window} */\n  const win = toWin(parent.ownerDocument.defaultView);\n  if (IS_ESM || win.MutationObserver) {\n    /** @const {MutationObserver} */\n    const observer = new win.MutationObserver(() => {\n      if (checkFunc(parent)) {\n        observer.disconnect();\n        callback();\n      }\n    });\n    observer.observe(parent, {childList: true});\n  } else {\n    /** @const {number} */\n    const interval = win.setInterval(() => {\n      if (checkFunc(parent)) {\n        win.clearInterval(interval);\n        callback();\n      }\n    }, /* milliseconds */ 5);\n  }\n}\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * promise is resolved.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @return {!Promise}\n */\nexport function waitForChildPromise(parent, checkFunc) {\n  return new Promise((resolve) => {\n    waitForChild(parent, checkFunc, resolve);\n  });\n}\n\n/**\n * Waits for document's body to be available and ready.\n * @param {!Document} doc\n * @param {function()} callback\n */\nexport function waitForBodyOpen(doc, callback) {\n  waitForChild(doc.documentElement, () => !!doc.body, callback);\n}\n\n/**\n * Waits for document's body to be available.\n * @param {!Document} doc\n * @return {!Promise}\n */\nexport function waitForBodyOpenPromise(doc) {\n  return new Promise((resolve) => waitForBodyOpen(doc, resolve));\n}\n\n/**\n * Removes the element.\n * @param {!Element} element\n */\nexport function removeElement(element) {\n  if (element.parentElement) {\n    element.parentElement.removeChild(element);\n  }\n}\n\n/**\n * Removes all child nodes of the specified element.\n * @param {!Element|!DocumentFragment} parent\n */\nexport function removeChildren(parent) {\n  while (parent.firstChild) {\n    parent.removeChild(parent.firstChild);\n  }\n}\n\n/**\n * Copies all children nodes of element \"from\" to element \"to\". Child nodes\n * are deeply cloned. Notice, that this method should be used with care and\n * preferably on smaller subtrees.\n * @param {!Element} from\n * @param {!Element|!DocumentFragment} to\n */\nexport function copyChildren(from, to) {\n  const frag = to.ownerDocument.createDocumentFragment();\n  for (let n = from.firstChild; n; n = n.nextSibling) {\n    frag.appendChild(n.cloneNode(true));\n  }\n  to.appendChild(frag);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n * @param {?Node=} after\n */\nexport function insertAfterOrAtStart(root, element, after = null) {\n  if (!after) {\n    insertAtStart(root, element);\n    return;\n  }\n  const before = after.nextSibling;\n  root.insertBefore(element, before);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n */\nexport function insertAtStart(root, element) {\n  root.insertBefore(element, root.firstChild);\n}\n\n/**\n * Add attributes to an element.\n * @param {!Element} element\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function addAttributesToElement(element, attributes) {\n  for (const attr in attributes) {\n    element.setAttribute(attr, attributes[attr]);\n  }\n  return element;\n}\n\n/**\n * Create a new element on document with specified tagName and attributes.\n * @param {!Document} doc\n * @param {string} tagName\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function createElementWithAttributes(doc, tagName, attributes) {\n  const element = doc.createElement(tagName);\n  return addAttributesToElement(element, attributes);\n}\n\n/**\n * Returns true if node is connected (attached).\n * @param {!Node} node\n * @return {boolean}\n * @see https://dom.spec.whatwg.org/#connected\n */\nexport function isConnectedNode(node) {\n  const connected = node.isConnected;\n  if (connected !== undefined) {\n    return connected;\n  }\n\n  // \"An element is connected if its shadow-including root is a document.\"\n  let n = node;\n  do {\n    n = rootNodeFor(n);\n    if (n.host) {\n      n = n.host;\n    } else {\n      break;\n    }\n  } while (true);\n  return n.nodeType === Node.DOCUMENT_NODE;\n}\n\n/**\n * Returns the root for a given node. Does not cross shadow DOM boundary.\n * @param {!Node} node\n * @return {!Node}\n */\nexport function rootNodeFor(node) {\n  if (Node.prototype.getRootNode) {\n    // Type checker says `getRootNode` may return null.\n    return node.getRootNode() || node;\n  }\n  let n;\n  // Check isShadowRoot() is only needed for the polyfill case.\n  for (\n    n = node;\n    !!n.parentNode && !isShadowRoot(/** @type {HTMLElement} */ (n));\n    n = n.parentNode\n  ) {}\n  return n;\n}\n\n/**\n * Determines if value is actually a `ShadowRoot` node.\n * @param {HTMLElement} value\n * @return {boolean}\n */\nexport function isShadowRoot(value) {\n  if (!value) {\n    return false;\n  }\n  // Node.nodeType == DOCUMENT_FRAGMENT to speed up the tests. Unfortunately,\n  // nodeType of DOCUMENT_FRAGMENT is used currently for ShadowRoot nodes.\n  if (value.tagName == 'I-AMPHTML-SHADOW-ROOT') {\n    return true;\n  }\n  return (\n    value.nodeType == /* DOCUMENT_FRAGMENT */ 11 &&\n    Object.prototype.toString.call(value) === '[object ShadowRoot]'\n  );\n}\n\n/**\n * Returns element data-param- attributes as url parameters key-value pairs.\n * e.g. data-param-some-attr=value -> {someAttr: value}.\n * @param {!HTMLElement} element\n * @param {function(string):string=} opt_computeParamNameFunc to compute the\n *    parameter name, get passed the camel-case parameter name.\n * @param {!RegExp=} opt_paramPattern Regex pattern to match data attributes.\n * @return {!JsonObject}\n */\nexport function getDataParamsFromAttributes(\n  element,\n  opt_computeParamNameFunc,\n  opt_paramPattern\n) {\n  const computeParamNameFunc = opt_computeParamNameFunc || ((key) => key);\n  const {dataset} = element;\n  const params = dict();\n  const paramPattern = opt_paramPattern ? opt_paramPattern : /^param(.+)/;\n  for (const key in dataset) {\n    const matches = key.match(paramPattern);\n    if (matches) {\n      const param = matches[1][0].toLowerCase() + matches[1].substr(1);\n      params[computeParamNameFunc(param)] = dataset[key];\n    }\n  }\n  return params;\n}\n\n/**\n * Whether the element have a next node in the document order.\n * This means either:\n *  a. The element itself has a nextSibling.\n *  b. Any of the element ancestors has a nextSibling.\n * @param {!Element} element\n * @param {?Node} opt_stopNode\n * @return {boolean}\n */\nexport function hasNextNodeInDocumentOrder(element, opt_stopNode) {\n  let currentElement = element;\n  do {\n    if (currentElement.nextSibling) {\n      return true;\n    }\n  } while (\n    (currentElement = currentElement.parentNode) &&\n    currentElement != opt_stopNode\n  );\n  return false;\n}\n\n/**\n * Returns a clone of the content of a template element.\n *\n * Polyfill to replace .content access for browsers that do not support\n * HTMLTemplateElements natively.\n *\n * @param {!HTMLTemplateElement|!Element} template\n * @return {!DocumentFragment}\n */\nexport function templateContentClone(template) {\n  if ('content' in template) {\n    return template.content.cloneNode(true);\n  } else {\n    const content = template.ownerDocument.createDocumentFragment();\n    copyChildren(template, content);\n    return content;\n  }\n}\n\n/**\n * Iterate over an array-like.\n * Test cases: https://jsbench.github.io/#f638cacc866a1b2d6e517e6cfa900d6b\n * @param {!IArrayLike<T>} iterable\n * @param {function(T, number)} cb\n * @template T\n */\nexport function iterateCursor(iterable, cb) {\n  const {length} = iterable;\n  for (let i = 0; i < length; i++) {\n    cb(iterable[i], i);\n  }\n}\n\n/**\n * This method wraps around window's open method. It first tries to execute\n * `open` call with the provided target and if it fails, it retries the call\n * with the `_top` target. This is necessary given that in some embedding\n * scenarios, such as iOS' WKWebView, navigation to `_blank` and other targets\n * is blocked by default.\n *\n * @param {!Window} win\n * @param {string} url\n * @param {string} target\n * @param {string=} opt_features\n * @return {?Window}\n */\nexport function openWindowDialog(win, url, target, opt_features) {\n  // Try first with the specified target. If we're inside the WKWebView or\n  // a similar environments, this method is expected to fail by default for\n  // all targets except `_top`.\n  let res;\n  try {\n    res = win.open(url, target, opt_features);\n  } catch (e) {\n    dev().error('DOM', 'Failed to open url on target: ', target, e);\n  }\n\n  // Then try with `_top` target.\n  if (!res && target != '_top' && !includes(opt_features || '', 'noopener')) {\n    res = win.open(url, '_top');\n  }\n  return res;\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.hasAttribute('type') &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/JSON'\n  );\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonLdScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/LD+JSON'\n  );\n}\n\n/**\n * Whether the page's direction is right to left or not.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isRTL(doc) {\n  const dir =\n    doc.body.getAttribute('dir') ||\n    doc.documentElement.getAttribute('dir') ||\n    'ltr';\n  return dir == 'rtl';\n}\n\n/**\n * Escapes `<`, `>` and other HTML charcaters with their escaped forms.\n * @param {string} text\n * @return {string}\n */\nexport function escapeHtml(text) {\n  if (!text) {\n    return text;\n  }\n  return text.replace(HTML_ESCAPE_REGEX, escapeHtmlChar);\n}\n\n/**\n * @param {string} c\n * @return {string}\n */\nfunction escapeHtmlChar(c) {\n  return HTML_ESCAPE_CHARS[c];\n}\n\n/**\n * Tries to focus on the given element; fails silently if browser throws an\n * exception.\n * @param {!Element} element\n */\nexport function tryFocus(element) {\n  try {\n    element./*OK*/ focus();\n  } catch (e) {\n    // IE <= 7 may throw exceptions when focusing on hidden items.\n  }\n}\n\n/**\n * Whether the given window is in an iframe or not.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isIframed(win) {\n  return win.parent && win.parent != win;\n}\n\n/**\n * Determines if this element is an AMP element\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isAmpElement(element) {\n  const tag = element.tagName;\n  // Use prefix to recognize AMP element. This is necessary because stub\n  // may not be attached yet.\n  return (\n    tag.startsWith('AMP-') &&\n    // Some \"amp-*\" elements are not really AMP elements. :smh:\n    !(tag == 'AMP-STICKY-AD-TOP-PADDING' || tag == 'AMP-BODY')\n  );\n}\n\n/**\n * Return a promise that resolve when an AMP element upgrade from HTMLElement\n * to CustomElement\n * @param {!HTMLElement} element\n * @return {!Promise<!AmpElement>}\n */\nexport function whenUpgradedToCustomElement(element) {\n  devAssert(isAmpElement(element), 'element is not AmpElement');\n  if (element.createdCallback) {\n    // Element already is CustomElement;\n    return Promise.resolve(/**@type {!AmpElement} */ (element));\n  }\n  // If Element is still HTMLElement, wait for it to upgrade to customElement\n  // Note: use pure string to avoid obfuscation between versions.\n  if (!element[UPGRADE_TO_CUSTOMELEMENT_PROMISE]) {\n    const deferred = new Deferred();\n    element[UPGRADE_TO_CUSTOMELEMENT_PROMISE] = deferred.promise;\n    element[UPGRADE_TO_CUSTOMELEMENT_RESOLVER] = deferred.resolve;\n  }\n\n  return element[UPGRADE_TO_CUSTOMELEMENT_PROMISE];\n}\n\n/**\n * Returns true if node is not disabled.\n *\n * IE8 can return false positives, see {@link matches}.\n * @param {!HTMLInputElement} element\n * @return {boolean}\n * @see https://www.w3.org/TR/html5/forms.html#concept-fe-disabled\n */\nexport function isEnabled(element) {\n  return !(element.disabled || matches(element, ':disabled'));\n}\n\n/**\n * A sorting comparator that sorts elements in DOM tree order.\n * A first sibling is sorted to be before its nextSibling.\n * A parent node is sorted to be before a child.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/compareDocumentPosition\n *\n * @param {!Element} element1\n * @param {!Element} element2\n * @return {number}\n */\nexport function domOrderComparator(element1, element2) {\n  if (element1 === element2) {\n    return 0;\n  }\n\n  const pos = element1.compareDocumentPosition(element2);\n  const precedingOrContains =\n    Node.DOCUMENT_POSITION_PRECEDING | Node.DOCUMENT_POSITION_CONTAINS;\n\n  // if fe2 is preceding or contains fe1 then, fe1 is after fe2\n  if (pos & precedingOrContains) {\n    return 1;\n  }\n\n  // if fe2 is following or contained by fe1, then fe1 is before fe2\n  return -1;\n}\n\n/**\n * Like `Element.prototype.toggleAttribute`. This either toggles an attribute\n * on by adding an attribute with an empty value, or toggles it off by removing\n * the attribute. This does not mutate the element if the new state matches\n * the existing state.\n * @param {!Element} element An element to toggle the attribute for.\n * @param {string} name The name of the attribute.\n * @param {boolean=} forced Whether the attribute should be forced on/off. If\n *    not specified, it will be toggled from the current state.\n * @return {boolean} Whether or not the element now has the attribute.\n */\nexport function toggleAttribute(element, name, forced) {\n  const hasAttribute = element.hasAttribute(name);\n  const enabled = forced !== undefined ? forced : !hasAttribute;\n\n  if (enabled !== hasAttribute) {\n    if (enabled) {\n      element.setAttribute(name, '');\n    } else {\n      element.removeAttribute(name);\n    }\n  }\n\n  return enabled;\n}\n\n/**\n * Parses a string as a boolean value using the expanded rules for DOM boolean\n * attributes:\n * - a `null` or `undefined` returns `null`;\n * - an empty string returns `true`;\n * - a \"false\" string returns `false`;\n * - otherwise, `true` is returned.\n *\n * @param {?string|undefined} s\n * @return {boolean|undefined}\n */\nexport function parseBooleanAttribute(s) {\n  return s == null ? undefined : s !== 'false';\n}\n\n/**\n * @param {!Window} win\n * @return {number} The width of the vertical scrollbar, in pixels.\n */\nexport function getVerticalScrollbarWidth(win) {\n  const {documentElement} = win.document;\n  const windowWidth = win./*OK*/ innerWidth;\n  const documentWidth = documentElement./*OK*/ clientWidth;\n  return windowWidth - documentWidth;\n}\n\n/**\n * Dispatches a custom event.\n *\n * @param {!Node} node\n * @param {string} name\n * @param {!Object=} opt_data Event data.\n * @param {!CustomEventOptionsDef=} opt_options\n */\nexport function dispatchCustomEvent(node, name, opt_data, opt_options) {\n  const data = opt_data || {};\n  // Constructors of events need to come from the correct window. Sigh.\n  const event = node.ownerDocument.createEvent('Event');\n\n  // Technically .data is not a property of Event.\n  /**@type {?}*/ (event).data = data;\n\n  const {bubbles, cancelable} = opt_options || DEFAULT_CUSTOM_EVENT_OPTIONS;\n  event.initEvent(name, bubbles, cancelable);\n  node.dispatchEvent(event);\n}\n\n/**\n * Ensures the child is contained by the parent, but not the parent itself.\n *\n * @param {!Node} parent\n * @param {!Node} child\n * @return {boolean}\n */\nexport function containsNotSelf(parent, child) {\n  return child !== parent && parent.contains(child);\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {dev} from './log';\nimport {whenUpgradedToCustomElement} from './dom';\n\nexport const MIN_VISIBILITY_RATIO_FOR_AUTOPLAY = 0.5;\n\n/**\n * VideoInterface defines a common video API which any AMP component that plays\n * videos is expected to implement.\n *\n * AMP runtime uses this common API to provide consistent video experience and\n * analytics across all video players.\n *\n * Components implementing this interface must also extend\n * {@link ./base-element.BaseElement} and register with the\n * Video Manager {@link ./service/video-manager-impl.VideoManager} during\n * their `builtCallback`.\n *\n * @interface\n */\nexport class VideoInterface {\n  /**\n   * See `BaseElement`.\n   * @return {!./utils/signals.Signals}\n   */\n  signals() {}\n\n  /**\n   * See `BaseElement`.\n   * @param {function()} unusedMutator\n   * @return {!Promise}\n   */\n  mutateElementSkipRemeasure(unusedMutator) {}\n\n  /**\n   * Whether the component supports video playback in the current platform.\n   * If false, component will be not treated as a video component.\n   * @return {boolean}\n   */\n  supportsPlatform() {}\n\n  /**\n   * Whether users can interact with the video such as pausing it.\n   * Example of non-interactive videos include design background videos where\n   * all controls are hidden from the user.\n   *\n   * @return {boolean}\n   */\n  isInteractive() {}\n\n  /**\n   * Current playback time in seconds at time of trigger.\n   *\n   * This is used for analytics metadata.\n   *\n   * @return {number}\n   */\n  getCurrentTime() {}\n\n  /**\n   * Total duration of the video in seconds\n   *\n   * This is used for analytics metadata.\n   *\n   * @return {number}\n   */\n  getDuration() {}\n\n  /**\n   * Get a 2d array of start and stop times that the user has watched.\n   * This is used for analytics metadata.\n   * @return {!Array<Array<number>>}\n   */\n  getPlayedRanges() {}\n\n  /**\n   * Plays the video.\n   *\n   * @param {boolean} unusedIsAutoplay Whether the call to the `play` method is\n   * triggered by the autoplay functionality. Video players can use this hint\n   * to make decisions such as not playing pre-roll video ads.\n   */\n  play(unusedIsAutoplay) {}\n\n  /**\n   * Pauses the video.\n   */\n  pause() {}\n\n  /**\n   * Mutes the video.\n   * Implementation is required for autoplay and mute/unmute controls on docked\n   * video.\n   */\n  mute() {}\n\n  /**\n   * Unmutes the video.\n   * Implementation is required for autoplay and mute/unmute controls on docked\n   * video.\n   */\n  unmute() {}\n\n  /**\n   * Makes the video UI controls visible.\n   *\n   * AMP will not call this method if `controls` attribute is not set.\n   *\n   * Implementation is required for docked video.\n   */\n  showControls() {}\n\n  /**\n   * Hides the video UI controls.\n   *\n   * AMP will not call this method if `controls` attribute is not set.\n   *\n   * Implementation is required for docked video.\n   */\n  hideControls() {}\n\n  /**\n   * Returns video's meta data (artwork, title, artist, album, etc.) for use\n   * with the Media Session API\n   * @return {!./mediasession-helper.MetadataDef|undefined} metadata\n   *   - artwork (Array): URL to the poster image (preferably a 512x512 PNG)\n   *   - title (string): Name of the video\n   *   - artist (string): Name of the video's author/artist\n   *   - album (string): Name of the video's album if it exists\n   */\n  getMetadata() {}\n\n  /**\n   * If returning true, it's assumed that the embedded video document internally\n   * implements a feature to enter fullscreen on device rotation, so that the\n   * VideoManager does not override it.\n   *\n   * Otherwise, the feature is implemented automatically when using the\n   * `rotate-to-fullscreen` attribute.\n   *\n   * @return {boolean}\n   */\n  preimplementsAutoFullscreen() {}\n\n  /**\n   * If returning true, it's assumed that the embedded video document internally\n   * implements the MediaSession API internally so that the VideoManager won't\n   * replace it.\n   *\n   * Otherwise provided and inferred metadata are used to update the video's\n   * Media Session.\n   *\n   * @return {boolean}\n   */\n  preimplementsMediaSessionAPI() {}\n\n  /**\n   * Enables fullscreen on the internal video element\n   * NOTE: While implementing, keep in mind that Safari/iOS do not allow taking\n   * any element other than <video> to fullscreen, if the player has an internal\n   * implementation of fullscreen (flash for example) then check\n   * if Services.platformFor(this.win).isSafari is true and use the internal\n   * implementation instead. If not, it is recommended to take the iframe\n   * to fullscreen using fullscreenEnter from dom.js\n   */\n  fullscreenEnter() {}\n\n  /**\n   * Quits fullscreen mode\n   */\n  fullscreenExit() {}\n\n  /**\n   * Returns whether the video is currently in fullscreen mode or not.\n   * @return {boolean}\n   */\n  isFullscreen() {}\n\n  /**\n   * Seeks the video to a specified time.\n   * @param {number} unusedTimeSeconds\n   */\n  seekTo(unusedTimeSeconds) {}\n}\n\n/** @type {!AmpElement} */\nVideoInterface.prototype.element;\n\n/** @type {!Window} */\nVideoInterface.prototype.win;\n\n/**\n * Attributes\n *\n * Components implementing the VideoInterface are expected to support\n * the following attributes.\n *\n * @enum {string}\n */\nexport const VideoAttributes = {\n  /**\n   * autoplay\n   *\n   * Whether the developer has configured autoplay on the component.\n   * This is normally done by setting `autoplay` attribute on the component.\n   *\n   * AMP runtime manages autoplay behavior itself using methods such as `play`,\n   * `pause`, `showControls`, `hideControls`, `mute`, etc.. therefore components\n   * should not propagate the autoplay attribute to the underlying player\n   * implementation.\n   *\n   * When a video is requested to autoplay, AMP will automatically\n   * mute and hide the controls for the video, when video is 75% visible in\n   * the viewport, AMP will play the video and later pauses it when 25%\n   * or more of the video exits the viewport. If an auto-playing video also has\n   * controls, AMP will install a tap\n   * handler on the video, and when an end-user taps the video, AMP will show\n   * the controls.\n   *\n   */\n  AUTOPLAY: 'autoplay',\n  /**\n   * dock\n   *\n   * Setting the `dock` attribute on the component makes the video minimize\n   * to the corner when scrolled out of view and has been interacted with.\n   */\n  DOCK: 'dock',\n  /**\n   * rotate-to-fullscreen\n   *\n   * If enabled, this automatically expands the currently visible video and\n   * playing to fullscreen when the user changes the device's orientation to\n   * landscape if the video was started following a user interaction\n   * (not autoplay)\n   *\n   * Dependent upon browser support of\n   * http://caniuse.com/#feat=screen-orientation\n   * and http://caniuse.com/#feat=fullscreen\n   */\n  ROTATE_TO_FULLSCREEN: 'rotate-to-fullscreen',\n  /**\n   * noaudio\n   *\n   * If set and autoplay, the equalizer icon will not be displayed.\n   */\n  NO_AUDIO: 'noaudio',\n};\n\n/**\n * Events\n *\n * Components implementing the VideoInterface are expected to dispatch\n * the following DOM events.\n *\n * @enum {string}\n */\nexport const VideoEvents = {\n  /**\n   * registered\n   *\n   * Fired when the video player element is built and has been registered with\n   * the video manager.\n   *\n   * @event registered\n   */\n  REGISTERED: 'registered',\n\n  /**\n   * load\n   *\n   * Fired when the video player is loaded and calls to methods such as `play()`\n   * are allowed.\n   *\n   * @event load\n   */\n  LOAD: 'load',\n\n  /**\n   * loadedmetadata\n   *\n   * Fired when the video's metadata becomes available (e.g. duration).\n   *\n   * @event loadedmetadata\n   */\n  LOADEDMETADATA: 'loadedmetadata',\n\n  /**\n   * loadeddata\n   *\n   * Fired when the user agent can render the media for the first time.\n   *\n   * @event loadeddata\n   */\n  LOADEDDATA: 'loadeddata',\n\n  /**\n   * play\n   *\n   * Fired when the video plays (either because of autoplay or the play method).\n   *\n   * Note: Because this event was not originally present in this interface, we\n   * cannot rely on all all implementations to emit it.\n   *\n   * @event play\n   */\n  PLAY: 'play',\n\n  /**\n   * playing\n   *\n   * Fired when the video begins playing.\n   *\n   * @event playing\n   */\n  PLAYING: 'playing',\n\n  /**\n   * pause\n   *\n   * Fired when the video pauses.\n   *\n   * @event pause\n   */\n  PAUSE: 'pause',\n\n  /**\n   * ended\n   *\n   * Fired when the video ends.\n   *\n   * This event should be fired in addition to `pause` when video ends.\n   *\n   * @event ended\n   */\n  ENDED: 'ended',\n\n  /**\n   * muted\n   *\n   * Fired when the video is muted.\n   *\n   * @event muted\n   */\n  MUTED: 'muted',\n\n  /**\n   * unmuted\n   *\n   * Fired when the video is unmuted.\n   *\n   * @event unmuted\n   */\n  UNMUTED: 'unmuted',\n\n  /**\n   * amp:video:visibility\n   *\n   * Fired when the video's visibility changes.\n   *\n   * @event amp:video:visibility\n   * @property {boolean} visible Whether the video player is visible or not.\n   */\n  VISIBILITY: 'amp:video:visibility',\n\n  /**\n   * reload\n   *\n   * Fired when the video's src changes.\n   *\n   * @event reloaded\n   */\n  RELOAD: 'reloaded',\n\n  /**\n   * pre/mid/post Ad start\n   *\n   * Fired when an Ad starts playing.\n   *\n   * This is used to remove any overlay shims during Ad play during autoplay\n   * or minimized-to-corner version of the player.\n   *\n   * @event ad_start\n   */\n  AD_START: 'ad_start',\n\n  /**\n   * pre/mid/post Ad ends\n   *\n   * Fired when an Ad ends playing.\n   *\n   * This is used to restore any overlay shims during Ad play during autoplay\n   * or minimized-to-corner version of the player.\n   *\n   * @event ad_end\n   */\n  AD_END: 'ad_end',\n\n  /**\n   * A 3p video player can send signals for analytics whose meaning doesn't\n   * fit for other events. In this case, a `tick` event is sent with additional\n   * information in its data property.\n   *\n   * @event amp:video:tick\n   */\n  CUSTOM_TICK: 'amp:video:tick',\n};\n\n/** @typedef {string} */\nexport let PlayingStateDef;\n\n/**\n * Playing States\n *\n * Internal playing states used to distinguish between video playing on user's\n * command and videos playing automatically\n *\n * @enum {string}\n */\nexport const PlayingStates = {\n  /**\n   * playing_manual\n   *\n   * When the video user manually interacted with the video and the video\n   * is now playing\n   *\n   * @event playing_manual\n   */\n  PLAYING_MANUAL: 'playing_manual',\n\n  /**\n   * playing_auto\n   *\n   * When the video has autoplay and the user hasn't interacted with it yet\n   *\n   * @event playing_auto\n   */\n  PLAYING_AUTO: 'playing_auto',\n\n  /**\n   * paused\n   *\n   * When the video is paused.\n   *\n   * @event paused\n   */\n  PAUSED: 'paused',\n};\n\n/** @enum {string} */\nexport const VideoAnalyticsEvents = {\n  /**\n   * video-ended\n   *\n   * Indicates that a video ended.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-ended\n   */\n  ENDED: 'video-ended',\n\n  /**\n   * video-pause\n   *\n   * Indicates that a video paused.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-pause\n   */\n  PAUSE: 'video-pause',\n\n  /**\n   * video-play\n   *\n   * Indicates that a video began to play.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-play\n   */\n  PLAY: 'video-play',\n\n  /**\n   * video-session\n   *\n   * Indicates that some segment of the video played.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-session\n   */\n  SESSION: 'video-session',\n\n  /**\n   * video-session-visible\n   *\n   * Indicates that some segment of the video played in the viewport.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-session-visible\n   */\n  SESSION_VISIBLE: 'video-session-visible',\n\n  /**\n   * video-seconds-played\n   *\n   * Indicates that a video was playing when the\n   * video-seconds-played interval fired.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-session-visible\n   */\n  SECONDS_PLAYED: 'video-seconds-played',\n\n  /**\n   * video-hosted-custom\n   *\n   * Indicates that a custom event incoming from a 3p frame is to be logged.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-custom\n   */\n  CUSTOM: 'video-hosted-custom',\n\n  /**\n   * video-percentage-played\n   *\n   * Indicates that a percentage interval has been played.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-custom\n   */\n  PERCENTAGE_PLAYED: 'video-percentage-played',\n\n  /**\n   * video-ad-start\n   *\n   * Indicates that an ad begins to play.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-ad-start\n   */\n  AD_START: 'video-ad-start',\n\n  /**\n   * video-ad-end\n   *\n   * Indicates that an ad ended.\n   * @property {!VideoAnalyticsDetailsDef} details\n   * @event video-ad-end\n   */\n  AD_END: 'video-ad-end',\n};\n\n/**\n * This key can't predictably collide with custom var names as defined in\n * analytics user configuration.\n * @type {string}\n */\nexport const videoAnalyticsCustomEventTypeKey = '__amp:eventType';\n\n/**\n * Helper union type to be used internally, so that the compiler treats\n * `VideoInterface` objects as `BaseElement`s, which they should be anyway.\n *\n * WARNING: Don't use to `register` at the Service level. Registering should\n * only allow `VideoInterface` as a guarding measure.\n *\n * @typedef {!VideoInterface|!./base-element.BaseElement}\n */\nexport let VideoOrBaseElementDef;\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isDockable(element) {\n  return element.hasAttribute(VideoAttributes.DOCK);\n}\n\n/** @enum {string} */\nexport const VideoServiceSignals = {\n  USER_INTERACTED: 'user-interacted',\n  PLAYBACK_DELEGATED: 'playback-delegated',\n};\n\n/** @param {!AmpElement|!VideoOrBaseElementDef} video */\nexport function delegateAutoplay(video) {\n  whenUpgradedToCustomElement(dev().assertElement(video)).then((el) => {\n    el.signals().signal(VideoServiceSignals.PLAYBACK_DELEGATED);\n  });\n}\n\n/** @param {!AmpElement|!VideoOrBaseElementDef} video */\nexport function userInteractedWith(video) {\n  video.signals().signal(VideoServiceSignals.USER_INTERACTED);\n}\n\n/**\n * Classname that media components should annotate themselves with.\n * This applies to all video and audio playback components, regardless of\n * whether they implement a common interface or not.\n *\n * TODO(go.amp.dev/issue/26984): This isn't exclusive to video, but there's no\n * better place to put this now due to OWNERShip. Move.\n */\nexport const MEDIA_COMPONENT_CLASSNAME = 'i-amphtml-media-component';\n\n/**\n * Annotates media component element with a common classname.\n * This applies to all video and audio playback components, regardless of\n * whether they implement a common interface or not.\n * @param {!Element} element\n *\n * TODO(go.amp.dev/issue/26984): This isn't exclusive to video, but there's no\n * better place to put this now due to OWNERShip. Move.\n */\nexport function setIsMediaComponent(element) {\n  element.classList.add(MEDIA_COMPONENT_CLASSNAME);\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Registration and getter functions for AMP services.\n *\n * Invariant: Service getters never return null for registered services.\n */\n\nimport {Deferred} from './core/data-structures/promise';\nimport {dev, devAssert} from './log';\nimport {toWin} from './core/window';\n\n/**\n * Holds info about a service.\n * - obj: Actual service implementation when available.\n * - promise: Promise for the obj.\n * - resolve: Function to resolve the promise with the object.\n * - context: Argument for ctor, either a window or an ampdoc.\n * - ctor: Function that constructs and returns the service.\n * @typedef {{\n *   obj: (?Object),\n *   promise: (?Promise),\n *   resolve: (?function(!Object)),\n *   reject: (?function((*))),\n *   context: (?Window|?./service/ampdoc-impl.AmpDoc),\n *   ctor: (function(new:Object, !Window)|\n *          function(new:Object, !./service/ampdoc-impl.AmpDoc)),\n * }}\n */\nlet ServiceHolderDef;\n\n/**\n * This interface provides a `dispose` method that will be called by\n * runtime when a service needs to be disposed of.\n * @interface\n */\nexport class Disposable {\n  /**\n   * Instructs the service to release any resources it might be holding. Can\n   * be called only once in the lifecycle of a service.\n   */\n  dispose() {}\n}\n\n/**\n * Installs a service override on amp-doc level.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n * @param {!Object} service The service.\n */\nexport function installServiceInEmbedDoc(ampdoc, id, service) {\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    function () {\n      return service;\n    },\n    /* override */ true\n  );\n}\n\n/**\n * Installs a service override in the scope of an embedded window.\n * @param {!Window} embedWin\n * @param {string} id\n * @param {function(new:Object, !Window)} constructor\n */\nexport function registerServiceBuilderInEmbedWin(embedWin, id, constructor) {\n  registerServiceInternal(\n    embedWin,\n    embedWin,\n    id,\n    constructor,\n    /* override */ true\n  );\n}\n\n/**\n * Registers a service given a class to be used as implementation.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {function(new:Object, !Window)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilder(win, id, constructor, opt_instantiate) {\n  win = getTopWindow(win);\n  registerServiceInternal(win, win, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(win, id);\n  }\n}\n\n/**\n * Returns a service and registers it given a class to be used as\n * implementation.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id of the service.\n * @param {function(new:Object, !./service/ampdoc-impl.AmpDoc)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilderForDoc(\n  nodeOrDoc,\n  id,\n  constructor,\n  opt_instantiate\n) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  registerServiceInternal(holder, ampdoc, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * Reject a service promise.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id\n * @param {*} error\n */\nexport function rejectServicePromiseForDoc(nodeOrDoc, id, error) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  rejectServicePromiseInternal(holder, id, error);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). Users\n * should typically wrap this as a special purpose function (e.g.\n * `Services.vsyncFor(win)`) for type safety and because the factory should not\n * be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getService(win, id) {\n  win = getTopWindow(win);\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). But\n * it looks in the immediate window scope, not the top-level window.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getServiceInEmbedWin(win, id) {\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. `Services.vsyncFor(win)`) for type safety and because the\n * factory should not be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nexport function getServicePromise(win, id) {\n  return getServicePromiseInternal(win, id);\n}\n\n/**\n * Returns a service or null with the given id.\n * @param {!Window} win\n * @param {string} id\n * @return {?Object} The service.\n */\nexport function getExistingServiceOrNull(win, id) {\n  win = getTopWindow(win);\n  if (isServiceRegistered(win, id)) {\n    return getServiceInternal(win, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Like getServicePromise but returns null if the service was never registered.\n * @param {!Window} win\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNull(win, id) {\n  return getServicePromiseOrNullInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * Expects service `id` to be registered.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {T}\n * @template T\n */\nexport function getServiceForDoc(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  return getServiceInternal(holder, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * If service `id` is not registered, returns null.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Object}\n */\nexport function getServiceForDocOrNull(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  if (isServiceRegistered(holder, id)) {\n    return getServiceInternal(holder, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Returns a promise for a service for the given id and ampdoc. Also expects\n * a service that has the actual implementation. The promise resolves when\n * the implementation loaded.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {!Promise<!Object>}\n */\nexport function getServicePromiseForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseInternal(getAmpdocServiceHolder(elementOrAmpDoc), id);\n}\n\n/**\n * Like getServicePromiseForDoc but returns null if the service was never\n * registered for this ampdoc.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNullForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseOrNullInternal(\n    getAmpdocServiceHolder(elementOrAmpDoc),\n    id\n  );\n}\n\n/**\n * Set the parent and top windows on a child window (friendly iframe).\n * @param {!Window} win\n * @param {!Window} parentWin\n */\nexport function setParentWindow(win, parentWin) {\n  win.__AMP_PARENT = parentWin;\n  win.__AMP_TOP = getTopWindow(parentWin);\n}\n\n/**\n * Returns the parent window for a child window (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getParentWindow(win) {\n  return win.__AMP_PARENT || win;\n}\n\n/**\n * Returns the top window where AMP Runtime is installed for a child window\n * (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getTopWindow(win) {\n  return win.__AMP_TOP || (win.__AMP_TOP = win);\n}\n\n/**\n * Returns the parent \"friendly\" iframe if the node belongs to a child window.\n * @param {!Node} node\n * @param {!Window=} opt_topWin\n * @return {?HTMLIFrameElement}\n */\nexport function getParentWindowFrameElement(node, opt_topWin) {\n  const childWin = (node.ownerDocument || node).defaultView;\n  const topWin = opt_topWin || getTopWindow(childWin);\n  if (childWin && childWin != topWin && getTopWindow(childWin) == topWin) {\n    try {\n      return /** @type {?HTMLIFrameElement} */ (childWin.frameElement);\n    } catch (e) {\n      // Ignore the error.\n    }\n  }\n  return null;\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc}\n */\nexport function getAmpdoc(nodeOrDoc) {\n  if (nodeOrDoc.nodeType) {\n    const win = toWin(\n      /** @type {!Document} */ (nodeOrDoc.ownerDocument || nodeOrDoc)\n        .defaultView\n    );\n    return getAmpdocService(win).getAmpDoc(/** @type {!Node} */ (nodeOrDoc));\n  }\n  return /** @type {!./service/ampdoc-impl.AmpDoc} */ (nodeOrDoc);\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc|!Window}\n */\nfunction getAmpdocServiceHolder(nodeOrDoc) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  return ampdoc.isSingleDoc() ? ampdoc.win : ampdoc;\n}\n\n/**\n * This is essentially a duplicate of `ampdoc.js`, but necessary to avoid\n * circular dependencies.\n * @param {!Window} win\n * @return {!./service/ampdoc-impl.AmpDocService}\n */\nfunction getAmpdocService(win) {\n  return /** @type {!./service/ampdoc-impl.AmpDocService} */ (\n    getService(win, 'ampdoc')\n  );\n}\n\n/**\n * Get service `id` from `holder`. Assumes the service\n * has already been registered.\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {Object}\n */\nfunction getServiceInternal(holder, id) {\n  devAssert(\n    isServiceRegistered(holder, id),\n    `Expected service ${id} to be registered`\n  );\n  const services = getServices(holder);\n  const s = services[id];\n  if (!s.obj) {\n    devAssert(s.ctor, `Service ${id} registered without ctor nor impl.`);\n    devAssert(s.context, `Service ${id} registered without context.`);\n    s.obj = new s.ctor(s.context);\n    devAssert(s.obj, `Service ${id} constructed to null.`);\n    s.context = null;\n    // The service may have been requested already, in which case we have a\n    // pending promise we need to fulfill.\n    if (s.resolve) {\n      s.resolve(s.obj);\n    }\n  }\n  return s.obj;\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {!Window|!./service/ampdoc-impl.AmpDoc} context Win or AmpDoc.\n * @param {string} id of the service.\n * @param {?function(new:Object, !Window)|?function(new:Object, !./service/ampdoc-impl.AmpDoc)} ctor Constructor function to new the service. Called with context.\n * @param {boolean=} opt_override\n * @param {boolean=} opt_sharedInstance\n */\nfunction registerServiceInternal(\n  holder,\n  context,\n  id,\n  ctor,\n  opt_override,\n  opt_sharedInstance\n) {\n  const services = getServices(holder);\n  let s = services[id];\n\n  if (!s) {\n    s = services[id] = {\n      obj: null,\n      promise: null,\n      resolve: null,\n      reject: null,\n      context: null,\n      ctor: null,\n      sharedInstance: opt_sharedInstance || false,\n    };\n  }\n\n  if (!opt_override && s.ctor) {\n    // Service already registered.\n    return;\n  }\n\n  s.ctor = ctor;\n  s.context = context;\n  s.sharedInstance = opt_sharedInstance || false;\n\n  // The service may have been requested already, in which case there is a\n  // pending promise that needs to fulfilled.\n  if (s.resolve) {\n    // getServiceInternal will resolve the promise.\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nfunction getServicePromiseInternal(holder, id) {\n  const cached = getServicePromiseOrNullInternal(holder, id);\n  if (cached) {\n    return cached;\n  }\n  // Service is not registered.\n\n  // TODO(@cramforce): Add a check that if the element is eventually registered\n  // that the service is actually provided and this promise resolves.\n  const services = getServices(holder);\n  services[id] = emptyServiceHolderWithPromise();\n  return /** @type {!Promise<!Object>} */ (services[id].promise);\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @param {*} error\n */\nfunction rejectServicePromiseInternal(holder, id, error) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.reject) {\n      s.reject(error);\n    }\n    return;\n  }\n\n  services[id] = emptyServiceHolderWithPromise();\n  services[id].reject(error);\n}\n\n/**\n * Returns a promise for service `id` if the service has been registered\n * on `holder`.\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {?Promise<!Object>}\n */\nfunction getServicePromiseOrNullInternal(holder, id) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.promise) {\n      return s.promise;\n    } else {\n      // Instantiate service if not already instantiated.\n      getServiceInternal(holder, id);\n      return (s.promise = Promise.resolve(/** @type {!Object} */ (s.obj)));\n    }\n  }\n  return null;\n}\n\n/**\n * Returns the object that holds the services registered in a holder.\n * @param {!Object} holder\n * @return {!Object<string,!ServiceHolderDef>}\n */\nfunction getServices(holder) {\n  let services = holder.__AMP_SERVICES;\n  if (!services) {\n    services = holder.__AMP_SERVICES = {};\n  }\n  return services;\n}\n\n/**\n * Whether the specified service implements `Disposable` interface.\n * @param {!Object} service\n * @return {boolean}\n */\nexport function isDisposable(service) {\n  return typeof service.dispose == 'function';\n}\n\n/**\n * Asserts that the specified service implements `Disposable` interface and\n * typecasts the instance to `Disposable`.\n * @param {!Object} service\n * @return {!Disposable}\n */\nexport function assertDisposable(service) {\n  devAssert(isDisposable(service), 'required to implement Disposable');\n  return /** @type {!Disposable} */ (service);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * ampdoc scope.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function disposeServicesForDoc(ampdoc) {\n  disposeServicesInternal(ampdoc);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * embed scope.\n * @param {!Window} embedWin\n */\nexport function disposeServicesForEmbed(embedWin) {\n  disposeServicesInternal(embedWin);\n}\n\n/**\n * @param {!Object} holder Object holding the service instances.\n */\nfunction disposeServicesInternal(holder) {\n  const services = getServices(holder);\n  for (const id in services) {\n    if (!Object.prototype.hasOwnProperty.call(services, id)) {\n      continue;\n    }\n    const serviceHolder = services[id];\n    if (serviceHolder.sharedInstance) {\n      continue;\n    }\n    if (serviceHolder.obj) {\n      disposeServiceInternal(id, serviceHolder.obj);\n    } else if (serviceHolder.promise) {\n      serviceHolder.promise.then((instance) =>\n        disposeServiceInternal(id, instance)\n      );\n    }\n  }\n}\n\n/**\n * @param {string} id\n * @param {!Object} service\n */\nfunction disposeServiceInternal(id, service) {\n  if (!isDisposable(service)) {\n    return;\n  }\n  try {\n    assertDisposable(service).dispose();\n  } catch (e) {\n    // Ensure that a failure to dispose a service does not disrupt other\n    // services.\n    dev().error('SERVICE', 'failed to dispose service', id, e);\n  }\n}\n\n/**\n * This adopts the service **instance** from the parent.\n *\n * This function is dangerous! Sharing an instance means data can leak to and\n * from a child ampdoc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceForEmbedDoc(ampdoc, id) {\n  const service = getServiceInternal(\n    getAmpdocServiceHolder(devAssert(ampdoc.getParent())),\n    id\n  );\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    function () {\n      return service;\n    },\n    /* override */ false,\n    /* sharedInstance */ true\n  );\n}\n\n/**\n * This adopts the service **factory** from the parent.\n *\n * This function is safer than sharing the service instance, since each ampdoc\n * will create its own instance of the factory (and each instance will have its\n * own instance data). Note that static data is still shared, so it's not 100%\n * foolproof.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceFactoryForEmbedDoc(ampdoc, id) {\n  const parentHolder = getAmpdocServiceHolder(devAssert(ampdoc.getParent()));\n  devAssert(\n    isServiceRegistered(parentHolder, id),\n    `Expected service ${id} to be registered`\n  );\n  const service = getServices(parentHolder)[id];\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    devAssert(service.ctor)\n  );\n}\n\n/**\n * Resets a single service, so it gets recreated on next getService invocation.\n * @param {!Object} holder\n * @param {string} id of the service.\n */\nexport function resetServiceForTesting(holder, id) {\n  if (holder.__AMP_SERVICES) {\n    holder.__AMP_SERVICES[id] = null;\n  }\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {boolean}\n */\nfunction isServiceRegistered(holder, id) {\n  const service = holder.__AMP_SERVICES && holder.__AMP_SERVICES[id];\n  // All registered services must have a constructor.\n  return !!(service && service.ctor);\n}\n\n/** @return {!ServiceHolderDef} */\nfunction emptyServiceHolderWithPromise() {\n  const deferred = new Deferred();\n  const {promise, reject, resolve} = deferred;\n  promise.catch(() => {}); // avoid uncaught exception when service gets rejected\n  return {\n    obj: null,\n    promise,\n    resolve,\n    reject,\n    context: null,\n    ctor: null,\n  };\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from '../mode';\nimport {urls} from '../config';\n\nconst CUSTOM_TEMPLATES = ['amp-mustache'];\nconst LATEST_VERSION = 'latest';\n\n/**\n * Calculate the base url for any scripts.\n * @param {!Location} location The window's location\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateScriptBaseUrl(location, opt_isLocalDev) {\n  if (opt_isLocalDev) {\n    let prefix = `${location.protocol}//${location.host}`;\n    if (\n      location.protocol == 'about:' ||\n      location.protocol == 'blob:' ||\n      location.protocol == 'data:'\n    ) {\n      prefix = '';\n    }\n    return `${prefix}/dist`;\n  }\n  return urls.cdn;\n}\n\n/**\n * Calculate script url for an extension.\n * @param {!Location} location The window's location\n * @param {string} extensionId\n * @param {string} version\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateExtensionScriptUrl(\n  location,\n  extensionId,\n  version,\n  opt_isLocalDev\n) {\n  const fileExtension = getMode().esm ? '.mjs' : '.js';\n  const base = calculateScriptBaseUrl(location, opt_isLocalDev);\n  const rtv = getMode().rtvVersion;\n  const extensionVersion = version ? '-' + version : '';\n  return `${base}/rtv/${rtv}/v0/${extensionId}${extensionVersion}${fileExtension}`;\n}\n\n/**\n * Calculate script url for an entry point.\n * If `opt_rtv` is true, returns the URL matching the current RTV.\n * @param {!Location} location The window's location\n * @param {string} entryPoint\n * @param {boolean=} isLocalDev\n * @param {boolean=} opt_rtv\n * @return {string}\n */\nexport function calculateEntryPointScriptUrl(\n  location,\n  entryPoint,\n  isLocalDev,\n  opt_rtv\n) {\n  const fileExtension = getMode().esm ? '.mjs' : '.js';\n  const base = calculateScriptBaseUrl(location, isLocalDev);\n  if (isLocalDev) {\n    return `${base}/${entryPoint}${fileExtension}`;\n  }\n  if (opt_rtv) {\n    return `${base}/rtv/${getMode().rtvVersion}/${entryPoint}${fileExtension}`;\n  }\n  return `${base}/${entryPoint}${fileExtension}`;\n}\n\n/**\n * Parse the extension version from a given script URL.\n * @param {string} scriptUrl\n * @return {?{extensionId: string, extensionVersion: string}}\n */\nexport function parseExtensionUrl(scriptUrl) {\n  if (!scriptUrl) {\n    return null;\n  }\n  // Note that the \"(\\.max)?\" group only applies to local dev.\n  const matches = scriptUrl.match(\n    /^(.*)\\/(.*)-([0-9.]+|latest)(\\.max)?\\.(?:js|mjs)$/i\n  );\n  const extensionId = matches ? matches[2] : undefined;\n  const extensionVersion = matches ? matches[3] : undefined;\n  if (!extensionId || !extensionVersion) {\n    return null;\n  }\n  return {extensionId, extensionVersion};\n}\n\n/**\n * Create the missing amp extension HTML script element.\n * @param {!Window} win\n * @param {string} extensionId\n * @param {string} version\n * @return {!Element} Script object\n */\nexport function createExtensionScript(win, extensionId, version) {\n  const scriptElement = win.document.createElement('script');\n  scriptElement.async = true;\n  if (isIntermediateExtension(extensionId)) {\n    version = '';\n  } else {\n    scriptElement.setAttribute(\n      CUSTOM_TEMPLATES.indexOf(extensionId) >= 0\n        ? 'custom-template'\n        : 'custom-element',\n      extensionId\n    );\n  }\n  scriptElement.setAttribute('data-script', extensionId);\n  scriptElement.setAttribute('i-amphtml-inserted', '');\n  if (getMode().esm) {\n    scriptElement.setAttribute('type', 'module');\n  }\n\n  // Propagate nonce to all generated script tags.\n  const currentScript = win.document.head.querySelector('script[nonce]');\n  if (currentScript) {\n    scriptElement.setAttribute('nonce', currentScript.getAttribute('nonce'));\n  }\n\n  // Allow error information to be collected\n  // https://github.com/ampproject/amphtml/issues/7353\n  scriptElement.setAttribute('crossorigin', 'anonymous');\n  let loc = win.location;\n  if (getMode(win).test && win.testLocation) {\n    loc = win.testLocation;\n  }\n  const scriptSrc = calculateExtensionScriptUrl(\n    loc,\n    extensionId,\n    version,\n    getMode(win).localDev\n  );\n  scriptElement.src = scriptSrc;\n  return scriptElement;\n}\n\n/**\n * Returns the extension <script> element and attribute for the given\n * extension ID, if it exists. Otherwise, returns null.\n * @param {!Window} win\n * @param {string} extensionId\n * @param {string} version\n * @param {boolean} latest\n * @param {boolean=} includeInserted If true, includes script elements that\n *   are inserted by the runtime dynamically. Default is true.\n * @return {!Array<!Element>}\n */\nexport function getExtensionScripts(\n  win,\n  extensionId,\n  version,\n  latest,\n  includeInserted = true\n) {\n  // Always ignore <script> elements that have a mismatched RTV.\n  const modifier =\n    ':not([i-amphtml-loaded-new-version])' +\n    (includeInserted ? '' : ':not([i-amphtml-inserted])');\n  // We have to match against \"src\" because a few extensions, such as\n  // \"amp-viewer-integration\", do not have \"custom-element\" attribute.\n  const matches = win.document.head./*OK*/ querySelectorAll(\n    `script[src*=\"/${extensionId}-\"]${modifier}`\n  );\n  const filtered = [];\n  for (let i = 0; i < matches.length; i++) {\n    const match = matches[i];\n    const urlParts = parseExtensionUrl(match.src);\n    if (!urlParts) {\n      continue;\n    }\n    const {\n      extensionId: scriptExtensionId,\n      extensionVersion: scriptExtensionVersion,\n    } = urlParts;\n    if (\n      scriptExtensionId == extensionId &&\n      (isIntermediateExtension(extensionId) ||\n        scriptExtensionVersion == version ||\n        (scriptExtensionVersion == LATEST_VERSION && latest))\n    ) {\n      filtered.push(match);\n    }\n  }\n  return filtered;\n}\n\n/**\n * Get list of all the extension JS files.\n * @param {HTMLHeadElement|Element|ShadowRoot|Document} head\n * @return {!Array<{extensionId: string, extensionVersion: string}>}\n */\nexport function extensionScriptsInNode(head) {\n  // ampdoc.getHeadNode() can return null.\n  if (!head) {\n    return [];\n  }\n  // Note: Some extensions don't have [custom-element] or [custom-template]\n  // e.g. amp-viewer-integration.\n  const list = head.querySelectorAll(\n    'script[custom-element],script[custom-template]'\n  );\n  const scripts = [];\n  for (let i = 0; i < list.length; i++) {\n    const script = list[i];\n    const extensionId =\n      script.getAttribute('custom-element') ||\n      script.getAttribute('custom-template');\n    const urlParts = parseExtensionUrl(script.src);\n    if (extensionId && urlParts) {\n      scripts.push({extensionId, extensionVersion: urlParts.extensionVersion});\n    }\n  }\n  return scripts;\n}\n\n/**\n * Verifies that an extension script is present in head for\n * installation.\n * @param {!Window} win\n * @param {string} id\n * @param {string} version\n * @return {boolean}\n */\nexport function extensionScriptInNode(win, id, version) {\n  return extensionScriptsInNode(win.document.head).some(\n    ({extensionId, extensionVersion}) =>\n      id == extensionId && version == extensionVersion\n  );\n}\n\n/**\n * @param {string} extensionId\n * @return {boolean}\n */\nfunction isIntermediateExtension(extensionId) {\n  return extensionId.startsWith('_');\n}\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dom from './dom';\nimport {extensionScriptInNode} from './service/extension-script';\nimport {\n  getAmpdoc,\n  getService,\n  getServiceForDocOrNull,\n  getServicePromise,\n  getServicePromiseForDoc,\n  getServicePromiseOrNull,\n  getServicePromiseOrNullForDoc,\n} from './service';\nimport {userAssert} from './log';\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {string} version The extension version.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailable(\n  win,\n  id,\n  extension,\n  version,\n  opt_element\n) {\n  const s = getServicePromiseOrNull(win, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  return getElementServicePromiseOrNull(\n    win,\n    id,\n    extension,\n    version,\n    opt_element\n  );\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. Services.viewportForDoc(...)) for type safety and because the\n * factory should not be passed around.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an element,\n *     not the extension.\n * @return {!Promise<*>}\n */\nexport function getElementServiceForDoc(element, id, extension, opt_element) {\n  return getElementServiceIfAvailableForDoc(\n    element,\n    id,\n    extension,\n    opt_element\n  ).then((service) => assertService(service, id, extension));\n}\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDoc(\n  element,\n  id,\n  extension,\n  opt_element\n) {\n  const s = getServicePromiseOrNullForDoc(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  const ampdoc = getAmpdoc(element);\n  return ampdoc\n    .whenExtensionsKnown()\n    .then(() => {\n      const version = ampdoc.getExtensionVersion(extension);\n      if (!version) {\n        return null;\n      }\n      const extensions = getService(ampdoc.win, 'extensions');\n      return extensions.waitForExtension(extension, version);\n    })\n    .then((ext) => {\n      if (!ext) {\n        return null;\n      }\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNullForDoc(element, id);\n      }\n      return getServicePromiseForDoc(element, id);\n    });\n}\n\n/**\n * Returns a promise for service for the given id in the embed scope of\n * a given element, if it exists. Falls back to ampdoc scope if the element\n * is not embedded.\n *\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDocInEmbedScope(\n  element,\n  id,\n  extension\n) {\n  const s = getServiceForDocOrNull(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (Promise.resolve(s));\n  }\n  return getElementServiceIfAvailableForDoc(element, id, extension);\n}\n\n/**\n * Throws user error if `service` is null.\n * @param {Object} service\n * @param {string} id\n * @param {string} extension\n * @return {!Object}\n * @private\n * @closurePrimitive {asserts.matchesReturn}\n */\nfunction assertService(service, id, extension) {\n  return /** @type {!Object} */ (\n    userAssert(\n      service,\n      'Service %s was requested to be provided through %s, ' +\n        'but %s is not loaded in the current page. To fix this ' +\n        'problem load the JavaScript file for %s in this page.',\n      id,\n      extension,\n      extension,\n      extension\n    )\n  );\n}\n\n/**\n * Returns the promise for service with `id` on the given window if available.\n * Otherwise, resolves with null (service was not registered).\n * @param {!Window} win\n * @param {string} id\n * @param {string} extension\n * @param {string} version\n * @param {boolean=} opt_element\n * @return {!Promise<Object>}\n * @private\n */\nfunction getElementServicePromiseOrNull(\n  win,\n  id,\n  extension,\n  version,\n  opt_element\n) {\n  return dom\n    .waitForBodyOpenPromise(win.document)\n    .then(() => {\n      // If there is an extension script wait for it to load before trying\n      // to get the service. Prevents a race condition when everything but\n      // the extensions is in cache. If there is no script then it's either\n      // not present, or the service was defined by a test. In those cases\n      // we don't wait around for an extension that does not exist.\n      const extensions = getService(win, 'extensions');\n\n      // TODO(jpettitt) investigate registerExtension to short circuit\n      // the dom call in extensionScriptsInNode()\n      if (!extensionScriptInNode(extensions.win, extension, version)) {\n        return null;\n      }\n      return extensions.waitForExtension(extension, version);\n    })\n    .then((ext) => {\n      if (!ext) {\n        return null;\n      }\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNull(win, id);\n      }\n      return getServicePromise(win, id);\n    });\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  getAmpdoc,\n  getExistingServiceOrNull,\n  getService,\n  getServiceForDoc,\n  getServiceForDocOrNull,\n  getServiceInEmbedWin,\n  getServicePromiseForDoc,\n} from './service';\nimport {\n  getElementServiceForDoc,\n  getElementServiceIfAvailable,\n  getElementServiceIfAvailableForDoc,\n  getElementServiceIfAvailableForDocInEmbedScope,\n} from './element-service';\n\n/** @typedef {!../extensions/amp-subscriptions/0.1/amp-subscriptions.SubscriptionService} */\nexport let SubscriptionService;\n\nexport class Services {\n  /**\n   * Hint: Add extensions folder path to compile.js with\n   * warnings cannot find modules.\n   */\n\n  /**\n   * Returns a promise for the Access service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>} */ (\n      getElementServiceForDoc(element, 'access', 'amp-access')\n    );\n  }\n\n  /**\n   * Returns a promise for the Access service or a promise for null if the\n   * service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>} */ (\n      getElementServiceIfAvailableForDoc(element, 'access', 'amp-access')\n    );\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!SubscriptionService>}\n   */\n  static subscriptionsServiceForDoc(element) {\n    return /** @type {!Promise<!SubscriptionService>} */ (\n      getElementServiceForDoc(element, 'subscriptions', 'amp-subscriptions')\n    );\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?SubscriptionService>}\n   */\n  static subscriptionsServiceForDocOrNull(element) {\n    return /** @type {!Promise<?SubscriptionService>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'subscriptions',\n        'amp-subscriptions'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/action-impl.ActionService}\n   */\n  static actionServiceForDoc(element) {\n    return /** @type {!./service/action-impl.ActionService} */ (\n      getServiceForDocOrNull(element, 'action')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/standard-actions-impl.StandardActions}\n   */\n  static standardActionsForDoc(element) {\n    return /** @type {!./service/standard-actions-impl.StandardActions} */ (\n      getServiceForDocOrNull(element, 'standard-actions')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>}\n   */\n  static activityForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>} */ (\n      getElementServiceForDoc(element, 'activity', 'amp-analytics')\n    );\n  }\n\n  /**\n   * Returns the global instance of the `AmpDocService` service that can be\n   * used to resolve an ampdoc for any node: either in the single-doc or\n   * shadow-doc environment.\n   * @param {!Window} window\n   * @return {!./service/ampdoc-impl.AmpDocService}\n   */\n  static ampdocServiceFor(window) {\n    return /** @type {!./service/ampdoc-impl.AmpDocService} */ (\n      getService(window, 'ampdoc')\n    );\n  }\n\n  /**\n   * Returns the AmpDoc for the specified context node.\n   * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrAmpDoc\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   */\n  static ampdoc(nodeOrAmpDoc) {\n    return getAmpdoc(nodeOrAmpDoc);\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @param {boolean=} loadAnalytics\n   * @return {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDoc(element, loadAnalytics = false) {\n    if (loadAnalytics) {\n      // Get Extensions service and force load analytics extension.\n      const ampdoc = getAmpdoc(element);\n      Services.extensionsFor(ampdoc.win)./*OK*/ installExtensionForDoc(\n        ampdoc,\n        'amp-analytics'\n      );\n    }\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (\n      getElementServiceForDoc(\n        element,\n        'amp-analytics-instrumentation',\n        'amp-analytics'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'amp-analytics-instrumentation',\n        'amp-analytics'\n      )\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/batched-xhr-impl.BatchedXhr}\n   */\n  static batchedXhrFor(window) {\n    return /** @type {!./service/batched-xhr-impl.BatchedXhr} */ (\n      getService(window, 'batched-xhr')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>}\n   */\n  static bindForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>} */ (\n      getElementServiceIfAvailableForDocInEmbedScope(\n        element,\n        'bind',\n        'amp-bind'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-script/0.1/amp-script.AmpScriptService>}\n   */\n  static scriptForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-script/0.1/amp-script.AmpScriptService>} */ (\n      getElementServiceIfAvailableForDocInEmbedScope(\n        element,\n        'amp-script',\n        'amp-script'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/cid-impl.CidDef>}\n   */\n  static cidForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/cid-impl.CidDef>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'cid')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/navigation.Navigation}\n   */\n  static navigationForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/navigation.Navigation} */ (\n      getServiceForDoc(elementOrAmpDoc, 'navigation')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>}\n   */\n  static loaderServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>} */ (\n      getElementServiceForDoc(element, 'loader', 'amp-loader')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>}\n   */\n  static standaloneServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>} */ (\n      getElementServiceForDoc(element, 'standalone', 'amp-standalone')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/crypto-impl.Crypto}\n   */\n  static cryptoFor(window) {\n    return /** @type {!./service/crypto-impl.Crypto} */ (\n      getService(window, 'crypto')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/document-info-impl.DocumentInfoDef} Info about the doc\n   */\n  static documentInfoForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/document-info-impl.DocInfo} */ (\n      getServiceForDoc(elementOrAmpDoc, 'documentInfo')\n    ).get();\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/extensions-impl.Extensions}\n   */\n  static extensionsFor(window) {\n    return /** @type {!./service/extensions-impl.Extensions} */ (\n      getService(window, 'extensions')\n    );\n  }\n\n  /**\n   * Returns a service to register callbacks we wish to execute when an\n   * amp-form is submitted.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>}\n   */\n  static formSubmitForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'form-submit-service')\n    );\n  }\n\n  /**\n   * Returns service to listen for `hidden` attribute mutations.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/hidden-observer-impl.HiddenObserver}\n   */\n  static hiddenObserverForDoc(element) {\n    return /** @type {!./service/hidden-observer-impl.HiddenObserver} */ (\n      getServiceForDocOrNull(element, 'hidden-observer')\n    );\n  }\n\n  /**\n   * Returns service implemented in service/history-impl.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/history-impl.History}\n   */\n  static historyForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/history-impl.History} */ (\n      getServiceForDoc(elementOrAmpDoc, 'history')\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {!./input.Input}\n   */\n  static inputFor(win) {\n    return getService(win, 'input');\n  }\n\n  /**s\n   * Returns a promise for the Inputmask service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>}\n   */\n  static inputmaskServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>} */ (\n      getElementServiceIfAvailableForDoc(element, 'inputmask', 'amp-inputmask')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {?./service/loading-indicator.LoadingIndicatorImpl}\n   */\n  static loadingIndicatorOrNull(elementOrAmpDoc) {\n    return /** @type {?./service/loading-indicator.LoadingIndicatorImpl} */ (\n      getServiceForDocOrNull(elementOrAmpDoc, 'loadingIndicator')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-next-page/1.0/service.NextPageService}\n   */\n  static nextPageServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-next-page/1.0/service.NextPageService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'next-page')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/mutator-interface.MutatorInterface}\n   */\n  static mutatorForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/mutator-interface.MutatorInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'mutator')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/owners-interface.OwnersInterface}\n   */\n  static ownersForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/owners-interface.OwnersInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'owners')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceFor(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (\n      getService(window, 'performance')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceForOrNull(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (\n      getExistingServiceOrNull(window, 'performance')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/platform-impl.Platform}\n   */\n  static platformFor(window) {\n    return /** @type {!./service/platform-impl.Platform} */ (\n      getService(window, 'platform')\n    );\n  }\n\n  /**\n   * Not installed by default; must be installed in extension code before use.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/position-observer/position-observer-impl.PositionObserver}\n   * @throws If the service is not installed.\n   */\n  static positionObserverForDoc(element) {\n    return /** @type {!./service/position-observer/position-observer-impl.PositionObserver} */ (\n      getServiceForDoc(element, 'position-observer')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./preconnect.PreconnectService}\n   */\n  static preconnectFor(window) {\n    return getService(window, 'preconnect');\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/resources-interface.ResourcesInterface}\n   */\n  static resourcesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/resources-interface.ResourcesInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'resources')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/resources-interface.ResourcesInterface>}\n   */\n  static resourcesPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/resources-interface.ResourcesInterface>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'resources')\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService>}\n   */\n  static storyVariableServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService>} */\n      (getElementServiceIfAvailable(win, 'story-variable', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService}\n   */\n  static storyVariableService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService} */\n      (getExistingServiceOrNull(win, 'story-variable'))\n    );\n  }\n\n  /**\n   * Version of the story store service depends on which version of amp-story\n   * the publisher is loading. They all have the same implementation.\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService>}\n   */\n  static storyStoreServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService>} */\n      (getElementServiceIfAvailable(win, 'story-store', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService}\n   */\n  static storyStoreService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService} */\n      (getExistingServiceOrNull(win, 'story-store'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService}\n   */\n  static storyMediaQueryService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService} */\n      (getExistingServiceOrNull(win, 'story-media-query'))\n    );\n  }\n\n  /**\n   * Get promise with story request service\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService>}\n   */\n  static storyRequestServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService>} */\n      (getElementServiceIfAvailable(win, 'story-request', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService}\n   */\n  static storyRequestService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService} */\n      (getExistingServiceOrNull(win, 'story-request'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService}\n   */\n  static mediaPerformanceMetricsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService} */\n      (getExistingServiceOrNull(win, 'media-performance-metrics'))\n    );\n  }\n\n  /**\n   * @param {!Element} el\n   * @return {!Promise<./service/localization.LocalizationService>}\n   */\n  static localizationServiceForOrNull(el) {\n    return /** @type {!Promise<?./service/localization.LocalizationService>} */ (\n      getServicePromiseForDoc(el, 'localization')\n    );\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {?./service/localization.LocalizationService}\n   */\n  static localizationForDoc(element) {\n    return /** @type {?./service/localization.LocalizationService} */ (\n      getServiceForDocOrNull(element, 'localization')\n    );\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>}\n   */\n  static storyAnalyticsServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>} */\n      (\n        getElementServiceIfAvailable(\n          win,\n          'story-analytics',\n          'amp-story',\n          '1.0',\n          true\n        )\n      )\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService}\n   */\n  static storyAnalyticsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService} */\n      (getExistingServiceOrNull(win, 'story-analytics'))\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>}\n   */\n  static webAnimationServiceFor(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>} */\n      (getElementServiceForDoc(element, 'web-animation', 'amp-animation'))\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/real-time-config/real-time-config-impl.RealTimeConfigManager>}\n   */\n  static realTimeConfigForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/real-time-config/real-time-config-impl.RealTimeConfigManager>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'real-time-config')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   */\n  static storageForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'storage')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   * TODO(dmanek): Add tests for this method.\n   */\n  static storageForTopLevelDoc(elementOrAmpDoc) {\n    const thisAmpdoc = Services.ampdoc(elementOrAmpDoc);\n    const ampdocService = Services.ampdocServiceFor(thisAmpdoc.win);\n    const topAmpdoc = ampdocService.isSingleDoc()\n      ? ampdocService.getSingleDoc()\n      : null;\n    // We need to verify that ampdocs are on the same origin, therefore\n    // we compare the windows of both.\n    const ampdoc =\n      topAmpdoc && topAmpdoc.win == thisAmpdoc.win ? topAmpdoc : thisAmpdoc;\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (\n      getServicePromiseForDoc(ampdoc, 'storage')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/template-impl.Templates}\n   */\n  static templatesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/template-impl.Templates} */ (\n      getServiceForDoc(elementOrAmpDoc, 'templates')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/timer-impl.Timer}\n   */\n  static timerFor(window) {\n    // TODO(alabiaga): This will always return the top window's Timer service.\n    return /** @type {!./service/timer-impl.Timer} */ (\n      getServiceInEmbedWin(window, 'timer')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-replacements-impl.UrlReplacements}\n   */\n  static urlReplacementsForDoc(element) {\n    return /** @type {!./service/url-replacements-impl.UrlReplacements} */ (\n      getServiceForDocOrNull(element, 'url-replace')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>}\n   */\n  static userNotificationManagerForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>} */\n      (\n        getElementServiceForDoc(\n          element,\n          'userNotificationManager',\n          'amp-user-notification'\n        )\n      )\n    );\n  }\n\n  /**\n   * Returns a promise for the consentPolicy Service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>}\n   */\n  static consentPolicyServiceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>} */\n      (\n        getElementServiceIfAvailableForDoc(\n          element,\n          'consentPolicyManager',\n          'amp-consent'\n        )\n      )\n    );\n  }\n\n  /**\n   * Returns a promise for the geo service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>}\n   */\n  static geoForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>} */ (\n      getElementServiceIfAvailableForDoc(element, 'geo', 'amp-geo', true)\n    );\n  }\n\n  /**\n   * Unlike most service getters, passing `Node` is necessary for some FIE-scope\n   * services since sometimes we only have the FIE Document for context.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-impl.Url}\n   */\n  static urlForDoc(element) {\n    return /** @type {!./service/url-impl.Url} */ (\n      getServiceForDocOrNull(element, 'url')\n    );\n  }\n\n  /**\n   * Returns a promise for the experiment variants or a promise for null if it\n   * is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>}\n   */\n  static variantsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'variant',\n        'amp-experiment',\n        true\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/video-manager-impl.VideoManager}\n   */\n  static videoManagerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/video-manager-impl.VideoManager} */ (\n      getServiceForDoc(elementOrAmpDoc, 'video-manager')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewer-interface.ViewerInterface}\n   */\n  static viewerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewer-interface.ViewerInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'viewer')\n    );\n  }\n\n  /**\n   * Returns promise for the viewer. This is an unusual case and necessary only\n   * for services that need reference to the viewer before it has been\n   * initialized. Most of the code, however, just should use `viewerForDoc`.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/viewer-interface.ViewerInterface>}\n   */\n  static viewerPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/viewer-interface.ViewerInterface>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'viewer')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/vsync-impl.Vsync}\n   */\n  static vsyncFor(window) {\n    return /** @type {!./service/vsync-impl.Vsync} */ (\n      getService(window, 'vsync')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewport/viewport-interface.ViewportInterface}\n   */\n  static viewportForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewport/viewport-interface.ViewportInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'viewport')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/xhr-impl.Xhr}\n   */\n  static xhrFor(window) {\n    return /** @type {!./service/xhr-impl.Xhr} */ (getService(window, 'xhr'));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-frame-service.AssistjsFrameService}\n   */\n  static assistjsFrameServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-frame-service.AssistjsFrameService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'assistjs-frame-service')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-config-service.AssistjsConfigService}\n   */\n  static assistjsConfigServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-google-assistant-assistjs/0.1/assistjs-config-service.AssistjsConfigService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'assistjs-config-service')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../amp-cache-url/amp-cache-url.AmpCacheUrlService>}\n   */\n  static cacheUrlServicePromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<?../amp-cache-url/amp-cache-url.AmpCacheUrlService>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'cache-url')\n    );\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\n\n/** Timeout that can be postponed, repeated or cancelled. */\nexport class Timeout {\n  /**\n   * @param {!Window} win\n   * @param {!Function} handler\n   */\n  constructor(win, handler) {\n    /** @private @const {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(win);\n\n    /** @private @const {!Function} */\n    this.handler_ = handler;\n\n    /** @private {?number|?string} */\n    this.id_ = null;\n  }\n\n  /**\n   * @param {number} time\n   * @param {...*} args\n   */\n  trigger(time, ...args) {\n    this.cancel();\n    this.id_ = this.timer_.delay(() => this.handler_.apply(null, args), time);\n  }\n\n  /** @public */\n  cancel() {\n    if (this.id_ !== null) {\n      this.timer_.cancel(this.id_);\n      this.id_ = null;\n    }\n  }\n\n  /** @return {boolean} */\n  isWaiting() {\n    return this.id_ !== null;\n  }\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {dev} from '../../../src/log';\n\n/** @enum {string} */\nexport const VideoDockingEvents = {\n  DISMISS_ON_TAP: 'dock-dismiss-on-tap',\n  SCROLL_BACK: 'dock-scroll-back',\n};\n\n/**\n * @param {!MouseEvent|!TouchEvent} e\n * @return {{x: number, y: number}}\n * @package\n */\nexport function pointerCoords(e) {\n  const coords = e.touches ? e.touches[0] : e;\n  return {\n    x: dev().assertNumber('x' in coords ? coords.x : coords.clientX),\n    y: dev().assertNumber('y' in coords ? coords.y : coords.clientY),\n  };\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @typedef {{className: string, minWidth: number}} */\nexport let SyntheticBreakpointDef;\n\n/**\n * @param {!Element} element\n * @param {number} width\n * @param {!Array<!SyntheticBreakpointDef>} breakpoints\n */\nexport function applyBreakpointClassname(element, width, breakpoints) {\n  // sort by minWidth descending\n  breakpoints = breakpoints.sort((a, b) => b.minWidth - a.minWidth);\n\n  let maxBreakpoint = -1;\n  breakpoints.forEach((breakpoint) => {\n    const {className, minWidth} = breakpoint;\n    if (minWidth <= width && minWidth > maxBreakpoint) {\n      element.classList.add(className);\n      maxBreakpoint = minWidth;\n    } else {\n      element.classList.remove(className);\n    }\n  });\n}\n", "/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether addEventListener supports options or only takes capture as a boolean\n * @type {boolean|undefined}\n * @visibleForTesting\n */\nlet optsSupported;\n\n/**\n * Whether addEventListener supports options or only takes passive as a boolean\n * @type {boolean|undefined}\n */\nlet passiveSupported;\n\n/**\n * Options supported by addEventListener\n * @typedef AddEventListenerOptsDef\n * @property {undefined|boolean} [capture]\n * @property {undefined|boolean} [once]\n * @property {undefined|boolean} [passive]\n * @property {undefined|!AbortSignal} [signal]\n * }}\n */\nlet AddEventListenerOptsDef;\n\n/**\n * Listens for the specified event on the element.\n *\n * Do not use this directly. This method is implemented as a shared\n * dependency. Use `listen()` in either `event-helper` or `3p-frame-messaging`,\n * depending on your use case.\n *\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {!AddEventListenerOptsDef=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function internalListenImplementation(\n  element,\n  eventType,\n  listener,\n  opt_evtListenerOpts\n) {\n  let localElement = element;\n  let localListener = listener;\n  /** @type {?function(!Event)} */\n  let wrapped = (event) => {\n    try {\n      return localListener(event);\n    } catch (e) {\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR?.(e);\n      throw e;\n    }\n  };\n  const optsSupported = detectEvtListenerOptsSupport();\n  const capture = !!opt_evtListenerOpts?.capture;\n\n  localElement.addEventListener(\n    eventType,\n    wrapped,\n    optsSupported ? opt_evtListenerOpts : capture\n  );\n  return () => {\n    localElement?.removeEventListener(\n      eventType,\n      wrapped,\n      optsSupported ? opt_evtListenerOpts : capture\n    );\n    // Ensure these are GC'd\n    localListener = null;\n    localElement = null;\n    wrapped = null;\n  };\n}\n\n/**\n * Tests whether the browser supports options as an argument of addEventListener\n * or not.\n *\n * @return {boolean}\n */\nexport function detectEvtListenerOptsSupport() {\n  // Only run the test once\n  if (optsSupported !== undefined) {\n    return optsSupported;\n  }\n\n  optsSupported = false;\n  try {\n    // Test whether browser supports EventListenerOptions or not\n    const options = {\n      get capture() {\n        optsSupported = true;\n      },\n    };\n    self.addEventListener('test-options', null, options);\n    self.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return optsSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports options or not.\n */\nexport function resetEvtListenerOptsSupportForTesting() {\n  optsSupported = undefined;\n}\n\n/**\n * Return boolean. if listener option is supported, return `true`.\n * if not supported, return `false`\n * @param {!Window} win\n * @return {boolean}\n */\nexport function supportsPassiveEventListener(win) {\n  if (passiveSupported !== undefined) {\n    return passiveSupported;\n  }\n\n  passiveSupported = false;\n  try {\n    const options = {\n      get passive() {\n        // This function will be called when the browser\n        // attempts to access the passive property.\n        passiveSupported = true;\n        return false;\n      },\n    };\n\n    win.addEventListener('test-options', null, options);\n    win.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return passiveSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports passive options or not.\n */\nexport function resetPassiveSupportedForTesting() {\n  passiveSupported = undefined;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalListenImplementation} from './core/dom/event-helper-listen';\nimport {lastChildElement} from './core/dom/query';\nimport {user} from './log';\n\n/** @const {string}  */\nconst LOAD_FAILURE_PREFIX = 'Failed to load:';\n\n/** @const {string} */\nexport const MEDIA_LOAD_FAILURE_SRC_PROPERTY = '__AMP_MEDIA_LOAD_FAILURE_SRC';\n\n/**\n * Returns a CustomEvent with a given type and detail; supports fallback for IE.\n * @param {!Window} win\n * @param {string} type\n * @param {!JsonObject|string|undefined|null} detail\n * @param {EventInit=} opt_eventInit\n * @return {!Event}\n */\nexport function createCustomEvent(win, type, detail, opt_eventInit) {\n  const eventInit = /** @type {!CustomEventInit} */ ({detail});\n  Object.assign(eventInit, opt_eventInit);\n  // win.CustomEvent is a function on Edge, Chrome, FF, Safari but\n  // is an object on IE 11.\n  if (IS_ESM || typeof win.CustomEvent == 'function') {\n    return new win.CustomEvent(type, eventInit);\n  } else {\n    // Deprecated fallback for IE.\n    const e = win.document.createEvent('CustomEvent');\n    e.initCustomEvent(\n      type,\n      !!eventInit.bubbles,\n      !!eventInit.cancelable,\n      detail\n    );\n    return e;\n  }\n}\n\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listen(element, eventType, listener, opt_evtListenerOpts) {\n  return internalListenImplementation(\n    element,\n    eventType,\n    listener,\n    opt_evtListenerOpts\n  );\n}\n\n/**\n * Returns the data property of an event with the correct type.\n * @param {!Event|{data: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getData(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.data);\n}\n\n/**\n * Returns the detail property of an event with the correct type.\n * @param {!Event|{detail: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getDetail(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.detail);\n}\n\n/**\n * Listens for the specified event on the element and removes the listener\n * as soon as event has been received.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listenOnce(element, eventType, listener, opt_evtListenerOpts) {\n  let localListener = listener;\n  const unlisten = internalListenImplementation(\n    element,\n    eventType,\n    (event) => {\n      try {\n        localListener(event);\n      } finally {\n        // Ensure listener is GC'd\n        localListener = null;\n        unlisten();\n      }\n    },\n    opt_evtListenerOpts\n  );\n  return unlisten;\n}\n\n/**\n * Returns  a promise that will resolve as soon as the specified event has\n * fired on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {Object=} opt_evtListenerOpts\n * @param {function(!UnlistenDef)=} opt_cancel An optional function that, when\n *     provided, will be called with the unlistener. This gives the caller\n *     access to the unlistener, so it may be called manually when necessary.\n * @return {!Promise<!Event>}\n */\nexport function listenOncePromise(\n  element,\n  eventType,\n  opt_evtListenerOpts,\n  opt_cancel\n) {\n  let unlisten;\n  const eventPromise = new Promise((resolve) => {\n    unlisten = listenOnce(element, eventType, resolve, opt_evtListenerOpts);\n  });\n  eventPromise.then(unlisten, unlisten);\n  if (opt_cancel) {\n    opt_cancel(unlisten);\n  }\n  return eventPromise;\n}\n\n/**\n * Whether the specified element/window has been loaded already.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nexport function isLoaded(eleOrWindow) {\n  return !!(\n    eleOrWindow.complete ||\n    eleOrWindow.readyState == 'complete' ||\n    (isHTMLMediaElement(eleOrWindow) && eleOrWindow.readyState > 0) ||\n    // If the passed in thing is a Window, infer loaded state from\n    //\n    (eleOrWindow.document && eleOrWindow.document.readyState == 'complete')\n  );\n}\n\n/**\n * Returns a promise that will resolve or fail based on the eleOrWindow's 'load'\n * and 'error' events. Optionally this method takes a timeout, which will reject\n * the promise if the resource has not loaded by then.\n * @param {T} eleOrWindow Supports both Elements and as a special case Windows.\n * @return {!Promise<T>}\n * @template T\n */\nexport function loadPromise(eleOrWindow) {\n  let unlistenLoad;\n  let unlistenError;\n  if (isLoaded(eleOrWindow)) {\n    return Promise.resolve(eleOrWindow);\n  }\n  const isMediaElement = isHTMLMediaElement(eleOrWindow);\n  if (\n    isMediaElement &&\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] === eleOrWindow.currentSrc\n  ) {\n    return Promise.reject(eleOrWindow);\n  }\n  const loadingPromise = new Promise((resolve, reject) => {\n    // Listen once since IE 5/6/7 fire the onload event continuously for\n    // animated GIFs.\n    if (isMediaElement) {\n      // The following event can be triggered by the media or one of its\n      // sources. Using capture is required as the media events do not bubble.\n      unlistenLoad = listenOnce(eleOrWindow, 'loadedmetadata', resolve, {\n        capture: true,\n      });\n    } else {\n      unlistenLoad = listenOnce(eleOrWindow, 'load', resolve);\n    }\n    // Don't unlisten on error for Windows.\n    if (!eleOrWindow.tagName) {\n      return;\n    }\n    let errorTarget = eleOrWindow;\n    // If the media element has no `src`, it will try to load the sources in\n    // document order. If the last source errors, then the media element\n    // loading errored.\n    if (isMediaElement && !eleOrWindow.hasAttribute('src')) {\n      errorTarget = lastChildElement(\n        eleOrWindow,\n        (child) => child.tagName === 'SOURCE'\n      );\n      if (!errorTarget) {\n        return reject(new Error('Media has no source.'));\n      }\n    }\n    unlistenError = listenOnce(errorTarget, 'error', reject);\n  });\n\n  return loadingPromise.then(\n    () => {\n      if (unlistenError) {\n        unlistenError();\n      }\n      return eleOrWindow;\n    },\n    () => {\n      if (unlistenLoad) {\n        unlistenLoad();\n      }\n      failedToLoad(eleOrWindow);\n    }\n  );\n}\n\n/**\n * Emit error on load failure.\n * @param {!Element|!Window} eleOrWindow Supports both Elements and as a special\n *     case Windows.\n */\nfunction failedToLoad(eleOrWindow) {\n  // Mark the element as errored since some elements - like HTMLMediaElement\n  // using HTMLSourceElement - do not provide any synchronous way to verify if\n  // they already errored, even though the error event was already dispatched.\n  if (isHTMLMediaElement(eleOrWindow)) {\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] =\n      eleOrWindow.currentSrc || true;\n  }\n\n  // Report failed loads as user errors so that they automatically go\n  // into the \"document error\" bucket.\n  let target = eleOrWindow;\n  if (target && target.src) {\n    target = target.src;\n  }\n  throw user().createError(LOAD_FAILURE_PREFIX, target);\n}\n\n/**\n * Returns true if the parameter is a HTMLMediaElement.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nfunction isHTMLMediaElement(eleOrWindow) {\n  return eleOrWindow.tagName === 'AUDIO' || eleOrWindow.tagName === 'VIDEO';\n}\n\n/**\n * Returns true if this error message is was created for a load error.\n * @param {string} message An error message\n * @return {boolean}\n */\nexport function isLoadErrorMessage(message) {\n  return message.indexOf(LOAD_FAILURE_PREFIX) != -1;\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from './log';\nimport {map} from './core/types/object';\n\nlet htmlContainer;\nlet svgContainer;\n\n/**\n * Creates the html helper for the doc.\n *\n * @param {!Element|!Document} nodeOrDoc\n * @return {function(!Array<string>):!Element}\n */\nexport function htmlFor(nodeOrDoc) {\n  const doc = nodeOrDoc.ownerDocument || nodeOrDoc;\n  if (!htmlContainer || htmlContainer.ownerDocument !== doc) {\n    htmlContainer = doc.createElement('div');\n  }\n\n  return html;\n}\n\n/**\n * Creates the svg helper for the doc.\n *\n * @param {!Element|!Document} nodeOrDoc\n * @return {function(!Array<string>):!Element}\n */\nexport function svgFor(nodeOrDoc) {\n  const doc = nodeOrDoc.ownerDocument || nodeOrDoc;\n  if (!svgContainer || svgContainer.ownerDocument !== svgContainer) {\n    svgContainer = doc.createElementNS('http://www.w3.org/2000/svg', 'svg');\n  }\n\n  return svg;\n}\n\n/**\n * A tagged template literal helper to generate static SVG trees.\n * This must be used as a tagged template, ie\n *\n * ```\n * const circle = svg`<circle cx=\"60\" cy=\"60\" r=\"22\"></circle>`;\n * ```\n *\n * Only the root element and its subtree will be returned. DO NOT use this to\n * render subtree's with dynamic content, it WILL result in an error!\n *\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction svg(strings) {\n  return createNode(svgContainer, strings);\n}\n\n/**\n * A tagged template literal helper to generate static DOM trees.\n * This must be used as a tagged template, ie\n *\n * ```\n * const div = html`<div><span></span></div>`;\n * ```\n *\n * Only the root element and its subtree will be returned. DO NOT use this to\n * render subtree's with dynamic content, it WILL result in an error!\n *\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction html(strings) {\n  return createNode(htmlContainer, strings);\n}\n\n/**\n * Helper used by html and svg string literal functions.\n * @param {!Element} container\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction createNode(container, strings) {\n  devAssert(strings.length === 1, 'Improper html template tag usage.');\n  container./*OK*/ innerHTML = strings[0];\n\n  const el = container.firstElementChild;\n  devAssert(el, 'No elements in template');\n  devAssert(!el.nextElementSibling, 'Too many root elements in template');\n\n  // Clear to free memory.\n  container.removeChild(el);\n\n  return el;\n}\n\n/**\n * Queries an element for all elements with a \"ref\" attribute, removing\n * the attribute afterwards.\n * Returns a named map of all ref elements.\n *\n * @param {!Element} root\n * @return {!Object<string, !Element>}\n */\nexport function htmlRefs(root) {\n  const elements = root.querySelectorAll('[ref]');\n  const refs = map();\n\n  for (let i = 0; i < elements.length; i++) {\n    const element = elements[i];\n    const ref = devAssert(element.getAttribute('ref'), 'Empty ref attr');\n    element.removeAttribute('ref');\n    devAssert(refs[ref] === undefined, 'Duplicate ref');\n    refs[ref] = element;\n  }\n\n  return refs;\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * TODO(rcebulko): Migrate the actual ViewportInterface into core or an extern.\n * @typedef {{\n *   getHeight: function(this:ViewportInterfaceDef):number,\n *   getWidth: function(this:ViewportInterfaceDef):number,\n * }}\n */\nlet ViewportInterfaceDef;\n\n/**\n * The structure that combines position and size for an element. The exact\n * interpretation of position and size depends on the use case.\n *\n * @typedef {{\n *   top: number,\n *   bottom: number,\n *   left: number,\n *   right: number,\n *   width: number,\n *   height: number,\n *   x: number,\n *   y: number\n * }}\n */\nexport let LayoutRectDef;\n\n/**\n * The structure that contains the size for an element. The exact\n * interpretation of the size depends on the use case.\n *\n * @typedef {{\n *   width: number,\n *   height: number,\n * }}\n */\nexport let LayoutSizeDef;\n\n/**\n * The structure that represents the margins of an Element.\n *\n * @typedef {{\n *   top: number,\n *   right: number,\n *   bottom: number,\n *   left: number\n * }}\n */\nexport let LayoutMarginsDef;\n\n/**\n * The structure that represents a requested change to the margins of an\n * Element. Any new values specified will replace existing ones (rather than\n * being additive).\n *\n * @typedef {{\n *   top: (number|undefined),\n *   right: (number|undefined),\n *   bottom: (number|undefined),\n *   left: (number|undefined)\n * }}\n */\nexport let LayoutMarginsChangeDef;\n\n/**\n * RelativePositions\n *\n * Describes the relative position of an element to another (whether the\n * first is inside the second, on top of the second or on the bottom\n * @enum {string}\n */\nexport const RelativePositions = {\n  INSIDE: 'inside',\n  TOP: 'top',\n  BOTTOM: 'bottom',\n};\n\n/**\n * Creates a layout rect based on the left, top, width and height parameters\n * in that order.\n * @param {number} left\n * @param {number} top\n * @param {number} width\n * @param {number} height\n * @return {!LayoutRectDef}\n */\nexport function layoutRectLtwh(left, top, width, height) {\n  return {\n    left,\n    top,\n    width,\n    height,\n    bottom: top + height,\n    right: left + width,\n    x: left,\n    y: top,\n  };\n}\n\n/**\n * Creates a layout rect based on the DOMRect, e.g. obtained from calling\n * getBoundingClientRect.\n * @param {!ClientRect} rect\n * @return {!LayoutRectDef}\n */\nexport function layoutRectFromDomRect(rect) {\n  return layoutRectLtwh(\n    Number(rect.left),\n    Number(rect.top),\n    Number(rect.width),\n    Number(rect.height)\n  );\n}\n\n/**\n * Returns true if the specified two rects overlap by a single pixel.\n * @param {!LayoutRectDef|!ClientRect} r1\n * @param {!LayoutRectDef|!ClientRect} r2\n * @return {boolean}\n */\nexport function rectsOverlap(r1, r2) {\n  return (\n    r1.top <= r2.bottom &&\n    r2.top <= r1.bottom &&\n    r1.left <= r2.right &&\n    r2.left <= r1.right\n  );\n}\n\n/**\n * Returns the intersection between a, b or null if there is none.\n * @param {...?LayoutRectDef|undefined} var_args\n * @return {?LayoutRectDef}\n */\nexport function rectIntersection(var_args) {\n  let x0 = -Infinity;\n  let x1 = Infinity;\n  let y0 = -Infinity;\n  let y1 = Infinity;\n  for (let i = 0; i < arguments.length; i++) {\n    const current = arguments[i];\n    if (!current) {\n      continue;\n    }\n    x0 = Math.max(x0, current.left);\n    x1 = Math.min(x1, current.left + current.width);\n    y0 = Math.max(y0, current.top);\n    y1 = Math.min(y1, current.top + current.height);\n    if (x1 < x0 || y1 < y0) {\n      return null;\n    }\n  }\n  if (x1 == Infinity) {\n    return null;\n  }\n  return layoutRectLtwh(x0, y0, x1 - x0, y1 - y0);\n}\n\n/**\n * Returns the position of r2 relative to r1\n * @param {!LayoutRectDef} r1\n * @param {!LayoutRectDef} r2\n * @return {!RelativePositions}\n */\nexport function layoutRectsRelativePos(r1, r2) {\n  if (r1.top < r2.top) {\n    return RelativePositions.TOP;\n  } else if (r1.bottom > r2.bottom) {\n    return RelativePositions.BOTTOM;\n  } else {\n    return RelativePositions.INSIDE;\n  }\n}\n\n/**\n * Determines if any portion of a layoutBox would be onscreen in the given\n * viewport, when scrolled to the specified position.\n * @param {!LayoutRectDef} layoutBox\n * @param {!ViewportInterfaceDef} viewport\n * @param {number} scrollPos\n * @return {!RelativePositions}\n */\nexport function layoutPositionRelativeToScrolledViewport(\n  layoutBox,\n  viewport,\n  scrollPos\n) {\n  const scrollLayoutBox = layoutRectFromDomRect(\n    /** @type {!ClientRect} */ ({\n      top: scrollPos,\n      bottom: scrollPos + viewport.getHeight(),\n      left: 0,\n      right: viewport.getWidth(),\n    })\n  );\n  if (rectsOverlap(layoutBox, scrollLayoutBox)) {\n    return RelativePositions.INSIDE;\n  } else {\n    return layoutRectsRelativePos(layoutBox, scrollLayoutBox);\n  }\n}\n\n/**\n * Expand the layout rect using multiples of width and height.\n * @param {!LayoutRectDef} rect Original rect.\n * @param {number} dw Expansion in width, specified as a multiple of width.\n * @param {number} dh Expansion in height, specified as a multiple of height.\n * @return {!LayoutRectDef}\n */\nexport function expandLayoutRect(rect, dw, dh) {\n  return layoutRectLtwh(\n    rect.left - rect.width * dw,\n    rect.top - rect.height * dh,\n    rect.width * (1 + dw * 2),\n    rect.height * (1 + dh * 2)\n  );\n}\n\n/**\n * Moves the layout rect using dx and dy.\n * @param {!LayoutRectDef} rect Original rect.\n * @param {number} dx Move horizontally with this value.\n * @param {number} dy Move vertically with this value.\n * @return {!LayoutRectDef}\n */\nexport function moveLayoutRect(rect, dx, dy) {\n  if ((dx == 0 && dy == 0) || (rect.width == 0 && rect.height == 0)) {\n    return rect;\n  }\n  return layoutRectLtwh(rect.left + dx, rect.top + dy, rect.width, rect.height);\n}\n\n/**\n * @param {!LayoutMarginsDef} margins\n * @param {!LayoutMarginsChangeDef} change\n * @return {boolean}\n */\nexport function areMarginsChanged(margins, change) {\n  return (\n    (change.top !== undefined && change.top != margins.top) ||\n    (change.right !== undefined && change.right != margins.right) ||\n    (change.bottom !== undefined && change.bottom != margins.bottom) ||\n    (change.left !== undefined && change.left != margins.left)\n  );\n}\n\n/**\n * @param {!LayoutRectDef} from\n * @param {!LayoutRectDef} to\n * @return {boolean}\n */\nexport function layoutRectSizeEquals(from, to) {\n  return from.width == to.width && from.height === to.height;\n}\n\n/**\n * @param {?LayoutRectDef} r1\n * @param {?LayoutRectDef} r2\n * @return {boolean}\n */\nexport function layoutRectEquals(r1, r2) {\n  if (!r1 || !r2) {\n    return false;\n  }\n  return (\n    r1.left == r2.left &&\n    r1.top == r2.top &&\n    r1.width == r2.width &&\n    r1.height == r2.height\n  );\n}\n\n/**\n * @param {LayoutMarginsChangeDef|undefined} marginsChange\n * @return {LayoutMarginsChangeDef|undefined}\n */\nexport function cloneLayoutMarginsChangeDef(marginsChange) {\n  if (!marginsChange) {\n    return marginsChange;\n  }\n  return {\n    top: marginsChange.top,\n    bottom: marginsChange.bottom,\n    left: marginsChange.left,\n    right: marginsChange.right,\n  };\n}\n\n/**\n * @param {!LayoutRectDef|!ClientRect|!DOMRect} rect\n * @return {!LayoutSizeDef}\n */\nexport function layoutSizeFromRect(rect) {\n  const {height, width} = rect;\n  return {width, height};\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Note: loaded by 3p system. Cannot rely on babel polyfills.\nimport {dev, devAssert} from './log';\nimport {map} from './core/types/object';\n\n/** @type {Object<string, string>} */\nlet propertyNameCache;\n\n/** @const {!Array<string>} */\nconst vendorPrefixes = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n\nconst EMPTY_CSS_DECLARATION = /** @type {!CSSStyleDeclaration} */ ({\n  'getPropertyPriority': () => '',\n  'getPropertyValue': () => '',\n});\n\n/**\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\nexport function camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n\n/**\n  Checks the style if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} style\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\nfunction getVendorJsPropertyName_(style, titleCase) {\n  for (let i = 0; i < vendorPrefixes.length; i++) {\n    const propertyName = vendorPrefixes[i] + titleCase;\n    if (style[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n  return '';\n}\n\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @param {!Object} style\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} opt_bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\nexport function getVendorJsPropertyName(style, camelCase, opt_bypassCache) {\n  if (isVar(camelCase)) {\n    // CSS vars are returned as is.\n    return camelCase;\n  }\n  if (!propertyNameCache) {\n    propertyNameCache = map();\n  }\n  let propertyName = propertyNameCache[camelCase];\n  if (!propertyName || opt_bypassCache) {\n    propertyName = camelCase;\n    if (style[camelCase] === undefined) {\n      const titleCase = camelCaseToTitleCase(camelCase);\n      const prefixedPropertyName = getVendorJsPropertyName_(style, titleCase);\n\n      if (style[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n    if (!opt_bypassCache) {\n      propertyNameCache[camelCase] = propertyName;\n    }\n  }\n  return propertyName;\n}\n\n/**\n * Sets the CSS styles of the specified element with !important. The styles\n * are specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setImportantStyles(element, styles) {\n  const {style} = element;\n  for (const k in styles) {\n    style.setProperty(\n      getVendorJsPropertyName(style, k),\n      String(styles[k]),\n      'important'\n    );\n  }\n}\n\n/**\n * Sets the CSS style of the specified element with optional units, e.g. \"px\".\n * @param {?Element} element\n * @param {string} property\n * @param {*} value\n * @param {string=} opt_units\n * @param {boolean=} opt_bypassCache\n */\nexport function setStyle(element, property, value, opt_units, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return;\n  }\n  const styleValue = /** @type {string} */ (\n    opt_units ? value + opt_units : value\n  );\n  if (isVar(propertyName)) {\n    element.style.setProperty(propertyName, styleValue);\n  } else {\n    element.style[propertyName] = styleValue;\n  }\n}\n\n/**\n * Returns the value of the CSS style of the specified element.\n * @param {!Element} element\n * @param {string} property\n * @param {boolean=} opt_bypassCache\n * @return {*}\n */\nexport function getStyle(element, property, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return undefined;\n  }\n  if (isVar(propertyName)) {\n    return element.style.getPropertyValue(propertyName);\n  }\n  return element.style[propertyName];\n}\n\n/**\n * Sets the CSS styles of the specified element. The styles\n * a specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setStyles(element, styles) {\n  for (const k in styles) {\n    setStyle(element, k, styles[k]);\n  }\n}\n\n/**\n * Asserts that the style is not the `display` style.\n * This is the only possible way to pass a dynamic style to setStyle.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {string} style\n * @return {string}\n */\nexport function assertNotDisplay(style) {\n  if (style === 'display') {\n    dev().error(\n      'STYLE',\n      '`display` style detected. You must use toggle instead.'\n    );\n  }\n  return style;\n}\n\n/**\n * Asserts that the styles does not contain the `display` style.\n * This is the only possible way to pass a dynamic styles object to setStyles\n * and setImportantStyles.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {!Object<string, *>} styles\n * @return {!Object<string, *>}\n */\nexport function assertDoesNotContainDisplay(styles) {\n  if ('display' in styles) {\n    dev().error(\n      'STYLE',\n      '`display` style detected in styles. You must use toggle instead.'\n    );\n  }\n  return styles;\n}\n\n/**\n * Sets the initial display style of an element. This is a last resort. If you\n * can set the initial display using CSS, YOU MUST.\n * DO NOT USE THIS TO ARBITRARILY SET THE DISPLAY STYLE AFTER INITIAL SETUP.\n *\n * @param {!Element} el\n * @param {string} value\n */\nexport function setInitialDisplay(el, value) {\n  const {style} = el;\n  devAssert(\n    value !== '' && value !== 'none',\n    'Initial display value must not be \"none\". Use toggle instead.'\n  );\n  devAssert(\n    !style['display'],\n    'setInitialDisplay MUST NOT be used for ' +\n      'resetting the display style. If you are looking for display:none ' +\n      'toggling, use toggle instead.'\n  );\n  style['display'] = value;\n}\n\n/**\n * Shows or hides the specified element.\n * @param {!Element} element\n * @param {boolean=} opt_display\n */\nexport function toggle(element, opt_display) {\n  if (opt_display === undefined) {\n    opt_display = element.hasAttribute('hidden');\n  }\n  if (opt_display) {\n    element.removeAttribute('hidden');\n  } else {\n    element.setAttribute('hidden', '');\n  }\n}\n\n/**\n * Returns a pixel value.\n * @param {number} value\n * @return {string}\n */\nexport function px(value) {\n  return `${value}px`;\n}\n\n/**\n * Returns a degree value.\n * @param {number} value\n * @return {string}\n */\nexport function deg(value) {\n  return `${value}deg`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function translateX(value) {\n  if (typeof value == 'string') {\n    return `translateX(${value})`;\n  }\n  return `translateX(${px(value)})`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} x\n * @param {(number|string)=} opt_y\n * @return {string}\n */\nexport function translate(x, opt_y) {\n  if (typeof x == 'number') {\n    x = px(x);\n  }\n  if (opt_y === undefined) {\n    return `translate(${x})`;\n  }\n  if (typeof opt_y == 'number') {\n    opt_y = px(opt_y);\n  }\n  return `translate(${x}, ${opt_y})`;\n}\n\n/**\n * Returns a \"scale\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function scale(value) {\n  return `scale(${value})`;\n}\n\n/**\n * Returns a \"rotate\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function rotate(value) {\n  if (typeof value == 'number') {\n    value = deg(value);\n  }\n  return `rotate(${value})`;\n}\n\n/**\n * Remove alpha value from a rgba color value.\n * Return the new color property with alpha equals if has the alpha value.\n * Caller needs to make sure the input color value is a valid rgba/rgb value\n * @param {string} rgbaColor\n * @return {string}\n */\nexport function removeAlphaFromColor(rgbaColor) {\n  return rgbaColor.replace(\n    /\\(([^,]+),([^,]+),([^,)]+),[^)]+\\)/g,\n    '($1,$2,$3, 1)'\n  );\n}\n\n/**\n * Gets the computed style of the element. The helper is necessary to enforce\n * the possible `null` value returned by a buggy Firefox.\n *\n * @param {!Window} win\n * @param {!Element} el\n * @return {!CSSStyleDeclaration}\n */\nexport function computedStyle(win, el) {\n  const style = /** @type {?CSSStyleDeclaration} */ (win.getComputedStyle(el));\n  return style || EMPTY_CSS_DECLARATION;\n}\n\n/**\n * Resets styles that were set dynamically (i.e. inline)\n * @param {!Element} element\n * @param {!Array<string>} properties\n */\nexport function resetStyles(element, properties) {\n  for (let i = 0; i < properties.length; i++) {\n    setStyle(element, properties[i], null);\n  }\n}\n\n/**\n * Propagates the object-fit/position element attributes as styles.\n * @param {!Element} fromEl ie: amp-img\n * @param {!Element} toEl ie: the img within amp-img\n */\nexport function propagateObjectFitStyles(fromEl, toEl) {\n  if (fromEl.hasAttribute('object-fit')) {\n    setStyle(toEl, 'object-fit', fromEl.getAttribute('object-fit'));\n  }\n\n  if (fromEl.hasAttribute('object-position')) {\n    setStyle(toEl, 'object-position', fromEl.getAttribute('object-position'));\n  }\n}\n\n/**\n * @param {string} property\n * @return {boolean}\n */\nfunction isVar(property) {\n  return property.startsWith('--');\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {HtmlLiteralTagDef} from './html';\nimport {PlayingStates, VideoEvents} from '../../../src/video-interface';\nimport {Services} from '../../../src/services';\nimport {Timeout} from './timeout';\nimport {VideoDockingEvents, pointerCoords} from './events';\nimport {applyBreakpointClassname} from './breakpoints';\nimport {closestAncestorElementBySelector} from '../../../src/core/dom/query';\nimport {createCustomEvent, listen} from '../../../src/event-helper';\nimport {dev, devAssert} from '../../../src/log';\nimport {htmlFor, htmlRefs} from '../../../src/static-template';\nimport {iterateCursor} from '../../../src/dom';\nimport {layoutRectLtwh} from '../../../src/core/math/layout-rect';\nimport {once} from '../../../src/core/types/function';\nimport {\n  resetStyles,\n  setImportantStyles,\n  toggle,\n  translate,\n} from '../../../src/style';\n\n/**\n * A single controls set can be displayed at a time on the controls layer.\n *\n * These map to their displayable classname portion in the format\n * `amp-video-docked-control-set-${NAME}`\n * e.g. `PLAYBACK: 'playback'` gets `amp-video-docked-control-set-playback`\n * @enum {string}\n */\nconst ControlSet = {\n  // Playback buttons like play/pause, mute and fullscreen.\n  PLAYBACK: 'playback',\n\n  // Single button to scroll back to inline position of the component. Displayed\n  // during ad playback for CTA interaction.\n  SCROLL_BACK: 'scroll-back',\n};\n\n/** @private @const {!Array<!./breakpoints.SyntheticBreakpointDef>} */\nconst BREAKPOINTS = [\n  {\n    className: 'amp-small',\n    minWidth: 0,\n  },\n  {\n    className: 'amp-large',\n    minWidth: 300,\n  },\n];\n\nconst TIMEOUT = 1200;\nconst TIMEOUT_AFTER_INTERACTION = 800;\n\n/**\n * @param {!Element} a\n * @param {!Element} b\n * @private\n */\nfunction swap(a, b) {\n  toggle(a, false);\n  toggle(b, true);\n}\n\n/**\n * @param {!HtmlLiteralTagDef} html\n * @return {!Element}\n * @private\n */\nconst renderDockedOverlay = (html) =>\n  html` <div class=\"i-amphtml-video-docked-overlay\" hidden></div> `;\n\n/**\n * @param {!HtmlLiteralTagDef} html\n * @return {!Element}\n * @private\n */\nconst renderControls = (html) =>\n  html`\n    <div class=\"amp-video-docked-controls\" hidden>\n      <div\n        class=\"amp-video-docked-main-button-group\n               amp-video-docked-control-set-playback\"\n      >\n        <div class=\"amp-video-docked-button-group\">\n          <div\n            role=\"button\"\n            ref=\"playButton\"\n            class=\"amp-video-docked-play\"\n          ></div>\n          <div\n            role=\"button\"\n            ref=\"pauseButton\"\n            class=\"amp-video-docked-pause\"\n          ></div>\n        </div>\n        <div class=\"amp-video-docked-button-group\">\n          <div\n            role=\"button\"\n            ref=\"muteButton\"\n            class=\"amp-video-docked-mute\"\n          ></div>\n          <div\n            role=\"button\"\n            ref=\"unmuteButton\"\n            class=\"amp-video-docked-unmute\"\n          ></div>\n        </div>\n        <div class=\"amp-video-docked-button-group\">\n          <div\n            role=\"button\"\n            ref=\"fullscreenButton\"\n            class=\"amp-video-docked-fullscreen\"\n          ></div>\n        </div>\n      </div>\n      <div\n        class=\"amp-video-docked-main-button-group\n               amp-video-docked-control-set-scroll-back\"\n        hidden\n      >\n        <div class=\"amp-video-docked-button-group\">\n          <div\n            role=\"button\"\n            ref=\"scrollBackButton\"\n            class=\"amp-video-docked-scroll-back\"\n          ></div>\n        </div>\n      </div>\n      <div class=\"amp-video-docked-button-dismiss-group\" ref=\"dismissContainer\">\n        <div\n          role=\"button\"\n          ref=\"dismissButton\"\n          class=\"amp-video-docked-dismiss\"\n        ></div>\n      </div>\n    </div>\n  `;\n\nexport class Controls {\n  /** @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc */\n  constructor(ampdoc) {\n    /** @private {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    // TODO(alanorozco): `htmlFor` should work with `ShadowRoot`\n    const html = htmlFor(dev().assertElement(ampdoc.getBody()));\n\n    /** @public @const {!Element}  */\n    this.container = renderControls(html);\n\n    /** @public @const {!Element} */\n    this.overlay = renderDockedOverlay(html);\n\n    const refs = htmlRefs(this.container);\n    const assertRef = (ref) => dev().assertElement(refs[ref]);\n\n    /** @private @const {!Element} */\n    this.dismissButton_ = assertRef('dismissButton');\n\n    /** @private @const {!Element} */\n    this.playButton_ = assertRef('playButton');\n\n    /** @private @const {!Element} */\n    this.pauseButton_ = assertRef('pauseButton');\n\n    /** @private @const {!Element} */\n    this.muteButton_ = assertRef('muteButton');\n\n    /** @private @const {!Element} */\n    this.unmuteButton_ = assertRef('unmuteButton');\n\n    /** @private @const {!Element} */\n    this.fullscreenButton_ = assertRef('fullscreenButton');\n\n    /** @private @const {!Element} */\n    this.scrollBackButton_ = assertRef('scrollBackButton');\n\n    /** @private @const {!Element} */\n    this.dismissContainer_ = assertRef('dismissContainer');\n\n    /** @private @const {!NodeList} */\n    this.controlSets_ = this.container.querySelectorAll(\n      '.amp-video-docked-main-button-group'\n    );\n\n    /** @private {boolean} */\n    this.isDisabled_ = false;\n\n    /** @private {boolean} */\n    this.isSticky_ = false;\n\n    /** @private {function():!Timeout} */\n    this.getHideTimeout_ = once(\n      () =>\n        new Timeout(this.ampdoc_.win, () => {\n          this.hide(/* respectSticky */ true);\n        })\n    );\n\n    /** @private @const {!Array<!UnlistenDef>} */\n    this.videoUnlisteners_ = [];\n\n    /** @private {?UnlistenDef} */\n    this.mouseMoveUnlistener_ = null;\n\n    /** @private {?UnlistenDef} */\n    this.mouseOutUnlistener_ = null;\n\n    /** @private {?../../../src/layout-rect.LayoutRectDef} */\n    this.area_ = null;\n\n    /** @private {?../../../src/video-interface.VideoOrBaseElementDef} */\n    this.video_ = null;\n\n    this.hideOnTapOutside_();\n    this.showOnTapOrHover_();\n  }\n\n  /** @public */\n  disable() {\n    this.isDisabled_ = true;\n  }\n\n  /** @public */\n  enable() {\n    this.isDisabled_ = false;\n  }\n\n  /**\n   * @param {!../../../src/video-interface.VideoOrBaseElementDef} video\n   * @param {!../../../src/layout-rect.LayoutRectDef} area\n   */\n  setVideo(video, area) {\n    this.area_ = area;\n\n    if (this.video_ !== video) {\n      this.video_ = video;\n      this.listen_(video);\n    }\n  }\n\n  /**\n   * Sets displayed controls set.\n   * @param {ControlSet} setName\n   * @private\n   */\n  useControlSet_(setName) {\n    const activeClassname = `amp-video-docked-control-set-${setName}`;\n\n    iterateCursor(this.controlSets_, (controlSet) => {\n      toggle(controlSet, controlSet.classList.contains(activeClassname));\n    });\n  }\n\n  /**\n   * @param {!../../../src/video-interface.VideoOrBaseElementDef} video\n   * @private\n   */\n  listen_(video) {\n    this.unlisten_();\n\n    const click = 'click';\n\n    const {element} = video;\n\n    this.videoUnlisteners_.push(\n      this.listenWhenEnabled_(this.dismissButton_, click, () => {\n        this.dispatch_(VideoDockingEvents.DISMISS_ON_TAP);\n      }),\n\n      this.listenWhenEnabled_(this.playButton_, click, () => {\n        video.play(/* auto */ false);\n      }),\n\n      this.listenWhenEnabled_(this.pauseButton_, click, () => {\n        video.pause();\n      }),\n\n      this.listenWhenEnabled_(this.muteButton_, click, () => {\n        video.mute();\n      }),\n\n      this.listenWhenEnabled_(this.unmuteButton_, click, () => {\n        video.unmute();\n      }),\n\n      this.listenWhenEnabled_(this.fullscreenButton_, click, () => {\n        video.fullscreenEnter();\n      }),\n\n      this.listenWhenEnabled_(this.scrollBackButton_, click, () => {\n        this.dispatch_(VideoDockingEvents.SCROLL_BACK);\n      }),\n\n      listen(this.container, 'mouseup', () =>\n        this.hideOnTimeout(TIMEOUT_AFTER_INTERACTION)\n      ),\n\n      listen(element, VideoEvents.PLAYING, () => this.onPlay_()),\n      listen(element, VideoEvents.PAUSE, () => this.onPause_()),\n      listen(element, VideoEvents.MUTED, () => this.onMute_()),\n      listen(element, VideoEvents.UNMUTED, () => this.onUnmute_()),\n\n      listen(element, VideoEvents.AD_START, () =>\n        this.useControlSet_(ControlSet.SCROLL_BACK)\n      ),\n\n      listen(element, VideoEvents.AD_END, () =>\n        this.useControlSet_(ControlSet.PLAYBACK)\n      )\n    );\n  }\n\n  /**\n   * @param {VideoDockingEvents} event\n   * @private\n   */\n  dispatch_(event) {\n    this.container.dispatchEvent(\n      createCustomEvent(this.ampdoc_.win, event, /* detail */ undefined)\n    );\n  }\n\n  /** @private */\n  onPlay_() {\n    const {pauseButton_, playButton_} = this;\n    this.isSticky_ = false;\n    swap(playButton_, pauseButton_);\n  }\n\n  /** @private */\n  onPause_() {\n    const {pauseButton_, playButton_} = this;\n    this.isSticky_ = true;\n    swap(pauseButton_, playButton_);\n  }\n\n  /** @private */\n  onMute_() {\n    const {muteButton_, unmuteButton_} = this;\n    swap(muteButton_, unmuteButton_);\n  }\n\n  /** @private */\n  onUnmute_() {\n    const {muteButton_, unmuteButton_} = this;\n    swap(unmuteButton_, muteButton_);\n  }\n\n  /**\n   * @param {!Element} element\n   * @param {string} eventType\n   * @param {function()} callback\n   * @return {!UnlistenDef}\n   * @private\n   */\n  listenWhenEnabled_(element, eventType, callback) {\n    return listen(element, eventType, () => {\n      if (this.isDisabled_) {\n        return;\n      }\n      callback();\n    });\n  }\n\n  /** @private */\n  unlisten_() {\n    while (this.videoUnlisteners_.length > 0) {\n      this.videoUnlisteners_.pop().call();\n    }\n  }\n\n  /** @param {number=} timeout */\n  hideOnTimeout(timeout = TIMEOUT) {\n    this.getHideTimeout_().trigger(timeout);\n  }\n\n  /** @private */\n  showOnTapOrHover_() {\n    const {overlay} = this;\n    const boundShow = () => this.show_();\n\n    this.listenWhenEnabled_(overlay, 'click', boundShow);\n    this.listenWhenEnabled_(overlay, 'mouseover', boundShow);\n  }\n\n  /** @private */\n  show_() {\n    // Delay by one animation frame to stop mouseover-click sequence mistrigger.\n    // See https://jsbin.com/rohesijowi/1/edit?output on Chrome (Blink) on a\n    // touch device/device mode.\n    this.ampdoc_.win.requestAnimationFrame(() => {\n      this.showOnNextAnimationFrame_();\n    });\n  }\n\n  /** @private */\n  showOnNextAnimationFrame_() {\n    const manager = Services.videoManagerForDoc(this.ampdoc_);\n    const video = devAssert(this.video_);\n\n    const isRollingAd = manager.isRollingAd(video);\n    const isMuted = manager.isMuted(video);\n    const isPlaying = manager.getPlayingState(video) !== PlayingStates.PAUSED;\n\n    const {container, overlay} = this;\n\n    toggle(container, true);\n\n    container.classList.add('amp-video-docked-controls-shown');\n    overlay.classList.add('amp-video-docked-controls-bg');\n\n    this.useControlSet_(\n      isRollingAd ? ControlSet.SCROLL_BACK : ControlSet.PLAYBACK\n    );\n\n    toggle(this.playButton_, !isPlaying);\n    toggle(this.pauseButton_, isPlaying);\n\n    toggle(this.muteButton_, !isMuted);\n    toggle(this.unmuteButton_, isMuted);\n\n    this.listenToMouseMove_();\n    this.hideOnTimeout();\n  }\n\n  /**\n   * @param {number} scale\n   * @param {number} x\n   * @param {number} y\n   * @param {number} width\n   * @param {number} height\n   */\n  positionOnVsync(scale, x, y, width, height) {\n    this.area_ = layoutRectLtwh(x, y, width * scale, height * scale);\n\n    const {container} = this;\n    const halfScale = scale / 2;\n    const centerX = x + width * halfScale;\n    const centerY = y + height * halfScale;\n\n    applyBreakpointClassname(container, scale * width, BREAKPOINTS);\n\n    setImportantStyles(container, {\n      'transform': translate(centerX, centerY),\n    });\n\n    const dismissMargin = 4;\n    const dismissWidth = 40;\n    const dismissX = width * halfScale - dismissMargin - dismissWidth;\n    const dismissY = -(height * halfScale - dismissMargin - dismissWidth);\n    setImportantStyles(this.dismissContainer_, {\n      'transform': translate(dismissX, dismissY),\n    });\n  }\n\n  /** @private */\n  hideOnTapOutside_() {\n    listen(this.ampdoc_.getRootNode(), 'mousedown', (e) => {\n      if (this.isControlsTarget_(dev().assertElement(e.target))) {\n        return;\n      }\n      this.hide(/* respectSticky */ true);\n    });\n  }\n\n  /**\n   * @param {!Element} target\n   * @return {boolean}\n   * @private\n   */\n  isControlsTarget_(target) {\n    return (\n      target == this.overlay ||\n      !!closestAncestorElementBySelector(target, '.amp-video-docked-controls')\n    );\n  }\n\n  /**\n   * @param {boolean=} opt_respectSticky\n   * @param {boolean=} opt_immediately Disables transition\n   * @public\n   */\n  hide(opt_respectSticky, opt_immediately) {\n    const ampVideoDockedControlsShown = 'amp-video-docked-controls-shown';\n    const {container, overlay} = this;\n    if (!container.classList.contains(ampVideoDockedControlsShown)) {\n      return;\n    }\n    if (opt_respectSticky && this.isSticky_) {\n      return;\n    }\n    if (opt_immediately) {\n      toggle(container, false);\n      toggle(overlay, false);\n    }\n    overlay.classList.remove('amp-video-docked-controls-bg');\n    container.classList.remove(ampVideoDockedControlsShown);\n  }\n\n  /** @private */\n  listenToMouseMove_() {\n    if (this.mouseMoveUnlistener_) {\n      return;\n    }\n\n    this.mouseMoveUnlistener_ = listen(this.overlay, 'mousemove', () => {\n      this.show_();\n    });\n\n    this.mouseOutUnlistener_ = listen(this.overlay, 'mouseout', (e) => {\n      devAssert(this.area_);\n\n      const {x, y} = pointerCoords(/** @type {!MouseEvent} */ (e));\n      const {bottom, left, right, top} = this.area_;\n\n      // check bounding box as not to trigger this while mouse hovers over\n      // buttons\n      if (!(x < left || x > right || y < top || y > bottom)) {\n        return;\n      }\n\n      this.hide(/* respectSticky */ true);\n      this.unlistenToMouseMovement_();\n    });\n  }\n\n  /** @private */\n  unlistenToMouseMovement_() {\n    if (this.mouseMoveUnlistener_) {\n      this.mouseMoveUnlistener_();\n      this.mouseMoveUnlistener_ = null;\n    }\n    if (this.mouseOutUnlistener_) {\n      this.mouseOutUnlistener_();\n      this.mouseOutUnlistener_ = null;\n    }\n  }\n\n  /** @public */\n  reset() {\n    const {container, overlay} = this;\n    const els = [overlay, container];\n\n    toggle(overlay, false);\n\n    this.hide();\n\n    for (let i = 0; i < els.length; i++) {\n      const el = els[i];\n      resetStyles(el, ['transform', 'transition', 'width', 'height']);\n    }\n  }\n}\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * These are interchangeable.\n * @typedef {!ClientRect|!../../../src/layout-rect.LayoutRectDef}\n */\nexport let RectDef;\n\n/** @enum {string} */\nexport const DirectionX = {LEFT: 'left', RIGHT: 'right'};\n\n/** @enum {string} */\nexport const DirectionY = {TOP: 'top', BOTTOM: 'bottom'};\n\n/** A loose small decimal amount to compensate for rough float calculations. */\nexport const FLOAT_TOLERANCE = 0.02;\n", "/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../assert';\n\n/**\n * Maps a value in a first range to its equivalent in a second range\n * Ex.: 5 in the range [0,10] gives 60 in the range[40,80]\n *\n * NOTE: lower/upper bounds on the source range are detected automatically,\n * however the bounds on the target range are not altered (thus the target\n * range could be decreasing).\n * Ex1: 8 in the range [0, 10] gives 2 in the range [10, 0]\n * Ex2: also, 8 in the range [10, 0] gives 2 in the range [10, 0]\n *\n * NOTE: Input value is enforced to be bounded inside the source range\n * Ex1: -2 in the range [0, 10] is interpreted as 0 and thus gives 40 in [40,80]\n * Ex2: 19 in the range [0, 5] is interpreted as 5 and thus gives 80 in [40,80]\n *\n * @param {number} val the value in the source range\n * @param {number} min1 the lower bound of the source range\n * @param {number} max1 the upper bound of the source range\n * @param {number} min2 the lower bound of the target range\n * @param {number} max2 the upper bound of the target range\n * @return {number} the equivalent value in the target range\n */\nexport function mapRange(val, min1, max1, min2, max2) {\n  let max1Bound = max1;\n  let min1Bound = min1;\n  if (min1 > max1) {\n    max1Bound = min1;\n    min1Bound = max1;\n  }\n\n  if (val < min1Bound) {\n    val = min1Bound;\n  } else if (val > max1Bound) {\n    val = max1Bound;\n  }\n\n  return ((val - min1) * (max2 - min2)) / (max1 - min1) + min2;\n}\n\n/**\n * Computes the modulus of values `a` and `b`.\n *\n * This is needed because the % operator in JavaScript doesn't implement\n * modulus behavior as can be seen by the spec here:\n * http://www.ecma-international.org/ecma-262/5.1/#sec-11.5.3.\n * It instead is used to obtain the remainder of a division.\n * This function uses the remainder (%) operator to determine the modulus.\n * Derived from here:\n * https://stackoverflow.com/questions/25726760/javascript-modular-arithmetic/47354356#47354356\n *\n * @param {number} a\n * @param {number} b\n * @return {number} returns the modulus of the two numbers.\n * @example\n *\n * _.min(10, 5);\n * // => 0\n *\n * _.mod(-1, 5);\n * // => 4\n */\nexport function mod(a, b) {\n  return a > 0 && b > 0 ? a % b : ((a % b) + b) % b;\n}\n\n/**\n * Restricts a number to be in the given min/max range. The minimum value must\n * be less than or equal to the maximum value.\n *\n * Examples:\n * clamp(0.5, 0, 1) -> 0.5\n * clamp(1.5, 0, 1) -> 1\n * clamp(-0.5, 0, 1) -> 0\n *\n * @param {number} val the value to clamp.\n * @param {number} min the lower bound.\n * @param {number} max the upper bound.\n * @return {number} the clamped value.\n */\nexport function clamp(val, min, max) {\n  devAssert(min <= max, 'Minimum value is greater than the maximum.');\n  return Math.min(Math.max(val, min), max);\n}\n\n/**\n * Returns value bound to min and max values +/- extent. The lower bound must\n * be less than or equal to the upper bound.\n * @param {number} val the value to bound.\n * @param {number} min the lower bound.\n * @param {number} max the upper bound\n * @param {number} extent the allowed extent beyond the bounds.\n * @return {number} the bounded value.\n */\nexport function boundValue(val, min, max, extent) {\n  devAssert(min <= max, 'Lower bound is greater than the upper bound.');\n  return clamp(val, min - extent, max + extent);\n}\n\n/**\n * Returns the length of a vector given in X- and Y-coordinates.\n * @param {number} deltaX distance in the X direction.\n * @param {number} deltaY distance in the Y direction.\n * @return {number} the magnitude of the vector.\n */\nexport function magnitude(deltaX, deltaY) {\n  return Math.sqrt(deltaX * deltaX + deltaY * deltaY);\n}\n\n/**\n * Returns the distance between two points.\n * @param {number} x1 X-coordinate of the first point.\n * @param {number} y1 Y-coordinate of the first point.\n * @param {number} x2 X-coordinate of the second point.\n * @param {number} y2 Y-coordinate of the second point.\n * @return {number} the distance between the two points.\n */\nexport function distance(x1, y1, x2, y2) {\n  return magnitude(x2 - x1, y2 - y1);\n}\n\n/**\n * @param {number} centerX\n * @param {number} centerY\n * @param {number} radius\n * @param {number} angleInDegrees\n * @return {{\n *  x: number,\n *  y: number,\n * }}\n */\nexport function polarToCartesian(centerX, centerY, radius, angleInDegrees) {\n  const angleInRadians = ((angleInDegrees - 90) * Math.PI) / 180.0;\n\n  return {\n    x: centerX + radius * Math.cos(angleInRadians),\n    y: centerY + radius * Math.sin(angleInRadians),\n  };\n}\n\n/**\n * Sums up the values of the given array and returns the result\n * @param {Array<number>} values\n * @return {number}\n */\nexport function sum(values) {\n  return values.reduce(function (a, b) {\n    return a + b;\n  });\n}\n", "/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {DirectionX, RectDef} from './def';\nimport {layoutRectLtwh} from '../../../src/core/math/layout-rect';\nimport {mapRange} from '../../../src/core/math';\n\n/**\n * @param {number} containerWidth\n * @param {number} itemWidth\n * @param {number} itemMargin\n * @param {number} directedStep\n * @return {number}\n */\nfunction calculateJustified(\n  containerWidth,\n  itemWidth,\n  itemMargin,\n  directedStep\n) {\n  return directedStep * (containerWidth - itemWidth - itemMargin * 2);\n}\n\n/**\n * @param {number} containerWidth\n * @param {number} itemWidth\n * @param {number} itemMargin\n * @param {number} step\n * @return {number}\n */\nexport function calculateRightJustifiedX(\n  containerWidth,\n  itemWidth,\n  itemMargin,\n  step\n) {\n  return calculateJustified(containerWidth, itemWidth, itemMargin, step);\n}\n\n/**\n * @param {number} containerWidth\n * @param {number} itemWidth\n * @param {number} itemMargin\n * @param {number} step\n * @return {number}\n */\nexport function calculateLeftJustifiedX(\n  containerWidth,\n  itemWidth,\n  itemMargin,\n  step\n) {\n  return calculateJustified(containerWidth, itemWidth, itemMargin, -step);\n}\n\n/**\n * Maps an interpolation step in [0..1] to its position in a range.\n * @param {number} step\n * @param {number} min\n * @param {number} max\n * @return {number}\n */\nconst mapStep = (step, min, max) => mapRange(step, 0, 1, min, max);\n\n/**\n * Provides offset coords to interpolate `from` rect `to` rect.\n * @param {!RectDef} from\n * @param {!RectDef} to\n * @param {number=} step  in [0..1]\n * @return {{x: number, y: number, scale: number, relativeX: !DirectionX}}\n *  - x is offset from the original box in pixels.\n *  - y is offset from the original box in pixels.\n *  - scale is the\n */\nexport function interpolatedBoxesTransform(from, to, step = 1) {\n  const relativeX = to.x < from.x ? DirectionX.LEFT : DirectionX.RIGHT;\n  const x = mapStep(step, from.x, to.x);\n  const y = mapStep(step, from.y, to.y);\n  const width = mapStep(step, from.width, to.width);\n  const scale = width / from.width;\n  return {x, y, scale, relativeX};\n}\n\n/**\n * Scales, fits and centers `original` into `container`.\n * @param {!RectDef} original\n * @param {!RectDef} container\n * @return {!RectDef}\n */\nexport function letterboxRect(original, container) {\n  const {height, width} = original;\n  const {height: maxHeight, left, top, width: maxWidth} = container;\n\n  const containerAspect = maxWidth / maxHeight;\n  const originalAspect = width / height;\n\n  let x, y, scale;\n\n  if (originalAspect > containerAspect) {\n    scale = maxWidth / width;\n    y = top + maxHeight / 2 - (height * scale) / 2;\n    x = left;\n  } else {\n    scale = maxHeight / height;\n    x = left + maxWidth / 2 - (width * scale) / 2;\n    y = top;\n  }\n\n  return layoutRectLtwh(x, y, width * scale, height * scale);\n}\n\n/**\n * @param {!RectDef} original\n * @param {!RectDef} container\n * @param {DirectionX} horizontalEdge\n * @param {number} widthRatio\n * @param {number} widthMin\n * @param {number} marginRatio\n * @param {number} marginMax\n * @return {!RectDef}\n */\nexport function topCornerRect(\n  original,\n  container,\n  horizontalEdge,\n  widthRatio,\n  widthMin,\n  marginRatio,\n  marginMax\n) {\n  const widthUnit = container.width;\n\n  const margin = Math.min(marginMax, marginRatio * widthUnit);\n  const aspect = original.width / original.height;\n\n  const width = Math.max(widthMin, widthUnit * widthRatio);\n  const height = width / aspect;\n\n  const x =\n    horizontalEdge == DirectionX.RIGHT\n      ? container.right - margin - width\n      : container.left + margin;\n\n  const y = margin;\n\n  return layoutRectLtwh(x, y, width, height);\n}\n\n/**\n * @param {!AmpElement} element\n * @return {boolean}\n */\nexport const isVisibleBySize = (element) =>\n  isSizedRect(element./*OK*/ getBoundingClientRect());\n\n/**\n * @param {!RectDef} rect\n * @return {boolean}\n */\nexport const isSizedRect = (rect) => rect.width > 0 && rect.height > 0;\n", "/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  LayoutRectDef,\n  layoutRectLtwh,\n} from '../../../src/core/math/layout-rect';\n\n/**\n * @param {function():T} get\n * @return {{get: function():T, configurable: boolean, enumerable: boolean}}\n * @template T\n */\nconst readonlyGetterProp = (get) => ({\n  get,\n  configurable: false,\n  enumerable: true,\n});\n\n/**\n * Returns a `LayoutRectDef`-like object whose values match the viewport's area\n * accoding to service.\n * @param {!../../../src/service/viewport/viewport-interface.ViewportInterface} viewport\n * @return {!LayoutRectDef} with dynamic getters\n */\nexport function createViewportRect(viewport) {\n  const width = readonlyGetterProp(() => viewport.getSize().width);\n  const height = readonlyGetterProp(() => viewport.getSize().height);\n\n  return /** @type {!LayoutRectDef} */ (\n    Object.defineProperties(layoutRectLtwh(0, 0, 0, 0), {\n      width,\n      height,\n      right: width,\n      bottom: height,\n    })\n  );\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {dev} from '../log';\nimport {setStyles} from '../style';\n\n/**\n * @param {!Window} win\n * @return {!Promise<boolean>}\n */\nexport function detectIsAutoplaySupported(win) {\n  // To detect autoplay, we create a video element and call play on it, if\n  // `paused` is true after `play()` call, autoplay is supported. Although\n  // this is unintuitive, it works across browsers and is currently the lightest\n  // way to detect autoplay without using a data source.\n  const detectionElement = /** @type {!HTMLVideoElement} */ (\n    win.document.createElement('video')\n  );\n\n  // NOTE(aghassemi): We need both attributes and properties due to Chrome and\n  // Safari differences when dealing with non-attached elements.\n  detectionElement.setAttribute('muted', '');\n  detectionElement.setAttribute('playsinline', '');\n  detectionElement.setAttribute('webkit-playsinline', '');\n  detectionElement.setAttribute('height', '0');\n  detectionElement.setAttribute('width', '0');\n\n  detectionElement.muted = true;\n  detectionElement.playsInline = true;\n  detectionElement['playsinline'] = true;\n  detectionElement['webkitPlaysinline'] = true;\n\n  setStyles(detectionElement, {\n    position: 'fixed',\n    top: '0',\n    width: '0',\n    height: '0',\n    opacity: '0',\n  });\n\n  // Promise wrapped this way to catch both sync throws and async rejections.\n  // More info: https://github.com/tc39/proposal-promise-try\n  new Promise((resolve) => resolve(detectionElement.play())).catch(() => {\n    // Suppress any errors, useless to report as they are expected.\n  });\n\n  return Promise.resolve(!detectionElement.paused);\n}\n\nconst AUTOPLAY_SUPPORTED_WIN_PROP = '__AMP_AUTOPLAY';\n\n/**\n * Determines autoplay support.\n *\n * Note that even if platfrom supports autoplay, users or browsers can disable\n * autoplay to save data / battery. This detects both platfrom support and\n * when autoplay has been disabled by the user.\n *\n * @param {!Window} win\n * @return {!Promise<boolean>}\n */\nexport function isAutoplaySupported(win) {\n  if (win[AUTOPLAY_SUPPORTED_WIN_PROP] == null) {\n    win[AUTOPLAY_SUPPORTED_WIN_PROP] = detectIsAutoplaySupported(win);\n  }\n  return win[AUTOPLAY_SUPPORTED_WIN_PROP];\n}\n\n/**\n * @param {!Window} win\n * @visibleForTesting\n */\nexport function resetIsAutoplaySupported(win) {\n  delete win[AUTOPLAY_SUPPORTED_WIN_PROP];\n}\n\n/**\n * @param {!Element} element\n * @return {!Element}\n */\nexport function getInternalVideoElementFor(element) {\n  return dev().assertElement(element.querySelector('video, iframe'));\n}\n", "/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CommonSignals} from './core/constants/common-signals';\nimport {Services} from './services';\nimport {TickLabel} from './core/constants/enums';\nimport {dev, devAssert} from './log';\nimport {getAmpdoc} from './service';\nimport {insertAfterOrAtStart, waitForBodyOpenPromise} from './dom';\nimport {map} from './core/types/object';\nimport {rethrowAsync} from './core/error';\nimport {setStyles} from './style';\nimport {waitForServices} from './render-delaying-services';\n\nconst TRANSFORMER_PROP = '__AMP_CSS_TR';\nconst STYLE_MAP_PROP = '__AMP_CSS_SM';\n\n/**\n * Adds the given css text to the given ampdoc.\n *\n * The style tags will be at the beginning of the head before all author\n * styles. One element can be the main runtime CSS. This is guaranteed\n * to always be the first stylesheet in the doc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc The ampdoc that should get the new styles.\n * @param {string} cssText\n * @param {?function(!Element)|undefined} cb Called when the new styles are available.\n *     Not using a promise, because this is synchronous when possible.\n *     for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n * @param {string=} opt_ext\n * @return {!Element}\n */\nexport function installStylesForDoc(\n  ampdoc,\n  cssText,\n  cb,\n  opt_isRuntimeCss,\n  opt_ext\n) {\n  const cssRoot = ampdoc.getHeadNode();\n  const style = insertStyleElement(\n    cssRoot,\n    maybeTransform(cssRoot, cssText),\n    opt_isRuntimeCss || false,\n    opt_ext || null\n  );\n\n  if (cb) {\n    const rootNode = ampdoc.getRootNode();\n    // Styles aren't always available synchronously. E.g. if there is a\n    // pending style download, it will have to finish before the new\n    // style is visible.\n    // For this reason we poll until the style becomes available.\n    // Sync case.\n    if (styleLoaded(rootNode, style)) {\n      cb(style);\n      return style;\n    }\n    // Poll until styles are available.\n    const interval = setInterval(() => {\n      if (styleLoaded(rootNode, style)) {\n        clearInterval(interval);\n        cb(style);\n      }\n    }, 4);\n  }\n  return style;\n}\n\n/**\n * Creates the properly configured style element.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @param {boolean} isRuntimeCss\n * @param {?string} ext\n * @return {!Element}\n */\nfunction insertStyleElement(cssRoot, cssText, isRuntimeCss, ext) {\n  let styleMap = cssRoot[STYLE_MAP_PROP];\n  if (!styleMap) {\n    styleMap = cssRoot[STYLE_MAP_PROP] = map();\n  }\n\n  const isExtCss =\n    !isRuntimeCss && ext && ext != 'amp-custom' && ext != 'amp-keyframes';\n  const key = isRuntimeCss\n    ? 'amp-runtime'\n    : isExtCss\n    ? `amp-extension=${ext}`\n    : null;\n\n  // Check if it has already been created or discovered.\n  if (key) {\n    const existing = getExistingStyleElement(cssRoot, styleMap, key);\n    if (existing) {\n      if (existing.textContent !== cssText) {\n        existing.textContent = cssText;\n      }\n      return existing;\n    }\n  }\n\n  // Create the new style element and append to cssRoot.\n  const doc = cssRoot.ownerDocument || cssRoot;\n  const style = doc.createElement('style');\n  style./*OK*/ textContent = cssText;\n  let afterElement = null;\n  // Make sure that we place style tags after the main runtime CSS. Otherwise\n  // the order is random.\n  if (isRuntimeCss) {\n    style.setAttribute('amp-runtime', '');\n  } else if (isExtCss) {\n    style.setAttribute('amp-extension', ext || '');\n    afterElement = dev().assertElement(\n      getExistingStyleElement(cssRoot, styleMap, 'amp-runtime')\n    );\n  } else {\n    if (ext) {\n      style.setAttribute(ext, '');\n    }\n    afterElement = cssRoot.lastChild;\n  }\n  insertAfterOrAtStart(cssRoot, style, afterElement);\n  if (key) {\n    styleMap[key] = style;\n  }\n  return style;\n}\n\n/**\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {!Object<string, !Element>} styleMap\n * @param {string} key\n * @return {?Element}\n */\nfunction getExistingStyleElement(cssRoot, styleMap, key) {\n  // Already cached.\n  if (styleMap[key]) {\n    return styleMap[key];\n  }\n  // Check if the style has already been added by the server layout.\n  const existing = cssRoot./*OK*/ querySelector(`style[${key}]`);\n  if (existing) {\n    styleMap[key] = existing;\n    return existing;\n  }\n  // Nothing found.\n  return null;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {function(string):string} transformer\n */\nexport function installCssTransformer(cssRoot, transformer) {\n  cssRoot[TRANSFORMER_PROP] = transformer;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @return {string}\n */\nfunction maybeTransform(cssRoot, cssText) {\n  const transformer = cssRoot[TRANSFORMER_PROP];\n  return transformer ? transformer(cssText) : cssText;\n}\n\n/** @private {boolean} */\nlet bodyMadeVisible = false;\n\n/**\n * @param {boolean} value\n * @visibleForTesting\n */\nexport function setBodyMadeVisibleForTesting(value) {\n  bodyMadeVisible = value;\n}\n\n/**\n * Sets the document's body opacity to 1.\n * If the body is not yet available (because our script was loaded\n * synchronously), polls until it is.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisible(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  const win = /** @type {!Window} */ (doc.defaultView);\n  waitForBodyOpenPromise(doc)\n    .then(() => {\n      return waitForServices(win);\n    })\n    .catch((reason) => {\n      rethrowAsync(reason);\n      return [];\n    })\n    .then((services) => {\n      bodyMadeVisible = true;\n      if (INI_LOAD_INOB) {\n        // Force sync measurement to ensure that style recalc is complete\n        // before showing body, which would trigger FCP. This should reduce\n        // make it less likely that a CLS would be triggered after FCP.\n        doc.body./*OK*/ getBoundingClientRect();\n      }\n      setBodyVisibleStyles(doc);\n      const ampdoc = getAmpdoc(doc);\n      ampdoc.signals().signal(CommonSignals.RENDER_START);\n      if (services.length > 0) {\n        const resources = Services.resourcesForDoc(doc.documentElement);\n        resources./*OK*/ schedulePass(1, /* relayoutAll */ true);\n      }\n      try {\n        const perf = Services.performanceFor(win);\n        perf.tick(TickLabel.MAKE_BODY_VISIBLE);\n        perf.flush();\n      } catch (e) {}\n    });\n}\n\n/**\n * Set the document's body opacity to 1. Called in error cases.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisibleRecovery(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  if (bodyMadeVisible) {\n    return;\n  }\n  bodyMadeVisible = true;\n  setBodyVisibleStyles(doc);\n}\n\n/**\n * Make sure that body exists, and make it visible.\n * @param {!Document} doc\n */\nfunction setBodyVisibleStyles(doc) {\n  setStyles(dev().assertElement(doc.body), {\n    opacity: 1,\n    visibility: 'visible',\n    'animation': 'none',\n  });\n}\n\n/**\n * Indicates that the body is always visible. For instance, in case of PWA.\n * This check is on a module level variable, and could be problematic if you are\n * relying on this function across different binaries.\n * @param {!Window} unusedWin\n */\nexport function bodyAlwaysVisible(unusedWin) {\n  bodyMadeVisible = true;\n}\n\n/**\n * Checks whether a style element was registered in the DOM.\n * @param {!Document|!ShadowRoot} doc\n * @param {!Element} style\n * @return {boolean}\n */\nfunction styleLoaded(doc, style) {\n  const sheets = doc.styleSheets;\n  for (let i = 0; i < sheets.length; i++) {\n    const sheet = sheets[i];\n    if (sheet.ownerNode == style) {\n      return true;\n    }\n  }\n  return false;\n}\n", "/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {ActionTrust} from '../../../src/core/constants/action-constants';\nimport {CSS} from '../../../build/amp-video-docking-0.1.css';\nimport {Controls} from './controls';\nimport {DirectionX, DirectionY, FLOAT_TOLERANCE, RectDef} from './def';\nimport {HtmlLiteralTagDef} from './html';\nimport {\n  PlayingStates,\n  VideoAttributes,\n  VideoEvents,\n  VideoInterface,\n  VideoOrBaseElementDef,\n  isDockable,\n} from '../../../src/video-interface';\nimport {Services} from '../../../src/services';\nimport {VideoDockingEvents, pointerCoords} from './events';\nimport {applyBreakpointClassname} from './breakpoints';\nimport {\n  calculateLeftJustifiedX,\n  calculateRightJustifiedX,\n  interpolatedBoxesTransform,\n  isSizedRect,\n  isVisibleBySize,\n  letterboxRect,\n  topCornerRect,\n} from './math';\nimport {createCustomEvent, listen, listenOnce} from '../../../src/event-helper';\nimport {createViewportRect} from './viewport-rect';\nimport {dev, devAssert, user, userAssert} from '../../../src/log';\nimport {dict} from '../../../src/core/types/object';\nimport {escapeCssSelectorIdent} from '../../../src/core/dom/css-selectors';\nimport {getInternalVideoElementFor} from '../../../src/utils/video';\nimport {htmlFor, htmlRefs} from '../../../src/static-template';\nimport {installStylesForDoc} from '../../../src/style-installer';\nimport {isRTL, removeElement} from '../../../src/dom';\nimport {\n  layoutRectEquals,\n  rectIntersection,\n} from '../../../src/core/math/layout-rect';\nimport {once} from '../../../src/core/types/function';\nimport {\n  px,\n  resetStyles,\n  setImportantStyles,\n  setStyles,\n  toggle,\n} from '../../../src/style';\nimport {scopedQuerySelector} from '../../../src/core/dom/query';\n\nconst TAG = 'amp-video-docking';\n\n/** Ratio to viewport width to use when docked to corner. */\nexport const CORNER_WIDTH_RATIO = 0.3;\n\n/** Min width in pixels for corner area. */\nexport const CORNER_WIDTH_MIN = 180;\n\n/** Max amount of pixels to use for margins (it's relative to viewport.) */\nexport const CORNER_MARGIN_MAX = 30;\n\n/** Max % of viewport width to use form margins. */\nexport const CORNER_MARGIN_RATIO = 0.04;\n\n/** Min viewport width for dock to appear at all. */\nexport const MIN_VIEWPORT_WIDTH = 320;\n\n/** Min visible intersection ratio of inline box to undock when scrolling. */\nexport const REVERT_TO_INLINE_RATIO = 0.85;\n\n/**\n * Width/height of placeholder icon when the inline box is large.\n * @visibleForTesting\n */\nexport const PLACEHOLDER_ICON_LARGE_WIDTH = 48;\n\n/** Margin applied to placeholder icon when the inline box is large. */\nexport const PLACEHOLDER_ICON_LARGE_MARGIN = 40;\n\n/** Width/height of placeholder icon when the inline box is small. */\nexport const PLACEHOLDER_ICON_SMALL_WIDTH = 32;\n\n/** Margin applied to placeholder icon when the inline box is large. */\nexport const PLACEHOLDER_ICON_SMALL_MARGIN = 20;\n\n/** @const {!Array<!./breakpoints.SyntheticBreakpointDef>} */\nexport const PLACEHOLDER_ICON_BREAKPOINTS = [\n  {\n    className: 'amp-small',\n    minWidth: 0,\n  },\n  {\n    className: 'amp-large',\n    minWidth: 420,\n  },\n];\n\n/** @visibleForTesting @const {string} */\nexport const BASE_CLASS_NAME = 'i-amphtml-video-docked';\n\n/** @enum {string} */\nexport const Actions = {DOCK: 'dock', UNDOCK: 'undock'};\n\n/** @enum {string} */\nexport const DockTargetType = {\n  // Dynamically calculated corner based on viewport percentage. Draggable.\n  CORNER: 'corner',\n  // Targets author-defined element's box. Not draggable.\n  SLOT: 'slot',\n};\n\n/**\n * @struct @typedef {{\n *   video: !VideoOrBaseElementDef,\n *   target: !DockTargetDef,\n *   step: number,\n * }}\n */\nlet DockedDef;\n\n/**\n * @struct @typedef {{\n *   type: DockTargetType,\n *   rect: !RectDef,\n *   slot: (!Element|undefined),\n * }}\n */\nlet DockTargetDef;\n\n/**\n * @param {number} x\n * @param {number} y\n * @param {number} scale\n * @return {string}\n */\nconst transform = (x, y, scale) => `translate(${x}px, ${y}px) scale(${scale})`;\n\n/**\n * @param {!Window} win\n * @param {function(...*)} fn\n * @return {function(...*)}\n */\nfunction throttleByAnimationFrame(win, fn) {\n  let running = false;\n  return (...args) => {\n    if (running) {\n      return;\n    }\n    running = true;\n    win.requestAnimationFrame(() => {\n      fn.apply(null, args);\n      running = false;\n    });\n  };\n}\n\n/**\n * @param {!Element} element\n * @restricted\n */\nfunction complainAboutPortrait(element) {\n  // Constant named `TAG` per lint rules.\n  const TAG = element.tagName.toUpperCase();\n  user().error(\n    TAG,\n    'Minimize-to-corner (`dock`) does not support portrait video.',\n    element\n  );\n}\n\n/**\n * Gets a poster src URL from a video players element.\n * API across components is unfortunately inconsistent, so this queries for all\n * known `poster` attribute patterns. Instances may also not use the `poster`\n * API at all, in which case we fallback to `placeholder` images.\n * @param {!Element} element\n * @return {string|undefined}\n * @private\n */\nexport function getPosterImageSrc(element) {\n  const attr =\n    element.getAttribute('poster') || element.getAttribute('data-poster');\n  if (attr) {\n    return attr;\n  }\n  const imgEl = scopedQuerySelector(\n    element,\n    'amp-img[placeholder],img[placeholder],[placeholder] amp-img'\n  );\n  if (imgEl) {\n    return imgEl.getAttribute('src');\n  }\n}\n\n/**\n * Returns an element representing a shadow under the docked video.\n * Alternatively, we could use box-shadow on the video element, but in\n * order to animate it without jank we have to use an opacity transition.\n * A separate layer also has the added benefit that authors can override its\n * box-shadow value or any other styling without handling the transition\n * themselves.\n * @param {!HtmlLiteralTagDef} html\n * @return {!Element}\n * @private\n */\nconst ShadowLayer = (html) =>\n  html` <div class=\"amp-video-docked-shadow\" hidden></div> `;\n\n/**\n * @param {!HtmlLiteralTagDef} html\n * @return {!Element}\n * @private\n */\nconst PlaceholderBackground = (html) =>\n  html`\n    <div class=\"amp-video-docked-placeholder-background\">\n      <div\n        class=\"amp-video-docked-placeholder-background-poster\"\n        ref=\"poster\"\n      ></div>\n      <div class=\"amp-video-docked-placeholder-icon\" ref=\"icon\"></div>\n    </div>\n  `;\n\n/**\n * Manages docking (a.k.a. minimize to corner) for videos that satisfy the\n * {@see VideoInterface}.\n * @visibleForTesting\n */\nexport class VideoDocking {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @private @const {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @private @const */\n    this.manager_ = once(() => Services.videoManagerForDoc(ampdoc));\n\n    /** @private @const {!../../../src/service/viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(ampdoc);\n\n    /** @private @const {!RectDef} */\n    this.viewportRect_ = createViewportRect(this.viewport_);\n\n    /** @private {?DockedDef} */\n    this.currentlyDocked_ = null;\n\n    /**\n     * Overriden when user drags the video to a different corner.\n     * @private {?DirectionX}\n     */\n    this.cornerDirectionX_ = null;\n\n    const html = htmlFor(this.getDoc_());\n\n    /** @private @const {function():!Element} */\n    this.getShadowLayer_ = once(() => this.append_(ShadowLayer(html)));\n\n    /** @private @const {function():!Controls} */\n    this.getControls_ = once(() => this.installControls_());\n\n    /** @private @const {function():!Element} */\n    this.getPlaceholderBackground_ = once(() =>\n      this.append_(PlaceholderBackground(html))\n    );\n\n    /** @private @const {function():!Object<string, !Element>} */\n    this.getPlaceholderRefs_ = once(() =>\n      htmlRefs(this.getPlaceholderBackground_())\n    );\n\n    /** @private {?VideoOrBaseElementDef} */\n    this.lastDismissed_ = null;\n\n    /**\n     * Memoizes x, y and scale to prevent useless mutations.\n     * @private {?{x: number, y: number, scale: number}}\n     */\n    this.placedAt_ = null;\n\n    /** @private {?{width: number, height: number}} */\n    this.sizedAt_ = null;\n\n    /** @private {?DirectionY} */\n    this.scrollDirection_ = null;\n\n    /** @private {number} */\n    this.lastScrollTop_ = this.viewport_.getScrollTop();\n\n    /** @private {boolean} */\n    this.isDragging_ = false;\n\n    /** @private {number} */\n    this.dragOffsetX_ = 0;\n\n    /** @private {number} */\n    this.previousDragOffsetX_ = 0;\n\n    /** @private {number} */\n    this.dragVelocityX_ = 0;\n\n    /** @private {!Array<!VideoOrBaseElementDef>} */\n    this.observed_ = [];\n\n    /**\n     * Lazily invoked.\n     * @private @const {!function()}\n     */\n    this.install_ = once(() => {\n      const ampdoc = this.ampdoc_;\n\n      this.viewport_.onScroll(\n        throttleByAnimationFrame(ampdoc.win, () => this.updateScroll_())\n      );\n\n      this.viewport_.onResize(() => this.onViewportResize_());\n\n      installStylesForDoc(\n        ampdoc,\n        CSS,\n        /* callback */ null,\n        /* isRuntimeCss */ false,\n        TAG\n      );\n    });\n\n    /** @private @const {function():?Element} */\n    this.findSlotOnce_ = once(() => this.findSlot_());\n\n    /** @private @const {?IntersectionObserver} */\n    this.intersectionObserver_ = null;\n\n    /** @private {boolean} */\n    this.isTransitioning_ = false;\n\n    this.registerAll_();\n  }\n\n  /** @private */\n  registerAll_() {\n    if (!this.isEnabled_()) {\n      return;\n    }\n\n    const ampdoc = this.ampdoc_;\n\n    const dockableSelector = `[${escapeCssSelectorIdent(\n      VideoAttributes.DOCK\n    )}]`;\n\n    const dockableElements = ampdoc\n      .getRootNode()\n      .querySelectorAll(dockableSelector);\n\n    for (let i = 0; i < dockableElements.length; i++) {\n      const element = dockableElements[i];\n      if (element.signals && element.signals().get(VideoEvents.REGISTERED)) {\n        this.registerElement(element);\n      }\n    }\n\n    listen(ampdoc.getBody(), VideoEvents.REGISTERED, (e) => {\n      const target = dev().assertElement(e.target);\n      if (isDockable(target)) {\n        this.registerElement(target);\n      }\n    });\n  }\n\n  /**\n   * @return {boolean}\n   * @private\n   */\n  isEnabled_() {\n    // iOS is impossible in the viewer. See https://bit.ly/2BJcNjV\n    if (\n      Services.platformFor(this.ampdoc_.win).isIos() &&\n      Services.viewerForDoc(this.ampdoc_).isEmbedded()\n    ) {\n      return false;\n    }\n    return true;\n  }\n\n  /**\n   * @return {?Element}\n   * @private\n   */\n  findSlot_() {\n    const root = this.ampdoc_.getRootNode();\n\n    // For consistency always honor the dock attribute on the first el in page.\n    const video = root.querySelector('[dock]');\n\n    dev().assertElement(video);\n\n    userAssert(\n      video.signals().get(VideoEvents.REGISTERED),\n      '`dock` attribute can only be set on video components.'\n    );\n\n    const slotSelector = video.getAttribute('dock').trim();\n\n    if (slotSelector == '') {\n      return null;\n    }\n\n    const el = root.querySelector(slotSelector);\n\n    if (el) {\n      userAssert(\n        el.tagName.toLowerCase() == 'amp-layout',\n        'Dock slot must be an <amp-layout> element.'\n      );\n    }\n\n    return el;\n  }\n\n  /** @private */\n  onViewportResize_() {\n    this.observed_.forEach((video) => this.updateOnResize_(video));\n  }\n\n  /**\n   * @return {number}\n   * @private\n   */\n  getTopBoundary_() {\n    const slot = this.getSlot_();\n    if (slot) {\n      // Match slot's top edge to tie transition to element.\n      // TODO: Reuse a inlineRect\n      return slot./*OK*/ getBoundingClientRect().top;\n    }\n    return 0;\n  }\n\n  /** @param {!VideoOrBaseElementDef} video */\n  register(video) {\n    this.install_();\n\n    if (!this.intersectionObserver_) {\n      this.intersectionObserver_ = new IntersectionObserver(\n        (entries) => {\n          // Multiple entries could belong to the same element, use only the\n          // most recent.\n          const handled = [];\n          for (let i = entries.length - 1; i >= 0; i--) {\n            const {boundingClientRect, target} = entries[i];\n            if (handled.indexOf(target) < 0) {\n              target.getImpl().then((video) => {\n                this.updateOnPositionChange_(video, boundingClientRect);\n              });\n              handled.push(target);\n            }\n          }\n        },\n        {threshold: [0, 0.1, 0.2, 0.8, 0.9, 1]}\n      );\n    }\n\n    this.intersectionObserver_.observe(video.element);\n    this.observed_.push(video);\n  }\n\n  /**\n   * @param {!Element} element\n   * @public\n   */\n  registerElement(element) {\n    element.getImpl().then((video) => this.register(video));\n  }\n\n  /** @private */\n  updateScroll_() {\n    const scrollTop = this.viewport_.getScrollTop();\n\n    // debounce\n    if (Math.abs(scrollTop - this.lastScrollTop_) < 5) {\n      return;\n    }\n\n    const scrollDirection =\n      scrollTop > this.lastScrollTop_ ? DirectionY.TOP : DirectionY.BOTTOM;\n\n    this.scrollDirection_ = scrollDirection;\n    this.lastScrollTop_ = scrollTop;\n  }\n\n  /**\n   * @return {!Document}\n   * @private\n   */\n  getDoc_() {\n    const root = this.ampdoc_.getRootNode();\n    return /** @type {!Document} */ (root.ownerDocument || root);\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {!Element}\n   * @private\n   */\n  append_(element) {\n    const root = this.getDoc_().body || this.getDoc_();\n    return dev().assertElement(root.appendChild(element));\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {!Element}\n   * @private\n   */\n  addDragListeners_(element) {\n    const handler = (e) => this.drag_(/** @type {!TouchEvent} */ (e));\n\n    listen(element, 'touchstart', handler);\n    listen(element, 'mousedown', handler);\n\n    return element;\n  }\n\n  /**\n   * @return {!Controls}\n   * @private\n   */\n  installControls_() {\n    const controls = new Controls(this.ampdoc_);\n    const {container, overlay} = controls;\n\n    listen(container, VideoDockingEvents.DISMISS_ON_TAP, () => {\n      this.dismissOnTap_();\n    });\n\n    listen(container, VideoDockingEvents.SCROLL_BACK, () => {\n      this.scrollBack_();\n    });\n\n    this.addDragListeners_(container);\n    this.addDragListeners_(overlay);\n\n    this.append_(container);\n    this.append_(overlay);\n\n    return controls;\n  }\n\n  /** @private */\n  dismissOnTap_() {\n    this.getControls_().hide(/* respectSticky */ false, /* immediately */ true);\n    this.undock_(this.getDockedVideo_());\n  }\n\n  /**\n   * @return {!VideoOrBaseElementDef}\n   * @private\n   */\n  getDockedVideo_() {\n    return devAssert(this.currentlyDocked_).video;\n  }\n\n  /**\n   * Returns the area's target when a video should be docked.\n   * @param {!VideoOrBaseElementDef} video\n   * @param {!RectDef=} opt_inlineRect\n   * @return {?DockTargetDef}\n   * @private\n   */\n  getTargetFor_(video, opt_inlineRect) {\n    if (\n      this.isDragging_ ||\n      !this.isValidSize_(video, opt_inlineRect) ||\n      this.ignoreBecauseAnotherDocked_(video) ||\n      this.ignoreDueToNotPlayingManually_(video)\n    ) {\n      return null;\n    }\n\n    const {element} = video;\n    const inlineRect = opt_inlineRect || element./*OK*/ getBoundingClientRect();\n    const intersectionRect = rectIntersection(inlineRect, this.viewportRect_);\n    if (!intersectionRect || !isSizedRect(intersectionRect)) {\n      return null;\n    }\n    if (intersectionRect.top > this.getTopBoundary_()) {\n      return null;\n    }\n    return this.getUsableTarget_(video, opt_inlineRect);\n  }\n\n  /**\n   * @param {!AmpElement|!VideoOrBaseElementDef} element\n   * @return {!inlineRect}\n   * @private\n   */\n  getScrollAdjustedRect_(element) {\n    element = element.element || element;\n    return element./*OK*/ getBoundingClientRect();\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @private\n   */\n  updateOnResize_(video) {\n    // Update on subsequent animation frame to allow CSS media queries to be\n    // applied.\n    this.raf_(() => {\n      const target = this.getTargetFor_(video);\n      if (target) {\n        this.dock_(video, target, /* step */ 1);\n        return;\n      }\n      if (this.isCurrentlyDocked_(video)) {\n        this.undock_(video);\n      }\n    });\n  }\n\n  /**\n   * @param {function()} cb\n   * @private\n   */\n  raf_(cb) {\n    this.ampdoc_.win.requestAnimationFrame(cb);\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @param {!RectDef=} opt_inlineRect\n   * @private\n   */\n  updateOnPositionChange_(video, opt_inlineRect) {\n    if (this.isTransitioning_) {\n      return;\n    }\n    if (this.scrollDirection_ == DirectionY.TOP) {\n      const target = this.getTargetFor_(video, opt_inlineRect);\n      if (target) {\n        this.dockOnPositionChange_(video, target, opt_inlineRect);\n      }\n    } else if (this.scrollDirection_ == DirectionY.BOTTOM) {\n      if (!this.currentlyDocked_) {\n        return;\n      }\n      if (video === this.getDockedVideo_()) {\n        if (this.isVisible_(video, REVERT_TO_INLINE_RATIO, opt_inlineRect)) {\n          this.undock_(video, /* opt_reconciled */ false, opt_inlineRect);\n        }\n      }\n    }\n  }\n\n  /**\n   * @param  {!VideoOrBaseElementDef} video\n   * @return {boolean}\n   */\n  ignoreDueToNotPlayingManually_(video) {\n    return !this.currentlyDocked_ && !this.isPlaying_(video);\n  }\n\n  /**\n   * @param  {!VideoOrBaseElementDef} video\n   * @return {boolean}\n   */\n  ignoreBecauseAnotherDocked_(video) {\n    return !!this.currentlyDocked_ && !this.isCurrentlyDocked_(video);\n  }\n\n  /**\n   * @param  {!VideoOrBaseElementDef} video\n   * @param {!RectDef=} opt_inlineRect\n   * @return {boolean}\n   * @private\n   */\n  isValidSize_(video, opt_inlineRect) {\n    const {height, width} =\n      opt_inlineRect || video.element./*OK*/ getBoundingClientRect();\n    if (width / height < 1 - FLOAT_TOLERANCE) {\n      complainAboutPortrait(video.element);\n      return false;\n    }\n    return (\n      this.viewportRect_.width >= MIN_VIEWPORT_WIDTH &&\n      this.viewportRect_.height >= height * REVERT_TO_INLINE_RATIO\n    );\n  }\n\n  /**\n   * @param {?VideoOrBaseElementDef} optVideo\n   * @return {boolean}\n   * @private\n   */\n  isPlaying_(optVideo = null) {\n    const video = /** @type {!VideoInterface} */ (\n      optVideo || this.getDockedVideo_()\n    );\n    return (\n      this.manager_().getPlayingState(video) == PlayingStates.PLAYING_MANUAL\n    );\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @param {!DockTargetDef} target\n   * @param {!RectDef=} opt_inlineRect\n   * @private\n   */\n  dockOnPositionChange_(video, target, opt_inlineRect) {\n    if (this.ignoreDueToDismissal_(video)) {\n      return;\n    }\n\n    if (this.currentlyDocked_) {\n      return;\n    }\n\n    this.dockInTransferLayerStep_(video, target, opt_inlineRect);\n  }\n\n  /**\n   * Dock this in a two-step process due to a browser quirk in transferring\n   * layers to GPU.\n   * @param {!VideoOrBaseElementDef} video\n   * @param {!DockTargetDef} target\n   * @param {!RectDef=} opt_inlineRect\n   * @return {!Promise}\n   * @private\n   */\n  dockInTransferLayerStep_(video, target, opt_inlineRect) {\n    const isTransferLayerStep = true;\n    return this.dock_(\n      video,\n      target,\n      /* step */ 0.05,\n      opt_inlineRect,\n      isTransferLayerStep\n    ).then(\n      () =>\n        new Promise((resolve) => {\n          this.raf_(() => {\n            this.dock_(video, target, /* step */ 1, opt_inlineRect).then(\n              resolve\n            );\n          });\n        })\n    );\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @param {!DockTargetDef} target\n   * @param {number} step\n   * @param {!RectDef=} opt_inlineRect\n   * @param {boolean=} opt_isTransferLayerStep\n   * @return {!Promise}\n   * @private\n   */\n  dock_(video, target, step, opt_inlineRect, opt_isTransferLayerStep) {\n    const {element} = video;\n\n    // Component background is now visible, so hide the poster for the Android\n    // workaround so authors can style the component container as they like.\n    // (see `AmpVideo#createPosterForAndroidBug_`).\n    // TODO(alanorozco): Make docking agnostic to this workaround.\n    this.removePosterForAndroidBug_(element);\n\n    const {relativeX, scale, x, y} = this.getDims_(\n      video,\n      target,\n      step,\n      opt_inlineRect\n    );\n\n    video.hideControls();\n\n    const transitionDurationMs = this.calculateTransitionDuration_(step);\n\n    this.setCurrentlyDocked_(video, target, step);\n\n    return this.placeAt_(\n      video,\n      x,\n      y,\n      scale,\n      step,\n      transitionDurationMs,\n      relativeX,\n      opt_inlineRect\n    ).then(() => {\n      if (opt_isTransferLayerStep) {\n        // Do not enable controls during transfer layer steps, which would\n        // make them appear on hover during transition.\n        return;\n      }\n      this.getControls_().enable();\n    });\n  }\n\n  /**\n   * @param {!Actions} action\n   * @param {!DockTargetDef=} opt_target\n   * @private\n   */\n  trigger_(action, opt_target) {\n    const element = dev().assertElement(\n      (opt_target && opt_target.slot) ||\n        this.getSlot_() ||\n        this.getDockedVideo_().element\n    );\n\n    const trust = ActionTrust.LOW;\n    const event = createCustomEvent(\n      this.ampdoc_.win,\n      /** @type {string} */ (action),\n      /* detail */ dict({})\n    );\n    const actions = Services.actionServiceForDoc(element);\n    actions.trigger(element, action, event, trust);\n  }\n\n  /**\n   * @param  {!VideoOrBaseElementDef} video\n   * @return {boolean}\n   * @private\n   */\n  ignoreDueToDismissal_(video) {\n    if (this.lastDismissed_ != video) {\n      return false;\n    }\n    // TODO: Reuse a inlineRect\n    if (this.isVisible_(video.element, FLOAT_TOLERANCE)) {\n      this.resetDismissed_();\n    }\n    return true;\n  }\n\n  /** @private */\n  resetDismissed_() {\n    this.lastDismissed_ = null;\n  }\n\n  /**\n   * @param {number} step\n   * @return {number}\n   */\n  calculateTransitionDuration_(step) {\n    const maxAutoTransitionDurationMs = 300;\n    if (!this.currentlyDocked_) {\n      // Don't animate first frame. Browsers sometimes behave weirdly and use\n      // a stale transform value, thus causing it to visually jump.\n      return 0;\n    }\n    const remaining = Math.abs(step - this.currentlyDocked_.step);\n    return remaining * maxAutoTransitionDurationMs;\n  }\n\n  /**\n   * @param {number} x\n   * @param {number} y\n   * @param {number} scale\n   * @return {boolean}\n   */\n  alreadyPlacedAt_(x, y, scale) {\n    return (\n      !!this.placedAt_ &&\n      this.placedAt_.x == x &&\n      this.placedAt_.y == y &&\n      this.placedAt_.scale == scale\n    );\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @param {number} x\n   * @param {number} y\n   * @param {number} scale\n   * @param {number} step in [0..1]\n   * @param {number} transitionDurationMs\n   * @param {DirectionX=} opt_relativeX\n   * @param {!RectDef=} opt_inlineRect\n   * @param {string=} position\n   * @return {!Promise}\n   * @private\n   */\n  placeAt_(\n    video,\n    x,\n    y,\n    scale,\n    step,\n    transitionDurationMs,\n    opt_relativeX,\n    opt_inlineRect,\n    position = 'fixed'\n  ) {\n    if (this.alreadyPlacedAt_(x, y, scale)) {\n      return Promise.resolve();\n    }\n\n    this.isTransitioning_ = true;\n\n    const {element} = video;\n    const inlineRect =\n      opt_inlineRect || video.element./*OK*/ getBoundingClientRect();\n\n    const {height, width} = inlineRect;\n\n    this.placedAt_ = {x, y, scale};\n\n    const transitionTiming = step > 0 ? 'ease-out' : 'ease-in';\n\n    const internalElement = getInternalVideoElementFor(element);\n    const shadowLayer = this.getShadowLayer_();\n    const {overlay} = this.getControls_();\n    const placeholderBackground = this.getPlaceholderBackground_();\n    const placeholderIcon = this.getPlaceholderRefs_()['icon'];\n    const hasRelativePlacement = opt_relativeX !== undefined;\n    const isPlacementRtl = opt_relativeX == DirectionX.LEFT;\n\n    if (hasRelativePlacement) {\n      applyBreakpointClassname(\n        placeholderIcon,\n        width,\n        PLACEHOLDER_ICON_BREAKPOINTS\n      );\n\n      placeholderIcon.classList.toggle('amp-rtl', isPlacementRtl);\n      this.getControls_().container.classList.toggle('amp-rtl', isPlacementRtl);\n    }\n\n    // Setting explicit dimensions is needed to match the video's aspect\n    // ratio. However, we only do this once to prevent jank in subsequent\n    // frames.\n    const boxNeedsSizing = this.boxNeedsSizing_(width, height);\n\n    /** @param {!Element} element */\n    const maybeSetSizing = (element) => {\n      if (!boxNeedsSizing) {\n        return;\n      }\n      setImportantStyles(element, {\n        'width': px(width),\n        'height': px(height),\n        'min-width': px(width),\n        'min-height': px(height),\n      });\n    };\n\n    const setOpacity = (element) =>\n      setImportantStyles(element, {\n        'opacity': step,\n      });\n\n    const setTransitionTiming = (element) =>\n      setImportantStyles(element, {\n        'transition-duration': `${transitionDurationMs}ms`,\n        'transition-timing-function': transitionTiming,\n      });\n\n    const isSmallPlaceholderIcon =\n      placeholderIcon.classList.contains('amp-small');\n\n    const placeholderIconWidth = isSmallPlaceholderIcon\n      ? PLACEHOLDER_ICON_SMALL_WIDTH\n      : PLACEHOLDER_ICON_LARGE_WIDTH;\n\n    const placeholderIconMargin = isSmallPlaceholderIcon\n      ? PLACEHOLDER_ICON_SMALL_MARGIN\n      : PLACEHOLDER_ICON_LARGE_MARGIN;\n\n    /**\n     * @param {number} containerWidth\n     * @param {number} itemWidth\n     * @param {number} itemMargin\n     * @param {number} step\n     * @return {number}\n     */\n    const iconPlacementFn = isPlacementRtl\n      ? calculateLeftJustifiedX\n      : calculateRightJustifiedX;\n\n    const placeholderIconX = iconPlacementFn(\n      width,\n      placeholderIconWidth,\n      placeholderIconMargin,\n      step\n    );\n\n    video.mutateElement(() => {\n      internalElement.classList.add(BASE_CLASS_NAME);\n\n      // Resets .i-amphtml-layout-size-defined to fix clipping on Safari.\n      setImportantStyles(element, {'overflow': 'visible'});\n\n      toggle(shadowLayer, true);\n      toggle(overlay, true);\n\n      video.applyFillContent(this.getPlaceholderRefs_()['poster']);\n      video.applyFillContent(placeholderBackground);\n      this.setPosterImage_(video);\n\n      element.appendChild(placeholderBackground);\n\n      // Delay by one frame to account for reparenting.\n      this.raf_(() => {\n        video.mutateElement(() => {\n          setOpacity(placeholderBackground);\n          setTransitionTiming(placeholderBackground);\n          setTransitionTiming(placeholderIcon);\n          if (hasRelativePlacement) {\n            const y = 0;\n            const scale = 1;\n            setImportantStyles(placeholderIcon, {\n              'transform': transform(placeholderIconX, y, scale),\n            });\n          }\n        });\n      });\n\n      // To re-orient position: absolute elements since they're no longer\n      // relative to viewport rect.\n      let offsetLeft = 0;\n      let offsetTop = 0;\n\n      // Body-level elements that do not descend from the <amp-video> element,\n      // like the shadow layer, need to be additionally offset by the inline\n      // element's position relative to the body.\n      let bodyLevelOffsetLeft = 0;\n      let bodyLevelOffsetTop = 0;\n\n      if (position === 'absolute') {\n        offsetLeft = inlineRect.left;\n        offsetTop = inlineRect.top;\n        bodyLevelOffsetLeft = element./*OK*/ offsetLeft;\n        bodyLevelOffsetTop = element./*OK*/ offsetTop;\n      }\n\n      this.getElementsOnDockArea_(video).forEach((element) => {\n        const bodyLevelOffsetFactor = Number(element !== internalElement);\n\n        const left = bodyLevelOffsetFactor * bodyLevelOffsetLeft - offsetLeft;\n        const top = bodyLevelOffsetFactor * bodyLevelOffsetTop - offsetTop;\n\n        setImportantStyles(element, {\n          'position': position,\n          'left': px(left),\n          'top': px(top),\n          'transform': transform(x, y, scale),\n        });\n\n        setTransitionTiming(element);\n        maybeSetSizing(element);\n      });\n\n      setOpacity(shadowLayer);\n\n      this.getControls_().positionOnVsync(scale, x, y, width, height);\n    });\n\n    return this.getTimer_()\n      .promise(transitionDurationMs)\n      .then(() => {\n        this.isTransitioning_ = false;\n      });\n  }\n\n  /**\n   * @return {!../../../src/service/timer-impl.Timer}\n   * @private\n   */\n  getTimer_() {\n    return Services.timerFor(this.ampdoc_.win);\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @return {!Array<!Element>}\n   * @private\n   */\n  getElementsOnDockArea_(video) {\n    return [\n      getInternalVideoElementFor(video.element),\n      this.getShadowLayer_(),\n      this.getControls_().overlay,\n    ];\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @private\n   */\n  setPosterImage_(video) {\n    const placeholderPoster = this.getPlaceholderRefs_()['poster'];\n    const posterSrc = getPosterImageSrc(video.element);\n\n    if (!posterSrc) {\n      toggle(placeholderPoster, false);\n      return;\n    }\n\n    toggle(placeholderPoster, true);\n    setStyles(placeholderPoster, {\n      'background-image': `url(${posterSrc})`,\n    });\n  }\n\n  /**\n   * @param  {number} width\n   * @param  {number} height\n   * @return {boolean}\n   * @private\n   */\n  boxNeedsSizing_(width, height) {\n    const needsSizing =\n      !this.sizedAt_ ||\n      this.sizedAt_.width != width ||\n      this.sizedAt_.height != height;\n    if (needsSizing) {\n      this.sizedAt_ = {width, height};\n    }\n    return needsSizing;\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @return {boolean}\n   */\n  isCurrentlyDocked_(video) {\n    return !!this.currentlyDocked_ && this.currentlyDocked_.video == video;\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @param {!DockTargetDef} target\n   * @param {number} step\n   */\n  setCurrentlyDocked_(video, target, step) {\n    const previouslyDocked = this.currentlyDocked_;\n    this.currentlyDocked_ = {video, target, step};\n    if (\n      previouslyDocked &&\n      previouslyDocked.video == video &&\n      layoutRectEquals(target.rect, previouslyDocked.target.rect)\n    ) {\n      return;\n    }\n    this.getControls_().setVideo(video, target.rect);\n    this.trigger_(Actions.DOCK, target);\n  }\n\n  /**\n   * @param {number} offsetX\n   * @private\n   */\n  offsetX_(offsetX) {\n    const video = this.getDockedVideo_();\n    const {target} = this.currentlyDocked_;\n\n    const step = 1;\n    const transitionDurationMs = 0;\n\n    const {scale, x, y} = this.getDims_(video, target, step);\n    const centerX = this.getCenterX_(offsetX);\n    const directionX = this.calculateDirectionX_(centerX);\n\n    this.dragVelocityX_ = offsetX - this.previousDragOffsetX_;\n    this.previousDragOffsetX_ = offsetX;\n\n    this.placeAt_(\n      video,\n      x + offsetX,\n      y,\n      scale,\n      step,\n      transitionDurationMs,\n      directionX\n    );\n  }\n\n  /**\n   * @param {!AmpElement|!VideoOrBaseElementDef} element\n   * @param {number=} minRatio\n   * @param {!RectDef=} opt_inlineRect\n   * @return {boolean}\n   */\n  isVisible_(element, minRatio = 1, opt_inlineRect) {\n    const inlineRect = opt_inlineRect || this.getScrollAdjustedRect_(element);\n\n    // If the component's box is way out of view, the runtime might have\n    // discarded its size values.\n    if (!isSizedRect(inlineRect)) {\n      return 0;\n    }\n\n    const intersectionHeight =\n      Math.min(inlineRect.bottom, this.viewportRect_.bottom) -\n      Math.max(inlineRect.top, this.viewportRect_.top);\n\n    const intersectionRatio = Math.max(\n      0,\n      intersectionHeight / inlineRect.height\n    );\n\n    return intersectionRatio > minRatio - FLOAT_TOLERANCE;\n  }\n\n  /**\n   * @param {!MouseEvent|!TouchEvent} e\n   * @private\n   */\n  drag_(e) {\n    if (!this.currentlyDocked_) {\n      return;\n    }\n\n    if (this.isDockedToType_(DockTargetType.SLOT)) {\n      return;\n    }\n\n    // Don't allow dragging videos that are transitioning.\n    // This allows the user to keep scrolling while touching the inline/almost\n    // inline video area.\n    if (this.isTransitioning_) {\n      return;\n    }\n\n    this.dragOffsetX_ = 0;\n\n    const {x} = pointerCoords(e);\n    const {directionX} = this.currentlyDocked_.target;\n\n    const onDragMove = throttleByAnimationFrame(this.ampdoc_.win, (e) =>\n      this.onDragMove_(\n        /** @type {!TouchEvent|!MouseEvent} */ (e),\n        directionX,\n        x\n      )\n    );\n\n    const onDragEnd = () => this.onDragEnd_(unlisteners);\n\n    const root = this.ampdoc_.getRootNode();\n    const unlisteners = [\n      this.disableScroll_(),\n      this.disableUserSelect_(),\n      this.workaroundWebkitDragAndScrollIssue_(),\n      listen(root, 'touchmove', onDragMove),\n      listen(root, 'mousemove', onDragMove),\n      listenOnce(root, 'touchend', onDragEnd),\n      listenOnce(root, 'mouseup', onDragEnd),\n    ];\n  }\n\n  /**\n   * @param {!DockTargetType} type\n   * @return {boolean}\n   * @private\n   */\n  isDockedToType_(type) {\n    return (\n      !!this.currentlyDocked_ && this.currentlyDocked_.target.type === type\n    );\n  }\n\n  /**\n   * @return {!UnlistenDef}\n   * @private\n   */\n  disableUserSelect_() {\n    const docEl = dev().assertElement(this.getDoc_().documentElement);\n    const disabledClassName = 'i-amphtml-select-disabled';\n    docEl.classList.add(disabledClassName);\n    return () => docEl.classList.remove(disabledClassName);\n  }\n\n  /**\n   * @return {!UnlistenDef}\n   * @private\n   */\n  disableScroll_() {\n    this.viewport_.disableScroll();\n    return this.viewport_.resetScroll.bind(this.viewport_);\n  }\n\n  /**\n   * @param {!MouseEvent|!TouchEvent} e\n   * @param {!DirectionX} directionX\n   * @param {number} startX\n   * @private\n   */\n  onDragMove_(e, directionX, startX) {\n    if (this.currentlyDocked_.target.directionX !== directionX) {\n      // stale event\n      return;\n    }\n\n    const offsetX = pointerCoords(e).x - startX;\n\n    this.dragOffsetX_ = offsetX;\n\n    // Prevents dragging misfires.\n    if (offsetX <= 10) {\n      return;\n    }\n\n    e.preventDefault();\n    e.stopPropagation();\n\n    this.getControls_().hide(/* respectSticky */ false, /* immediately */ true);\n    this.isDragging_ = true;\n    this.getControls_().disable();\n    this.offsetX_(offsetX);\n  }\n\n  /**\n   * Works around https://bugs.webkit.org/show_bug.cgi?id=184250\n   * @return {!UnlistenDef}\n   * @private\n   */\n  workaroundWebkitDragAndScrollIssue_() {\n    const {win} = this.ampdoc_;\n    if (!Services.platformFor(win).isIos()) {\n      return () => {\n        /* NOOP */\n      };\n    }\n    const handler = (e) => e.preventDefault();\n    win.addEventListener('touchmove', handler, {passive: false});\n    return () => win.removeEventListener('touchmove', handler);\n  }\n\n  /**\n   * @param {!Array<!UnlistenDef>} unlisteners\n   * @private\n   */\n  onDragEnd_(unlisteners) {\n    unlisteners.forEach((unlisten) => unlisten.call());\n\n    this.isDragging_ = false;\n\n    this.getControls_().enable();\n\n    if (Math.abs(this.dragVelocityX_) < 40) {\n      this.snap_(this.dragOffsetX_);\n    } else {\n      this.flickToDismiss_(\n        this.previousDragOffsetX_,\n        Math.sign(this.dragVelocityX_)\n      );\n    }\n\n    this.dragVelocityX_ = 0;\n    this.previousDragOffsetX_ = 0;\n    this.dragOffsetX_ = 0;\n  }\n\n  /**\n   * @param {number} offsetX\n   * @param {number} direction -1 or 1\n   * @private\n   */\n  flickToDismiss_(offsetX, direction) {\n    devAssert(Math.abs(direction) == 1);\n\n    const video = this.getDockedVideo_();\n\n    video.pause();\n\n    // TODO: Reuse a inlineRect\n    if (this.isVisible_(video, 0.2)) {\n      this.bounceToDismiss_(video, offsetX, direction);\n      return;\n    }\n\n    const step = 1;\n    const {target} = devAssert(this.currentlyDocked_);\n    const {width, x, y} = target.rect;\n    const {scale} = this.getDims_(video, target, step);\n\n    const currentX = x + offsetX;\n    const nextX =\n      direction == 1\n        ? this.viewportRect_.right\n        : this.viewportRect_.left - width;\n\n    const transitionDurationMs = this.calculateDismissalTransitionDurationMs_(\n      nextX - currentX\n    );\n\n    this.reconcileUndocked_();\n\n    // Show immediately due to Chrome freeze bug when out-of-view.\n    video.showControls();\n\n    this.placeAt_(\n      video,\n      nextX,\n      y,\n      scale,\n      /* step */ 0,\n      transitionDurationMs\n    ).then(() => {\n      this.resetOnUndock_(video);\n    });\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @param {number} offsetX\n   * @param {number} direction -1 or 1\n   * @private\n   */\n  bounceToDismiss_(video, offsetX, direction) {\n    devAssert(Math.abs(direction) == 1);\n\n    const step = 1;\n    const {target} = devAssert(this.currentlyDocked_);\n\n    const {width, x, y} = target.rect;\n    const {scale} = this.getDims_(video, target, step);\n\n    const outerWidth = this.viewportRect_.width;\n\n    const currentX = x + offsetX;\n    const nextX =\n      direction == 1\n        ? calculateRightJustifiedX(outerWidth, width, /* margin */ 0, step)\n        : calculateLeftJustifiedX(outerWidth, width, /* margin */ 0, step);\n\n    const transitionDurationMs = this.calculateDismissalTransitionDurationMs_(\n      nextX - currentX\n    );\n\n    this.reconcileUndocked_();\n\n    this.placeAt_(\n      video,\n      nextX,\n      y,\n      scale,\n      /* step */ 0,\n      transitionDurationMs\n    ).then(() => {\n      // TODO: Reuse a inlineRect\n      this.undock_(video, /* reconciled */ true);\n      video.showControls();\n    });\n  }\n\n  /**\n   * @param {number} deltaX\n   * @return {number}\n   * @private\n   */\n  calculateDismissalTransitionDurationMs_(deltaX) {\n    return Math.min(300, Math.abs(deltaX) / 2);\n  }\n\n  /**\n   * Gets the horizontal center of the currently docked video, offset by x.\n   * @param {number} offsetX\n   * @return {number}\n   * @private\n   */\n  getCenterX_(offsetX) {\n    const {step, target} = this.currentlyDocked_;\n    const video = this.getDockedVideo_();\n    const {width} = video.element./*OK*/ getBoundingClientRect();\n    const {scale, x} = this.getDims_(video, target, step);\n    return x + offsetX + (width * scale) / 2;\n  }\n\n  /**\n   * @param {number} offsetX\n   * @private\n   */\n  snap_(offsetX) {\n    const video = this.getDockedVideo_();\n    const {step} = this.currentlyDocked_;\n\n    const directionX = this.calculateDirectionX_(offsetX);\n    this.cornerDirectionX_ = directionX;\n\n    // TODO: Reuse inlineRect\n    const target = this.getUsableTarget_(video);\n\n    this.currentlyDocked_.target = target;\n\n    const {scale, x, y} = this.getDims_(video, target, step);\n\n    this.placeAt_(\n      video,\n      x,\n      y,\n      scale,\n      step,\n      /* transitionDurationMs */ 200,\n      directionX\n    );\n  }\n\n  /**\n   * @param {number} offsetX\n   * @return {!DirectionX}\n   * @private\n   */\n  calculateDirectionX_(offsetX) {\n    return this.getCenterX_(offsetX) >= this.viewportRect_.width / 2\n      ? DirectionX.RIGHT\n      : DirectionX.LEFT;\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @param {!DockTargetDef} target\n   * @param {number} step in [0..1]\n   * @param {!RectDef} opt_inlineRect\n   * @return {{x: number, y: number, scale: number, relativeX: !DirectionX}}\n   */\n  getDims_(video, target, step, opt_inlineRect) {\n    return interpolatedBoxesTransform(\n      opt_inlineRect || this.getScrollAdjustedRect_(video),\n      target.rect,\n      step\n    );\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @param {boolean=} opt_reconciled\n   * @param {!RectDef=} opt_inlineRect\n   * @return {!Promise}\n   * @private\n   */\n  undock_(video, opt_reconciled, opt_inlineRect) {\n    const isMostlyInView = this.isVisible_(\n      video,\n      REVERT_TO_INLINE_RATIO,\n      opt_inlineRect\n    );\n\n    if (!isMostlyInView) {\n      video.pause();\n\n      // Show controls immediately rather than after transition to work around a\n      // weird Chrome bug where controls never reappear if enabled on a paused,\n      // out-of-view video.\n      video.showControls();\n    }\n\n    if (!opt_reconciled) {\n      this.reconcileUndocked_();\n    }\n\n    const step = 0;\n\n    const {target} = devAssert(this.currentlyDocked_);\n\n    const {relativeX, scale, x, y} = this.getDims_(video, target, step);\n\n    // Do not animate transition if video is out-of-view. Chrome glitches\n    // when pausing an out-of-view video, so we need to show controls and\n    // transition after. If we animate the transition, we would see native\n    // controls during, which looks a bit funky.\n    const transitionDurationMs = isMostlyInView\n      ? this.calculateTransitionDuration_(step)\n      : 0;\n\n    return this.placeAt_(\n      video,\n      x,\n      y,\n      scale,\n      step,\n      transitionDurationMs,\n      relativeX,\n      opt_inlineRect,\n      /* position */ 'absolute'\n    ).then(() => {\n      video.showControls();\n      this.resetOnUndock_(video);\n    });\n  }\n\n  /** @private */\n  reconcileUndocked_() {\n    this.getControls_().disable();\n\n    // Prevents ghosting\n    this.getControls_().hide(/* respectSticky */ false, /* immediately */ true);\n\n    this.trigger_(Actions.UNDOCK);\n  }\n\n  /**\n   * @param {!VideoOrBaseElementDef} video\n   * @return {!Promise}\n   * @private\n   */\n  resetOnUndock_(video) {\n    const {element} = video;\n    const internalElement = getInternalVideoElementFor(element);\n\n    return video.mutateElement(() => {\n      internalElement.classList.remove(BASE_CLASS_NAME);\n      const shadowLayer = this.getShadowLayer_();\n      const placeholderIcon = this.getPlaceholderRefs_()['icon'];\n      const placeholderBackground = this.getPlaceholderBackground_();\n\n      toggle(shadowLayer, false);\n\n      this.getControls_().reset();\n\n      [\n        internalElement,\n        shadowLayer,\n        placeholderBackground,\n        placeholderIcon,\n      ].forEach((el) => {\n        resetStyles(el, [\n          'transform',\n          'transition',\n          'min-width',\n          'min-height',\n          'width',\n          'height',\n          'opacity',\n          'overflow',\n          'position',\n          'left',\n          'top',\n        ]);\n      });\n\n      this.placedAt_ = null;\n      this.sizedAt_ = null;\n      this.currentlyDocked_ = null;\n    });\n  }\n\n  /**\n   * @param {!Element} parent\n   * @private\n   */\n  removePosterForAndroidBug_(parent) {\n    const el = parent.querySelector('.i-amphtml-android-poster-bug');\n    if (!el) {\n      return;\n    }\n    removeElement(el);\n  }\n\n  /** @private */\n  scrollBack_() {\n    if (!this.currentlyDocked_) {\n      return;\n    }\n    // Don't set duration or curve.\n    // Rely on Viewport service to determine timing based on scroll \u0394.\n    this.viewport_.animateScrollIntoView(\n      this.getDockedVideo_().element,\n      'center'\n    );\n  }\n\n  /**\n   * Returns usable target. If it can dock to a `slot` element that's larger\n   * than zero width/height, it calculates a letterboxed rectangle that matches\n   * the aspect ratio of the `video` but is contained within the slot's box.\n   * Otherwise returns a rectangle calculated relative to viewport and sticking\n   * to the horizontal `directionX`.\n   * @param {!AmpElement|!VideoOrBaseElementDef} video\n   * @param {!RectDef=} opt_inlineRect\n   * @return {!DockTargetDef}\n   * @private\n   */\n  getUsableTarget_(video, opt_inlineRect) {\n    const slot = this.getSlot_();\n    const inlineRect =\n      opt_inlineRect || video.element./*OK*/ getBoundingClientRect();\n\n    if (slot) {\n      return {\n        type: DockTargetType.SLOT,\n        rect: letterboxRect(inlineRect, slot./*OK*/ getBoundingClientRect()),\n        slot,\n      };\n    }\n\n    if (this.cornerDirectionX_ === null) {\n      this.cornerDirectionX_ = isRTL(this.getDoc_())\n        ? DirectionX.LEFT\n        : DirectionX.RIGHT;\n    }\n\n    return {\n      type: DockTargetType.CORNER,\n      rect: topCornerRect(\n        inlineRect,\n        this.viewportRect_,\n        this.cornerDirectionX_,\n        CORNER_WIDTH_RATIO,\n        CORNER_WIDTH_MIN,\n        CORNER_MARGIN_RATIO,\n        CORNER_MARGIN_MAX\n      ),\n      // Bookkeep horizontal edge for drag-and-snap.\n      directionX: this.cornerDirectionX_,\n    };\n  }\n\n  /**\n   * @return {?Element}\n   * @private\n   */\n  getSlot_() {\n    const slot = this.findSlotOnce_();\n\n    // Slots are optional by configuration but also by visibility.\n    // If the slot element is hidden via media queries (`isVisibleBySize`),\n    // fallback to corner.\n    if (slot && isVisibleBySize(slot)) {\n      return slot;\n    }\n\n    return null;\n  }\n}\n\nAMP.extension(TAG, 0.1, (AMP) => {\n  AMP.registerServiceForDoc('video-docking', VideoDocking);\n});\n"],
  "mappings": "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",
  "names": []
}
