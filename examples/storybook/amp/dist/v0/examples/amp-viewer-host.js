;
(function(){"use strict";function k(a){if("string"!=typeof a)return a;if("{"!=a.charAt(0))return null;try{return JSON.parse(a)}catch(c){return null}}function l(a,c,b){this.o=a;this.C=c;this.H=b}l.prototype.addEventListener=function(a,c){var b=this;this.o.addEventListener("message",(function(d){d.origin==b.C&&d.source==b.H&&c(d)}))};l.prototype.postMessage=function(a){this.H.postMessage(a,"null"===this.C?"*":this.C)};l.prototype.start=function(){};function m(a){this.o=null;this.D=a;this.A=!1;this.j=null;this.I=!0;this.M=0;this.F={};this.B={};this.G=null;this.D.addEventListener("message",this.K.bind(this));this.D.start()}function n(a){return new Promise((function(c){var b=setInterval((function(){function d(g){if((g=k(g.data))&&"__AMPHTML__"===g.app&&"channelOpen"===g.name){clearInterval(b);e.removeEventListener("message",d);var h=new m(e);p(h,g.requestid,"channelOpen",null);c(h)}}var f=new MessageChannel;a.postMessage({app:"__AMPHTML__",name:"handshake-poll"},"*",[f.port2]);var e=f.port1;e.addEventListener("message",d);e.start()}),1e3)}))}function q(a,c,b){return new Promise((function(d){function f(e){var g=k(e.data);!g||e.origin!=b||e.source&&e.source!=c||"__AMPHTML__"!==g.app||"channelOpen"!==g.name||(a.removeEventListener("message",f),e=new l(a,e.origin,c),e=new m(e),p(e,g.requestid,"channelOpen",null),d(e))}a.addEventListener("message",f)}))}m.prototype.registerHandler=function(a,c){this.B[a]=c};m.prototype.unregisterHandler=function(a){delete this.B[a]};m.prototype.setDefaultHandler=function(a){this.G=a};m.prototype.K=function(a){if((a=k(a.data))&&"__AMPHTML__"===a.app)if(this.j&&this.I&&a.messagingToken!==this.j)r(this,"amp-viewer-messaging: handleMessage_ error: ","invalid token");else if("q"===a.type)u(this,a);else if("s"===a.type){var c=a.requestid,b=this.F[c];b&&(delete this.F[c],a.error?(r(this,"amp-viewer-messaging: handleResponse_ error: ",a.error),b.reject(Error("Request "+a.name+" failed: "+a.error))):b.resolve(a.data))}};m.prototype.sendRequest=function(a,c,b){var d=this,f=++this.M,e=void 0;b&&(e=new Promise((function(g,h){d.F[f]={resolve:g,reject:h}})));v(this,{app:"__AMPHTML__",requestid:f,type:"q",name:a,data:c,rsvp:b});return e};function p(a,c,b,d){v(a,{app:"__AMPHTML__",requestid:c,type:"s",name:b,data:d})}function w(a,c,b,d){var f=d?d.message?d.message:String(d):"unknown error";r(a,"amp-viewer-messaging: sendResponseError_, message name: "+b,f);v(a,{app:"__AMPHTML__",requestid:c,type:"s",name:b,data:null,error:f})}function v(a,c){var b=Object.assign(c,{});a.j&&!a.I&&(b.messagingToken=a.j);a.D.postMessage(a.A?JSON.stringify(b):b)}function u(a,c){var b=a.B[c.name];b||(b=a.G);if(!b)throw b=Error("Cannot handle request because no default handler is set!"),b.args=c.name,b;b=b(c.name,c.data,!!c.rsvp);if(c.rsvp){var d=c.requestid;if(!b)throw w(a,d,c.name,Error("no response")),Error("expected response but none given: "+c.name);b.then((function(f){p(a,d,c.name,f)}),(function(f){w(a,d,c.name,f)}))}}function r(a,c,b){if(a.o){var d="amp-messaging-error-logger: "+c;d+=" data: "+(b?b.message?b.message:String(b):"unknown error");a.o.viewerState=d}}function x(a,c,b,d,f,e,g){var h=this;this.win=a;this.J=c;this.L=d;this.A=!!e;this.logsId=f;a=this.J.contentWindow;this.A||g?n(a).then((function(t){h.h=t;y(h)})):q(this.win,a,b).then((function(t){h.h=t;y(h)}))}function y(a){a.h.setDefaultHandler(a.L);a.sendRequest("visibilitychange",{state:a.N,prerenderSize:a.prerenderSize},!0)}x.prototype.sendRequest=function(a,c,b){this.log("sendRequest");if(this.h)return this.h.sendRequest(a,c,b)};x.prototype.log=function(){var a=Array.prototype.slice.call(arguments,0);a.unshift("[ViewerHost "+this.logsId+"]");console.log.apply(console,a)};self.AmpViewerHost=x})();//# sourceMappingURL=amp-viewer-host.js.map